<html>
    <head>
        <title>Expansion Fuel Tweaks</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Fuel Tweaks</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">14 Equipment</a></li>
          <li><a href="#ships">2 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">6 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Changes how fuel works, to make sun skimming more useful and profitable.</td>
                    <td>Changes how fuel works, to make sun skimming more useful and profitable.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.FuelTweaks</td>
                    <td>oolite.oxp.phkb.FuelTweaks</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Fuel Tweaks</td>
                    <td>Fuel Tweaks</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb and Thargoid</td>
                    <td>phkb and Thargoid</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.14.4</td>
                    <td>1.14.4</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/35/FuelTweaks.oxz">https://wiki.alioth.net/img_auth.php/3/35/FuelTweaks.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license with clauses - see readme file</td>
                    <td>Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license with clauses - see readme file</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873266</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Fuel%20Tweaks'>http://wiki.alioth.net/index.php/Fuel%20Tweaks</a></p>
        <h3>readme.txt</h3>
        <pre>Fuel Tweaks
By Nick Rogers

Overview
========
This OXP came out of a BB discussion where the idea was to make fuel scooping both (a) more desirable, and (b) more likely to happen. This OXP seeks to meet these goals in the following ways:
    1. The fuel system can be tweaked in a number of ways. It can operate as normal, or fuel rationing could be in effect, limiting the amount of fuel that can be bought at stations. Refuelling stations can also be installed, which effectively moves the purchase of fuel to be outside the main station. All of these scenarios can be altered by Javascript functions (see below).
    2. Scooped fuel can be collected in fuel storage containers and sold for profit.

This is a concept OXP, designed to feed discussion and experimentation.

Commodities
===========
A new trade good has been added to the system: Quirium Fuel. This trade good gets its best price at mainly agricultural systems.

    Item            Description                         Average Price/cr    Units 
    Quirium Fuel    Fuel scooped from a star&#39;s corona               30.0    TC

Equipment
=========
The following equipment items have been added to the game:

Quirium Fuel Processor
----------------------
This device replicates some of the fuel scooping system except, rather than putting the fuel into the main tank, processed fuel is stored in specialised fuel storage containers. The Fuel Processor is automatically activated during the fuel scoop process when the ship&#39;s main tank is full. 

The Fuel Processor comes equipped with 1 fuel container, so simply by purchasing this item pilots will be able to scoop 1t of quirium fuel.

    Cost:           450.0 Cr
    Availability:   TL4

Quirium Fuel Storage Unit
-------------------------
Fuel storage units can store 1t of Quirium fuel. Until used they will not consume any cargo space. When fuel is scooped and processed the units will expand to hold the fuel. If Quirium Fuel is dumped, a fuel storage unit will be dumped with it. When it is scooped, the fuel storage unit will be scooped as well.

    Cost:           50.0 Cr
    Availability:   TL3

Quirium Fuel Transfer
---------------------
This device is a slightly unstable method of moving fuel from storage and into the main ship tank. Quirium fuel is highly volatile, and the connection between the fuel processor and all storage units is designed to be one-way during flight. The Fuel transfer device is a third party add-on which breaches some of the containment protocols of the storage units in order to extract fuel and dump it in the main engine fuel tank. There is a chance that cargo loss or equipment damage could result from the transfer process. There have been reports of complete ship destruction in extreme cases, but these reports are rare.

To transfer fuel during flight, prime the &quot;Quirium Fuel Transfer&quot; equipment, then press the &quot;n&quot; (activate) key twice to start transferring fuel. Press the &quot;n&quot; key a third time (or use the &quot;b&quot; (mode) key) to stop the process.

A minimum 1t of Quirium fuel will be used regardless of how much is actually transferred to the main tank. Excess fuel is dumped to prevent any additional damage. For example, transferring 0.4LY of fuel will use 1t of Quirium. Transferring 6.4LY of fuel will also use 1t. Stopping the transfer process will dump the excess fuel from the container, meaning that each time you start the transfer you will use 1t of Quirium fuel.

    Cost:           1380.0 Cr
    Availability:   TL7

Options
=======
The &quot;fuelTweaks_fuelEconomy.js&quot; file contains a variety of functions and settings to control where fuel is sold, how much can be sold, and the presence of refuelling stations. While this file can be manually adjusted to taste, the preferred way is by using the following JavaScript interfaces described below.

Fuel stations
-------------
If fuel stations are enabled for a particular system, they will appear towards the edge of scanner range behind the main station. To get refuelled, simply fly into the station and come to a halt when directed. Fuel will then be transferred. WHen finished, exit the station and your account will be charged.

Fuel rations
------------
Some systems may have introduced a ration system, where a limited amount of fuel is available for purchase at the main station. Once you have purchased your ration, you will be unable to purchase any more fuel in that system until you jump out and come back.

Fuel Collector OXP
------------------
If Frame&#39;s Fuel Collector OXP is installed, the Fuel Collector will collect fuel into the Fuel Processor once the ship&#39;s tank is full.

JavaScript interfaces
=====================
Note: Changes made to the fuel system via these JavaScript methods will persist across save games.

Fuel
----
The following Javascript methods control access to the sale of fuel through the F3 interface:

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$addFuelAvailability(ecos : array, govs : array, tl : int[, useRations : boolean]);

    Adds a economy/government/min techlevel fuel availability setting. &quot;ecos&quot; and &quot;govs&quot; are arrays containing integers between 0 and 7.
    To ignore the economy or government, pass an empty array.
    tl is an integer, being the minimum techlevel required, between -1 and 15 (-1 means no techlevel check is performed)
    useRations is an optional flag indicating that fuel rations will be used at these systems, rather than the standard fuel.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$setMaxFuelRation(maxVal : int);

    Sets the maximum amount of fuel that can be purchased through a non-refuelling stations

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$setFuelAllegiance(alleg: array);

    Sets an array of allegiance types to control what stations can sell fuel.
    An empty array means all stations can sell fuel.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$addFuelSystemOverride(sysID : int, avail : boolean [, useRations : boolean [, maxRation : int]]);

    Adds a system specific override to the fuel system.
    avail determines whether fuel will be available for sale.
    useRations determines whether fuel rationing is in effect
    maxRation sets the maximum amount of fuel ration that can be sold.

Refuelling stations
-------------------
The following methods control the presence of refueling stations:
Note: Refuel stations will not be present if no fuel is available in the system.
Note: If a refueling station is present in a system, fuel will not be for sale in other stations.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$addRefuelStationAvailability(ecos : array, govs : array, tl : int);

    Adds a economy/government/min techlevel fuel availability setting. &quot;ecos&quot; and &quot;govs&quot; are arrays containing integers between 0 and 7.
    To ignore the economy or government, pass an empty array.
    tl is an integer, being the minimum techlevel required, between -1 and 15 (-1 means no techlevel check is performed)

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$setRefuelStationCostFactor(cf : decimal);

    Sets the default cost factor applied to fuel sales at refuelling stations. default 0.15

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$addRefuelStationSystemOverride(sysID : int, avail : boolean, costFactor : decimal);

    Adds an refuel station override item for the speficied system ID.
    avail = true means a refuel station will always be present, false means it will never be present
    costFactor is the cost factor applied to fuel sales through the refuel station.
    Note: Fuel must be available in the system before a refuelling station can be added.

General methods
---------------
    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$isFuelAvailable([sysID : int]);

    Returns true if the passed system ID (or the current system if no value passed) will have fuel available (either at the station itself or via a refuelling station). Otherwise false.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$fuelRationsInUse([sysID : int]);

    Returns true if fuel rationing is in use in the passed system ID.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$getMaxFuelRation([sysID: int]);

    Returns the maximum fuel ration permitted in the passed system ID.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$isRefuelStationAvailable([sysID : int]);

    Returns true if the passed system ID (or the current system if no value passed) will have refuelling stations present. Otherwise false.
    Note: Fuel must be available in the system before a refuelling station can be added.

    ---------------------------------------------------------------------------------------------------------------------
    worldScripts.FuelTweaks_FuelEconomy.$reset();

    Resets all fuel settings back to their default.

Or you can change the data elements directly in fuelTweaks_fuelEconomy.js. ;)

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

With thanks to Thargoid for his fly-through Fuel Station (from the Fuel Station OXP), and to gsagostinho for his amazing textures.

Discussion
==========
This OXP is discussed at this forum link: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=18947

Version History
===============
1.14.4
- The current state of the Quirium Fuel Processor (ie. how full it is) is now shown on the F5F5 Manifest screen.

1.14.3
- A Quirium Fuel Storage Unit will now automatically be awarded whenever a quirium fuel cargo container is scooped.

1.14.2
- Bug fixes.

1.14.1
- Fixed invalid character in shipdata.plist file.

1.14
- Fixed issue with repairing damaged fuel storage units.

1.13.1
- Removed debug log messages.

1.13
- Fixed issue with Fuel Collector taking too long to fill up accumulator when scooping fuel in free space.
- Fixed issue with Fuel Collector turning off the Quirium Fuel Processor when scooping fuel from the sun.

1.12
- Bug fixes and tweaks to the fuel transfer process.
- Added link to Fuel Collector OXP to enable the fuel collector to collect fuel into the fuel processor.
- Added variable pricing for pirate fuel, based on the amount of fuel required.

1.11
- Excluded fuel items from getting purchase notifications via the Email System.
- Scooping ejected quirium fuel containers will now award the player a Quirium Fuel Storage unit, so they can safely keep the cargo, rather than requiring the cargo be auto-ejected.
- Dumping quirium fuel will now dump a fuel storage unit along with it.
- Adjusted the prices of the Quirium Fuel Storage unit and it&#39;s associated removal item.
- Adjusted fuel storage equipment item configuration to handle case where player might have scooped some Quirium fuel and received fuel storage units, but without having a fuel processor.
- Better logic for determining if an escape pod is installed.
- Fixed missing variable definition errors during self-destruct sequence.
- Fixed output messages including a &quot;0&quot; during the self-destruct sequence.
- Corrected readme and wiki page regarding the Quirium Fuel Transfer equipment item and process.

1.10
- Bug fixes.

1.9
- NPC AI not being set to correct file to use fuel stations.
- Updated texture on fuel station, turned off the &quot;smooth&quot; setting.

1.8
- Better handling of interstellar space.
- Fuel can now be purchased at some chaotic and pirate stations in systems where there is some sort of fuel restrictions in place, but at a price.

1.7
- Fixed invalid reference bug after exiting witchspace.

1.6
- Added missing cost factor to refuel station availability code.

1.5
- Message about fuel not being for sale incorrectly being broadcast even when rations are available.
- Added information about fuel availability to the F7 System Data screen.
- Fixed incorrect TL variable reference in various lookup functions.
- Tweaks to checking functions to make them more logical.

1.4
- Bug fixes.

1.3
- Tweaks to the equipment.plist file.
- Added 5 and 6 ly fuel rations.
- Tweaks to the logic of the various properties to make system clearer.
- Added textures from gsagostinho&#39;s updated version of Fuel Stations.
- Added reset function to remove any fuel-related settings currently in use.
- Bug fixes.

1.2
- Set the default quantity of Quirium fuel available for purchase at all stations to be zero, to encourage scooping.
- Added the &quot;Quirium Fuel Transfer&quot; equipment item, to allow for fuel to be transferred from cargo to the main tank, but with a risk of cargo and/or equipment damage (and even entire ship destruction!).
- Scooping of Quirium Fuel cargo pods when there is insufficient fuel storage units to hold it will now result in the cargo being auto-ejected.
- Corrected logic for determining when fuel or fuel stations are available.
- Added logic to allow for players without fuel scoops to always have the ability to purchase 4ly fuel rations, even if all other logic says no fuel or rations or fuel stations are allowed in this system.

1.1
- Added options and JS methods to control how and where fuel is sold.

1.0
- Initial release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL.html">Fuel</a></td>
                    <td>yes</td>
                    <td align="right">2</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT1.html">Fuel (1.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">100</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT2.html">Fuel (2.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">250</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT3.html">Fuel (3.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">400</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT4.html">Fuel (4.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">800</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT5.html">Fuel (5.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">1200</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_ALT6.html">Fuel (6.0ly only)</a></td>
                    <td>yes</td>
                    <td align="right">1600</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_PROCESSOR.html">Quirium Fuel Processor</a></td>
                    <td>yes</td>
                    <td align="right">4500</td>
                    <td align="center">4+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_PROCESSOR_REMOVAL.html">Remove Quirium Fuel Processor</a></td>
                    <td>no</td>
                    <td align="right">500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_STORAGE.html">Quirium Fuel Storage Unit</a></td>
                    <td>yes</td>
                    <td align="right">500</td>
                    <td align="center">3+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_STORAGE_REMOVAL.html">Remove Quirium Fuel Storage Unit</a></td>
                    <td>no</td>
                    <td align="right">100</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_TRANSFER.html">Quirium Fuel Transfer</a></td>
                    <td>yes</td>
                    <td align="right">13800</td>
                    <td align="center">7+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_TRANSFER_REMOVAL.html">Remove Quirium Fuel Internal Transfer</a></td>
                    <td>no</td>
                    <td align="right">2000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_PIRATE_FUEL.html">Fuel</a></td>
                    <td>yes</td>
                    <td align="right">10</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/fuelStation_burningFuel.html">Burning quirium fuel</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fuelTweaks_station.html">Refuelling Station</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_burningFuel.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;FuelTweaks_BurningFuel&quot;;
this.author					= &quot;Thargoid&quot;;
this.copyright				= &quot;Creative Commons: attribution, non-commercial, sharealike with clauses - see readme.txt&quot;;
this.description			= &quot;Script for fuel station&quot;;

this._timer = null;

//-------------------------------------------------------------------------------------------------------------
this.shipSpawned = function() {
    var delay = 0.25;
    var chance = parseInt(Math.random() * 8 + 1);
    switch (chance) {
        case 1: 
            delay += 0.25;
            break;
        case 3:
            delay += 0.50;
            break;
        case 5:
            delay += 0.75;
            break;
        case 7:
            delay += 1;
            break;
    }
    this._timer = new Timer(this, this.$sequence, delay, 0);
}

//-------------------------------------------------------------------------------------------------------------
this.$sequence = function $sequence() {
    this.ship.dealEnergyDamage(200, 50);
    this.ship.explode();
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;FuelTweaks_Conditions&quot;;
this.author					= &quot;phkb&quot;;
this.copyright              = &quot;2017 phkb&quot;;
this.description			= &quot;Condition script for fuel equipment&quot;;
this.licence                = &quot;CC BY-NC-SA 4.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function(equipment, ship, context) {
    if (context === &quot;scripted&quot;) return true;
    if (equipment === &quot;EQ_FUEL&quot;) {
        if (system.ID === -1) return true;
        var fe = worldScripts.FuelTweaks_FuelEconomy;
        if (fe._fuelNormal === true) return true;
        if (fe.$isFuelAvailable() === true &amp;&amp; fe.$fuelRationsInUse() === false &amp;&amp; fe.$isRefuelStationAvailable() === false) return true;
        return false;
    }

    if (equipment === &quot;EQ_FUEL_STORAGE&quot;) {
        var sts = ship.equipmentStatus(&quot;EQ_FUEL_PROCESSOR&quot;);
        if (sts === &quot;EQUIPMENT_OK&quot; || sts === &quot;EQUIPMENT_DAMAGED&quot;) return true;
        return false;
    }

    if (equipment === &quot;EQ_PIRATE_FUEL&quot;) {
        var fe = worldScripts.FuelTweaks_FuelEconomy;
        if (fe._fuelNormal === true) return false;
        if (fe.$isFuelAvailable() === true &amp;&amp; fe.$fuelRationsInUse() === false &amp;&amp; fe.$isRefuelStationAvailable() === false) return false;
        if (system.economy &lt; 4) return false;
        if (ship.dockedStation.allegiance === &quot;pirate&quot; || ship.dockedStation.allegiance === &quot;chaotic&quot;) return true;
        return false;
    }

    var list = [&quot;EQ_FUEL_ALT1&quot;,&quot;EQ_FUEL_ALT2&quot;,&quot;EQ_FUEL_ALT3&quot;,&quot;EQ_FUEL_ALT4&quot;,&quot;EQ_FUEL_ALT5&quot;,&quot;EQ_FUEL_ALT6&quot;]    
    if (list.indexOf(equipment) &gt;= 0) {
        if (system.ID === -1) return false;
        var fe = worldScripts.FuelTweaks_FuelEconomy;
        if (fe._fuelNormal === true) return false;
        if (fe.$fuelRationsInUse() === false) return false;
        var info = EquipmentInfo.infoForKey(equipment);
        var max = parseInt(info.scriptInfo[&quot;fuel_amount&quot;]);
        if (max &gt; fe.$getMaxFuelRation()) return false;

        var req = parseInt(7 - player.ship.fuel);
        if (max &gt; req) return false;
        //if ((max - 1) &lt; req) return false; // this would only allow the highest ration amount to be shown

        // check the station allegiance
        var alleg = ship.dockedStation.allegiance;
        if (alleg == null) alleg = &quot;neutral&quot;;
        if (fe._fuelAllegiance.length &gt; 0 &amp;&amp; fe._fuelAllegiance.indexOf(alleg) === -1) return false;
        // not available if we&#39;ve already got our ration from this station.
        if (ship.dockedStation &amp;&amp; fe._emergencyFuel.indexOf(ship.dockedStation.displayName) &gt;= 0) return false;
        // might add further conditions here.
    }
    return true;
}

//-------------------------------------------------------------------------------------------------------------
this.updateEquipmentPrice = function(equipment, price) {
    var newprice = price;
    var p = player.ship;
    if (equipment === &quot;EQ_PIRATE_FUEL&quot;) {
        newprice = ((7 - p.fuel) * 10) * price;
    }
    return newprice;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_fuelEconomy.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;FuelTweaks_FuelEconomy&quot;;
this.author					= &quot;phkb&quot;;
this.copyright              = &quot;2017 phkb&quot;;
this.description			= &quot;Controls where fuel is available&quot;;
this.licence                = &quot;CC BY-NC-SA 4.0&quot;;

this._fuelNormal = true;                    // switch to true to enable normal fuel operations galaxywide
this._fuelUseRations = false;               // default setting to indicate whether fuel rationing is in place (true) or standard fuel purchasing (false)
                                            // even if false, availability of fuel will still be controlled by settings below
this._fuelAvailability = [];                // an array of dictionaries
                                            // dict:    eco         array of economies. empty array means no economy check
                                            //          gov         array of government types. empty array means no gov checks
                                            //          tl          min tech level. -1 means no tl check
                                            //          rations     boolean to indicate fuel rations are in use. default = this._fuelUseRations
                                            //          max         integer between 0 and 4 being the maximum ration that can be sold
this._maxFuelRation = 1;                    // default maximum amount of ration that can be sold (between 0 and 6)
this._fuelAllegiance = [&quot;galcop&quot;];          // allegiance of stations where fuel rations will be available. empty means any station allegiance
                                            // can include galcop,neutral,pirate,chaotic,,military,private,restricted,hunter,thargoid
this._fuelSystemOverride = [];              // array of dictionaries
                                            // dict:    systemID    id of the system having the override
                                            //          available   boolean indicating whether any fuel is for sale
                                            //          rations     boolean indicating whether rations are in use
                                            //          max         integer between 0 and 4 indicating the maximum ration that can be sold
this._refuelStationAvailability = [];       // an array of dictionaries
                                            // dict:    eco         array of economies. empty array means no economy check
                                            //          gov         array of government types. empty array means no gov checks
                                            //          tl          min tech level. -1 means no tl check
                                            //          factor      price factor for these systems
this._refuelStationSystemOverride = [];     // array of dictionaries 
                                            // dict:    systemID    system id of system in question
                                            //          available   boolean indicating whether refuel station is available
                                            //          factor      price factor to apply to fuel here
this._refuelStationCostFactor = 0.15;       // default price factor applied to fuel sold through refuelling stations

this._emergencyFuel = [];                   // array of stations names where player has purchased a fuel ration
this._saveSettings = false;                 // set to true to save all settings in save game file (which means values set above will be overridden)
                                            // this would probably only enabled if the OXP reached release stage and was linked into other OXP&#39;s
                                            // eg Diplomacy

this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];

//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
    /*
    // sample settings
    this._fuelNormal = false; // turn off normal fuel operations
    this._fuelUseRations = true; // turn on rationing
    // add some controls over fuel availability
    this.$addFuelAvailability([4,5,6,7], [0], 5);
    this.$addFuelAvailability([4,5,6,7], [1], 3);
    this.$addFuelAvailability([3,4,5,6,7], [2,3,4,5,6,7], 0, false);
    
    // add some controls over where refulling stations are present
    this.$addRefuelStationAvailability([4,5], [0], 8);
    this.$addRefuelStationAvailability([4,5], [1], 6);
    this.$addRefuelStationAvailability([4,5,6], [2], 3);
    this.$addRefuelStationAvailability([3,4,5,6], [2,3,4,5,6,7], 2);
    */

    if (missionVariables.FuelTweaks_EmergencyFuel) {
        this._emergencyFuel = JSON.parse(missionVariables.FuelTweaks_EmergencyFuel);
        delete missionVariables.FuelTweaks_EmergencyFuel;
    }
    // only try to load settings if we&#39;re actually saving them
    if (this._saveSettings === true) {
        if (missionVariables.FuelTweaks_FuelAvailability) {
            this._fuelAvailability = JSON.parse(missionVariables.FuelTweaks_FuelAvailability);
            delete missionVariables.FuelTweaks_FuelAvailability;
        }
        if (missionVariables.FuelTweaks_Allegiance) {
            this._fuelAllegiance = JSON.parse(missionVariables.FuelTweaks_Allegiance);
            delete missionVariables.FuelTweaks_Allegiance;
        }
        if (missionVariables.FuelTweaks_FuelSystemOverride) {
            this._fuelSystemOverride = JSON.parse(missionVariables.FuelTweaks_FuelSystemOverride);
            delete missionVariables.FuelTweaks_FuelSystemOverride;
        }
        if (missionVariables.FuelTweaks_RefuelStationAvailability) {
            this._refuelStationAvailability = JSON.parse(missionVariables.FuelTweaks_RefuelStationAvailability);
            delete missionVariables.FuelTweaks_RefuelEconomy;
        }
        if (missionVariables.FuelTweaks_RefuelStationSystemOverride) {
            this._refuelStationSystemOverride = JSON.parse(missionVariables.FuelTweaks_RefuelStationSystemOverride);
            delete missionVariables.FuelTweaks_RefuelStationSystemOverride;
        }
        if (missionVariables.FuelTweaks_RefuelStationCostFactor) {
            this._refuelStationCostFactor = parseFloat(missionVariables.FuelTweaks_RefuelStationCostFactor);
        }
        if (missionVariables.FuelTweaks_Normal) {
            this._fuelNormal = (this._trueValues.indexOf(missionVariables.FuelTweaks_Normal) &gt;= 0 ? true : false);
        }
    }
    delete this.startUp;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
    if (worldScripts[&quot;oolite-system-data-config&quot;] &amp;&amp; worldScripts[&quot;CommpressedF7Layout&quot;]) {
        worldScripts[&quot;oolite-system-data-config&quot;].addChangeCallback(this.name, &quot;$addInfoToSystemDataScreen&quot;);
        delete this.guiScreenWillChange;
        delete this.infoSystemWillChange;
    }
    if (worldScripts.GalCopAdminServices) {
        var ga = worldScripts.GalCopAdminServices;
        ga._purchase_ignore_equip.push(&quot;EQ_PIRATE_FUEL&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT1&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT2&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT3&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT4&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT5&quot;);
        ga._purchase_ignore_equip.push(&quot;EQ_FUEL_ALT6&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
    if (this._emergencyFuel.length &gt; 0) {
        missionVariables.FuelTweaks_EmergencyFuel = JSON.stringify(this._emergencyFuel);
    } else {
        delete missionVariables.FuelTweaks_EmergencyFuel;
    }
    // only save settings if we&#39;re allowed
    if (this._saveSettings === true) {
        missionVariables.FuelTweaks_FuelAvailability = JSON.stringify(this._fuelAvailability);
        missionVariables.FuelTweaks_Allegiance = JSON.stringify(this._fuelAllegiance);
        missionVariables.FuelTweaks_FuelSystemOverride = JSON.stringify(this._fuelSystemOverride);
        missionVariables.FuelTweaks_RefuelStationAvailability = JSON.stringify(this._refuelStationAvailability);
        missionVariables.FuelTweaks_RefuelStationSystemOverride = JSON.stringify(this._refuelStationSystemOverride);
        missionVariables.FuelTweaks_RefuelStationCostFactor = this._refuelStationCostFactor;
        missionVariables.FuelTweaks_Normal = this._fuelNormal;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function(equipmentKey) {
    var list = [&quot;EQ_FUEL_ALT1&quot;,&quot;EQ_FUEL_ALT2&quot;,&quot;EQ_FUEL_ALT3&quot;,&quot;EQ_FUEL_ALT4&quot;]    
	if (list.indexOf(equipmentKey) &gt;= 0) {
        var info = EquipmentInfo.infoForKey(equipmentKey);
        var amt = parseInt(info.scriptInfo[&quot;fuel_amount&quot;]);
		player.ship.fuel += amt;
        player.ship.removeEquipment(equipmentKey);
        this._emergencyFuel.push(player.ship.dockedStation.displayName); 
    }
    if (equipmentKey === &quot;EQ_PIRATE_FUEL&quot;) {
        player.ship.fuel = 7;
        player.ship.removeEquipment(equipmentKey);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillEnterWitchspace = function(cause, destination) {
    this._emergencyFuel = [];
    if (cause === &quot;galactic jump&quot;) {
        // reset fuel system parameters
        this._fuelAvailability = [];
        this._fuelSystemOverride = [];
        this._refuelStationAvailability = [];
        this._refuelStationSystemOverride = [];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function() {
    if (this._fuelNormal === false &amp;&amp; system.ID &gt;= 0) {
        var msg = &quot;&quot;;
        var avail = this.$isFuelAvailable(system.ID);
        var stn = (avail === true ? this.$isRefuelStationAvailable(system.ID) : false);
        var rations = (avail === true ? this.$fuelRationsInUse(system.ID) : false);
        if (avail === false) msg = expandDescription(&quot;[fuelTweaks_notAvailable]&quot;);
        if (avail === true) {
            if (rations === true &amp;&amp; stn === false) msg = expandDescription(&quot;[fuelTweaks_fuelRationsAvailable]&quot;);
        }
        if (msg !== &quot;&quot;) {
            var targets = system.shipsWithRole(&quot;buoy-witchpoint&quot;);
            if (targets.length &gt; 0) {
                for (var i = 0; i &lt; targets.length; i++) {
                    targets[i].commsMessage(msg, player.ship);
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenWillChange = function(to, from) {
    if (to === &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		this.$addInfoToSystemDataScreen();
    }
}

//-------------------------------------------------------------------------------------------------------------
this.infoSystemWillChange = function(to, from) {
	if (guiScreen === &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		this.$addInfoToSystemDataScreen();
	}
}

//-------------------------------------------------------------------------------------------------------------
// adds an availability register to the list
this.$addFuelAvailability = function(ecoList, govList, tl, useRations, maxRation) {
    if (Array.isArray(ecoList) === false) {
        throw &quot;Invalid settings - ecoList must be an array&quot;;
    }
    for (var i = 0; i &lt; ecoList.length; i++) {
        if (ecoList[i] &lt; 0 || ecoList[i] &gt; 7) {
            throw &quot;Invalid settings - ecoList data elements must be between 0 and 7&quot;;
        }
    }
    if (Array.isArray(govList) === false) {
        throw &quot;Invalid settigns - govList must be an array&quot;;
    }
    for (var i = 0; i &lt; govList.length; i++) {
        if (govList[i] &lt; 0 || govList[i] &gt; 7) {
            throw &quot;Invalid settings - govList data elements must be between 0 and 7&quot;;
        }
    }
    if (tl &lt; -1 || tl &gt; 15) {
        throw &quot;Invalid settings - tl must be between -1 and 15&quot;;
    }
    // default if not passed
    if (useRations == undefined) useRations = this._fuelUseRations;
    if (maxRation == undefined) {
        maxRation = this._maxFuelRation;
    } else {
        if (isNaN(maxRation) || maxRation &lt; 0 || maxRation &gt; 6) {
            throw &quot;Invalid settings - maxRation must be an integer between 0 and 6&quot;;
        }
    }

    var test = JSON.stringify({eco:ecoList, gov:govList, tl:tl, rations:useRations, max:maxRation});
    var found = false;
    for (var i = 0; i &lt; this._fuelAvailability.length; i++) {
        if (JSON.stringify(this._fuelAvailability[i]) === test) {found = true; break;}
    }
    if (found === false) this._fuelAvailability.push({eco:ecoList, gov:govList, tl:tl, rations:useRations, max:maxRation});
}

//-------------------------------------------------------------------------------------------------------------
// removes a fuel availability register from the list
this.$removeFuelAvailability = function(ecoList, govList, tl, useRations, maxRation) {
    if (Array.isArray(ecoList) === false) {
        throw &quot;Invalid settings - ecoList must be an array&quot;;
    }
    for (var i = 0; i &lt; ecoList.length; i++) {
        if (ecoList[i] &lt; 0 || ecoList[i] &gt; 7) {
            throw &quot;Invalid settings - ecoList data elements must be between 0 and 7&quot;;
        }
    }
    if (Array.isArray(govList) === false) {
        throw &quot;Invalid settigns - govList must be an array&quot;;
    }
    for (var i = 0; i &lt; govList.length; i++) {
        if (govList[i] &lt; 0 || govList[i] &gt; 7) {
            throw &quot;Invalid settings - govList data elements must be between 0 and 7&quot;;
        }
    }
    if (tl &lt; -1 || tl &gt; 15) {
        throw &quot;Invalid settings - tl must be between -1 and 15&quot;;
    }
    // default if not passed
    if (useRations == undefined) useRations = this._fuelUseRations;
    if (maxRation == undefined) {
        maxRation = this._maxFuelRation;
    } else {
        if (isNaN(maxRation) || maxRation &lt; 0 || maxRation &gt; 6) {
            throw &quot;Invalid settings - maxRation must be an integer between 0 and 6&quot;;
        }
    }

    var test = JSON.stringify({eco:ecoList, gov:govList, tl:tl, rations:useRations, max:maxRation});
    for (var i = 0; i &lt; this._fuelAvailability.length; i++) {
        if (JSON.stringify(this._fuelAvailability[i]) === test) {
            this._fuelAvailability.splice(i, 1);
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$addInfoToSystemDataScreen = function() {
	var sysID = player.ship.targetSystem;
	if (player.ship.hasOwnProperty(&quot;infoSystem&quot;)) sysID = player.ship.infoSystem;
    // build message
    var msg = &quot;&quot;;
    var avail = this.$isFuelAvailable(sysID);
    var stn = (avail === true ? this.$isRefuelStationAvailable(sysID) : false);
    var rations = (avail === true ? this.$fuelRationsInUse(sysID) : false);
    if (avail === false) msg = expandDescription(&quot;[fuelTweaks_notAvailable]&quot;);
    if (avail === true) {
        if (rations === true &amp;&amp; stn === false) msg = expandDescription(&quot;[fuelTweaks_fuelRationsAvailable]&quot;);
        if (stn === true) msg = expandDescription(&quot;[fuelTweaks_fuelStationAvailable]&quot;);
    }
    // add message to top part of screen, if possible
    var added = false;
    if (worldScripts[&quot;oolite-system-data-config&quot;] &amp;&amp; worldScripts[&quot;CompressedF7Layout&quot;]) {
        var ln = 0;
        var dc = worldScripts[&quot;oolite-system-data-config&quot;];
        for (var i = 16; i &gt;= 1; i--) {
            if (ln === 0 &amp;&amp; dc.systemDataLineText(i) != &quot;&quot;) {
                ln = i + 1;
            }
            if (dc.systemDataLineOwner(i) === this.name) {
                ln = i;
                break;
            }
        }
        if (ln &lt;= 16 &amp;&amp; ln &gt; 0) {
            added = true;
            dc.setSystemDataLine(ln, msg, (msg != &quot;&quot; ? this.name : &quot;&quot;));
        }
    } 
    // if none of the above worked, then just add the message to the bottom part of the screen
    if (added === false) mission.addMessageText(msg);
}

//-------------------------------------------------------------------------------------------------------------
// adds a fuel override to a specific system
this.$addFuelSystemOverride = function(sysID, avail, useRations, maxRation) {
    // default if not passed
    if (!useRations) useRations = this._fuelUseRations;
    if (!maxRation) {
        maxRation = this._maxFuelRation;
    } else {
        if (isNaN(maxRation) || maxRation &lt; 0 || maxRation &gt; 6) {
            throw &quot;Invalid settings - maxRation must be an integer between 0 and 6&quot;;
        }
    }
    
    var found = false;
    for (var i = 0; i &lt; this._fuelSystemOverride.length; i++) {
        if (this._fuelSystemOverride[i].systemID === sysID) {
            this._fuelSystemOverride[i] = {systemID:sysID, available:avail, rations:useRations, max:maxRation};
            found = true;
            break;
        }
    }
    if (found === false) {
        this._fuelSystemOverride.push({systemID:sysID, available:avail, rations:useRations, max:maxRation});
    }
}

//-------------------------------------------------------------------------------------------------------------
// removes a system specific fuel override
this.$removeFuelSystemOverride = function(sysID) {
    if (isNaN(sysID) || sysID &lt; 0 || sysID &gt; 255) {
        throw &quot;Invalid setting - system ID must be an integer between 0 and 255&quot;;
    }
    for (var i = 0; i &lt; this._fuelSystemOverride.length; i++) {
        if (this._fuelSystemOverride[i].systemID === sysID) {
            this._fuelSystemOverride.splice(i, 1)
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// Sets the default maximum amount of fuel that can be purchased through a non-refuelling stations
// Zero (0) means no ration available.
this.$setMaxFuelRation = function(maxFuel) {
	if (isNaN(maxFuel) === true || maxFuel &lt; 0 || maxFuel &gt; 6) {
		throw &quot;Invalid setting - max fuel ration must be an integer between 0 and 6&quot;;
	}
    this._maxFuelRation = maxFuel;
}

//-------------------------------------------------------------------------------------------------------------
// Sets an array of allegiance types to control what stations can sell fuel.
// empty array means all stations.
this.$setFuelAllegiance = function(alleg) {
	if (Array.isArray(alleg) === false) {
		throw &quot;Invalid setting - parameter must be an array of strings&quot;;
	}
    var poss = [&quot;galcop&quot;,&quot;neutral&quot;,&quot;pirate&quot;,&quot;chaotic&quot;,&quot;military&quot;,&quot;private&quot;,&quot;restricted&quot;,&quot;hunter&quot;,&quot;thargoid&quot;];
	for (var i = 0; i &lt; alleg.length; i++) {
		if (poss.indexOf(alleg[i]) === -1) {
			throw &quot;Invalid allegiance value - &quot; + alleg[i] + &quot; must be one of these: galcop,neutral,pirate,chaotic,,military,private,restricted,hunter,thargoid&quot;;
		}
	}
	this._fuelAllegiance = alleg;
}

//-------------------------------------------------------------------------------------------------------------
// adds a refuel station availability register to the list
this.$addRefuelStationAvailability = function(ecoList, govList, tl, factor) {
        if (Array.isArray(ecoList) === false) {
        throw &quot;Invalid settings - ecoList must be an array&quot;;
    }
    for (var i = 0; i &lt; ecoList.length; i++) {
        if (ecoList[i] &lt; 0 || ecoList[i] &gt; 7) {
            throw &quot;Invalid settings - ecoList data elements must be between 0 and 7&quot;;
        }
    }
    if (Array.isArray(govList) === false) {
        throw &quot;Invalid settigns - govList must be an array&quot;;
    }
    for (var i = 0; i &lt; govList.length; i++) {
        if (govList[i] &lt; 0 || govList[i] &gt; 7) {
            throw &quot;Invalid settings - govList data elements must be between 0 and 7&quot;;
        }
    }
    if (tl &lt; -1 || tl &gt; 15) {
        throw &quot;Invalid settings - tl must be between -1 and 15&quot;;
    }
    if (factor &amp;&amp; isNaN(factor) === true) {
        throw &quot;Invalid settings - factor must be a valid number greater than 0&quot;;
    }
    var test = JSON.stringify({eco:ecoList, gov:govList, tl:tl});
    var found = false;
    for (var i = 0; i &lt; this._refuelStationAvailability.length; i++) {
        if (JSON.stringify(this._refuelStationAvailability[i]) === test) {found = true; break;}
    }
    if (!factor) factor = this._refuelStationCostFactor;
    if (found === false) this._refuelStationAvailability.push({eco:ecoList, gov:govList, tl:tl, factor:factor});
}

//-------------------------------------------------------------------------------------------------------------
// removes a refuel station availability register from the list
this.$removeRefuelStationAvailability = function(ecoList, govList, tl) {
        if (Array.isArray(ecoList) === false) {
        throw &quot;Invalid settings - ecoList must be an array&quot;;
    }
    for (var i = 0; i &lt; ecoList.length; i++) {
        if (ecoList[i] &lt; 0 || ecoList[i] &gt; 7) {
            throw &quot;Invalid settings - ecoList data elements must be between 0 and 7&quot;;
        }
    }
    if (Array.isArray(govList) === false) {
        throw &quot;Invalid settigns - govList must be an array&quot;;
    }
    for (var i = 0; i &lt; govList.length; i++) {
        if (govList[i] &lt; 0 || govList[i] &gt; 7) {
            throw &quot;Invalid settings - govList data elements must be between 0 and 7&quot;;
        }
    }
    if (tl &lt; -1 || tl &gt; 15) {
        throw &quot;Invalid settings - tl must be between -1 and 15&quot;;
    }
    var test = JSON.stringify({eco:ecoList, gov:govList, tl:tl});
    for (var i = 0; i &lt; this._refuelStationAvailability.length; i++) {
        if (JSON.stringify(this._refuelStationAvailability[i]) === test) {
            this._refuelStationAvailability.splice(i, 1); 
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// Adds a system ID to a list of systems that will be forced to have a refuelling station.
this.$addRefuelStationSystemOverride = function(sysID, avail, costFactor) {
    if (isNaN(sysID) || sysID &lt; 0 || sysID &gt; 255) {
        throw &quot;Invalid setting - system ID must be an integer between 0 and 255&quot;;
    }
    if (isNaN(costFactor) || costFactor &lt;= 0) {
        throw &quot;Invalid setting - cost factor must be greater than 0&quot;
    }
    var found = false;
    for (var i = 0; i &lt; this._refuelStationSystemOverride.length; i++) {
        if (this._refuelStationSystemOverride[i].systemID === sysID) {
            found = true;
            this._refuelStationSystemOverride[i] = {systemID:sysID, available:avail, factor:costFactor};
            break;
        }
    }
    if (found === false) {
        this._refuelStationSystemOverride.push({systemID:sysID, available:avail, factor:costFactor});
    }
}

//-------------------------------------------------------------------------------------------------------------
// Removes a systemID from the list of systems that will always have a refuelling station.
this.$removeRefuelStationSystemOverride = function(sysID) {
    if (isNaN(sysID) || sysID &lt; 0 || sysID &gt; 255) {
        throw &quot;Invalid setting - system ID must be an integer between 0 and 255&quot;;
    }
    for (var i = 0; i &lt; this._refuelStationSystemOverride.length; i++) {
        if (this._refuelStationSystemOverride[i].systemID === sysID) {
            this._refuelStationSystemOverride.splice(i, 1);
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// sets the default refuelling station cost factor 
this.$setRefuelStationCostFactor = function(cf) {
    if (isNaN(cf) || cf &lt;= 0) {
        throw &quot;Invalid setting - cost factor must be greater than 0&quot;;
    }
    this._refuelStationCostFactor = cf;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if fuel rations will be available in a particular system. otherwise false.
this.$isFuelAvailable = function(sysID) {
    if (this._fuelNormal === true) return true;
	if (!sysID) sysID = system.ID;
	var sys = System.infoForSystem(galaxyNumber, sysID);
    // check if we have an override
    var ovr = this.$checkFuelSystemOverride(sysID);
    if (ovr) return ovr.available;
    return this.$checkFuelAvailability(sys.economy, sys.government, sys.techlevel);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if fuel rationing is in use in a system, otherwise false
this.$fuelRationsInUse = function(sysID) {
    if (this._fuelNormal === true) return false;
	if (!sysID) sysID = system.ID;
	var sys = System.infoForSystem(galaxyNumber, sysID);
    // look for an override first
    var ovr = this.$checkFuelSystemOverride(sysID);
    if (ovr) return ovr.rations;
    // check if a refuel station is available here
    if (this.$isRefuelStationAvailable(sysID) === true) return false;
    var inuse = this.$checkFuelRationsInUse(sys.economy, sys.government, sys.techlevel);
    // make sure players who can&#39;t scoop fuel can still get a fuel ration
    if (player.ship.hasEquipmentProviding(&quot;EQ_FUEL_SCOOPS&quot;) === false) {
        if (inuse === false &amp;&amp; this.$isFuelAvailable(sysID) === false &amp;&amp; this.$isRefuelStationAvailable(sysID) === false) {
            inuse = true;
        }
    }
    return inuse;
}

//-------------------------------------------------------------------------------------------------------------
// checks all fuel availability settings to see if we hit a true condition
this.$checkFuelAvailability = function(ecoID, govID, tl) {
    for (var i = 0; i &lt; this._fuelAvailability.length; i++) {
        var checkCount = 0;
        var itm = this._fuelAvailability[i];
        if (itm.eco.length === 0 || itm.eco.indexOf(ecoID) &gt;= 0) checkCount += 1;
        if (itm.gov.length === 0 || itm.gov.indexOf(govID) &gt;= 0) checkCount += 1;
        if (itm.tl === -1 || tl &gt;= itm.tl) checkCount += 1;
 
        if (checkCount === 3) {
            return true;
        }
    }
    return false;
}

//-------------------------------------------------------------------------------------------------------------
// checks all fuel availability settings to see whether fuel rations are in use
this.$checkFuelRationsInUse = function(ecoID, govID, tl) {
    var inuse = this._fuelUseRations;
    var itm = this.$getAvailabilityItem(ecoID, govID, tl);
    if (itm != null) inuse = itm.rations;
    return inuse;
}

//-------------------------------------------------------------------------------------------------------------
// returns the maximum possible fuel ration available for this system
this.$getMaxFuelRation = function(sysID) {
    var max = this._maxFuelRation;
	if (!sysID) sysID = system.ID;
	var sys = System.infoForSystem(galaxyNumber, sysID);
    // look for an override
    var ovr = this.$checkFuelSystemOverride(sysID);
    if (ovr) return ovr.max;
    // look for a general item
    var itm = this.$getAvailabilityItem(sys.economy, sys.government, sys.techlevel);
    if (itm != null) max = itm.max;
    // make sure players who can&#39;t scoop fuel can still get a decent fuel ration
    if (player.ship.hasEquipmentProviding(&quot;EQ_FUEL_SCOOPS&quot;) === false) {
        if (this.$isFuelAvailable(sysID) === false &amp;&amp; this.$isRefuelStationAvailable(sysID) === false) {
            max = 4;
        }
    }
    return max;
}

//-------------------------------------------------------------------------------------------------------------
// checks the availability register for a match on eco, gov and tl
this.$getAvailabilityItem = function(ecoID, govID, tl) {
    var item = null;
    for (var i = 0; i &lt; this._fuelAvailability.length; i++) {
        var itm = this._fuelAvailability[i];
        if (((itm.eco.length &gt; 0 &amp;&amp; itm.eco.indexOf(ecoID) &gt;= 0) || itm.eco.length === 0) &amp;&amp;
            ((itm.gov.length &gt; 0 &amp;&amp; itm.gov.indexOf(govID) &gt;= 0) || itm.gov.length === 0) &amp;&amp;
            (itm.tl === -1 || tl &gt;= itm.tl)) {item = itm; break;}
    }
    return item;
}

//-------------------------------------------------------------------------------------------------------------
// checks for a fuel ration system override, returns item or null
this.$checkFuelSystemOverride = function(sysID) {
    if (this._fuelSystemOverride.length &gt; 0) {
        for (var i = 0; i &lt; this._fuelSystemOverride.length; i++) {
            if (this._fuelSystemOverride[i].systemID === sysID) return this._fuelSystemOverride[i];
        }
    }
    return null;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if fuel rations will be available from stations in a particular system. otherwise false
this.$isRefuelStationAvailable = function(sysID) {
    // if the fuel is set to normal operations, don&#39;t spawn any refuelling stations - but maybe some discussion is worthwhile here.
    if (this._fuelNormal === true) return false;
	if (!sysID) sysID = system.ID;
	var sys = System.infoForSystem(galaxyNumber, sysID);
    // is fuel allowed to be sold in this system? run relevant fuel availability checks first
    var fuelAvail = true;
    var ovr = this.$checkFuelSystemOverride(sysID);
    // check if we have a &quot;deny&quot; override
    if (ovr) {
        fuelAvail = ovr.available;
    } else {
        // otherwise check for general availability
        fuelAvail = this.$checkFuelAvailability(sys.economy, sys.government, sys.techlevel);
    }
    // check the economy of the current system
    var avail = true;
    // if fuel is available we can now check for refuel stations
    if (fuelAvail === true) {
        // check if we have an override for this system
        ovr = this.$checkRefuelStationSystemOverride(sysID);
        if (ovr) return ovr.available;
        avail = this.$checkRefuelStationAvailability(sys.economy, sys.government, sys.techlevel);
    } else {
        // if no fuel is available, no refuelling stations are available either
        avail = false;
    }
    return avail;
}

//-------------------------------------------------------------------------------------------------------------
// checks all reful station availability settings to see if we hit a true condition
this.$checkRefuelStationAvailability = function(ecoID, govID, tl) {
    for (var i = 0; i &lt; this._refuelStationAvailability.length; i++) {
        var checkCount = 0;
        var itm = this._refuelStationAvailability[i];
        if (itm.eco.length === 0 || itm.eco.indexOf(ecoID) &gt;= 0) checkCount += 1;
        if (itm.gov.length === 0 || itm.gov.indexOf(govID) &gt;= 0) checkCount += 1;
        if (itm.tl === -1 || tl &gt;= itm.tl) checkCount += 1;

        // if we completely matched on this item, we&#39;re good to go
        if (checkCount === 3) {
            return true;
        }
    }
    return false;
}

//-------------------------------------------------------------------------------------------------------------
// checks the fuel station availability register for a match on eco, gov and tl
this.$getRefuelStationAvailabilityItem = function(ecoID, govID, tl) {
    var item = null;
    for (var i = 0; i &lt; this._refuelStationAvailability.length; i++) {
        var itm = this._refuelStationAvailability[i];
        if (((itm.eco.length &gt; 0 &amp;&amp; itm.eco.indexOf(ecoID) &gt;= 0) || itm.eco.length === 0) &amp;&amp;
            ((itm.gov.length &gt; 0 &amp;&amp; itm.gov.indexOf(govID) &gt;= 0) || itm.gov.length === 0) &amp;&amp;
            ((itm.tl &gt;= 0 &amp;&amp; tl &gt;= itm.tl) || itm.tl === -1)) {item = itm; break;}
    }
    return item;
}

//-------------------------------------------------------------------------------------------------------------
// checks for a fuel ration system override, returns item or null
this.$checkRefuelStationSystemOverride = function(sysID) {
    if (this._refuelStationSystemOverride.length &gt; 0) {
        for (var i = 0; i &lt; this._refuelStationSystemOverride.length; i++) {
            if (this._refuelStationSystemOverride[i].systemID === sysID) return this._refuelStationSystemOverride[i];
        }
    }
    return null;
}

//-------------------------------------------------------------------------------------------------------------
// returns the refuel station cost factor for this system
this.$getRefuelStationCostFactor = function(sysID) {
	if (!sysID) sysID = system.ID;
	var sys = System.infoForSystem(galaxyNumber, sysID);
    // check for an override
    var ovr = this.$checkRefuelStationSystemOverride(sysID);
    if (ovr) return ovr.factor;
    // start with the default
    var result = this._refuelStationCostFactor;
    // see if there&#39;s something in the register
    var item = this.$getRefuelStationAvailabilityItem(sys.economy, sys.government, sys.techlevel);
    if (item != null) {
        result = parseFloat(item.factor);
    }
    return result;
}

//-------------------------------------------------------------------------------------------------------------
// resets all fuel-related data
this.$reset = function() {
    this._fuelNormal = true;
    this._fuelAvailability = [];
    this._maxFuelRation = 1;
    this._fuelAllegiance = &quot;galcop&quot;;
    this._fuelSystemOverride = [];
    this._refuelStationAvailability = [];
    this._refuelStationSystemOverride = [];
    this._refuelStationCostFactor = 0.15
    this._emergencyFuel = [];
    delete missionVariables.FuelTweaks_FuelAvailability;
    delete missionVariables.FuelTweaks_Allegiance;
    delete missionVariables.FuelTweaks_FuelSystemOverride;;
    delete missionVariables.FuelTweaks_RefuelStationAvailability;
    delete missionVariables.FuelTweaks_RefuelStationSystemOverride;
    delete missionVariables.FuelTweaks_RefuelStationCostFactor;
    delete missionVariables.FuelTweaks_Normal;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_quirium.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name                   = &quot;FuelTweaks_Quirium&quot;;
this.author                 = &quot;phkb&quot;;
this.copyright              = &quot;2017 phkb&quot;;
this.description            = &quot;Routines for controlling the collection, sale and transport of scooped Quirium fuel&quot;;
this.licence                = &quot;CC BY-NC-SA 4.0&quot;;

/*
    TODO:
        firing on, or using ecm near, to a cargo pod with Quirium inside will result in a cascade explosion
*/

this._scoopDistanceTimer = null;
this._damagedStorage = 0;
this._preProcessAmount = 0;
this._scoopProcess = 0;
this._fuelScoopStorage = false;
this._chs = false;
this._mo_timer = null;
this._purchase = {};
this._minAmount = 0.1;
this._shipConfig = false;
this._scEquip = [];
this._itemColor = &quot;yellowColor&quot;;								
this._menuColor = &quot;orangeColor&quot;;
this._exitColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._startCount = 0;
this._secondTimer = null;
this._transferTimer = null;
this._destructTimer = null;
this._damageChance = 0.05; // 0.1;
this._destructCounter = 0;
this._destructPhase = 0;
this._oneTAmount = 7;                       /// amount of scooped fuel that will be considered &quot;1t&quot;
//this._dumpQuirium = null;

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
    if (missionVariables.FuelTweaks_PreProcessAmount) this._preProcessAmount = missionVariables.FuelTweaks_PreProcessAmount;
    if (missionVariables.FuelTweaks_ScoopProcess) this._scoopProcess = missionVariables.FuelTweaks_ScoopProcess;
    if (worldScripts[&quot;Coronal Harvester Script&quot;]) this._chs = true;
    if (worldScripts.ShipConfiguration_Core) {
        this._shipConfig = true;
    }
    if (worldScripts[&quot;Fuel Collector&quot;]) {
        worldScripts[&quot;Fuel Collector&quot;].$CruiseCheck = this.$fuelCollector_CruiseCheck;
        worldScripts[&quot;Fuel Collector&quot;].$checkifover01 = this.$fuelCollector_checkifover01;
    }
    this.$initInterface(player.ship.dockedStation);
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function(station) {
    if (player.ship.equipmentStatus(&quot;EQ_FUEL_PROCESSOR&quot;) === &quot;EQUIPMENT_OK&quot;) {
        this._scoopDistanceTimer = new Timer(this, this.$monitorPlayer, 5, 5);
    }
    if (this._shipConfig === true) {
        var sc = worldScripts.ShipConfiguration_Core;
        var eq = EquipmentInfo.infoForKey(sc.$equipmentItemInUse(&quot;fuelscoops&quot;, player.ship));
        if (eq) this._minAmount = parseFloat(eq.scriptInfo.accumulator_size) + 0.1;
        // grab a copy of sc equipment that will report itself as damaged, so we don&#39;t double up during a self-destruct
        this._scEquip = [].concat(sc._engines).concat(sc._boosters).concat(sc._hyperdrive).concat(sc._thrusters)
            .concat(sc._energy).concat(sc._frontshields).concat(sc._aftshields).concat(sc._fuelinjectors)
            .concat(sc._fuelscoops).concat(sc._heatshields);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
    missionVariables.FuelTweaks_PreProcessAmount = this._preProcessAmount;
    missionVariables.FuelTweaks_ScoopProcess = this._scoopProcess;
}

//-------------------------------------------------------------------------------------------------------------
this.shipDied = function(whom, why) {
    if (this._scoopDistanceTimer &amp;&amp; this._scoopDistanceTimer.isRunning) this._scoopDistanceTimer.stop();
    this._scoopDistanceTimer = null;
    this.$stopTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function(station) {
    if (this._scoopDistanceTimer &amp;&amp; this._scoopDistanceTimer.isRunning) this._scoopDistanceTimer.stop();
    this._scoopDistanceTimer = null;
    this.$initInterface(station);
    this.$stopTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentDamaged = function(equipmentKey) {
    // if a full storage container gets damaged, remove a fuel commodity from the player
    if (equipmentKey === &quot;EQ_FUEL_PROCESSOR&quot; || equipmentKey === &quot;EQ_FUEL_STORAGE&quot;) {
        var curr = player.ship.manifest[&quot;quirium_fuel&quot;];
        var cntr = this.$countOKContainers();
        if (curr &gt; cntr) {
            player.ship.manifest[&quot;quirium_fuel&quot;] -= (curr - cntr);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function(equipmentKey) {
    var p = player.ship;
    var refundEq = &quot;&quot;;
    if (equipmentKey === &quot;EQ_FUEL_STORAGE_REMOVAL&quot;) {
        p.removeEquipment(&quot;EQ_FUEL_STORAGE_REMOVAL&quot;);
        refundEq = &quot;EQ_FUEL_STORAGE&quot;;
    }
    if (equipmentKey === &quot;EQ_FUEL_PROCESSOR_REMOVAL&quot;) {
        p.removeEquipment(&quot;EQ_FUEL_PROCESSOR_REMOVAL&quot;);
        refundEq = &quot;EQ_FUEL_PROCESSOR&quot;;
        mission.setInstructions(&quot;&quot;, this.name);
    }
    if (equipmentKey === &quot;EQ_FUEL_TRANSFER_REMOVAL&quot;) {
        p.removeEquipment(&quot;EQ_FUEL_TRANSFER_REMOVAL&quot;);
        refundEq = &quot;EQ_FUEL_TRANSFER&quot;;
    }
    if (equipmentKey === &quot;EQ_FUEL_STORAGE&quot;) {
        if (p.equipmentStatus(&quot;EQ_FUEL_STORAGE&quot;, true)[&quot;EQUIPMENT_DAMAGED&quot;] &gt; 0) {
            p.setEquipmentStatus(&quot;EQ_FUEL_STORAGE&quot;, &quot;EQUIPMENT_OK&quot;);
            p.removeEquipment(&quot;EQ_FUEL_STORAGE&quot;);
        }
    }
    if (equipmentKey === &quot;EQ_FUEL_PROCESSOR&quot;) {
        this._preProcessAmount = 0;
        this.$updateManifest();
    }
    if (refundEq !== &quot;&quot;) {
    	var stn = p.dockedStation;
		var eqSts = p.equipmentStatus(refundEq);
        p.removeEquipment(refundEq);
		// refund the cost of the equipment
        if (eqSts === &quot;EQUIPMENT_OK&quot;) player.credits += (eq.price / 10) * stn.equipmentPriceFactor;
        if (eqSts === &quot;EQUIPMENT_DAMAGED&quot;) player.credits += ((eq.price/ 10) * stn.equipmentPriceFactor) / 2;
    }
    if (equipmentKey === &quot;EQ_FUEL_TRANSFER&quot; || equipmentKey === &quot;EQ_FUEL_TRANSFER_REMOVAL&quot;) {
        this.$initInterface(player.ship.dockedStation);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtCargo = function(commodity, units, price) {
    if (commodity === &quot;quirium_fuel&quot;) {
        var spare = this.$countOKContainers() - player.ship.manifest[&quot;quirium_fuel&quot;];
        if (spare &lt; 0) {
            player.consoleMessage(&quot;Unable to purchase Quirium fuel - insufficient fuel storage.&quot;, 5);
            player.ship.manifest[&quot;quirium_fuel&quot;] -= Math.abs(spare);
            player.ship.dockedStation.setMarketQuantity(commodity, player.ship.dockedStation.market[commodity].quantity + Math.abs(spare));
            player.credits += (Math.abs(spare) * (price / 10));
            if (worldScripts.market_observer3) {
                this._mo_timer = new Timer(this, this.$reverseMOPurchase, 0.5, 0);
                this._purchase = {commodity:commodity, units:units, price:price};
            }
            return;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedEscapePod = function(escapepod) {
    this.$stopTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.shipScoopedFuel = function() {
    if (this._fuelScoopStorage === true) {
        // send this fuel to storage
        this._preProcessAmount += this._minAmount;
        this.$updateManifest();
        // display some status info ... somewhere ...
        var checkCalc = parseInt(Math.abs(parseFloat(this._preProcessAmount) - parseFloat(this._oneTAmount) * ((this._scoopProcess + 1) * 0.25)) * 100);
        var p = player.ship;
        if (this._scoopProcess === 2 &amp;&amp; checkCalc &lt;= 5) {
            player.consoleMessage(&quot;75% complete\n&quot;, 5);
            this._scoopProcess += 1;
        }
        if (this._scoopProcess === 1 &amp;&amp; checkCalc &lt;= 5) {
            player.consoleMessage(&quot;50% complete\n&quot;, 5);
            this._scoopProcess += 1;
        }
        if (this._scoopProcess === 0 &amp;&amp; checkCalc &lt;= 5) {
            player.consoleMessage(&quot;25% complete\n&quot;, 5);
            this._scoopProcess += 1;
        }
        if (this._preProcessAmount &gt;= this._oneTAmount) {
            p.manifest[&quot;quirium_fuel&quot;] += 1;
            this._preProcessAmount = 0;
            this._scoopProcess = 0;
            this.$updateManifest();
            player.consoleMessage(&quot;Processed 1t Quirium fuel\n&quot;, 5);
            // add an extra blank line otherwise the &quot;Fuel scoop active&quot; message will overwrite it
            var curr = p.manifest[&quot;quirium_fuel&quot;];
            var cntr = this.$countOKContainers();
            if (curr === cntr) {
                this._fuelScoopStorage = false;
                player.consoleMessage(&quot;All fuel storage units are full - processing halted.\n&quot;, 5);
                return;
            }
            if (p.cargoSpaceAvailable === 0) {
                this._fuelScoopStorage = false;
                player.consoleMessage(&quot;Cargo capacity reached - processing halted.\n&quot;, 5);
                return;
            }
        }
        // subtract the amount from the player&#39;s fuel so 
        p.fuel -= this._minAmount;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipScoopedOther = function(whom) {
    if (whom.isCargo &amp;&amp; whom.commodity === &quot;quirium_fuel&quot;) {
        // we automatically gain an qfsu whenever we scoop quirium fuel
        var p = player.ship;
        p.awardEquipment(&quot;EQ_FUEL_STORAGE&quot;);
        /*var curr = p.manifest[&quot;quirium_fuel&quot;];
        var cntr = this.$countOKContainers();
        if (curr &gt; cntr) {
            // if we don&#39;t have any quirium on board, but we do have a processor, we don&#39;t need to add a separate fuel storage unit
            if (curr === 0 &amp;&amp; player.ship.equipmentStatus(&quot;EQ_FUEL_PROCESSOR&quot;) === &quot;EQUIPMENT_OK&quot;) return;
            var diff = curr - cntr;
            //this._dumpQuirium = new Timer(this, this.$dumpQuirium, 1, 0);
            // player picks up fuel storage unit with the fuel if they don&#39;t have enough of them 
            for (var i = 0; i &lt; diff; i++) {
                p.awardEquipment(&quot;EQ_FUEL_STORAGE&quot;);
            }
        }*/
    }    
}

//-------------------------------------------------------------------------------------------------------------
this.shipDumpedCargo = function(cargo) {
    if (cargo.commodity === &quot;quirium_fuel&quot;) {
        // if we just dumped quirium, we dumped the storage unit with it.
        var result = player.ship.removeEquipment(&quot;EQ_FUEL_STORAGE&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
// not used any more, but kept just in case
/*this.$dumpQuirium = function $dumpQuirium() {
    player.consoleMessage(&quot;Unable to store Quirium Fuel safely - auto-ejecting cargo!&quot;, 5);
    // hopefully this will dump the just-scooped entity
    player.ship.dumpCargo(1, &quot;quirium_fuel&quot;);
}*/

//-------------------------------------------------------------------------------------------------------------
// start the process (after second press)
this.activated = function() {
    if (player.ship.fuel === 7) {
        player.consoleMessage(&quot;Fuel tanks are full. Unable to start fuel transfer.&quot;);
        return;
    }
    if (player.ship.manifest[&quot;quirium_fuel&quot;] === 0) {
        player.consoleMessage(&quot;No Quirium fuel in storage. Unable to start fuel transfer.&quot;);
        return;
    }
    var ft = worldScripts.FuelTweaks_Quirium;
    // stop the process, if it&#39;s running
    if (ft._transferTimer &amp;&amp; ft._transferTimer.isRunning) {ft.mode(); return;}
    // ask the player again before starting
    if (this._startCount === 0) {
        this._startCount = 1;
        ft._secondTimer = new Timer(ft, ft.$cancelStart, 20, 0);
        player.consoleMessage(&quot;Activate again to begin fuel transfer.&quot;);
        return;
    }
    // ok we&#39;re really starting now
    if (this._startCount === 1) {
        this._startCount = 0;
        if (ft._secondTimer.isRunning) ft._secondTimer.stop();
        ft._transferTimer = new Timer(ft, ft.$doFuelTransfer, 2, 2);
        player.consoleMessage(&quot;Fuel transfer started.&quot;, 2);
    }
}

//-------------------------------------------------------------------------------------------------------------
// stop process
this.mode = function() {
    var ft = worldScripts.FuelTweaks_Quirium;
    if (ft._transferTimer &amp;&amp; ft._transferTimer.isRunning) {
        player.ship.manifest[&quot;quirium_fuel&quot;] -= 1;
        ft._damageChance = 0.05;
        ft._transferTimer.stop();
        player.consoleMessage(&quot;Fuel transfer stopped. 1t Quirium fuel consumed.&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$cancelStart = function $cancelStart() {
    this._startCount = 0;
}

//-------------------------------------------------------------------------------------------------------------
this.$doFuelTransfer = function $doFuelTransfer() {
    var p = player.ship;
    if (p.equipmentStatus(&quot;EQ_FUEL_TRANSFER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) {
        this.mode();
        return;
    }
    p.fuel += 0.1;
    if (p.fuel &gt;= 7) {
        p.fuel = 7;
        player.consoleMessage(&quot;Fuel tanks full. Transfer completed.&quot;);
        this.mode();
        return;
    }
    player.consoleMessage(&quot;Fuel transfer in progress&quot;, 1.5);
    // will there be damage?
    if (Math.random() &lt; this._damageChance) {
        // yes there is
        // but what type?
        var type = Math.random();
        if (type &gt;= 0 &amp;&amp; type &lt; 0.76) {
            // cargo - grab a copy of the array
            var c = p.manifest.list.splice(0);
            // sort it randomly
            c.sort(function(a, b) { return Math.random() - 0.5; });
            var amt = 0;
            var cmdty = &quot;&quot;;
            var unit = &quot;t&quot;;
            for (var i = 0; i &lt; c.length; i++) {
                if (c[i].quantity &gt; 0 &amp;&amp; c[i].unit === &quot;t&quot;) {
                    amt = 1;
                    cmdty = c[i].commodity;
                    p.manifest[c[i].commodity] -= 1;
                    break;
                }
                if (c[i].quantity &gt; 0 &amp;&amp; c[i].unit !== &quot;t&quot;) {
                    amt = Math.floor(Math.random() * c[i].quantity) + 1;
                    cmdty = c[i].commodity;
                    unit = c[i].unit;
                    p.manifest[c[i].commodity] -= amt;
                    break;
                }
            }
            if (cmdty != &quot;&quot;) {
                player.consoleMessage(&quot;Warning! &quot; + amt + unit + &quot; of &quot; + displayNameForCommodity(cmdty) + &quot; destroyed!&quot;);
                var mySound = new SoundSource;
                mySound.sound = &quot;[player-scrape-damage]&quot;;
                mySound.loop = false;
                mySound.play();
                // check to see if we&#39;ve destroyed all the stored quirium fuel 
                if (cmdty === &quot;quirium_fuel&quot; &amp;&amp; p.manifest[cmdty] === 0) {
                    this._damageChance = 0.05;
                    this._transferTimer.stop();
                    player.consoleMessage(&quot;Fuel transfer stopped. Insufficient Quirium fuel available.&quot;);
                }
            } else {
                // theoretically this can never happen - if there&#39;s no cargo to destroy, then there&#39;s
                // no quirium fuel left, so the process should have been stopped in the clause above
                type = 0.6; // switch to equipment damage if no cargo available
            }
        }
        if (type &gt;= 0.76 &amp;&amp; type &lt; 0.995) {
            // equipment
			this.$performEquipmentDamage();
        }
        if (type &gt;= 0.995) {
            this._transferTimer.stop();
            p.script._findMe = true;
            // oh dear - the ship!
            player.consoleMessage(&quot;ALERT! Catastrophic internal fuel leak!&quot;);
            // start the self-destruct sequence
            this._destructPhase = 0;
            this._destructTimer = new Timer(this, this.$destructSequence, 2, 2);
            // slowly damage every equipment item
            // turn off hud and replace with custom one that only has console at top left corner
            // show a brief series of error messages then either (a) eject the player or (b) destroy their ship.
        }
    }
    this._damageChance += 0.01;
}

this.$testDestruct = function () {
    // oh dear - the ship!
    player.consoleMessage(&quot;ALERT! Catastrophic internal fuel leak!&quot;);
    // start the self-destruct sequence
    this._destructPhase = 0;
    this._destructTimer = new Timer(this, this.$destructSequence, 2, 2);
}

//-------------------------------------------------------------------------------------------------------------
this.$destructSequence = function $destructSequence() {
    this.$performEquipmentDamage();
    this._destructCounter += 1;
    if (this._destructCounter &gt; 8) {
        // switch off hud
        this._storeHUD = player.ship.hud;
        player.ship.hud = &quot;destruct_hud.plist&quot;;
        // unbreak the breakable IFF scanner (if present and damaged) so the final sequence display is shown clearly
        if (player.ship.equipmentStatus(&quot;EQ_BREAKABLE_HUD_IFF_SCANNER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) player.ship.setEquipmentStatus(&quot;EQ_BREAKABLE_HUD_IFF_SCANNER&quot;, &quot;EQUIPMENT_OK&quot;);
        this._destructPhase = 1;
        this._destructTimer.stop();
        this._destructCounter = 0;
        this._destructTimer = new Timer(this, $destructFinalSequence, 1, 1);
    }
}

//-------------------------------------------------------------------------------------------------------------
// we&#39;re doing this manually, rather than using takeInternalDamage, so we can (a) exclude some items, and (b) only damage equipment
this.$performEquipmentDamage = function() {
    // list of equipment items we don&#39;t want to damage (either because they&#39;re critical to gameplay, or it just doesn&#39;t make sense)
    var noDamage = [&quot;EQ_HULL_REPAIR&quot;];
    var p = player.ship;

    // grab a copy of the equipment list
    var eq = p.equipment.slice(0);
    // randomly sort the list
    eq.sort(function(a, b) { return Math.random() - 0.5; });
    for (var i = 0; i &lt; eq.length; i++) {
        var eqItem = eq[i];
        // find an item to damage (but not the escape pod)
        if (noDamage.indexOf(eqItem.equipmentKey) === -1 &amp;&amp; eqItem.provides.indexOf(&quot;EQ_ESCAPE_POD&quot;) === -1 &amp;&amp; p.equipmentStatus(eqItem.equipmentKey) == &quot;EQUIPMENT_OK&quot; &amp;&amp; eqItem.damageProbability != 0 &amp;&amp; eqItem.isVisible == true &amp;&amp; Math.random() &lt;= eqItem.damageProbability) {
            p.setEquipmentStatus(eqItem.equipmentKey, &quot;EQUIPMENT_DAMAGED&quot;);
            if (this._scEquip.indexOf(eqItem.equipmentKey) === -1) {
                player.consoleMessage(&quot;Warning! Fuel leak! &quot; + eqItem.name + &quot; damaged!&quot;);
            }
            var mySound = new SoundSource;
            mySound.sound = &quot;[player-scrape-damage]&quot;;
            mySound.loop = false;
            mySound.play();
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$destructFinalSequence = function $destructFinalSequence() {
    var msg = [
        &quot;&quot;,
        &quot;Life support system failure!&quot;,
        &quot;Environmental control failure!&quot;,
        &quot;Hull breach!&quot;,
        &quot;Structure integrity failing!&quot;,
        &quot;Oxygen venting detected!&quot;,
        &quot;Complete atmosphere loss in 1 sec&quot;
    ];
    this._destructCounter += 1;
    if (this._destructCounter &lt; msg.length) {
        player.consoleMessage(msg[this._destructCounter]);
        return;
    }
    if (this._destructCounter &gt;= msg.length) {
        if (this._destructPhase === 1) this._destructPhase = 2;
        if (this._destructPhase === 2 &amp;&amp; player.ship.hasEquipmentProviding(&quot;EQ_ESCAPE_POD&quot;) === &quot;EQUIPMENT_OK&quot;) {
            player.consoleMessage(&quot;Auto-eject sequence initiated&quot;);
            player.ship.throwSpark();
            this._destructPhase = 3;
            player.ship.abandonShip();
            return;
        }
        this._destructTimer.stop();
        this._explodeTimer = new Timer(this, this.$explodeShip, 0.25, 0);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$explodeShip = function $explodeShip() {
    this.$stopTimers();
    player.ship.explode();
    player.ship.hud = this._storeHUD;
}

//-------------------------------------------------------------------------------------------------------------
this.$stopTimers = function() {
    if (this._secondTimer &amp;&amp; this._secondTimer.isRunning) this._secondTimer.stop();
    if (this._transferTimer &amp;&amp; this._transferTimer.isRunning) this.mode();
    if (this._scoopDistanceTimer &amp;&amp; this._scoopDistanceTimer.isRunning) this._scoopDistanceTimer.stop();
    if (this._destructTimer &amp;&amp; this._destructTimer.isRunning) this._destructTimer.stop();
    //if (this._dumpQuirium &amp;&amp; this._dumpQuirium.isRunning) this._dumpQuirium.stop();
}

//-------------------------------------------------------------------------------------------------------------
// initialise the F4 screen entries
this.$initInterface = function(station) {
    if (player.ship.equipmentStatus(&quot;EQ_FUEL_TRANSFER&quot;) === &quot;EQUIPMENT_OK&quot;) {
        station.setInterface(this.name,{
            title:&quot;Quirium fuel transfer&quot;,
            category:&quot;Ship Systems&quot;,
            summary:&quot;Allows scooped Quirium fuel in fuel containers to be transferred safely to your ship&#39;s fuel tank.&quot;,
            callback:this.$showScreen.bind(this)
        });
    } else {
        station.setInterface(this.name, null);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$showScreen = function() {
    var text = &quot;&quot;;
    if (player.ship.manifest[&quot;quirium_fuel&quot;] === 0 || player.ship.fuel === 7) {
        text = &quot;No Quirium fuel in your hold. No transfer available.&quot;;
        if (player.ship.fuel === 7) text = &quot;Fuel tanks are full. No transfer required.&quot;;
		mission.runScreen({
			screenID:&quot;oolite-quirium-fuel-map&quot;,
			title: &quot;Quirium Fuel Transfer&quot;,
			overlay: {name:&quot;fuelTweaks_pump.png&quot;, height:546},
			message: text,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
		});
    } else {
        text = &quot;Confirm you wish to transfer &quot; + (7 - player.ship.fuel) + &quot;ly of fuel from your cargo hold to your ship&#39;s fuel tank.&quot;
            + &quot;\n\nNote: 1t of Quirium will be consumed in this transfer.&quot;;
        var curChoices = {};
		curChoices[&quot;01_YES&quot;] = {text:&quot;Process with transfer&quot;, color:this._menuColor};
		curChoices[&quot;02_NO&quot;] = {text:&quot;Return&quot;, color:this._menuColor};

		var opts = {
			screenID: &quot;oolite-quirium-transfer-map&quot;,
			title: &quot;Confirm Quirium Fuel Transfer&quot;,
			overlay: {name:&quot;fuelTweaks_pump.png&quot;, height:546},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: &quot;02_NO&quot;,
			message: text
		};
    	mission.runScreen(opts, this.$screenHandler, this);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$screenHandler = function(choice) {
    if (!choice) return;
    if (choice === &quot;01_YES&quot;) {
        var amt = 7 - player.ship.fuel;
        player.ship.fuel = 7;
        player.ship.manifest[&quot;quirium_fuel&quot;] -= 1;
        player.consoleMessage(amt + &quot;ly fuel transferred to main tank.\n1t Quirium Fuel used.&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$reverseMOPurchase = function() {
    var mo = worldScripts.market_observer3;
    mo.playerSoldCargo(this._purchase.commodity, this._purchase.units, this._purchase.price);
    this._purchase = {};
}

//-------------------------------------------------------------------------------------------------------------
this.$monitorPlayer = function $monitorPlayer() {
    var p = player.ship;
    if (this.$playerWithinFuelScoopRange() === true) {
        // if it&#39;s already on, don&#39;t start it again
        if (this._fuelScoopStorage === true) return;
        // stay out of the way of the coronal harvester
        if (this._chs) {
            var chs = worldScripts[&quot;Coronal Harvester Script&quot;];
            if (chs._vicinitySunTimer &amp;&amp; chs._vicinitySunTimer.isRunning) return;
        }
        // do we have a processor?
        if (p.equipmentStatus(&quot;EQ_FUEL_PROCESSOR&quot;) === &quot;EQUIPMENT_OK&quot;) {
            // how much space do we have?
            var curr = p.manifest[&quot;quirium_fuel&quot;];
            var cntr = this.$countOKContainers();
            // if we have spare containers, and our fuel tanks are full, we can turn on the storage process
            if (curr &lt; cntr &amp;&amp; p.fuel &gt;= 7 &amp;&amp; p.cargoSpaceAvailable &gt; 0) {
                // we have free space
                // enable some scooping action
                this._fuelScoopStorage = true;
                p.fuel -= this._minAmount;
            }
        }
    } else {
        // if the fuel process was active, and we&#39;re about to turn it off, make sure we give the player their fuel back.
        if (this._fuelScoopStorage === true) player.ship.fuel = 7;
        this._fuelScoopStorage = false;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$playerWithinFuelScoopRange = function() {
    if (!system.sun) return false;
    if (((system.sun.collisionRadius * system.sun.collisionRadius) / system.sun.position.squaredDistanceTo(player.ship.position)) &gt; 0.75) return true;
    return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns the number of fuel containers
this.$countFuelContainers = function() {
	var fc = 0;
	var eq = player.ship.equipment;
	for (var i = 0; i &lt; eq.length; i++) {
		if (eq[i].equipmentKey === &quot;EQ_FUEL_STORAGE&quot;) fc += 1;
	}
	return fc;
}

//-------------------------------------------------------------------------------------------------------------
this.$countOKContainers = function() {
    if (player.ship &amp;&amp; player.ship.equipmentStatus(&quot;EQ_FUEL_STORAGE&quot;, true) != undefined) {
        return player.ship.equipmentStatus(&quot;EQ_FUEL_STORAGE&quot;, true)[&quot;EQUIPMENT_OK&quot;] + (player.ship.equipmentStatus(&quot;EQ_FUEL_PROCESSOR&quot;) === &quot;EQUIPMENT_OK&quot; ? 1 : 0);
    } else {
        return 0;
    }
}

//-------------------------------------------------------------------------------------------------------------
// fuel collector function overrides to enable fuel collection interface
this.$fuelCollector_checkifover01 = function(fuel_award) {
    this.fuel_below01 += fuel_award;
    var ftq = worldScripts.FuelTweaks_Quirium;
    if (this.fuel_below01 &gt; 1000) {
        // only do something if we&#39;re /not/ in fuel scoop range of the sun
        // when we&#39;re in scoop range of the sun, the fuel scoop itself will take over
        if (ftq.$playerWithinFuelScoopRange() === false) {
            // if we have full fuel, pass the quirium over to the quirium fuel accumulator
            if (player.ship.fuel === 7) {
                var curr = player.ship.manifest[&quot;quirium_fuel&quot;];
                var cntr = ftq.$countOKContainers();
                // are we in fuel scooping range?
                if (ftq._fuelScoopStorage === false &amp;&amp; curr &lt; cntr) {
                    ftq._fuelScoopStorage = true;
                    player.consoleMessage(&quot;Fuel Collector &gt;&gt; Quirium Fuel Storage&quot;, 10);
                    player.consoleMessage(&quot;Gathered fuel: 0.1 ly&quot;, 10);
                    ftq.shipScoopedFuel();
                    player.ship.fuel = 7;
                    ftq._fuelScoopStorage = false;
                }
            } else if (player.ship.fuel &lt; 7) {
                // otherwise, it&#39;s just the normal fuel collector process here.
                player.ship.fuel += 0.1;
                player.consoleMessage(&quot;Fuel Collector&quot;, 10);
                player.consoleMessage(&quot;Gathered fuel: 0.1 ly&quot;, 10);
            }
        }
        this.fuel_below01 -= 1000;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$fuelCollector_CruiseCheck = function() {
	if (player.ship.docked) {
		this.CruiseCheckTimer.stop()
		return // return because we really dont need more checking from here
			//return also saves a few cycles, instead of having the CPU do 3 extra Compares it just jumps to an address in memory
	}
	
	//if(this.tonearplanet) //if it is zero, then return
	//return
	
	// we never got here if the fuel collector was not started in the first place which is why
        // we can use explicit OR	
	if (player.ship.equipmentStatus(&quot;EQ_FRAME_FUEL_COLLECTOR&quot;) != &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_FUEL_SCOOPS&quot;) != &quot;EQUIPMENT_OK&quot;) { //is EQ damaged ?
		this.CruiseCheckTimer.stop() // should we stop or keep it running, in order for it to be repaired..
		//i&#39;d say performance is of the essense here, therefore we kill it until next witchspace / station launch
		return // return because we really dont need more checking from here
	}
    	
	//player.ship.consoleMessage(&quot;entering cruisecheck&quot;, 3) // for testing
	
		
	//if(system.isInterstellarSpace) //some person in the future might add a sun in interstellar space
	if(!system.sun) {
			//so if there is a sun present, it will activate the crusing mode collector	
		if(this.ispaceswitch &amp;&amp; this.firstrun) {
			this.ispaceswitch = false
			this.firstrun = false
			player.consoleMessage(&quot;Fuel Collector&quot;,3)
			player.consoleMessage(&quot;Interstellar space: Fly at max speed to extract fuel&quot;,3)
		}
		
		//if there is not a sun there it will extract whatever it can from its surroundings..
		//however only as long as the player is at max speed.
		if(player.ship.speed == player.ship.maxSpeed)		
		this.$checkifover01(this.fuel_level_1*Math.random())
		return  
	} else {		
		//what distance are we at to the star
		// to close and it will shutdown, to far away it will collect very little
		
		/* a notice on why it shuts down, when to close
		
		due to the fine filter of the fuel collector, it will shut down when it
		gets to close to the star so that the filter is having a chance of getting
		cleaned by the subsequent cleaning, which in effect harvest the fuel from
		the filter
		
		The fuel scoop will then take over shortly after..
		*/
		
		
		let sun_distance = player.ship.position.distanceTo(system.sun)+system.sun.radius	
		/* This is the old shut off if to close to sun..
		// this however didnt take into consideration, the proximity to the planet
		*/
		
		if ((player.ship.speed &gt; player.ship.maxSpeed) || ( 7 == player.ship.fuel &amp;&amp; !worldScripts.FuelTweaks_Quirium)) {//|| means explicit or // injector or warp speed
            return // return because we really dont need more checking from here
		}
		
		let distancemodifier =10
				
		if(sun_distance&lt; this.averagesun)
		distancemodifier = 30
		if(sun_distance&lt; this.nearsun)
		distancemodifier = 50 //this is near the filters saturation limit,..
				
		let speedp = 100/player.ship.maxSpeed*player.ship.speed
		
		if (speedp&gt;89) {
			this.$checkifover01(this.fuel_level_4+distancemodifier)			
			//player.consoleMessage(&quot;speed over 89 %&quot;, 3) // for testing
			return			
		}
		
		if(speedp&gt;49) {
			this.$checkifover01(this.fuel_level_3+distancemodifier)
			//player.consoleMessage(&quot;speed over 49 %&quot;,3) // for testing
			return			
		}
		
		if(speedp&gt;19) {
			this.$checkifover01(this.fuel_level_2+distancemodifier)
			//player.consoleMessage(&quot;speed over 19 %&quot;,3) // for testing
			return			
		}		
	}
}

this.$updateManifest = function $updateManifest() {
    mission.setInstructions(&quot;Quirium Fuel Processor status: &quot; + (parseFloat(this._preProcessAmount / this._oneTAmount) * 100).toFixed(1) + &quot;%% full&quot;,this.name);
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_station.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;FuelTweaks_Station&quot;;
this.author					= &quot;Thargoid&quot;;
this.copyright				= &quot;Creative Commons: attribution, non-commercial, sharealike with clauses - see readme.txt&quot;;
this.description			= &quot;Script for fuel station&quot;;

//-------------------------------------------------------------------------------------------------------------
this.shipSpawned = function() { 
	this.ship.scannerDisplayColor1 = &quot;greenColor&quot;;
	this.ship.scannerDisplayColor2 = &quot;lightGrayColor&quot;;

	var traders = system.shipsWithPrimaryRole(&quot;trader&quot;, this.ship, 50E3)	
	if (traders.length &gt; 0 &amp;&amp; traders[0].AIState == &quot;HEAD_FOR_PLANET&quot;) {
		traders[0].script.checkFuelStationDistance = this.checkFuelStationDistance; // attach function to script.
		traders[0].script.checkUsage = this.checkUsage; // attach function to script.
		traders[0].setAI(&quot;fuelTweaks_gotoFuelStationAI.plist&quot;);
	}

	//  line the station up with the route one. Code borrowed from Anarchies for convenience.
	if (system.isInterstellarSpace || !system.mainPlanet) return;
	var targetVector = system.mainPlanet.position.subtract(this.ship.position).direction();
	var angle = this.ship.heading.angleTo(targetVector);
	var cross = this.ship.heading.cross(targetVector).direction();
	this.ship.orientation = this.ship.orientation.rotate(cross, -angle);	
	this.setColour();
	this.setPrice();
}

//-------------------------------------------------------------------------------------------------------------
this.setColour = function() {
	this.colRand = system.scrambledPseudoRandomNumber(45.32);
	var colName = &quot;yellowColor&quot;;
	if (this.colRand &lt; 0.25) colName = &quot;blueColor&quot;;
	if (this.colRand &lt; 0.75) colName = &quot;redColor&quot;;
	if (this.colRand &gt; 0.25 &amp;&amp; this.colRand &lt; 0.5) colName = &quot;magentaColor&quot;;
	this.ship.setMaterials({&quot;fuelTweaks_station.png&quot;: { diffuse: colName }});
}
	
//-------------------------------------------------------------------------------------------------------------
this.setPrice = function() {
	var fe = worldScripts.FuelTweaks_FuelEconomy;
	var cf = fe.$getRefuelStationCostFactor();
	this.fuelPrice = cf * EquipmentInfo.infoForKey(&quot;EQ_FUEL&quot;).price * player.ship.fuelChargeRate; // price per 0.1LY of fuel
	if (system.economy === 0 || system.economy === 5) this.fuelPrice *= 1.2; //  rich industrial or agricultural
	if (system.techLevel &gt; 4 &amp;&amp; system.techLevel &lt; 11) this.fuelPrice *= 1.1; //  mid-tech level
	this.fuelPrice = this.decPlaces(this.fuelPrice,2);
}	

//-------------------------------------------------------------------------------------------------------------
this.decPlaces = function(number, places) {
	if (!places || places &lt; 0) places = 0;
	if (!number) return 0;
	return ((Math.round(number * Math.pow(10, places))) / Math.pow(10, places));
}
	
//-------------------------------------------------------------------------------------------------------------
this.playerDetected = function() {
	this.firstMessage = true;
	this.fuelTransferred = 0; // how many 0.1LY units are transferred
	this.fuelBill = 0;
	this.ship.commsMessage(&quot;Greetings Commander &quot; + player.name + &quot;. Refuel here for only &quot; + this.decPlaces((10 * this.fuelPrice),1) + &quot; credits per ly&quot;);
	if (this.scanTimer) {
		this.scanTimer.start();
	} else {
		this.scanTimer = new Timer(this, this.locatePlayer, 0, 0.50);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.locatePlayer = function locatePlayer() {
	if (!this.ship ||!this.ship.isValid || !this.ship.position || !player.ship.isValid) { 
		// if the ship no longer exists but timer is running, e.g. if player has jumped whilst near a satellite into a system without one
		this.playerGone();
		return;
	}

	if (this.ship.position.distanceTo(player.ship) &lt; 150) {
		// player ship within 150m of the centre of the fuel station
		if (player.ship.fuel &lt; 7) {
			if (player.credits &gt; this.fuelBill) {
				// player in place, fuel tank not full and credit balance not empty
				player.ship.fuel += 0.1;
				this.fuelBill += this.fuelPrice;
				this.fuelTransferred++;

				if (this.firstMessage) {
					player.consoleMessage(&quot;Fuel transfer is underway, please come to a halt.&quot;, 6);
					this.firstMessage = false;
				}
				return;
			} else { // not enough funds left
				player.consoleMessage(&quot;Insufficient credits remaining, transfer terminated.&quot;, 6);
				this.scanTimer.stop();
				return;
			}
		} else { // Fuel tank full
			player.consoleMessage(&quot;Fuel tanks are full.&quot;, 6);
			this.scanTimer.stop();
			return;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipTraversePositiveZ = this.shipTraverseNegativeZ = function(ship) {
	if (ship.isPlayer) this.playerLeaving()
}

//-------------------------------------------------------------------------------------------------------------
this.playerLeaving = function() {
	this.fuelBill = this.decPlaces(this.fuelPrice * this.fuelTransferred,1);
	player.consoleMessage(&quot;Summary - &quot; + (this.fuelTransferred / 10) + &quot; ly transferred, &quot; + this.fuelBill + &quot; credits charged.&quot;, 6);
	player.credits -= this.fuelBill;
	this.fuelTransferred = 0;
	this.fuelBill = 0;
	this.firstMessage = true;
}
    
//-------------------------------------------------------------------------------------------------------------
this.playerWillEnterWitchspace = this.playerGone = function() {
	if(this.scanTimer) {
		this.scanTimer.stop();
		delete this.scanTimer;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDied = function(whom, why) {
	this.playerGone();
	this.fuelCount = (Math.ceil(Math.random() * 30) + 30);
	this.ship.spawn(&quot;fuelStation_burningFuel&quot;, this.fuelCount); // lets make this go with a bang!

	if (whom &amp;&amp; whom.isPlayer) {
		player.consoleMessage(&quot;CCTV beam towards the main station detected.&quot;, 6);
		player.score -=1; // don&#39;t condone vandalism!
		player.ship.setBounty(player.bounty + 20, &quot;damaged property&quot;);
	}
}

//-------------------------------------------------------------------------------------------------------------
// below not used by stationscript but is attached to traderscript.
this.checkFuelStationDistance = function() {	
	if (this.ship.position.distanceTo(this.ship.target) &gt; 50E3) {
		this.ship.reactToAIMessage(&quot;NEXT_FUELSTATION&quot;)
	}
}

//-------------------------------------------------------------------------------------------------------------
this.checkUsage = function() {
	if (this.ship.target.position.distanceTo(player.ship) &lt; 1000) {
		this.ship.reactToAIMessage(&quot;NEXT_FUELSTATION&quot;)
	} else {
		this.ship.reactToAIMessage(&quot;STATION_CLEAR&quot;)
	}
}
	
//-------------------------------------------------------------------------------------------------------------
this.attackedMessage = function() {
	this.ship.commsMessage(&quot;ALERT - fuel station under attack, explosion danger!&quot;);
}	
	
//-------------------------------------------------------------------------------------------------------------
this.collisionMessage = function() {
	this.ship.commsMessage(&quot;ALERT - proximity detection, please take evasive action&quot;);
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fuelTweaks_stationSetup.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;FuelTweaks_StationSetup&quot;;
this.author					= &quot;Thargoid&quot;;
this.copyright				= &quot;Creative Commons: attribution, non-commercial, sharealike with clauses - see readme.txt&quot;;
this.description			= &quot;Script to add fuel station to certain systems&quot;;

this._notify = false;

//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
	if (missionVariables.FuelTweaks_Notice) this._notify = missionVariables.FuelTweaks_Notice;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	if (worldScripts.BountySystem_Core) {
		worldScripts.BountySystem_Core._offenceTypes[&quot;damaged property&quot;] = {description:&quot;Willful damage of GalCop property.&quot;, severity:2};
	}
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function() {
	if (this._notify == false) {
		this._notify = true;
		/*mission.runScreen({
			screenID:&quot;oolite-fueltweaks-notice-map&quot;,
			title: &quot;Change to refuelling process&quot;,
			model:&quot;fuelTweaks_station&quot;,
			spinModel:true,
			message: this.$duplicate(&quot;=&quot;, 32) + &quot;\nOfficial GalCop Notice:\n&quot; + this.$duplicate(&quot;-&quot;, 32) + &quot;\n\nDue to a spate of accidents involving refuelling at GalCop stations, all pilots need to be aware of new rules and processes governing the refuelling of ships.\n\nYou will no longer be able to fully refuel your ship at GalCop stations. Instead, GalCop have installed a specialised refuelling station near the main station of many systems. Pilots can enter these facilities to refuel.\n\nThere are a few places where these refuelling stations are not yet able to be installed, and so you will be able to purchase an emergency fuel ration from those stations.\n\nWe thank you for your support and help in making our stations safer.\n\nGalCop Port Authority&quot;,
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;
		});*/
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
	missionVariables.FuelTweaks_Notice = this._notify;
}

//-------------------------------------------------------------------------------------------------------------
this.systemWillPopulate = function() {
	if (system.isInterstellarSpace || system.sun.isGoingNova || system.sun.hasGoneNova || system.countShipsWithRole(&quot;fuelTweaks_location&quot;) &gt; 0) return;

	// no anarchy system, and no really low-tech systems
	var fe = worldScripts.FuelTweaks_FuelEconomy;
	if (fe.$isRefuelStationAvailable() === false) return;

	var posFS = system.mainStation.position.add(system.mainStation.vectorForward.multiply(system.mainStation.scannerRange * -0.8));

	system.setPopulator(&quot;fuel_station&quot;, {
		location: &quot;COORDINATES&quot;,
		coordinates: posFS,
		callback: function(pos) {
			var fs = system.addShips(&quot;fuelTweaks_station&quot;, 1, pos, 0);
		}}
	);
}

//-------------------------------------------------------------------------------------------------------------
// duplicates text until it is just less than the desired length;
this.$duplicate = function(text, desiredLength) {
	var res = &quot;&quot;;
	do {
		res += text;
	} while (defaultFont.measureString(res) &lt; desiredLength);

	res = res.substring(1, res.length);
	return res;
}

</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
