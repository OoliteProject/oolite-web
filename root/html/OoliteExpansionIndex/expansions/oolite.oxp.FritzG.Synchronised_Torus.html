<html>
    <head>
        <title>Expansion Synchronised Torus</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Synchronised Torus</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Enables torus drive synchronisation with NPC ships escorted by the player.</td>
                    <td>Enables torus drive synchronisation with NPC ships escorted by the player.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.FritzG.Synchronised_Torus</td>
                    <td>oolite.oxp.FritzG.Synchronised_Torus</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Synchronised Torus</td>
                    <td>Synchronised Torus</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Fritz G.</td>
                    <td>Fritz G.</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.0</td>
                    <td>1.0</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Synchronised_Torus_OXP">http://wiki.alioth.net/index.php/Synchronised_Torus_OXP</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/e/ec/Synchronised_Torus_1.0.oxz">https://wiki.alioth.net/img_auth.php/e/ec/Synchronised_Torus_1.0.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873506</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Synchronised%20Torus'>http://wiki.alioth.net/index.php/Synchronised%20Torus</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SYNC_TORUS.html">Torus synchronisation</a></td>
                    <td>no</td>
                    <td align="right">1</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/st_equipment.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	     = &quot;Synchronised_Torus_Controller&quot;;
this.version     = &quot;1.0&quot;;    // 2015-12-14
this.description = &quot;equipment script for torus drive synchronisation&quot;;
this.author	     = &quot;Fritz G.&quot;;   
this.copyright	 = &quot;© 2015 Fritz G.&quot;;
this.licence	 = &quot;CC BY-NC-SA 4.0&quot;;

//------------------------------------------------------------------------------------------------------------
// Credits to Capt. Murphy for his idea to implement torus synchronisation in his Escort Contracts OXP.
//------------------------------------------------------------------------------------------------------------
// This OXP is based on an idea I had when escorting slow freighters. Because NPX ships have no torus drive,
// this can take very long, if you want to follow them all the way from witchpoint to station.
// Later I discovered Escort Contracts OXP, using &quot;torus synchronisation&quot; to speed up the game.
// This of course works only for the ship you have agreed to escort, but using the same basic technique
// (simulating torus drive by using a high velocity) I was able to make this available for all ships 
// that are underway in a straight line to a distant destination. That could be traders, bounty hunters,
// vipers or even pirates or assassins on their way to the station, the witchpoint or the sun. 
// In theory this should work with all ships regardless of role, including OXP ships. Only Thargoids are 
// excluded but they usually attack and dont&#39;t fly to a distant destination. 
// 
// Because the player shouldn&#39;t be able to change the destination of a NPC ship, the direction of torus 
// driving (and its speed) is defined by the NPC. The torus drive stops if the destination is reached or  
// if either the player or the mother is mass locked. 
//------------------------------------------------------------------------------------------------------------
// configuration (values taken from Escort Contracts v1.7.1)
this.$st_minDist     	= 500;	// minimum distance to NPC ship in game meters
this.$st_maxDist     	= 2500;	// maximum distance to NPC ship in game meters
this.$st_headingAlign  	= 0.98;	// precision needed for heading alignment (1 is exact (impossible!), 0.9 is too easy and looks odd) 
this.$st_timerInterval  = 0.75; // The Escort Contracts AI checks once per second, but a little more often can&#39;t do damage.
//------------------------------------------------------------------------------------------------------------
this.$st_timerRunning = false;  
this.$st_npc = null;           // will hold the ship object of the npc 
this.$st_nbEscorts = 0;        // number of npc escorts 
// for saving scanner properties of targeted npc ship
this.$st_scanClass = &quot;&quot;; 	   	 
this.$st_scanColour1 = null;
this.$st_scanColour2 = null;
this.$st_scanDescription = null;
// sound
this.$st_beep = null;  
this.$st_beepSounds = [];      // array for storing the different sounds 

// Key &quot;n&quot; pressed for starting or stopping torus synchronisation.
this.activated = function ()
{
    if (!this.$st_timerRunning) this.$st_init(); // initialize timer and sounds

	if (worldScripts[&quot;Synchronised_Torus&quot;].$st_torusEngaged) 
	{
		// stop synchronised torus 
        this.$st_stopTorus(1);
		this.$st_message(&quot;Synchronised torus stopped.&quot;, 2);
	}
	else
	{	
		// try to start synchronised torus 
		// first check the conditions (NPC targeted, correct distance and heading, NPC destination, mass locking)
		if (this.$st_checkConditions(1))
		{
			this.$st_message(&quot;Synchronised torus drive engaged.&quot;, 1);
			// Because the core game doesn&#39;t feature torus drives for npc ships, we have to simulate 
			// it by a high velocity. The factor 32 is the same as used for the standard torus drive.
			// Synchronised torus speed is defined by the npc ship because it is the leader.
			// For exact synchronisation of velocities the timer interval is too long, so use frame callback.	
			this.$st_frameCallback = addFrameCallback(this.$st_matchVelocity.bind(this));   
			this.$st_npc.velocity = this.$st_npc.heading.multiply(this.$st_npc.maxSpeed * 32); 
			// velocity will be synchronised in this.$st_matchVelocity(), but if we dont&#39;t do it here, the npc  
			// will start up to 1/60s (frame rate) earlier, and this is visible because of the very high speed.
			player.ship.velocity = this.$st_npc.velocity;
			if (this.$st_nbEscorts &gt; 0)  this.$st_setEscortVelocity(this.$st_npc.velocity);
			worldScripts[&quot;Synchronised_Torus&quot;].$st_torusEngaged = true;
			this.$st_timer.start();      
		}
		else
		{
			// Initialisation failed, reset the npc scanner class.
			this.$st_resetScanClass();
		}	
	}	
};

// Key &quot;b&quot; pressed, show distance to target waypoint.
this.mode = function () 
{
    if (!this.$st_timerRunning) this.$st_init(); // initialize sounds (and timer)

	var pst = player.ship.target;
	if (!pst)
	{
		this.$st_message(&quot;No target selected.&quot;, 2);
	}		
	else if (!pst.isPiloted || pst.isStation)
	{	
		this.$st_message(&quot;Unsuitable target.&quot;, 2);
	}
	else
	{
		this.$st_message(&quot;Distance to waypoint: &quot; + Math.round(pst.position.distanceTo(pst.destination)/1000) + &quot; km.&quot;, 0);
	}		
};

// Check if conditions allow starting or continuing torus synchronisation. 
// Function called on activation (n key) (1) and in timer function (2).
this.$st_checkConditions = function(calledBy)
{
	var ps = player.ship;
    if (calledBy === 1)
    {
		// Checks only needed when starting (conditions shouldn&#39;t change after starting).
		// First we have to check if something is targeted,
		if (!ps.target) 
		{
			this.$st_message(&quot;No target selected.&quot;, 2);
			return false;
		}		
		this.$st_npc = ps.target;
		this.$st_nbEscorts = this.$st_npc.escortGroup.count - 1;  		
		// Exclude unsuitable &quot;ships&quot;
		// An Escort Contracts mother is unsuitable because the results could be unpredictable...
		// Usually the mother starts synchronised torus driving anyway if it is possible.
		// Escape capsules are piloted but don&#39;t have a torus drive.
		if (!this.$st_npc.isPiloted || this.$st_npc.isThargoid || this.$st_npc.isStation || this.$st_npc.primaryRole === &quot;ec_mother&quot; || this.$st_npc.primaryRole === &quot;escape-capsule&quot;) 
		{
			this.$st_message(&quot;Unsuitable target.&quot;, 2);
			return false;
		}		
		// Is the target an escort?
		if (this.$st_npc.owner != null)			
        {
			// We could automatically target the leader. I tried it and it works, but it seemed too confusing.
			// this.$st_message(&quot;Target was an escort, targeting leader.&quot;,0);
			// ps.target = this.$st_npc.owner;
			this.$st_message(&quot;Target is an escort, please target the leader.&quot;, 2);
			return false;
		}	
		// Does the target move?
		if (this.$st_npc.speed === 0)			
        {
			this.$st_message(&quot;Target is stationary.&quot;, 2);
			return false;
		}	
		// Check distance between ships. 
		if(this.$st_npc.position.distanceTo(ps.position) &gt; this.$st_maxDist)
		{
			this.$st_message(&quot;Distance to target must not exceed &quot; + this.$st_maxDist + &quot; m.&quot;, 2);
			return false;
		}			
		else if(this.$st_npc.position.distanceTo(ps.position) &lt; this.$st_minDist)
		{
			this.$st_message(&quot;Distance to target must be at least &quot; + this.$st_minDist + &quot; m.&quot;, 2);
			return false;
		}			
		// Check if escort ships are aligned correctly.
		if (this.$st_nbEscorts &gt; 0 &amp;&amp; !this.$st_escortAligned(this.$st_npc.heading))
		{
			this.$st_message(&quot;Escort not aligned properly.&quot;, 2);
			return false;
		}			
		// Check for planet and star mass locks
		// The reason for doing it this way is that player.alertMassLocked can&#39;t be used at 
		// this stage, even if these lines would stand behind the change of npc scan class.
        if (this.st_checkForPlanetMassLock(ps))
        {
			this.$st_message(&quot;Mass-locked by planet.&quot;, 2);
			return false;
		}	
        else if (this.st_checkForSunMassLock(ps))
        {
			this.$st_message(&quot;Mass-locked by sun.&quot;, 2);
			return false;
		}	
		
		// To prevent the player being mass-locked we have to give the npc the scan class &quot;rock&quot;. 
		// $st_setScanClass() will also turn the scanner lollipop to flashing yellow and magenta (like in Escort Contracts).
		// Side effects:
		// - The player status will change from yellow to green if no other ships are present
		// - The legal status will not be shown during torus driving when using the Scanner Targeting Enhancement.
		// Escorts, if present, will be &quot;rocked&quot; too, but they don&#39;t get a different colour.
		this.$st_setScanClass(); 
    }

    // The following conditions are checked continuously during torus driving

	// Torus synchronisation makes only sense over larger distances, so the distance to  
	// destination of npc ship must be outside scanner range.
	var distance = this.$st_npc.position.distanceTo(this.$st_npc.destination); 			
	if (distance &lt; ps.scannerRange)			
	{
		if (calledBy === 1) 
			this.$st_message(&quot;Next waypoint too close (&quot; + Math.round(distance/1000) + &quot; km).&quot;, 2);
		else
			this.$st_message(&quot;Waypoint reached.&quot;, 2);
		return false;
	}	
	else if (calledBy === 2)
	{
		// show (remaining) distance in scanner targeting description 
		this.$st_npc.scanDescription  = &quot;waypoint: &quot; + Math.round(distance/1000) + &quot; km&quot;;
		
	}		
	// The player and in some cases the npc can change heading (but not velocity) 
	// during torus driving, so this has to be checked continuously. 
	if(this.$st_npc.heading.dot(ps.heading) &lt; this.$st_headingAlign)
	{
		this.$st_message(&quot;Heading mismatch.&quot;, 2);
		return false;
	}			
	// Check for player mass lock (check returns true when done immediately after changing the npc ship(s) to rock).
	if (calledBy != 1 &amp;&amp; player.alertMassLocked) 
	{
		this.$st_message(&quot;Mass-locked.&quot;, 2);
		return false;
	}	
	// Check for npc mass lock. 
	var targets = system.filteredEntities(this, st_checkForMassLock, this.$st_npc, this.$st_npc.scannerRange);
	if (targets.length &gt; 0) 
	{
		this.$st_message(&quot;Target mass-locked.&quot;, 2);
		return false;
	}	
	// Check for npc planet and star mass locks
	if (this.st_checkForPlanetMassLock(this.$st_npc))
	{
		this.$st_message(&quot;Target mass-locked by planet.&quot;, 2);
		return false;
	}	
	else if (this.st_checkForSunMassLock(this.$st_npc))
	{
		this.$st_message(&quot;Target mass-locked by sun.&quot;, 2);
		return false;
	}	
	// If player engages normal torus drive or injectors, synchronisation will be stopped.
	// Player will be mass locked by npc ship shortly after this. 
	// Note: Torus driving does _not_ change speed, but using injectors does!
	if (ps.torusEngaged || ps.speed &gt; ps.maxSpeed) 
	{
		return false;
	}	
	// Everything is (still) ok  
	return true;
};	

// Check for entities other than the player mass-locking the npc.
this.st_checkForMassLock = function(entity) 
{
	return ((entity.scanClass === &quot;CLASS_NEUTRAL&quot; || entity.scanClass === &quot;CLASS_MILITARY&quot; || entity.scanClass === &quot;CLASS_POLICE&quot; || entity.scanClass === &quot;CLASS_THARGOID&quot; || entity.scanClass === &quot;CLASS_STATION&quot;) &amp;&amp; !entity.isPlayer);
};

// Check mass-lock distance for sun 
this.st_checkForSunMassLock = function(ship) 
{
	return (ship.position.distanceTo(system.sun.position) &lt; system.sun.radius * 1.4142136);
};

// Check mass-lock distance for planets 
this.st_checkForPlanetMassLock = function(ship) 
{
    for (var i = 0; i &lt; system.planets.length; i++)	
	{
		if (ship.position.distanceTo(system.planets[i].position) &lt; system.planets[i].radius + Math.max(system.planets[i].radius, 25600))
		{
			return true;
		}				
	}
	return false;
};

// Stop torus, called by pressing n key (1) or by timer function (2). 
this.$st_stopTorus = function(calledBy)
{
	this.$st_timer.stop();
	worldScripts[&quot;Synchronised_Torus&quot;].$st_torusEngaged = false;      
    // Stop velocity synchronisation.
	this.$st_removeFrameCallback(); 	
	// Bring ships back to normal speed.
	this.$st_npc.velocity = this.$st_npc.thrustVector; 
	player.ship.velocity = player.ship.thrustVector; 
	if (this.$st_nbEscorts &gt; 0) this.$st_setEscortVelocity(null);
    // Reset scan class and lollipop colours.	
	this.$st_resetScanClass(); 
};	

// Set velocity of escort ships or restore to normal. 
this.$st_setEscortVelocity = function(v)	
{
	for (var i = 0; i &lt; this.$st_nbEscorts; i++)
	{	
		if (v) 
			this.$st_npc.escorts[i].velocity = v;
		else
			this.$st_npc.escorts[i].velocity = this.$st_npc.escorts[i].thrustVector;
	}
};	

// Check if all escort ships are aligned correctly. 
this.$st_escortAligned = function(heading)	
{
	for (var i = 0; i &lt; this.$st_nbEscorts; i++)
	{	
		if(this.$st_npc.escorts[i].heading.dot(heading) &lt; this.$st_headingAlign)  
			return false;
	}
	return true;
};	

// Set scan class to prevent mass locking.
this.$st_setScanClass = function()
{
	if (this.$st_npc)
	{	
		// Save for resetting. It can be assumed that escorts have the same class.	
		// We should save the colours too because these could have been changed by an OXP.
		// Scan description will be used to show remaining distance to waypoint.
		this.$st_scanClass   = this.$st_npc.scanClass;  
		this.$st_scanColour1 = this.$st_npc.scannerDisplayColor1;
		this.$st_scanColour2 = this.$st_npc.scannerDisplayColor2;
		this.$st_scanDescription = this.$st_npc.scanDescription;

		this.$st_npc.scanClass = &quot;CLASS_ROCK&quot;; 		
		this.$st_npc.scannerDisplayColor1 =	&quot;yellowColor&quot;;	// same colours are used in Escort Contracts
		this.$st_npc.scannerDisplayColor2 =	&quot;magentaColor&quot;;		
		for (var i = 0; i &lt; this.$st_nbEscorts; i++)
		{	
			this.$st_npc.escorts[i].scanClass = &quot;CLASS_ROCK&quot;; 		
			// The escorts should not flash. Note: The saved colour values are usually null, 
			// so using them here will turn the escorts white, the default for scan class &quot;rock&quot;.
			if (this.$st_scanClass === &quot;CLASS_POLICE&quot; || this.$st_scanClass === &quot;CLASS_MILITARY&quot;)
			{
				this.$st_npc.escorts[i].scannerDisplayColor1 =	&quot;purpleColor&quot;;	
				this.$st_npc.escorts[i].scannerDisplayColor2 =	&quot;purpleColor&quot;;		
			}		
			else
			{
				this.$st_npc.escorts[i].scannerDisplayColor1 =	&quot;yellowColor&quot;;	
				this.$st_npc.escorts[i].scannerDisplayColor2 =	&quot;yellowColor&quot;;		
			}		
		}
	}	
};

// Reset scan class after stopping torus driving or after a failed starting attempt.
this.$st_resetScanClass = function()
{
	// only reset if it has been changed already
	if (this.$st_npc &amp;&amp; this.$st_scanClass != &quot;&quot;)
	{	
		this.$st_npc.scanClass = this.$st_scanClass; 		
		this.$st_npc.scannerDisplayColor1 =	this.$st_scanColour1; 		
		this.$st_npc.scannerDisplayColor2 =	this.$st_scanColour2;		
		this.$st_npc.scanDescription = this.$st_scanDescription;
		for (var i = 0; i &lt; this.$st_nbEscorts; i++)
		{	
			this.$st_npc.escorts[i].scanClass = this.$st_scanClass; 		
			this.$st_npc.escorts[i].scannerDisplayColor1 = this.$st_scanColour1;
			this.$st_npc.escorts[i].scannerDisplayColor2 = this.$st_scanColour2;
		}
		this.$st_scanClass = &quot;&quot;;
	}	
};

// Timer function, checks if conditions are still ok.
this.$st_torusDriving = function()
{
	if (!this.$st_checkConditions(2))
	{
		this.$st_stopTorus(2);
	}
	else
	{
		// Velocity reduces slowly, so we have to keep it up.
		this.$st_npc.velocity = this.$st_npc.heading.multiply(this.$st_npc.maxSpeed * 32); 
		player.ship.velocity = this.$st_npc.velocity;
		if (this.$st_nbEscorts &gt; 0) this.$st_setEscortVelocity(this.$st_npc.velocity);	
	}		
};
	
// Frame callback function for adjusting velocities continuously. 
this.$st_matchVelocity = function() 
{
	player.ship.velocity = this.$st_npc.velocity;
	if (this.$st_nbEscorts &gt; 0) this.$st_setEscortVelocity(this.$st_npc.velocity);	
};	

// Remove frame callback function. 
this.$st_removeFrameCallback = function() 
{
	if (this.$st_frameCallback)
	{
		removeFrameCallback(this.$st_frameCallback);
		delete this.$st_frameCallback;
	}
};

// Console message with no sound (0), beep (1), or boop (2).
this.$st_message = function(msg, beep)
{
	if (beep &gt; 0)
	{
		this.$st_beep.sound = this.$st_beepSounds[beep];
		this.$st_beep.play();
	}	
	player.consoleMessage(msg);
};	

// Initialise timer and sound.
this.$st_init = function()
{
	// initialise timer
	this.$st_timer =  new Timer(this, this.$st_torusDriving, -1, this.$st_timerInterval);  
	this.$st_timerRunning = true;
	// initialise beep sounds
	this.$st_beepSounds[1] = Sound.load(&quot;beep.ogg&quot;);   // on
	this.$st_beepSounds[2] = Sound.load(&quot;boop.ogg&quot;);   // off, interrupted, not possible
	this.$st_beep = new SoundSource;  
	// this.$st_beep.sound = this.$st_beepSounds[1];  
	this.$st_beep.volume = 1;  
	this.$st_beep.loop = false;  
};	
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/st_world.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	     = &quot;Synchronised_Torus&quot;;
this.version     = &quot;1.0&quot;;    // 2015-12-14
this.description = &quot;World script for awarding torus drive synchronisation equipment at start-up&quot;;
this.author	     = &quot;Fritz G.&quot;;   
this.copyright	 = &quot;© 2015 Fritz G.&quot;;
this.licence	 = &quot;CC BY-NC-SA 4.0&quot;;

//--------------------------------------------------------------------------------------------------------------------
// For information and configuration see st_equipment.js
//--------------------------------------------------------------------------------------------------------------------
this.$st_torusEngaged = false;  // this can be used read only (!) by other OXPs (similar to player.ship.torusEngaged)    
//--------------------------------------------------------------------------------------------------------------------

// Award primable equipment at startup.
// It is assumed that every ship can do torus synchronisation without the player having to buy 
// additional equipment, because every ship can do it in Escort Contracts OXP too. The equipment 
// is only needed for starting and stopping the synchronisation by pressing a key.
this.startUp = function() 
{
	if(!player.ship.awardEquipment(&quot;EQ_SYNC_TORUS&quot;)) 
	{	
		log(this.name, &quot;Equipment EQ_SYNC_TORUS already present or failed to award&quot;);
	}
	else
	{
		log(this.name, &quot;Equipment EQ_SYNC_TORUS successfully awarded&quot;);
	}
};


</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
