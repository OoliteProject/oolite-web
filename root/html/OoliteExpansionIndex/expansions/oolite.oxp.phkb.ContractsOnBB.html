<html>
    <head>
        <title>Expansion Contracts on Bulletin Board</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Contracts on Bulletin Board</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>http://wiki.alioth.net/index.php/Contracts%20on%20Bulletin%20Board -&gt; 404 Not Found</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Moves all cargo, passenger and parcel contracts onto the Bulletin Board</td>
                    <td>Moves all cargo, passenger and parcel contracts onto the Bulletin Board</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.ContractsOnBB</td>
                    <td>oolite.oxp.phkb.ContractsOnBB</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Contracts on Bulletin Board</td>
                    <td>Contracts on Bulletin Board</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Miscellaneous</td>
                    <td>Miscellaneous</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.9</td>
                    <td>1.9</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.phkb.BulletinBoardSystem:1.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.phkb.BulletinBoardSystem:1.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/b/b1/ContractsOnBB.oxz">https://wiki.alioth.net/img_auth.php/b/b1/ContractsOnBB.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1651116640</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        
        <h3>readme.txt</h3>
        <pre>Contracts On BB
By Nick Rogers

Overview
========
This OXP moves all contracts (cargo, passenger and parcel) onto the Bulletin Board system, and removes the 3 F4 interface entries. There are no functional changes to the contracts themselves - simply the means of viewing and accepting them, unifying the user experience and reducing the number of items on the F4 interface screen.

The list of active cargo, passenger and parcel contracts will appear in their normal position on the F5F5 Manifest screen. The details of each contract can also be seen on the bulletin board. Once the contract is fulfilled, the mission will be automatically removed from the Bulletin Board.

If the &quot;Smugglers - The Galactic Underworld&quot; OXP is installed, all smuggling contracts will also be moved onto the Bulletin Board.

Other Mission OXP&#39;s
===================
The following OXP&#39;s can have their missions moved onto the Bulletin Board by using the Library OXP, finding the &quot;Contracts On BB&quot; section, and then turning on the appropriate flags. By default, all the flags are turned off. Turning one of the flags on without having the actual OXP installed will not do anything.

If you change the flag to true at a station where any of the contracts from the OXP&#39;s below are already on offer, you may need to launch and re-dock before the missions are added to the Bulletin Board.

Escort Contracts
----------------
When adding Escort Contracts to the Bulletin Board, these missions do not have an expiry date, and no ability to manually terminate the contract. This follows the procedure of the OXP, which assumes that once a mission is accepted it is either completed successfully, or failed.

In either case, once the mission is completed, the mission will be automatically removed from the Bulletin Board.

Contract status will still be displayed in the &quot;Missions&quot; section of the F5F5 Manifest screen. The F4 interface screen will be removed.

Rescue Stations
---------------
Adding Rescue Station missions to the Bulletin Board does change the mission framework a little. In it&#39;s original form, players are presented with an overview of a mission, with some unspecific details (eg &quot;Pay: Moderate&quot;). The player can then choose to attend the mission briefing, where the actual details are displayed (eg destination, pay). At this screen, players are given two options, to either accept or reject the mission. If the player rejects this mission, it is completely removed - there is no chance to change your mind and go back into the mission and accept it.

When accessed through the Bulletin Board, the first step of showing a generalised summary is removed. When a mission is displayed, you will be seeing the actual details of the mission (eg destination, pay, etc). You can also view this mission multiple times without accepting it.

The details of each mission has also been adjusted slightly for better alignment with the style of display on the Bulletin Board.

Mission status will still be displayed in the &quot;Missions&quot; section of the F5F5 Manifest screen. The F4 interface screen will be removed. Once the mission is completed, the mission will be automatically removed from the Bulletin Board.

Random Hits
-----------
Adding Random Hits missions to the Bulletin Board makes some minor changes to the sequence of screens displayed. In it&#39;s original form, players are shown an email-like screen when they accept a contract. This screen has been removed, and, if the email system is installed, an actual email will be generated.

Contracts can still be terminated, and accessing the Bulletin Board on a Space Bar will still incur a small charge.

Contract status will still be displayed in the &quot;Missions&quot; section of the F5F5 Manifest screen. The F4 interface screen will be removed. Once the mission is completed, the mission will be automatically removed from the Bulletin Board.

In-System Taxi
--------------
In-System Taxi contracts are similar to passenger missions, except that there is no destination system. When converted to use the Bulletin Board, the destination will be the current system. The taxi contract can be accepted from the Bulletin Board, and then will be viewable in the &quot;Missions&quot; section of the F5F5 Manifest screen, and will be removed automatically when the passenger is delivered. Taxi contracts accepted while in flight will not be displayed on the Bulletin Board at all.

Mining Contracts
----------------
Mining Contracts are only available from Rock Hermits, and work in the same way as the original pack. The Bulletin Board will now always be available at Rock Hermits, even if there are no contracts available. A new menu item in the Bulletin Board, &quot;Wait for new mining contracts&quot;, will perform the same &quot;Wait&quot; function as expected.

An additional benefit from having the mining contracts on the Bulletin Board is that, once you have accepted one of them, you can dock at any station and hand in cargo, rather than being limited to only docking at Rock Hermits. You will still need to dock at a Rock Hermit in order to complete the contract.

Mining contracts will be listed on the F5F5 Manifest screen, under the &quot;Bulletin Board Contracts&quot; section, rather than in the general &quot;Missions&quot; section.

Taxi Galactica
--------------
Taxi Galactica contracts are only available from Taxi Stations located in Corporate State systems. All TG missions translate to standard passenger missions, and will be available from the BB upon docking.

Contract status will still be displayed in the &quot;Missions&quot; section of the F5F5 Manifest screen (as per standard passenger contracts). Once the mission is completed, the mission will be automatically removed from the Bulletin Board.

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Life preserver image made by &quot;Icon Works&quot; http://www.flaticon.com/authors/icon-works from http://www.flaticon.com, licensed by CC 3.0 BY http://creativecommons.org/licenses/by/3.0/
Target image made by &quot;Freepik&quot; http://www.freepik.com from http://www.flaticon.com, licensed by CC 3.0 BY http://creativecommons.org/licenses/by/3.0/
Shield image made by &quot;Freepik&quot; http://www.freepik.com from http://www.flaticon.com, licensed by CC 3.0 BY http://creativecommons.org/licenses/by/3.0/
Rocket image from http://simpleicon.com/rocket.html
Shovel/Pick icon made by &quot;Made by Made&quot; https://www.flaticon.com/authors/made-by-made from https://www.flaticon.com/, licensed by http://creativecommons.org/licenses/by/3.0/

Version History
===============
1.9
- Fixed issue that was leaving orphaned contracts in the list and potentially causing script failures.

1.8
- Improved logic for removing missions before adding new ones.
- Small text corrections.

1.7
- Improved logic for adding missions to prevent duplicate ID&#39;s being selected.
- Fixed bug that was preventing passenger contracts from being re-indexed correctly.
- Code cleanup.

1.6
- Fixed issue with Taxi Galctica contract conversion flag not being restored correctly from a save game.
- Fixed issue with the link to the Bounty System for failed Mining Contracts that generate bounties.

1.5
- Fixed issue with Escort Contracts showing as being available when they don&#39;t actually exist any more.

1.4
- Fixed issue with Escort Contracts, where failing the contract by jumping to the wrong system would not remove the Bulletin Board item.
- Added contracts from &quot;Taxi Galactica&quot; OXP (v2.0) onto the Bulletin Board.
- Updates to handle new features in Bulletin Board v1.4
- Code refactoring.

1.3 
- Better handling of situation where Smugglers OXP is not installed.

1.2
- More adjustments for accepting of RH contracts.

1.1
- Adjusted code for accepting Random Hits contracts to improve reliability.
- Code refactoring.

1.0
- Added contracts from the &quot;Mining Contracts&quot; OXP onto the Bulletin Board.
- Fixed issue where the flag for converting In-System Taxi contracts was not being saved correctly in the save game.
- Turned on decimal place display on all credit value output.

0.12
- Fixed bug with passenger contracts causing a JavaScript error.
- Fixed bug with there being no main station in interstellar space.

0.11
- Fixed buggy process for checking when Smuggling contracts are completed.

0.10
- More robust logic for connecting with Smugglers Black Market.
- Added logic to remove passenger contracts after purchasing a new ship.

0.9
- Attempt to fix issue where using an escape pod leads to indexing errors.
- Added contracts from the &quot;In-System Taxi&quot; OXP onto the Bulletin Board.

0.8
- Added checks to ensure no mission is added to the BB with an expiry date in the past.

0.7
- Corrected Xenon Redux UI image filenames.
- Corrected Xenon Redux UI world script reference.
- Code refactoring.

0.6
- Added the &quot;Shuffle BB&quot; flag to the Library options.
- Turned of the &quot;Shuffle BB&quot; flag by default.
- Fixed incompatibility with v0.20 of Bulletin Board system.

0.5
- Removed selected asteroid keys from being used as background models for Rescue Station missions.
- Fixed improper casing in details of cargo and parcel contracts.

0.4
- Default settings for the various OXP inclusions now set correctly to &quot;false&quot;.

0.3
- Added contracts from the &quot;Escort Contracts&quot; OXP onto the Bulletin Board.
- Added missions from the &quot;Rescue Stations&quot; OXP onto the Bulletin Board.
- Added contracts from the &quot;Random Hits&quot; OXP onto the Bulletin Board.
- Contract conversion for core contracts will now only occur when at a main station.
- Contract conversion for smuggling contracts will now only occur at stations with a black market.

0.2
- Fixed problem with calling Smuggling contract validation without checking that the Smuggling OXP is installed.

0.1
- Initial release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/contracts_on_bb.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;ContractsOnBB&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2017 phkb&quot;;
this.description = &quot;Converts the cargo, parcel and passenger contracts to be delivered through the BB interface&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

this._disabled = false; // flag to quickly disable the OXP
this._turnOffF4Entries = true; // flag to indicate all F4 interface entries should be removed for applicable contract OXP&#39;s
this._bbShuffle = false; // flag to turn on/off BB list shuffle post conversion process
this._smuggling = false; // flag to indicate smuggling contracts will be converted
this._repopulate = true; // flag used to note when the first repopulate process is being run
this._performConversions = true; // flag used to determine if contracts need to be converted after docking
this._switchDefault = false; // convenience switch to make it simple to turn on or off contract conversion by default

/* 
    Escort contracts are offered to the player via a menu, and then player is then left to launch themselves.
    This makes these contracts the easiest to convert, as we&#39;re essentially just changing one menu system for another.
*/
this._convertEscortContracts = this._switchDefault; // flag to turn on/off escort contract conversions
this._doEscortContractsConversion = false; // flag to indicate that the conversion process is going/about to be run
// used by the escort contracts conversion process
this._govTypes = [&quot;an anarchy&quot;, &quot;a feudal state&quot;, &quot;a multi-government system&quot;, &quot;a dictatorship&quot;, &quot;a communist system&quot;, &quot;a confederacy&quot;, &quot;a democracy&quot;, &quot;a corporate state&quot;];
this._govRisk = [&quot;very high&quot;, &quot;high&quot;, &quot;moderate&quot;, &quot;moderate&quot;, &quot;low&quot;, &quot;low&quot;, &quot;very low&quot;, &quot;very low&quot;];

/* 
    RRS missions are presented to the player in two steps: first a very simple overview, followed by a more detailed briefing.
    Once the player has viewed the more detailed briefing, that mission can only be accepted or discarded completely.
    Mission variables are only setup when the detailed briefing is displayed, including random destinations or risk factors.
    Re-run initialisation phase mean new values will be established. But the BB wants the more detailed information
    the initialisation phase provides, and well ahead of when the player may or may not choose to accept the mission. 
    This means we need to store the first set of values, and override all variables once the mission is accepted.

    We are also using customised versions of the mission briefing details for RRS missions. This was purely for aesthetic reasons:
    the deadlines and payment amounts are shown on the BB item details, so I removed them from the text. It was too complicated
    to try and do some sort of automatic text replacement.

    The upshot is, should the RRS OXP change in any way internally (eg adding new mission variables, changing variable meanings), 
    this OXP will break.
*/
this._convertRRSContracts = this._switchDefault; // flag to turn on/off rescue station mission conversions
this._doRRSContractsConversion = false; // flag to indicate that the conversion process is going/about to be run
this._rrsMissionList = []; // holds list of mission scenarios currently being offered
this._rrsMissionStorage = []; // storage point for all mission scenario mission variables
this._rrsMissionCurrent = {}; // storage of the current mission variables, in case a mission is already active
// lists of the mission variables in use by the different RRS scenarios
this._rrsMissionVariables = {
    &quot;Rescue Scenario 1&quot;: [&quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;, &quot;rescuestation_leader_home&quot;, &quot;rescuestation_derelict_home&quot;, &quot;rescuestation_startsystem&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_type&quot;, &quot;rescuestation_shiprole&quot;, &quot;rescuestation_shiprole2&quot;, &quot;rescuestation_missionwingsize&quot;, &quot;rescuestation_wingname&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_livefire&quot;],
    &quot;Rescue Scenario 1a&quot;: [&quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;, &quot;rescuestation_leader_home&quot;, &quot;rescuestation_derelict_home&quot;, &quot;rescuestation_startsystem&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_type&quot;, &quot;rescuestation_shiprole&quot;, &quot;rescuestation_shiprole2&quot;, &quot;rescuestation_missionwingsize&quot;, &quot;rescuestation_wingname&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_livefire&quot;],
    &quot;Rescue Scenario 1b&quot;: [&quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;, &quot;rescuestation_leader_home&quot;, &quot;rescuestation_derelict_home&quot;, &quot;rescuestation_startsystem&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_type&quot;, &quot;rescuestation_shiprole&quot;, &quot;rescuestation_shiprole2&quot;, &quot;rescuestation_missionwingsize&quot;, &quot;rescuestation_wingname&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_livefire&quot;],
    &quot;Rescue Scenario 2&quot;: [&quot;rescuestation_reward&quot;, &quot;rescuestation_system&quot;],
    &quot;Rescue Scenario 2a&quot;: [&quot;rescuestation_reward&quot;, &quot;rescuestation_system&quot;, &quot;rescuestation_deadline&quot;],
    &quot;Rescue Scenario 2b&quot;: [&quot;rescuestation_reward&quot;, &quot;rescuestation_system&quot;, &quot;rescuestation_deadline&quot;],
    &quot;Rescue Scenario 3&quot;: [&quot;rescuestation_startsystem&quot;, &quot;rescuestation_startsystem_name&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;],
    &quot;Rescue Scenario 3a&quot;: [&quot;rescuestation_startsystem&quot;, &quot;rescuestation_startsystem_name&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;],
    &quot;Rescue Scenario 4&quot;: [&quot;rescuestation_system&quot;, &quot;rescuestation_system_name&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_pilot&quot;, &quot;rescuestation_pilotdesc&quot;, &quot;rescuestation_reward&quot;],
    &quot;Rescue Scenario 4a&quot;: [&quot;rescuestation_system&quot;, &quot;rescuestation_system_name&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_pilot&quot;, &quot;rescuestation_pilotdesc&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_danger1&quot;, &quot;rescuestation_danger2&quot;],
    &quot;Rescue Scenario 4b&quot;: [&quot;rescuestation_system&quot;, &quot;rescuestation_system_name&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_pilot&quot;, &quot;rescuestation_pilotdesc&quot;, &quot;rescuestation_agent&quot;, &quot;rescuestation_agentdesc&quot;, &quot;rescuestation_reward&quot;],
    &quot;Rescue Scenario 5&quot;: [&quot;rescuestation_reward&quot;, &quot;rescuestation_system&quot;, &quot;rescuestation_shipname&quot;],
    &quot;Rescue Scenario 5a&quot;: [&quot;rescuestation_reward&quot;, &quot;rescuestation_system&quot;, &quot;rescuestation_shipname&quot;],
    &quot;Rescue Scenario 6&quot;: [&quot;rescuestation_system&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_danger&quot;],
    &quot;Rescue Scenario 6a&quot;: [&quot;rescuestation_system&quot;, &quot;rescuestation_destsystem&quot;, &quot;rescuestation_destsystem_name&quot;, &quot;rescuestation_destsystem_desc&quot;, &quot;rescuestation_destsystem2&quot;, &quot;rescuestation_destsystem2_name&quot;, &quot;rescuestation_destsystem2_desc&quot;, &quot;rescuestation_deadline&quot;, &quot;rescuestation_deadline_text&quot;, &quot;rescuestation_reward&quot;, &quot;rescuestation_danger&quot;, &quot;rescuestation_disease&quot;]
};
// lists the model to use on the background of the mission description for all the different RRS scenarios
this._rrsMissionShipRole = {
    &quot;Rescue Scenario 1&quot;: &quot;shipModel&quot;,
    &quot;Rescue Scenario 1a&quot;: &quot;shipModel&quot;,
    &quot;Rescue Scenario 1b&quot;: &quot;shipModel&quot;,
    &quot;Rescue Scenario 2&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 2a&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 2b&quot;: &quot;EQ_RRS_SOLAR_MINE&quot;,
    &quot;Rescue Scenario 3&quot;: &quot;asteroidModel&quot;,
    &quot;Rescue Scenario 3a&quot;: &quot;asteroidModel&quot;,
    &quot;Rescue Scenario 4&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 4a&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 4b&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 5&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 5a&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 6&quot;: &quot;rescue_station&quot;,
    &quot;Rescue Scenario 6a&quot;: &quot;rescue_station&quot;
};
this._rrsAsteroidKeyList = [];

/* 
    RH stores mission data in missionVariables, like RRS does. The variables are swapped in and out with 
    the &quot;readHitpage&quot; routine. But because the &quot;pages&quot; array has all the variable data, so we don&#39;t need to store it ourselves,
    as we do for RRS missions.

    Because of some idiosyncrasies with expandMissionText, the mission variable replacement doesn&#39;t occur when it should. 
    Thus, we have created a routine to look for and replace all mission variable reference items in the text with the 
    actual mission variable content.

    Again, because of the way we&#39;re doing things, should RH change any of it&#39;s mission variables, or change the variable&#39;s meanings,
    this OXP will break.
*/
this._convertRHContracts = this._switchDefault; // flag to turn on/off random hits mission conversions
this._doRHContractsConversion = false; // flag to indicate that the conversion process is going/about to be run
// lists all the mission variables in use by RH
this._rhMissionVariables = [
    &quot;random_hits_mark_system&quot;,
    &quot;random_hits_mark_direction&quot;,
    &quot;random_hits_mark_gender&quot;,
    &quot;random_hits_mark_first_name&quot;,
    &quot;random_hits_mark_nick_name&quot;,
    &quot;random_hits_mark_second_name&quot;,
    &quot;random_hits_mark_race_part1&quot;,
    &quot;random_hits_mark_race_part2&quot;,
    &quot;random_hits_mark_ship_description&quot;,
    &quot;random_hits_mark_ship&quot;,
    &quot;random_hits_mark_ship_name&quot;,
    &quot;random_hits_mark_ship_ad_name&quot;,
    &quot;random_hits_mark_fee&quot;,
    &quot;random_hits_mark_ship_personality&quot;,
    &quot;random_hits_assassination_board_poster_title&quot;,
    &quot;random_hits_assassination_board_job_name&quot;,
    &quot;random_hits_assassination_board_poster_surname&quot;,
    &quot;random_hits_assassination_board_poster_name&quot;,
    &quot;random_hits_assassination_board_poster_system&quot;,
    &quot;random_hits_assassination_board_subject&quot;,
    &quot;random_hits_assassination_board_address1&quot;,
    &quot;random_hits_assassination_board_address2&quot;,
    &quot;random_hits_assassination_board_part1&quot;,
    &quot;random_hits_assassination_board_part2&quot;,
    &quot;random_hits_assassination_board_part3&quot;,
    &quot;random_hits_assassination_board_part4&quot;,
    &quot;random_hits_assassination_board_part5&quot;,
    &quot;random_hits_assassination_board_part6&quot;,
    &quot;random_hits_assassination_board_part7&quot;,
    &quot;random_hits_showship&quot;
];

/* In-System Taxi */
this._convertTaxiContracts = this._switchDefault;
this._doTaxiContractsConversion = false;

/*
    Bug in In-System Taxi: if you receive a comms-based notification of a client, then do a fast dock, launch, accept the contracts, then fast dock again, 
    the contract ends up with an expiry time in the past.
*/

/* mining contracts */
/* 
    note: because of the way mining contracts is structured, we can&#39;t reuse its internal functions for mission processing
    so much of the code that exists in mining contracts has been rewritten here, with the BB system&#39;s methodologies in mind
*/
this._convertMiningContracts = this._switchDefault;
this._doMiningContractsConversion = false;

/* taxi galactica */
this._convertTaxiGalacticaContracts = this._switchDefault;
this._doTaxiGalacticaContractsConversion = false;

// configuration settings for use in Lib_Config
this._COBBConfig = {
    Name: this.name,
    Alias: &quot;Contracts On BB&quot;,
    Display: &quot;Conversion Options&quot;,
    Alive: &quot;_COBBConfig&quot;,
    Notify: &quot;$changeSettings&quot;,
    Bool: {
        B0: {
            Name: &quot;_convertEscortContracts&quot;,
            Def: false,
            Desc: &quot;Escort contracts&quot;
        },
        B1: {
            Name: &quot;_convertRRSContracts&quot;,
            Def: false,
            Desc: &quot;Rescue Stations&quot;
        },
        B2: {
            Name: &quot;_convertRHContracts&quot;,
            Def: false,
            Desc: &quot;Random Hits&quot;
        },
        B3: {
            Name: &quot;_convertTaxiContracts&quot;,
            Def: false,
            Desc: &quot;In-System Taxi&quot;
        },
        B4: {
            Name: &quot;_convertMiningContracts&quot;,
            Def: false,
            Desc: &quot;Mining contracts&quot;
        },
        B5: {
            Name: &quot;_convertTaxiGalacticaContracts&quot;,
            Def: false,
            Desc: &quot;Taxi Galactica contracts&quot;
        },
        B6: {
            Name: &quot;_turnOffF4Entries&quot;,
            Def: true,
            Desc: &quot;Remove F4 items&quot;
        },
        Info: &quot;0 - Converts Escort contracts\n1 - Converts Rescue Station missions.\n2 - Converts Random Hits missions.\n3 - Converts In-System Taxi contracts.\n4 - Converts Mining contracts.\n5 - Convert Taxi Galactica contracts.\n6 - Removes any F4 interface entries.&quot;
    },
};
this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];

this._waitTimer = null;

//-------------------------------------------------------------------------------------------------------------
this.startUp = function () {
    if (this._disabled === true) {
        delete this.startUpComplete;
        delete this.systemWillPopulate;
        delete this.systemWillRepopulate;
        delete this.missionScreenOpportunity;
        delete this.guiScreenWillChange;
        delete this.shipDockedWithStation;
        delete this.shipWillDockWithStation;
        delete this.shipWillEnterWitchspace;
        delete this.playerCompletedContract;
        delete this.playerWillSaveGame;
        delete this.startUp;
        return;
    }

    var mc = worldScripts.miningcontracts;
    if (mc) {
        // hide this function for the moment
        mc.$cobb_ovr_startUpComplete = mc.startUpComplete;
    }

}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
    var count = 0;
    var bb = worldScripts.BulletinBoardSystem;

    if (worldScripts.BountySystem_Core) {
        var bs = worldScripts.BountySystem_Core;
        bs[&quot;contract obligations&quot;] = {
            description: &quot;Reneging on contract obligations with the Mining Association.&quot;,
            severity: &quot;2&quot;
        };
    }

    if (missionVariables.ContractsOnBB_ShuffleBB) this._bbShuffle = (this._trueValues.indexOf(missionVariables.ContractsOnBB_ShuffleBB) &gt;= 0 ? true : false);

    if (missionVariables.ContractsOnBB_EscortContracts) this._convertEscortContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_EscortContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;Escort_Contracts&quot;]) this._convertEscortContracts = false;

    if (missionVariables.ContractsOnBB_RRSContracts) this._convertRRSContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_RRSContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;Rescue Stations&quot;]) {
        this._convertRRSContracts = false;
    } else {
        this.$rrsGetAsteroidKeyList();
        if (this._convertRRSContracts) {
            // monkey patch our required changes into RSS
            // this allows us to easily monitor when missions are completed
            var rrs = worldScripts[&quot;Rescue Stations&quot;];
            rrs.$cobb_hold_missionSuccess = rrs.missionSuccess;
            rrs.missionSuccess = this.$cobb_missionSuccess;
            rrs.$cobb_hold_failMission = rrs.failMission;
            rrs.failMission = this.$cobb_failMission;
        }
    }

    if (missionVariables.ContractsOnBB_RHContracts) this._convertRHContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_RHContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;Random_Hits&quot;]) this._convertRHContracts = false;

    if (missionVariables.ContractsOnBB_TaxiContracts) this._convertTaxiContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_TaxiContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;in-system_taxi&quot;]) this._convertTaxiContracts = false;

    if (missionVariables.ContractsOnBB_MiningContracts) this._convertMiningContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_MiningContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;miningcontracts&quot;]) this._convertMiningContracts = false;

    if (missionVariables.ContractsOnBB_TaxiGalacticaContracts) this._convertTaxiGalacticaContracts = (this._trueValues.indexOf(missionVariables.ContractsOnBB_TaxiGalacticaContracts) &gt;= 0 ? true : false);
    if (!worldScripts[&quot;taxi_galactica_main&quot;] || worldScripts[&quot;taxi_galactica_main&quot;].version.indexOf(&quot;1.&quot;) &gt;= 0) this._convertTaxiGalacticaContracts = false;

    if (missionVariables.ContractsOnBB_RRSMissionList) {
        this._rrsMissionList = JSON.parse(missionVariables.ContractsOnBB_RRSMissionList);
        delete missionVariables.ContractsOnBB_RRSMissionList;
    }
    if (missionVariables.ContractsOnBB_RRSMissionStorage) {
        this._rrsMissionStorage = JSON.parse(missionVariables.ContractsOnBB_RRSMissionStorage);
        delete missionVariables.ContractsOnBB_RRSMissionStorage;
    }

    // register our settings, if Lib_Config is present
    if (worldScripts.Lib_Config) worldScripts.Lib_Config._registerSet(this._COBBConfig);

    // cargo contracts
    // we&#39;re monkey patching the validateContracts function so we can do some link re-referencing of our own
    worldScripts[&quot;oolite-contracts-cargo&quot;]._validateContracts = this.$bbovr_cargo_validateContracts;
    count = worldScripts[&quot;oolite-contracts-cargo&quot;].$contracts.length;
    // are there any contracts available at the moment?
    if (count &gt; 0) {
        // see if there are any unaccepted missions at ID 31000
        var itm = bb.$getItem(31000);
        // if there isn&#39;t, run the conversion process
        if (itm == null || this.$countContracts(31000) != count) this.$convertContracts(&quot;cargo&quot;);
    }

    // passenger contracts
    // we&#39;re monkey patching the validateContracts function so we can do some link re-referencing of our own
    worldScripts[&quot;oolite-contracts-passengers&quot;]._validateContracts = this.$bbovr_passengers_validateContracts;
    count = worldScripts[&quot;oolite-contracts-passengers&quot;].$passengers.length;
    if (count &gt; 0) {
        // see if there are any unaccepted missions @ ID 32000
        var itm = bb.$getItem(32000);
        // if there isn&#39;t, run the conversion process
        if (itm == null || this.$countContracts(32000) != count) this.$convertContracts(&quot;passengers&quot;);
    }

    // parcel contracts
    // we&#39;re monkey patching the validateContracts function so we can do some link re-referencing of our own
    worldScripts[&quot;oolite-contracts-parcels&quot;]._validateContracts = this.$bbovr_parcels_validateContracts;
    count = worldScripts[&quot;oolite-contracts-parcels&quot;].$parcels.length;
    if (count &gt; 0) {
        // see if there are any unaccepted missions @ ID 33000
        var itm = bb.$getItem(33000);
        // if there isn&#39;t, run the conversion process
        if (itm == null || this.$countContracts(33000) != count) this.$convertContracts(&quot;parcels&quot;);
    }

    // register our validateContracts script to be run just before the mission list is displayed
    bb.$registerBBEvent(this.name, &quot;$validateContracts&quot;, &quot;preListDisplay&quot;);
    // register our bar bill script to be run whenever the BB is exited
    bb.$registerBBEvent(this.name, &quot;$rhBarBill&quot;, &quot;close&quot;);
    bb.$registerBBEvent(this.name, &quot;$rhBarBill&quot;, &quot;exit&quot;);
    bb.$registerBBEvent(this.name, &quot;$rhBarBillPostLaunch&quot;, &quot;launchExit&quot;);

    // in-system taxi
    // we&#39;re monkey patching the &quot;$acceptOffer&quot; function to make it easier to determine when the player accepts a contract during flight
    if (this._convertTaxiContracts) {
        var taxi = worldScripts[&quot;in-system_taxi&quot;];
        taxi.$ccob_acceptOffer = taxi.$acceptOffer;
        taxi.$acceptOffer = this.$acceptTaxiOffer_inFlight;
    }

    // mining contracts
    bb.$registerBBEvent(this.name, &quot;$miningContractOpen&quot;, &quot;preItemDisplay&quot;);
    bb.$registerBBEvent(this.name, &quot;$miningContractListOpen&quot;, &quot;preListDisplay&quot;);
    var mc = worldScripts.miningcontracts;
    if (this._convertMiningContracts) {
        this.$checkForHermit(player.ship.dockedStation);
        mc.$cobb_ovr_shipExitedWitchspace = mc.shipExitedWitchspace;
        mc.shipExitedWitchspace = this.$mc_shipExitedWitchspace;
    } else {
        if (mc) mc.$cobb_ovr_startUpComplete();
    }

    var tg = worldScripts.taxi_galactica_main;
    if (this._convertTaxiGalacticaContracts) {
        tg.$cobb_ovr_missionScreenOpportunity = tg.missionScreenOpportunity;
        delete tg.missionScreenOpportunity;
    }

    // do a quick check to make sure we don&#39;t have any orphaned smuggling contracts
    this.$checkSmugglingContracts();
    // un-accepted escort contracts are not saved between sessions - they&#39;re available when you dock,
    // but if you save and reload, they disappear. 
    // so do a quick check to make sure we don&#39;t have any orphaned escort contracts, where the source data
    // has been cleared away by a reload
    this.$checkEscortContacts();

    this.systemWillRepopulate();
}

//-------------------------------------------------------------------------------------------------------------
this.systemWillPopulate = function () {
    // add our station key to the main station, so the contracts are only offered there
    if (system.mainStation) {
        worldScripts.BulletinBoardSystem.$addStationKey(this.name, system.mainStation, &quot;mainStation&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.systemWillRepopulate = function () {
    if (this._repopulate === true) {
        this._repopulate = false;
        var taxi = [];
        if (worldScripts[&quot;in-system_taxi&quot;]) {
            taxi = worldScripts[&quot;in-system_taxi&quot;].$listOfStations();
        }
        var sbm = worldScripts.Smugglers_BlackMarket;
        var bb = worldScripts.BulletinBoardSystem;
        for (var i = 0; i &lt; system.stations.length; i++) {
            var stn = system.stations[i];
            if (sbm &amp;&amp; sbm.$doesStationHaveBlackMarket) {
                // add the black market station keys
                if (sbm.$doesStationHaveBlackMarket(stn) === true) bb.$addStationKey(this.name, stn, &quot;blackMarket&quot;);
            }
            // add rrs station keys
            if (stn.hasRole(&quot;rescue_station&quot;)) bb.$addStationKey(this.name, stn, &quot;rescueStation&quot;);
            // add rh station keys
            if (stn.name === &quot;A Seedy Space Bar&quot;) bb.$addStationKey(this.name, stn, &quot;randomHits&quot;);
            // add tax station keys
            if (taxi.indexOf(stn) &gt;= 0) bb.$addStationKey(this.name, stn, &quot;taxi&quot;);
            // add rock hermit station keys
            if (Ship.roleIsInCategory(stn.primaryRole, &quot;oolite-rockhermits&quot;) === true) bb.$addStationKey(this.name, stn, &quot;rockHermit&quot;);
            // add taxi galactica station keys
            if (stn.hasRole(&quot;taxi_station&quot;)) bb.$addStationKey(this.name, stn, &quot;taxiGalactica&quot;);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillEnterWitchspace = function () {
    this._repopulate = true;
    if (this._convertMiningContracts) {
        // remove any mining contracts from the bb
        // they&#39;ll be deleted from the mining contracts data via its own script - this just saves confusion
        var curr = this.$countContracts(39000);
        if (curr &gt; 0) {
            var bb = worldScripts.BulletinBoardSystem;
            for (var i = 0; i &lt; curr; i++) {
                bb.$removeBBMission(39000 + i);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenWillChange = function (to, from) {
    // if we&#39;re able to show the interfaces screen while on the main station...
    if (to === &quot;GUI_SCREEN_INTERFACES&quot; &amp;&amp; player.ship.dockedStation &amp;&amp; this._turnOffF4Entries) {
        // remove the interfaces from the station
        if (system.mainStation) {
            system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;, null);
            system.mainStation.setInterface(&quot;oolite-contracts-passengers&quot;, null);
            system.mainStation.setInterface(&quot;oolite-contracts-parcels&quot;, null);
        }
        if (this._convertEscortContracts) player.ship.dockedStation.setInterface(&quot;escort_f4contracts&quot;, null);
        if (this._convertRRSContracts) player.ship.dockedStation.setInterface(&quot;rescue_station&quot;, null);
        if (this._convertRHContracts) player.ship.dockedStation.setInterface(&quot;RandomHits&quot;, null);
        if (this._convertTaxiContracts) player.ship.dockedStation.setInterface(&quot;in-system_taxi&quot;, null);
        if (this._convertMiningContracts) player.ship.dockedStation.setInterface(&quot;MiningContracts-bm&quot;, null);
        if (this._convertTaxiGalacticaContracts) player.ship.dockedStation.setInterface(&quot;taxi_galactica_main&quot;, null);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
    if (this._performConversions === true) {
        this._performConversions = false;

        var do_interface = false;
        var bb = worldScripts.BulletinBoardSystem;
        // do any contract conversion for EC, RRS and RH here
        // these flags will be turned on during shipDockedWithStation
        // ec
        if (this._doEscortContractsConversion === true) {
            this._doEscortContractsConversion = false;
            if (worldScripts[&quot;Escort_Contracts&quot;].ec_targetsystems) {
                var count = worldScripts[&quot;Escort_Contracts&quot;].ec_targetsystems.length;
                if (count &gt; 0) {
                    // see if there are any unaccepted missions @ ID 35000
                    var itm = bb.$getItem(35000);
                    // if there isn&#39;t, run the conversion process
                    if (itm == null || this.$countContracts(35000) != count) {
                        this.$convertContracts(&quot;escort&quot;);
                        do_interface = true;
                    }
                }
            }
        }
        // rrs
        if (this._doRRSContractsConversion === true) {
            this._doRRSContractsConversion = false;
            var rrs = worldScripts[&quot;Rescue Stations&quot;];
            this._rrsMissionList.length = 0;
            if (rrs.availablescenarios &amp;&amp; rrs.availablescenarios.length &gt; 0) {
                this._rrsMissionList = rrs.availablescenarios.concat();
            }
            if (rrs.availablescenarios_save &amp;&amp; rrs.availablescenarios_save.length &gt; 0) {
                this._rrsMissionList = rrs.availablescenarios_save.concat();
            }
            if (this._rrsMissionList.length &gt; 0) {
                this._rrsMissionStorage = new Array(this._rrsMissionList.length);
                // see if there are any unaccepted missions @ ID 36000
                var itm = bb.$getItem(36000);
                // if there isn&#39;t, run the conversion process
                if (itm == null || this.$countContracts(36000) != this._rrsMissionList.length) {
                    this.$convertContracts(&quot;rescue&quot;);
                    do_interface = true;
                }
            }
        }
        // rh
        if (this._doRHContractsConversion === true) {
            this._doRHContractsConversion = false;
            var rh = worldScripts[&quot;Random_Hits&quot;];
            if (rh.pages &amp;&amp; missionVariables.random_hits_status !== &quot;RUNNING&quot;) {
                var count = rh.pages.length;
                if (count &gt; 0) {
                    // see if there are any unaccepted missions @ ID 37000
                    var itm = bb.$getItem(37000);
                    // if there isn&#39;t, run the conversion process
                    if (itm == null || this.$countContracts(37000) != count) {
                        this.$convertContracts(&quot;random_hits&quot;);
                        do_interface = true;
                    }
                }
            }
        }
        // in-system taxi
        if (this._doTaxiContractsConversion === true) {
            this._doTaxiContractsConversion = false;
            var taxi = worldScripts[&quot;in-system_taxi&quot;];
            if (taxi.$stationOffers.length &gt; 0) {
                this.$convertContracts(&quot;taxi&quot;);
                do_interface = true;
            }
        }
        // mining contracts
        if (this._doMiningContractsConversion === true) {
            this._doMiningContractsConversion = false;
            var mining = worldScripts.miningcontracts;
            var count = mining.MC_contracts.length;
            if (count &gt; 0) {
                // see if there are any unaccepted missions @ ID 39000
                var itm = bb.$getItem(39000);
                // if there isn&#39;t, run the conversion process
                if (itm == null || this.$countContracts(39000) != count) {
                    this.$convertContracts(&quot;mining&quot;);
                    do_interface = true;
                }
            }
        }
        // taxi galaxtica
        if (this._doTaxiGalacticaContractsConversion === true) {
            this._doTaxiGalacticaContractsConversion = false;
            var tg = worldScripts.taxi_galactica_main;
            // see if there are any unaccepted missions @ ID 40000
            var itm = bb.$getItem(40000);
            // if there isn&#39;t, run the conversion process
            if (itm == null || this.$countContracts(40000) != 3) {
                this.$convertContracts(&quot;taxi_galactica&quot;);
                do_interface = true;
            }
        }
        // force an update to the interface entry
        if (do_interface) bb.$initInterface(player.ship.dockedStation);
    }

    // due to the way taxi galactica is structured, we need to recreate some of the functionality from missionScreenOpportunity
    if (this._convertTaxiGalacticaContracts === true &amp;&amp; worldScripts.taxi_galactica_main) {
        var tg = worldScripts.taxi_galactica_main;
        // Check if Player is currently docked at the main station:
        if (player.ship.dockedStation.isMainStation) {
            // Check if Player is doing a contract and is at the contract mission destination:
            if (missionVariables.taxistatus === &quot;ON_THE_JOB&quot; &amp;&amp; system.ID === missionVariables.taxi_dest) {
                // Change variable to reflect no longer doing contract:
                missionVariables.taxistatus = &quot;NOT_ON_JOB&quot;;
                // Increase variable to reflect another contract completed:
                missionVariables.taxijobstotal += 1;
                // Refuel Player ship:
                player.ship.fuel = 7.0;
                // Check if Player was doing special mission #1:
                if (missionVariables.taxi_diff === 3) {
                    // Change variable to reflect special mission #1 complete:
                    missionVariables.taxi_specmiss_1 = &quot;MISSION_COMPLETE&quot;;
                    // Check if Snoopers OXP is installed and if so insert news story about events of special mission #1:
                    if (worldScripts.snoopers) worldScripts.snoopers.insertNews({
                        ID: this.name,
                        Agency: 1,
                        Message: expandDescription(&quot;[taxi_snoopers_specmiss_1]&quot;)
                    });
                    if (worldScripts.GNN) worldScripts.GNN._insertNews({
                        ID: this.name,
                        Agency: 1,
                        Message: expandDescription(&quot;[taxi_snoopers_specmiss_1]&quot;)
                    });
                }
            }
        }
        // Check if Player is current docked at a Taxi Station:
        if (player.ship.dockedStation.hasRole(&quot;taxi_station&quot;)) {
            if (missionVariables.taxistat === &quot;ACCEPTED&quot;) {
                // Display contract accepted screen:
                /*mission.runScreen(
                    {
                        title: &quot;Taxi Galactica Contract Accepted&quot;, 
                        screenID: &quot;taxi_galactica_accepted&quot;,
                        messageKey: &quot;mission_taxi_accepted&quot;, 
                        model: &quot;taxi_adder&quot;, 
                        choicesKey: &quot;mission_taxi_on_job_choices&quot;
                    });*/
                missionVariables.taxistat = &quot;ON_THE_JOB_1&quot;;
                return;
            }
            if (missionVariables.taxistat === &quot;REVISIT&quot;) {
                // Check if Player is currently doing a contract and if so prompt Player that they need to complete contract:
                if (missionVariables.taxistatus !== &quot;ON_THE_JOB&quot;) {
                    // Check if Player has completed 5 or more contracts, has not yet completed special mission #1 and has a free passenger berth:
                    if (missionVariables.taxijobstotal &gt;= 5 &amp;&amp; missionVariables.taxi_specmiss_1 !== &quot;MISSION_COMPLETE&quot; &amp;&amp; player.ship.passengerCount &lt; player.ship.passengerCapacity) {
                        // Generate name for ambassador for special mission #1 briefing:
                        missionVariables.taxi_specmis_1_ambassador = randomName() + &quot; &quot; + randomName();
                        // Generate special mission #1 destination:
                        missionVariables.taxi_specmis1_dest = tg._generateTaxiDest(20);
                        missionVariables.taxi_specmis1_dest_name = System.systemNameForID(missionVariables.taxi_specmis1_dest);
                        // Get special mission #1 destination government type and assign name to variable: 
                        missionVariables.taxi_specmis1_dest_gov = System.infoForSystem(galaxyNumber, missionVariables.taxi_specmis1_dest).government;
                        if (missionVariables.taxi_specmis1_dest_gov === 0) missionVariables.taxi_specmis1_dest_gov_name = &quot;Anarchy&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 1) missionVariables.taxi_specmis1_dest_gov_name = &quot;Feudal&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 2) missionVariables.taxi_specmis1_dest_gov_name = &quot;Multi-Governmental&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 3) missionVariables.taxi_specmis1_dest_gov_name = &quot;Dictatorship&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 4) missionVariables.taxi_specmis1_dest_gov_name = &quot;Communist&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 5) missionVariables.taxi_specmis1_dest_gov_name = &quot;Confederacy&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 6) missionVariables.taxi_specmis1_dest_gov_name = &quot;Democracy&quot;;
                        if (missionVariables.taxi_specmis1_dest_gov === 7) missionVariables.taxi_specmis1_dest_gov_name = &quot;Corporate State&quot;;
                        // Generate time limit for special mission #1:
                        missionVariables.taxi_specmis1_time = Math.floor(Math.random() * (20 - 10 + 1) + 10);
                        // Determine special mission #1 destination distance and assign to variable:
                        missionVariables.taxi_specmis1_dist = Math.round(system.info.distanceToSystem(System.infoForSystem(galaxyNumber, missionVariables.taxi_specmis1_dest)) * 5) / 5;
                        // Display special mission #1 briefing screen:
                        mission.runScreen({
                                title: &quot;Taxi Galactica Contract Offer&quot;,
                                screenID: &quot;taxi_galactica_intro&quot;,
                                messageKey: &quot;mission_taxi_spec_mis_1_intro&quot;,
                                model: &quot;taxi_adder&quot;,
                                modelPersonality: tg._modelPersonality,
                                choicesKey: &quot;mission_taxi_spec_mis_1_intro_choices&quot;
                            },
                            this.$tg_choiceEvaluation);

                        missionVariables.taxistat = &quot;SPEC_MIS_01_1&quot;;
                        return;
                    } else {
                        // Display welcome screen for Taxi Station and generate new contract destinations:
                        mission.runScreen({
                                title: &quot;Welcome to the Taxi Galactica Station&quot;,
                                screenID: &quot;taxi_galactica_mission_intro&quot;,
                                messageKey: &quot;mission_taxi_intro&quot;,
                                model: &quot;taxi_adder&quot;,
                                modelPersonality: tg._modelPersonality,
                                choicesKey: &quot;mission_taxi_intro_choices&quot;
                            },
                            this.$tg_choiceEvaluation);
                        tg._generateTaxiJobs();
                        this.$convertContracts(&quot;taxi_galactica&quot;);
                        worldScripts.BulletinBoardSystem.$initInterface(player.ship.dockedStation);
                        missionVariables.taxistat = &quot;REVISIT_1&quot;;
                        return;
                    }
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function (station) {
    if (station.isMainStation) {
        this.$convertContracts(&quot;cargo&quot;);
        this.$convertContracts(&quot;passengers&quot;);
        this.$convertContracts(&quot;parcels&quot;);
    }
    if (this._smuggling) {
        if (worldScripts.Smugglers_BlackMarket.$doesStationHaveBlackMarket(station) === true) this.$convertContracts(&quot;smuggling&quot;);
    }
    var found = false;
    var bb = worldScripts.BulletinBoardSystem;
    // are any escort contracts going to be completed when we dock?
    if (this._convertEscortContracts) {
        var ecList = this.$getActiveContractsByType(&quot;escort&quot;);
        var ec = worldScripts[&quot;Escort_Contracts&quot;];
        if (ecList.length &gt; 0 &amp;&amp; !ec.ec_currentcontract) {
            // there should only ever be one, which should be index 0
            bb.$removeBBMission(ecList[0].ID);
        }
        if ((ec.ec_currentcontract &amp;&amp; ec.ec_currentcontract !== &quot;success&quot;) || (ec.ec_currentcontract === &quot;success&quot; &amp;&amp; system.info.systemID === ec.ec_targetsystem &amp;&amp; player.ship.dockedStation.isMainStation)) {
            // find the contract in the BB to remove it
            // there should only ever be one, which should be index 0
            bb.$removeBBMission(ecList[0].ID);
        }
    }
    if (this._convertRHContracts) {
        // are any rh contracts going to be completed when we dock
        var rh = worldScripts[&quot;Random_Hits&quot;];
        if (missionVariables.random_hits_status &amp;&amp; rh.hitMissionEndings.indexOf(missionVariables.random_hits_status) &gt; -1) {
            var rhList = this.$getActiveContractsByType(&quot;randomhits&quot;);
            if (rhList.length &gt; 0) {
                // find the contract in the BB to remove it
                // there should only ever be one, which should be index 0
                bb.$removeBBMission(rhList[0].ID);
            }
        }
    }
    if (this._convertMiningContracts) this.$checkForHermit(station);

    if (found === true) bb.$initInterface(player.ship.dockedStation);
    // turn on the flag that will do OXP contract conversions after the player docks
    this._performConversions = true;
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
    var bb = worldScripts.BulletinBoardSystem;

    if (this._convertEscortContracts &amp;&amp; station.isMainStation) this._doEscortContractsConversion = true;
    if (this._convertRRSContracts &amp;&amp; station.hasRole(&quot;rescue_station&quot;)) this._doRRSContractsConversion = true;
    if (this._convertRHContracts &amp;&amp; station.name === &quot;A Seedy Space Bar&quot;) this._doRHContractsConversion = true;

    // first, reset the overlay back to the default
    bb.$resetOverlayDefault();
    // set the default overlay to use on the main BB list
    // rh board
    if (this._convertRHContracts &amp;&amp; player.ship.dockedStation.name === &quot;A Seedy Space Bar&quot;) bb.$setOverlayDefault({
        name: &quot;cobb_rh.png&quot;,
        height: 546
    });
    // rrs board
    if (this._convertRRSContracts &amp;&amp; player.ship.dockedStation.hasRole(&quot;rescue_station&quot;)) bb.$setOverlayDefault({
        name: &quot;cobb_rrs.png&quot;,
        height: 546
    });

    // look for a taxi contract being completed and remove the BB item
    var taxi = worldScripts[&quot;in-system_taxi&quot;];
    if (taxi &amp;&amp; this._convertTaxiContracts) {
        if (taxi.$fireMissionScreen &gt;= 2) {
            // note for screen 6, the passenger is converted into a normal passenger so the game can handle the processing
            // rather than trying to keep the bb item until the final delivery, I&#39;m removing it here as with all other
            // outcomes. The passenger details will be on the F5F5 screen, just not on the BB
            //
            var tList = this.$getActiveContractsByType(&quot;taxi&quot;);
            if (tList.length &gt; 0) {
                // find the taxi contract and delete it.
                // there should only ever be one, which should be index 0
                bb.$removeBBMission(tList[0].ID);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
    if (this._convertMiningContracts) {
        var bb = worldScripts.BulletinBoardSystem;
        // turn off the always visible flag
        if (Ship.roleIsInCategory(station.primaryRole, &quot;oolite-rockhermits&quot;) === true) {
            bb._alwaysShowBB = false;
            // remove main menu items
            bb.$removeMainMenuItem(this.name, &quot;$miningContract_wait&quot;);
            bb.$removeMainMenuItem(this.name, &quot;$miningContract_repayDebt&quot;);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerCompletedContract = function (type, result, fee, contract) {
    switch (type) {
        case &quot;cargo&quot;:
        case &quot;passenger&quot;:
        case &quot;parcel&quot;:
            // find and remove the contract from the BB
            var bb = worldScripts.BulletinBoardSystem;
            for (var i = 0; i &lt; bb._data.length; i++) {
                var itm = bb._data[i];
                if (itm != null &amp;&amp; itm.accepted === true) {
                    // is this item the one we&#39;re dealing with?
                    if (itm.destination === contract.destination &amp;&amp; itm.payment === contract.fee &amp;&amp; itm.source === contract.start) {
                        bb.$removeBBMission(itm.ID);
                        break;
                    }
                }
            }
            break;
    }

}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtNewShip = function (ship, price) {
    var bb = worldScripts.BulletinBoardSystem;
    var d = bb._data;
    var found = false;
    for (var i = d.length - 1; i &gt;= 0; i--) {
        if (d[i].accepted === true &amp;&amp; d[i].worldScript === this.name &amp;&amp; d[i].initiateCallback === &quot;$acceptPassengerContract&quot;) {
            bb.$removeBBMission(d[i].ID);
            found = true;
        }
    }
    if (found === true) bb.$initInterface(player.ship.dockedStation);
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
    delete missionVariables.ContractsOnBB_EscortContracts;
    if (worldScripts[&quot;Escort_Contracts&quot;]) missionVariables.ContractsOnBB_EscortContracts = this._convertEscortContracts;
    delete missionVariables.ContractsOnBB_RRSContracts;
    if (worldScripts[&quot;Rescue Stations&quot;]) {
        missionVariables.ContractsOnBB_RRSContracts = this._convertRRSContracts;
        if (this._rrsMissionList &amp;&amp; this._rrsMissionList.length &gt; 0) {
            missionVariables.ContractsOnBB_RRSMissionList = JSON.stringify(this._rrsMissionList);
            missionVariables.ContractsOnBB_RRSMissionStorage = JSON.stringify(this._rrsMissionStorage);
        }
    }
    delete missionVariables.ContractsOnBB_RHContracts;
    if (worldScripts[&quot;Random_Hits&quot;]) missionVariables.ContractsOnBB_RHContracts = this._convertRHContracts;
    delete missionVariables.ContractsOnBB_TaxiContracts;
    if (worldScripts[&quot;in-system_taxi&quot;]) missionVariables.ContractsOnBB_TaxiContracts = this._convertTaxiContracts;
    delete missionVariables.ContractsOnBB_MiningContracts;
    if (worldScripts[&quot;miningcontracts&quot;]) missionVariables.ContractsOnBB_MiningContracts = this._convertMiningContracts;
    delete missionVariables.ContractsOnBB_TaxiGalacticaContracts;
    if (worldScripts[&quot;taxi_galactica_main&quot;]) missionVariables.ContractsOnBB_TaxiGalacticaContracts = this._convertTaxiGalacticaContracts;
    missionVariables.ContractsOnBB_ShuffleBB = this._bbShuffle;
}

//-------------------------------------------------------------------------------------------------------------
this.$changeSettings = function () {
    var rrs = worldScripts[&quot;Rescue Stations&quot;];
    if (rrs) {
        if (this._convertRRSContracts) {
            // monkey patch rrs with our new versions
            rrs.$cobb_hold_missionSuccess = rrs.missionSuccess;
            rrs.missionSuccess = this.$cobb_missionSuccess;
            rrs.$cobb_hold_failMission = rrs.failMission;
            rrs.failMission = this.$cobb_failMission;
        } else {
            // remove any monkey patches from rrs
            if (rrs.$cobb_hold_missionSuccess) rrs.missionSuccess = rrs.$cobb_hold_missionSuccess;
            if (rrs.$cobb_hold_failMission) rrs.failMission = rrs.$cobb_hold_failMission;
            delete rrs.$cobb_hold_missionSuccess;
            delete rrs.$cobb_hold_failMission;
        }
    }
    var tg = worldScripts.taxi_galactica_main;
    if (tg) {
        if (this._convertTaxiGalacticaContracts) {
            // monkey patch tg with our new versions
            tg.$cobb_ovr_missionScreenOpportunity = tg.missionScreenOpportunity;
            delete tg.missionScreenOpportunity;
        } else {
            // remove any monkey patches from tg
            tg.missionScreenOpportunity = tg.$cobb_ovr_missionScreenOpportunity;
            delete tg.$cobb_ovr_missionScreenOpportunity;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$convertContracts = function (contractType) {
    var bb = worldScripts.BulletinBoardSystem;
    var xui = false;
    var ovr1 = &quot;&quot;;
    var ovr2 = &quot;&quot;;
    var ovr3 = &quot;&quot;;
    if (worldScripts.XenonReduxUI) {
        xui = true;
        ovr1 = {
            name: &quot;xrui-cargo.png&quot;,
            height: 546
        };
        ovr2 = {
            name: &quot;xrui-boardingpass.png&quot;,
            height: 546
        };
        ovr3 = {
            name: &quot;xrui-briefcase.png&quot;,
            height: 546
        };
    }
    if (worldScripts.XenonUI) {
        xui = true;
        ovr1 = {
            name: &quot;xui-cargo.png&quot;,
            height: 546
        };
        ovr2 = {
            name: &quot;xui-boardingpass.png&quot;,
            height: 546
        };
        ovr3 = {
            name: &quot;xui-briefcase.png&quot;,
            height: 546
        };
    }

    var curr = 0;

    /* Essentially, we&#39;re making a copy of all the contracts and assigning them an in in the 31000+ range.
    The ID assigned, minus the base amount, should match the index value of the contract. 
    Once a contract is accepted, the ID of the equivalent BB item is reset back to the normal range (0 - 30000), 
    excluding it from the rest of this code.
    When a mission is completed, the BB item is linked to the contract based on start system, destination system, and the payment amount.
    */

    switch (contractType) {
        case &quot;cargo&quot;:
            // cargo contracts
            var cc = worldScripts[&quot;oolite-contracts-cargo&quot;];
            // remove anything already there
            curr = this.$countContracts(31000);
            if (curr &gt; 0) this.$clearMissionSet(curr, 31000);
            curr = 0;
            for (var i = 0; i &lt; cc.$contracts.length; i++) {
                // make sure we only add missions that haven&#39;t passed their deadline
                if (cc.$contracts[i].deadline &gt; clock.adjustedSeconds) {
                    // make sure the id is clear
                    if (bb.$getIndex(31000 + curr) != -1) {
                        for (var j = 1; j &lt; 100; j++) {
                            if (bb.$getIndex(31000 + curr + j) === -1) {
                                curr = curr + j;
                                break;
                            }
                        }
                    }
                    bb.$addBBMission({
                        ID: (31000 + curr), // cargo contracts are from 31000
                        source: system.ID,
                        destination: cc.$contracts[i].destination,
                        stationKey: &quot;mainStation&quot;,
                        description: expandDescription(&quot;[contract-cargo-title]&quot;) + &quot; &quot; + cc._descriptionForGoods(cc.$contracts[i]).toLowerCase(),
                        details: expandDescription(&quot;[contract-cargo-description]&quot;, {
                            cargo: cc._descriptionForGoods(cc.$contracts[i]).toLowerCase(),
                            destination: System.systemNameForID(cc.$contracts[i].destination)
                        }),
                        payment: cc.$contracts[i].payment,
                        deposit: cc.$contracts[i].deposit,
                        allowTerminate: false,
                        completionType: &quot;IMMEDIATE&quot;,
                        stopTimeAtComplete: true,
                        allowPartialComplete: false,
                        expiry: cc.$contracts[i].deadline,
                        disablePercentDisplay: true,
                        noEmails: true,
                        markerShape: &quot;NONE&quot;, // marker control will be handled by contracts system
                        overlay: (xui === true ? ovr1 : &quot;&quot;),
                        playAcceptedSound: false,
                        remoteDepositProcess: true,
                        initiateCallback: &quot;$acceptCargoContract&quot;,
                        availableCallback: &quot;$cargoContractAvailable&quot;,
                        worldScript: this.name,
                    });
                    curr += 1;
                }
            }
            break;
        case &quot;passengers&quot;:
            // passenger contracts
            var pc = worldScripts[&quot;oolite-contracts-passengers&quot;];
            // remove anything already there
            curr = this.$countContracts(32000);
            if (curr &gt; 0) this.$clearMissionSet(curr, 32000);
            curr = 0;
            for (var i = 0; i &lt; pc.$passengers.length; i++) {
                // make sure we only add missions that haven&#39;t passed their deadline
                if (pc.$passengers[i].deadline &gt; clock.adjustedSeconds) {
                    var cust = [];
                    if (pc.$passengers[i].advance &gt; 0) cust.push({
                        heading: expandDescription(&quot;[contract-advance]&quot;),
                        value: formatCredits(pc.$passengers[i].advance, true, true)
                    });
                    cust.push({
                        heading: expandDescription(&quot;[contract-clientname]&quot;),
                        value: pc.$passengers[i].name + &quot;, a &quot; + pc.$passengers[i].species
                    });
                    // make sure the id is clear
                    if (bb.$getIndex(32000 + curr) != -1) {
                        for (var j = 1; j &lt; 100; j++) {
                            if (bb.$getIndex(32000 + curr + j) === -1) {
                                curr = curr + j;
                                break;
                            }
                        }
                    }
                    bb.$addBBMission({
                        ID: (32000 + curr), // passenger contracts are from 32000
                        source: system.ID,
                        destination: pc.$passengers[i].destination,
                        stationKey: &quot;mainStation&quot;,
                        description: expandDescription(&quot;[contract-passenger-title]&quot;),
                        details: expandDescription(&quot;[contract-passenger-description]&quot;, {
                            client: pc.$passengers[i].name,
                            destination: System.systemNameForID(pc.$passengers[i].destination)
                        }),
                        payment: pc.$passengers[i].payment,
                        allowTerminate: false,
                        completionType: &quot;IMMEDIATE&quot;,
                        stopTimeAtComplete: true,
                        allowPartialComplete: false,
                        expiry: pc.$passengers[i].deadline,
                        disablePercentDisplay: true,
                        noEmails: true,
                        markerShape: &quot;NONE&quot;, // marker control will be handled by contracts system
                        overlay: (xui === true ? ovr2 : &quot;&quot;),
                        playAcceptedSound: false,
                        customDisplayItems: cust,
                        initiateCallback: &quot;$acceptPassengerContract&quot;,
                        availableCallback: &quot;$passengerContractAvailable&quot;,
                        worldScript: this.name,
                    });
                    curr += 1;
                }
            }
            break;
        case &quot;parcels&quot;:
            // parcel contracts
            var bc = worldScripts[&quot;oolite-contracts-parcels&quot;];
            // remove anything already there
            curr = this.$countContracts(33000);
            if (curr &gt; 0) this.$clearMissionSet(curr, 33000);
            curr = 0;
            for (var i = 0; i &lt; bc.$parcels.length; i++) {
                // make sure we only add missions that haven&#39;t passed their deadline
                if (bc.$parcels[i].deadline &gt; clock.adjustedSeconds) {
                    // make sure the id is clear
                    if (bb.$getIndex(33000 + curr) != -1) {
                        for (var j = 1; j &lt; 100; j++) {
                            if (bb.$getIndex(33000 + curr + j) === -1) {
                                curr = curr + j;
                                break;
                            }
                        }
                    }
                    var cust = [];
                    cust.push({
                        heading: expandDescription(&quot;[contract-clientname]&quot;),
                        value: bc.$parcels[i].sender
                    });

                    bb.$addBBMission({
                        ID: (33000 + curr), // passenger contracts are from 33000
                        source: system.ID,
                        destination: bc.$parcels[i].destination,
                        stationKey: &quot;mainStation&quot;,
                        description: expandDescription(&quot;[contract-parcel-title]&quot;),
                        details: expandDescription(&quot;[contract-parcel-description]&quot;, {
                            parcel: bc.$parcels[i].description.toLowerCase(),
                            destination: System.systemNameForID(bc.$parcels[i].destination)
                        }),
                        payment: bc.$parcels[i].payment,
                        allowTerminate: false,
                        completionType: &quot;IMMEDIATE&quot;,
                        stopTimeAtComplete: true,
                        allowPartialComplete: false,
                        expiry: bc.$parcels[i].deadline,
                        disablePercentDisplay: true,
                        noEmails: true,
                        markerShape: &quot;NONE&quot;, // marker control will be handled by contracts system
                        overlay: (xui === true ? ovr3 : &quot;&quot;),
                        playAcceptedSound: false,
                        customDisplayItems: cust,
                        initiateCallback: &quot;$acceptParcelContract&quot;,
                        availableCallback: &quot;$parcelContractAvailable&quot;,
                        worldScript: this.name
                    });
                    curr += 1;
                }
            }
            break;
        case &quot;smuggling&quot;:
            if (this._smuggling) {
                // smuggling contracts
                var sc = worldScripts.Smugglers_Contracts;
                // remove anything already there
                curr = this.$countContracts(34000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 34000);
                curr = 0;
                for (var i = 0; i &lt; sc._contracts.length; i++) {
                    // make sure we only add missions that haven&#39;t passed their deadline
                    if (sc._contracts[i].deadline &gt; clock.adjustedSeconds) {
                        // make sure the id is clear
                        if (bb.$getIndex(34000 + curr) != -1) {
                            for (var j = 1; j &lt; 100; j++) {
                                if (bb.$getIndex(34000 + curr + j) === -1) {
                                    curr = curr + j;
                                    break;
                                }
                            }
                        }
                        bb.$addBBMission({
                            ID: (34000 + curr), // smuggling contracts are from 34000
                            source: system.ID,
                            destination: sc._contracts[i].destination,
                            stationKey: &quot;blackMarket&quot;,
                            description: expandDescription(&quot;[contract-smuggling-title]&quot;) + &quot; &quot; + sc.$descriptionForGoods(sc._contracts[i]),
                            details: expandDescription(&quot;[contract-smuggling-description]&quot;, {
                                cargo: sc.$descriptionForGoods(sc._contracts[i]),
                                destination: System.systemNameForID(sc._contracts[i].destination)
                            }),
                            payment: sc._contracts[i].payment,
                            deposit: sc._contracts[i].deposit,
                            allowTerminate: false,
                            completionType: &quot;IMMEDIATE&quot;,
                            stopTimeAtComplete: true,
                            allowPartialComplete: false,
                            expiry: sc._contracts[i].deadline,
                            disablePercentDisplay: true,
                            noEmails: true,
                            markerShape: &quot;NONE&quot;, // marker control will be handled by smuggling contract system
                            overlay: {
                                name: &quot;stgu-skull.png&quot;,
                                height: 546
                            },
                            playAcceptedSound: false,
                            remoteDepositProcess: true,
                            initiateCallback: &quot;$acceptSmugglingContract&quot;,
                            availableCallback: &quot;$smugglingContractAvailable&quot;,
                            worldScript: this.name,
                        });
                        curr += 1;
                    }
                }
                // force an update here
                if (player.ship.docked) bb.$initInterface(player.ship.dockedStation);
            }
            break;
        case &quot;escort&quot;:
            if (this._convertEscortContracts) {
                var ec = worldScripts[&quot;Escort_Contracts&quot;];
                // remove anything already there
                curr = this.$countContracts(35000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 35000);
                curr = 0;
                for (var i = 0; i &lt; ec.ec_targetsystems.length; i++) {
                    // make sure the id is clear;
                    if (bb.$getIndex(35000 + curr) != -1) {
                        for (var j = 1; j &lt; 100; j++) {
                            if (bb.$getIndex(35000 + curr + j) === -1) {
                                curr = curr + j;
                                break;
                            }
                        }
                    }
                    var cust = [];
                    cust.push({
                        heading: expandDescription(&quot;[contract-escort-bonus]&quot;),
                        value: formatCredits(ec.ec_killsbonuses[i], true, true) + &quot; per kill&quot;
                    });

                    var text = expandDescription(&quot;[ec_mission_details]&quot;, {
                        mothername: ec.ec_mothernames[i],
                        targetsystemname: ec.ec_targetsystemsnames[i],
                        dbcontractactualprice: formatCredits(ec.ec_contractactualprices[i], true, true),
                        dbkillsbonus: formatCredits(ec.ec_killsbonuses[i], true, true),
                        targetsystemgovernmentname: this._govTypes[ec.ec_targetsystemsgovernment[i]],
                        contractdifficultydesc: this._govRisk[ec.ec_targetsystemsgovernment[i]]
                    });
                    bb.$addBBMission({
                        ID: (35000 + curr), // escort contracts are from 35000
                        source: system.ID,
                        destination: ec.ec_targetsystems[i],
                        stationKey: &quot;mainStation&quot;,
                        description: expandDescription(&quot;[contract-escort-title]&quot;),
                        details: text,
                        payment: ec.ec_contractactualprices[i],
                        deposit: 0,
                        allowTerminate: false,
                        completionType: &quot;IMMEDIATE&quot;,
                        stopTimeAtComplete: true,
                        allowPartialComplete: false,
                        expiry: -1,
                        disablePercentDisplay: true,
                        noEmails: false, // escort contracts don&#39;t have emails built in, so use the BB&#39;s system
                        markerShape: &quot;NONE&quot;, // marker control will be handled by escort contracts
                        overlay: {
                            name: &quot;cobb_ec.png&quot;,
                            height: 546
                        },
                        remoteDepositProcess: false,
                        customDisplayItems: cust,
                        initiateCallback: &quot;$acceptEscortContract&quot;,
                        availableCallback: &quot;$escortContractAvailable&quot;,
                        worldScript: this.name,
                        data: &quot;escort&quot;
                    });
                    curr += 1;
                }
            }
            break;
        case &quot;rescue&quot;:
            if (this._convertRRSContracts) {
                var rrs = worldScripts[&quot;Rescue Stations&quot;];
                // remove anything already there
                curr = this.$countContracts(36000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 36000);
                curr = 0;
                // if we&#39;re currently running an RRS mission, then store the current variables before we start
                if (rrs.missionActive()) this.$rrsStoreCurrentVariables();
                for (var i = 0; i &lt; this._rrsMissionList.length; i++) {
                    var cust = [];
                    cust.push({
                        heading: &quot;Client name:&quot;,
                        value: &quot;RRS Operations Manager&quot;
                    });
                    var scen = &quot;Rescue Scenario &quot; + this._rrsMissionList[i];
                    if (!worldScripts[scen] &amp;&amp; this._rrsMissionList[i].length &gt; 1) scen = &quot;Rescue Scenario &quot; + this._rrsMissionList[i].substring(0, 1);

                    // load the mission variables for this scenario, either from RRS or from our saved data
                    if (this._rrsMissionStorage[scen]) {
                        this.$rrsReloadMissionVariables(scen, i);
                    } else {
                        worldScripts[scen].initMissionVariables();
                        this.$rrsSaveMissionVariables(scen, i);
                    }
                    // get the model for the mission type, but convert it into a shipKey so that the same model is shown every time.
                    // although secondary screens, displayed by RRS, might still show a different one. At least the BB will be consistent.
                    var mdl = this.$rrsGetKeyForShipRole(this.$rrsGetShipRoleForScenario(scen));
                    // make sure we only add missions that haven&#39;t passed their deadline
                    if (missionVariables.rescuestation_deadline &gt; clock.adjustedSeconds) {
                        // make sure the id is clear
                        if (bb.$getIndex(36000 + curr) != -1) {
                            for (var j = 1; j &lt; 100; j++) {
                                if (bb.$getIndex(36000 + curr + j) === -1) {
                                    curr = curr + j;
                                    break;
                                }
                            }
                        }
                        // add the mission to the bb
                        bb.$addBBMission({
                            ID: (36000 + curr), // rrs contracts are from 36000
                            source: system.ID,
                            destination: (missionVariables.rescuestation_destsystem ? missionVariables.rescuestation_destsystem : missionVariables.rescuestation_system),
                            stationKey: &quot;rescueStation&quot;,
                            description: this.$rrsExtractMissionTitle(this._rrsMissionList[i]),
                            details: this.$rrsExtractMissionDetails(this._rrsMissionList[i]),
                            payment: missionVariables.rescuestation_reward,
                            deposit: 0,
                            allowTerminate: false,
                            completionType: &quot;IMMEDIATE&quot;,
                            stopTimeAtComplete: true,
                            allowPartialComplete: false,
                            expiry: (missionVariables.rescuestation_deadline ? missionVariables.rescuestation_deadline : -1),
                            disablePercentDisplay: true,
                            noEmails: false,
                            markerShape: &quot;NONE&quot;, // marker control will be handled by RRS
                            model: &quot;[&quot; + mdl + &quot;]&quot;,
                            modelPersonality: Math.floor(Math.random() * 32768),
                            overlay: {
                                name: &quot;cobb_rrs.png&quot;,
                                height: 546
                            },
                            remoteDepositProcess: false,
                            customDisplayItems: cust,
                            initiateCallback: &quot;$acceptRRSContract&quot;,
                            availableCallback: &quot;$rrsContractAvailable&quot;,
                            worldScript: this.name,
                            data: &quot;rescue&quot;
                        });
                        curr += 1;
                    }
                    this.$rrsResetMissionVariables(scen);
                }
                // put everything back how we found it
                if (rrs.missionActive()) this.$rrsReturnCurrentVariables();
            }
            break;
        case &quot;random_hits&quot;:
            if (this._convertRHContracts) {
                var rh = worldScripts[&quot;Random_Hits&quot;];
                // remove anything already there
                curr = this.$countContracts(37000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 37000);
                var difficultyText = [&quot;Easy&quot;, &quot;Challenging&quot;, &quot;Hard&quot;];
                var page = 1;
                curr = 0;
                if (rh.pages &amp;&amp; rh.pages.length &gt; 0 &amp;&amp; rh.pages[0] &amp;&amp; rh.pages[0].hasOwnProperty(&quot;mark_system&quot;)) {
                    for (var i = 0; i &lt; rh.pages.length; i++) {
                        var cust = [];
                        rh.readHitpage(i + 1);
                        //log(this.name, &quot;rh &quot; + missionVariables.random_hits_mark_system);
                        cust.push({
                            heading: &quot;Client name:&quot;,
                            value: missionVariables.random_hits_assassination_board_poster_title + &quot; &quot; + missionVariables.random_hits_assassination_board_poster_name + &quot; &quot; + missionVariables.random_hits_assassination_board_poster_surname
                        });
                        cust.push({
                            heading: &quot;Difficulty:&quot;,
                            value: difficultyText[page - 1]
                        })
                        cust.push({
                            heading: &quot;Termination fee:&quot;,
                            value: formatCredits(missionVariables.random_hits_mark_fee / 10, true, true)
                        });
                        // make sure the id is clear
                        if (bb.$getIndex(37000 + curr) != -1) {
                            for (var j = 1; j &lt; 100; j++) {
                                if (bb.$getIndex(37000 + curr + j) === -1) {
                                    curr = curr + j;
                                    break;
                                }
                            }
                        }
                        bb.$addBBMission({
                            ID: (37000 + curr), // rh contracts are from 37000
                            source: system.ID,
                            destination: (missionVariables.random_hits_mark_system ? System.systemIDForName(missionVariables.random_hits_mark_system) : system.ID),
                            stationKey: &quot;randomHits&quot;,
                            description: this.$rhExtractMissionTitle(missionVariables.random_hits_assassination_board_subject),
                            details: this.$rhExtractMissionDetails(this.$rhReplaceMissionVariables(expandMissionText(&quot;level_&quot; + page + &quot;_mark_advert&quot;))) + this.$rhDifficultyText(page),
                            payment: missionVariables.random_hits_mark_fee,
                            deposit: 0,
                            allowTerminate: true,
                            completionType: &quot;IMMEDIATE&quot;,
                            stopTimeAtComplete: true,
                            allowPartialComplete: false,
                            expiry: -1,
                            disablePercentDisplay: true,
                            noEmails: false,
                            markerShape: &quot;NONE&quot;, // marker control will be handled by RH
                            remoteDepositProcess: false,
                            customDisplayItems: cust,
                            model: &quot;[&quot; + missionVariables.random_hits_mark_ship + &quot;]&quot;,
                            modelPersonality: missionVariables.random_hits_mark_ship_personality,
                            initiateCallback: &quot;$acceptRHContract&quot;,
                            terminateCallback: &quot;$terminateRHContract&quot;,
                            availableCallback: &quot;$rhContractAvailable&quot;,
                            worldScript: this.name,
                            data: &quot;randomhits&quot;
                        });
                        curr += 1;
                        page += 1;
                        page = ((page - 1) % 3) + 1;
                    }
                }
            }
            break;
        case &quot;taxi&quot;:
            if (this._convertTaxiContracts) {
                var taxi = worldScripts[&quot;in-system_taxi&quot;];
                // remove anything already there
                curr = this.$countContracts(38000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 38000);
                curr = 0;
                for (var i = 0; i &lt; taxi.$stationOffers.length; i++) {
                    if (taxi.$stationOffers[i][0] &lt; 2) {
                        var cust = [];
                        cust.push({
                            heading: expandDescription(&quot;[contract-clientname]&quot;),
                            value: taxi.$stationOffers[i][5]
                        });
                        var text = &quot;Taxi Galactica contract to transfer &quot; + taxi.$stationOffers[i][5] + &quot; from the &quot; +
                            taxi.$stationOffers[i][1].displayName + &quot; to the &quot; + taxi.$stationOffers[i][2].displayName + &quot;.\n\n&quot; +
                            &quot;Tips may be awarded for quick transfers.&quot;;
                        // make sure the id is clear
                        if (bb.$getIndex(38000 + curr) != -1) {
                            for (var j = 1; j &lt; 100; j++) {
                                if (bb.$getIndex(38000 + curr + j) === -1) {
                                    curr = curr + j;
                                    break;
                                }
                            }
                        }
                        bb.$addBBMission({
                            ID: (38000 + curr), // escort contracts are from 35000
                            source: system.ID,
                            destination: system.ID,
                            stationKey: &quot;taxi&quot;,
                            description: &quot;Taxi Contract&quot;,
                            details: text,
                            payment: taxi.$stationOffers[i][4],
                            deposit: 0,
                            allowTerminate: false,
                            completionType: &quot;IMMEDIATE&quot;,
                            stopTimeAtComplete: true,
                            allowPartialComplete: false,
                            expiry: taxi.$stationOffers[i][3],
                            disablePercentDisplay: true,
                            noEmails: false, // escort contracts don&#39;t have emails built in, so use the BB&#39;s system
                            markerShape: &quot;NONE&quot;, // marker control will be handled by escort contracts
                            overlay: {
                                name: &quot;cobb_taxi.png&quot;,
                                height: 546
                            },
                            remoteDepositProcess: false,
                            customDisplayItems: cust,
                            initiateCallback: &quot;$acceptTaxiContract&quot;,
                            availableCallback: &quot;$taxiContractAvailable&quot;,
                            worldScript: this.name,
                            data: &quot;taxi&quot;
                        });
                        curr += 1;
                    }
                }

            }
            break;
        case &quot;mining&quot;:
            if (this._convertMiningContracts) {
                var mc = worldScripts.miningcontracts;
                // remove anything already there
                curr = this.$countContracts(39000);
                if (curr &gt; 0) this.$clearMissionSet(curr, 39000);
                curr = 0;
                for (var i = 0; i &lt; mc.MC_contracts.length; i++) {
                    var contract = mc.MC_contracts[i];
                    var cust = [];
                    cust.push({
                        heading: &quot;Client name:&quot;,
                        value: contract.company
                    });
                    cust.push({
                        heading: &quot;Forfeit penalty:&quot;,
                        value: formatCredits(contract.penalty, true, true) + &quot; per ton of shortage&quot;
                    });

                    var med = &quot;Mining Association of &quot; + mc.MC_system;
                    var custMenu = [];
                    custMenu.push({
                        text: &quot;Dispatch current cargo load&quot;,
                        worldScript: this.name,
                        callback: &quot;$partMiningContract_process&quot;,
                        condition: &quot;$partMiningContract_condition&quot;,
                        autoRemove: false
                    });

                    var text = expandDescription(&quot;[contract-mining-details]&quot;, {
                        amount: (contract.signed === 0 ? contract.amount : contract.gross),
                        cargo: displayNameForCommodity(contract.cargo).toLowerCase(),
                        mediator: med
                    });

                    // make sure the id is clear
                    if (bb.$getIndex(39000 + curr) != -1) {
                        for (var j = 1; j &lt; 100; j++) {
                            if (bb.$getIndex(39000 + curr + j) === -1) {
                                curr = curr + j;
                                break;
                            }
                        }
                    }

                    bb.$addBBMission({
                        ID: (39000 + curr), // mining contracts are from 39000
                        source: system.ID,
                        destination: 256, // ignore the destination
                        stationKey: &quot;rockHermit&quot;,
                        description: expandDescription(&quot;[contract-mining-title]&quot;, {
                            amount: (contract.signed === 0 ? contract.amount : contract.gross),
                            cargo: displayNameForCommodity(contract.cargo).toLowerCase()
                        }),
                        details: text,
                        payment: contract.reward,
                        deposit: 0,
                        allowTerminate: true,
                        completionType: &quot;AT_SOURCE&quot;,
                        stopTimeAtComplete: false,
                        allowPartialComplete: false,
                        expiry: contract.deadline,
                        disablePercentDisplay: false,
                        percentComplete: (contract.signed === 0 ? 0.0 : (contract.gross - contract.amount) / contract.gross),
                        accepted: (contract.signed === 1 ? true : false),
                        noEmails: true, // because of the way we&#39;re re-adding these contracts all the time, we can&#39;t use the built in emailer
                        markerShape: &quot;NONE&quot;, // mining contracts can only be completed in current system, so don&#39;t add any
                        overlay: {
                            name: &quot;cobb_mining.png&quot;,
                            height: 546
                        },
                        remoteDepositProcess: false,
                        customMenuItems: custMenu,
                        customDisplayItems: cust,
                        initiateCallback: &quot;$acceptMiningContract&quot;,
                        completedCallback: &quot;$completedMiningContract&quot;,
                        confirmCompleteCallback: &quot;$confirmCompleteMiningContract&quot;,
                        terminateCallback: &quot;$terminateMiningContract&quot;,
                        manifestCallback: &quot;$miningManifest&quot;,
                        worldScript: this.name,
                        postStatusMessages: [{
                                status: &quot;completed&quot;,
                                return: &quot;list&quot;,
                                overlay: {
                                    name: &quot;cobb_mining.png&quot;,
                                    height: 546
                                },
                                text: expandDescription(&quot;[contract-mining-completed]&quot;, {
                                    mediator: med,
                                    amount: formatCredits(contract.reward, true, true)
                                })
                            },
                            {
                                status: &quot;terminated&quot;,
                                return: &quot;list&quot;,
                                overlay: {
                                    name: &quot;cobb_mining.png&quot;,
                                    height: 546
                                },
                                text: expandDescription(&quot;[contract-mining-terminated-1]&quot;, {
                                    mediator: med,
                                    amount: 0
                                })
                            }
                        ],
                        data: &quot;mining&quot;
                    });
                    curr += 1;
                }
            }
            break;
        case &quot;taxi_galactica&quot;:
            var tg = worldScripts.taxi_galactica_main;
            // remove anything already there
            curr = this.$countContracts(40000);
            if (curr &gt; 0) this.$clearMissionSet(curr, 40000);
            curr = 0;
            for (var i = 1; i &lt;= 3; i++) {
                var cust = [];
                var s = System.infoForSystem(galaxyNumber, (Math.random() &gt; 0.5 ? missionVariables[&quot;taxi_job_dest_&quot; + i] : system.ID));
                cust.push({
                    heading: expandDescription(&quot;[contract-clientname]&quot;),
                    value: missionVariables[&quot;taxi_job_name_&quot; + i] + &quot;, a &quot; + s.inhabitant
                }, {
                    heading: &quot;Difficulty&quot;,
                    value: missionVariables[&quot;taxi_job_diff_name_&quot; + i]
                });
                // make sure the id is clear
                if (bb.$getIndex(40000 + curr) != -1) {
                    for (var j = 1; j &lt; 20; j++) {
                        if (bb.$getIndex(40000 + curr + j) === -1) {
                            curr = curr + j;
                            break;
                        }
                    }
                }
                bb.$addBBMission({
                    ID: (40000 + curr), // taxi galactica contracts are from 40000
                    source: system.ID,
                    destination: missionVariables[&quot;taxi_job_dest_&quot; + i],
                    stationKey: &quot;taxiGalactica&quot;,
                    description: expandDescription(&quot;[taxi-galactica-passenger-title]&quot;),
                    details: expandDescription(&quot;[taxi-galactica-passenger-description]&quot;, {
                        client: missionVariables[&quot;taxi_job_name_&quot; + i],
                        destination: System.systemNameForID(missionVariables[&quot;taxi_job_dest_&quot; + i])
                    }),
                    payment: missionVariables[&quot;taxi_job_pay_&quot; + i],
                    allowTerminate: false,
                    completionType: &quot;IMMEDIATE&quot;,
                    stopTimeAtComplete: true,
                    allowPartialComplete: false,
                    expiry: (clock.seconds + missionVariables[&quot;taxi_job_time_&quot; + i] * 24 * 3600),
                    disablePercentDisplay: true,
                    noEmails: true,
                    markerShape: &quot;NONE&quot;, // marker control will be handled by contracts system
                    overlay: {
                        name: &quot;cobb_taxi.png&quot;,
                        height: 546
                    },
                    customDisplayItems: cust,
                    initiateCallback: &quot;$tg_acceptContract&quot;,
                    availableCallback: &quot;$taxiGalacticaContractAvailable&quot;,
                    worldScript: this.name,
                    data: &quot;taxi_galactica&quot;
                });
                curr += 1;
            }
            break;
    }

    if (this._bbShuffle) bb.$shuffleBBList();
}

//-------------------------------------------------------------------------------------------------------------
// accept contract functions
//-------------------------------------------------------------------------------------------------------------
this.$acceptCargoContract = function (missID) {
    var idx = parseInt(missID);
    var cc = worldScripts[&quot;oolite-contracts-cargo&quot;];
    cc.$contractIndex = idx - 31000;
    cc._acceptContract();
    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(31000, idx - 31000, false);

    if (this._turnOffF4Entries) system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;, null);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptPassengerContract = function (missID) {
    var idx = parseInt(missID);
    var pc = worldScripts[&quot;oolite-contracts-passengers&quot;];
    pc.$contractIndex = idx - 32000;
    pc._acceptContract();
    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(32000, idx - 32000, false);

    if (this._turnOffF4Entries) system.mainStation.setInterface(&quot;oolite-contracts-passengers&quot;, null);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptParcelContract = function (missID) {
    var idx = parseInt(missID);
    var bc = worldScripts[&quot;oolite-contracts-parcels&quot;];
    bc.$contractIndex = idx - 33000;
    bc._acceptContract();
    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(33000, idx - 33000, false);

    if (this._turnOffF4Entries) system.mainStation.setInterface(&quot;oolite-contracts-parcels&quot;, null);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptSmugglingContract = function (missID) {
    var idx = parseInt(missID);
    var sc = worldScripts.Smugglers_Contracts;
    sc._contractIndex = idx - 34000;
    sc.$acceptContract();
    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(34000, idx - 34000, false);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptEscortContract = function (missID) {
    var idx = parseInt(missID) - 35000;
    var ec = worldScripts[&quot;Escort_Contracts&quot;];
    ec.ec_contractno = idx;
    ec.ec_updatemissionvariables();
    ec.ec_currentcontract = true;
    ec.ec_contractexpiretime = clock.minutes + 180;
    ec.ec_missionkills = 0;
    ec.ec_payment = 0;
    ec.ec_mothername = missionVariables.ec_mothername;
    ec.ec_targetsystem = missionVariables.ec_targetsystem;
    ec.ec_contractactualprice = missionVariables.ec_dbcontractactualprice;
    ec.ec_killsbonus = missionVariables.ec_dbkillsbonus;
    mission.setInstructionsKey(&quot;Contract_Details&quot;, &quot;Escort_Contracts&quot;);
    ec.ec_cleanupmissionVariables();

    // theoretically we don&#39;t need to do this because you can only accept one escort mission at a time
    // but to be consistent...

    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(35000, idx, false);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptRRSContract = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    // RRS missions have their own post-acceptance screen, but we need to exit the BB to see it
    bb._displayType = -1;

    // reset mission variables back to the details for the mission
    var idx = parseInt(missID) - 36000;
    var rrsScenario = this._rrsMissionList[idx];
    // run the initMissionVariables routine, but we&#39;ll be overwriting all the values anyway.
    worldScripts[&quot;Rescue Stations&quot;].initMissionVariables(rrsScenario);
    // force the stage into 2, to ensure the correct mission screen is displayed during the &quot;missionOfferDecision&quot; routine.
    missionVariables.rescuestation_stage = 2;

    // now that the mission is accepted, plug in the variables we stored
    var list = this._rrsMissionVariables[&quot;Rescue Scenario &quot; + rrsScenario];
    for (var i = 0; i &lt; list.length; i++) {
        missionVariables[list[i]] = this._rrsMissionStorage[idx][list[i]];
    }

    // remove the mission from our holding arrays
    this._rrsMissionList.splice(idx, 1);
    this._rrsMissionStorage.splice(idx, 1);

    // check for, and run, any post-mission acceptance routine 
    // this may result in the player being forcably launched
    if (worldScripts[&quot;Rescue Scenario &quot; + rrsScenario].missionOfferDecision) worldScripts[&quot;Rescue Scenario &quot; + rrsScenario].missionOfferDecision(&quot;yes&quot;);

    // theoretically we don&#39;t need to do this because you can only accept one RRS mission at a time
    // but to be consistent...

    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(36000, idx, false);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptRHContract = function (missID) {
    // we&#39;re reproducing the mission acceptance code here so we can also replace the email display
    //var idx = parseInt(missID) - 37000;
    var idx = -1;
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);

    var rh = worldScripts[&quot;Random_Hits&quot;];
    // find the linked RH item
    for (var i = 0; i &lt; rh.pages.length; i++) {
        rh.readHitpage(i + 1);
        if (item.destinationName === missionVariables.random_hits_mark_system &amp;&amp; parseInt(item.payment) === parseInt(missionVariables.random_hits_mark_fee)) {
            idx = i;
            break;
        }
    }
    if (idx === -1) {
        log(this.name, &quot;!!ERROR: Unable to link BB item to original Random Hits contract&quot;);
        // un-accept the contract so we don&#39;t get confused.
        item.accepted = false;
        bb.$initInterface(player.ship.dockedStation);
        return;
    }
    rh.setStoreVariables(idx + 1);
    rh.$markSystem(missionVariables.random_hits_planetnumber);

    // send email
    if (worldScripts.EmailSystem) {
        var email = worldScripts.EmailSystem;
        var text = this.$rhReplaceMissionVariables(expandDescription(&quot;Thank you [assassination_board_refused2] [mission_random_hits_playertitle] [commander_name], &quot; +
            &quot;you [assassination_board_accepted1] [assassination_board_accepted2] [assassination_board_accepted3] [assassination_board_accepted4] &quot; +
            &quot;[assassination_board_accepted5] this [mission_random_hits_assassination_board_job_name]. &quot; +
            &quot;[assassination_board_accepted6] [assassination_board_refused5] [assassination_board_accepted7]! &quot; +
            &quot;[mission_random_hits_assassination_board_part5] mission_random_hits_mark_fee Credits [assassination_board_accepted7a] &quot; +
            &quot;upon docking with any GalCop Station or Seedy Space Bar following the [assassination_board_accepted8] of [assassination_board_refused5b]. &quot; +
            &quot;This [assassination_board_accepted9] will be in addition to any bounty paid by GalCop. [assassination_board_accepted10]\n\n&quot; +
            &quot;You have accepted this [mission_random_hits_assassination_board_job_name]. [assassination_board_accepted11]. If you leave Galaxy &quot; +
            &quot;[mission_random_hits_show_galaxy] you will be deemed to have abandoned the [mission_random_hits_assassination_board_job_name].&quot;));

        email.$createEmail({
            sender: this.$rhReplaceMissionVariables(expandDescription(&quot;mission_random_hits_assassination_board_poster_title mission_random_hits_assassination_board_poster_name&quot;)),
            subject: this.$rhReplaceMissionVariables(expandDescription(&quot;[assassination_board_refused1] mission_random_hits_mark_first_name mission_random_hits_mark_nick_name [mission_random_hits_mark_second_name]&quot;)),
            date: global.clock.seconds,
            message: text
        });
    }

    //random shipnames sometimes makes very long names that don&#39;t fit in one missionline.
    //if that happens we&#39;ll use plain ship name instead.
    var instructions = expandMissionText(&quot;random_hits_shortdescription&quot;);
    if (defaultFont.measureString(instructions) &gt; 32) {
        missionVariables.random_hits_mark_ship_short_name = Ship.shipDataForKey(missionVariables.random_hits_mark_ship)[&quot;name&quot;];
        instructions = expandMissionText(&quot;random_hits_shorterdescription&quot;);
    }
    mission.setInstructions(instructions, &quot;Random_Hits&quot;);
    delete missionVariables.random_hits_mark_ship_short_name;

    rh.setupMarkPosition(); // sets mark position and various fees.
    missionVariables.random_hits_status = &quot;RUNNING&quot;;

    // theoretically we don&#39;t need to do this because you can only accept one RH mission at a time
    // but to be consistent...

    // reindex the bb item, because we don&#39;t need to know about the details anymore
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    // we don&#39;t need to reindex this time - RH keeps 9 items in the array even if a contract has been accepted and then terminated
    //this.$reindexContracts(37000, idx, false);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptTaxiContract = function (missID) {
    var idx = parseInt(missID) - 38000;
    var taxi = worldScripts[&quot;in-system_taxi&quot;];
    taxi.$removeOfferTimer(); //in case there is an offerTimer running from in-flight offers.
    taxi.$currentOffer = taxi.$stationOffers[idx];
    taxi.$currentOffer[0] = 2;

    // reindex the bb item, because we don&#39;t need to know about the details anymore
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID

    this.$reindexContracts(38000, idx, false);

    taxi.$deleteMissionInstructions();
    player.ship.addPassenger(taxi.$currentOffer[5] + &quot; (going to &quot; + taxi.$currentOffer[2].displayName + &quot;)&quot;, system.ID, system.ID, taxi.$currentOffer[3], 0);
    taxi.$currentOffer[0] = 3;
    taxi.$currentOffer[7] = taxi.$currentOffer[3] - clock.seconds; //premium is based on basetime. basetime is defined when pickin up passenger.
    taxi.$fireMissionScreen = 0;
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptMiningContract = function (missID) {
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    contract.signed = 1;
    contract.gross = contract.amount;
    player.consoleMessage(&quot;Contract signed&quot;);
    if (worldScripts.EmailSystem) {
        var bb = worldScripts.BulletinBoardSystem;
        var itm = bb.$getItem(missID);
        itm.manifestText = &quot;Dispatch &quot; + contract.amount + &quot;t  &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; for &quot; + contract.company;
        itm.noEmails = false;
        bb.$sendEmail(player.ship.dockedStation, &quot;accepted&quot;, missID);
        itm.noEmails = true;
    }
    this.$convertContracts(&quot;mining&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$tg_acceptContract = function (missID) {
    var idx = (missID - 40000) + 1; // should be 1, 2 or 3
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);

    // Store passenger contract #1 details into variables and add passenger to ship &amp; manifest:
    missionVariables.taxi_passenger = missionVariables[&quot;taxi_job_name_&quot; + idx];
    missionVariables.taxi_dest = missionVariables[&quot;taxi_job_dest_&quot; + idx];
    missionVariables.taxi_dest_name = missionVariables[&quot;taxi_job_dest_name_&quot; + idx];
    missionVariables.taxi_diff = missionVariables[&quot;taxi_job_diff_&quot; + idx];
    missionVariables.taxi_pay = missionVariables[&quot;taxi_job_pay_&quot; + idx];
    missionVariables.taxi_time = missionVariables[&quot;taxi_job_time_&quot; + idx];
    missionVariables.taxistatus = &quot;ON_THE_JOB&quot;;
    var name = missionVariables.taxi_passenger;
    var curloc = system.ID;
    var dest = missionVariables.taxi_dest;
    var time = missionVariables.taxi_time;
    var pay = missionVariables.taxi_pay;
    player.ship.addPassenger(name, curloc, dest, clock.seconds + time * 24 * 3600, pay);
    missionVariables.taxistat = &quot;ACCEPTED&quot;;

    // reindex the bb item, because we don&#39;t need to know about the details anymore
    item.ID = bb.$nextID();
    bb._selectedItem = item.ID
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptTaxiOffer_inFlight = function () {
    // run the internal part first
    if (this.$cobb_acceptOffer) this.$cobb_acceptOffer;

    // now add the BB item to match
    var bb = worldScripts.BulletinBoardSystem;
    var text = &quot;Taxi Galactica contract to transfer &quot; + this.$currentOffer[5] + &quot; from the &quot; +
        this.$currentOffer[1].displayName + &quot; to the &quot; + this.$currentOffer[2].displayName + &quot;.\n\n&quot; +
        &quot;Tips may be awarded for quick transfers.&quot;;
    bb.$addBBMission({
        source: system.ID,
        destination: system.ID,
        stationKey: &quot;taxi&quot;,
        description: &quot;Taxi Contract&quot;,
        details: text,
        payment: this.$currentOffer[4],
        deposit: 0,
        allowTerminate: false,
        completionType: &quot;IMMEDIATE&quot;,
        stopTimeAtComplete: true,
        allowPartialComplete: false,
        expiry: this.$currentOffer[3],
        disablePercentDisplay: true,
        noEmails: false,
        markerShape: &quot;NONE&quot;,
        overlay: {
            name: &quot;cobb_taxi.png&quot;,
            height: 546
        },
        remoteDepositProcess: false,
        initiateCallback: &quot;$acceptTaxiContract&quot;,
        availableCallback: &quot;$taxiContractAvailable&quot;,
        worldScript: this.name,
        data: &quot;taxi&quot;
    });
}

//-------------------------------------------------------------------------------------------------------------
this.$terminateRHContract = function (missID) {
    var rh = worldScripts[&quot;Random_Hits&quot;];
    rh.showScreen = &quot;cancelMission&quot;;
    rh.missionOffers();
    rh.showScreen = &quot;&quot;;
    worldScripts.BulletinBoardSystem._displayType = -1;
}

//-------------------------------------------------------------------------------------------------------------
this.$completedMiningContract = function (missID) {
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    var reward = contract.reward - contract.amount * contract.penalty;
    var repayment = Math.min(reward, mc.MC_debt);
    reward -= repayment;
    mc.MC_debt -= repayment;
    if (reward &gt; 0) {
        player.consoleMessage(formatCredits(reward, true, true) + &quot; received&quot;);
    } else {
        player.consoleMessage(formatCredits(Math.abs(reward), true, true) + &quot; deducted&quot;);
    }
    player.credits += reward;
    if (worldScripts.EmailSystem) {
        var bb = worldScripts.BulletinBoardSystem;
        var itm = bb.$getItem(missID);
        var med = &quot;Mining Association of &quot; + mc.MC_system;
        if (contract.amount === 0) {
            // success result
            itm.originalManifestText = &quot;Dispatch &quot; + contract.gross + &quot;t  &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; for &quot; + contract.company + (repayment === 0 ? &quot;&quot; : &quot;\n\nNote: A debt repayment amount of &quot; + formatCredits(repayment, true, true) + &quot; was deducted from the original payment amount.&quot;);
            // move this to the event callback
            itm.noEmails = false;
            bb.$sendEmail(player.ship.dockedStation, &quot;success&quot;, missID, reward);
            itm.noEmails = true;
        } else {
            // terminated/failed result
            itm.originalManifestText = &quot;Dispatch &quot; + contract.gross + &quot;t  &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; for &quot; + contract.company;
            itm.noEmails = false;
            if (contract.deadline &gt; clock.adjustedSeconds) {
                // not expired, so must be a manual termination
                bb.$sendEmail(player.ship.dockedStation, &quot;terminated&quot;, missID, -reward);
            } else {
                // ran out of time
                bb.$sendEmail(player.ship.dockedStation, &quot;fail&quot;, missID, -reward);
            }
            itm.noEmails = true;
        }
    }
    mc.MC_contracts.splice(idx, 1);
    this.$convertContracts(&quot;mining&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$confirmCompleteMiningContract = function (missID) {
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    if (contract.signed === 2) return &quot;Contract terminated&quot;;
    var amount = manifest[contract.cargo];
    if (amount &lt; contract.amount) return &quot;Insufficient &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; in cargo hold&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$terminateMiningContract = function (missID) {
    player.consoleMessage(&quot;Contract terminated&quot;);
    this.$completedMiningContract(missID);
}

//-------------------------------------------------------------------------------------------------------------
// manifest functions

// There doesn&#39;t appear to be any way to override the F5F5 manifest entries for cargo, passenger or parcel contracts. 
// So we&#39;ll leave them to do their thing. These next 3 functions would add entries to the &quot;Bulletin Board&quot; section of the F5F5 screen.

//-------------------------------------------------------------------------------------------------------------
this.$cargoManifest = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var itm = bb.$getItem(missID);
    var desc = &quot;&quot;;
    for (var i = 0; i &lt; p.contracts.length; i++) {
        if (parseInt(itm.destination) === parseInt(p.contracts[i].destination) &amp;&amp; Math.round(itm.payment, 1) === Math.round((p.contracts[i].fee + p.contracts[i].premium), 1) &amp;&amp; parseint(itm.source) === parseInt(p.contracts[i].start)) {
            var unit = &quot;tons&quot;;
            if (system.mainStation.market[p.contracts[i].commodity][&quot;quantity_unit&quot;] == &quot;1&quot;) {
                unit = &quot;kilograms&quot;;
            } else if (system.mainStation.market[p.contracts[i].commodity][&quot;quantity_unit&quot;] == &quot;2&quot;) {
                unit = &quot;grams&quot;;
            }
            desc = &quot;Deliver &quot; + p.contracts[i].quantity + unit + &quot;  &quot; + displayNameForCommodity(p.contracts[i].commodity) + &quot; to &quot; + System.systemNameForID(p.contracts[i].destination) + &quot; in &quot; + bb.$getTimeRemaining(itm.expiry) + &quot;.&quot;;
            break;
        }
    }
    bb.$updateBBManifestText(missID, desc);
}

//-------------------------------------------------------------------------------------------------------------
this.$passengerManifest = function (missID) {
    var p = player.ship;
    var bb = worldScripts.BulletinBoardSystem;
    var itm = bb.$getItem(missID);
    var desc = &quot;&quot;;
    for (var i = 0; i &lt; p.passengers.length; i++) {
        if (parseInt(itm.destination) === parseInt(p.passengers[i].destination) &amp;&amp; Math.round(itm.payment, 1) === Math.round((p.passengers[i].fee + p.contracts[i].premium), 2) &amp;&amp; parseInt(itm.source) === parseInt(p.passengers[i].start)) {
            desc = &quot;Transport &quot; + p.passengers[i].name + &quot; to &quot; + System.systemNameForID(p.passengers[i].destination) + &quot; in &quot; + bb.$getTimeRemaining(itm.expiry) + &quot;.&quot;;
            break;
        }
    }
    bb.$updateBBManifestText(missID, desc);
}

//-------------------------------------------------------------------------------------------------------------
this.$parcelManifest = function (missID) {
    var p = player.ship;
    var bb = worldScripts.BulletinBoardSystem;
    var itm = bb.$getItem(missID);
    var desc = &quot;&quot;;
    for (var i = 0; i &lt; p.parcels.length; i++) {
        if (parseInt(itm.destination) === parseInt(p.parcels[i].destination) &amp;&amp; Math.round(itm.payment, 1) === Math.round(p.parcels[i].fee, 1) &amp;&amp; parseInt(itm.source) === parseInt(p.parcels[i].start)) {
            desc = &quot;Deliver &quot; + p.parcels[i].name + &quot; to &quot; + System.systemNameForID(p.parcels[i].destination) + &quot; in &quot; + bb.$getTimeRemaining(itm.expiry) + &quot;.&quot;;
            break;
        }
    }
    bb.$updateBBManifestText(missID, desc);
}

//-------------------------------------------------------------------------------------------------------------
this.$smugglingManifest = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var sc = worldScripts.Smugglers_Contracts;
    var itm = bb.$getItem(missID);
    var desc = &quot;&quot;;
    for (var i = 0; i &lt; sc._smugglingContracts.length; i++) {
        if (parseInt(itm.destination) === parseInt(sc._smugglingContracts[i].destination) &amp;&amp; Math.round(itm.payment, 1) === Math.round((sc._smugglingContracts[i].fee + sc._smugglingContracts[i].premium), 1) &amp;&amp; parseint(itm.source) === parseInt(sc._smugglingContracts[i].start)) {
            var unit = &quot;tons&quot;;
            if (system.mainStation.market[sc._smugglingContracts[i].commodity][&quot;quantity_unit&quot;] == &quot;1&quot;) {
                unit = &quot;kilograms&quot;;
            } else if (system.mainStation.market[sc._smugglingContracts[i].commodity][&quot;quantity_unit&quot;] == &quot;2&quot;) {
                unit = &quot;grams&quot;;
            }
            desc = &quot;Deliver &quot; + sc._smugglingContracts[i].quantity + unit + &quot; &quot; + displayNameForCommodity(sc._smugglingContracts[i].commodity) + &quot; to &quot; + System.systemNameForID(sc._smugglingContracts[i].destination) + &quot; in &quot; + bb.$getTimeRemaining(itm.expiry) + &quot;.&quot;;
            break;
        }
    }
    bb.$updateBBManifestText(missID, desc);
}

//-------------------------------------------------------------------------------------------------------------
this.$taxiManifest = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    var taxi = worldScripts[&quot;in-system_taxi&quot;];
    bb.$updateBBManifestText(
        missID,
        &quot;Deliver &quot; + taxi.$currentOffer[5] + &quot; from &quot; + taxi.$currentOffer[1].displayName + &quot; to &quot; + taxi.$currentOffer[2].displayName + &quot; in &quot; + Math.floor((taxi.$currentOffer[3] - clock.seconds) / 60) + &quot; minutes.&quot;
    );
    // status text doesn&#39;t need expiry time, as it&#39;s shown elsewhere on the BB item
    bb.$updateBBStatusText(
        missID,
        &quot;Deliver &quot; + taxi.$currentOffer[5] + &quot; from &quot; + taxi.$currentOffer[1].displayName + &quot; to &quot; + taxi.$currentOffer[2].displayName + &quot;.&quot;
    );
}

//-------------------------------------------------------------------------------------------------------------
this.$miningManifest = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var itm = bb.$getItem(missID);
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    var desc = &quot;Dispatch &quot; + contract.amount + &quot;t &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; for &quot; + contract.company + &quot; in &quot; + bb.$getTimeRemaining(itm.expiry) + &quot;.&quot;;
    var sts = (contract.gross - contract.amount) + &quot;t of &quot; + contract.gross + &quot;t &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; &quot; + ((contract.gross - contract.amount) === 1 ? &quot;has&quot; : &quot;have&quot;) + &quot; been dispatched&quot;;
    bb.$updateBBManifestText(missID, desc);
    bb.$updateBBStatusText(missID, sts)
}

//-------------------------------------------------------------------------------------------------------------
this.$getActiveContractsByType = function (type) {
    var list = [];
    var bb = worldScripts.BulletinBoardSystem;

    // find the contract in the BB to remove it
    for (var i = 0; i &lt; bb._data.length; i++) {
        if (bb._data[i].accepted === true &amp;&amp; bb._data[i].worldScript === this.name &amp;&amp; bb._data[i].data === type) {
            list.push(bb._data[i]);
        }
    }
    return list;
}

//-------------------------------------------------------------------------------------------------------------
// availability functions
//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the cargo contract can be accepted by the player
this.$cargoContractAvailable = function (missID) {
    var idx = parseInt(missID) - 31000;
    var cc = worldScripts[&quot;oolite-contracts-cargo&quot;];
    if (!cc._hasSpaceFor(cc.$contracts[idx])) return &quot;insufficient cargo space&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the passenger contract can be accepted by the player
this.$passengerContractAvailable = function (missID) {
    var idx = parseInt(missID) - 32000;
    var pc = worldScripts[&quot;oolite-contracts-passengers&quot;];
    // temp variable to simplify code
    var passenger = pc.$passengers[idx];
    if (passenger) {
        var playerrep = worldScripts[&quot;oolite-contracts-helpers&quot;]._playerSkill(player.passengerReputationPrecise);
        // if the player has a spare cabin
        if (player.ship.passengerCapacity &lt;= player.ship.passengerCount) {
            return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable&quot;).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
        } else if (playerrep &lt; passenger.skill) {
            var utype = &quot;both&quot;;
            if (player.passengerReputationPrecise * 10 &gt;= passenger.skill) {
                utype = &quot;kills&quot;;
            } else if (Math.sqrt(player.score) &gt;= passenger.skill) {
                utype = &quot;rep&quot;;
            }
            return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable-&quot; + utype).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
        }
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the parcel contract can be accepted by the player
this.$parcelContractAvailable = function (missID) {
    var idx = parseInt(missID) - 33000;
    var bc = worldScripts[&quot;oolite-contracts-parcels&quot;];
    // temp variable to simplify code
    var parcel = bc.$parcels[idx];
    var playerrep = worldScripts[&quot;oolite-contracts-helpers&quot;]._playerSkill(player.parcelReputationPrecise);
    if (parcel.skill &gt; playerrep) {
        var utype = &quot;both&quot;;
        if (player.parcelReputationPrecise * 10 &gt;= parcel.skill) {
            utype = &quot;kills&quot;;
        } else if (Math.sqrt(player.score) &gt;= parcel.skill) {
            utype = &quot;rep&quot;;
        }
        return expandMissionText(&quot;oolite-contracts-parcels-command-unavailable-&quot; + utype).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the smuggling contract can be accepted by the player
this.$smugglingContractAvailable = function (missID) {
    var idx = parseInt(missID) - 34000;
    var sc = worldScripts.Smugglers_Contracts;
    if (!sc.$hasSpaceFor(sc._contracts[idx])) return &quot;insufficient cargo space&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the escort contract can be accepted by the player
this.$escortContractAvailable = function (missID) {
    if (worldScripts[&quot;Escort_Contracts&quot;].ec_currentcontract) {
        // basically, once a contract is accepted, all other contracts become unavailable
        return &quot;unable to access multiple escort contracts&quot;;
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the rrs mission can be accepted by the player
this.$rrsContractAvailable = function (missID) {
    if (worldScripts[&quot;Rescue Stations&quot;].missionActive()) {
        return &quot;unable to access multiple RRS missions&quot;;
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$rhContractAvailable = function (missID) {
    if (missionVariables.random_hits_status === &quot;RUNNING&quot;) return &quot;unable to access multiple contracts&quot;;
    var idx = parseInt(missID) - 37000;
    var lvl = Math.floor(idx / 3) + 1;
    if ((lvl === 1 &amp;&amp; player.score &lt; 32) || (lvl === 2 &amp;&amp; player.score &lt; 128) || (lvl === 3 &amp;&amp; player.score &lt; 512))
        return &quot;insufficient combat experience&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$taxiContractAvailable = function (missID) {
    var taxi = worldScripts[&quot;in-system_taxi&quot;];
    var idx = missID - 38000;
    if (player.ship.passengerCapacity &lt;= player.ship.passengerCount) {
        return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable&quot;).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
    }
    if (taxi.$currentOffer &amp;&amp; worldScripts[&quot;in-system_taxi&quot;].$currentOffer[0] &gt;= 2) {
        return &quot;unable to access multiple taxi contracts&quot;;
    }
    var rightStartingPoint = false;
    if (taxi.$stationOffers[idx][1].isPlanet) { //is it a planetary starting point?
        if (worldScripts.PlanetFall.lastPlanet == taxi.$stationOffers[idx][1] &amp;&amp; (player.ship.dockedStation.hasRole(&quot;planetFall_surface&quot;)))
            rightStartingPoint = true;
    } else if (player.ship.dockedStation == taxi.$stationOffers[idx][1])
        rightStartingPoint = true;
    if (rightStartingPoint === false) return &quot;incorrect starting point&quot;;

    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the taxi contract can be accepted by the player
this.$taxiGalacticaContractAvailable = function (missID) {
    if (missionVariables.taxistatus == &quot;ON_THE_JOB&quot;) {
        return &quot;unable to access multiple Taxi Galactica contracts&quot;;
    }
    if (player.ship.passengerCapacity &lt;= player.ship.passengerCount) {
        return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable&quot;).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// the various contract scripts regularly do checks to validate contracts, making sure they are still acceptable.
// any found to be out of date are removed. 
this.$validateContracts = function () {
    worldScripts[&quot;oolite-contracts-cargo&quot;]._validateContracts();
    worldScripts[&quot;oolite-contracts-passengers&quot;]._validateContracts();
    worldScripts[&quot;oolite-contracts-parcels&quot;]._validateContracts();
    if (this._smuggling) worldScripts.Smugglers_Contracts.$validateSmugglingContracts();
    // taxi contracts recycle regularly, so we need to refresh the data each time we open the BB
    if (this._convertTaxiContracts) {
        var taxi = worldScripts[&quot;in-system_taxi&quot;];
        //var itm = worldScripts.BulletinBoardSystem.$getItem(38000);
        taxi.$clearOldOffers();
        // redo the conversion
        this.$convertContracts(&quot;taxi&quot;);
    }
    if (this._convertMiningContracts) {
        worldScripts.miningcontracts.MC_generateContracts();
        this.$convertContracts(&quot;mining&quot;);
    }
}

//-------------------------------------------------------------------------------------------------------------
// we&#39;re overriding the base function &quot;validateContracts&quot; as any change to the index could spell disaster for mission links
this.$bbovr_cargo_validateContracts = function () {
    var c = this.$contracts.length - 1;
    var removed = false;
    // iterate downwards so we can safely remove as we go
    for (var i = c; i &gt;= 0; i--) {
        // if the time remaining is less than 1/3 of the estimated
        // delivery time, even in the best case it&#39;s probably not
        // going to get there.
        if (this.$helper._timeRemainingSeconds(this.$contracts[i]) &lt; this.$helper._timeEstimateSeconds(this.$contracts[i]) / 3) {
            worldScripts.ContractsOnBB.$reindexContracts(31000, i, true);
            // remove it
            this.$contracts.splice(i, 1);
            removed = true;
        }
    }
    /*if (removed) {
        // update the interface description if we removed any
        this._updateMainStationInterfacesList();
    }*/
}

//-------------------------------------------------------------------------------------------------------------
this.$bbovr_passengers_validateContracts = function () {
    var c = this.$passengers.length - 1;
    var removed = false;
    // iterate downwards so we can safely remove as we go
    for (var i = c; i &gt;= 0; i--) {
        // if the time remaining is less than 1/3 of the estimated
        // delivery time, even in the best case it&#39;s probably not
        // going to get there.
        if (this.$helper._timeRemainingSeconds(this.$passengers[i]) &lt; this.$helper._timeEstimateSeconds(this.$passengers[i]) / 3) {
            worldScripts.ContractsOnBB.$reindexContracts(32000, i, true);
            // remove it
            this.$passengers.splice(i, 1);
            removed = true;
        }
    }
    /*if (removed) {
        // update the interface description if we removed any
        this._updateMainStationInterfacesList();
    }*/
}

//-------------------------------------------------------------------------------------------------------------
this.$bbovr_parcels_validateContracts = function () {
    var c = this.$parcels.length - 1;
    var removed = false;
    // iterate downwards so we can safely remove as we go
    for (var i = c; i &gt;= 0; i--) {
        // if the time remaining is less than 1/3 of the estimated
        // delivery time, even in the best case it&#39;s probably not
        // going to get there.
        if (this.$helper._timeRemainingSeconds(this.$parcels[i]) &lt; this.$helper._timeEstimateSeconds(this.$parcels[i]) / 3) {
            worldScripts.ContractsOnBB.$reindexContracts(33000, i, true);
            // remove it
            this.$parcels.splice(i, 1);
            removed = true;
        }
    }
    /*if (removed) {
        // update the interface description if we removed any
        this._updateMainStationInterfacesList();
    }*/
}

//-------------------------------------------------------------------------------------------------------------
// counts the number of BB contracts at a particular base ref
this.$countContracts = function (baseRef) {
    var done = false;
    var chk = baseRef;
    var count = 0;
    var bb = worldScripts.BulletinBoardSystem;
    do {
        if (bb.$getItem(chk) == null &amp;&amp; bb.$getItem(chk + 1) == null) {
            done = true;
        } else {
            count += 1;
            chk += 1;
        }
    } while (done === false);
    return count;
}

//-------------------------------------------------------------------------------------------------------------
// reindexes contracts (type based on baseref), from a particular point in the array
this.$reindexContracts = function (baseRef, point, bbRemove) {
    var bb = worldScripts.BulletinBoardSystem;
    var idx = baseRef + point;
    if (bbRemove == true || bbRemove == null) bb.$removeBBMission(idx);
    var chk = idx + 1;
    var done = false;
    do {
        var item = bb.$getItem(chk);
        if (item != null) {
            // reindex the bb item
            item.ID = chk - 1;
            chk += 1;
        } else {
            done = true;
        }
    } while (done === false);
}

//-------------------------------------------------------------------------------------------------------------
// smuggling contracts specific functions
//-------------------------------------------------------------------------------------------------------------
// removes a smuggling contract from the BB
this.$removeSmugglingContract = function (idx) {
    // find and remove the contract from the BB
    var bb = worldScripts.BulletinBoardSystem;
    var sc = worldScripts.Smugglers_Contracts;
    for (var i = 0; i &lt; bb._data.length; i++) {
        var itm = bb._data[i];
        if (itm != null &amp;&amp; itm.accepted === true) {
            // is this item the one we&#39;re dealing with?
            if (itm.destination === sc._smugglingContracts[idx].destination &amp;&amp; itm.payment === sc._smugglingContracts[idx].fee &amp;&amp; itm.source === sc._smugglingContracts[idx].start) {
                bb.$removeBBMission(itm.ID);
                break;
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// clean up any orphaned smuggling contracts
this.$checkSmugglingContracts = function () {
    var bb = worldScripts.BulletinBoardSystem;
    var sc = worldScripts.Smugglers_Contracts;
    if (!sc) return;
    for (var i = bb._data.length - 1; i &gt;= 0; i--) {
        var itm = bb._data[i];
        // is this a smuggling contract
        if (itm.stationKey === &quot;blackMarket&quot; &amp;&amp; itm.availableCallback === &quot;$smugglingContractAvailable&quot;) {
            var found = false;
            // see if this contract is still active
            for (var j = 0; j &lt; sc._smugglingContracts.length; j++) {
                // is this item the one we&#39;re dealing with?
                if (itm.destination === sc._smugglingContracts[j].destination &amp;&amp; itm.payment === sc._smugglingContracts[j].fee &amp;&amp; itm.source === sc._smugglingContracts[j].start) {
                    found = true;
                    break;
                }
            }
            // if it doesn&#39;t exist we need to remove the BB item as well
            if (found === false) {
                bb.$removeBBMission(itm.ID);
                //bb._data.splice(i, 1);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// called by smugglers contracts, to ensure the contracts have been restored before we try to convert them
this.$convertSmugglingContracts = function () {
    var count = 0;
    // smuggling contracts
    if (worldScripts.Smugglers_Contracts) {
        this._smuggling = true;
        count = worldScripts.Smugglers_Contracts._contracts.length;
        if (count &gt; 0) {
            // see if there are any unaccepted missions @ ID 34000
            var itm = worldScripts.BulletinBoardSystem.$getItem(34000);
            // if there isn&#39;t, run the conversion process
            if (itm == null || this.$countContracts(34000) != count) this.$convertContracts(&quot;smuggling&quot;);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// Escort Contracts specific functions
//-------------------------------------------------------------------------------------------------------------
this.$checkEscortContacts = function () {
    var bb = worldScripts.BulletinBoardSystem;
    var ec = worldScripts.Escort_Contracts;
    if (!ec) return;
    for (var i = bb._data.length - 1; i &gt;= 0; i--) {
        var itm = bb._data[i];
        if (itm.accepted === false &amp;&amp; itm.data &amp;&amp; itm.data === &quot;escort&quot;) {
            // is this item still active?
            if (!ec.ec_targetsystems) {
                //log(this.bame, &quot;no ec data - removing bb item id &quot; + itm.ID);
                bb.$removeBBMission(itm.ID);
            } else {
                var found = false;
                for (var j = 0; j &lt; ec.ec_targetsystems.length - 1; j++) {
                    if (ec.ec_targetsystems[j] === itm.destination &amp;&amp; itm.payment === ec.ec_contractactualprices[j]) found = true;
                }
                if (found === false) {
                    //log(this.bame, &quot;no ec data match - removing bb item id &quot; + itm.ID);
                    bb.$removeBBMission(itm.ID);
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// Rescue Station specific functions
//-------------------------------------------------------------------------------------------------------------
this.$rrsExtractMissionTitle = function (ref) {
    var text = expandMissionText(&quot;rescue_scenario_&quot; + ref + &quot;_synopsis&quot;);
    var title = text.substring(0, text.indexOf(&quot;\n&quot;));
    return title;
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsExtractMissionDetails = function (ref) {
    var text = expandMissionText(&quot;cobb_rescue_scenario_&quot; + ref + &quot;_mission_available&quot;);
    if (!text &amp;&amp; ref.length &gt; 1) text = expandMissionText(&quot;cobb_rescue_scenario_&quot; + ref.substring(0, 1) + &quot;_mission_available&quot;);
    if (!text) text = &quot;&lt;&lt;Error: mission details for scenario &quot; + ref + &quot; not found&gt;&gt;&quot;;
    return text;
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsStoreCurrentVariables = function () {
    var sc = &quot;Rescue Scenario &quot; + missionVariables.rescuestation_scenario;
    var list = this._rrsMissionVariables[sc];
    this._rrsMissionCurrent = {};
    for (var i = 0; i &lt; list.length; i++) {
        this._rrsMissionCurrent[list[i]] = missionVariables[list[i]];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsReturnCurrentVariables = function () {
    var sc = &quot;Rescue Scenario &quot; + missionVariables.rescuestation_scenario;
    var list = this._rrsMissionVariables[sc];
    this._rrsMissionCurrent = {};
    for (var i = 0; i &lt; list.length; i++) {
        missionVariables[list[i]] = this._rrsMissionCurrent[list[i]];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsReloadMissionVariables = function (scen, idx) {
    var list = this._rrsMissionVariables[scen];
    for (var i = 0; i &lt; list.length; i++) {
        missionVariables[list[i]] = this._rrsMissionStorage[idx][list[i]];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsSaveMissionVariables = function (scen, idx) {
    var list = this._rrsMissionVariables[scen];
    this._rrsMissionStorage[idx] = {};
    for (var i = 0; i &lt; list.length; i++) {
        // look for any expansion items in the mission variable content
        if (typeof missionVariables[list[i]] === &quot;string&quot; &amp;&amp; missionVariables[list[i]].indexOf(&quot;[&quot;) &gt;= 0) {
            missionVariables[list[i]] = expandDescription(missionVariables[list[i]]);
        }
        this._rrsMissionStorage[idx][list[i]] = missionVariables[list[i]];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsResetMissionVariables = function (scen) {
    var list = this._rrsMissionVariables[scen];
    for (var i = 0; i &lt; list.length; i++) {
        delete missionVariables[list[i]];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsGetShipRoleForScenario = function (scen) {
    var role = this._rrsMissionShipRole[scen];
    if (role === &quot;shipModel&quot;) role = missionVariables.rescuestation_shiprole;
    return role;
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsGetKeyForShipRole = function (shiprole) {
    var key = &quot;&quot;;
    if (shiprole === &quot;asteroidModel&quot;) {
        key = this._rrsAsteroidKeyList[Math.floor(Math.random() * this._rrsAsteroidKeyList.length)];
    } else {
        var dataKeys = Ship.keysForRole(shiprole);
        var index = Math.floor(Math.random() * dataKeys.length);
        key = dataKeys[index];
    }
    return key;
}

//-------------------------------------------------------------------------------------------------------------
// replacement for the standard RRS mission success routine. Allows us to hook in.
this.$cobb_missionSuccess = function () {
    worldScripts.ContractsOnBB.$rrsCompleteMission();
    var sckey = missionVariables.rescuestation_scenario;
    if (!this.missionlog[sckey + &quot;_complete&quot;]) {
        this.missionlog[sckey + &quot;_complete&quot;] = 1;
    } else {
        this.missionlog[sckey + &quot;_complete&quot;]++;
    }
    this.syncMissionLog();
    worldScripts[&quot;Rescue Scenario &quot; + missionVariables.rescuestation_scenario].missionSuccess();
    this.cleanupMission();
    this.fillMissionBoard();
}

//-------------------------------------------------------------------------------------------------------------
// replacement for the standard RRS mission failue routine. Allows us to hook in.
this.$cobb_failMission = function () {
    worldScripts.ContractsOnBB.$rrsCompleteMission();
    var sckey = missionVariables.rescuestation_scenario;
    if (!this.missionlog[sckey + &quot;_failed&quot;]) {
        this.missionlog[sckey + &quot;_failed&quot;] = 1;
    } else {
        this.missionlog[sckey + &quot;_failed&quot;]++;
    }
    this.syncMissionLog();
    worldScripts[&quot;Rescue Scenario &quot; + missionVariables.rescuestation_scenario].failMission();
    this.cleanupMission(); // all for now
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsCompleteMission = function () {
    // find the contract in the BB to remove it. There should only be one accepted mission
    var bb = worldScripts.BulletinBoardSystem;
    var rrsList = this.$getActiveContractsByType(&quot;rescue&quot;);
    if (rrsList.length &gt; 0) {
        var found = false;
        bb.$removeBBMission(rrsList[0].ID);
        /*for (var i = 0; i &lt; bb._data.length; i++) {
            if (bb._data[i].data === &quot;rescue&quot; &amp;&amp; bb._data[i].accepted === true) {
                found = true;
                bb._data.splice(i, 1);
                break;
            }
        }*/
        //if (found === true) 
        bb.$initInterface(player.ship.dockedStation);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rrsGetAsteroidKeyList = function () {
    // these asteroid models don&#39;t work on a mission screen, so exclude them
    var exclude = [&quot;Casteroid1&quot;, &quot;Casteroid2&quot;, &quot;Casteroid3&quot;, &quot;Casteroid4&quot;, &quot;Casteroid5&quot;, &quot;Casteroid6&quot;, &quot;Casteroid7&quot;,
        &quot;Casteroid8&quot;, &quot;Casteroid9&quot;, &quot;Casteroid10&quot;, &quot;Casteroid11&quot;, &quot;Casteroid12&quot;
    ];
    var keys = Ship.keysForRole(&quot;asteroid&quot;);
    this._rrsAsteroidKeyList.length = 0;
    for (var i = 0; i &lt; keys.length; i++) {
        // and exclude any of the yah billboards as well
        if (keys[i].indexOf(&quot;billboard&quot;) === -1 &amp;&amp; exclude.indexOf(keys[i]) === -1) this._rrsAsteroidKeyList.push(keys[i]);
    }
}

//-------------------------------------------------------------------------------------------------------------
// Random Hits specific functions
//-------------------------------------------------------------------------------------------------------------
this.$rhReplaceMissionVariables = function (text) {
    if (text == null) return &quot;&quot;;
    for (var i = 0; i &lt; this._rhMissionVariables.length; i++) {
        if (text.indexOf(this._rhMissionVariables[i]) &gt;= 0) {
            do {
                text = text.replace(&quot;mission_&quot; + this._rhMissionVariables[i], missionVariables[this._rhMissionVariables[i]]);
            } while (text.indexOf(this._rhMissionVariables[i]) &gt;= 0);
        }
    }
    return text;
}

//-------------------------------------------------------------------------------------------------------------
this.$rhExtractMissionDetails = function (text) {
    var point1 = text.indexOf(&quot;\n\n&quot;) + 2;
    var point2 = text.indexOf(&quot;REPLIES TO&quot;);
    return text.substring(point1, point2);
}

//-------------------------------------------------------------------------------------------------------------
this.$rhExtractMissionTitle = function (text) {
    return text.substring(0, text.length - 1);
}

//-------------------------------------------------------------------------------------------------------------
this.$rhDifficultyText = function (diff) {
    var text = &quot;&quot;;
    switch (diff) {
        case 1:
            text = expandDescription(&quot;This is [random_hits_makeoffer3_start_levelone] [mission_random_hits_assassination_board_job_name]. [assassination_board_easykill]&quot;);
            break;
        case 2:
            text = expandDescription(&quot;This is [random_hits_makeoffer3_start_leveltwo] [mission_random_hits_assassination_board_job_name]. [assassination_board_mediumkill]&quot;);
            break;
        case 3:
            text = expandDescription(&quot;This is [random_hits_makeoffer3_start_levelthree] [mission_random_hits_assassination_board_job_name]. [assassination_board_hardkill]&quot;);
            break;
    }
    return text;
}

//-------------------------------------------------------------------------------------------------------------
this.$rhBarBill = function () {
    if (this._convertRHContracts &amp;&amp; player.ship.dockedStation.name === &quot;A Seedy Space Bar&quot; &amp;&amp; player.credits &gt; 0) {
        var rh = worldScripts[&quot;Random_Hits&quot;];
        if (rh.random_hits_billdue &gt; player.credits) rh.random_hits_billdue = player.credits;
        rh.showScreen = &quot;barBill&quot;;
        rh.missionOffers();
        rh.showScreen = &quot;&quot;;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$rhBarBillPostLaunch = function (station) {
    if (this._convertRHContracts &amp;&amp; station.name === &quot;A Seedy Space Bar&quot; &amp;&amp; player.credits &gt; 0) {
        var rh = worldScripts[&quot;Random_Hits&quot;];
        if (rh.random_hits_billdue &gt; player.credits) rh.random_hits_billdue = player.credits;
        var text = expandMissionText(&quot;cobb_random_hits_barbill_postlaunch&quot;, {
            barbill: formatCredits(parseFloat(rh.random_hits_billdue), true, true)
        });
        player.credits -= rh.random_hits_billdue;
        station.commsMessage(text, player.ship);
    }

}

//-------------------------------------------------------------------------------------------------------------
// mining contract specific functions
//-------------------------------------------------------------------------------------------------------------
this.$partMiningContract_process = function (missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var itm = bb.$getItem(missID);
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    var amount = Math.min(contract.amount, manifest[contract.cargo]);
    player.consoleMessage(amount + &quot;t of &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; dispatched&quot;);
    contract.amount -= amount;
    manifest[contract.cargo] -= amount;
    mc.MC_subscr = Math.max(mc.MC_subscr, 900 * Math.floor(clock.seconds / 900)) + amount * 900;
    this.$convertContracts(&quot;mining&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$partMiningContract_condition = function (missID) {
    var idx = missID - 39000;
    var mc = worldScripts.miningcontracts;
    var contract = mc.MC_contracts[idx];
    var amount = manifest[contract.cargo];
    if (contract.signed === 2) return &quot;Contract terminated&quot;;
    if (contract.amount === 0) return &quot;Contract can be completed&quot;;
    if (amount === 0) return &quot;No &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot; in cargo hold&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$miningContract_wait = function () {
    var mc = worldScripts.miningcontracts;
    if (player.credits &lt; mc.MC_waitPrice) {
        player.consoleMessage(&quot;Insufficient credits&quot;);
        return;
    }
    player.consoleMessage(formatCredits(mc.MC_waitPrice, true, true) + &quot; deducted&quot;);
    player.credits -= mc.MC_waitPrice;
    mc.MC_waitForContract();
    this.$convertContracts(&quot;mining&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$miningContract_repayDebt = function () {
    var mc = worldScripts.miningcontracts;
    if (mc.MC_debt &gt; player.credits) {
        player.consoleMessage(&quot;Insufficient credits&quot;);
    } else {
        player.consoleMessage(formatCredits(mc.MC_debt, true, true) + &quot; deducted&quot;);
        player.credits -= mc.MC_debt;
        mc.MC_debt = 0;
        worldScripts.BulletinBoardSystem.$removeMainMenuItem(this.name, &quot;$miningContract_repayDebt&quot;);
    }
    mc.MC_generateContracts();
    this.$convertContracts(&quot;mining&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$miningContractOpen = function (missID) {
    if (this._convertMiningContracts) {
        if (missID &gt;= 39000) {
            var bb = worldScripts.BulletinBoardSystem;
            var itm = bb.$getItem(missID);
            var idx = missID - 39000;
            var mc = worldScripts.miningcontracts;
            var contract = mc.MC_contracts[idx];
            if (manifest[contract.cargo] &gt; 0 &amp;&amp; contract.amount &gt; 0) {
                itm.customMenuItems[0].text = &quot;Dispatch current cargo load (&quot; + Math.min(contract.amount, manifest[contract.cargo]) + &quot;t  &quot; + displayNameForCommodity(contract.cargo).toLowerCase() + &quot;)&quot;;
            } else {
                itm.customMenuItems[0].text = &quot;Dispatch current cargo load&quot;;
            }

            // keep these details up to date whenever a mining contract is opened
            var med = &quot;Mining Association of &quot; + mc.MC_system;
            var reward = contract.reward - contract.amount * contract.penalty;
            var repayment = Math.min(reward, mc.MC_debt);
            reward -= repayment;
            var balance = contract.reward - contract.amount * contract.penalty;
            itm.postStatusMessages[0].text = expandDescription(&quot;[contract-mining-completed]&quot;, {
                mediator: med,
                amount: formatCredits(reward, true, true)
            });

            if (balance &lt; 0) {
                itm.postStatusMessages[1].text = expandDescription(&quot;[contract-mining-terminated-1]&quot;, {
                    mediator: med,
                    amount: formatCredits(-balance, true, true)
                });
            } else {
                itm.postStatusMessages[1].text = expandDescription(&quot;[contract-mining-terminated-2]&quot;, {
                        mediator: med,
                        amount: formatCredits(balance, true, true)
                    }) +
                    ((mc.MC_debt - repayment) &gt; 0 ? expandDescription(&quot;[contract-mining-debt]&quot;, {
                        mediator: med,
                        amount: formatCredits(Math.min(reward, (mc.MC_debt - repayment)), true, true)
                    }) : &quot;&quot;);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$miningContractListOpen = function () {
    if (this._convertMiningContracts) {
        if (Ship.roleIsInCategory(player.ship.dockedStation.primaryRole, &quot;oolite-rockhermits&quot;) === true) {
            var bb = worldScripts.BulletinBoardSystem;
            var mc = worldScripts.miningcontracts;
            if (mc.MC_debt &gt; 0) {
                bb.$removeMainMenuItem(this.name, &quot;$miningContract_repayDebt&quot;);
                bb.$addMainMenuItem({
                    text: &quot;Repay debt (&quot; + formatCredits(mc.MC_debt, true, true) + &quot;)&quot;,
                    worldScript: this.name,
                    menuCallback: &quot;$miningContract_repayDebt&quot;
                });
            } else {
                bb.$removeMainMenuItem(this.name, &quot;$miningContract_repayDebt&quot;);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$checkForHermit = function (station) {
    // turn on the always visible flag at hermits
    if (Ship.roleIsInCategory(station.primaryRole, &quot;oolite-rockhermits&quot;) === true) {
        var bb = worldScripts.BulletinBoardSystem;
        var mc = worldScripts.miningcontracts;
        bb._alwaysShowBB = true;
        bb.$removeMainMenuItem(this.name, &quot;$miningContract_wait&quot;);
        bb.$addMainMenuItem({
            text: &quot;Wait for new mining contracts (&quot; + formatCredits(mc.MC_waitPrice, true, true) + &quot;)&quot;,
            worldScript: this.name,
            menuCallback: &quot;$miningContract_wait&quot;
        });
    }
}

//-------------------------------------------------------------------------------------------------------------
// small adjustment to the shipExitedWitchspace routine, to eliminate some unneccessary functions
this.$mc_shipExitedWitchspace = function () {
    this.MC_countAsteroids();
    var number = this.MC_contracts.length;
    var total = this.MC_debt;

    for (var i = 0; i &lt; number; i++) {
        var contract = this.MC_contracts[i];
        if (contract.signed) total += contract.amount * contract.penalty - contract.reward;
    }

    this.MC_contracts.length = 0;
    this.MC_debt = 0;
    this.MC_clock = 0;

    if (total &gt; 0) {
        player.ship.setBounty(player.bounty + 50, &quot;contract obligations&quot;);
        var targets = system.shipsWithPrimaryRole(&quot;buoy-witchpoint&quot;);
        if (targets.length &gt; 0) {
            targets[0].commsMessage(&quot;The Mining Association of &quot; + this.MC_system + &quot; has put a bounty of &quot; + formatCredits(50, true, true) + &quot; on your head.&quot;, player.ship);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// taxi galactica specific functions
//-------------------------------------------------------------------------------------------------------------
this.$tg_choiceEvaluation = function (choice) {
    // Mission text screen choices are below:
    // Welcome screen choices:
    if (missionVariables.taxistat === &quot;REVISIT_1&quot;) {
        if (choice === &quot;1BOARD&quot;) {
            worldScripts.BulletinBoardSystem.$showBB();
            return;
        } else if (choice === &quot;2EXPLORE&quot;) {
            // Return to the manifest screen:
            missionVariables.taxistat = &quot;EXPLORE&quot;;
        }
    }
    // Special Mission #1 screen choices:
    if (missionVariables.taxistat === &quot;SPEC_MIS_01_1&quot;) {
        if (choice === &quot;1ACCEPT&quot;) {
            this.$tg_acceptSpecialMission();
        }
    }
    return;
}

//-------------------------------------------------------------------------------------------------------------
this.$tg_acceptSpecialMission = function () {
    // Store special mission #1 details into variables and add passenger to ship &amp; manifest:
    missionVariables.taxi_passenger = missionVariables.taxi_specmis_1_ambassador;
    missionVariables.taxi_dest = missionVariables.taxi_specmis1_dest;
    missionVariables.taxi_dest_name = missionVariables.taxi_specmis1_dest_name;
    missionVariables.taxi_diff = 3;
    missionVariables.taxi_pay = 10000;
    missionVariables.taxi_time = missionVariables.taxi_specmis1_time;
    missionVariables.taxistatus = &quot;ON_THE_JOB&quot;;
    var name = missionVariables.taxi_passenger;
    var curloc = system.ID;
    var dest = missionVariables.taxi_dest;
    var time = missionVariables.taxi_time;
    var pay = missionVariables.taxi_pay;
    player.ship.addPassenger(name, curloc, dest, clock.seconds + time * 24 * 3600, pay);
    missionVariables.taxistat = &quot;ACCEPTED&quot;;

    // add this mission to the bulletin board
    var bb = worldScripts.BulletinBoardSystem;
    bb.$addBBMission({
        source: system.ID,
        destination: missionVariables.taxi_specmis1_dest,
        stationKey: &quot;mainStation&quot;,
        description: expandDescription(&quot;[taxi-galactica-passenger-title]&quot;),
        details: expandDescription(&quot;[taxi-galactica-passenger-description]&quot;, {
            client: missionVariables.taxi_specmis_1_ambassador,
            destination: System.systemNameForID(missionVariables.taxi_specmis1_dest)
        }),
        payment: 10000,
        accepted: true,
        allowTerminate: false,
        completionType: &quot;IMMEDIATE&quot;,
        stopTimeAtComplete: true,
        allowPartialComplete: false,
        expiry: (clock.seconds + missionVariables.taxi_specmis1_time * 24 * 3600),
        disablePercentDisplay: true,
        noEmails: true,
        markerShape: &quot;NONE&quot;, // marker control will be handled by contracts system
        overlay: {
            name: &quot;cobb_taxi.png&quot;,
            height: 546
        },
        customDisplayItems: cust,
        initiateCallback: &quot;$tg_acceptContract&quot;,
        availableCallback: &quot;$taxiGalacticaContractAvailable&quot;,
        worldScript: this.name,
    });

}

//-------------------------------------------------------------------------------------------------------------
this.$clearMissionSet = function $clearMissionSet(curr, range) {
    var bb = worldScripts.BulletinBoardSystem;
    var chk = 0;
    var found = 0;
    do {
        if (bb.$getIndex(range + chk) &gt;= 0) {
            bb.$removeBBMission(range + chk);
            found += 1;
        }
        // failsafe in case we don&#39;t find one
        if (chk &gt;= (range + 100)) found = curr + 1;
        chk += 1;
    } while (found &lt; curr);
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
