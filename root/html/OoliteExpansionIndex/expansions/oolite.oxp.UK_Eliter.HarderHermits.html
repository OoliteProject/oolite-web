<html>
    <head>
        <title>Expansion Harder Hermits</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Harder Hermits</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">1 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>License not specified</li>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER D)(&#39;[]&#39; vs &#39;[dockables mechanics hard hermit]&#39;)</li>
                <li>Optional Expansions mismatch between OXP Manifest and Expansion Manager at character position 0064 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
                <li>Unknown key &#39;upload_date&#39; at https://wiki.alioth.net/img_auth.php/5/54/Oolite.oxp.UK_Eliter.HarderHermits.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>This expansion packs (further) toughens up some rock hermits.</td>
                    <td>This expansion packs (further) toughens up some rock hermits.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.UK_Eliter.HarderHermits</td>
                    <td>oolite.oxp.UK_Eliter.HarderHermits</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Harder Hermits</td>
                    <td>Harder Hermits</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>UK_Eliter</td>
                    <td>UK_Eliter</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.22</td>
                    <td>1.22</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>dockables mechanics hard hermit</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.spara.spicy_hermits:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.spara.spicy_hermits:</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://www.aegidian.org/bb/viewtopic.php?f=4&amp;t=20802">http://www.aegidian.org/bb/viewtopic.php?f=4&amp;t=20802</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/5/54/Oolite.oxp.UK_Eliter.HarderHermits.oxz">https://wiki.alioth.net/img_auth.php/5/54/Oolite.oxp.UK_Eliter.HarderHermits.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/img_auth.php/5/54/Oolite.oxp.UK_Eliter.HarderHermits.oxz">http://wiki.alioth.net/img_auth.php/5/54/Oolite.oxp.UK_Eliter.HarderHermits.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1646067191</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Harder%20Hermits'>http://wiki.alioth.net/index.php/Harder%20Hermits</a></p>
        <h3>Readme &amp; License.txt</h3>
        <pre>
    __  __               __             __  __                    _ __
   / / / /___ __________/ /__  _____   / / / /__  _________ ___  (_) /______
  / /_/ / __ `/ ___/ __  / _ \/ ___/  / /_/ / _ \/ ___/ __ `__ \/ / __/ ___/
 / __  / /_/ / /  / /_/ /  __/ /     / __  /  __/ /  / / / / / / / /_(__  )
/_/ /_/\__,_/_/   \__,_/\___/_/     /_/ /_/\___/_/  /_/ /_/ /_/_/\__/____/


An expansion pack for Oolite

by &#39;UK_Eliter&#39;



------------
REQUIREMENTS
------------

� This expansion pack requires Oolite version *1.82* or above.

-------
PURPOSE
-------

This expansion packs toughens up some rock hermits - or, toughens them *further* if some other pack already makes them harder.


---------------------------------
RECOMMENDED OTHER EXPANSION PACKS
---------------------------------

� This expansion pack is compatible with, and is best used with, &#39;Spicy Hermits&#39; by Spara.

� Also, to add more types of defence ships for the hermits, install, in addition to HarderHermits, these OXPs of mine:
	- Super Sidewinder
	- Fer-de-Lance 3G


-------
LICENSE
-------

This expansion pack is released under the Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/2.0/ or send a letter to Creative Commons, 559 Nathan Abbott Way, Stanford, California 94305, USA. 

You are free:

� to copy, distribute, display, and perform the work;
� to make derivative works. 

But only under the following conditions.

� Attribution: you must give the original author credit. 
� Non-commercial use: you may not use this work for commercial purposes. 
� Share Alike: if you alter, transform, or build upon this work, you may distribute the resulting work only under a license materially identical to this one. 

Your fair use right and other rights are in no way affected by the above.


----------------
ACKNOWLEDGEMENTS
----------------

My thanks to the following:

	- spara (who wrote &#39;Spicy Hermits&#39;, which is much more ambitious than this my OXP);
	- dybal (for encouragement and suggestions).


------------------------------
NOTE FOR EXPANSION PACK MAKERS
------------------------------

This expansion pack works mainly in the following way. It uses the this.shipExitedWitchspace handler. When Oolite sends my code a message that that handler has fired, my code seeks entities with rock-hermit roles and then (sometimes) does things to (some of) them.


----------------- END OF FILE ----------------- 
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/harderHermits_resurrected.html">Abandoned Rock Hermit</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/harderHermits.js</td>
                    <td><pre>/*
========================================================================
harderHermits.js
This file is part of the Harder Hermits expansion pack.
Author: UK_Eliter
License: 2017 Creative Commons: attribution, non-commercial, sharealike.
========================================================================
*/



/*
===================
JSHINT: set options
===================
*/

/*jshint esversion: 6*/
/*jshint sub:true*/

// Needs oolite &gt;=1.82 (or, er, higher?)

/*
 */

this.name = &quot;harderHermits&quot;; // should be &#39;harderHermits.js&#39;?
this.author = &quot;UK_Eliter&quot;;
this.copyright = &quot;See the license field&quot;;
this.description = &quot;harderHermits.js&quot;;
this.license = &quot;2014 CC-by-nc-sa 3.0&quot;;


/*
==================
DEBUGGING SWITCHES
==================
*/

// this.logging = true;

//	Do NOT comment-out any of the following three assignments. Rather, to disable any one of them, set it to false.
var consoleDebugMessages = false;

this.debug = false;

this.debug_testResurrection = false;
//	Requires this.debug to be true, but does not *make* that variable true,


/*
========================
JSLINT: start of wrapper
========================
*/

(function() {

	&quot;use strict&quot;;


	/*
	=======
	GLOBALS
	=======
	*/

	this.name = &quot;harderHermits&quot;;

	this.abandoned_chanceAct = 0.15;
	//	0.15

	this.installed_spicyHermits = false;
	//	Gets changed to true if the OXP is installed.
	this.installed_hermitage = false;
	//	Gets changed to true if the OXP is installed.
	this.installed_pirateCove = false;
	//	Gets changed to true if the OXP is installed.


	/*
	=========
	DEBUGGING
	=========
	*/

	this.$msg_dbg = function(debugTxt) {
		if (!debugTxt) {
			player.consoleMessage(&quot;Problem with debug message text!&quot;, 30);
			return;
		}
		player.consoleMessage(this.name + &quot; - &quot; + debugTxt, 12);
		log(this.name + &quot; - DEBUG&quot;, debugTxt);
	};

	this.$msg_info = function(msgTxt) {
		// if( !msgTxt ) { player.consoleMessage( &quot;Problem with info message text!&quot;, 30 ); return; }
		log(this.name + &quot; - INFO&quot;, msgTxt);
	};


	/*
	================
	SOUNDS
	================
	*/

	this.mySound_hullBang = new SoundSource();
	this.mySound_hullBang.sound = &quot;hullbang.ogg&quot;;
	// this sound built-in to Oolite - and does not need to be declared in the &#39;customsounds&#39; file.


	/*
	================
	ENTITY PICKER(S)
	================

	The following roles are from Oolite itself:

		rockhermit
		rockhermit-chaotic
		rock-hermit-pirate

	The following role is from SpicyHermits:

		spicy_hermits_abandoned
	*/

	this.$isCove = function(e) {
		return e.isShip &amp;&amp; e.AI === &quot;pirateCoveAI.plist&quot;;
		// Seemingly there is no more efficient way of doing the above.
	};

	this.$isAbandonedHermit = function(e) {
		return e.isShip &amp;&amp; (e.primaryRole === &quot;asteroid&quot; &amp;&amp; e.name === &quot;Abandoned Rock Hermit&quot;);
	};

	this.$isHermit = function(e) {
		return e.isShip &amp;&amp;
			(e.primaryRole === &quot;rockhermit&quot; || e.primaryRole === &quot;rockhermit-chaotic&quot; || e.primaryRole === &quot;rockhermit-pirate&quot;);
	};

	this.$isHermitButNotHermitage = function(e) {
		return e.isShip &amp;&amp;
			(e.primaryRole === &quot;rockhermit&quot; || e.primaryRole === &quot;rockhermit-chaotic&quot; || e.primaryRole === &quot;rockhermit-pirate&quot;) &amp;&amp;
			!e.hasRole(&quot;hermitage&quot;);
	};


	/*
	======
	TIMERS
	======
	*/

	this.$timer_delete_hermitAction_warn = function() {
		if (!this.timer_hermitAction_warn) {
			return;
		}
		if (this.timer_hermitAction_warn.isRunning) {
			this.timer_hermitAction_warn.stop();
		}
		delete this.timer_hermitAction_warn;
	};

	this.$timer_delete_hermitAction_warnThenExplode = function() {
		if (!this.timer_hermitAction_warnThenExplode) {
			return;
		}
		if (this.timer_hermitAction_warnThenExplode.isRunning) {
			this.timer_hermitAction_warnThenExplode.stop();
		}
		delete this.timer_hermitAction_warnThenExplode;
	};

	this.$timer_delete_hermitAction_explode = function() {
		if (!this.timer_hermitAction_explode) {
			return;
		}
		if (this.timer_hermitAction_explode.isRunning) {
			this.timer_hermitAction_explode.stop();
		}
		delete this.timer_hermitAction_explode;
	};

	this.$timer_delete_hermitAction_resurrect = function() {
		if (!this.timer_hermitAction_resurrect) {
			return;
		}
		if (this.timer_hermitAction_resurrect.isRunning) {
			this.timer_hermitAction_resurrect.stop();
		}
		delete this.timer_hermitAction_resurrect;
	};

	this.$timer_delete_die = function() {
		if (!this.timer_die) {
			return;
		}
		if (this.timer_die.isRunning) {
			this.timer_die.stop();
		}
		delete this.timer_die;
	};

	this.$timer_delete_treatHermits_coves = function() {
		if (!this.timer_treatHermits_coves) {
			return;
		}
		if (this.timer_treatHermits_coves.isRunning) {
			this.timer_treatHermits_coves.stop();
		}
		delete this.timer_treatHermits_coves;
	};

	this.$timer_delete_all = function() {
		this.$timer_delete_die();
		this.$timer_delete_treatHermits_coves();
		this.$timer_delete_hermitAction_resurrect();
		this.$timer_delete_hermitAction_warn();
		this.$timer_delete_hermitAction_warnThenExplode();
		this.$timer_delete_hermitAction_explode();
		if (this.abandonedHermit) {
			delete this.abandonedHermit;
		}
	};


	/*
	===============
	TIMED FUNCTIONS
	===============
	*/

	this.$treatHermits_coves = function() {
		var s = system.filteredEntities(this, this.$isCove);

		if (this.debug) {
			// DEBUGGING version
			if (s.length === 0) {
				this.$msg_dbg(&quot;Seeking coves: none found.&quot;);
				return;
			}
			this.$msg_dbg(&quot;Seeking coves: at least one found ..&quot;);
			this.$treatHermits_core(s);
			return;
		}

		// NON-DEBUGGING VERSION
		if (s.length === 0) {
			return;
		}
		this.$treatHermits_core(s);
	};

	this.$die_timed = function $die_timed() {
		// The above format, with its repetition of the function name, is right. See http://aegidian.org/bb/viewtopic.php?p=257147#p257147.
		this.$timer_delete_die();
		// Do not automatically delete it, because it might not be running; other things can call this.
		if (!player.ship) {
			return;
		}
		// Next two lines are to avoid auto-eject shenanigans, etc.
		if (player.ship.equipmentStatus(&quot;EQ_AUTO_EJECT&quot;) === &quot;EQUIPMENT_OK&quot;) {
			player.ship.removeEquipment(&quot;EQ_AUTO_EJECT&quot;);
		}
		if (player.ship.equipmentStatus(&quot;EQ_EEU&quot;) === &quot;EQUIPMENT_OK&quot;) {
			player.ship.removeEquipment(&quot;EQ_EEU&quot;);
		}
		player.ship.explode();
	};

	this.$timed_hermitAction_message_warn = function(e) {
		if (!e || !e.isValid) {
			return;
		}
		e.commsMessage(&quot;WARNING: This station will explode. Clear the area.&quot;);
		e.broadcastCascadeImminent();
	};

	this.$timed_hermitAction_warn = function() {
		if (this.debug) {
			this.$msg_dbg(&quot;timed_hermitAction_warn.&quot;);
		}
		this.$timer_delete_hermitAction_warn();
		if (!this.abandonedHermit) {
			return;
		}
		if (!this.abandonedHermit.isValid) {
			delete this.abandonedHermit;
			return;
		}
		var e = this.abandonedHermit;
		this.$timed_hermitAction_message_warn(e);
	};

	this.$timed_hermitAction_warnThenExplode = function() {
		if (this.debug) {
			this.$msg_dbg(&quot;timed_hermitAction_warnThenExplode.&quot;);
		}
		this.$timer_delete_hermitAction_warnThenExplode();
		if (!this.abandonedHermit) {
			return;
		}
		if (!this.abandonedHermit.isValid) {
			delete this.abandonedHermit;
			return;
		}
		this.$timed_hermitAction_message_warn(this.abandonedHermit);
		var seconds = ~~((Math.random() * 60) + 0.5); // * 60
		this.timer_hermitAction_explode = new Timer(this, this.$timed_hermitAction_explode, seconds);
	};

	this.$timed_hermitAction_explode = function() {
		if (this.debug) {
			this.$msg_dbg(&quot;timed_hermitAction_explode.&quot;);
		}
		this.$timer_delete_hermitAction_explode();
		if (!this.abandonedHermit) {
			return;
		}
		if (!this.abandonedHermit.isValid) {
			delete this.abandonedHermit;
			return;
		}
		this.abandonedHermit.explode();
		// NB SpicyHermits occasionally adds a q-mine death action!
		delete this.abandonedHermit;
	};

	this.$timed_hermitAction_resurrect = function() {
		if (this.debug) {
			this.$msg_dbg(&quot;timed_hermitAction_resurrect.&quot;);
		}
		this.$timer_delete_hermitAction_resurrect();
		if (!this.abandonedHermit) {
			return;
		}
		if (!this.abandonedHermit.isValid) {
			delete this.abandonedHermit;
			return;
		}

		// We have to *replace* the hermit (otherwise it cannot be a station).
		// If the hermit is close enough to the player to notice the change, abort.
		if (!player.ship || !player.ship.position) {
			delete this.abandonedHermit;
			return;
		}
		var ps = player.ship; // for speed, but changes won&#39;t affect the original variable
		if (this.abandonedHermit.position.distanceTo(ps.position) &lt; 50000) {
			if (this.debug) {
				this.$msg_dbg(&quot;Hermit too close to player for resurrection.&quot;);
			}
			delete this.abandonedHermit;
			return;
		}

		// Get data for the replacement.
		var orientation = this.abandonedHermit.orientation;
		var position = this.abandonedHermit.position;

		if (this.abandonedHermit) {
			this.abandonedHermit.remove(true);
			delete this.abandonedHermit;
		}

		// Do the replacement.
		// Note that Spicy Hermits overrides Oolite&#39;s rockhermit shipdata, so what we&#39;ll get here is &#39;spicy&#39; stuff.

		var replacement;
		replacement = system.addShips(&quot;harderHermits_resurrected&quot;, 1, position);

		// this.replacement = this.abandonedHermit.spawnOne( &quot;harderHermits_resurrected&quot; );

		if (replacement[0] &amp;&amp; replacement[0].isValid) {
			if (this.debug) {
				this.$msg_dbg(&quot;Created replacement.&quot;);
			}
			// this.replacement.orientation = this.abandonedHermit.orientation; 
			// this.replacement.position = this.abandonedHermit.position;
			replacement[0].orientation = orientation;
			replacement[0].lightsActive = false;
			replacement[0].desiredRange = 13000; // Tested?
			if (this.debug) {
				replacement[0].displayName = &quot;Abandoned rock hermit (RESURRECTED)&quot;;
			}
			// Energy
			var r = Math.random();
			replacement[0].maxEnergy *= (r + 1.5);
		} else if (this.debug) {
			this.$msg_dbg(&quot;Replacement failed to exist.&quot;);
		}
	};


	/*
	==============
	EVENT HANDLERS
	==============
	*/

	this.startUp = function() {
		if (this.debug) {
			this.$msg_dbg(&quot;DEBUGGING is ON.&quot;);
			if (this.debug_testResurrection) {
				this.$msg_dbg(&quot;Testing resurrection.&quot;);
			}
		}

		if (worldScripts[&quot;Hermitage_Main&quot;]) {
			// Hermitage_Main is the name the script itself declares.
			// Yet, that script&#39;s *filename* is hermitage_main.js.
			this.installed_spicyHermits = true;
			this.$msg_info(&quot;Detected hermitage OXP&quot;);
		}
		if (worldScripts[&quot;spicy_hermits_abandoned&quot;]) {
			this.installed_spicyHermits = true;
			this.$msg_info(&quot;Detected SpicyHermits OXP&quot;);
		}
		if (worldScripts[&quot;Pirate_Coves&quot;]) {
			this.installed_pirateCove = true;
			this.$msg_info(&quot;Detected pirateCove OXP.&quot;);
		}
	};

	this.shipDockedWithStation = function(station) {
		if (!player.ship.docked || player.ship.dockedStation.name !== &quot;Abandoned Rock Hermit&quot;) {
			return;
		}

		// Unmodified abandoned hermits from SpicyHermits do not allow the player to dock (at all), so this routine won&#39;t fire for that.
		this.showScreen = &quot;rejectPage&quot;;
		mission.runScreen({
				title: &quot;Abandoned Rock Hermit (well, not really abandoned)&quot;,
				color: &quot;redColor&quot;,
				message: &quot;You have docked at a disguised pirate cove.\n\nNine out of ten for style, but minus several thousand for good thinking.&quot;,
				model: &quot;rockhermit&quot;,
				choicesKey: &quot;harderHermits_docked&quot;
			},
			function(choice) {
				if (choice === &quot;1_RETURN&quot;) {
					var r = Math.random();
					// r = 0.1; // TESTING
					if (r &lt; 0.2) {
						player.commsMessage(&quot;The pirates attack your launching ship!&quot;);
						player.ship.launch();
						if (!this.timer_die) {
							this.timer_die = new Timer(this, this.$die_timed, 1.7);
						}
						this.mySound_hullBang.play();
					} else if (r &lt; 0.8) {
						var d = 40 + ~~((Math.random() * 500) + 1);
						player.commsMessage(&quot;The pirates attack your launching ship!&quot;);
						player.ship.launch();
						player.ship.energy = player.ship.energy - d;
						if (player.ship.energy &lt; 0) {
							if (!this.timer_die) {
								this.timer_die = new Timer(this, this.$die_timed, 1.7);
							}
						} else {
							this.mySound_hullBang.play();
						}
					}
					station.reactToAIMessage(&quot;ATTACKED&quot;);
				}
			}
		);
	};

	this.playerWillEnterWitchspace = function() {
		this.$timer_delete_all();
	};

	this.shipExitedWitchspace = function() {
		if (system.isInterstellarSpace) {
			return;
		}
		if (this.debug) {
			this.$msg_dbg(&quot;shipExitedWitchspace&quot;);
		}

		this.$treatHermits_normalAndSpicy();

		if (this.installed_spicyHermits) {
			this.$treatHermits_spicy_abandoned();
		}

		if (this.installed_pirateCove) {
			// PirateCoves adds hermits upon shipExitedWitchspace
			this.timer_$treatHermits_coves = new Timer(this, this.$treatHermits_coves, 1);
			if (this.debug) {
				this.$msg_dbg(&quot;Set timer to seek coves.&quot;);
			}
		}
	};


	/*
	=======================
	OTHER
	=======================
	*/

	this.$treatHermits_core = function(s) {
		var i;
		var debugStr;
		var energyToAdd;

		/*
		Adjust energy of all hermits detected. Those hermits comprise:
		- all hermits added by the core game;
		- hermits added by the SpicyHermits OXP (er, I think);
		- hermits added by the PirateCove OXP (which get added on Witchspace exit and so are detected within this function only when it is run on a timer.

		SpicyHermits gives pirate rock-hermits a maxEnergy of 2500.
		SpicyHermits leaves the maxEnergy of other types alone, i.e. at Oolite default, which is 1,000.
		(SpicyHermits saves the position of its hermits but anything else - including their maxEnergy - about them.
		We will not try to save that, either.)
		*/

		i = s.length;
		if (this.debug) {
			// * Debugging version *
			debugStr = &quot;Hermits: iterating through &lt;&quot; + i + &quot;&gt; found ..&quot;;
			this.$msg_dbg(debugStr);
			while (i--) {
				if (!s[i] || !s[i].isValid) {
					continue;
				}
				debugStr = &quot;.. Rock hermit &lt;&quot; + s[i].displayName + &quot;&gt; HAD energy &quot; + s[i].maxEnergy;
				this.$msg_dbg(debugStr);
				if (s[i].maxEnergy === 1000) {
					energyToAdd = Math.ceil(Math.random() * 1499);
				} else if (s[i].maxEnergy === 2500) {
					energyToAdd = Math.ceil(Math.random() * 180);
				}
				s[i].maxEnergy += energyToAdd;
				debugStr = &quot;.. Rock hermit &lt;&quot; + s[i].displayName + &quot;&gt;: added &lt;&quot; + energyToAdd + &quot;&gt;; NOW HAS energy &quot; + s[i].maxEnergy;
				this.$msg_dbg(debugStr);
			}
		} else {
			// * NON-debugging version *
			while (i--) {
				if (!s[i] || !s[i].isValid) {
					continue;
				}
				if (s[i].maxEnergy === 1000) {
					energyToAdd = Math.ceil(Math.random() * 1499);
				} else if (s[i].maxEnergy === 2500) {
					energyToAdd = Math.ceil(Math.random() * 180);
				}
				s[i].maxEnergy += energyToAdd;
			}
		}
	};

	this.$treatHermits_spicy_abandoned = function() {
		if (!this.debug &amp;&amp; !this.debug_testResurrection) {
			if (Math.random() &gt; this.abandoned_chanceAct) {
				if (this.debug) {
					this.$msg_dbg(&quot;Abandoned hermits: decided to ignore.&quot;);
				}
				return;
			}
		}

		var action, debugStr, i, r, s, seconds;

		if (this.debug) {
			// DEBUGGING version
			this.$msg_dbg(&quot;Abandoned hermits: seeking ..&quot;);
			s = system.filteredEntities(this, this.$isAbandonedHermit);
			if (s.length &lt; 1) {
				this.$msg_dbg(&quot;.. found no abandoned hermits.&quot;);
				return;
			}
			this.$msg_dbg(&quot;.. found at least one abandoned hermit.&quot;);
			// Pick one of them.
			i = ~~(Math.random() * s.length);
			// Check there is nothing fundamentally wrong with it.
			if (!(s[i] &amp;&amp; s[i].isValid)) {
				this.$msg_dbg(&quot;Invalid abandoned hermit selected.&quot;);
				return;
			}
			this.abandonedHermit = s[i];
			if (this.debug_testResurrection) {
				action = &quot;resurrect&quot;;
				seconds = 5;
				this.timer_hermitAction_resurrect = new Timer(this, this.$timed_hermitAction_resurrect, seconds);
			} else {
				seconds = ~~((Math.random() * 10800) + 1) + 5; // * 10800 + 5
				r = Math.random();
				if (r &lt; 0.7) {
					action = &quot;warn-then-explode&quot;;
					this.timer_hermitAction_warnThenExplode = new Timer(this, this.$timed_hermitAction_warnThenExplode, seconds);
				} else if (r &lt; 0.75) {
					action = &quot;warn&quot;;
					this.timer_warn = new Timer(this, this.$timed_hermitAction_warn, seconds);
				} else if (r &lt; 0.8) {
					action = &quot;explode&quot;;
					this.timer_hermitAction_explode = new Timer(this, this.$timed_hermitAction_explode, seconds);
				} else {
					action = &quot;resurrect&quot;;
					this.timer_hermitAction_resurrect = new Timer(this, this.$timed_hermitAction_resurrect, seconds);
				}
			}
			s[i].displayName = &quot;Abandoned Rock Hermit (TWEAKED)&quot;;
			debugStr = &quot;.. Primed abandoned hermit &lt;&quot; + this.abandonedHermit.displayName + &quot;&gt; to &lt;&quot; + action + &quot;&gt; in &quot; + seconds + &quot; seconds time.&quot;;
			this.$msg_dbg(debugStr);
		} else {
			// NON-DEBUGGING version
			s = system.filteredEntities(this, this.$isAbandonedHermit);
			if (s.length &lt; 1) {
				return;
			}
			i = ~~(Math.random() * s.length);
			if (!(s[i] &amp;&amp; s[i].isValid)) {
				return;
			}
			this.abandonedHermit = s[i];
			seconds = ~~((Math.random() * 10800) + 1) + 5; // * 10800 + 5
			r = Math.random();
			if (r &lt; 0.7) {
				this.timer_hermitAction_warnThenExplode = new Timer(this, this.$timed_hermitAction_warnThenExplode, seconds);
			} else if (r &lt; 0.75) {
				this.timer_warn = new Timer(this, this.$timed_hermitAction_warn, seconds);
			} else if (r &lt; 0.8) {
				this.timer_hermitAction_explode = new Timer(this, this.$timed_hermitAction_explode, seconds);
			} else {
				this.timer_hermitAction_resurrect = new Timer(this, this.$timed_hermitAction_resurrect, seconds);
			}
		}
	};

	this.$treatHermits_normalAndSpicy = function() {
		var s;
		if (this.installed_hermitage) {
			s = system.filteredEntities(this, this.$isHermitButNotHermitage);
		} else {
			s = system.filteredEntities(this, this.$isHermit);
		}

		if (this.debug) {
			// DEBUGGING version
			if (s.length === 0) {
				this.$msg_dbg(&quot;Seeking normal and spicy hermits: none found.&quot;);
				return;
			}
			this.$msg_dbg(&quot;Seeking normal and spicy hermits ..&quot;);
			this.$treatHermits_core(s);
			return;
		}

		// NON-DEBUGGING VERSION
		if (s.length &gt; 0) {
			this.$treatHermits_core(s);
		}
	};

	/*
	=======================
	JSHINT: end of wrapper
	=======================
	*/

}).call(this);


// EOF</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
