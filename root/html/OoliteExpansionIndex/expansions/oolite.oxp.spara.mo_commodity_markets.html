<html>
    <head>
        <title>Expansion Commodity Markets</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Commodity Markets</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Required Expansions mismatch between OXP Manifest and Expansion Manager at character position 0066 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Divides the Market Observer&#39;s market screen&#39;s price column to sell price and buy price. Buy price is always a little higher than sell price. This adds a little bit of difficulty and realism to the game.</td>
                    <td>Divides the Market Observer&#39;s market screen&#39;s price column to sell price and buy price. Buy price is always a little higher than sell price. This adds a little bit of difficulty and realism to the game.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.spara.mo_commodity_markets</td>
                    <td>oolite.oxp.spara.mo_commodity_markets</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Commodity Markets</td>
                    <td>Commodity Markets</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>spara</td>
                    <td>spara</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.2.3</td>
                    <td>1.2.3</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.spara.market_observer:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.spara.market_observer:</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/MarketObserver">http://wiki.alioth.net/index.php/MarketObserver</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/8/8a/Mo_commodity_markets_1.2.3.oxz">https://wiki.alioth.net/img_auth.php/8/8a/Mo_commodity_markets_1.2.3.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873355</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Commodity%20Markets'>http://wiki.alioth.net/index.php/Commodity%20Markets</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>this.name           = &quot;mo-commodity_markets&quot;;
this.author         = &quot;spara&quot;;
this.copyright      = &quot;2013-2014 Mika Sp√•ra&quot;;
this.description    = &quot;Different prices for buying and selling in every station.&quot;;
this.version        = &quot;1.2.3&quot;;
this.licence    	= &quot;CC BY-NC-SA 3.0&quot;;

this.startUp = function() {
	
	//Market Observer is needed for showing buy prices in market.
	if (!worldScripts[&quot;market_observer&quot;]) {
		for (prop in this.name) {
			if (prop !== &#39;name&#39; &amp;&amp; prop !== &#39;version&#39;) delete worldScripts[this.name][prop];
		}
		log(this.name, &quot;Install marketObserver for mO-Commodity Markets to work. Exiting&quot;);
		player.consoleMessage(&quot;Install marketObserver for mO-Commodity Markets to work. Exiting.&quot;, 10);
	}
	
	this.$commodities = [&quot;food&quot;,&quot;textiles&quot;,&quot;radioactives&quot;,&quot;slaves&quot;,&quot;liquor_wines&quot;,&quot;luxuries&quot;,&quot;narcotics&quot;,&quot;computers&quot;,&quot;machinery&quot;,&quot;alloys&quot;,&quot;firearms&quot;,&quot;furs&quot;,&quot;minerals&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;,&quot;alien_items&quot;];
	this.$fixedPrices = false;//flag for prices&#39; status
	
	//restore pricefactors
	if (missionVariables.commodityMarketsPriceFactors) {
		this.$priceFactor = JSON.parse(missionVariables.commodityMarketsPriceFactors);
	} 
	else {
		//init individual pricefactors
		this.$priceFactor = [];
		var i;
		for (i = 0; i &lt; 17; i++) {
			this.$priceFactor.push(1.02 + 0.03 * Math.random());
		}
	}
	this.$createPrices();//init arrays
}

//set prices and start timer for fluctuating prices
this.shipDockedWithStation = function(station) {
	this.$renewPriceFactors();
	this.$createPrices();
}

this.shipWillLaunchFromStation = function(station) {
	//restore prices to averages when launching
	if (this.$fixedPrices) this.$restorePrices();
}

this.guiScreenChanged = function(to, from) {
	if (!player.ship.docked) return;	
	//fix prices when switching to market screen
	if (guiScreen === &quot;GUI_SCREEN_MARKET&quot; &amp;&amp; !this.$fixedPrices) {
		for (i = 0; i &lt; 17; i++) 
			player.ship.dockedStation.setMarketPrice(this.$commodities[i], this.$sellPrices[i]);
		this.$fixedPrices = true;
		//make a list of scripts to notify about buying and selling
		this.$collectNotifyScripts();
		return;
	}
	//restore median prices when leaving market screen
	if (guiScreen !== &quot;GUI_SCREEN_MARKET&quot; &amp;&amp; this.$fixedPrices) {
		this.$restorePrices();
	}	
}

//restore original prices
this.$restorePrices = function(){
	for (i = 0; i &lt; 17; i++) 
		player.ship.dockedStation.setMarketPrice(this.$commodities[i], this.$originalPrices[i]);
	this.$fixedPrices = false;
}

//create arrays for original, buy and sell prices
this.$createPrices = function() {
	var i, newPrice, commodity;
	this.$buyPrices = [];
	this.$sellPrices = [];
	this.$originalPrices = [];
	for (i = 0; i &lt; 17; i ++) {
		commodity = this.$commodities[i];
		var priceFactor = this.$priceFactor[i];
		this.$originalPrices.push(player.ship.dockedStation.market[commodity].price);
		//buy prices
		newPrice = priceFactor * this.$originalPrices[i];
		if (newPrice &gt; 1020) newPrice = 1020;
		this.$buyPrices.push(newPrice);
		//sell prices
		newPrice = this.$originalPrices[i] / priceFactor;
		this.$sellPrices.push(newPrice);
	}
}

//5% change for individual commodity prices to fluctuate
this.$renewPriceFactors = function() {
	for (i = 0; i &lt; 17; i ++) {
		if (Math.random() &lt; 0.05)
			this.$priceFactor[i] = 1.02 + 0.03 * Math.random();		
	}
}

//handle buying
this.$playerBoughtCargo = function(commodity, units, price) {
	//return, if original prices
	if (!this.$fixedPrices) return [units, price];
	//return, if price is correct to circumvent continuous looping
	var commIndex = this.$commodities.indexOf(commodity);
	if (price === this.$buyPrices[commIndex]) return [units, price];
	//reverse buying with sell prices
	player.ship.dockedStation.setMarketQuantity(commodity, (player.ship.dockedStation.market[commodity].quantity + units));
	player.credits += (units * price) / 10;
	player.ship.manifest[commodity] -= units;
	//notify other scripts about reversing
	//this.$notifySell(commodity, units, price);
	//buy again with correct prices
	var unitsBought = 0;
	while (unitsBought &lt; units &amp;&amp; player.credits &gt;= Math.round(this.$buyPrices[commIndex])/10) {
		player.ship.dockedStation.setMarketQuantity(commodity, (player.ship.dockedStation.market[commodity].quantity - 1));	
		player.credits -= this.$buyPrices[commIndex] / 10;
		player.ship.manifest[commodity] += 1;
		unitsBought++;
	}
	//notify other scripts about buying
	/*
	if (unitsBought &gt; 0) {
		this.$notifyBuy(commodity, unitsBought, this.$buyPrices[commIndex]);
	}
	*/
	return [unitsBought, this.$buyPrices[commIndex]];
}

//make a list of scripts to notify about buying and selling
this.$collectNotifyScripts = function() {
	this.$buyScripts = [];
	this.$sellScripts = [];
	for (i = 0; i &lt; worldScriptNames.length; i++) {
		scriptName = worldScriptNames[i];
		if (worldScripts[scriptName] &amp;&amp; scriptName !== &quot;market_observer&quot; &amp;&amp; worldScripts[scriptName].playerSoldCargo)
			this.$sellScripts.push(scriptName);
		if (worldScripts[scriptName] &amp;&amp; scriptName !== this.name &amp;&amp; scriptName !== &quot;market_observer&quot; &amp;&amp; worldScripts[scriptName].playerBoughtCargo)
			this.$buyScripts.push(scriptName);			
	}	
}

//notify other scripts about selling
this.$notifySell = function(commodity, units, price) {
	var i, scriptName;
	this.$notifyScripts = [];
	for (i = 0; i &lt; this.$sellScripts.length; i++) {
		scriptName = this.$sellScripts[i];
		if (worldScripts[scriptName].playerSoldCargo)
			worldScripts[scriptName].playerSoldCargo(commodity, units, price);
	}	
}

//notify other scripts about buying
this.$notifyBuy = function(commodity, units, price) {
	var i, scriptName;
	this.$notifyScripts = [];
	for (i = 0; i &lt; this.$buyScripts.length; i++) {
		scriptName = this.$buyScripts[i];
		if (worldScripts[scriptName].playerBoughtCargo) 
			worldScripts[scriptName].playerBoughtCargo(commodity, units, price);
	}	
}

//save pricefactors
this.playerWillSaveGame = function() {
	missionVariables.commodityMarketsPriceFactors = JSON.stringify(this.$priceFactor);
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
