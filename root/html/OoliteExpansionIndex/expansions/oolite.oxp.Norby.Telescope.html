<html>
    <head>
        <title>Expansion Telescope</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Telescope</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">1 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">8 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Extended targeting and scanning features, masslock borders and sniper ring.</td>
                    <td>Extended targeting and scanning features, masslock borders and sniper ring.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Telescope</td>
                    <td>oolite.oxp.Norby.Telescope</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Telescope</td>
                    <td>Telescope</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.15</td>
                    <td>1.15</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Norby.Telescope_Extender:1.0</li>
                            <li>oolite.oxp.Norby.CombatMFD:1.9</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Norby.Telescope_Extender:1.0</li>
                            <li>oolite.oxp.Norby.CombatMFD:1.9</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Telescope">http://wiki.alioth.net/index.php/Telescope</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/7/77/Telescope_1.15.oxz">https://wiki.alioth.net/img_auth.php/7/77/Telescope_1.15.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873341</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Telescope'>http://wiki.alioth.net/index.php/Telescope</a></p>
        <h3>Telescope readme.txt</h3>
        <pre>Telescope forum topic: http://bb.aegidian.org/viewtopic.php?f=4&amp;t=14961

Quick start as a Hunter

* Copy the .oxp folder to the AddOns directory, hold down the Shift when starting the game the first time after copying.
* Buy Telescope with Extender equipment or load the included savegame (&quot;Telescope demo.oolite-save&quot;). Injectors, ECM System, Fuel Scoop, Military Laser and Scanner Targeting Enhancement are used also in this guide.
* After undock (F1) you can see the magnified target in top center position.
* If you bought Gravity Scanner then stop near the station, turn off your weapons with underscore (_) and wait for the scan results.
* Turn your ship where you see lollipops at the edge of your IFF scanner. The Panorama targeting will countinually change the box to the most centered target.
* Choose your enemy for the strength of your ship: start with a small ship flying alone.
* Use Injectors (i) to fly into scanner range where you can see a Red ball which means visible ship with bounty. Do not hunt Yellow traders and Purple police ships if you want to remain in clean status.
* Use Ctrl+arrow keys to put the target into the middle of the crosshairs to turn on the sniper ring which magnify the difference from the correct line-up.
* Turn on your weapons (_) and fire (a). You can try to hit with Military laser over normal scanner range but within 30km and a stopped target will turn when successful, but if your target is too small then fly inside 25.6km where the red target box indicate the correct line-up.
* Press ident (r) to lock the most centered target if there are more, press again to start auto steering or to lock another if it&#39;s more centered than the current target.
* Telescope can be primed (Shift+N) then activated (n) to lock the nearest target, mode (b) change the function of the activate key.
* If a missile is coming then a cyan ball warns you: start ECM (e), target it (t), try to avoid (i) or shoot it (a).
* If you win and the pilot ejected then shot down the derelict ship to get the bounty, then fly after the small White balls and scoop the Escape Pod, metal fragments and cargo pods.
* Fly back to the station and dock to get the reward for the pilot and sell the cargo (F8). Congratulations, you are richer. :)


Telescope Equipment

This OXP realizes some requests for an extended scanner described in this topic:
http://bb.aegidian.org/viewtopic.php?f=6&amp;t=13274
Can determine the direction, distance, orientation and legal status of all visible ships.

The detection range is equal with the scanner range if you use it without the Telescope Extender (still or willfully), but you can use the following features:

Visual targeting

The virtual model of the target ship is displayed and a console message shows the name, range and direction.
The direction is marked by &lt;^ or v&gt; symbols to read faster than the Port Up or Down Starboard words.
The ranges and directions are calculated continually to help turn in line and see the decreasing range while traveling to the target.
The orientation of the model is equal with the target if you centered it and you can spin the model if turn around your ship.
You can set the size of the model with the $TelescopeVSize variable in the Scripts/telescope.js.

Lightballs

Far targets get coloured lightball markers in the view and lollipops with darker colours near the edge of the scanner.

Red: Hostile ship with bounty (pirates and thargoids),
Pink: Tharglet until active and Drones with bounty in HardShips OXP,
Yellow: Neutral ship with clean status (traders and co),
Purple: Police,
Cyan: Missile or Mine,
Green: Buoy or Station,
Blue: Derelict (Wormhole also from Oolite v1.79),
White: Cargo, Escape Pod or Sun,
Gray: last known position of a lost target (moved out of telescope range),
Lightgray: Planet or Moon (a bit darker than Planet),
Orange: Gravity Scanner detected ship too far to be visible,
Brown: Gravity Scanner detected ship under 130t mass (less dangerous, especially with ShipVersion OXP).
Black: lollipops in red alert over 30km to help focus on near targets.

Beacons are identified in the whole system due to the transmitted radio signals.
If a ship transmits a beaconcode then it&#39;s detected anywhere but coloured as a ship and turns to orange if too far to be visible.

The current target is also marked with a gray &quot;shadow&quot; lollipop at the edge of the IFF scanner to help determine the direction, especially at close range, to avoid zooming the scanner. 
If the target is closer than 1000m, the lightball will be removed as the ship almost covers the ball and cargo pods are large enough to detect with your eyes, but the shadow lollipop still remain.
You can set the minimum distance with the $TelescopeVMarkMinDist variable in the file Scripts/telescope.js.

Targets within the range of the Military Laser (30km) are marked with a larger ball and a normal (not darker) coloured lollipop.
You can use this feature to determine exactly where you can open fire on the target so it&#39;s large enough to stand a chance of being hit.

You can disable the lightballs of the ships by setting $TelescopeLightBalls to false, but non-ships with Blue, Cyan, Gray, Green and White colours will remain to help find these. Auto targeting functions can still lock far targets; there seems to be an empty box but the ships are in there.

You can restrict lightballs in Red Alert to 10-30km if you set $TelescopeRedAlertLimiter to true to save a few CPU cycles but it is worth it on slow computers only.

Sniper ring

If you have almost lined up with your target who is between 10 and 30km then a ring will appear.
The movement of this ring magnifies the variance to the correct line-up, to help fine tune your aim.
You can hit if the target box of the Scanner Targeting Enhancement switches to red.

Snipers can use the distances between 25.6 and 30km to fire before the enemy can see the attacker on its scanner.
This was possible without Telescope, but the size of the ball gives another aid to knowing when the target runs out of range; and the ring can guide your aim without red box, which only works in the normal scanner range.

If you think this is a cheat then fire only when the target can also see you (red box) or set the $TelescopeSniperRange variable to 25600 which will shorten the appearance of the ring and the largest ball (but there&#39;s no way to shorten the range of the Military Laser).

Auto steering

With the Telescope primed (Shift+N) the activate button (&quot;n&quot;) can steer to the nearest lightball-marked target, which is useful in picking up cargo from the near field, rather than zooming the scanner to find them. Now you can just press activate instead of hitting zoom, locate, turn and unzoom.

Auto-steering starts only if your ship flys in a line (not turning) and stops instantly if you touch the controls. It will stop steering before a perfect line-up so as not to aim for you.

In Red Alert the activate button steers to the nearest attacker. You can disable this by turning off the weapons, in which case you can lock and steer to any near target regardless of the alert condition.

Auto scanning

Telescope checks for new targets every second and performs an autoscan if it finds one: simple light sensors can see new dots in the whole sky without using energy but must zoom with the main scope to determine the ship type which needs 2 energy points.
The autoscan can be turned off if you set $TelescopeAutoScan false in the telescope.js file but it&#39;s usually worth the cost to get new information sooner.

Far target locking

You can lock far targets also which is not in the normal scanner (beacons and planets are always lockable). The distance is shown before the name of the ship with Scanner Targeting Enhancement, due to the fact that the second line shows the range of the virtual marker (which is always near the edge of the IFF Scanner).
We must use this workaround because the core game does not allow locking onto a target outside of normal scanner range. So the locked marker coinsides with the lock of the target (can only fix this in the core game).

If you cannot see a ship then it may have been destroyed, jumped out or flew farther than the visible range; or it has a Military Scanner Jammer and you do not have a Jammer Filter so you cannot get target lock.

When a target flys too far and is lost, the telescope renames it to &#39;Lost target&#39; until the next scan.

MFD with the nearest targets

The built-in MFD shows the 10 nearest targets, ships first then others.
A &quot;*&quot; mean &quot;red&quot; targets (pirates and thargoids).
Hostiles (who targeting you) are flagged with &quot;!&quot;.
Your current target is bracketed with [].
If [[CombatMFD|Combat MFD]] is installed then the newest detected target is displayed in the last line in Combat MFD.

Masslock borders

In green alert you will see circles around detected targets where these ships can block your Torus Drive.
Without a Telescope Extender, these are shown around planets and stations only, but if you buy one, it allows for detection of ships that you can see with your Mark-1 eyeball (escort ships at 2x, traders near 4x scanner range) and you will then get circles around all the ships before you.

Until you enter these circles you will stay in condition green, but cloaked ships can cause surprises.

The colour of a masslock border is the same as the lightball in the middle (see above).

To get the shortest route, you can safely go forward near the largest circle without touching it or going inside. Imagine this is the border of a sphere so if you fly direct to the center then you will be masslocked sooner than if you flew to a point of the circle. If you steer just a little outside the circle, you will fly forward as near as possible without masslock.

These are also a good indicator of the distance to the ships because the radius of the circles represent exactly one scanner range for the ship at its center.
Planets have rings that are double its radius as they can masslock you within this range.
The sun also has a large masslock field but this is not displayed by rings - it&#39;s less important and mainly a distraction.

You can also turn on masslock borders in non-green alerts if you turn off your weapons.
You can turn off all circles completely with the Telescope primed to the Lightballs menu (see below).

Keypress functions

The ident button (&quot;r&quot;) gets a new feature from Telescope: it can lock the most centered target even if it&#39;s not shown on the screen.
The next press will start auto steering to the target if the most centered target is the same, otherwise it will lock onto the new target; a third ident press will unlock it.
In Red Alert it will not narrow the locking to the attackers; it can lock any target.

Works only if there was a locked target beforehand, due to the triggering of the shipTargetLost event, so if there&#39;s no target it won&#39;t get called. Press &quot;r&quot; again or get something into the crosshair or use equipment buttons to lock a target. (Usually only an issue when leaving a station, exitting witchspace or Torus drive.)

If you turn off the weapons with the underscore button (&quot;_&quot;) then a scan happens and you enter into &quot;Navigation Mode&quot;, where autolock helps you see through targets (called Panorama targeting): continually relocks to the most centered target.
This button is choosed to avoid unwanted fire if you have turrets.
In Red Alert you can lock any target and see far targets if you turn this mode on.
The Ident button presses can turn Panorama targeting on and off when in Navigation Mode.

With the Telescope primed (Shift+N), the mode button (&quot;b&quot;) cycles through the functions of the activate (&quot;n&quot;) button:

 Nearest target
 Rescan
 Step forward in the target list
 Step back in the target list
 Lightballs: off / navigation only / ships / masslock borders / large
 Sniper ring km: off / 5-25.6 / 10-25.6 / 15-25.6 / 5-30 / 10-30 / 15-30
 Steering: off / nearest target only / both nearest and step in the list
 Targets: 20 and limitation in red alert / 50 / 100 / 200
 Visual target: off / weapons off / no ring / no station / no question mark / all
 Visual target size: 1-8

The first 4 functions are commands which happen instantly when activated.
The &quot;Step forward&quot; and &quot;Step back&quot; will rescan if you step over the end of the target list.
The Target list contains hostiles first, if any, then all ships in normal scanner (25.6km), followed by Cargo and Escape Pods, then ending with ships which are not in the normal scanner.

The last 6 functions are some of customizable properties in the telescope.js file, which you can change during flight.
Your settings are stored into missionVariables and saved when you save your game after docking.

[When the core game provides more equipment buttons, a back button could step back to the previous function (maybe Ctrl+&quot;b&quot;).
With a second equipment button (maybe Ctrl+&quot;n&quot;) settings could be separated from the commands.]

 Cost: 500.0 Cr.
 Techlevel: 5


Telescope Extender

You must install &quot;Telescope Extender and Gravity Scanner&quot; OXZ package and buy this equipment separatedly to confirm you want step over the rules of the standard game.
This will increase the detection range based on the size of the target so you can lock onto it when the core game sets it to isVisible and shows at least a dot in the sky.
For example you can see:
-Adder at 32 km,
-Viper and escort ships around 50 km (2x scanner range),
-Anaconda, Boa, Cobra MkIII and Python about 100 km (4x scanner range),
-Rock Hermit in almost 500 km (if not visible from the Main Station then fly around),
-Coriolis Station at 1000 km (right from the witchpoint).

 Cost: 500.0 Cr.
 Techlevel: 5


Gravity Scanner Equipment

You must install the separated &quot;Telescope Extender and Gravity Scanner&quot; OXZ package to use this and the following uber-ranged equipments.

If the mass of your ship more than 130t (Cobra MkIII and above) and there is a station within 5km, you can then extend the detection range of Telescope using a mass detector, which scales by third power of distance:
the mass of the target in kg must be larger than d2*d2*d2/100 where d2 = distance*2 in km.

Detection of the player ships and the Hard versions in HardShips OXP:
                 t    km   Hard t  km
Adder           11    52    23     66
Moray           40    79    81     100
Cobra Mk I      47    84    94     106
Fer-de-Lance    51    86    102    108
Asp             59    90    118    114
Cobra Mk III    186   132   371    167
Boa             192   134   385    169
Phyton          222   141   445    177
Anaconda        430   175   1289   253

Beacons are detected in the whole system and Rock Hermits usually as well (from 900km).

A station needs to be near as the largest parts of the gravity scanner system is fitted into the stations, which broadcast some important data and it needs a large mass (at least 10.000t, the station itself) nearby as a reference to refine the results.
Mobile bases can scan anywhere.

It takes 4 minutes from undock or hyperjump to reach the maximal detection range when your ship is on the move.
The detection progresses 4 times faster when your ship is stopped, needing only 60 seconds to finish.

The mass is scaled with the elapsed time: an Anaconda is detected at half time as its half mass (215t) would, which means 140km, and needs more time to detect it from the maximal 175km.

When the gravity detection is done and you remain at maximum speed until docking or jumping, the computer only needs to calculate in the new area coming into range from travel and not the whole sphere.

The Gravity scanner works only when you turn off your weapons with underscore (&quot;_&quot;) button, otherwise only visible targets are displayed.
You can define a more comfortable key in the Oolite/oolite.app/Resources/Config/keyconfig.plist file.

The auto-relock feature will continually change your target to the most centered one, so the box will jump during your turn; your ship helps browse the many targets. The ident (&quot;r&quot;) button can lock the same target only in this mode, it cannot step to the second centered target.

Gravity scan consume 8 energy points (visual scan uses only 2).
You can hear the sound of the Gravity Scanner at work, which is to remind you of the energy usage.

Orange and Brown lollipops and lightballs mark the detected targets out of the visible range.
Brown if the ship is under 130t mass which means small ships, usually escorts - avoid Orange ones and target single Browns while your ship is not very strong.
The mass usually cannot tell if a ship is pirate or not, coloured identification need visual contact.

If you see a lighter ball then there are two or more ship in the same place.
The smallest orange and brown ball means the target is farther than 150km, these get dark orange and dark brown lollipops.

The Gravity Scanner cannot determine the orientation. If the target is not visible then the view position of the virtual model will be a fixed view from the top.

There are no passive gravity sensors so AutoScan will happen only if a new target arrives into the visible range.
When you undock or arrive at a new system, the telescope scan is performed automatically but if you want to scan the final frontier then you must turn off your weapons.

Beware: aliens can sometimes detect the signal of a Gravity Scan, so if your ship is not strong then do not use it often and pay for the full repair if it&#39;s damaged.

 Cost: 10000.0 Cr.
 Techlevel: 5


Secondary Gravity Scanner Equipment

Cuts in half the time to get the full detection range and works as a single scanner if the primary one is damaged.
Can only fit into ships over 400t mass (Anaconda and heavy OXP ships).

 Cost: 20000.0 Cr.
 Techlevel: 5


Small Dish Equipment

Detect ships from one third farther out (for example an Asp at 120km) but can only fit onto ships over 130t mass (from Cobra MkIII) due to the size.

Needs Gravity Scanner, it is just a piece of metal.

Fast CPUs can draw 200 targets without relevant FPS drop, slow systems draw it also but with some drop (tested on Intel Atom netbook). In this case scan for Gravity targets only when needed and turn it off when Telescope range is reached.

This is not a primable equipment (there are no buttons on the pure alloy) and a passive extension so will not increase the energy usage of the scan.

 Cost: 5000.0 Cr.
 Techlevel: 5


Large Dish Equipment

Detect ships from double the range (an Asp at 180km) but can only fit onto ships over 400t mass (Anaconda and over) due to the size.

Small Dish will not increase this range further so you can refund it when you buy a Large Dish.

Ships over 1000t (Hard Anaconda and big OXP ships) can use the hull mass to refine the gravity signals to reach 4 times range than without Large Dish.

Will only show the nearest 200 targets to save CPU and avoid serious FPS drops in systems with many ships.

 Cost: 10000.0 Cr.
 Techlevel: 5



Cheap Repairs

You can buy small fixes for 1/10 the cost of the new equipment instead of the normal 1/2 price but the following drawbacks will be applied:

Telescope: get back the lightballs but will not fix the virtual model display, auto steering and sniper ring.
Gravity Scanner: the cheap spare parts can interfere with the hyperdrive and often cause misjumps.
Small and Large Dish: uses less durable alloys and can break during hyperjump.

After a cheap fix you can buy the full repair which costs the difference between cheap and normal repair: 2/5 of the full price.
You can only refund fully repaired equipment.


Dependencies:
Oolite v1.77 or later. No shaders needed.

Instructions:
Unzip the file, and then move the folder name ending in &quot;.oxp&quot; into the AddOns directory of your Oolite installation.
Savegame included: put the &quot;Telescope demo.oolite-save&quot; file into the oolite-saves directory to load it.


Settings in Scripts/telescope.js:

$TelescopeAutoScan = true; //check continually for new isVisible isPiloted target and scan if found
Scanning use a very little energy if a new target arrived but you strongly need this to avoid often scan manually.

$TelescopeAutoScanMaxRange = 1000000; //meters, how far targets will be reported

$TelescopeAutoLock = 1; //if no target and something in crosshairs with max. this degree diff., 1=lightball size, 0=off
AutoLock is set to 1 degree (size of a lightball) and lock only if no current target to make it similar with the original ident function plus can lock far targets also. Disabled if set to 0 but in this case you can lock targets in 25.6km only.

$TelescopeFarStatus = false; //red ball reveal pirates over normal scanner if true
If false then bounty detected within 25.6km only which is more real and exciting but Thargoids get red ball at any range and a red ship will not change back to yellow if fly over the normal scanner range.

$TelescopeGravLock = 20; //gravity scanner relock in this degree cone (0-180, 20=about the screen)
Panorama targeting offer auto-relock to the most centered target during manual turning and can be switched on or off in-game frist with the weapons and second with the ident button when you see gravity targets. Disabled if set it to 0 but it is not recommended due to in this case you can not lock far targets, so set it to 1 degree at least, or simply use the ident button in-game to reduce it to the level of the AutoLock and leave the possibility to turn it on again.

$TelescopeIdentLock = 180; //if ident pressed or target lost then lock in this degree (0-180, 180=the whole sphere)
Can lock the most centered target even if behind you if set it to 180 and the second press will unlock it so you can clear the virtual model when not needed. If set it to 1 then the locking radius reduced to the size of a lightball so can do unlock only. Note the AutoLock will relock in 0.25 second if the target centered exactly, in this case turn a bit before unlock.

Red alert is an exception where the IdentLock target hostiles only (who target you) to help find attackers. Can be override with AutoLock and GravLock, so if you unlock the current target and point exactly to another then the AutoLock will target it regardless of the hostile&#39;s status, or if you point it and turn weapons quickly off and on again then lock it regardless from you has lock on another target (but not too quickly, the timed function need max. 0.25 second to lock).

$TelescopeLargeLightBalls = false; //lightballs are increasing depending on the distance or remains small

$TelescopeLightBalls = true; //turn on or off all lightballs, but marks on the scanner will remain

$TelescopeMassLockBorders = true; //coloured circles around ships and planets in green alert

$TelescopeRedAlertDist = 30000; //show lollipops in red alert within this distance only

$TelescopeRedAlertLimiter = false; //a bit more FPS in dogfight if true but show all marks with weapons off only

$TelescopeRing = true; //show a ring around the visual target

$TelescopeShipLightBalls = true; //turn on or off the lightballs with scanner markers of the ships, but cargo, etc. remain
Non-ships with Blue, Cyan, Gray, Green and White colours will remain to help find these. Auto targeting functions still can lock far targets, the targeted ship are in an empty box.

$TelescopeShowVisualQuestionMark = false; //if a ship has no virtual model in effecdata.plist show a big &quot;?&quot; model

$TelescopeShowVisualStation = true; //show or not show the 3D model of the targeted station

$TelescopeShowVisualTarget = true; //show the 3D model of the target if weapons are on (except stations if VisualStation is false)

Set it to false if you want to use the weapon toggle button to show and hide virtual model also.

$TelescopeSniperMinRange = 10000; //meters, show sniper ring if the target is over this distance

$TelescopeSniperRange = 30000; //meters, if the target is inside then show sniper ring and large lightball
Set it to to 25600 if you want to shorten the appearance of the sniper ring in the name of the fair play.

$TelescopeSniperRingSize = 2; //size of the sniper ring (between 1 and 5, default: 2)

$TelescopeSteering = 2; //auto steering if lock nearest or step in the target list with activate, 1:nearest only

$TelescopeTargets = 200; //limitable to reduce FPS drop in systems with many ships, min. 10, max. 200

$TelescopeThargoids = false; //you will get aliens right after undock to test Telescope

$TelescopeVMarkMinDist = 1000; //meters, if target is inside then remove the lightball marker

$TelescopeVMarkShipMinDist = 5000; //meters, if target is ship and inside then remove the lightball marker

$TelescopeVPosHUD = [0, 0, 0]; //position shift for your HUD&#39;s built-in visual target screen if any

$TelescopeVSize = 4; //size of the visual target with online weapons (between 0 and 10, default: 4)

$TelescopeVZoomSize = 6; //zoomed size of the visual target with offline weapons (between 0 and 10, default: 6)

If size is 0 then the visual target is not shown at all.


Script_info support:

OXP makers can alter the detection of any objects in shipdata.plist to avoid revealing mission secrets.

Stations with non-standard roles and ships with the word &quot;stealth&quot; within their dataKey or role are detected in normal scanner range only. Must specify &quot;telescope&quot; script_info key to detect it farther to stay compatible with the existing OXPs, for example Rescue Stations.oxp, Stealth.oxp and Vector.oxp.

Standard Station roles: &quot;station&quot;, &quot;coriolis&quot;, &quot;dodo&quot;, &quot;dodec&quot;, &quot;dodecahedron&quot;, &quot;ico&quot;, &quot;icosa&quot;, &quot;icosahedron&quot; and &quot;rockhermit&quot;.

Hiding ships need &quot;stealth&quot; role or set telescope = 0; in script_info.

 script_info = {
 	telescope = 0;
 };

* 0: detected within normal scanner only as without telescope.
* 1: detected in visible range only (due to gravity scanner can see a ship with 1kg mass from 2km only).
* Positive integer: give new mass to the ship in kg which can increase the gravity detection.
* Negative integer: will be substracted from the ship.mass in kg to reduce gravity detection.

If this key is not placed at all then get the normal detection.
Objects with disabled detection (0) are not detected when arrive into visible range (need scanner range), but once detected then tracked over scanner range while in visible range until next scan (small help and save performance).


Problems:
If you do not see the model of a ship (or see a question mark if enabled) then you probably installed a custom ship OXP.
The core game currently does not support making visual effects from ships directly, but there is a workaround: copy the Config/shipdata.plist files in your OXPs to effectdata.plist or insert into the full contents if exists to avoid overwrite.

If the model still not appear and the definition of the ship using like_ship then copy the model = &quot;filename.dat&quot;; from the original ship into the section of this ship. Original cobras arrived after I do this only.

If a custom ship use shaders with uniforms then you may see errors in the log but the visual target usually appear with less detail (need several core improvements to fix properly). To avoid the errors you can try commenting out the referred lines with // from the effectdata.plist or replace the inputs with fix numbers based on the wiki. For example the Griff Boa ( http://wiki.alioth.net/index.php/Griff_Boa ) is included in the effectdata.plist file of the Telescope OXP.

If you ride a custom ship and the visual target is misaligned (not in the top center position) then copy the view_position values from your shipdata.plist into the $ShipLibViewPosition array in Scripts/shiplib.js .
From Oolite v1.79 the player.ship.viewPositionForward property solve this.

Opened wormholes are not auto targetable. You can put a box around with the standard ident but the script receive an empty target only. Can not get a pointer from the list of allShips nor allVisualEffects in v1.77, but from v1.79 the isWormhole flag will solve this.

If a ship flys over a station then the lightball hides behind the station. To solve this need resizeable flashers which will be available from Oolite v1.79 only.

Right after undock or hyperjump the first ident press can not target the most centered ship, only the second press. The first does not call any event, so you must press &quot;r&quot; again.

Distant targets writes double message when locked, sometimes the first shows the name of the previous target. This seems to be a problem in the core game (tried to log it but only one log line created). Simply ignore the first message.


License:
This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.
ScanSound source: http://soundbible.com/878-Martian-Scanner.html

Changelog:
 2017.06.24. v1.15 Further speed improvements by cag.
 2017.06.20. v1.14 Serious speed improvements and a fix for targeting boulders by cag.
 2015.05.25. v1.13 Asteroids are lockable with ident press not in the crosshairs also.
                   Selectable bright masslock borders.
 2014.10.28. v1.12 Masslock borders with very bright textures for fluxxx.
 2014.10.28. v1.11 Masslock border brightness is adjusted.
                   Default lightball size is smaller, except for large ships over 400t mass.
                   Very far targets over 1000km show a dot only.
                   Show hostile/offender/derelict flag in CombatMFD.
 2014.10.12. v1.10 A fix to prevent sudden target changes reported by Bogatyr.
 2014.10.11. v1.9  Show the list of the nearest 10 targets in a MFD.
                   The newest detected target is displayed in the CombatMFD if installed.
                   A small fix if Visual target:off and size is changed, thanks to Anthony.
 2014.07.06. v1.8  Fixed the restore of lightball settings after load game, thanks to Anthony.
                   Dark far lollipops in yellow alert except if weapons are offline.
                   Virtual target model is within a ring by default with offline weapons also.
                   Range extenders are separated into Telescope Extender and Gravity Scanner OXZ.
 2014.01.28. v1.7  Targets marked with dots from far distances for FarPlanets OXP.
                   Lock the nearest from overlapping targets within 0.5 degree.
                   $TelescopeRedAlertDist change lollipops over 30km to black in red alert.
                   Reduced chanche of timeLimit.
 2014.01.16. v1.6  Fixed reorientation during Asteroid hunting, thanks to Duggan.
                   Improvements for FarPlanets OXP.
                   Sun is added into the target list and got orange lollipop.
                   Planet lollipop color is changed to lightgray, masslockborder also.
                   Targets over $TelescopeSniperRange (30km) get tiny lightballs.
 2014.01.04. v1.5  Planets are targetable within scanner range also.
 2014.01.02. v1.4  Polished masslock borders and planet targets.
 2013.12.29. v1.3  Masslock borders: coloured circles around ships and planets.
                   Planets are included into the target list.
                   In Oolite 1.79 show visual target models of new ship graphics.
                   Thinner ring around visual target, smaller sniper ring.
 2013.11.02. v1.2  Gravity Scanner can fit from 130t mass again but restricted to use near stations.
                   Small Dish introduced, Large Dish need at least an Anaconda.
                   Ship lightballs minimal distance raised to 10km, cargo lightballs stay at 1km.
                   Lightball size of ships under 30t mass reduced to tiny.
                   Fixed infinite lost messages caused by piloted rocks in Lave.oxp.
 2013.10.22. v1.1  Double ident press will start auto steering to the target.
                   Need Telescope Extender to see over scanner range.
                   Gravity Scanner need ship with at least 400t mass.
                   Custom stations are lockable from 4x scanner range.
 2013.08.06. v1.0  Telescope configurable during fly: press mode key to cycle, activate to choose.
                   Settings stored into missionVariables and restored with load game.
                   Gravity Scanner is not primable anymore due to functions merged into Telescope.
 2013.08.03. v0.92 FCB speed almost doubled by Svengali, many thanks to him!
                   Maximal handled Telescope targets increased to 200.
                   False $TelescopeFarStatus to do not reveal pirates over normal scanner range.
                   Gravity scan need some time to calculate.
                   Added Secondary Gravity Scanner Equipment for faster scan in large ships.
                   $TelescopeLargeLightBalls set to false by default for small balls.
                   $TelescopeLightBalls can turn off lightballs but leave lollipops on the scanner.
                   $TelescopeShipLightBalls turn off ship lightballs only and show non-ships only.
 2013.07.23. v0.91 Cheap repairs get nice drawbacks.
                   Gravity scan sometimes detected by aliens.
                   FCB speed improvements to prevent Timelimit in trunk.
                   Fixed rescan bug if target has Military Jammer awarded by ShipVersion OXP.
                   Changed $TelescopeShowVisualTarget to always show the model in weapons off mode.
 2013.07.20. v0.90 Activate steer to the nearest target or to the nearest attacker in Red Alert.
                   Mode lock and steer to the most centered target or attacker in Red Alert.
                   Large lightballs added, show within $TelescopeSniperMinRange (10km).
                   Added telescope script_info key and hide custom Stations, thanks to Svengali.
                   Added $TelescopeThargoids if you want a test in instant action.
                   Fixed $TelescopeRedAlertLimiter, thanks to Solonar.
 2013.07.17. v0.86 Gravity Scanner cost increased, repair discounted.
                   Tharglet get small pink lightball until active.
 2013.07.16. v0.85 Debug version to Duggan and Solonar with many Tharglets and without crash.
 2013.07.15. v0.84 Internal updates to avoid timeLimit.
 2013.07.15. v0.83 Gravity Scanner range reduced and made another performance improvements.
 2013.07.14. v0.82 Added $TelescopeGravLock and $TelescopeIdentLock sensitivity in degree.
                   Added $TelescopeShowVisualStation and $TelescopeShowVisualQuestionMark.
                   Added is_external_dependency = yes; to griff boa, thanks to Svengali.
                   Bugfixes and preformance improvements.
                   Can lock asteroids in crosshairs with ident press.
 2013.07.11. v0.81 Added $TelescopeAutoLock, if 0 then must manually lock targets as before.
 2013.06.17. v0.8  Lightballs and shadow lollipop added.
 2013.06.10. v0.7  Visual targeting and Auto steering added.
 2013.05.05. v0.6  Minor fixes.
 2013.04.08. v0.5  First working version.
 2013.03.31. v0.1  First test files.
</pre>
        <h3>cag/Norby.readme.again.cag.txt</h3>
        <pre>After posting in &#39;OXP Performance tips&#39; about the speed gains of the function
_index_in_list, I realized I forgot to back-port that little gem into the
version I made for you.  So it&#39;s included in &quot;telescope -after final.js&quot;, so
you should see a few more fps.

I also fixed a few minor bugs (HA! not) that I introduced (you didn&#39;t test it
much, did you) and excluded docked escorts and the tow ship from Nearest,
Steering and stepping through the List. No doubt Murphy will find a way to
make me regret it!

Unless someone (else) finds a bug(s), I&#39;m going to stop here and move onto
other things.
=============================================================================
Enclosed are the following:  (&#39;*&#39; indicate new or modified)

  telescope.orig.1.13.js            - copy of your last published version
  telescope -stage1.js             - after stage1 changes
  orig-stage1.diffs.txt            - output from DOS&#39;s FC (file compare)
  telescope -stage2.js             - after stage2 changes
  stage1-stage2.diffs.txt          - output from DOS&#39;s FC (file compare)
  telescope -final.js              - after final changes
  stage2-final.diffs.txt           - output from DOS&#39;s FC (file compare)
* telescope -after final.js        - after more &#39;final&#39; changes &amp; bug fixes
* after-final.diffs.txt            -  output from DOS&#39;s FC (file compare)
  Telescope 1.13 readme.cag.txt    - updated readme (grammar)
* Norby.readme.txt                 - this file

Let me preface this by saying I wanted to avoid changing anything in the logic
or calculations in your code - that&#39;s how bugs are born!  Most edits were just
house keeping and should not produce any behavioral changes.  I say &#39;most&#39;
because a) I did rewrite Telescope_MostCentered2 and b) some of the closures
benefitted by moving functions inside.  I don&#39;t see any differences but, being
much more familiar, you may.  

stage1:
 - eliminate JSLint errors (220+)
   - if you&#39;re not using one, JSLint is a syntax checker that also reports
     strict usage violations and some basic speed improvements
   - mine is a plug-in to NotePad++
 - remove all &#39;delete&#39; statements
   - a poorly named statement, delete actually removes a property from its object.
     This is an expensive op, esp. if you add it back on.  Setting the ref to null
	 or some other value, is sufficient for garbage collection. eg.
	 	delete ws.$TelescopeList; 	// not necessary
		ws.$TelescopeList = [];		// reduces # references to previous array to 0
 - dynamic FCBs to replace 50 static ones
   - I discovered by accident that the 50 hard coded FCBs to ws.$TelescopeVFCBM 
     were costing me a few fps, so I replaced them w/ a dynamic scheme.  This 
	 turned out to be tricky, as changes can take a few frames (5 on my PC) to
	 take effect.  Adding a callback was fine, as this was done before processing
	 the VFCBMarks, and I always had more than 16 in the List, doing 4/frame.  But
	 removing a callback kept triggering my error checks until I realized the delay.
 - rewrote Telescope_MostCentered2
   - I usually equip my ship w/ a mining laser to port and was having trouble 
     targetting boulders. The problem is in the ordering of the subtracted entity 
	 positons.  It seems backward to me but
		ps.vectorForward.angleTo( psp.subtract( t.position ) )
	 counts down from 180, whereas
		ps.vectorForward.angleTo( t.subtract( psp.position ) )
	 counts up from 0!  So, if you always .subtract( psp ) instead of psp.subtract(...,
	 you get what you&#39;d expect from angleTo and it makes coding easier.
	 
stage2:
  - here I placed 3 FCB ( _VFCB, _VFCB2, _VFCBVisualTarget ) inside closures to reduces
    the # of WorldScriptsGetProperty, ShipGetProperty &amp; EntityGetProperty executed, as
	they were usually the top time expenditures.  Function addresses and some global
	variables do not change or the course of a game.  Those are stored in the closure&#39;s
	scope and are only evaluated once, from the initiaton call in startUp.  In a few
	cases, I was able to move global variables into a closure, as they were not 
	referenced elsewhere.
	I avoided doing _SteerFCB and _VFCBMarks, as I&#39;m a chicken at heart! (I have not
	dealt with _SteerFCB at all so far and you had already done _VFCBMarks).

final:
  - here I placed _TimedS in a closure along with 3 functions, as they were called no
    where else: _IsPilotedVisible, _IsNonHostileStaion, _MFDTarget
	I also folded _IsScannerTarget into _IsPilotedVisible to eliminate repeated property 
	checks. 
  - I added a few more locals to _TimedVMC() and cut a third off its execution time

I&#39;m sure _List3 could also benefit but I failed (twice) trying to put it in a closure 
(I introduced bugs) and so reverted to its original form.

frame rates (fps):
  - with no Addons, telescope demo varied
    from 58 - 85, using ver.1.13
      to 74 -112, using final
  - with 156 Addons, telescope demo varied
    from 18 - 30, using ver.1.13
      to 23 - 36, using final
  - with 156 Addons, telescope demo, my re-write varies between 35 - 48 fps
  
Given the numbers above, I think it best for me to halt optimizing current telescope code
and continue with my re-write.  Unless you find a bug (or 2) in my edits but you wouldn&#39;t,
would you? ;-&gt;  
</pre>
        <h3>cag/Norby.readme.cag.txt</h3>
        <pre>Enclosed are the following:

telescope.orig.1.13.js			- copy of your last published version
telescope -stage1.js			- after stage1 changes
orig-stage1.diffs.txt			- output from DOS&#39;s FC (file compare)
telescope -stage2.js			- after stage2 changes
stage1-stage2.diffs.txt			- output from DOS&#39;s FC (file compare)
telescope -final.js				- after final changes
stage2-final.diffs.txt			- output from DOS&#39;s FC (file compare)
Telescope 1.13 readme.cag.txt	- updated readme (grammar)
Norby.readme.txt				- this file

Let me preface this by saying I wanted to avoid changing anything in the logic
or calculations in your code - that&#39;s how bugs are born!  Most edits were just
house keeping and should not produce any behavioral changes.  I say &#39;most&#39;
because a) I did rewrite Telescope_MostCentered2 and b) some of the closures
benefitted by moving functions inside.  I don&#39;t see any differences but, being
much more familiar, you may.  

stage1:
 - eliminate JSLint errors (220+)
   - if you&#39;re not using one, JSLint is a syntax checker that also reports
     strict usage violations and some basic speed improvements
   - mine is a plug-in to NotePad++
 - remove all &#39;delete&#39; statements
   - a poorly named statement, delete actually removes a property from its object.
     This is an expensive op, esp. if you add it back on.  Setting the ref to null
	 or some other value, is sufficient for garbage collection. eg.
	 	delete ws.$TelescopeList; 	// not necessary
		ws.$TelescopeList = [];		// reduces # references to previous array to 0
 - dynamic FCBs to replace 50 static ones
   - I discovered by accident that the 50 hard coded FCBs to ws.$TelescopeVFCBM 
     were costing me a few fps, so I replaced them w/ a dynamic scheme.  This 
	 turned out to be tricky, as changes can take a few frames (5 on my PC) to
	 take effect.  Adding a callback was fine, as this was done before processing
	 the VFCBMarks, and I always had more than 16 in the List, doing 4/frame.  But
	 removing a callback kept triggering my error checks until I realized the delay.
 - rewrote Telescope_MostCentered2
   - I usually equip my ship w/ a mining laser to port and was having trouble 
     targetting boulders. The problem is in the ordering of the subtracted entity 
	 positons.  It seems backward to me but
		ps.vectorForward.angleTo( psp.subtract( t.position ) )
	 counts down from 180, whereas
		ps.vectorForward.angleTo( t.subtract( psp.position ) )
	 counts up from 0!  So, if you always .subtract( psp ) instead of psp.subtract(...,
	 you get what you&#39;d expect from angleTo and it makes coding easier.
	 
stage2:
  - here I placed 3 FCB ( _VFCB, _VFCB2, _VFCBVisualTarget ) inside closures to reduces
    the # of WorldScriptsGetProperty, ShipGetProperty &amp; EntityGetProperty executed, as
	they were usually the top time expenditures.  Function addresses and some global
	variables do not change or the course of a game.  Those are stored in the closure&#39;s
	scope and are only evaluated once, from the initiaton call in startUp.  In a few
	cases, I was able to move global variables into a closure, as they were not 
	referenced elsewhere.
	I avoided doing _SteerFCB and _VFCBMarks, as I&#39;m a chicken at heart! (I have not
	dealt with _SteerFCB at all so far and you had already done _VFCBMarks).

final:
  - here I placed _TimedS in a closure along with 3 functions, as they were called no
    where else: _IsPilotedVisible, _IsNonHostileStaion, _MFDTarget
	I also folded _IsScannerTarget into _IsPilotedVisible to eliminate repeated property 
	checks. 
  - I added a few more locals to _TimedVMC() and cut a third off its execution time

I&#39;m sure _List3 could also benefit but I failed (twice) trying to put it in a closure 
(I introduced bugs) and so reverted to its original form.

frame rates (fps):
  - with no Addons, telescope demo varied
    from 58 - 85, using ver.1.13
      to 74 -112, using final
  - with 156 Addons, telescope demo varied
    from 18 - 30, using ver.1.13
      to 23 - 36, using final
  - with 156 Addons, telescope demo, my re-write varies between 35 - 48 fps
  
Given the numbers above, I think it best for me to halt optimizing current telescope code
and continue with my re-write.  Unless you find a bug (or 2) in my edits but you wouldn&#39;t,
would you? ;-&gt;  
</pre>
        <h3>cag/Telescope 1.13 readme.cag.txt</h3>
        <pre>Telescope forum topic: http://bb.aegidian.org/viewtopic.php?f=4&amp;t=14961

Quick start as a Hunter

* Copy the .oxp folder to the AddOns directory, hold down the Shift when starting the game the first time after copying.
* Buy Telescope with Extender equipment or load the included savegame (&quot;Telescope demo.oolite-save&quot;). Injectors, ECM System, Fuel Scoop, Military Laser and Scanner Targeting Enhancement are used also in this guide.
* After undock (F1) you can see the magnified target in top center position.
* If you bought Gravity Scanner then stop near the station, turn off your weapons with underscore (_) and wait for the scan results.
* Turn your ship where you see lollipops at the edge of your IFF scanner. The Panorama targeting will countinually change the box to the most centered target.
* Choose your enemy for the strength of your ship: start with a small ship flying alone.
* Use Injectors (i) to fly into scanner range where you can see a Red ball which means visible ship with bounty. Do not hunt Yellow traders and Purple police ships if you want to remain in clean status.
* Use Ctrl+arrow keys to put the target into the middle of the crosshairs to turn on the sniper ring which magnify the difference from the correct line-up.
* Turn on your weapons (_) and fire (a). You can try to hit with Military laser over normal scanner range but within 30km and a stopped target will turn when successful, but if your target is too small then fly inside 25.6km where the red target box indicate the correct line-up.
* Press ident (r) to lock the most centered target if there are more, press again to start auto steering or to lock another if it&#39;s more centered than the current target.
* Telescope can be primed (Shift+N) then activated (n) to lock the nearest target, mode (b) change the function of the activate key.
* If a missile is coming then a cyan ball warns you: start ECM (e), target it (t), try to avoid (i) or shoot it (a).
* If you win and the pilot ejected then shot down the derelict ship to get the bounty, then fly after the small White balls and scoop the Escape Pod, metal fragments and cargo pods.
* Fly back to the station and dock to get the reward for the pilot and sell the cargo (F8). Congratulations, you are richer. :)


Telescope Equipment

This OXP realizes some requests for an extended scanner described in this topic:
http://bb.aegidian.org/viewtopic.php?f=6&amp;t=13274
Can determine the direction, distance, orientation and legal status of all visible ships.

The detection range is equal with the scanner range if you use it without the Telescope Extender (still or willfully), but you can use the following features:

Visual targeting

The virtual model of the target ship is displayed and a console message shows the name, range and direction.
The direction is marked by &lt;^ or v&gt; symbols to read faster than the Port Up or Down Starboard words.
The ranges and directions are calculated continually to help turn in line and see the decreasing range while traveling to the target.
The orientation of the model is equal with the target if you centered it and you can spin the model if turn around your ship.
You can set the size of the model with the $TelescopeVSize variable in the Scripts/telescope.js.

Lightballs

Far targets get coloured lightball markers in the view and lollipops with darker colours near the edge of the scanner.

Red: Hostile ship with bounty (pirates and thargoids),
Pink: Tharglet until active and Drones with bounty in HardShips OXP,
Yellow: Neutral ship with clean status (traders and co),
Purple: Police,
Cyan: Missile or Mine,
Green: Buoy or Station,
Blue: Derelict (Wormhole also from Oolite v1.79),
White: Cargo, Escape Pod or Sun,
Gray: last known position of a lost target (moved out of telescope range),
Lightgray: Planet or Moon (a bit darker than Planet),
Orange: Gravity Scanner detected ship too far to be visible,
Brown: Gravity Scanner detected ship under 130t mass (less dangerous, especially with ShipVersion OXP).
Black: lollipops in red alert over 30km to help focus on near targets.

Beacons are identified in the whole system due to the transmitted radio signals.
If a ship transmits a beaconcode then it&#39;s detected anywhere but coloured as a ship and turns to orange if too far to be visible.

The current target is also marked with a gray &quot;shadow&quot; lollipop at the edge of the IFF scanner to help determine the direction, especially at close range, to avoid zooming the scanner. 
If the target is closer than 1000m, the lightball will be removed as the ship almost covers the ball and cargo pods are large enough large to detect with your eyes, but the shadow lollipop still remain.
You can set the minimum distance with the $TelescopeVMarkMinDist variable in the file Scripts/telescope.js.

Targets within the range of the Military Laser (30km) are marked with a larger ball and a normal (not darker) coloured lollipop.
You can use this feature to determine exactly where you can open fire on the target so it&#39;s large enough to stand a chance of being hit.

You can disable the lighballs of the ships by setting $TelescopeLightBalls to false, but non-ships with Blue, Cyan, Gray, Green and White colours will remain to help find these. Auto targeting functions can still lock far targets; there seems to be an empty box but the ships are in there.

You can restrict lighballs in Red Alert to 10-30km if you set $TelescopeRedAlertLimiter to true to save a few CPU cycles but it is worth it on slow computers only.

Sniper ring

If you have almost lined up with your target who is between 10 and 30km then a ring will appear.
The movement of this ring magnifies the variance to the correct line-up, to help fine tune your aim.
You can hit if the target box of the Scanner Targeting Enhancement switches to red.

Snipers can use the distances between 25.6 and 30km to fire before the enemy can see the attacker on its scanner.
This was possible without Telescope, but the size of the ball gives another aid to knowing when the target runs out of range; and the ring can guide your aim without red box, which only works in the normal scanner range.

If you think this is a cheat then fire only when the target can also see you (red box) or set the $TelescopeSniperRange variable to 25600 which will shorten the appearance of the ring and the largest ball (but there&#39;s no way to shorten the range of the Military Laser).

Auto steering

With the Telescope primed (Shift+N) the activate button (&quot;n&quot;) can steer to the nearest lightball-marked target, which is useful in picking up cargo from the near field, rather than zooming the scanner to find them. Now you can just press activate instead of hitting zoom, locate, turn and unzoom.

Auto-steering starts only if your ship flys in a line (not turning) and stops instantly if you touch the controls. It will stop steering before a perfect line-up so as not to aim for you.

In Red Alert the activate button steers to the nearest attacker. You can disable this by turning off the weapons, in which case you can lock and steer to any near target regardless of the alert condition.

Auto scanning

Telescope checks for new targets every second and performs an autoscan if it finds one: simple light sensors can see new dots in the whole sky without using energy but must zoom with the main scope to determine the ship type which needs 2 energy points.
The autoscan can be turned off if you set $TelescopeAutoScan false in the telescope.js file but it&#39;s usually worth the cost to get new information sooner.

Far target locking

You can lock far targets also which is not in the normal scanner (beacons and planets are always lockable). The distance is shown before the name of the ship with Scanner Targeting Enhancement, due to the fact that the second line shows the range of the virtual marker (which is always near the edge of the IFF Scanner).
We must use this workaround because the core game does not allow locking onto a target outside of normal scanner range. So the locked marker coinsides with the lock of the target (can only fix this in the core game).

If you cannot see a ship then it may have been destroyed, jumped out or flew farther than the visible range; or it has a Military Scanner Jammer and you do not have a Jammer Filter so you cannot get target lock.

When a target flys too far and is lost, the telescope renames it to &#39;Lost target&#39; until the next scan.

Masslock borders

In green alert you will see circles around detected targets where these ships can block your Torus Drive.
Without a Telescope Extender, these are shown around planets and stations only, but if you buy one, it allows for detection of ships that you can  see with your Mark-1 eyeball (escort ships at 2x, traders near 4x scanner range) and you will then get circles around all the ships before you.

Until you enter these circles you will stay in condition green, but cloaked ships can cause surprises.

The colour of a masslock border is the same as the lightball in the middle (see above).

To get the shortest route, you can safely go forward near the largest circle without touching it or going inside. Imagine this is the border of a sphere so if you fly direct to the center then you will be masslocked sooner than if you flew to a point of the circle. If you steer just a little outside the circle, you will fly forward as near as possible without masslock.

These are also a good indicator of the distance to the ships because the radius of the circles represent exactly one scanner range for the ship at its center.
Planets have rings that are double its radius as they can masslock you within this range.
The sun also has a large masslock field but this is not displayed by rings - it&#39;s less important and mainly a distraction.

You can also turn on masslock borders in non-green alerts if you turn off your weapons.
You can turn off all circles completely with the Telescope primed to the Lightballs menu (see below).

Keypress functions

The ident button (&quot;r&quot;) gets a new feature from Telescope: it can lock the most centered target even if it&#39;s not shown on the screen.
The next press will start auto steering to the target if the most centered target is the same, otherwise it will lock onto the new target; a third ident press will unlock it.
In Red Alert it will not narrow the locking to the attackers; it can lock any target.

Works only if there was a locked target beforehand, due to the triggering of the shipTargetLost event, so if there&#39;s no target it won&#39;t get called. Press &quot;r&quot; again or get something into the crosshair or use equipment buttons to lock a target. (Usually only an issue when leaving a station, exitting witchspace or Torus drive.)

If you turn off the weapons with the underscore button (&quot;_&quot;) then a scan happens and you enter into &quot;Navigation Mode&quot;, where autolock helps you see through targets (called Panorama targeting): continually relocks to the most centered target.
This button is choosed to avoid unwanted fire if you have turrets.
In Red Alert you can lock any target and see far targets if you turn this mode on.
The Ident button presses can turn Panorama targeting on and off when in Navigation Mode.

With the Telescope primed (Shift+N), the mode button (&quot;b&quot;) cycles through the functions of the activate (&quot;n&quot;) button:

 Nearest target
 Rescan
 Step forward in the target list
 Step back in the target list
 Lightballs: off / navigation only / ships / masslock borders / large
 Sniper ring km: off / 5-25.6 / 10-25.6 / 15-25.6 / 5-30 / 10-30 / 15-30
 Steering: off / nearest target only / both nearest and step in the list
 Targets: 20 and limitation in red alert / 50 / 100 / 200
 Visual target: off / weapons off / no ring / no station / no question mark / all
 Visual target size: 1-8

The first 4 functions are commands which happen instantly when activated.
The &quot;Step forward&quot; and &quot;Step back&quot; will rescan if you step over the end of the target list.
The Target list contains hostiles first, if any, then all ships in normal scanner (25.6km), followed by Cargo and Escape Pods, then ending with ships which are not in the normal scanner.

The last 6 functions are some of customizable properties in the telescope.js file, which you can during flight.
Your settings are stored into missionVariables and saved when you save your game after docking.

[When the core game provides more equipment buttons, a back button could step back to the previous function (maybe Ctrl+&quot;b&quot;).
With a second equipment button (maybe Ctrl+&quot;n&quot;) settings could be separated from the commands.]

 Cost: 500.0 Cr.
 Techlevel: 5


Telescope Extender

You must install &quot;Telescope Extender and Gravity Scanner&quot; OXZ package and buy this equipment separatedly to confirm you want step over the rules of the standard game.
This will increase the detection range based on the size of the target so you can lock onto it when the core game sets it to isVisible and shows at least a dot in the sky.
For example you can see:
-Adder at 32 km,
-Viper and escort ships around 50 km (2x scanner range),
-Anaconda, Boa, Cobra MkIII and Python about 100 km (4x scanner range),
-Rock Hermit in almost 500 km (if not visible from the Main Station then fly around),
-Coriolis Station at 1000 km (right from the witchpoint).

 Cost: 500.0 Cr.
 Techlevel: 5


Gravity Scanner Equipment

You must install the separated &quot;Telescope Extender and Gravity Scanner&quot; OXZ package to use this and the following uber-ranged equipments.

If the mass of your ship more than 130t (Cobra MkIII and above) and there is a station within 5km, you can then extend the detection range of Telescope using a mass detector, which scales by third power of distance:
the mass of the target in kg must be larger than d2*d2*d2/100 where d2 = distance*2 in km.

Detection of the player ships and the Hard versions in HardShips OXP:
                 t    km   Hard t  km
Adder           11    52    23     66
Moray           40    79    81     100
Cobra Mk I      47    84    94     106
Fer-de-Lance    51    86    102    108
Asp             59    90    118    114
Cobra Mk III    186   132   371    167
Boa             192   134   385    169
Phyton          222   141   445    177
Anaconda        430   175   1289   253

Beacons are detected in the whole system and Rock Hermits usually as well (from 900km).

A station needs to be near as the largest parts of the gravity scanner system is fitted into the stations, which broadcast some important data and it needs a large mass (at least 10.000t, the station itself) nearby as a reference to refine the results.
Mobile bases can scan anywhere.

It takes 4 minutes from undock or hyperjump to reach the maximal detection range when your ship is on the move.
The detection progresses 4 times faster when your ship is stopped, needing only 60 seconds to finish.

The mass is scaled with the elapsed time: an Anaconda is detected at half time as its half mass (215t) would, which means 140km, and needs more time to detect it from the maximal 175km.

When the gravity detection is done and you remain at maximum speed until docking or jumping, the computer only needs to calculate in the new area coming into range from travel and not the whole sphere.

The Gravity scanner works only when you turn off your weapons with underscore (&quot;_&quot;) button, otherwise only visible targets are displayed.
You can define a more comfortable key in the Oolite/oolite.app/Resources/Config/keyconfig.plist file.

The auto-relock feature will contiunually change your target to the most centered one, so the box will jump during your turn; your ship helps browse the many targets. The ident (&quot;r&quot;) button can lock the same target only in this mode, it cannot step to the second centered target.

Gravity scan consume 8 energy points (visual scan uses only 2).
You can hear the sound of the Gravity Scanner at work, which is to remind you of the energy usage.

Orange and Brown lollipops and lightballs mark the detected targets out of the visible range.
Brown if the ship is under 130t mass which means small ships, usually escorts - avoid Orange ones and target single Browns while your ship is not very strong.
The mass usually cannot tell if a ship is pirate or not, coloured identification need visual contact.

If you see a lighter ball then there are two or more ship in the same place.
The smallest orange and brown ball means the target is farther than 150km, these get dark orange and dark brown lollipops.

The Gravity Scanner cannot determine the orientation. If the target is not visible then the view position of the virtual model will be a fixed view from the top.

There are no passive gravity sensors so AutoScan will happen only if a new target arrives into the visible range.
When you undock or arrive at a new system, the telescope scan is performed automatically but if you want to scan the final frontier then you must turn off your weapons.

Beware: aliens can sometimes detect the signal of a Gravity Scan, so if your ship is not strong then do not use it often and pay for the full repair if it&#39;s damaged.

 Cost: 10000.0 Cr.
 Techlevel: 5


Secondary Gravity Scanner Equipment

Cuts in half the time to get the full detection range and works as a single scanner if the primary one is damaged.
Can only fit into ships over 400t mass (Anaconda and heavy OXP ships).

 Cost: 20000.0 Cr.
 Techlevel: 5


Small Dish Equipment

Detect ships from one third farther out (for example an Asp at 120km) but can only fit onto ships over 130t mass (from Cobra MkIII) due to the size.

Needs Gravity Scanner, it is a just piece of metal.

Fast CPUs can draw 200 targets without relevant FPS drop, slow systems draw it also but with some drop (tested on Intel Atom netbook). In this case scan for Gravity targets only when needed and turn it off when Telescope range is reached.

This is not a primable equipment (there are no buttons on the pure alloy) and a passive extension so will not increase the energy usage of the scan.

 Cost: 5000.0 Cr.
 Techlevel: 5


Large Dish Equipment

Detect ships from double the range (an Asp at 180km) but can only fit onto ships over 400t mass (Anaconda and over) due to the size.

Small Dish will not increase this range further so you can refund it when you buy a Large Dish.

Ships over 1000t (Hard Anaconda and big OXP ships) can use the hull mass to refine the gravity signals to reach 4 times range than without Large Dish.

Will only show the nearest 200 targets to save CPU and avoid serious FPS drops in systems with many ships.

 Cost: 10000.0 Cr.
 Techlevel: 5



Cheap Repairs

You can buy small fixes for 1/10 the cost of the new equipment instead of the normal 1/2 price but the following drawbacks will be applied:

Telescope: get back the lightballs but will not fix the virtual model display, auto steering and sniper ring.
Gravity Scanner: the cheap spare parts can interfere with the hyperdrive and often cause misjumps.
Small and Large Dish: usees less durable alloys and can break during hyperjump.

After a cheap fix you can buy the full repair which costs the difference between cheap and normal repair: 2/5 of the full price.
You can only refund fully repaired equipment.


Dependencies:
Oolite v1.77 or later. No shaders needed.

Instructions:
Unzip the file, and then move the folder name ending in &quot;.oxp&quot; into the AddOns directory of your Oolite installation.
Savegame included: put the &quot;Telescope demo.oolite-save&quot; file into the oolite-saves directory to load it.


Settings in Scripts/telescope.js:

$TelescopeAutoScan = true; //check continually for new isVisible isPiloted target and scan if found
Scanning use a very little energy if a new target arrived but you strongly need this to avoid often scan manually.

$TelescopeAutoScanMaxRange = 1000000; //meters, how far targets will be reported

$TelescopeAutoLock = 1; //if no target and something in crosshairs with max. this degree diff., 1=lightball size, 0=off
AutoLock is set to 1 degree (size of a lightball) and lock only if no current target to make it similar with the original ident function plus can lock far targets also. Disabled if set to 0 but in this case you can lock targets in 25.6km only.

$TelescopeFarStatus = false; //red ball reveal pirates over normal scanner if true
If false then bounty detected within 25.6km only which is more real and exciting but Thargoids get red ball at any range and a red ship will not change back to yellow if fly over the normal scanner range.

$TelescopeGravLock = 20; //gravity scanner relock in this degree cone (0-180, 20=about the screen)
Panorama targeting offer auto-relock to the most centered target during manual turning and can be switched on or off in-game frist with the weapons and second with the ident button when you see gravity targets. Disabled if set it to 0 but it is not recommended due to in this case you can not lock far targets, so set it to 1 degree at least, or simply use the ident button in-game to reduce it to the level of the AutoLock and leave the possibility to turn it on again.

$TelescopeIdentLock = 180; //if ident pressed or target lost then lock in this degree (0-180, 180=the whole sphere)
Can lock the most centered target even if behind you if set it to 180 and the second press will unlock it so you can clear the virtual model when not needed. If set it to 1 then the locking radius reduced to the size of a lightball so can do unlock only. Note the AutoLock will relock in 0.25 second if the target centered exactly, in this case turn a bit before unlock.

Red alert is an exception where the IdentLock target hostiles only (who target you) to help find attackers. Can be override with AutoLock and GravLock, so if you unlock the current target and point exactly to another then the AutoLock will target it regardless of the hostile&#39;s status, or if you point it and turn weapons quickly off and on again then lock it regardless from you has lock on another target (but not too quickly, the timed function need max. 0.25 second to lock).

$TelescopeLargeLightBalls = false; //lightballs are increasing depending on the distance or remains small

$TelescopeLightBalls = true; //turn on or off all lightballs, but marks on the scanner will remain

$TelescopeMassLockBorders = true; //coloured circles around ships and planets in green alert

$TelescopeRedAlertDist = 30000; //show lollipops in red alert within this distance only

$TelescopeRedAlertLimiter = false; //a bit more FPS in dogfight if true but show all marks with weapons off only

$TelescopeRing = true; //show a ring around the visual target

$TelescopeShipLightBalls = true; //turn on or off the lightballs with scanner markers of the ships, but cargo, etc. remain
Non-ships with Blue, Cyan, Gray, Green and White colours will remain to help find these. Auto targeting functions still can lock far targets, the targeted ship are in an empty box.

$TelescopeShowVisualQuestionMark = false; //if a ship has no virtual model in effecdata.plist show a big &quot;?&quot; model

$TelescopeShowVisualStation = true; //show or not show the 3D model of the targeted station

$TelescopeShowVisualTarget = true; //show the 3D model of the target if weapons are on (except stations if VisualStation is false)

Set it to false if you want to use the weapon toggle button to show and hide virtual model also.

$TelescopeSniperMinRange = 10000; //meters, show sniper ring if the target is over this distance

$TelescopeSniperRange = 30000; //meters, if the target is inside then show sniper ring and large lightball
Set it to to 25600 if you want to shorten the appearance of the sniper ring in the name of the fair play.

$TelescopeSniperRingSize = 2; //size of the sniper ring (between 1 and 5, default: 2)

$TelescopeSteering = 2; //auto steering if lock nearest or step in the target list with activate, 1:nearest only

$TelescopeTargets = 200; //limitable to reduce FPS drop in systems with many ships, min. 10, max. 200

$TelescopeThargoids = false; //you will get aliens right after undock to test Telescope

$TelescopeVMarkMinDist = 1000; //meters, if target is inside then remove the lightball marker

$TelescopeVMarkShipMinDist = 5000; //meters, if target is ship and inside then remove the lightball marker

$TelescopeVPosHUD = [0, 0, 0]; //position shift for your HUD&#39;s built-in visual target screen if any

$TelescopeVSize = 4; //size of the visual target with online weapons (between 0 and 10, default: 4)

$TelescopeVZoomSize = 6; //zoomed size of the visual target with offline weapons (between 0 and 10, default: 6)

If size is 0 then the visual target is not shown at all.


Script_info support:

OXP makers can alter the detection of any objects in shipdata.plist to avoid revealing mission secrets.

Stations with non-standard roles and ships with the word &quot;stealth&quot; within their dataKey or role are detected in normal scanner range only. Must specify &quot;telescope&quot; script_info key to detect it farther to stay compatible with the existing OXPs, for example Rescue Stations.oxp, Stealth.oxp and Vector.oxp.

Standard Station roles: &quot;station&quot;, &quot;coriolis&quot;, &quot;dodo&quot;, &quot;dodec&quot;, &quot;dodecahedron&quot;, &quot;ico&quot;, &quot;icosa&quot;, &quot;icosahedron&quot; and &quot;rockhermit&quot;.

Hiding ships need &quot;stealth&quot; role or set telescope = 0; in script_info.

 script_info = {
 	telescope = 0;
 };

* 0: detected within normal scanner only as without telescope.
* 1: detected in visible range only (due to gravity scanner can see a ship with 1kg mass from 2km only).
* Positive integer: give new mass to the ship in kg which can increase the gravity detection.
* Negative integer: will be substracted from the ship.mass in kg to reduce gravity detection.

If this key is not placed at all then get the normal detection.
Objects with disabled detection (0) are not detected when arrive into visible range (need scanner range), but once detected then tracked over scanner range while in visible range until next scan (small help and save performance).


Problems:
If you do not see the model of a ship (or see a question mark if enabled) then you probably installed a custom ship OXP.
The core game currently does not support making visual effects from ships directly, but there is a workaround: copy the Config/shipdata.plist files in your OXPs to effectdata.plist or insert into the full contents if exists to avoid overwrite.

If the model still not appear and the definition of the ship using like_ship then copy the model = &quot;filename.dat&quot;; from the original ship into the section of this ship. Original cobras arrived after I do this only.

If a custom ship use shaders with uniforms then you may see errors in the log but the visual target usually appear with less detail (need several core improvements to fix properly). To avoid the errors you can try commenting out the referred lines with // from the effectdata.plist or replace the inputs with fix numbers based on the wiki. For example the Griff Boa ( http://wiki.alioth.net/index.php/Griff_Boa ) is included in the effectdata.plist file of the Telescope OXP.

If you ride a custom ship and the visual target is misaligned (not in the top center position) then copy the view_position values from your shipdata.plist into the $ShipLibViewPosition array in Scripts/shiplib.js .
From Oolite v1.79 the player.ship.viewPositionForward property solve this.

Opened wormholes are not auto targetable. You can put a box around with the standard ident but the script receive an empty target only. Can not get a pointer from the list of allShips nor allVisualEffects in v1.77, but from v1.79 the isWormhole flag will solve this.

If a ship flys over a station then the lightball hides behind the station. To solve this need resizeable flashers which will be available from Oolite v1.79 only.

Right after undock or hyperjump the first ident press can not target the most centered ship, only the second press. The first does not call any event, so you must press &quot;r&quot; again.

Distant targets writes double message when locked, sometimes the first shows the name of the previous target. This seems to be a problem in the core game (tried to log it but only one log line created). Simply ignore the first message.


License:
This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.
ScanSound source: http://soundbible.com/878-Martian-Scanner.html

Changelog:
 2015.05.25. v1.13 Asteroids are lockable with ident press not in the crosshairs also.
                   Selectable bright masslock borders.
 2014.10.28. v1.12 Masslock borders with very bright textures for fluxxx.
 2014.10.28. v1.11 Masslock border brightness is adjusted.
                   Default lightball size is smaller, except for large ships over 400t mass.
                   Very far targets over 1000km show a dot only.
                   Show hostile/offender/derelict flag in CombatMFD.
 2014.10.12. v1.10 A fix to prevent sudden target changes reported by Bogatyr.
 2014.10.11. v1.9  Show the list of the nearest 10 targets in a MFD.
                   The newest detected target is displayed in the CombatMFD if installed.
                   A small fix if Visual target:off and size is changed, thanks to Anthony.
 2014.07.06. v1.8  Fixed the restore of lightball settings after load game, thanks to Anthony.
                   Dark far lollipops in yellow alert except if weapons are offline.
                   Virtual target model is within a ring by default with offline weapons also.
                   Range extenders are separated into Telescope Extender and Gravity Scanner OXZ.
 2014.01.28. v1.7  Targets marked with dots from far distances for FarPlanets OXP.
                   Lock the nearest from overlapping targets within 0.5 degree.
                   $TelescopeRedAlertDist change lollipops over 30km to black in red alert.
                   Reduced chanche of timeLimit.
 2014.01.16. v1.6  Fixed reorientation during Asteroid hunting, thanks to Duggan.
                   Improvements for FarPlanets OXP.
                   Sun is added into the target list and got orange lollipop.
                   Planet lollipop color is changed to lightgray, masslockborder also.
                   Targets over $TelescopeSniperRange (30km) get tiny lightballs.
 2014.01.04. v1.5  Planets are targetable within scanner range also.
 2014.01.02. v1.4  Polished masslock borders and planet targets.
 2013.12.29. v1.3  Masslock borders: coloured circles around ships and planets.
                   Planets are included into the target list.
                   In Oolite 1.79 show visual target models of new ship graphics.
                   Thinner ring around visual target, smaller sniper ring.
 2013.11.02. v1.2  Gravity Scanner can fit from 130t mass again but restricted to use near stations.
                   Small Dish introduced, Large Dish need at least an Anaconda.
                   Ship lightballs minimal distance raised to 10km, cargo lightballs stay at 1km.
                   Lightball size of ships under 30t mass reduced to tiny.
                   Fixed infinite lost messages caused by piloted rocks in Lave.oxp.
 2013.10.22. v1.1  Double ident press will start auto steering to the target.
                   Need Telescope Extender to see over scanner range.
                   Gravity Scanner need ship with at least 400t mass.
                   Custom stations are lockable from 4x scanner range.
 2013.08.06. v1.0  Telescope configurable during fly: press mode key to cycle, activate to choose.
                   Settings stored into missionVariables and restored with load game.
                   Gravity Scanner is not primable anymore due to functions merged into Telescope.
 2013.08.03. v0.92 FCB speed almost doubled by Svengali, many thanks to him!
                   Maximal handled Telescope targets increased to 200.
                   False $TelescopeFarStatus to do not reveal pirates over normal scanner range.
                   Gravity scan need some time to calculate.
                   Added Secondary Gravity Scanner Equipment for faster scan in large ships.
                   $TelescopeLargeLightBalls set to false by default for small balls.
                   $TelescopeLightBalls can turn off lightballs but leave lollipops on the scanner.
                   $TelescopeShipLightBalls turn off ship lightballs only and show non-ships only.
 2013.07.23. v0.91 Cheap repairs get nice drawbacks.
                   Gravity scan sometimes detected by aliens.
                   FCB speed improvements to prevent Timelimit in trunk.
                   Fixed rescan bug if target has Military Jammer awarded by ShipVersion OXP.
                   Changed $TelescopeShowVisualTarget to always show the model in weapons off mode.
 2013.07.20. v0.90 Activate steer to the nearest target or to the nearest attacker in Red Alert.
                   Mode lock and steer to the most centered target or attacker in Red Alert.
                   Large lightballs added, show within $TelescopeSniperMinRange (10km).
                   Added telescope script_info key and hide custom Stations, thanks to Svengali.
                   Added $TelescopeThargoids if you want a test in instant action.
                   Fixed $TelescopeRedAlertLimiter, thanks to Solonar.
 2013.07.17. v0.86 Gravity Scanner cost increased, repair discounted.
                   Tharglet get small pink lightball until active.
 2013.07.16. v0.85 Debug version to Duggan and Solonar with many Tharglets and without crash.
 2013.07.15. v0.84 Internal updates to avoid timeLimit.
 2013.07.15. v0.83 Gravity Scanner range reduced and made another performance improvements.
 2013.07.14. v0.82 Added $TelescopeGravLock and $TelescopeIdentLock sensitivity in degree.
                   Added $TelescopeShowVisualStation and $TelescopeShowVisualQuestionMark.
                   Added is_external_dependency = yes; to griff boa, thanks to Svengali.
                   Bugfixes and preformance improvements.
                   Can lock asteroids in crosshairs with ident press.
 2013.07.11. v0.81 Added $TelescopeAutoLock, if 0 then must manually lock targets as before.
 2013.06.17. v0.8  Lightballs and shadow lollipop added.
 2013.06.10. v0.7  Visual targeting and Auto steering added.
 2013.05.05. v0.6  Minor fixes.
 2013.04.08. v0.5  First working version.
 2013.03.31. v0.1  First test files.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TELESCOPE.html">Telescope</a></td>
                    <td>yes</td>
                    <td align="right">5000</td>
                    <td align="center">5+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TELESCOPE_FULLREPAIR.html">Repair Telescope</a></td>
                    <td>yes</td>
                    <td align="right">2000</td>
                    <td align="center">5+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TELESCOPE_REFUND.html">Refund Telescope</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">5+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TELESCOPE_REPAIR.html">Repair Telescope targeting only</a></td>
                    <td>yes</td>
                    <td align="right">500</td>
                    <td align="center">5+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/telescopemarker.html">Telescope marker</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/largeonly.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;largeonly&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;This equipment is usable only for ships over 130t like the Cobra III or Rocket Miner.&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context)
{
//	player.consoleMessage( eqKey+&quot; &quot;+ship+&quot; &quot;+context );//debug
	if( ship.mass &gt;= 130000 ) return true;
	else return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/notforsmall.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;notforsmall&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;This equipment can not fit into small ships like the Adder or Rocket Fighter.&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context)
{
//bugfix for eqs with conditions scripts: need double replaceShip() to work!
//player.replaceShip(shipname, pers); player.replaceShip(shipname, pers);
//call twice! the first always got false for allow without run this script.
//Proof: if you uncomment the following line, only the 2nd call will write into the log.
//log(&quot;notforsmall&quot;, eqKey+&quot; &quot;+ship.name+&quot; &quot;+ship.mass+&quot; &quot;+context );

	if( ship.mass &gt;= 30000 ) return true;
	else return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/shiplib.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;shiplib&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Contains data about player ships.&quot;;
this.version     = &quot;1.0&quot;;

//please configure these to your custom ship if not in the list below
this.$ShipLibViewPosition = { //must be equal with view_position_* of your ship in the shipdata.plist
	aft:[0.0, 7.5, -32.5], forward:[0.0, 7.25, 16.25], port:[-30.0, 4.75, 0.0], starboard:[30.0, 4.75, 0.0]};
	
//internal data, should not touch
this.$ShipLibVP = [
	{k:&quot;default&quot;, a:this.$ShipLibViewPosition.aft, f:this.$ShipLibViewPosition.forward,
		p:this.$ShipLibViewPosition.port, s:this.$ShipLibViewPosition.starboard},
	//original player ships
	{k:&quot;adder&quot;, a:[0.0, 2.5, -22.5], f:[0.0, 2.5, 14.0], p:[-12.0, 1.5, -1.0], s:[12.0, 1.5, -1.0]},
	{k:&quot;anaconda&quot;, a:[0.0, -4.0, -80.0], f:[0.0, -0.5, 70.0], p:[-2.15, -0.5, 70.0], s:[2.15, -0.5, 70.0]},
	{k:&quot;asp&quot;, a:[0.0, 5.0, -35.0], f:[0.0, 5.31, 17.5], p:[-27.0, 5.0, 0.0], s:[27.0, 5.0, 0.0]},
	{k:&quot;boa&quot;, a:[0.0, 20.5, -50.75], f:[0.0, 16.25, 23.9], p:[-7.3, 16.25, -23.9], s:[7.3, 16.25, -23.9]},
	{k:&quot;boa-mk2&quot;, a:[0.0, 22.875, -47.375], f:[0.0, 12.5, 19.4375], p:[-20.67, 11.17, -14.67], s:[20.67, 11.17, -14.67]},
	{k:&quot;cobra&quot;, a:[0.0, 7.5, -32.5], f:[0.0, 7.25, 16.25], p:[-30.0, 4.75, 0.0], s:[30.0, 4.75, 0.0]},
	{k:&quot;cobra3&quot;, a:[0.0, 7.5, -32.5], f:[0.0, 7.25, 16.25], p:[-30.0, 4.75, 0.0], s:[30.0, 4.75, 0.0]},
	{k:&quot;cobramk1&quot;, a:[0.0, 3.75, -27.5], f:[0.0, 2.925, 15.125], p:[-13.0, 3.75, 0.0], s:[13.0, 3.75, 0.0]},
	{k:&quot;ferdelance&quot;, a:[0.0, 5.0, -32.5], f:[0.0, 0.0, 9.0], p:[-16.875, 2.0, 3.5], s:[16.875, 2.0, 3.5]},
	{k:&quot;moray&quot;, a:[0.0, 8.875, 5.5], f:[0.0, 4.4, 22.5], p:[-22.5, 5.25, 11.875], s:[22.5, 5.25, 11.875]},
	{k:&quot;morayMED&quot;, a:[0.0, 8.875, 5.5], f:[0.0, 4.4, 22.5], p:[-22.5, 5.25, 11.875], s:[22.5, 5.25, 11.875]},
	{k:&quot;python&quot;, a:[0.0, 15.0, -49.5], f:[0.0, 10.0, 31.5], p:[-16.0, 4.0, 15.2], s:[16.0, 4.0, 15.2]},
	//custom ships
	{k:&quot;base&quot;, a:[0.0, 500.0, -400.0], f:[0.0, 3.0, 320.0], p:[-60.0, 3.0, 0.0], s:[60.0, 3.0, 0.0]},
	{k:&quot;corvette&quot;, a:[0.0, 6.0, -16.5], f:[0.0, 3.0, 16.5], p:[-5.0, 2.0, 0.0], s:[5.0, 2.0, 0.0]},
	{k:&quot;cruiser&quot;, a:[0.0, 3.0, -120.0], f:[0.0, 3.0, 120.0], p:[-60.0, 3.0, 0.0], s:[60.0, 3.0, 0.0]},
	{k:&quot;drone&quot;, a:[0.0, 5.0, -6.5], f:[0.0, 3.0, 9.5], p:[-2.5, 2.0, 0.0], s:[2.5, 2.0, 0.0]},
	{k:&quot;freighter&quot;, a:[0.0, 3.0, -120.0], f:[0.0, 3.0, 120.0], p:[-60.0, 3.0, 0.0], s:[60.0, 3.0, 0.0]},
	{k:&quot;frigate&quot;, a:[0.0, 30.0, -50.0], f:[0.0, 3.0, 50.0], p:[-30.0, 0.0, 0.0], s:[30.0, 0.0, 0.0]},
	{k:&quot;fighter&quot;, a:[0.0, 6.0, -16.5], f:[0.0, 3.0, 16.5], p:[-5.0, 2.0, 0.0], s:[5.0, 2.0, 0.0]},
	{k:&quot;gunship&quot;, a:[0.0, 6.0, -16.5], f:[0.0, 3.0, 16.5], p:[-5.0, 2.0, 0.0], s:[5.0, 2.0, 0.0]},
	{k:&quot;miner&quot;, a:[0.0, 30.0, -50.0], f:[0.0, 3.0, 50.0], p:[-30.0, 0.0, 0.0], s:[30.0, 0.0, 0.0]},
	{k:&quot;runner&quot;, a:[0.0, 6.0, -16.5], f:[0.0, 3.0, 16.5], p:[-5.0, 2.0, 0.0], s:[5.0, 2.0, 0.0]},
	];
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/telescope.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;telescope&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;Telescope mark all visible ships, show vitrual model, sniper ring and more.&quot;;

//customizable properties
this.$TelescopeAutoScan = true; //check continually for new isVisible isPiloted target and scan if found
this.$TelescopeAutoScanMaxRange = 1000000; //meters, how far targets will be reported
this.$TelescopeAutoLock = 1; //if no target and something in crosshairs with max. this degree diff., 1=lightball size, 0=off
this.$TelescopeFarStatus = false; //red ball reveal pirates over normal scanner if true
this.$TelescopeGravLock = 20; //gravity scanner relock in this degree cone (0-180, 20=about the screen)
this.$TelescopeIdentLock = 180; //if ident pressed or target lost then lock in this degree (0-180, 180=the whole sphere)
this.$TelescopeLargeLightBalls = false; //lightballs are increasing depending on the distance or remains small
this.$TelescopeLightBalls = true; //turn on or off all lightballs, but markes on the scanner will be remain
this.$TelescopeMassLockBorders = true; //coloured circles around ships and planets in green alert
this.$TelescopeBrightMassLockBorders = false; //brighter circles around ships and planets in green alert
this.$TelescopeRedAlertDist = 30000; //show lollipops in red alert within this distance only
this.$TelescopeRedAlertLimiter = false; //a bit more FPS in dogfight if true but show all marks with weapons off only
this.$TelescopeRing = true; //show a ring around the visual target
this.$TelescopeShipLightBalls = true; //turn on or off the lightballs with scanner markers of the ships, but cargo, etc. remain
this.$TelescopeShowVisualQuestionMark = false; //if a ship has no visual model in effecdata.plist show a big &quot;?&quot; model
this.$TelescopeShowVisualStation = true; //show or not show the 3D model of the targeted station
this.$TelescopeShowVisualTarget = true; //show 3D model of target if weapons are on (except stations if VisualStation false)
this.$TelescopeSniperMinRange = 10000; //meters, show sniper ring if the target is over this distance
this.$TelescopeSniperRange = 30000; //meters, if the target is inside then show sniper ring and large lightball
this.$TelescopeSniperRingSize = 2; //size of the sniper ring (between 1 and 5, default: 2)
this.$TelescopeSteering = 2; //auto steering if lock nearest or step in the target list with activate, 1:nearest only
this.$TelescopeTargets = 200; //limitable to reduce FPS drop in systems with many ships, min. 4, max. 200 due to VFCBM0-VFCBM49
this.$TelescopeThargoids = false; //you will get some aliens right after undock to test Telescope
this.$TelescopeVMarkMinDist = 3000; //meters, if target is inside then remove the lightball marker
this.$TelescopeVMarkShipMinDist = 5000; //meters, if target is ship and inside this range then remove the lightball marker
this.$TelescopeVPosHUD = [0, 0, 0]; //position shift for your HUD&#39;s built-in visual target screen if any
this.$TelescopeVSize = 4; //size of the visual target with online weapons (between 0 and 10, default: 4)
this.$TelescopeVZoomSize = 6; //zoomed size of the visual target with offline weapons (between 0 and 10, default: 6)

//internal properties, should not touch
this.$TelescopeAttackers = []; //ships attacked player regardless of success
this.$TelescopeAttackeri = 0; //store the sequential number of the last attacker in the target list
this.$TelescopeBuyMsg = true; //flag to show the buy message once
this.$TelescopeCMFD = null; //store the worldScripts pointer of Combart MFD
this.$TelescopeDataKeys77 = [&quot;adder&quot;, //dataKeys with 77 suffix in effectdata.plist for Oolite 1.77
	&quot;alloy&quot;, &quot;anaconda&quot;, &quot;arc-detail&quot;, &quot;asp&quot;, &quot;asp-cloaked&quot;, &quot;asteroid&quot;, &quot;asteroid-alternative&quot;,
	&quot;oolite-cinder&quot;, &quot;oolite-cinder-alternative&quot;, &quot;oolite-cinder-small&quot;, &quot;oolite-cinder-small-alternative&quot;,
	&quot;barrel&quot;,&quot;boa&quot;, &quot;boa-mk2&quot;, &quot;boulder&quot;, &quot;boulder-alternative&quot;, &quot;buoy&quot;, &quot;buoy-witchpoint&quot;,
	&quot;cloaking-device&quot;, &quot;cobra3-trader&quot;, &quot;cobra3-alternate&quot;, &quot;cobra3-pirate&quot;, &quot;cobramk1&quot;,
	&quot;cobramk1-alt&quot;, &quot;cobramk1-miner&quot;, &quot;constrictor&quot;, &quot;coriolis-station&quot;, &quot;dock&quot;,
	&quot;dock-flat&quot;, &quot;oolite-dock-virtual&quot;, &quot;dodecahedron-station&quot;, &quot;ecm-proof-missile&quot;,
	&quot;escape-capsule&quot;, &quot;ferdelance&quot;, &quot;gecko&quot;, &quot;hermit-docking-slit&quot;, &quot;hermitage&quot;, &quot;icosahedron-station&quot;,
	&quot;krait&quot;, &quot;mamba&quot;, &quot;mamba-escort&quot;, &quot;missile&quot;, &quot;moray&quot;, &quot;morayMED&quot;, &quot;oolite-unknown-ship&quot;,
	&quot;python&quot;, &quot;python-blackdog&quot;, &quot;python-trader&quot;, &quot;qbomb&quot;, &quot;rock-hermit&quot;, &quot;scarred-alloy&quot;,
	&quot;shuttle&quot;, &quot;sidewinder&quot;, &quot;sidewinder-escort&quot;, &quot;splinter&quot;, &quot;splinter-alternative&quot;, &quot;strut&quot;,
	&quot;tharglet&quot;, &quot;thargoid&quot;, &quot;transporter&quot;, &quot;transporter-miner&quot;, &quot;viper&quot;, &quot;viper-interceptor&quot;,
	&quot;viper-pursuit&quot;, &quot;worm&quot;, &quot;worm-miner&quot;, &quot;wreckage-component&quot;, &quot;more-wreckage2&quot;,
	&quot;more-wreckage3&quot;, &quot;more-wreckage4&quot;, &quot;more-wreckage5&quot;, &quot;ballturret&quot;];
this.$TelescopeFixedTel = 0; //cheaply fixed Telescope with drawbacks
this.$TelescopeFixedGS = 0; //cheaply fixed Gravity Scanner with drawbacks
this.$TelescopeFixedSD = 0; //cheaply fixed Small Dish with drawbacks
this.$TelescopeFixedLD = 0; //cheaply fixed Large Dish with drawbacks
this.$TelescopeGSC = 0; //Gravity Scan counter to call aliens
this.$TelescopeGSP = 0; //Gravity Scan percent counter store the progress of the gravity scan
this.$TelescopeIdentUnLock = false; //flag to steering started by ident, next press will unlock
this.$TelescopeList = []; //list of the scanned ships
this.$TelescopeListFar = []; //list of the scanned far ships
this.$TelescopeListFarPos = []; //positions of the scanned far ships at the moment of the scan
this.$TelescopeListGD = []; //gravity scanner maximal detection distances of the scanned ships
this.$TelescopeListPos = []; //positions of the scanned ships at the moment of the scan
this.$TelescopeListi = 0; //sequential number of the currently selected ship in the list
this.$TelescopeMaxRange = 1000000000000000; //10^15m, usable part of double precision for filteredEntities
this.$TelescopeMMarks = []; //visual effects to mark the masslocking fields around NPC ships
this.$TelescopeMRings = []; //mark the border of masslock fields
this.$TelescopeNearestd = this.$TelescopeMaxRange; //store the distance of the nearest ship in the list (updated in TimedVMC)
this.$TelescopeNearesti = 0; //store the sequential number of the nearest ship in the list (updated in TimedVMC)
this.$TelescopePlanetNames = []; //cache of names
this.$TelescopePrevHeading = []; //heading vector of the player ship in the previous frame to detect manual steering
this.$TelescopePrevNewTarget = null; //bugfix against repeated scan if a ship can not get into the list by any reason
this.$TelescopePrevMFDTarget = null; //support for Combat MFD
this.$TelescopePrevTargetAcq = null; //bugfix against repeated scan if a ship can not get into the list by any reason
this.$TelescopePrevWho = null; //bugfix against non-lockable Military Jammer awarded by ShipVersion to avoid repeated scan
this.$TelescopePrevPlanet = null; //bugfix against target switch but name remain old if new planet is within scanner range
this.$TelescopeReds = []; //store red ships detected earlier
this.$TelescopeSoundScan = null; //scan soundsource
this.$TelescopeStaionNearby = true; //store a station is nearby for gravity scanner
this.$TelescopeSteerFCB = null; //auto steering framecallback
//this.$TelescopeSniperRing = null; //if this ring guided around the crosshair then the far target is lined up correctly
this.$TelescopeSVSync = false; //flag to synhronize the visual effect during auto steering
this.$TelescopeTarget = null; //the targeted entity, needed when target is far and player target set to the markership
this.$TelescopeTargetSet = false; //flag scanning to avoid double scan
this.$TelescopeGravLock2 = this.$TelescopeGravLock; //ident press will switch this between 1 and GravLock
this.$TelescopeTimerA = null; //set player target a bit later to avoid relock the ship in crosshair (bugfix)
this.$TelescopeTimerF = null; //delayed launch of FCBs, must after FarPlanets FCB
this.$TelescopeTimerS = null; //AutoScan timer get targets from normal scanner and do scan if new far target in the front view
this.$TelescopeTWS = null; //store the worldScripts pointer of Towbar
//this.$TelescopeV = null; //visual effect to show the selected target
//this.$TelescopeVDataKey = null; //key of the visual effect
this.$TelescopeVFCB = null; //visual model and ring positions updated in these framecallbacks
this.$TelescopeVFCB2 = null; //visual model and ring positions updated in these framecallbacks part 2 to avoid timelimit
this.$TelescopeVFCB3 = null; //visual model and ring positions updated in these framecallbacks part 3 to avoid timelimit
this.$TelescopeVFCBM = []; //visual marker positions updated in these framecallbacks
this.$TelescopeVMark = null; //visual effect to mark the target
this.$TelescopeVMarks = []; //visual effects to mark the non-current targets
//this.$TelescopeVMCC = 0; //counter to make colour of the visual marks, used to do once in a second within a 0.25s timer
this.$TelescopeVMCs = []; //colour of the visual marks
this.$TelescopeVP = { //default view_positions if shiplib.js is missing
	aft:[0.0, 7.5, -32.5], forward:[0.0, 7.25, 16.25], port:[-30.0, 4.75, 0.0], starboard:[30.0, 4.75, 0.0]};
this.$TelescopeVPos = null; //position of the visual effect
//this.$TelescopeVRing = null; //a ring around the visual effect target
//this.$TelescopeVShrinkC = 0; //visual effect shrink counter - shrink code is not ready, leave these at 0
//this.$TelescopeVShrinkDelay = 0; //in sec after the larger visual target start shrinkig to normal size (0: instant)
//this.$TelescopeVShrinkLength = 0; //in sec, shrinking faster if smaller (0: instant)
//this.$TelescopeVUp = 0; //visual effect align to top modifier
//this.$TelescopeWps = true; //the previous state of the player weapons
//this.$TelescopeZoom = 1; //store the original maximal zoom level of the visual effect

//world script events
this.startUp = function() {
	var h = worldScripts.hudselector;
	if( h &amp;&amp; h.$HUDSelectorAddMFD ) h.$HUDSelectorAddMFD(this.name);
	var ps = player.ship;
	if( ps.setMultiFunctionText )
		ps.setMultiFunctionText(this.name, &quot;No Telescope Target&quot;, false);

	this.$TelescopeSoundScan = new SoundSource();
	this.$TelescopeSoundScan.sound = &quot;ScanSound.ogg&quot;; //sound of the Gravity Scanner
	this.$TelescopeSoundScan.loop = false;
	this.$TelescopeSoundScan.repeatCount = 1;
	this.$TelescopeBuyMsg = true; //show again after reload
	this.$TelescopePlanetNames = []; //cache of names
	this.$TelescopeReds = []; //store red ships detected earlier
	this.$TelescopeCMFD = worldScripts.combat_MFD; //store the worldScripts pointer of Combart MFD
	this.$TelescopeTWS = worldScripts.towbar; //store the worldScripts pointer of Towbar
	
	var subitem = missionVariables.$TelescopeMenuLightballs;
	if( subitem &gt; 0 ) this.$Telescope_SetLightballs( subitem );
	subitem = missionVariables.$TelescopeMenuSniper;
	if( subitem &gt; 0 ) this.$Telescope_SetSniper( subitem );
	subitem = missionVariables.$TelescopeMenuSteering;
	if( subitem &gt; 0 ) this.$Telescope_SetSteering( subitem );
	subitem = missionVariables.$TelescopeMenuTargets;
	if( subitem &gt; 0 ) this.$Telescope_SetTargets( subitem );
	subitem = missionVariables.$TelescopeMenuVisual;
	if( subitem &gt; 0 ) this.$Telescope_SetVisual( subitem );
	subitem = missionVariables.$TelescopeMenuVisualSize;
	if( subitem &gt; 0 ) this.$Telescope_SetVisualSize( subitem );
	
	var ws = worldScripts.telescope;
	ws._FBC_closures();
 	if( ws.$FBC_closures )								// once done
		delete ws._FBC_closures;						// remove ability to create a 2nd ones!
	else
		log(&#39;telescope&#39;, &#39;startUp, failed to create $FBC_closures!&#39; );
}

this.$FBC_closures = false;
this._FBC_closures = function() {	// create closure &amp; expose functions
	var ws = worldScripts.telescope;
	ws.$Telescope_TimedS = ws._TimedS_closure();
	ws.$Telescope_VFCBVisualTarget = ws._VFCBVisualTarget_closure();
	
	var vc = ws._VFCB_closure();
	ws.$Telescope_VClearS = vc.clear;
	ws.$Telescope_VShow = vc.show;
	ws.$Telescope_VFCB = vc.fcb;

	vc = ws._VFCB2_closure();
	ws._clearSniperRing = vc.clear;
	ws.$Telescope_VFCB2 = vc.fcb;

	ws.$FBC_closures = true;
}

this.equipmentDamaged = this.equipmentDestroyed = function(equipment) {
	if( equipment === &quot;EQ_TELESCOPE&quot; || equipment === &quot;EQ_GRAVSCANNER&quot;
		|| equipment === &quot;EQ_GRAVSCANNER2&quot; || equipment === &quot;EQ_SMALLDISH&quot; || equipment === &quot;EQ_LARGEDISH&quot; )
		worldScripts.telescope.$Telescope_NewList(); //remove lost targets, autoscan will scan again
}

this.equipmentRepaired = function(equipment) {
	//Do not use &quot;false&quot; in missionVariables! Will return true! Use 0 and 1 instead!
	if(equipment === (&quot;EQ_TELESCOPE&quot;))
		this.$TelescopeFixedTel = missionVariables.$TelescopeFixedTel = 0;
	else if(equipment === (&quot;EQ_GRAVSCANNER&quot;))
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 0;
	else if(equipment === (&quot;EQ_GRAVSCANNER2&quot;))
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 0;
	else if(equipment === (&quot;EQ_SMALLDISH&quot;))
		this.$TelescopeFixedLD = missionVariables.$TelescopeFixedSD = 0;
	else if(equipment === (&quot;EQ_LARGEDISH&quot;))
		this.$TelescopeFixedLD = missionVariables.$TelescopeFixedLD = 0;
}

this.playerBoughtEquipment = function(equipmentKey) {
	var ps = player.ship;
	if(equipmentKey === (&quot;EQ_TELESCOPE&quot;))
		this.$TelescopeFixedTel = missionVariables.$TelescopeFixedTel = 0;
	else if(equipmentKey === (&quot;EQ_GRAVSCANNER&quot;))
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 0;
	else if(equipmentKey === (&quot;EQ_GRAVSCANNER2&quot;))
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 0;
	else if(equipmentKey === (&quot;EQ_SMALLDISH&quot;))
		this.$TelescopeFixedSD = missionVariables.$TelescopeFixedSD = 0;
	else if(equipmentKey === (&quot;EQ_LARGEDISH&quot;))
		this.$TelescopeFixedLD = missionVariables.$TelescopeFixedLD = 0;
	else if(equipmentKey === (&quot;EQ_TELESCOPE_REPAIR&quot;))      {
		ps.setEquipmentStatus(&quot;EQ_TELESCOPE&quot;, &quot;EQUIPMENT_OK&quot;);
		ps.removeEquipment(&quot;EQ_TELESCOPE_REPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedTel = missionVariables.$TelescopeFixedTel = 1; //with drawback (lightballs only)
	}
	else if(equipmentKey === (&quot;EQ_TELESCOPE_FULLREPAIR&quot;))      {
		ps.removeEquipment(&quot;EQ_TELESCOPE_FULLREPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedTel = missionVariables.$TelescopeFixedTel = 0;
	}
	else if(equipmentKey === (&quot;EQ_GRAVSCANNER_REPAIR&quot;))      {
		ps.setEquipmentStatus(&quot;EQ_GRAVSCANNER&quot;, &quot;EQUIPMENT_OK&quot;);
		ps.removeEquipment(&quot;EQ_GRAVSCANNER_REPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 1; //with drawback (misjump)
	}
	else if(equipmentKey === (&quot;EQ_GRAVSCANNER2_REPAIR&quot;))      {
		ps.setEquipmentStatus(&quot;EQ_GRAVSCANNER2&quot;, &quot;EQUIPMENT_OK&quot;);
		ps.removeEquipment(&quot;EQ_GRAVSCANNER2_REPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 1; //with drawback (misjump)
	}
	else if(equipmentKey === (&quot;EQ_GRAVSCANNER_FULLREPAIR&quot;) || equipmentKey === (&quot;EQ_GRAVSCANNER2_FULLREPAIR&quot;) ) {
		ps.removeEquipment(equipmentKey);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS = 0;
	}
	else if(equipmentKey === (&quot;EQ_SMALLDISH_REPAIR&quot;))      {
		ps.setEquipmentStatus(&quot;EQ_SMALLDISH&quot;, &quot;EQUIPMENT_OK&quot;);
		ps.removeEquipment(&quot;EQ_SMALLDISH_REPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedSD = missionVariables.$TelescopeFixedSD = 1; //with drawback (break during jump)
	}
	else if(equipmentKey === (&quot;EQ_LARGEDISH_REPAIR&quot;))      {
		ps.setEquipmentStatus(&quot;EQ_LARGEDISH&quot;, &quot;EQUIPMENT_OK&quot;);
		ps.removeEquipment(&quot;EQ_LARGEDISH_REPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedLD = missionVariables.$TelescopeFixedLD = 1; //with drawback (break during jump)
	}
	else if(equipmentKey === (&quot;EQ_SMALLDISH_FULLREPAIR&quot;))      {
		ps.removeEquipment(&quot;EQ_SMALLDISH_FULLREPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedSD = missionVariables.$TelescopeFixedSD = 0;
	}
	else if(equipmentKey === (&quot;EQ_LARGEDISH_FULLREPAIR&quot;))      {
		ps.removeEquipment(&quot;EQ_LARGEDISH_FULLREPAIR&quot;);
		clock.addSeconds(&quot;3600&quot;);
		this.$TelescopeFixedLD = missionVariables.$TelescopeFixedLD = 0;
	}
	else if( equipmentKey.substr(-7,7) === &quot;_REFUND&quot; ) { 
		//any eq which end with _REFUND means full refund the eq named before
		ps.removeEquipment( equipmentKey ); //remove the &quot;bought&quot; refund eq
		var eq = equipmentKey.substr( 0, equipmentKey.length-7 );//the real eq
		if( ps.equipmentStatus( eq ) === &quot;EQUIPMENT_OK&quot; )
			worldScripts.telescope.$Telescope_RefundEQ( eq );
		else if( ps.equipmentStatus( eq ) === &quot;EQUIPMENT_DAMAGED&quot; ) //need check to avoid message at refund
			player.consoleMessage(&quot;Need repair first&quot;); //do not get full price back for a damaged eq
		return;
	}
}

this.shipBeingAttacked = function(whom) {
	if( whom &amp;&amp; whom.isValid ) {
		var ws = worldScripts.telescope;
		if( ws._index_in_list( whom, ws.$TelescopeAttackers ) === -1 )
			ws.$TelescopeAttackers.push(whom); //add
		var i = ws._index_in_list( whom, ws.$TelescopeList );
		if( i &gt; -1 ) ws.$TelescopeAttackeri = i + 1; //save last attacker
	}
}

this.shipBeingAttackedUnsuccessfully = function(whom) {
	if( whom &amp;&amp; whom.isValid ) {
		var ws = worldScripts.telescope;
		if( ws._index_in_list( whom, ws.$TelescopeAttackers ) === -1 )
			ws.$TelescopeAttackers.push(whom); //add
		var ai = ws.$TelescopeAttackeri;
		if( ai &gt; 0 ) {
			var a = ws.$TelescopeList[ ai - 1 ]; //if previous attacker is destroyed or too far
			if( !a || !a.isValid || !a.isVisible ) ai = ws.$TelescopeAttackeri = 0;
		}
		if( ai === 0 ) {
			var i = ws._index_in_list( whom, ws.$TelescopeList );
			if( i &gt; -1 ) ws.$TelescopeAttackeri = i + 1; //save attacker
		}
	}
}

this.shipKilledOther = function(whom /*,damageType*/) {
	var ws = worldScripts.telescope;
	var i = ws._index_in_list( whom, ws.$TelescopeList );
	if( i &gt; -1 ) ws.$Telescope_Scan();//forced rescan to remove from the list
}

this.shipLaunchedFromStation = function() {
	var ps = player.ship;
	this.$TelescopeFixedTel = missionVariables.$TelescopeFixedTel;
//	if(this.$TelescopeFixedTel) log(&quot;Telescope&quot;, &quot;FixedTel &quot;+this.$TelescopeFixedTel);
	this.$TelescopeFixedGS = missionVariables.$TelescopeFixedGS;
//	if(this.$TelescopeFixedGS) log(&quot;Telescope&quot;, &quot;FixedGS &quot;+this.$TelescopeFixedGS);
	this.$TelescopeFixedSD = missionVariables.$TelescopeFixedSD;
//	if(this.$TelescopeFixedSD) log(&quot;Telescope&quot;, &quot;FixedSD &quot;+this.$TelescopeFixedSD);
	this.$TelescopeFixedLD = missionVariables.$TelescopeFixedLD;
//	if(this.$TelescopeFixedLD) log(&quot;Telescope&quot;, &quot;FixedLD &quot;+this.$TelescopeFixedLD);
	this.$TelescopeGSC = missionVariables.$TelescopeGSC; //Gravity Scan counter to call aliens
	if( !this.$TelescopeGSC ) this.$TelescopeGSC = 0; //start to count gravity scans
	this.$TelescopeGSP = 0; //begin new gravity detection process
	var ws = worldScripts.telescope;
	ws.$Telescope_NewList();
	ws.$TelescopeAttackers = [];
//	if( ps.equipmentStatus(&quot;EQ_TELESCOPE&quot;) == &quot;EQUIPMENT_OK&quot; ) {
//		if( ps &amp;&amp; ps.weaponsOnline 
//			&amp;&amp; ps.equipmentStatus(&quot;EQ_GRAVSCANNER&quot;) == &quot;EQUIPMENT_OK&quot; )
//			player.consoleMessage(&quot;Turn off weapons for Gravity Scan.&quot;,10);
////		ws.$Telescope_Scan();//forced rescan
//	}

//	if( ws.$TelescopeV &amp;&amp; ws.$TelescopeV.isValid ) {
//;		log(&quot;Telescope&quot;, &quot;shipLaunchedFromStation V:&quot;+ws.$TelescopeV);//debug
		ws.$Telescope_VClear();
//		ws.$TelescopeV.remove();
//		var i = system.allVisualEffects.indexOf( this.$TelescopeV );
//		if( i &gt; -1 ) system.allVisualEffects[i].remove();
//	}
	if( ps.viewPositionForward ) { //from oolite v1.79
		ws.$TelescopeVPos = ps.viewPositionForward;
	} else  {
		var p = new Vector3D(0,0,0);
		if( worldScripts.shiplib &amp;&amp; worldScripts.shiplib.$ShipLibVP ) {
			var l = worldScripts.shiplib.$ShipLibVP; //view_position
			var d = 0; //0. line contains the default data
			for( var i = 1; i &lt; l.length; i++ )
				if( ps.dataKey &amp;&amp; l &amp;&amp; l[i]
					&amp;&amp; ws._index_in_list( l[i].k, ps.dataKey ) &gt; -1 ) {
					d = i; //found
					i = l.length; //end of for
				}
//			player.consoleMessage(l[d].f[0]+&quot; &quot;+l[d].f[1]+&quot; &quot;+l[d].f[2]);//debug
			p = new Vector3D( l[d].f[0], l[d].f[1], l[d].f[2] );
		} else {
			var p1 = ws.$TelescopeVP;
			p = new Vector3D( p1.forward[0], p1.forward[1], p1.forward[2] );
		}
//		player.consoleMessage(p,10);//debug
		ws.$TelescopeVPos = p; //save corrected position
	}
//	if( worldScripts[&quot;genericHUDswitch - MilHUD.js&quot;] ) { //was in MilHUD 0.9, removed in 0.92
//		ws.$TelescopeVPos = ws.$TelescopeVPos.add([20,-25,70]);
//		ws.$TelescopeRing = false; //do not show the ring around visual target
//		ws.$TelescopeVSize = 1; //zoomed size of the visual target
//		ws.$TelescopeVZoomSize = 1; //zoomed size of the visual target
//	} else
	ws.$TelescopeVPos = ws.$TelescopeVPos.add(ws.$TelescopeVPosHUD); //custom HUD position
	ws.$Telescope_Scan(); //need to avoid list all ship name as newship
	ws.$Telescope_StartTimer( 0 ); //no delay
}

this.shipScoopedOther = function(whom) {
//      var w = worldScripts[&quot;telescope&quot;].$TelescopeList [worldScripts[&quot;telescope&quot;].$TelescopeListi - 1 ];
//      log(&quot;Telescope&quot;, &quot;Scooped &quot;+w.isValid+w.name+&quot; VMark:&quot;+worldScripts[&quot;telescope&quot;].$TelescopeVMark); //debug
	var ws = worldScripts.telescope;
	if( ws.$TelescopeVMark &amp;&amp; whom === ws.$TelescopeList [ ws.$TelescopeListi - 1 ] ) { //remove shadowmarker if targeted
		ws.$TelescopeVMark.remove();
		ws.$TelescopeVMark = null;
	}
}

this.shipSpawned = function(ship) { //detect missile launch immediately
//	ship.setScript(&quot;oolite-default-ship-script.js&quot;);//debug
	var ps = player.ship;
	if( !ps || !ps.isValid || ps.docked //player died or docked
		|| !worldScripts.telescope.$TelescopeTimerS //no timer means in witchspace
		|| !ship || !ship.isValid || ship.isVisualEffect //invalid or effect
		|| !ship.dataKey || ship.dataKey === &quot;telescopemarker&quot; //planet or marker
		|| !ship.isWeapon ) //missile and mine only
		return; //means no scan needed
	var distance = ps.position.distanceTo( ship.position );
	if( distance &lt; ps.scannerRange ) //ship in range
		worldScripts.telescope.$Telescope_Scan();//forced rescan to see launched missiles
}

this.shipTargetAcquired = function(target) { //if locked target by hand then set as the actual item in the list
//		player.ship.targetSystem = 147;

//	player.consoleMessage(target.name+&quot; &quot;+target.isBeacon);//debug
//	var a = system.allShips; var s = &quot;&quot;;//debug
//	for( var i = 0; i &lt; a.length; i++) s+=a[i]+&quot;\n&quot;;//debug
//;	log(&quot;Telescope&quot;, a.length+&quot; Ships &quot;+s);//debug
//	a = system.allVisualEffects; s = &quot;&quot;;//debug
//	for( var i = 0; i &lt; a.length; i++) s+=a[i]+&quot;\n&quot;;//debug
//	log(&quot;Telescope&quot;, a.length+&quot; VEffs &quot;+s);//debug
//	a = system.filteredEntities(this, this.$Telescope_True, player.ship, player.ship.scannerRange); s = &quot;&quot;;//debug
//	for( var i = 0; i &lt; a.length; i++) { s+=a[i]+&quot;\n&quot;; if(!a[i].isPlayer &amp;&amp; !a[i].isStation) a[i].remove(); }//debug
//	log(&quot;Telescope&quot;, a.length+&quot; Nears: &quot;+s);//debug
	if(!target || !target.isValid || this.$TelescopeTargetSet === true ) return;
		//no target or just set in $Telescope_Show() or list is empty
//	log(&quot;Telescope&quot;, &quot;TargetAcq: &quot;+target);//debug
	var i = -1;
	var ws = worldScripts.telescope;
	if( target &amp;&amp; target.dataKey &amp;&amp; target.dataKey === &quot;telescopemarker&quot; ) { //planet marker?
		i = ws.$TelescopeListi;
		ws.$TelescopeTarget = ws.$TelescopeList [ i - 1 ];
	} else ws.$TelescopeTarget = target; //save the real target
	if( i &lt; 0 &amp;&amp; ws.$TelescopeList &amp;&amp; ws.$TelescopeList.length &gt; 0 )
		i = ws._index_in_list( target, ws.$TelescopeList ); //find target in list
	if( i &lt; 0 &amp;&amp; target &amp;&amp; target.isValid //not found, refresh the list (usually the target spawned after the last scan)
		&amp;&amp; target !== ws.$TelescopePrevTargetAcq ) { //Military Jammer bugfix
//;		log(&quot;Telescope&quot;, &quot;ScanTA: &quot;+target+&quot; - &quot;+ws.$TelescopePrevTargetAcq);//debug
		ws.$TelescopePrevTargetAcq = target; //store to avoid repeated scan
		ws.$Telescope_Scan(); //rescan
//		ws.$Telescope_List3(0, true, true); //free refresh from the normal scanner - need fix, removed
		i = ws._index_in_list( target, ws.$TelescopeList ); //find target in list
		if( i &lt; 0 ) ws.$TelescopeListi = 0; //target not in list
	}
	if( ( ws.$TelescopeShowVisualTarget || !player.ship.weaponsOnline )
		&amp;&amp; ws.$TelescopeFixedTel !== 1 ) {
		//player.consoleMessage(i);//debug
		if( i &gt;= 0) { //found
			ws.$TelescopeListi = i + 1;
			ws.$Telescope_Show2( false );
		} else {
//;			log(&quot;Telescope&quot;,&quot;shipTargetAcquired i:&quot;+i+&quot; ti:&quot;+ws.$TelescopeListi);
			ws.$Telescope_VShow();
		}
	}
}

this.shipTargetLost = function(losttarget) {
//;	log(&quot;Telescope&quot;, &quot;Losttarget: &quot;+losttarget);//debug
	var ws = worldScripts.telescope;
	ws.$TelescopeTarget = null; //must to clear
	if( ws.$TelescopeTargetSet === true //set by script or disabled
		|| ws.$TelescopeIdentLock === 0 ) return;
	var lostvalid = false; //target destroyed
	if( losttarget &amp;&amp; losttarget.isValid ) lostvalid = true; //target not destroyed but lost by ident keypress
	ws.$Telescope_MostCentered( null, &quot;ident&quot;, lostvalid ); //lock-unlock target
}

this.shipWillEnterWitchspace = function() {
	var ps = player.ship;
	this.$TelescopeReds = []; //store red ships detected earlier
	if( this.$TelescopeFixedGS === 1 &amp;&amp; Math.random() &gt; 0.5 ) {
		ps.scriptedMisjump = true; //meet Thargoids due to the cheap Grav.Sc. repair
		player.consoleMessage(&quot;Gravity Scanner caused misjump!&quot;);
	}
	if( this.$TelescopeFixedSD === 1 &amp;&amp; Math.random() &gt; 0.2 ) {
		ps.setEquipmentStatus(&quot;EQ_SMALLDISH&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
		player.consoleMessage(&quot;Small Dish damaged during hyperjump!&quot;, 10);
	}
	if( this.$TelescopeFixedLD === 1 &amp;&amp; Math.random() &gt; 0.2 ) {
		ps.setEquipmentStatus(&quot;EQ_LARGEDISH&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
		player.consoleMessage(&quot;Large Dish damaged during hyperjump!&quot;, 10);
	}
	this.shipWillDockWithStation();
}

this.shipWillDockWithStation = function() {
	var ws = worldScripts.telescope;
	ws.$Telescope_NewList();
	ws.$TelescopeAttackers = [];
	ws.$Telescope_VClear();
	if( isValidFrameCallback( ws.$TelescopeVFCB ) )
		removeFrameCallback( ws.$TelescopeVFCB );
	if( isValidFrameCallback( ws.$TelescopeVFCB2 ) )
		removeFrameCallback( ws.$TelescopeVFCB2 );
	if( isValidFrameCallback( ws.$TelescopeVFCB3 ) )
		removeFrameCallback( ws.$TelescopeVFCB3 );
	for(var i = 0; i &lt; ws.$TelescopeVFCBM.length; i++) {
		if( isValidFrameCallback( ws.$TelescopeVFCBM[i] ) )
			removeFrameCallback( ws.$TelescopeVFCBM[i] );
		ws.$TelescopeVFCBM[i] = null; //cag: converting to static arrays
	}
	if( ws.$TelescopeTimerS ) {
		ws.$TelescopeTimerS.stop();
		ws.$TelescopeTimerS = null;
	}
}

this.shipWillExitWitchspace = function() { //use this event due to shipExitedWitchspace is not working in v1.77
	var ws = worldScripts.telescope;
	ws.$TelescopePlanetNames = []; //cache of names
	ws.$TelescopeGSP = 0; //begin new gravity detection process
	ws.$Telescope_NewList();
	ws.$Telescope_AddShips(); //do not call shipLaunchedFromStation() to aovid a bug
	this.$TelescopeTimerF = new Timer(this, ws.$Telescope_TimedF, 1, 0); //1s delay to launch FCBs after FarPlanets FCB!
}

this.shipWillLaunchFromStation = function( /*station*/ ) {
//	player.consoleMessage(player.ship.targetSystem+&quot; &quot;+player.ship.galaxyCoordinatesInLY.x+&quot; &quot;+player.ship.galaxyCoordinatesInLY.y);//debug
//	player.ship.targetSystem = 147;//debug
	var ws = worldScripts.telescope;
	ws.$TelescopeStaionNearby = false; //to send gravscanner message after launch
	ws.$Telescope_AddShips();
}

this._index_in_list = function( item, list ) { // for arrays only; faster than indexOf 
	var k = list.length;
	while( k-- ) {
		if( list[ k ] === item ) return k;
	}
	return -1;
}

//Telescope methods
this.$Telescope_AddShips = function() { 
	if( !system.isInterstellarSpace ) { //need check due to called from shipWillExitWitchspace also
		system.addShips(&quot;shuttle&quot;, 1, system.mainStation.position, 50000);//demo visible target
		system.addShips(&quot;trader&quot;, 1, system.mainStation.position, 20000);//demo near target
		
//		system.addShips(&quot;asteroid&quot;, 10, system.mainStation.position, 20000);//test rock target
//		system.addShips(&quot;rescue_station&quot;, 1, system.mainStation.position, 20000);//test custom station
//		system.addShips(&quot;rescue_blackbox&quot;, 1, system.mainStation.position, 10000);//test custom ship
//		system.addShips(&quot;rescue_blackbox_generic&quot;, 1, system.mainStation.position, 10000);//test custom ship
//		system.addShips(&quot;stealth_base&quot;, 1, system.mainStation.position, 20000);//test custom station
//		system.addShips(&quot;stealth_barracuda&quot;, 1, system.mainStation.position, 10000);//test stealth ship
//		system.addShips(&quot;stealth_mine&quot;, 1, system.mainStation.position, 20000);//test stealth mine
//		system.addShips(&quot;vector_areidisAlpha&quot;, 1, system.mainStation.position, 20000);//test custom station
//		system.addShips(&quot;vector_arn&quot;, 1, system.mainStation.position, 10000);//test custom ship
//		system.addShips(&quot;griff_NPC_prototype_boa_decals_from_red_channel&quot;,
//			1, system.mainStation.position, 10000);//test visual effect shader uniforms, need Griff Boa OXP
		
		if( worldScripts.telescope.$TelescopeThargoids ) { //test Telescope in instant action
			system.addShips(&quot;tharglet&quot;, 4, system.mainStation.position, 30000);
			system.addShips(&quot;thargoid&quot;, 4, system.mainStation.position, 30000);
//			system.addShips(&quot;police&quot;, 4, system.mainStation.position, 30000);
			player.ship.scriptedMisjump = true; //meet Thargoids in the next hyperjump also
		}
	}
}

this.$Telescope_Angle = function( angle ) { //show the side and up viewing angle of the target
	var c = 90;
	if( angle &lt; 0 ) c = -90;
	return( Math.round( angle * 180 / Math.PI - c ) + &quot;&quot; );
}

this.$Telescope_Attacker = function(lock) { //lock on the last attacker
	var ws = worldScripts.telescope;
	var ai = ws.$TelescopeAttackeri;
	var who = ws.$TelescopeList[ ai - 1 ];
//;	log(&quot;Telescope&quot;, &quot;Attacker ai:&quot;+ai+&quot; who:&quot;+who);//debug
	if( who &amp;&amp; who.isValid &amp;&amp; who.isVisible ) { //remove if destroyed or flyed too far
		ws.$TelescopeListi = ai;
		if( lock ) ws.$Telescope_Show(); //change player target to the nearest
		return( who );
	} else {
		ws.$TelescopeAttackeri = 0; //clear to get another attacker
		return false;
	}
}

this.$Telescope_From = function(ship, whomposition) { //direction mark
//	log(&quot;Telescope_From1&quot;, &quot;ship:&quot;+ship+&quot; wp:&quot;+whomposition);//debug
	if( !ship || !ship.isValid || !whomposition || !whomposition.dot ) return (&quot;&quot;);
	var v = ship.position.subtract(whomposition);
	var fw = ship.vectorForward.angleTo(v);
	var ri = ship.vectorRight.angleTo(v);
	var up = ship.vectorUp.angleTo(v);
	var s = &quot;&quot;; // refine if out of front 1 degree cone
	if( ri &lt; 1.56 ) s += &quot;&lt;&quot;;
	if( up &gt; 1.58 ) s += &quot;^&quot;;
	else if( up &lt; 1.56 ) s += &quot;v&quot;;
	if( ri &gt; 1.58 ) s += &quot;&gt;&quot;;
//	log(&quot;Telescope_From2&quot;, &quot;v:&quot;+v+&quot; fw:&quot;+fw+&quot; ri:&quot;+ri+&quot; up:&quot;+up+&quot; s:&quot;+s);//debug
	if( s.length &gt; 0 || fw &lt; 1 ) //do not exclude the aft 1 degree cone
		s = Math.round( 180 * ( 1 - fw / Math.PI ) ) + &quot; &quot; + s;
	return( s ); //show forward angle in degrees
}

this.$Telescope_GetDetect = function(who) { //read detection from the script_info telescope entry
	var good = true; var d;
	if( who.scriptInfo || who.isStation ) {//can give custom detection distance to the target ship
		if( who.scriptInfo ) d = parseInt( who.scriptInfo.telescope );
		if( d === 0 ) good = false;
		else if( d &gt; 0 || d &lt; 0 ) good = true; //show custom station
		else if( who.isStation &amp;&amp; who.primaryRole !== &quot;station&quot; //d is NaN due to undefined scriptInfo key
			&amp;&amp; who.primaryRole !== &quot;coriolis&quot;
			&amp;&amp; who.primaryRole !== &quot;dodo&quot;
			&amp;&amp; who.primaryRole !== &quot;dodec&quot;
			&amp;&amp; who.primaryRole !== &quot;dodecahedron&quot;
			&amp;&amp; who.primaryRole !== &quot;ico&quot;
			&amp;&amp; who.primaryRole !== &quot;icosa&quot;
			&amp;&amp; who.primaryRole !== &quot;icosahedron&quot;
			&amp;&amp; who.primaryRole !== &quot;rockhermit&quot; ) {
			var ps = player.ship;
			if(ps &amp;&amp; ps.isValid) { //hide custom station over 4x scanner range
				var distance = ps.position.distanceTo(who.position);
				if( distance &gt; 4 * ps.scannerRange ) good = false;
			}
		}
	}
	//stealth ships and non-standard stations detected in normal scanner range only, requested by Svengali
	if( good &amp;&amp; ( who.dataKey &amp;&amp; ( who.dataKey.indexOf(&quot;stealth&quot;) &gt; -1 
		|| who.dataKey === &quot;vector_arn&quot; ) //mission ship in Vector OXP
		|| who.primaryRole &amp;&amp; ( who.primaryRole.indexOf(&quot;stealth&quot;) &gt; -1
		|| who.primaryRole.indexOf(&quot;rescue_blackbox&quot;) &gt; -1 ) ) ) //mission ships in Rescue Stations OXP
		good = false;
	return( good );
}

this.$Telescope_GetMass = function(entity) { //read mass from the script_info telescope_mass entry
	var em = entity.mass;
	if( entity.scriptInfo ) { //can give custom mass to the ship
		var e = parseInt(entity.scriptInfo.telescope);
		if( e &gt;= 0 ) em = e;
		else if( e &lt; 0 ) em += e; //substract the mass instead of overwrite it
		//else telescope key not present, return the original mass
//; 		log(&quot;Telescope&quot;, &quot;scriptInfo &quot;+entity.name+&quot;:&quot;+entity.scriptInfo.telescope+&quot; e:&quot;+e+&quot; mass:&quot;+em);//debug
	}
	return( em * Math.min( 1, worldScripts.telescope.$TelescopeGSP ) ); //reduce if GS not in full detection yet
}

this.$Telescope_GravOK = function() { //in the range of the Gravity Scanner if installed
	if( player.ship &amp;&amp; player.ship.equipmentStatus(&quot;EQ_GRAVSCANNER&quot;) == &quot;EQUIPMENT_OK&quot;
		&amp;&amp; worldScripts.telescope.$TelescopeStaionNearby //near a station or baseship
		&amp;&amp; !player.ship.weaponsOnline ) return true; //grav scan without weapons only to need force it
	return false;
}

this.$Telescope_InRange = function(entity) { //Visible or in normal Scanner means in Telescope range
	if( player.ship &amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPE&quot;) === &quot;EQUIPMENT_OK&quot; &amp;&amp;
		( entity.isPlanet || entity.isSun || !entity.isCloaked &amp;&amp; !entity.isVisualEffect
		&amp;&amp; ( entity.dataKey //sun and planets has no dataKey
			&amp;&amp; entity.dataKey !== &quot;telescopemarker&quot; ) //virtual target of far targets
		&amp;&amp; ( !entity.isRock || entity.isStation || entity.isPiloted ) &amp;&amp; //there are piloted &quot;rocks&quot; in lave.oxp
		( ( entity.isVisible &amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot; )
		|| entity.isBeacon || entity.beaconCode //beacons in the whole system
		|| worldScripts.telescope.$Telescope_IsScannerTarget(entity)
		|| worldScripts.telescope.$Telescope_InGravRange(entity) ) ) ) //or in grav.scanner
		return true;
	else return false;
}

this.$Telescope_InRangeFast = function(entity, listi) {
	//less check than InRange due to checked before and speed is important
	if( entity.isCloaked ) return false;
	var ps = player.ship;
	if( entity.isVisible &amp;&amp; ps.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot;
		|| entity.isBeacon || entity.beaconCode || entity.isPlanet || entity.isSun )
		return true;//beacons in the whole system
	var distance = ps.position.distanceTo(entity.position);
	if( distance &lt; ps.scannerRange ) return true; //target in the normal scanner
	var ws = worldScripts.telescope;
	if( !ws.$TelescopeListGD[ listi ] ) { //store max. grav. distance to next time check faster
		var em = ws.$Telescope_GetMass( entity );
		var gd = Math.pow( 100 * em, 1/3 );//reverse calculation of InGravRange
		if( ps.equipmentStatus(&quot;EQ_LARGEDISH&quot;) === &quot;EQUIPMENT_OK&quot; ) {
			gd = gd * 2; //large dish double range
			var pm = ws.$Telescope_GetMass( ps );
			if( pm &gt; 1000000 ) gd = gd * 2; //huge player ship double range another time
			if( pm &gt; 100000000 ) gd = gd * 2; //baseship scan double range third time
		} else if( ps.equipmentStatus(&quot;EQ_SMALLDISH&quot;) === &quot;EQUIPMENT_OK&quot; )
			gd = gd * 1.33; //small dish 1.33x range
		gd = gd * 500; //max. grav. distance of this ship in meters
		ws.$TelescopeListGD[ listi ] = gd; //store
//;		log(&quot;Telescope&quot;, &quot;InRangeFast ship:&quot;+entity.name+&quot; em:&quot;+Math.round(em)+&quot;kg gd:&quot;+Math.round(gd)+&quot;m&quot;);//debug
	}
	if( distance &lt; ws.$TelescopeListGD[ listi ] ) return true; //compare with the stored value
	return false;
}

this.$Telescope_InGravRange = function(entity) { //in the range of the Gravity Scanner if installed
	var ws = worldScripts.telescope;
	if( ws.$Telescope_GravOK()
		&amp;&amp; entity.isValid &amp;&amp; !entity.isCloaked //can not detect if cloaked
		&amp;&amp; entity.dataKey &amp;&amp; entity.dataKey !== &quot;telescopemarker&quot; //virtual target of far targets
		&amp;&amp; ( entity.isPiloted || entity.forwardWeapon ) //need to detect hostile drones from HardShips OXP
		&amp;&amp; ( !entity.isRock || entity.isStation )
		&amp;&amp; !entity.isVisualEffect ) {
		var ps = player.ship;
		var distance = ps.position.distanceTo(entity.position);
		if( distance &lt; ps.scannerRange ) return false; //near ships listed before
		if( entity.isBeacon || entity.beaconCode || entity.isPlanet || entity.isSun )
			return true; //beacons in the whole system
		var d2 = distance / 500; //in half km, = 2 * distance / 1000, keep it in sync with InRangeFast
		if( ps.equipmentStatus(&quot;EQ_LARGEDISH&quot;) === &quot;EQUIPMENT_OK&quot; ) {
			var pm = ws.$Telescope_GetMass( ps );
			if( pm.mass &gt; 100000000 ) d2 = d2 / 2; //baseship scan double range
			if( pm.mass &gt; 1000000 ) d2 = d2 / 2; //huge player ship
			d2 = d2 / 2; //others detected at double range (with huge 4x)
		} else if( ps.equipmentStatus(&quot;EQ_SMALLDISH&quot;) === &quot;EQUIPMENT_OK&quot; )
			d2 = d2 / 1.33; //small dish 1.33x range
		var em = ws.$Telescope_GetMass( entity );
		if( em &gt; d2*d2*d2/100 ) return true; //mass scaled to third power of distance
	}
	return false;
}

this.$Telescope_IsCargo = function(entity) { //Cargo, Escape Pod, Station in visible range and Beacon anywhere
	if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect ) {
		if( entity.isBeacon || entity.beaconCode ) return true; //beacons identifyed by active radio broadcast
		if( !entity.isPiloted &amp;&amp; entity.isCargo || entity.isStation
			|| entity.primaryRole &amp;&amp; entity.primaryRole === &quot;escape-capsule&quot; ) {
			if( worldScripts.telescope.$Telescope_IsVisible( entity ) )
				return true; //visible
		}
	}
	return false;
}

this.$Telescope_IsHostile = function(entity) {
	var ps = player.ship;
	var ws = worldScripts.telescope;
	if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect
		&amp;&amp; ( entity.isPiloted || entity.forwardWeapon ) //need to detect hostile drones from HardShips OXP
		&amp;&amp; ws.$Telescope_InRange( entity )
		&amp;&amp; !entity.isStation &amp;&amp; !entity.isCloaked &amp;&amp;
		( entity.target &amp;&amp; entity.target === ps //target is hostile if targeting back
		   //or in the defenseTargets
		|| ps.defenseTargets &amp;&amp; ws._index_in_list( entity, ps.defenseTargets ) &gt; -1
		   //or this ship in the defenseTargets of the other
		|| entity.defenseTargets &amp;&amp; ws._index_in_list( ps, entity.defenseTargets ) &gt; -1 )
		|| ws._index_in_list( entity, ws.$TelescopeReds ) &gt; -1 ) //pirate or thargoid
		return true;
	else return false;
}

/* this.$Telescope_IsNonHostileStaion = function(entity) {
	if( entity &amp;&amp; entity.isValid &amp;&amp; entity.isStation &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isCloaked
		&amp;&amp; entity.mass &gt; 10000000 //skip ships with docking port (except baseships), rockhermit with 53508t must fit in
		&amp;&amp; entity.target !== player.ship //target is hostile if targeting back
		   //or player is in the defenseTargets
		&amp;&amp; ( !entity.defenseTargets || entity.defenseTargets.indexOf(player.ship) === -1 ) )
		return true;
	else return false;
}
 */

 this.$Telescope_IsNotInTList = function(entity) { //asteroids, etc.
	var ws = worldScripts.telescope;
	if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isCloaked //else excluded from this list also
		&amp;&amp; !entity.isPiloted &amp;&amp; !entity.forwardWeapon &amp;&amp; !entity.isCargo //approximately not in list for speedup
		&amp;&amp; ws._index_in_list( entity, ws.$TelescopeList ) === -1 ) //surely not in list but slow alone
		return( true );
	else return( false );
}

this.$Telescope_IsPilotedShip = function(entity) { //non-hostile piloted ships
	return( entity.isValid &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isStation &amp;&amp; !entity.isPlanet &amp;&amp; !entity.isSun
		&amp;&amp; ( entity.isPiloted || entity.forwardWeapon ) //need to detect drones from HardShips OXP
		&amp;&amp; worldScripts.telescope.$Telescope_InRange( entity )
		&amp;&amp; !entity.isCloaked &amp;&amp; !this.$Telescope_IsHostile(entity) );
}

/* this.$Telescope_IsPilotedVisible = function(entity) {
	if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isCloaked
		&amp;&amp; ( entity.isPiloted || entity.forwardWeapon ) //need to detect drones from HardShips OXP
//		&amp;&amp; ( !entity.isRock || entity.isStation ) //too much asteroids, lock only in scannerRange
		&amp;&amp; (( worldScripts.telescope.$Telescope_GetDetect( entity )
			&amp;&amp; entity.isVisible &amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot; )
			|| worldScripts.telescope.$Telescope_IsScannerTarget( entity ))
	  	&amp;&amp; ( !entity.dataKey || entity.dataKey !== &quot;telescopemarker&quot; ) )
		return true;
	return false;
}
 */

// there is now a copy of this inside _TimedS_closure
this.$Telescope_IsScannerTarget = function(entity) { //call to surely detect all small targets in scanner
	var ps = player.ship;
	if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect &amp;&amp; entity.dataKey //sun and planets has no dataKey
		&amp;&amp; !entity.isCloaked &amp;&amp; ps &amp;&amp; ps.isValid ) {
		var distance = ps.position.distanceTo(entity.position);
		if( distance &lt; ps.scannerRange ) return true; //target in the normal scanner
	}
	return false;
}

this.$Telescope_IsValid = function(entity) { //help to find most centered
	if( !entity || !entity.isValid || ( !entity.dataKey &amp;&amp; !entity.isPlanet &amp;&amp; !entity.isSun ) )
		return false; //Sun and Planets has no dataKey
//	var angle = player.ship.vectorForward.angleTo(player.ship.position.subtract(entity.position));
//	log(&quot;Telescope&quot;,&quot;angle:&quot;+angle+&quot; entity:&quot;+entity.name);//debug
//	if( angle &lt; worldScripts.telescope.$TelescopeAutoLockRad ) { //in auto degree
		if( !entity.isVisualEffect || entity.dataKey &amp;&amp; entity.dataKey.indexOf(&quot;telescope-&quot;) &gt; -1 )
			return true;
//	}
	return false;
}

this.$Telescope_IsVisible = function(entity) {
	if( !entity.isVisualEffect &amp;&amp; ( entity.dataKey || entity.isPlanet || entity.isSun ) //sun and planets has no dataKey
		&amp;&amp; ( !entity.isRock || entity.isStation ) //too much asteroids, lock only in scannerRange
		&amp;&amp; !entity.isCloaked
		&amp;&amp; ( ( entity.isVisible &amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot; )
			|| worldScripts.telescope.$Telescope_IsScannerTarget(entity) ) ) return true;
	return false;
}


this.$Telescope_List = function(step) {
	//no scan if there are a list already, show again the message only
	worldScripts.telescope.$Telescope_List2(step, false);
}

this.$Telescope_List2 = function(step, forcedscan) {
	worldScripts.telescope.$Telescope_List3(step, forcedscan, false);
}

this.$Telescope_List3 = function(step, forcedscan, free) {
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //if player died
	var ws = worldScripts.telescope;
	var list = ws.$TelescopeList;
	var len = list.length;
	var ti = ws.$TelescopeListi;
	if(ps.equipmentStatus(&quot;EQ_TELESCOPE&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) {
		player.consoleMessage(&quot;Telescope damaged&quot;);
		ws.$Telescope_NewList();
	} else if(ps.equipmentStatus(&quot;EQ_TELESCOPE&quot;) !== &quot;EQUIPMENT_OK&quot;) {
		if( ws.$TelescopeBuyMsg ) {
			player.consoleMessage(&quot;Buy Telescope! (x)&quot;);
			ws.$TelescopeBuyMsg = false;
		}
		ws.$Telescope_NewList(); //needed when destroyed
		//else silent exit (no Telescope when called from shipTargetLost)
	} else {
		ws.$TelescopeTargetSet = true;
		var forcedship = null;
		if( ti &gt; 0 )
			forcedship = list[ti - 1];
//		var who = null;
		if(step &lt; 0) ws.$TelescopeListi--; //step backward in list
		else if(step &gt; 0) ws.$TelescopeListi++; //step forward in list
		ti = ws.$TelescopeListi;
//		player.consoleMessage(step+&quot; &quot;+ws.$TelescopeListi);//debug
		if( forcedscan || !list
			|| ti &lt; 1
			|| len &lt; ti ) {
			//if forced to scan or no list yet or listed all items then rescan
			if(ps.energy &lt; 64)
				player.consoleMessage(&quot;Not enough energy for Telescope&quot;);
			else {
				ws.$Telescope_NewList();
				//detect hostile ships in normal scanner
				var st = system.filteredEntities(this, this.$Telescope_IsHostile,
								 ps, ps.scannerRange);
//				var st1 = st.length;
				if(st &amp;&amp; st[0]) ws.$Telescope_ListAdd(st); //add to the list if any
				//detect non-hostile piloted ships in normal scanner
				st = system.filteredEntities(this, this.$Telescope_IsPilotedShip,
								 ps, ps.scannerRange);
//				var st2 = st.length;
				if(st &amp;&amp; st[0]) ws.$Telescope_ListAdd(st); //add to the list if any
				//detect visible cargoes, stations and all beacons
				st = system.filteredEntities(this, this.$Telescope_IsCargo,
								 ps, 2*ps.scannerRange);
//				var st3 = st.length;
				if(st &amp;&amp; st[0]) ws.$Telescope_ListAdd(st); //add to the list
				var st4 = 0;
				if( free ) { //add the previously scanned far ships
					ws.$Telescope_VFCBShrinkVMarks();//new far marks needed
					ws.$Telescope_ListAdd2(
						ws.$TelescopeListFar,
						ws.$TelescopeListFarPos ); //old positions
				} else {
					ps.energy -= 2; //use a little energy to scan the whole sky
					var sc = &quot;Telescope&quot;;
					if( ws.$Telescope_GravOK() ) {
						ps.energy -= 6; //need 4x energy with Gravity Scanner
						ws.$TelescopeSoundScan.play();//GS scan sound
						sc = &quot;Gravity scan&quot;;
						if( ws.$TelescopeGSP &lt; 1 )
							sc += &quot; &quot;+Math.round(ws.$TelescopeGSP*100)
								+&quot;% done,&quot;;
						//Gravity Scan counter to bring aliens
						missionVariables.$TelescopeGSC = ++ws.$TelescopeGSC;
						var p = 200; //at every 200. scan
						if( ws.$TelescopeFixedGS === 1 ) p = 100; //every 100. scan
						var g = ws.$TelescopeGSC / p;
						if( g === Math.floor( g ) ) {
							var n = Math.ceil( Math.pow( player.score, 0.5 ) / 10 );
							if( n &gt; 0 ) { //with 0 score do not get any
								player.consoleMessage(&quot;Aliens detected your Gravity Scan!&quot;,10);
								system.addShips(&quot;thargoid&quot;, n, ps.position, 50000);
							}
						}
					}
					ws.$Telescope_NewFarList();
					//detect ships NOT in normal scanner
					st = system.filteredEntities(this, this.$Telescope_InRange, ps,
								     ws.$TelescopeMaxRange);//to avoid bugs
					st4 = st.length;
					if(st &amp;&amp; st[0]) ws.$Telescope_ListFarAdd(st); //add to the list
					//finally planets
					st = system.planets;
					if(st &amp;&amp; st[0]) ws.$Telescope_ListFarAdd(st); //add to the list
					if( !system.isInterstellarSpace &amp;&amp; system.sun &amp;&amp; system.sun.isValid )
						ws.$Telescope_ListFarAdd(system.sun); //add sun to the end of the list
					//send message about scan
					len = ws.$TelescopeList.length;
					if( !forcedscan ) {
						var msg = &quot;No&quot;;
						if( len &gt; 0 ) msg = sc+&quot; found &quot;+len;
						var s = &quot;&quot;;
						if( len &gt; 1 ) s = &quot;s&quot;;
						player.consoleMessage(msg+&quot; target&quot;+s, 5);
					}
				}
//;		 		log(&quot;Telescope&quot;, &quot;filteredEntities: &quot;+st1+&quot;, &quot;+st2+&quot;, &quot;+st3+&quot;, &quot;+st4+&quot; list:&quot;+ws.$TelescopeList.length+&quot; allShips:&quot;+system.allShips.length);  //debug
				ws.$Telescope_TimedVMC(); //make colours to the new list
			}
		}
		if( ps.target &amp;&amp; ps.target.isValid ) {
			ti = 0;
			list = ws.$TelescopeList;
			len = list.length;
			if( forcedship &amp;&amp; ps.target.dataKey
				&amp;&amp; ps.target.dataKey === &quot;telescopemarker&quot; ) //far target
				ti  = ws._index_in_list( forcedship, list ) + 1;
			else ti = ws._index_in_list( ps.target, list ) + 1;
			if( ti &gt; 0 ) {
				if( step &lt; 0 ) {
					ti--; //step backward in list
					if( ti &lt;= 0 ) ti = len;
				} else if( step &gt; 0 ) {
					ti++; //step forward in list
					if( ti &gt; len ) ti = 1;
				}
			} else ti = 0;
			if( ti &gt; 0 ) {
				var who = list[ ti - 1 ];
				var limit = len;
				while( ws._is_ignored_ship( ws, who ) &amp;&amp; limit &gt; 0 ) {
					ti += step;
					limit--;
					if( ti &lt;= 0 ) ti = len;
					if( ti &gt; len ) ti = 1;
					who = list[ ti - 1 ];
				}
				if( limit === 0 ) ti = 0;
			}
			ws.$TelescopeListi = ti;
//			if( forcedscan ) ws.$Telescope_Show2( false ); //do not show name - removed due to a target changer bug reported by Bogatyr
			if( !forcedscan ) ws.$Telescope_Show(); //target name with list number
		} //else leave listi on 0 to do not nock anything, show lightballs only
//; 		log(&quot;Telescope&quot;, &quot;List step:&quot;+step+&quot; forcedscan:&quot;+forcedscan+&quot; listi:&quot;+ws.$TelescopeListi+&quot; ship:&quot;+ws.$TelescopeList[ws.$TelescopeListi-1]);//debug
		ws.$TelescopeTargetSet = false;
	}
}

this.$Telescope_ListAdd = function(newitems) { //add to the main list
	worldScripts.telescope.$Telescope_ListAdd2(newitems, null); //with fresh positions
}

this.$Telescope_ListAdd2 = function(newitems, pos) { //can append the old scanned far list to the new free list
	var ws = worldScripts.telescope;
	for(var i = 0; i &lt; newitems.length &amp;&amp; ws.$TelescopeList.length &lt;
		ws.$TelescopeTargets; i++) { //limited number of targets to save CPU
		var who = newitems[i]; var p;
		if( who &amp;&amp; who.isValid &amp;&amp;
			ws._index_in_list( who, ws.$TelescopeList ) === -1 ) {
			if( ws.$Telescope_GetDetect( who )
				|| ws.$Telescope_IsScannerTarget( who ) ) {
				if( pos ) p = pos[i]; //old saved position
				else p = who.position; //fresh position
				ws.$TelescopeListPos.push( p );
				ws.$TelescopeList.push(who);
			}
		}
	}
}

this.$Telescope_ListFarAdd = function(newitems) { //add to the far and main list also
	var ws = worldScripts.telescope;
	for(var i = 0; i &lt; newitems.length; i++) {
		var who = newitems[i];
		if( who &amp;&amp; who.isValid &amp;&amp;
			ws._index_in_list( who, ws.$TelescopeListFar ) === -1 ) {
			ws.$TelescopeListFarPos.push(who.position);
			ws.$TelescopeListFar.push(who);
		}
	}
	ws.$Telescope_ListAdd(newitems); //add to the main list also
}

/* this.$Telescope_MFDTarget = function(ws, ps, who) { //helper function for building MFD in TimedS
	if( who &amp;&amp; who.isValid ) {
		var v = ws.$Telescope_ShowName2(who, who.position);
		if( v &amp;&amp; v.length &gt; 0 &amp;&amp; v.indexOf(&quot;(Lost &quot;) === -1 ) {
			if( who === ps.target || //current target
				ps.target &amp;&amp; ps.target.dataKey
				&amp;&amp; ps.target.dataKey === &quot;telescopemarker&quot; //get the original target
				&amp;&amp; who === ws.$TelescopeList[ ws.$TelescopeListi - 1 ] )
				v = &quot;[ &quot;+v+&quot; ]&quot;; //mark the current target
			return( v+&quot;\n&quot; );
		}
	}
	return false;
}
 */
this.$Telescope_MostCentered = function( skiptarget, mode, lostvalid ) {
	var ws = worldScripts.telescope;
//;	log(&quot;Telescope&quot;, &quot;MostCentered &quot;+skiptarget+&quot; &quot;+mode+&quot; &quot;+lostvalid+&quot; &quot;+ws.$TelescopeIdentUnLock);//debug
	var mct = null;
	var ps = player.ship;
	//in red alert find most centered hostile first if not supressed with offline weapons
	if( player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline &amp;&amp; mode === &quot;mode&quot; ) {
//		mct = ws.$Telescope_Attacker(false); //fallback to last attacker - old method
//;		if(mct) log(&quot;Telescope&quot;, &quot;Ident lock on attacker: &quot;+mct.name);//debug
		mct = ws.$Telescope_MostCentered2( skiptarget, mode, true, true );//ships attacking player
//		log(&quot;Telescope&quot;, &quot;mct1:&quot;+mct);  //debug
		if(!mct) {
			mct = ws.$Telescope_MostCentered2( skiptarget, mode, true, false );//ships targeting player
//			log(&quot;Telescope&quot;, &quot;mct2:&quot;+mct);  //debug
		}
	}
	//if no hostile then fallback to normal check
	if(!mct) mct = ws.$Telescope_MostCentered2( skiptarget, mode, false, false );
	if( mct ) {
		if( mct.dataKey &amp;&amp; mct.dataKey === &quot;telescopemarker&quot; ) {//markership
			mct = ws.$TelescopeTarget; //the real target behind the markership
		}
		var mi = ws._index_in_list( mct, ws.$TelescopeList );
		if( mi &gt; -1 ) {
			//ident mode do unlock if pressed second time with the same most centered target
			if( mode !== &quot;ident&quot; || mi + 1 !== ws.$TelescopeListi ) {
				
//;				log(&quot;Telescope&quot;, &quot;MostCenteredTarget: &quot;+mct.name+&quot; mi:&quot;+mi);//debug
				if( !ps.weaponsOnline &amp;&amp; mode === &quot;ident&quot; ) {//restore GravLock if ident lock target
					ws.$TelescopeGravLock2 = ws.$TelescopeGravLock;
					player.consoleMessage(&quot;Panorama targeting turned ON.&quot;);
				}
				if(  ws.$TelescopeListi !== mi + 1 ) {
					ws.$TelescopeListi = mi + 1;
					ws.$Telescope_Show2( false ); //lock target
				}
			} else {
				if( mode === &quot;ident&quot; &amp;&amp; ws.$TelescopeIdentUnLock ) { //unlock target after steer (3. ident press)
					ws.$TelescopeIdentUnLock = false;
//;					log(&quot;Telescope&quot;, &quot;MCT ident unlock&quot;);//debug
					if( !ps.weaponsOnline &amp;&amp; mode === &quot;ident&quot; &amp;&amp; lostvalid ) {
						//shrink GravLock if ident unlock target by keypress and not by target destroyed
						ws.$TelescopeGravLock2 = ws.$TelescopeAutoLock;
						player.consoleMessage(&quot;Panorama targeting turned OFF.&quot;);
					}
					ws.$TelescopeListi = 0;
//the following lines cause crash to desktop in 1.77 after some fight when a targeted Tharglet is exploding
//					ws.$Telescope_VClear();
					if( ps.target ) {
//						log(&quot;Telescope&quot;, &quot;MostCenteredTarget unlock: &quot;+mct.name+&quot; mi:&quot;+mi);//debug
						ws.$TelescopeTargetSet = true;//to avoid doubled message
						ps.target = null;
						ws.$TelescopeTargetSet = false;
					}
					ws.$TelescopeTarget = null; //clear after(!) player target cleared
				} else if( mode === &quot;ident&quot;) { //second ident press start steering to the target
					ws.$TelescopeIdentUnLock = true; //next time will do unlock
					ws.$TelescopeListi = mi + 1;
					ws.$Telescope_Show2( false ); //lock target
 					if( ws.$TelescopeSteering &gt; 0 )
						if( ps.velocity.magnitude() &lt; ps.maxSpeed * 1.1 )
							//prevent unwanted steer when lost marker at high speeds
							ws.$Telescope_Steer();//turn to the target
				}
			}
		}
	}
}

this.$Telescope_MostCentered2 = function( skiptarget, mode, red, attacker ) {
	var ps = player &amp;&amp; player.ship;
	if( !ps || !ps.isValid ) return false;
	var psp = ps.position;
	var ws = worldScripts.telescope;

	function closest_to( target_vector ) {
		var min_a = rad;
		var best = -1; 		// ie. not init&#39;d
		var best_d = ws.$TelescopeMaxRange;
		var angle, distance, i;
		for( i = 0; i &lt; list.length; i++ ) { //search target near the center
			var test = list[ i ];
			if( !test || !test.isValid ) continue; // brought $Telescope_MostCenteredCheck inline
			if( test === skiptarget ) continue;
			if( red &amp;&amp; mode === &#39;ident&#39; &amp;&amp; test.target !== ps ) continue;
				// in red alert w/ mode &#39;ident&#39;, check only hostiles
			angle = target_vector.angleTo( test.position.subtract( psp ) );
			if( angle &gt; min_a ) continue;
			distance = psp.distanceTo( test.position );
			if( min_a === rad ) { // 1st target found
				best_d = distance;
				min_a = angle;
				best = i;
				continue;
			}
			if( Math.abs( angle - min_a ) &lt; Math.PI / 360 ) { // for ships within a half degree, pick the closer one
				if( distance &gt; best_d ) continue;
			}
			best_d = distance;
			min_a = angle;
			best = i;
		}
		return best;
	}
	function find_target() {
		var dir = ps.viewDirection;
			 if( dir === &quot;VIEW_FORWARD&quot; ) 	return closest_to( ps.vectorForward );
		else if( dir === &quot;VIEW_AFT&quot; )		return closest_to( ps.vectorForward.multiply(-1) );
		else if( dir === &quot;VIEW_STARBOARD&quot; ) return closest_to( ps.vectorRight );
		else if( dir === &quot;VIEW_PORT&quot; ) 		return closest_to( ps.vectorRight.multiply(-1) );
		return -1;
	}
	var list = ws.$TelescopeList; //search in the list only (stable)
	var rad = ws.$TelescopeIdentLock * Math.PI / 180; ///angle in radians
	var result = -1;
	if( attacker ) { 
		list = ws.$TelescopeAttackers; 
		red = false; 
	} else if( player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline ) {//in red alert find most centered hostile if not supressed with offline weapons
		rad = Math.PI; //in Red Alert lock from the whole sphere who target you
		red = true;
	}
	if( mode === &quot;ident&quot; ) {									//button &quot;r&quot; pressed or target lost
		if( player.alertCondition &lt; 3 ) { //do not target asteroids before ships in red alert
//	log(&quot;Telescope&quot;, &quot;MCT calling filteredEntities&quot;);  //debug
//	var list = system.filteredEntities(this, this.$Telescope_IsValid, ps, ps.scannerRange); - cause bug
			list = system.filteredEntities(ws, ws.$Telescope_IsNotInTList, ps, ps.scannerRange);
//	log(&quot;Telescope&quot;, &quot;MCT filteredEntities returned &quot;+list.length);  //debug
			rad = ws.$TelescopeIdentLock * Math.PI / 180; ///angle in radians
			result = find_target();
			if( result &gt; -1 ) { //found, target it
				return( list[ result ] ); //priority to targets not in list but in crosshairs for asteroid hunting
			}
		} //if no asteroid in crosshairs then do normal ident to a ship in telescope list
		list = ws.$TelescopeList; 
		red = false;
	} else 	if( mode === &quot;auto&quot; ) { //lock in the crosshairs only
		if( ws.$TelescopeAutoLock &lt;= 0 ) return false;	//if disabled
		rad = ws.$TelescopeAutoLock * Math.PI / 180; ///angle in radians
	} else 	if( mode === &quot;grav&quot; ) { //panorama targeting or lock in the crosshairs
		rad = ws.$TelescopeGravLock2 * Math.PI / 180; ///angle in radians
	} else 	if( mode === &quot;mode&quot; ) { //button &quot;b&quot; pressed after primed Telescope equipment with Shift+N
		if( red ) rad = Math.PI;//in Red Alert lock from the whole sphere who target you
	}
//;	log(&quot;Telescope&quot;, &quot;MostCentered2 &quot;+mode+&quot; &quot;+l);//debug
//	if( ps &amp;&amp; ps.isValid &amp;&amp; ps.target ) skiptarget = ps.target; //search another target
	result = find_target();
	if( result &gt; -1 ) { //found, target it
		return( list[ result ] );
	}
	return false;
}

/* this.$Telescope_Nearest = function() { //lock the nearest target
//	var attacker = false;
	var ws = worldScripts.telescope;
	var ps = player.ship;
	var i, nd, nai, who, ni = 0, d = null;
	//in Red Alert lock the last attacker if any and weapons are online
	if( player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline ) {
//		attacker = ws.$Telescope_Attacker( true ); //last attacker - old method
		nd = ws.$TelescopeMaxRange; //reset to max.
		nai = -1;
		for( i = 0; i &lt; ws.$TelescopeAttackers.length; i++ ) {
			who = ws.$TelescopeAttackers[ i ];
			ni = ws._index_in_list( who, ws.$TelescopeList );
			if( who &amp;&amp; who.isValid &amp;&amp; ni &gt; -1 &amp;&amp; !who.isDerelict ) {
				d = ps.position.distanceTo( who.position ); //distance to the attacker
				if( d &lt; nd ) { //nearer than the last nearest
					nd = d; //save the new nearest distance
					nai = ni; //save the index in the main list
				}
			} else { //remove if destroyed, derelict or not in TelescopeList
				ws.$TelescopeAttackers.splice( i, 1 ); //remove from the array
				i--; //stay on this position due to the array is shorter
			}
		}
		if( nai &gt; -1 ) { //change player target to the nearest attacker
			ws.$TelescopeListi = nai + 1;
			ws.$Telescope_Show();
		}
	} else { //lock the nearest target
//	if( !attacker ) {
		ni = ws.$TelescopeNearesti;
		who = ws.$TelescopeList[ ni - 1 ];
		if( ps &amp;&amp; ( !who || !who.isValid ) ) {
			ws.$Telescope_Scan(); //forced scan
			ni = ws.$TelescopeNearesti;
			who = ws.$TelescopeList[ ni - 1 ];
		}
//;		log(&quot;Telescope&quot;, &quot;Nearest ni:&quot;+ni+&quot; who:&quot;+who);//debug
		if( ps &amp;&amp; who &amp;&amp; who.isValid ) {
			ws.$TelescopeListi = ni;
			ws.$Telescope_Show(); //change player target to the nearest
		}
	}
}
 */

 this.$Telescope_Nearest = function() { //lock the nearest target
//	var attacker = false;
	var ws = worldScripts.telescope;
	var ps = player.ship;
	var i, nd, nai, who, ni = 0, d = null;
	function nearest( list ) {
		nd = ws.$TelescopeMaxRange; //reset to max.
		let near = -1;
		let len = list.length;
		for( i = 0; i &lt; len; i++ ) {
			who = list[ i ];
			if( ws._is_ignored_ship( ws, who ) ) continue;
			ni = list === ws.$TelescopeList ? i : ws._index_in_list( who, ws.$TelescopeList );
			if( who &amp;&amp; who.isValid &amp;&amp; ni &gt; -1 &amp;&amp; !who.isDerelict ) {
				d = ps.position.distanceTo( who.position ); //distance to the attacker
				if( d &lt; nd ) { //nearer than the last nearest
					nd = d; //save the new nearest distance
					near = ni; //save the index in the main list
				}
			} else { //remove if destroyed, derelict or not in TelescopeList
				ws.$TelescopeAttackers.splice( i, 1 ); //remove from the array
				i--; //stay on this position due to the array is shorter
			}
		}
		return near;
	}
	//in Red Alert lock the last attacker if any and weapons are online
	if( player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline ) {
//		attacker = ws.$Telescope_Attacker( true ); //last attacker - old method
		nai = nearest( ws.$TelescopeAttackers );
		if( nai &gt; -1 ) { //change player target to the nearest attacker
			ws.$TelescopeListi = nai + 1;
			ws.$Telescope_Show();
			return;
		}
	}
	nai = nearest( ws.$TelescopeList );
	if( nai &gt; -1 ) { //change player target to the nearest attacker
		ws.$TelescopeListi = nai + 1;
		ws.$Telescope_Show();
	}
}

this.$Telescope_NewFarList = function() {
//	log(&quot;Telescope&quot;,&quot;NewFarList&quot;);
	var ws = worldScripts.telescope;
	ws.$TelescopeListFar = [];
	ws.$TelescopeListFarPos = [];
}

this.$Telescope_NewList = function() {
//;	log(&quot;Telescope&quot;,&quot;NewList&quot;);
	var ws = worldScripts.telescope;
	ws.$Telescope_NewFarList();
	ws.$TelescopeAttackeri = 0;
	ws.$TelescopeList = [];
	ws.$TelescopeListGD = [];
	ws.$TelescopeListPos = [];
	ws.$TelescopeListi = 0;
	ws.$TelescopeNearestd = ws.$TelescopeMaxRange;
	ws.$TelescopeNearesti = 0;
	var m = ws.$TelescopeMMarks;
	var i = 0;
	for( i = 0; i &lt; m.length; i++ ) {
		if( m[i] ) m[i].remove();
		ws.$TelescopeMMarks[i] = null;
	}
	ws.$TelescopeMMarks = [];
	m = ws.$TelescopeMRings;
	for( i = 0; i &lt; m.length; i++ ) {
		if( m[i] ) m[i].remove();
		ws.$TelescopeMRings[i] = null;
	}
	ws.$TelescopeMRings = [];
	m = ws.$TelescopeVMarks;
	for( i = 0; i &lt; m.length; i++ ) {
		if( m[i] ) m[i].remove();
		ws.$TelescopeVMarks[i] = null;
	}
	ws.$TelescopeVMarks = [];
	ws.$TelescopeVMCs = [];
}

this.$Telescope_PlanetName = function(who) { //cached names
	if( !system || !system.planets || system.planets.length &lt; 1 || !who || (!who.isPlanet &amp;&amp; !who.isSun ))
		return(&quot;&quot;);
	var ws = worldScripts.telescope;
	var name = &#39;&#39;;
	if( who.isSun ) {
		name = ws.$TelescopePlanetNames.sun;
		if( !name || name.length &lt; 1 ) {
			name = ws.$Telescope_PlanetName2(who);
			ws.$TelescopePlanetNames.sun = name;
		}
	} else {
		var i = ws._index_in_list( who, system.planets );
		if( i === -1 ) return(&quot;&quot;);
		name = ws.$TelescopePlanetNames[i];
		if( !name || name.length &lt; 1 ) {
			name = ws.$Telescope_PlanetName2(who);
			ws.$TelescopePlanetNames[i] = name;
		}
	}
	return( name );
}

this._isNotPlanet = function (entity) {return(!entity.isPlanet);}
this._allPlanets  = function (entity) {return entity.isPlanet;}
this.$Telescope_PlanetName2 = function(who) {
	var ws = worldScripts.telescope;
	var name = &quot;Planet&quot;;
	var p = null;
	if( system &amp;&amp; who &amp;&amp; who.isValid ) {
		if( who.isSun ) return(&quot;Sun of &quot;+system.name);
		if( !who.isPlanet ) return(&quot;Non-Planet&quot;);

		var wn = worldScripts.planetnames;
		if( wn ) {
			name = wn.$PlanetNames_GetPlanetName( who );
			if( name &amp;&amp; name.length &gt; 0 ) return( name );
		}

		if( worldScripts[&quot;planetaryCompass_worldScript.js&quot;] ) {
			p = system.filteredEntities(this, this._isNotPlanet, who, 10);
//;			log(&quot;Telescope&quot;,&quot;PlanetName2 &quot;+p);
			if( p &amp;&amp; p[0] &amp;&amp; p[0].isValid &amp;&amp; p[0].isVisualEffect &amp;&amp; p[0].displayName )
				return( p[0].displayName );
		}
		name = system.name;
		if( who.isMainPlanet ) name += &quot; Prime (Planet)&quot;;
		else {
			p = system.filteredEntities(this, this._allPlanets, system.sun); //order by distance from sun
			if( who.hasAtmosphere ) {
				var n = [ &quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;IV&quot;, &quot;V&quot;, &quot;VI&quot;, &quot;VII&quot;, &quot;VIII&quot;, &quot;IX&quot;, &quot;X&quot;, 
					&quot;XI&quot;, &quot;XII&quot;, &quot;XIII&quot;, &quot;XIV&quot;, &quot;XV&quot;, &quot;XVI&quot;, &quot;XVII&quot;, &quot;XVIII&quot;, &quot;XIX&quot;, &quot;XX&quot; ];
				var no = 0;
				var i = ws._index_in_list( who, p );
				if( i &lt; n.length ) no = n[i];
				else no = i;
				name += &quot; &quot;+no+&quot; (Planet)&quot;;
			} else name = &quot;Moon &quot;+(ws._index_in_list( who, p )+1);
		}
	}
	return( name );
}

this.$Telescope_RefundEQ = function( eq ) {
	var ws = worldScripts.telescope;
	var ps = player.ship;
	if( ws._index_in_list( eq, ps.equipment ) ) {
		if( ps.equipmentStatus( eq ) === &quot;EQUIPMENT_DAMAGED&quot; )
			player.consoleMessage(&quot;Need repair first&quot;); //do not get back full price for a damaged eq
		else if( ps.equipmentStatus( eq ) === &quot;EQUIPMENT_OK&quot; ) {
			ps.removeEquipment( eq );
			clock.addSeconds (&quot;3600&quot;);
			var refund = EquipmentInfo.infoForKey( eq ).price / 10; ///
			player.credits += refund;
			player.consoleMessage(&quot;Refunded &quot;+refund+&quot; credits for &quot;+EquipmentInfo.infoForKey( eq ).name);
			return( refund );
		}
	}
	return( 0 );
}

this.$Telescope_Scan = function() {
	worldScripts.telescope.$Telescope_List2( 0, true ); //forced to scan
}

this.$Telescope_SetLightballs = function( subitem ) { //set config variables from telescopeeq.js also
	var ws = worldScripts.telescope;
//	if( subitem == 1 ) { //off
	ws.$TelescopeLightBalls = false;
	ws.$TelescopeShipLightBalls = false;
	ws.$TelescopeMassLockBorders = false;
    ws.$TelescopeBrightMassLockBorders = false;
	ws.$TelescopeLargeLightBalls = false;
	if( subitem &gt;= 2 ) ws.$TelescopeLightBalls = true; //ship off
	if( subitem &gt;= 3 ) ws.$TelescopeShipLightBalls = true; //small
	if( subitem &gt;= 4 ) ws.$TelescopeMassLockBorders = true; //25.6km but in green alert only
	if( subitem &gt;= 5 ) ws.$TelescopeBrightMassLockBorders = true; //use brighter borders
	if( subitem &gt;= 6 ) ws.$TelescopeLargeLightBalls = true;//large
}

this.$Telescope_SetSniper = function( subitem ) {
	var ws = worldScripts.telescope;
	if( subitem === 1 ) { //off
		ws.$TelescopeSniperRange = 10000;
		ws.$TelescopeSniperMinRange = 10000;
	} else {
		var minitem = subitem;
		if( subitem &lt; 5 ) ws.$TelescopeSniperRange = 25600;
		else { minitem = subitem - 3; ws.$TelescopeSniperRange = 30000;}
		ws.$TelescopeSniperMinRange = 5000 * (minitem-1); //5, 10 or 15km
	}
}

this.$Telescope_SetSteering = function( subitem ) {
	worldScripts.telescope.$TelescopeSteering = subitem - 1;
}

this.$Telescope_SetTargets = function( subitem ) {
	var ws = worldScripts.telescope;
	if( subitem === 1 ) { //20 and limitation in red alert
		ws.$TelescopeRedAlertLimiter = true;
		ws.$TelescopeTargets = 20;
	} else {
		ws.$TelescopeRedAlertLimiter = false;
		if( subitem === 2 ) ws.$TelescopeTargets = 50;
		else if( subitem === 3 ) ws.$TelescopeTargets = 100;
		else ws.$TelescopeTargets = 200;
	}
}

this.$Telescope_SetVisual = function( subitem ) {
	var ws = worldScripts.telescope;
	if( subitem === 1 ) {
		ws.$TelescopeShowVisualTarget = false; //off
		ws.$TelescopeVZoomSize = 0; //off without weapons also
	}
	if( subitem &lt;= 2 ) ws.$TelescopeShowVisualTarget = false; //weapons off
		else ws.$TelescopeShowVisualTarget = true;
	if( subitem &lt;= 3 ) {
		if( subitem &gt; 1 &amp;&amp; ws.$TelescopeRing ) {
			ws.$TelescopeRing = false; //no ring
			ws.$TelescopeVSize += 3; //due to ring turned off
			ws.$TelescopeVZoomSize = ws.$TelescopeVSize;
		}
	} else {
		if( subitem &gt; 1 &amp;&amp; !ws.$TelescopeRing ) {
			ws.$TelescopeRing = true;
			ws.$TelescopeVSize -= 3; //due to ring turned on
			ws.$TelescopeVZoomSize = ws.$TelescopeVSize + 3;
		}
	}
	if( subitem &lt;= 4 ) ws.$TelescopeShowVisualStation = false; //no station
	else ws.$TelescopeShowVisualStation = true;
	if( subitem &lt;= 5 ) ws.$TelescopeShowVisualQuestionMark = false; //no &quot;?&quot;
	else ws.$TelescopeShowVisualQuestionMark = true;
}

this.$Telescope_SetVisualSize = function( subitem ) {
	var ws = worldScripts.telescope;
	if( ws.$TelescopeRing ) ws.$TelescopeVSize = subitem; //1-8
	else ws.$TelescopeVSize = subitem + 3; //without ring is equal with zoomed
	ws.$TelescopeVZoomSize = subitem + 3; //3-10
}

this.$Telescope_Show = function() { //inputs: $TelescopeList array, $TelescopeListi item index to show
	worldScripts.telescope.$Telescope_Show2( true );
}

this.$Telescope_Show2 = function( showname ) { //call with showname=true if eq step pressed
	var ws = worldScripts.telescope;
	//must use ws.$Telescope* and not this.$Telescope* to do not crash the game
	var ti = ws.$TelescopeListi;
	if( ws.$TelescopeList &amp;&amp; ti &gt; 0
		&amp;&amp; ws.$TelescopeList.length &gt;= ti ) {
		var who = ws.$TelescopeList[ ti - 1 ];
		if( who ) {
			if( worldScripts.detectors &amp;&amp; who.isValid &amp;&amp; who.script &amp;&amp; who.script.$Detectors_Origname )
				who.displayName = who.script.$Detectors_Origname;
				//show short name in automatic lock message
//			log(&quot;Telescope&quot;, &quot;Show pt:&quot;+player.ship.target+&quot; who:&quot;+who+&quot; tt:&quot;+ws.$TelescopeTarget);//debug
			if( player.ship.target !== who //to avoid repeated ident lock sound and message
				&amp;&amp; ws.$TelescopeTarget !== who) { //far target
				if( ws.$TelescopeTimerA ) { //restart timer if already running
					ws.$TelescopeTimerA.stop();
					ws.$TelescopeTimerA = null;
				}
				if( showname )
					ws.$TelescopeTimerA = new Timer(this, ws.$Telescope_TimedA, 0.05, 0);
				//return; //if the wait time of the timer set to 0.01 then buggy on Intel Atom netbook
				//but good on i3: if see coriolis then can not step to the next target (relock the base)
				//without timer the same bug happen on desktop i3
				else ws.$Telescope_TimedA();
				//if called from shipTargetLost then must to lock new target instantly to avoid
				//ident system active message
			}
		}
		if( showname ) ws.$Telescope_ShowName(ti, who,
			ws.$TelescopeListPos[ ti - 1 ] ); //fallback pos if lost target
		if( ( ws.$TelescopeShowVisualTarget || !player.ship.weaponsOnline )
			&amp;&amp; ws.$TelescopeFixedTel !== 1 ) {//no visual mode if cheaply fixed
//;			log(&quot;Telescope&quot;,&quot;Show2 ti:&quot;+ti+&quot; who:&quot;+who);
			ws.$Telescope_VShow();
		}
	}
}

this.$Telescope_ShowName = function(ti, who, position) {
	var ws = worldScripts.telescope;
	var msg = ws.$Telescope_ShowName2(who, position);
	if( !msg || msg.length &lt;= 0 ) return;
	
	var idlast = &quot;&quot;;
	if( ti &gt; 0 &amp;&amp; ws.$TelescopeList.length &lt;= ti ) idlast = &quot; last&quot;;
	var tis = &quot;&quot;;
	if( ti ) tis = &quot; (&quot;+ti+&quot;.&quot;+idlast+&quot;)&quot;;
	
//	msg+=&quot; (&quot;+Math.round( ws.$TelescopeZoom )+&quot;x)&quot;; //debug
	if( ws.$TelescopeCMFD ) { //show in Combat MFD instead of console
		ws.$TelescopePrevMFDTarget = who; //store for MFD
		if(msg &amp;&amp; msg.length &gt; 0) ws.$TelescopeCMFD.$TelescopeLine = msg;
	} else player.consoleMessage( msg+tis, 4.5 ); //fallback to console, showtime matched to ident message
//;	log(&quot;Telescope&quot;, msg+tis); //debug
}

this.$Telescope_ShowName2 = function(who, position) {
	var ws = worldScripts.telescope;
	var name = &quot;&quot;;
	if( who &amp;&amp; who.isValid ) {
		if( who.name &amp;&amp; ( who.name === &quot;Railgun Projectile&quot;
                        || who.name === &quot;Debris&quot; //do not show launched bullets
			|| who.name.indexOf(&quot;customshields&quot;) &gt; -1 ) ) return; //nor customshields parts
		if( ws.$Telescope_InRange( who ) )
			position = who.position; //got fresh data from the normal scanner or the telescope
		if( who.script &amp;&amp; who.script.$Detectors_Origname )
			name = who.script.$Detectors_Origname;
		else if( who.displayName &amp;&amp; who.displayName.length &gt; 0 )
			name = who.displayName;
		else if( who.isPlanet || who.isSun ) name = ws.$Telescope_PlanetName(who);
		else name = who.name;
	}
	if( name.indexOf(&quot;Exhibition]&quot;) &gt; -1 ) return; //do not show ships in exhibition of Gallery OXP
	if( !name || name.length === 0 ) name = &quot;(Lost target)&quot;;
	else if( !who || !who.isPlanet &amp;&amp; !who.isSun &amp;&amp; ( !who.isValid || !ws.$Telescope_InRange( who ) ) )
//		name = &quot;(Lost &quot;+name+&quot;)&quot;;
		return;
	var direction = ws.$Telescope_From(player.ship, position);
//	log(ws.name, name+&quot; d:&quot;+direction+&quot; p:&quot;+position); //debug
	var cr = 0;
	if( who.collisionRadius &gt; 0) cr = who.collisionRadius;
	var rng = Math.floor((player.ship.position.distanceTo(position)-cr) / 1000);
	if( rng &gt;= 1000000 ) rng = Math.floor(rng/1000000)+&quot;M&quot;;

	if( who.isDerelict ) {
		if(ws.$TelescopeTWS &amp;&amp; who.script) { //Towbar status
			if(who.script.$TowbarUsableShip) name = &quot;Usable &quot;+name;
			else if(who.script.$TowbarMinedShip) name = &quot;Mined &quot;+name;
			if(who.script.$TowbarEmptyShip) name = &quot;Empty &quot;+name;
			else name = &quot;Derelict &quot;+name;
		} else name = &quot;Derelict &quot;+name;
	} else if( who.target === player.ship ) rng = &quot;! &quot;+rng; //hostile
	else if( ws._index_in_list( who, ws.$TelescopeReds ) &gt; -1 ) rng = &quot;* &quot;+rng; //pirate
	return( rng+&quot;km &quot;+name+&quot; &quot;+direction );
}

this.$Telescope_ShowFoundTargetNumber = function() {
	var ws = worldScripts.telescope;
	var len = ws.$TelescopeList.length;
	var s = &quot;&quot;;
	if( len &gt; 1 ) s = &quot;s&quot;;
	var msg = &quot; found &quot;+len+&quot; target&quot;+s;
	if( ws.$TelescopeStaionNearby ) {
		var p = &quot;&quot;;
		if( ws.$TelescopeGSP &lt; 1 ) p = Math.round(ws.$TelescopeGSP*100)+&quot;% &quot;;
		msg = &quot;Gravity scan&quot;+msg+&quot;, &quot;+p+&quot;done&quot;; //need online gravity scanner
	} else msg = &quot;Telescope&quot;+msg;
	player.consoleMessage( msg, 5 );
}

this.$Telescope_StartTimer = function( delay ) {
	if( player.ship.equipmentStatus(&quot;EQ_TELESCOPE&quot;) === &quot;EQUIPMENT_OK&quot; ) {
		var ws = worldScripts.telescope;
		if( !isValidFrameCallback( ws.$TelescopeVFCB ) )
			ws.$TelescopeVFCB = addFrameCallback( this.$Telescope_VFCB.bind(this) );
		if( !isValidFrameCallback( ws.$TelescopeVFCB2 ) )
			ws.$TelescopeVFCB2 = addFrameCallback( this.$Telescope_VFCB2.bind(this) );
		if( !isValidFrameCallback( ws.$TelescopeVFCB3 ) )
			ws.$TelescopeVFCB3 = addFrameCallback( this.$Telescope_VFCBVisualTarget.bind(this) );
		for(var i = 0; i &lt; ws.$TelescopeVFCBM.length; i++) {
			if( isValidFrameCallback( ws.$TelescopeVFCBM[i] ) )
				removeFrameCallback( ws.$TelescopeVFCBM[i] );
			ws.$TelescopeVFCBM[i] = null; //cag: converting to static arrays
		}
//		ws.$TelescopeVFCBM = [];
		ws.$TelescopeVFCBM[0] = addFrameCallback( ws.$Telescope_VFCBM0.bind(ws) );
//cag: deleted 49 static FCBs to replace with dynamic ones
		//AutoScan timer get targets from normal scanner and do scan if a new target is visible
		//need at least 1 sec delay when called from shipWillExitWitchspace to avoid many gray balls
		this.$TelescopeTimerS = new Timer(this, ws.$Telescope_TimedS, delay, 0.25);
	}
}

this._is_ignored_ship = function( ws, who ) {
	var we = worldScripts.escortdeck;
	if( who.status === &#39;STATUS_BEING_SCOOPED&#39; || who.status === &#39;STATUS_IN_HOLD&#39; ) 
		return true;											// a problem when mining!
	if( we ) { 
		let i = ws._index_in_list( who, we.$EscortDeckShip );	//escortdeck oxp is present
		if( i &gt;= 0 &amp;&amp; we.$EscortDeckShipPos[i] )
			return true; 										//who is on deck so exclude this who from target list
	}
	var wt = worldScripts.towbar;
		if( wt &amp;&amp; who === wt.$TowbarShip )
			return true;										//skip the towed ship
	return false;
}

this.$Telescope_Steer = function() {//turn to the target
	var ws = worldScripts.telescope;
	var ti = ws.$TelescopeListi;
	var who = ws.$TelescopeList[ ti - 1 ];
	if( ws._is_ignored_ship( ws, who ) ) return;
	if( player.ship &amp;&amp; who &amp;&amp; who.isValid &amp;&amp; player.ship.viewDirection === &quot;VIEW_FORWARD&quot; //working in forward view only
		&amp;&amp; ws.$TelescopeFixedTel !== 1 //no steering if cheaply fixed
		&amp;&amp; !isValidFrameCallback( ws.$TelescopeSteerFCB ) ) {
		ws.$TelescopePrevHeading = player.ship.heading;
		ws.$TelescopeSteerFCB = addFrameCallback( ws.$Telescope_SteerFCB.bind(ws) );
	}
}

/*
(function() {
	var ws = worldScripts.telescope;
	if( isValidFrameCallback( ws.$TelescopeSteerFCB ) )
		removeFrameCallback( ws.$TelescopeSteerFCB );
	ws.$TelescopeSteerFCB = addFrameCallback( ws.$Telescope_SteerFCB.bind(ws) );
	console.clearConsole();
})()
*/

this.$Telescope_SteerFCB = function( delta ) {
	var ws = worldScripts.telescope;
	var ps = player.ship;
//	sum += delta;	log(&quot;Telescope&quot;, &quot;Time elapsed: &quot; + sum + &quot; (delta: &quot; + delta + &quot;)&quot;);
	var ti = ws.$TelescopeListi;
	var who = ws.$TelescopeList[ ti - 1 ];
	if( ps &amp;&amp; ps.isValid &amp;&amp; who &amp;&amp; who.isValid &amp;&amp; !ws._is_ignored_ship( ws, who ) ) {
		var position = who.position; //got fresh data from the normal scanner or the telescope
		if( !ws.$Telescope_InRangeFast( who, ti ) )
			position = ws.$TelescopeListPos[ ti - 1 ];
		if( !position ) {
			if( isValidFrameCallback( ws.$TelescopeSteerFCB ) )
				removeFrameCallback( ws.$TelescopeSteerFCB );
		} else {
			var v = position.subtract( ps.position ).direction();
			var angle = ps.heading.angleTo(v);
                	var ato = ps.heading.angleTo(ws.$TelescopePrevHeading);
			if( ato &lt; 0.005 &amp;&amp; angle &gt; 0.015 ) { //steer if no manual steering and not in 1 degree
				//if the above ato value lower then can not start steering in my intel atom netbook
//				player.consoleMessage(ws.$TelescopePrevHeading +&quot; vs &quot;+ ps.heading);
				var a = Math.min(ps.maxPitch*delta, angle/12);//half max turn/step and not too accutate
				var wstow = ws.$TelescopeTWS;  //slowed steering from towbar oxp if there are towed ship
				if( wstow &amp;&amp; wstow.$TowbarShip &amp;&amp; wstow.$TowbarShip.isValid ) {
					var ma = Math.min( 2, ps.mass / wstow.$TowbarShip.mass ); ///small ship max. 2x
					a = a * ma / 3; // 1/3 of the original rate with same mass, min. 1/5 max. 2/3
//					player.consoleMessage(&quot;Telescope slow steering with towed ship &quot;+ato);//debug
				}
				var c = ps.heading.cross(v).direction(); //set the plane where we should rotate in
				var q = ps.orientation.rotate( c, -a );
				ps.orientation = q;
			} else { //end of steering
//      	                player.consoleMessage(ato+&quot; a&quot;+angle+&quot; p&quot;+position);//debug
				if( isValidFrameCallback( ws.$TelescopeSteerFCB ) )
					removeFrameCallback( ws.$TelescopeSteerFCB );
			}
		}
		ws.$TelescopePrevHeading = ps.heading;
	} else { //end of steering
		if( isValidFrameCallback( ws.$TelescopeSteerFCB ) )
			removeFrameCallback( ws.$TelescopeSteerFCB );
	}
	if( isValidFrameCallback( ws.$TelescopeVFCB ) ) {
		ws.$TelescopeSVSync = true;
		ws.$Telescope_VFCB( delta );//must be run surely after the SteerFCB
		ws.$TelescopeSVSync = false;
	}
}

this.$Telescope_TimedA = function() { //to avoid backstep if a target in the crosshairs
//	log(&quot;Telescope&quot;, &quot;TimedA start&quot;);//debug
	var ws = worldScripts.telescope;
	var ti = ws.$TelescopeListi;
	var who = ws.$TelescopeList[ ti - 1 ];
	var ps = player.ship;
//	log(&quot;Telescope&quot;, &quot;TimedA ti:&quot;+ti+&quot; who:&quot;+who);//debug
	if( ps &amp;&amp; ps.isValid &amp;&amp; who &amp;&amp; who.isValid ) {
		var d = ps.position.distanceTo( who.position );
		if( d &lt; ps.scannerRange &amp;&amp; !who.isVisualEffect &amp;&amp; !who.isPlanet &amp;&amp; !who.isSun ) {
			if( who &amp;&amp; who.isValid &amp;&amp; ps.target !== who ) {
				ws.$TelescopeTargetSet = true;//to avoid doubled list item message
//				log(&quot;Telescope&quot;, &quot;New player target: &quot;+who.displayName+&quot; who:&quot;+who);//debug
				if( !who.isPlanet &amp;&amp; !who.isSun ) ps.target = who;
				if( ps.target !== who &amp;&amp; //yes, it is possible! Hohoho showed when a ship jumped!
				//bugfix against non-lockable Military Jammer awarded by ShipVersion to avoid repeated scan
					ws.$TelescopePrevWho !== who ) {
					ws.$TelescopePrevWho = who; //store to scan only once
//					player.consoleMessage(&quot;Hohoho!&quot;);//debug
//;				log(&quot;Telescope&quot;, &quot;ScanTW: &quot;+who+&quot; - &quot;+ws.$TelescopePrevWho);//debug
					ws.$Telescope_Scan(); //forced scan to remove the invalid ball
				}
				ws.$TelescopeTarget = ps.target; //save real target after(!) set
//				log(&quot;Telescope&quot;, &quot;New player target set to &quot;+who.displayName);//debug
				ws.$TelescopeTargetSet = false;
			}
		} else { //far target or planet, lock the marker
			var vm = ws.$TelescopeVMark;
//			log(&quot;Telescope&quot;, &quot;ti:&quot;+ti+&quot; pt:&quot;+ps.target+&quot; VMark:&quot;+vm);//debug
			if( !ps.target || ps.target !== vm ) {
//				log(&quot;Telescope&quot;, &quot;TimedA pt:&quot;+ps.target+&quot; vm:&quot;+vm);//debug
				ws.$Telescope_VFCBVisualTarget(); //get new name
				vm = ws.$TelescopeVMark;
//				log(&quot;Telescope&quot;, &quot;TimedA got new target name for vm:&quot;+vm);//debug
				if( vm &amp;&amp; vm.isValid &amp;&amp; !vm.isVisualEffect &amp;&amp; ps.target !== vm ) {
//					log(&quot;Telescope&quot;, &quot;TimedA will set displayName:&quot;+vm.displayName);//debug
					var vd = vm.displayName;
					if( who.isPlanet || who.isSun ) vm.displayName = ws.$Telescope_PlanetName(who);
					else vm.displayName = who.displayName; //remove km from ident message
					ws.$TelescopeTargetSet = true;//avoid doubled list item message
//					log(&quot;Telescope&quot;, &quot;New player target: &quot;+vm.displayName+&quot; vm:&quot;+vm+&quot; who:&quot;+who);//debug
					ps.target = vm;
					ws.$TelescopeTarget = who; //save the real target after(!) set
//					log(&quot;Telescope&quot;, &quot;New player target set to &quot;+vm.displayName);//debug
					ws.$TelescopeTargetSet = false;
					vm.displayName = vd; //restore km
				}
			}
		}
//		log(&quot;Telescope&quot;, &quot;Player target: &quot;+ps.target+&quot; VMark:&quot;+vm);//debug
//		ws.$Telescope_ShowName();//removed, show in target box
	}
	if( ws.$TelescopeTimerA ) {
		ws.$TelescopeTimerA.stop();
		ws.$TelescopeTimerA = null;
	}
//	log(&quot;Telescope&quot;, &quot;TimedA end&quot;);//debug
}

this.$Telescope_TimedF = function() { //delayed launch of FCBs, must after FarPlanets FCB
	var ws = worldScripts.telescope;
	ws.$Telescope_StartTimer( 1 ); //1 sec delay to avoid unwanted gray balls
	if( ws.$TelescopeTimerF ) {
		ws.$TelescopeTimerF.stop();
		ws.$TelescopeTimerF = null;
	}
}

// before w/ TelescopeVMCC=0, Total time: 48.901 ms JavaScript: 10.732 ms, native: 38.155 ms
//  after w/ TelescopeVMCC=0, Total time: 34.331 ms JavaScript: 9.057 ms, native: 25.257 ms
this._TimedS_closure = function() {
	// &#39;constant&#39; variables
	var ws = worldScripts.telescope;
	var telescopeAutoScan = ws.$TelescopeAutoScan;
	var telescopeAutoScanMaxRange = ws.$TelescopeAutoScanMaxRange;
	var telescopeRedAlertLimiter = ws.$TelescopeRedAlertLimiter;
	var telescopeAutoLock = ws.$TelescopeAutoLock;
	var telescopeGravLock = ws.$TelescopeGravLock;
	var telescopeCMFD = ws.$TelescopeCMFD;
	// function references
	var player_consoleMessage = player.consoleMessage;
	var telescope_Scan = ws.$Telescope_Scan;
	var telescope_ShowFoundTargetNumber = ws.$Telescope_ShowFoundTargetNumber;
	var system_filteredEntities = system.filteredEntities;
	var telescope_ShowName = ws.$Telescope_ShowName;
	var telescope_ShowName2 = ws.$Telescope_ShowName2;
	var telescope_MostCentered = ws.$Telescope_MostCentered;
	var telescope_GetDetect = ws.$Telescope_GetDetect;
	var telescope_VClear = ws.$Telescope_VClear;
	var telescope_TimedVMC = ws.$Telescope_TimedVMC;
	var index_in_list = ws._index_in_list;
	// local variables
	var telescopeVMCC = 0; //counter to make colour of the visual marks, used to do once in a second within a 0.25s timer
	var ps, pst, psp, scannerRange, telescopeGSP, telescopeList, telescopeListi, telescopeStaionNearby;

	function _IsPilotedVisible(entity) {
		if( entity &amp;&amp; entity.isValid &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isCloaked
			&amp;&amp; ( entity.isPiloted || entity.forwardWeapon ) //need to detect drones from HardShips OXP
	//		&amp;&amp; ( !entity.isRock || entity.isStation ) //too much asteroids, lock only in scannerRange
			&amp;&amp; (( telescope_GetDetect( entity )
				&amp;&amp; entity.isVisible &amp;&amp; ps.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot; )
				|| // brought code inline // ws.$Telescope_IsScannerTarget( entity )
				( entity.dataKey &amp;&amp; ps &amp;&amp; ps.isValid &amp;&amp; psp.distanceTo(entity.position) &lt; scannerRange )
				)
			&amp;&amp; ( !entity.dataKey || entity.dataKey !== &quot;telescopemarker&quot; ) )
			return true;
		return false;
	}
	function _IsNonHostileStaion(entity) {
		if( entity &amp;&amp; entity.isValid &amp;&amp; entity.isStation &amp;&amp; !entity.isVisualEffect &amp;&amp; !entity.isCloaked
			&amp;&amp; entity.mass &gt; 10000000 //skip ships with docking port (except baseships), rockhermit with 53508t must fit in
			&amp;&amp; entity.target !== ps //target is hostile if targeting back
			   //or player is in the defenseTargets
			&amp;&amp; ( !entity.defenseTargets || ws._index_in_list( ps, entity.defenseTargets ) === -1 ) )
			return true;
		else return false;
	}
	function _MFDTarget(ws, ps, who) { //helper function for building MFD in TimedS
		if( who &amp;&amp; who.isValid ) {
			var v = telescope_ShowName2(who, who.position);
			if( v &amp;&amp; v.length &gt; 0 &amp;&amp; v.indexOf(&quot;(Lost &quot;) === -1 ) {
				if( who === pst || //current target
					pst &amp;&amp; pst.dataKey
					&amp;&amp; pst.dataKey === &quot;telescopemarker&quot; //get the original target
					&amp;&amp; who === telescopeList[ telescopeListi - 1 ] )
					v = &quot;[ &quot;+v+&quot; ]&quot;; //mark the current target
				return( v+&quot;\n&quot; );
			}
		}
		return false;
	}

	function _TimedS() { //check for most centered 4 times/second, new targets and colour update once/second
	//	log(&quot;Telescope&quot;, &quot;TimedS start&quot;); //debug
		ps = player.ship;
		pst = ps.target;
		psp = ps.position;
		scannerRange = ps.scannerRange;
		telescopeStaionNearby = ws.$TelescopeStaionNearby;
	//;	if( ps.target === null ) log(&quot;Telescope&quot;,&quot;TimedS notarget1&quot;);
		if( !ps || !ps.isValid || ps.equipmentStatus(&quot;EQ_TELESCOPE&quot;) !== &quot;EQUIPMENT_OK&quot; ) {
			if(ps.setMultiFunctionText) //clear MFD if Telescope damaged
				ps.setMultiFunctionText(this.name, &quot;No Telescope Target&quot;, false);
			return; //stop scan when damaged
		}
	//	var gravdone = false;
		var gravok = false;
		if( ps.equipmentStatus(&quot;EQ_GRAVSCANNER&quot;) === &quot;EQUIPMENT_OK&quot; ) gravok = true;
		telescopeGSP = ws.$TelescopeGSP;
		if( gravok &amp;&amp; telescopeStaionNearby ) {
			if( telescopeGSP &lt; 1 ) {
				var gsm = 1;//gravity scanner multiplyer
				if( ps.speed === 0 ) gsm = 4; //4 times faster if stopped
				if( ps.equipmentStatus(&quot;EQ_GRAVSCANNER2&quot;) === &quot;EQUIPMENT_OK&quot; )
					gsm *= 2; //half time with 2 working grav.scanner
				ws.$TelescopeGSP = telescopeGSP = telescopeGSP + gsm * 1/960; //normal gravity scan need 4 minutes
				if( telescopeGSP &gt;= 1 ) {
					ws.$TelescopeGSP = telescopeGSP = 1;
					if( ps.weaponsOnline )
						player_consoleMessage(&quot;Gravity scan done, turn off weapons to see results&quot;, 5);
					else {
						telescope_Scan(); //forced scan to insert new gravity targets
						telescope_ShowFoundTargetNumber();
					}
				}
			}
		} else if( telescopeGSP &gt; 0 ) 
			ws.$TelescopeGSP = telescopeGSP = telescopeGSP - 1/240; //degrading from 100% to 0% in 2 minute if away from stations
		var newtarget = null;
		var st = [];
		var ascan = false;
		var i = 0, j = 0, who = 0, s = &#39;&#39;;
		telescopeList = ws.$TelescopeList;
		telescopeListi = ws.$TelescopeListi;
		if( telescopeAutoScan //enabled
			&amp;&amp; telescopeVMCC &lt; 1 //and every 4. call
			&amp;&amp; telescopeList.length &lt; ws.$TelescopeTargets ) { //and list is not full
			ascan = true;
			st = system_filteredEntities(this._TimedS_closure, _IsPilotedVisible, ps,
							 telescopeAutoScanMaxRange); //maybe avoid bugs if maxed
	// 		log(&quot;Telescope&quot;, &quot;TimedS filteredEntities returned &quot;+st.length);  //debug

			var mfd = &quot;&quot;; //build Telescope MFD

			for( i = 0; i &lt; st.length &amp;&amp; j &lt; 10; i++ ) { //list the nearest ships first
				s = _MFDTarget(ws, ps, st[i]);
				if( s ) { mfd += s; j++; }
			}
			for( i = 0; i &lt; telescopeList.length &amp;&amp; j &lt; 10; i++ ) { //then other targets
				who = telescopeList[i];
				if( who &amp;&amp; ws._index_in_list( who, st ) === -1 ) { //not in the filtered ships array
					s = _MFDTarget(ws, ps, who);
					if( s ) { mfd += s; j++; }
				}
			}
			if( j &lt; 1 ) mfd = &quot;No Telescope Target&quot;;
			if(ps.setMultiFunctionText) ps.setMultiFunctionText(this.name, mfd, false);

			//check a station is nearby for gravity scanner
			if( gravok ) {
				if( ps.mass &lt; 100000000 ) { //baseships can perform gravity scan anywhere
					var sg = system_filteredEntities(this._TimedS_closure, _IsNonHostileStaion, ps, 5000);
					if( !telescopeStaionNearby &amp;&amp; sg &amp;&amp; sg.length &gt; 0 ) {
	//					var w = &quot;&quot;;
						telescopeStaionNearby = true; //store the result
						if( ps.weaponsOnline )  //show when arrived near a station
							player_consoleMessage(&quot;Gravity scan need offline weapons&quot;, 5);
						else {
							telescope_Scan();//forced rescan
							telescope_ShowFoundTargetNumber();
						}
					} else {
						if( telescopeStaionNearby &amp;&amp; ( !sg || sg.length === 0 ) ) { //too far or become hostile
							player_consoleMessage(&quot;Gravity scan need friendly station in 5km&quot;, 5);
							telescopeStaionNearby = false;
							telescope_Scan();//forced rescan
						}
					}
				} else telescopeStaionNearby = true;//baseship
			} else telescopeStaionNearby = false;
		}
		for( i = 0; i &lt; st.length; i++ ) { //search new target
			if( ws._index_in_list( st[i], telescopeList ) === -1 &amp;&amp;
				!st[i].isPlayer ) { //must, bugfix
				var p = st[i].position;
				telescope_ShowName(&quot;&quot;, st[i], p);
	//			var m = Math.round(ps.position.distanceTo( p ));
	//			var dir = ws.$Telescope_From(ps, p);
	//			log(&quot;Telescope&quot;, &quot;New visible: &quot; + m+&quot;m &quot;+dir+&quot; &quot;+st[i]);//debug
	//			system.addVisualEffect(&quot;telescope-whitemarker&quot;, p);//debug
				newtarget = st[i]; //but do not jump out of the cycle, keep to print all new name
			}
		}
		if( !newtarget &amp;&amp; telescopeCMFD ) { //CombatMFD support
			var pt = ws.$TelescopePrevMFDTarget;
			if( !pt || !pt.isValid || ascan &amp;&amp; index_in_list( pt, telescopeList ) === -1 ) {
				//need ascan check also, else cause blinking names in CombatMFD
	//			player.consoleMessage(pt);//debug
				ws.$TelescopePrevMFDTarget = null;
				telescopeCMFD.$TelescopeLine = &quot;&quot;; //clear the line in MFD
			} else telescope_ShowName(&quot;&quot;, pt, pt.position); //update the direction
		}
	//;	if( ps.target == null ) log(&quot;Telescope&quot;,&quot;TimedS notarget2&quot;);
		if( newtarget &amp;&amp; newtarget !== ws.$TelescopePrevNewTarget
			|| pst &amp;&amp; !pst.isValid //target jumped or so
			&amp;&amp; !pst.isPlanet &amp;&amp; !pst.isSun
			&amp;&amp; ( !pst.dataKey || pst.dataKey !== &quot;telescopemarker&quot; )) {
	//;		log(&quot;Telescope&quot;, &quot;ScanNT: &quot;+newtarget+&quot; - &quot;+ws.$TelescopePrevNewTarget);//debug
			ws.$TelescopePrevNewTarget = newtarget; //store to scan only once
			telescope_Scan(); //forced scan to insert new one(s)
		}
	//	else ws.$Telescope_List3(0, true, true); //forced free scan to refresh from the normal scanner - need fix, removed

	//;	if( ps.target == null ) log(&quot;Telescope&quot;,&quot;TimedS notarget3&quot;);
		if( !isValidFrameCallback( ws.$TelescopeSteerFCB ) ) { //no retarget during autosteering
			if( ps.weaponsOnline ) {//in auto mode
				if( pst === null //no target and autolock not disabled
					&amp;&amp; telescopeAutoLock !== 0 )
					telescope_MostCentered( null, &quot;auto&quot;, false );
			} else if( telescopeGravLock !== 0 ) //in grav mode and not disabled
				telescope_MostCentered( null, &quot;grav&quot;, false );
		}
		
		if( pst === null ) {
	//;		log(&quot;Telescope&quot;,&quot;TimedS notarget&quot;);
			var ti = telescopeListi;
			who = telescopeList[ ti - 1 ];
			if( !who || ( !who.isPlanet &amp;&amp; !who.isSun ) ) {
	//;			log(&quot;Telescope&quot;,&quot;TimedS VClear&quot;);
				telescope_VClear(); //cleanup needed in some cases
			}
		}
		
		if( !telescopeRedAlertLimiter //small help to slow computers:
			|| telescopeVMCC &lt; 1 ) //update in every 4. call only
			telescope_TimedVMC(); //update the colours of the lightball markers
		if( telescopeVMCC &lt; 1 ) { //check colour making counter
			telescopeVMCC = 3; //do once in a second when reach 0
		} else telescopeVMCC--;
	//	log(&quot;Telescope&quot;, &quot;TimedS end&quot;); //debug
		ws.$TelescopeStaionNearby = telescopeStaionNearby;
	}

	return _TimedS;
}

this.$Telescope_TimedVMC = function() { //make colours to visual markers, check targets are flyed out of range
	if( !player.ship || !player.ship.isValid ) return;
	var ws = worldScripts.telescope;
	var ps = player.ship;
	var ball = null;
	var col = null;
	var dt = null;
//	var dir = null;
//	var scr = ps.scannerRange;
	var tcr = 0;
	var tl = ws.$TelescopeList;
	var tfs = ws.$TelescopeFarStatus;
	var t = null;
//	var v = null;
	ws.$TelescopeNearestd = ws.$TelescopeMaxRange; //reset to max.
	var prepa = ws.$TelescopeRedAlertLimiter; //run much faster with local variables
	var prepb = ws.$TelescopeLightBalls;
	var prepc = ws.$TelescopeVMCs;
	var prepd = ws.$TelescopeNearestd;
	var prepi = ws.$TelescopeNearesti;
	var prepl = ws.$TelescopeLargeLightBalls;
	var prepm = ws.$TelescopeSniperMinRange;
	var prepp = ws.$TelescopeListPos;
	var prepr = ws.$TelescopeSniperRange;
	var preps = ws.$TelescopeShipLightBalls;
	var prept = null; if( ws.$TelescopeTWS ) prept = ws.$TelescopeTWS.$TowbarShip; //skip the towed ship
	var prepv = ws.$TelescopeVMarkMinDist;
	var prepvs = ws.$TelescopeVMarkShipMinDist;
	var reds = ws.$TelescopeReds; //pirate detected earlier
	var telescope_InRangeFast = ws.$Telescope_InRangeFast;
	var telescopeListPos = ws.$TelescopeListPos;
	var psp = ps.position;
	var scannerRange = ps.scannerRange;
	var tpos, dataKey, isPlanet, isThargoid, isSun, mass;
	//following part is very CPU consuming, with 100 ships need 400 cycle/sec, so code wisely
	for( var i = 0; i &lt; tl.length; i++ ) {
		t = tl[i];
		if( !t || !t.isValid ) col = null; //invalid target
		else if( !telescope_InRangeFast( t, i ) ) {
			//less check than InRange due to checked before and speed is important
			col = &quot;gray&quot;; //last known position only
			dt = psp.distanceTo( prepp[ i ] );
			//distance to the last known position
		} else {
			tpos = t.position;
			dataKey = t.dataKey;
			isPlanet = t.isPlanet;
			isThargoid = t.isThargoid;
			isSun = t.isSun;
			mass = t.mass;
			dt = psp.distanceTo( tpos ); //distance to the target
			telescopeListPos[ i ] = tpos; //update until InRange
			if( t.isStation || ( dataKey &amp;&amp; dataKey.indexOf(&quot;buoy&quot;) &gt; -1 ) )
				col = &quot;green&quot;; //base or buoy, do not use isBeacon to exclude ships with beaconCode
			else if( isPlanet ) col = &quot;lightgray&quot;; //planets
			else if( isThargoid &amp;&amp; dataKey !== &quot;tharglet&quot; //warship is red but tharglet is pink or white
				|| !t.isDerelict &amp;&amp; prepc[i] &amp;&amp; prepc[i].indexOf(&quot;red&quot;) &gt; -1 )
				col = &quot;red&quot;; //pirate detected earlier
			else if( t.isVisible || dt &lt; scannerRange ) {
				if( t.isPolice ) col = &quot;purple&quot;; //police
				else if( t.isWormhole || t.isDerelict ) col = &quot;blue&quot;; //wormhole from Oolite v1.79
				else if( !t.isPiloted &amp;&amp; t.forwardWeapon &amp;&amp; t.bounty &gt; 0 //active tharglet or drone
//					&amp;&amp; ( ( t.owner &amp;&amp; t.owner.isValid || t.speed &gt; 0 ) //can fire after owner gone until moving
						//&amp;&amp; !t.owner.isDerelict - still fire
					&amp;&amp; ( isThargoid //will be like a rock when inactive
						|| dataKey !== &quot;tharglet&quot; ) ) col = &quot;pink&quot;;
				else if( t.isCargo || t.primaryRole === &quot;escape-capsule&quot; //cargo, esc.pod, rock or sun
					|| isSun || t.isRock || dataKey === &quot;tharglet&quot; ) col = &quot;white&quot;;
				else if( t.bounty &gt; 0 &amp;&amp; ( tfs || dt &lt; scannerRange || isThargoid ) ) {
					col = &quot;red&quot;; //pirate in scanner or FarStatus=true or thargoid
					if( ws._index_in_list( t, reds ) === -1 ) reds.push(t); //save
				}
				else if( t.isWeapon ) col = &quot;cyan&quot;; //missile or mine
				else if( ws._index_in_list( t, reds ) &gt; -1 ) col = &quot;red&quot;; //pirate detected earlier
				else col = &quot;yellow&quot;; //other ship with clean status
			} else if( mass &gt;= 130000 ) col = &quot;orange&quot;; //large ship over the visible range
			else col = &quot;brown&quot;; //small ship over the visible range
		}
		if( col ) { //check to avoid invalid target
			if( dt &lt; prepd &amp;&amp; t !== prept ) { //find the nearest target but skip the towed ship
				prepd = dt;
				prepi = i + 1; //store the nearest
			}
			tcr = 0;
			if( t &amp;&amp; t.isValid &amp;&amp; !isPlanet &amp;&amp; !isSun ) tcr = t.collisionRadius;
			if( prepb &amp;&amp; prepl ) {
				if( isPlanet &amp;&amp; !t.hasAtmosphere ) ball = &quot;moon&quot;;
				else if( dt &lt; prepm + tcr ) ball = &quot;largeball&quot;; //xl size
				else if( dt &lt; prepr + tcr ) ball = &quot;ball&quot;; //large size
				else ball = &quot;marker&quot;; //average size
			}
			if( dt &lt; prepv + tcr //too near
				|| ( ( dt &lt; prepvs + tcr ) &amp;&amp; col !== &quot;cyan&quot; &amp;&amp; col !== &quot;white&quot; &amp;&amp; col !== &quot;pink&quot; )
				//in red alert show ball marked targets only to save CPU and clean scanner
				|| prepa &amp;&amp; player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline &amp;&amp; ball !== &quot;ball&quot; )
				col = null;
			else {
				if( !prepb || !preps //if ship lightballs are disabled then show others only
					&amp;&amp; col !== &quot;blue&quot; &amp;&amp; col !== &quot;cyan&quot; &amp;&amp; col !== &quot;green&quot; &amp;&amp; col !== &quot;white&quot; )
					col = &quot;telescope-&quot;+col+&quot;_flag&quot;;//lollipop without lightball
				else if( isPlanet || isSun ) {
					if( t.hasAtmosphere ) { //only lightrgray has moon in effectdata.plsit
						if( t.isVisible &amp;&amp; dt &lt; 10000000 )
							col = &quot;telescope-lightgray_moonflag&quot;; //no dot
						else col = &quot;telescope-lightgray_moon&quot;;
					} else if( t.isVisible &amp;&amp; dt &lt; 10000000 )
						col = &quot;telescope-&quot;+col+&quot;_flag&quot;; //no dot
					else col = &quot;telescope-&quot;+col+&quot;_dotmarker&quot;;
				} else if( prepl ) { //large balls
					if( dt &gt; 1000000 ) col += &quot;_tiny&quot;; //over 1000km show tiny ball
					else if( dt &gt; 100000 ) col += &quot;_small&quot;; //over 100km show smaller ball
					col = &quot;telescope-&quot;+col+&quot;_&quot;+ball;
				} else if( dt &gt; 1000000 ) col = &quot;telescope-&quot;+col+&quot;_dotmarker&quot;; //over 1000km
				else if( mass &lt; 400000 ) col = &quot;telescope-&quot;+col+&quot;_tinymarker&quot;; //escort ship
				else col = &quot;telescope-&quot;+col+&quot;_smallmarker&quot;; //large ship (Cobra3 and over)
			}
		}
		ws.$TelescopeVMCs[ i ] = col;
	}
	ws.$TelescopeNearestd = prepd;
	ws.$TelescopeNearesti = prepi;
}

this.$Telescope_True = function(/*target*/) { //system.filteredEntities can get all ship with this
	return true;
}

this.$Telescope_VClear = function() { //Clear Visual Effect Ship Model and Visual Marker also
	var ws = worldScripts.telescope;
//;	log(&quot;Telescope&quot;,&quot;VClear&quot;);
	ws.$Telescope_VClearM();
	ws.$Telescope_VClearS();
}

/*
(function() {
	var ws = worldScripts.telescope;
	if( isValidFrameCallback( ws.$TelescopeVFCB ) ) removeFrameCallback( ws.$TelescopeVFCB );
	var vc = ws._VFCB_closure();
	ws.$Telescope_VClearS = vc.clear;
	ws.$Telescope_VShow = vc.show;
	ws.$Telescope_VFCB = vc.fcb;
	if( !isValidFrameCallback( ws.$TelescopeVFCB ) )
		ws.$TelescopeVFCB = addFrameCallback( ws.$Telescope_VFCB.bind(ws) );
})()
*/

this._VFCB_closure = function() {
	// &#39;constant&#39; variables
	var ws = worldScripts.telescope;
	var w_shiplib = worldScripts.shiplib;
	var gameWindow = oolite.gameSettings.gameWindow;
	// function references
	var system_addVisualEffect = system.addVisualEffect;
	var telescope_Scan = ws.$Telescope_Scan;
	var telescope_ShowFoundTargetNumber = ws.$Telescope_ShowFoundTargetNumber;
	var telescope_InRange = ws.$Telescope_InRange;
	var telescope_VClear = ws.$Telescope_VClear;
	var index_in_list = ws._index_in_list;
	// local variables
	var weaps = true; //the previous state of the player weapons
	var vRing = null; //a ring around the visual effect target
	var vShip = null; //visual effect to show the selected target
	var vDataKey = null; //key of the visual effect
	var vShrinkC = 0; //visual effect shrink counter - shrink code is not ready, leave these at 0
	var vShrinkDelay = 0; //in sec after the larger visual target start shrinkig to normal size (0: instant)
	var vShrinkLength = 0; //in sec, shrinking faster if smaller (0: instant)
	var vAlighUp = 0; //visual effect align to top modifier
	var vZoom = 1; //store the original maximal zoom level of the visual effect
	var ps, wide;

//	function getVShip() { return vShip; }
	function setVShip( ship, up, delay, length ) {
		vShip = ship;
		vAlighUp = up;
		vShrinkDelay = delay;
		vShrinkLength = length;
		vShrinkC = vShrinkDelay + vShrinkLength; //shrink after delay
		return ship;
	}
	function clearVShip() { //Clear Visual Effect Ship Model and large visual ring
		if( vShip ) {
	//; 		log(&quot;Telescope&quot;, &quot;Remove VModel:&quot;+ws.$TelescopeV); //debug
			vShip.remove();
	// 		log(&quot;Telescope&quot;, &quot;Removed VModel.&quot;); //debug
			vShip = null;
			vShrinkC = 0;
			vAlighUp = 0;
			vDataKey = null;//need to show again when reident
		}
		if( vRing ) {//remove large visual ring
	//; 		log(&quot;Telescope&quot;, &quot;Remove VRing:&quot;+vRing); //debug
			vRing.remove();
	// 		log(&quot;Telescope&quot;, &quot;Removed VRing.&quot;); //debug
			vRing = null;
		}
		return null;
	}
	function showVShip() { //Show Visual Effect
		ps = player.ship;
		if( !ws.$TelescopeShowVisualTarget ) return;
	//cag: added to fix bug where loading game or altering its size caused effect to re-appear when turned off
		if( !ws.$TelescopeAutoLock &amp;&amp; !ps.target ) return;
		if( ps.weaponsOnline ) {
			if( ws.$TelescopeVSize &lt;= 0 ) return;
		} else if( ws.$TelescopeVZoomSize &lt;= 0 ) return;
		var ti = ws.$TelescopeListi;
		var who = ws.$TelescopeList[ ti - 1 ];
		if( !who || !who.isValid &amp;&amp; !who.isPlanet &amp;&amp; !who.isSun || !telescope_InRange( who ) ) {
	//;		log(&quot;Telescope&quot;,&quot;VShow ti:&quot;+ti+&quot; who:&quot;+who);
			telescope_VClear();
			return;
		}
		var dk = who.dataKey;
		var v = vShip;
	//	log(&quot;Telescope&quot;,&quot;VShow &quot;+dk+&quot; &quot;+v+&quot; &quot;+who.isStation+&quot; &quot;+ws.$TelescopeShowVisualStation);//debug
		if( who.isPlanet || who.isSun || who.isStation &amp;&amp; !ws.$TelescopeShowVisualStation )
			clearVShip();
		else if( !v || vDataKey !== dk ) {
			vDataKey = dk;
			if( v ) v.remove();
			v = null;
					
			if( 0 &lt; oolite.compareVersion(&quot;1.79&quot;) ) { //before Oolite v1.79
				if( index_in_list( dk, ws.$TelescopeDataKeys77 ) &gt; -1 ) {
					dk += &quot;77&quot;; //use dataKeys with 77 suffix in effectdata.plist
				}
			}
			var p = ps.position;
			if( dk ) v = system_addVisualEffect( dk, p );
	//		log(&quot;Telescope&quot;,&quot;VShow2 &quot;+dk+&quot; &quot;+v);//debug
			if( !v ) { //maybe the dataKey contains partially a name from the shiplib
				if( w_shiplib &amp;&amp; w_shiplib.$ShipLibVP ) {
					var l = w_shiplib.$ShipLibVP;
					var d = 0; //0. line contains the default data
					for( var i = l.length; i &gt;= 0 ; i-- ) //search backward (from orig.ships)
						if( dk &amp;&amp; l &amp;&amp; l[i] &amp;&amp; dk.indexOf( l[i].k ) &gt; -1 ) {
							d = i; //found
							i = -1; //exit from for
						}
					v = system_addVisualEffect( l[d].k, p );
				}
				if( !v &amp;&amp; ws.$TelescopeShowVisualQuestionMark )
					v = system_addVisualEffect(&quot;oolite-unknown-ship&quot;, p); //fallback
				else clearVShip(); //silent fallback
			}
	//		player.consoleMessage(v+&quot; &quot;+dk);//debug
			if( v ) { //must to check it (bugfix)
	//			log(&quot;Telescope&quot;,&quot;VShow3 &quot;+dk+&quot; &quot;+v);//debug
					var z = v.collisionRadius / 6; ///
				vZoom = z; //save zoom value
				if( z &gt; 0 ) v.scale( 1 / z ); //shrink to the largest size
				v.scannerDisplayColor1 = null; //hide from the scanner
				v.scannerDisplayColor2 = null; //hide from the scanner
	//			ws.$TelescopeV = v; //save
	//			ws.$TelescopeVUp = 0;
	//			ws.$TelescopeVShrinkC = ws.$TelescopeVShrinkDelay + ws.$TelescopeVShrinkLength; //shrink after delay
				setVShip( v, 0, 0, 0 ); // vAlighUp, vShrinkDelay, vShrinkLength
				if( !isValidFrameCallback( ws.$TelescopeVFCB ) )
					ws.$TelescopeVFCB = addFrameCallback( ws.$Telescope_VFCB.bind( ws ) );
				if( !isValidFrameCallback( ws.$TelescopeVFCB2 ) )
					ws.$TelescopeVFCB2 = addFrameCallback( ws.$Telescope_VFCB2.bind( ws ) );
				if( !isValidFrameCallback( ws.$TelescopeVFCB3 ) )
					ws.$TelescopeVFCB3 = addFrameCallback( ws.$Telescope_VFCBVisualTarget.bind( ws ) );
			}
		}
	}
	function _VFCB( delta ) { //Visual FrameCallBack
	//	log(&quot;Telescope&quot;, &quot;VFCB start&quot;); //debug
		ps = player.ship
		if( !ps || !ps.isValid ) return; //if player died
		if( isValidFrameCallback( ws.$TelescopeSteerFCB )
			&amp;&amp; !ws.$TelescopeSVSync ) return; //call after Steering

		wide = gameWindow.height / gameWindow.width; ///widescreen correction
		//full size virtual target (and ring also) if weapons offline
		var vsize = ws.$TelescopeVZoomSize / 10; ///
		var vsizechanged = false;
		if( ps.weaponsOnline ) { //gravity scan if weapons turned off
			if( !ws.$TelescopeShowVisualTarget //remove model if weapons changed back to on
				&amp;&amp; vShip ) { //and model showing is disabled
				vShip.remove();
				vShip = null;
			}
			vsize = ws.$TelescopeVSize / 10; ///
			if( !weaps ) { //state changed to on
				vsizechanged = true;
				vShrinkC = 0; //restart counter to rescale
				weaps = true; //save state
				telescope_Scan(); //perform visible scan
			}
		} else if( weaps ) { //state changed to off
			vsizechanged = true;
			vShrinkC = 0; //restart counter to rescale
			weaps = false; //save state
			telescope_Scan(); //perform gravity scan
			telescope_ShowFoundTargetNumber();
			if( ps.target //repaint visual target and ring if show in weapons off mode only
				&amp;&amp; ws.$TelescopeFixedTel !== 1 ) {//no visual mode if cheaply fixed
				clearVShip();
				showVShip();
			}
	//		player.consoleMessage(ps.target);//debug
		}

		//visual target zoom
		var vp = ws.$TelescopeVPos;
		var pos = ps.position.add( ps.vectorForward.multiply( 50 + vp.z ) ); //check effectdata.plist if this line give TypeError: vp is null
		pos = pos.add( ps.vectorRight.multiply( vp.x ) );
	//	var srp = pos; //sniper ring position
		if( !vShip || !vShip.isValid ) {
			if( vShip || vRing ) {
	//;			log(&quot;Telescope&quot;,&quot;VFCB remove V:&quot;+ws.$TelescopeV);
				clearVShip();
			}
		} else {
			var slen = vShrinkLength; //do shrink after delay
			if( ( vShrinkC &gt;= 0 || vsizechanged )
				&amp;&amp; vShrinkC &lt;= slen ) {
				vShrinkC -= delta;
				var d = 1;
				if( slen &gt; 0 ) d = ( slen - vShrinkC ) / slen;
				var z = ( 1 - d * ( 1 - vsize ) ) / vZoom;
				if( z &gt; 0 ) vShip.scale( z ); //shrink
				vAlighUp = 3 * d * ( 1 - vsize ) * 1.5; //align to top
	//			player.consoleMessage(vShrinkC+&quot; &quot;+z);//debug
			}
			var up = 12.5;
			if( !ws.$TelescopeRing )
				//|| vsize == ws.$TelescopeVZoomSize / 10 ) ///no ring if zoomed - removed since the ring is narrow
				up += 1; //a bit more higher if no ring
			else up += 1.25 - 2.5 * vsize; //correction with ring
	//		player.consoleMessage(up);//debug
			pos = pos.add( ps.vectorUp.multiply( up - 24 * ( 0.75 - wide ) + vp.y
				+ vAlighUp ) );
			vShip.position = pos;
		}

		//orient vship model
		var ti = ws.$TelescopeListi;
		var who = ws.$TelescopeList[ ti - 1 ];
		var wp = null;
		if( who &amp;&amp; who.isValid &amp;&amp; ( who.isPlanet || who.isSun || ws.$Telescope_InRangeFast( who, ti ) ) ) {
			wp = who.position;
		} else 
			wp = ws.$TelescopeListPos[ ti - 1 ]; //last known position
		if( wp ) {
			var vd = wp.subtract( ps.position ).direction(); // unit vector towards wp
			if( vShip &amp;&amp; vShip.isValid &amp;&amp; !vShip.isPlanet &amp;&amp; !vShip.isSun ) {
				if( who.isVisible ) { //orientation is known only if visible, Grav.Scanner can give position only
					let ps_heading = ps.heading;
					var a = ps_heading.angleTo(vd);
					var c = ps_heading.cross(vd).direction();
					var o = who.orientation.rotate( c, -a );
	//	var v2 = ps.position.subtract(wp);
	//	var fw = ship.vectorForward.angleTo(v2);
	//	var ri = ship.vectorRight.angleTo(v2);
	//	var up = ship.vectorUp.angleTo(v2);
	//	var o = who.orientation;
	//	var o = who.orientation.multiply( ps.orientation ); //depends on player ori only
	//	o = o.rotateZ(fw);
	//	o = o.rotateY(up);
	//	o = o.rotateX(ri);
					vShip.orientation = o;
	// 		( who.orientation.rotate( ps.position.subtract( who.position ) )
	//			).multiply( ps.orientation );
			//who.orientation.multiply( ps.orientation );
				} else { //nonvisible, fixed view only
					var r = Math.PI / 2 + 0.22; ///ships viewed from top (90 degree plus a bit)
					let who_isValid = who.isValid;
					if( who_isValid &amp;&amp; who.isStation ) r = Math.PI + 0.22; //stations facing
					vShip.orientation = ps.orientation.rotate( ps.vectorRight, r );
					if( who_isValid &amp;&amp; who.isMainStation ) //rotate to horizontal dock position
						vShip.orientation = vShip.orientation.rotate( vShip.vectorForward, Math.PI / 2 );
	//				var cr = who.collisionRadius;
	//				log(&quot;Telescope&quot;, &quot;VFCB who:&quot;+who.name+&quot; cr:&quot;+cr);//debug
	//				if( cr &gt; 0 ) vShip.scale( 2.5 / cr ); //smaller
				}
			}
		}
		
		//large visual target ring
		if( vShip &amp;&amp; vShip.isValid &amp;&amp; ws.$TelescopeRing //if not disabled
			&amp;&amp; ws.$TelescopeFixedTel !== 1 //no ring (nor target model) if cheaply fixed
			//&amp;&amp; ps.weaponsOnline //and not in zoomed size - removed since the ring is narrow
			&amp;&amp; vShrinkC &lt;= 0 ) { //and not zooming
			if( !vRing ) {
				vRing = system_addVisualEffect(&quot;telescope-sniper&quot;, pos);
				vRing.scale( 0.166 * vsize ); //shrink
	//			vRing.scaleZ = vRing.scaleZ * 0.1; //make flatter
			} else {
				vRing.position = pos;
				if( vsizechanged ) { //if weapons switched on/off set new size (small/large)
					vRing.scale( 0.166 * vsize ); //shrink
	//				vRing.scaleZ = vRing.scaleZ * 0.1; //make flatter
				}
			}
			vRing.orientation = ps.orientation;//.rotate( ps.vectorRight, 0 );
		} else if( vRing ) {
			vRing.remove();
			vRing = null;
		}

	//	ws.$Telescope_VFCBVisualTarget(); //called from separated FCB to avoid timeLimit

	//	the following can reach timeLimit if placed here so must be called from separatd FCB
	//	for(var i = 0; i &lt; ws.$TelescopeList.length; i+=10; )
	//		ws.$Telescope_VFCBMarks(Math.floor(i/10)); 
	}
	return { clear: clearVShip,
			  show: showVShip,
			   fcb: _VFCB };
}

this.$Telescope_VClearM = function() { //Clear Visual Marker and small sniper ring
	var ws = worldScripts.telescope;
	if( ws.$TelescopeVMark ) {
//; 		log(&quot;Telescope&quot;, &quot;Remove VMark:&quot;+ws.$TelescopeVMark); //debug
		ws.$TelescopeVMark.remove();
// 		log(&quot;Telescope&quot;, &quot;Removed VMark.&quot;); //debug
		ws.$TelescopeVMark = null;
	}
	ws._clearSniperRing();
}
/*
(function() {
	var ws = worldScripts.telescope;
	if( isValidFrameCallback( ws.$TelescopeVFCB2 ) ) removeFrameCallback( ws.$TelescopeVFCB2 );
	var vc = ws._VFCB2_closure();
	ws._clearSniperRing = vc.clear;
	ws.$Telescope_VFCB2 = vc.fcb;
	if( !isValidFrameCallback( ws.$TelescopeVFCB2 ) )
		ws.$TelescopeVFCB2 = addFrameCallback( ws.$Telescope_VFCB2.bind(ws) );
})()
*/

this._VFCB2_closure = function() {
	// &#39;constant&#39; variables
	var ws = worldScripts.telescope;
	var gameWindow = oolite.gameSettings.gameWindow;
	var TelescopeSniperRingSize = ws.$TelescopeSniperRingSize;
	// function references
	var system_addVisualEffect = system.addVisualEffect;
	// local variables
	var sniperRing = null; //if this ring guided around the crosshair then the far target is lined up correctly
	var ps, wide;

	function clearVRing() { //Clear small sniper ring
		if( sniperRing ) {//remove the small sniper ring
	//; 		log(&quot;Telescope&quot;, &quot;Remove SniperRing:&quot;+ws.$TelescopeSniperRing); //debug
			sniperRing.remove();
	// 		log(&quot;Telescope&quot;, &quot;Removed SniperRing.&quot;); //debug
			sniperRing = null;
		}
	}
	function _VFCB2( /*delta*/ ) { //Visual FrameCallBack for the small sniper ring
		ps = player.ship;
		var d = 0;
		var snipertarget = false;
		var psp, psVF, psVR, psVU;
		var pst = ps.target;
		if( ps &amp;&amp; pst &amp;&amp; pst.isValid
			&amp;&amp; ws.$TelescopeFixedTel !== 1 ) { //no sniper ring if cheaply fixed
			if( pst.dataKey &amp;&amp; pst.dataKey === &quot;telescopemarker&quot; ) { //get the original target
				var ti = ws.$TelescopeListi;
				pst = ws.$TelescopeList[ ti - 1 ];
			}
			if( pst &amp;&amp; pst.isValid &amp;&amp; !pst.isPlanet &amp;&amp; !pst.isSun ) {
				psp = ps.position;
				d = psp.distanceTo( pst.position );
				var tcr = pst.collisionRadius;
				if( d - tcr &lt; ws.$TelescopeSniperRange
					&amp;&amp; d - tcr &gt; ws.$TelescopeSniperMinRange ) {
					var m = psp.subtract( pst.position );
					psVF = ps.vectorForward;
					if( psVF.angleTo( m ) &gt; 3 ) { //to exclude aft line-up
	//					player.consoleMessage(ps.vectorForward.angleTo( m ));//debug
						var vp = ws.$TelescopeVPos;
						var srp = psp.add( psVF.multiply( 50 + vp.z ) ); //check effectdata.plist if this line give TypeError: vp is null
						psVR = ps.vectorRight;
						psVU = ps.vectorUp;
						srp = srp.add( psVR.multiply( vp.x ) );
						wide = gameWindow.height / gameWindow.width; ///widescreen correction
						//distant and smaller target tracked with larger ring movement
						var ax = -2 * d / tcr * ( psVR.angleTo( m ) - Math.PI / 2 );
						var ay = -2 * d / tcr * ( psVU.angleTo( m ) - Math.PI / 2 );
	//					player.consoleMessage(Math.round(ax*100)/100+&quot; &quot;+Math.round(ay*100)/100);//debug
						if( Math.abs(ax) &lt; 5 &amp;&amp;  Math.abs(ay) &lt; 6 * wide ) { //ay&lt;4 if 4:3, &lt;3.4 if 16:9
							srp = srp.add( psVU.multiply( vp.y ) );//center of the view_position
							srp = srp.add( psVR.multiply( ax ) );//show misalignment
							srp = srp.add( psVU.multiply( ay ) );
							if( sniperRing ) sniperRing.position = srp;
							else {
								sniperRing = system_addVisualEffect(&quot;telescope-ring&quot;, srp);
								sniperRing.scale( 0.01 * TelescopeSniperRingSize ); //shrink
							}
							sniperRing.orientation = ps.orientation;
							snipertarget = true;
						}
					}
				}
			}
		}
		if( !snipertarget &amp;&amp; sniperRing ) {
			sniperRing.remove();
			sniperRing = null;
		}
	}
	return { clear: clearVRing,
			   fcb: _VFCB2 };
}

//call these from separated FCBs to avoid timeLimit
//this.$Telescope_VFCBM0 = function( delta ) { this.$Telescope_VFCBMarks(0); }
//...
this.$Telescope_VFCBM0 = function() { this.$Telescope_VFCBMarks(&#39;zero&#39;); }
//cag:  deleted 49 static FCB fns to replace with dynamic FCBs

/*
(function() {
	var ws = worldScripts.telescope;
	for(var i = 1; i &lt; ws.$TelescopeVFCBM.length; i++) {
		if( isValidFrameCallback( ws.$TelescopeVFCBM[i] ) )
			removeFrameCallback( ws.$TelescopeVFCBM[i] );
		ws.$TelescopeVFCBM[i] = null; //cag: converting to static arrays
	}
	console.clearConsole();
})()
*/

this.$Telescope_fcb_Startfrom = 0;
this.$Telescope_VFCBMarks = function(starting) { //create and update target marker lightballs - new fast code
//cag: implement dynamic FCBs, as unused ones impact framerate significantly.  
// 	var $num_fcbs = 1;  			// we initiate w/ FCB in [ 0 ] // for *debug msgs* only
	var $fcbs_removed = 0;

	function _SetUpFCBs() { // count # FCBs needed and adjust list
	//cag: implement dynamic FCBs, as unused ones impact framerate significantly
		var ws = worldScripts.telescope;
		var TelescopeVFCBM = ws.$TelescopeVFCBM;
		var Telescope_VFCBMarks = ws.$Telescope_VFCBMarks;
		var list = ws.$TelescopeList;
		var i = 4;		// start checking on 2nd group of 4 from TelescopeList
		var fnum = 1;	// $Telescope_VFCBMarks() is started w/ an FCB in [ 0 ]
		var fcb;
//var chg = false; // to reduce # degug msgs
		do {
			fcb = TelescopeVFCBM[ fnum ]; // the next FCB in the lists
			if( list[ i ] ) { // have at least one more, will need next FCB slot
//				if( !isValidFrameCallback( fcb ) ) {
// not good enough, as it can take a number of frames for a callback to become registered (ie. isValidFrameCallback to become true)!!!
				if( fnum &gt; TelescopeVFCBM.length - 1 || fcb === null ) {
					TelescopeVFCBM[ fnum ] = addFrameCallback( Telescope_VFCBMarks.bind(ws) );
//				log(&#39;telescope&#39;, &#39;_SetUpFCBs adding FCB in slot &#39; + fnum + &#39;, list.len is &#39; + list.length ); $num_fcbs++; chg = true;
				}
			} else if( isValidFrameCallback( fcb ) ) { // have run out of items in TelescopeList, remove any remaining FCBs
					removeFrameCallback( fcb );
					TelescopeVFCBM[ fnum ] = null;
					$fcbs_removed = 5;	// takes 5 frames (on my pc) to complete removal
//				log(&#39;telescope&#39;, &#39;_SetUpFCBs removing FCB in slot &#39; + fnum + &#39;, list.len is &#39; + list.length ); $num_fcbs--; chg = true;
			}
			i += 4;	// each call of $Telescope_VFCBMarks handles 4 items from list
			fnum++; // the # of the next FCB in the array
		} while( i &lt; list.length || isValidFrameCallback( fcb ) ); // end of list or have extra FCB to delete
//	if( chg ) log(&#39;telescope&#39;, &quot;# of FCBs: &quot; + $num_fcbs + &#39;, List.len is &#39; + ws.$TelescopeList.length );
	}

//	log(&quot;Telescope&quot;, &quot;VFCBMarks start from &quot;+startfrom); //debug
	//need call from FrameCallBack to compensate player movement
	var ws = worldScripts.telescope;
	var startfrom = starting;	// never modify function args
	var prept = ws.$TelescopeList; // local
// - insert - ////////////////////////////////////////////////////////
	if( startfrom === &#39;zero&#39; ) { // is &#39;zero&#39; on 1st call, delta on the rest
		_SetUpFCBs();
		ws.$Telescope_fcb_Startfrom = 0;
	} else { 
		ws.$Telescope_fcb_Startfrom++;
	}
	startfrom = ws.$Telescope_fcb_Startfrom;
// - end - ///////////////////////////////////////////////////////////
	var co = 4*startfrom, cl = prept.length; // set loop conditions from local instead
//	if( co &gt; cl ) return; //early exit over the end of TelescopeList
// - insert - ////////////////////////////////////////////////////////
	if( cl &amp;&amp; co &gt; cl ) { // happens when decr # of FCBs, as changes are not applied until next frame (or later?) so don&#39;t panic
		if( $fcbs_removed &gt; 0 ) {
			$fcbs_removed--;
		} else if( prept.length &gt; ws.$TelescopeVFCBM * 4 ) {
			log(&#39;telescope&#39;, &#39;do not have enough FCBs!!!!!!  List.length: &#39; + prept.length + &#39; TelescopeVFCBM: &#39; + ws.$TelescopeVFCBM );
		} else {										// ok, now you can panic
			log(&#39;telescope&#39;, &#39;should never happen anymore!!!!!!  co &gt; cl: &#39; + co + &#39; &gt; &#39; + cl );
		}
		return; //early exit over the end of TelescopeList
	}
// - end - ///////////////////////////////////////////////////////////
	var ce = co+4; //end of the loop, 4 item only in one FCB to avoid timelimit
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //exit if player died
	var dir = null, dt = null, md = null, pos = null, tpos = null;

	var prepc = ws.$TelescopeVMCs; // local, colour calculated in timer to save CPU
// 	var prepd = ws.$TelescopeRedAlertDist; //show lollipops in red alert within this distance only
//	var prepm = ws.$TelescopeMMarks; // removed
	var prepp = ws.$TelescopeListPos; // local
	var prepr = ws.$TelescopeMRings; // local
	var prepv = ws.$TelescopeVMarks; // local
	var pla = player.alertCondition;
	var psf = ps.vectorForward; // local
	var pso = ps.orientation; //local
	var psp = ps.position; //local
	var scr = ps.scannerRange; //local

	var angle = 0; //thin masslock border outside this angle
	var bl = false; //black lollipops in red alert
	if( pla &gt; 1 &amp;&amp; ps.weaponsOnline ) bl = true;
	var bla = [0,0,0]; //the color of black lollipops is black in red alert
	if( pla === 2 ) bla = [0.1, 0.1, 0.1]; //and very dark grey in yellow alert
	var cm = null, cmf = null, cmt = null; //dataKey holders of normal, far and thin masslock borders
	var fardist = 300000; //far masslock border over this distance (station or gravity scanner target)
	var farplanet = 30; //far masslock border distance multiplier (an average 5000km planet over 1500km distance)
	var mb = ws.$TelescopeMassLockBorders &amp;&amp; ( pla === 1 || !ps.weaponsOnline );
	var mb2 = &quot;&quot;;
	if( ws.$TelescopeBrightMassLockBorders ) mb2 = &quot;2&quot;;
	var mrs = 41.8; //masslock ring scale, used in var rsc and below for planets also
	var rsc = scr / mrs; //masslock ring size
	var scr2 = 2 * scr; //maximal distance of thin border
	var ti = ws.$TelescopeListi - 1; //exclude current target from black lollipops
	
	//following part is very CPU consuming, with 100 ships 60fps need 6000 cycle/sec, so code wisely
	for(var i=co; i&lt;cl &amp;&amp; i&lt;ce; i++){ //process 5 marker only at once to avoid timeLimit
		var t = prept[i], c = prepc[i], r = prepr[i], v = prepv[i]; // local //m = prepm[i],
		if( !c || !t || !t.isValid ) {
			tpos = null;
			if( v ) {
				v.remove(); //without this red ball remain after destroyed pirates
				prepv[i] = null;
			}
			if( r ) {
				r.remove();
				prepr[i] = null;
			}
//			if( m ) {
//				m.remove();
//				ws.$TelescopeMMarks[i] = null;
//			}
		} else if( c.indexOf(&quot;gray&quot;) &gt; -1 ) tpos = prepp[i]; //last known position only
		else tpos = t.position;
		if( tpos ) { //check to avoid invalid target and if ListPos[i] is null
			dir = tpos.subtract( psp ).direction();
			dt = psp.distanceTo( tpos ); //distance to the target (or to last known pos)
			if( dt &gt; scr ) { //target is out of scanner range
				md = scr - 600; //marker distance
				//do not set closer to the range to do not left behind aft markers during torus travel
				if( mb &amp;&amp; !t.isSun ) { //masslock borders allowed, except for the sun
					cm = c.substr(0, c.indexOf(&quot;_&quot;))+mb2+&quot;_ml&quot;; //dataKey with colour
					cmf = cm+&quot;f&quot;; //dataKey of coloured far masslock border
					cmt = cm+&quot;t&quot;; //dataKey of coloured thin masslock border
//					log(&quot;Telescope&quot;, cm );//debug
//					var ml = false;  //masslock field - removed
					if( r &amp;&amp; r.dataKey !== cm &amp;&amp; r.dataKey !== cmf &amp;&amp; r.dataKey !== cmt ) {
						r.remove(); //colour changed, forced to recreate
						prepr[i] = r = null;
					}
					//following conditions determine the thickness of ring, need thinner from close
					//if( t.isSun ) cm = cmt; //set thin masslock border, the sun always get thin border
					//else 
					if( dt &gt; fardist ) { //change to far
						if( t.isPlanet ) {
							if( dt &gt; farplanet * t.radius ) {
								cm = cmf; //set far masslock border
								if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;f&quot; ) {
									r.remove();
									prepr[i] = r = null;
								}
							} else if( dt &lt; 3 * t.radius ) {
								cm = cmt; //set thin masslock border
								if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;t&quot; ) {
									r.remove();
									prepr[i] = r = null;
								}
							} else {
//								cm = cm; //set normal masslock border (default)
								if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;l&quot; ) {
									r.remove();
									prepr[i] = r = null;
								}
							}
						} else { //is not planet but far
							cm = cmf; //set far masslock border
							if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;f&quot; ) {
								r.remove();
								prepr[i] = r = null;
							}
						}
					} else { //check for thin border within 2x scanner range
						//and over 45 degree mean ship is near and out of sight
						//so if ring is in screen then can be close so need thin border
						if( dt &lt; scr2 //45 degree = 2.9 radian
							&amp;&amp; (angle = psf.angleTo(psp.subtract(tpos))) &lt; 2.9
							//and crosshairs points out of ring which is closer
							&amp;&amp; Math.sin( angle ) &gt; scr / dt ) {
							cm = cmt; //set thin masslock border
							if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;t&quot; ) {
								r.remove();
								prepr[i] = r = null;
							}
						} else {
//							cm = cm; //set normal masslock border (default)
							if( r &amp;&amp; r.dataKey.substr(-1) !== &quot;l&quot; ) {
								r.remove();
								prepr[i] = r = null;
							}
						}
					}
					if( r ) { //move masslock ring
						r.position = tpos;
//						if( cm == cmt ) {//stop further rotating if crosshairs points outside of ring
//							r.orientation = (psp.subtract(tpos)).rotationTo([0, 0, 1]).normalize();
//							r.orientation = psp.subtract(tpos).rotationTo(psf, angle).normalize();
//							var psu = ps.vectorUp;
//							var ua = psu.angleTo(psp.subtract(tpos));//up angle
							//var borderangle = Math.asin( scr / dt );
							//r.orientation = pso.rotate([1, 1, 0], Math.asin(scr / dt) );
//						} else 
							r.orientation = pso;
					} else { //create masslock ring
						if( t.isPlanet  ) { //|| t.isSun ) {
							r = system.addVisualEffect( cm, tpos );
							if( r ) r.scale( ( t.radius + Math.max( t.radius, scr ) ) / mrs ); ///
//							log(&quot;Telescope&quot;, &quot;Planet radius: &quot;+t.radius );
						} else if( !t.isRock &amp;&amp; !t.isDerelict
							&amp;&amp; t.scanClass !== &quot;CLASS_BUOY&quot; &amp;&amp; t.scanClass !== &quot;CLASS_CARGO&quot;
							&amp;&amp; !t.isWormhole &amp;&amp; !t.isCloaked ) {
//							ml = true;  //target
							r = system.addVisualEffect( cm, tpos ); //cm is set above
							if( r ) r.scale( rsc ); //ring radius=scanner range
						}
						if( r ) {
							r.orientation = pso;
							prepr[i] = r;
						}
					}
//					if( m ) m.position = tpos; //huge lightball - replaced with MRings
//					else {
//						if( ml ) {
//							ws.$TelescopeMMarks[i] = //show masslockfield
//								system.addVisualEffect( &quot;telescope-masslockfield&quot;, tpos );
//						} else ml = false;
//					}
				} else { //masslock borders turned off with primable menu or weapons on and alert is not green
					if( r ) {
						r.remove();
						prepr[i] = null;
					}
//					if( m ) {
//						m.remove();
//						ws.$TelescopeMMarks[i] = null;
//					}
				}
			} else { //target is within scanner range (circle is surely out of view)
				md = scr + 300; //show the visual marker only without shadow lolipop
				if( r ) {
					r.remove();
					prepr[i] = null;
				}
//				if( m ) { //remove masslockfield
//					m.remove();
//					ws.$TelescopeMMarks[i] = null;
//				}
			}
			pos = psp.add( dir.multiply( md - i ) ) //anti-flicker difference
				.add( ps.heading.direction().multiply( ps.speed / 25 ) ); ///torus speed need correction
			if( !v ) {
				ws.$TelescopeVMarks[i] = system.addVisualEffect( c, pos );
//				log(&quot;Telescope&quot;, &quot;VMarks[&quot;+i+&quot;]:&quot;+ws.$TelescopeVMarks[i]+&quot; c:&quot;+c+&quot; pos:&quot;+pos); //debug
			} else {
				if( v.dataKey !== c ) { //colour or size changed
					v.remove();
					prepv[i] = system.addVisualEffect( c, pos );
				} else {
					v.position = pos;
				}
				if( bl &amp;&amp; i !== ti ) //black lollipops exccept the current target
					v.scannerDisplayColor1 = bla;
				else v.scannerDisplayColor1 = null; //original color from effectdata.plist
			}
		}
	}	
//	log(&quot;Telescope&quot;, &quot;VFCBMarks end&quot;); //debug
}

this.$Telescope_VFCBMarksOld = function() { //create and update target marker lightballs - old slow code
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //exit if player died
	var ws = worldScripts.telescope;
	var tl = ws.$TelescopeList, i, md, v = 0, ball = &#39;&#39;;
	//following part is very CPU cunsuming, with 100 ships 60fps need 6000 cycle/sec, so code wisely
	for( i = 0; i &lt; tl.length; i++ ) {
		var col = &quot;pink&quot;; //invalid target
		var tpos = null;
		var t = tl[i];
		if( !t || !t.isValid || !t.dataKey ) { //sun and planets has no dataKey
			v = ws.$TelescopeVMarks[i];
			if( v ) {
				v.remove(); //without this red ball remain after destroyed pirates
				ws.$TelescopeVMarks[i] = null;
			}
		} else if( !t.isBeacon &amp;&amp; //buoy in the whole system, others in range
			!ws.$Telescope_InRange( t ) ) {
			tpos = ws.$TelescopeListPos[ i ];
			col = &quot;gray&quot;; //last known position only
		} else {
			ws.$TelescopeListPos[ i ] = t.position; //update until InRange
			if( t.isStation || t.dataKey.indexOf(&quot;buoy&quot;) &gt; -1 )
				col = &quot;green&quot;; //base or buoy, do not use isBeacon to exclude ships with beaconCode
			else if( t.isVisible || ps.position.distanceTo( t.position ) &lt; ps.scannerRange ) {
				if( t.isPolice ) col = &quot;purple&quot;; //police
				else if( t.isCargo || t.primaryRole === &quot;escape-capsule&quot; //cargo, esc.pod,
					|| t.isRock ) col = &quot;white&quot;; //or rock
				else if( t.isWormhole || t.isDerelict ) col = &quot;blue&quot;; //wormhole from Oolite v1.79
				else if( t.bounty &gt; 0 ) col = &quot;red&quot;; //pirate or thargoid with bounty
				else if( t.isWeapon ) col = &quot;cyan&quot;; //missile or mine
				else col = &quot;yellow&quot;; //other ship with clean status
			} else if( t.mass &gt;= 130000 ) col = &quot;orange&quot;; //large ship over the visible range
			else col = &quot;brown&quot;; //small ship over the visible range
			if( ws.$TelescopeLightBalls //if ship lightballs are disabled
				|| col === &quot;blue&quot; || col === &quot;cyan&quot; || col === &quot;green&quot; || col === &quot;white&quot; )
				tpos = t.position; //then show others only
		}
		if( tpos ) { //check to avoid invalid target and if ListPos[i] is null
			var dir = tpos.subtract( ps.position ).direction();
			var dt = ps.position.distanceTo( tpos ); //distance to the target (or to last known pos)
			if( dt &gt; ps.scannerRange ) md = ps.scannerRange - 100; //marker distance
			//do not set closer to the range to do not left behind aft markers during torus travel
			else md = ps.scannerRange + 100; //show the visual marker only without shadow lolipop
			var pos = ps.position.add( dir.multiply( md + 50 * Math.random() ) ) //anti-flicker randomness
				.add( ps.heading.direction().multiply( ps.speed / 60 ) ); ///torus speed need correction
			var tcr = 0;
			if( t &amp;&amp; t.isValid ) tcr = t.collisionRadius;
			if( dt &lt; ws.$TelescopeSniperRange + tcr ) ball = &quot;ball&quot;; //large size
			else ball = &quot;marker&quot;; //average size
			if( dt &lt; ws.$TelescopeVMarkMinDist + tcr
				//in red alert show nearest large ball marked targets only to save CPU and clean scanner
				|| player.alertCondition &gt; 2 &amp;&amp; ps.weaponsOnline &amp;&amp; ball !== &quot;ball&quot; ) {
				var vmi = ws.$TelescopeVMarks[i];
				if( vmi ) vmi.remove();
				ws.$TelescopeVMarks[i] = null;
			} else {
				if( dt &gt; 150000 ) col += &quot;small&quot;; //over 150km show smaller ball
				v = ws.$TelescopeVMarks[i];
				if( !v ) {
					v = ws.$TelescopeVMarks[i] =
						system.addVisualEffect(&quot;telescope-&quot;+col+ball, pos);
				} else if( v.dataKey !== &quot;telescope-&quot;+col+ball ) { //colour or size changed
					v.remove();
					v = ws.$TelescopeVMarks[i] =
						system.addVisualEffect(&quot;telescope-&quot;+col+ball, pos);
				} else v.position = pos;
			}
		}
	}
//	ws.$Telescope_VFCBShrinkVMarks();//should not needed
}

this.$Telescope_VFCBShrinkVMarks = function() {
	var ws = worldScripts.telescope;
	var i = ws.$TelescopeList.length;
	while( i &lt; ws.$TelescopeVMarks.length) { //shrink VMarks to match List
		if( ws.$TelescopeVMarks[i] ) ws.$TelescopeVMarks[i].remove();
		ws.$TelescopeVMarks[i] = null;
		i++;
	}
	i = ws.$TelescopeList.length;
	while( i &lt; ws.$TelescopeMMarks.length) { //shrink VMarks to match List
		if( ws.$TelescopeMMarks[i] ) ws.$TelescopeMMarks[i].remove();
		ws.$TelescopeMMarks[i] = null;
		i++;
	}
	i = ws.$TelescopeList.length;
	while( i &lt; ws.$TelescopeMRings.length) { //shrink VMarks to match List
		if( ws.$TelescopeMRings[i] ) ws.$TelescopeMRings[i].remove();
		ws.$TelescopeMRings[i] = null;
		i++;
	}
}

this._VFCBVisualTarget_closure = function() { //orient vship model, make and update shadow and vmarkship
	// &#39;constant&#39; variables
	var ws = worldScripts.telescope;
	var ps, ps_scannerRange, ps_target, ps_heading, ps_position, who_isPlanet, who_isSun, who_isValid;
	var vm, mp, wdn, who;
	// function references
	var system_addShips = system.addShips;
	var system_addVisualEffect = system.addVisualEffect;
	var telescope_VClear = ws.$Telescope_VClear;
	var telescope_VClearM = ws.$Telescope_VClearM;
	var telescope_InRangeFast = ws.$Telescope_InRangeFast;
	var telescope_PlanetName = ws.$Telescope_PlanetName;
	var telescope_Scan = ws.$Telescope_Scan;
		
	function _VFCBVisualTargetMarker() {
		if( vm ) vm.remove();
		vm = system_addShips(&quot;telescopemarker&quot;, 1, mp, 1)[0];
		ws.$TelescopeVMark = vm;
		if( wdn &amp;&amp; vm &amp;&amp; vm.isValid ) vm.displayName = wdn;
	//;	log(&quot;Telescope&quot;, &quot;VMarkShip:&quot;+vm);//debug
		if( vm &amp;&amp; vm.isValid &amp;&amp; (ps_target === who || who_isPlanet || who_isSun) &amp;&amp; ps_target !== vm ) {
	//		var v = ws.$TelescopeVMarks[ws.$TelescopeListi-1];
	//		if( v &amp;&amp; v.isValid ) 
			vm.scannerDisplayColor1 = vm.scannerDisplayColor2 = [0.2, 0.2, 0.2];
			//change the lock to the markership when step over normal scanner range
			ws.$TelescopeTargetSet = true;//to avoid doubled list item message
	//;		log(&quot;Telescope&quot;, &quot;Vtarget change n:&quot;+n+&quot;km from:&quot;+vm+&quot; to:&quot;+who);//debug
			ps.target = ps_target = vm;
			ws.$TelescopeTarget = who; //save the real target after(!) set
	//;		log(&quot;Telescope&quot;, &quot;Vtarget changed n:&quot;+n+&quot;km from:&quot;+vm+&quot; to:&quot;+who);//debug
			ws.$TelescopeTargetSet = false;
		}
		return(vm);
	}
	function _VFCBVisualTarget() { // make and update shadow and vmarkship
		ps = player.ship;	// need this here unless we export a fn to reset value when player changes ship
		if( !ps || !ps.isValid ) return; //if player died
		ps_scannerRange = ps.scannerRange; // needed in case scannerRange can chg over course of a game (new equipment?)
		ps_target = ps.target; 
		if( !ws.$TelescopeAutoLock &amp;&amp; !ps_target ) return;
	//	ws.$TelescopeV.orientation = ps.orientation;
		var ti = ws.$TelescopeListi;
		who = ws.$TelescopeList[ ti - 1 ];
		var wp = null;
		if( !who ) {
	//;		log(&quot;Telescope&quot;,&quot;VFCBVisualTarget ti:&quot;+ti+&quot; who:&quot;+who);
			telescope_VClear();
		} else {
			who_isPlanet = who.isPlanet;
			who_isSun = who.isSun;
			who_isValid = who.isValid;
			wdn = &quot;&quot;;
			if( who_isValid &amp;&amp; ( who_isPlanet || who_isSun || telescope_InRangeFast( who, ti ) ) ) {
				wp = who.position;
				if( who_isPlanet || who_isSun ) wdn = telescope_PlanetName(who);
				else wdn = who.displayName; //remove km from ident message
			} else wp = ws.$TelescopeListPos[ ti - 1 ]; //last known position
			if( !wp ) return; //bugfix after jump
			ps_heading = ps.heading; 
			ps_position = ps.position;
			var vd = wp.subtract( ps_position ).direction(); //used below for target marker also		
			
			//current target marker
			var md = ps_scannerRange - 499.6; //shadow lolipop nearer than others to reduce flickering
				//do not set nearer to do not left behind aft markers during torus travel
			mp = ps_position.add(vd.multiply(md))
				.add(ps_heading.direction().multiply(ps.speed/25));
			vm = ws.$TelescopeVMark;
			var n = ps_position.distanceTo( wp );
			if( who_isPlanet || who_isSun ) n -= who.radius;
			else n += who.collisionRadius;
			if( n &lt; ps_scannerRange ) { //too near, replace the markership with visuall effect shadow lollipop
				if( who_isPlanet || who_isSun ) { //stay with marker
					mp = ps_position.add(vd.multiply(Math.min(md, n-299.6)
						)).add(ps_heading.direction().multiply(ps.speed/25));
					if( !vm || !vm.isValid || ws.$TelescopePrevPlanet !== who ) {
						ws.$TelescopePrevPlanet = who;
						vm = _VFCBVisualTargetMarker();
	//;					log(&quot;Telescope&quot;, &quot;Markwho: &quot;+who+&quot; &quot;+n+&quot; m target:&quot;+ps.target+&quot; &quot;+vm);
					} else {
						vm.position = mp;
					}
				} else {
					if( vm &amp;&amp; !ps_target ) //must check player target to remove shadow marker after scooped
						telescope_VClearM();
					else if( who &amp;&amp; who_isValid &amp;&amp; vm &amp;&amp; ps_target === vm &amp;&amp; ps_target !== who ) {
						//change the lock to the real target when reached normal scanner range
						ws.$TelescopeTargetSet = true;//to avoid doubled list item message
	//;					log(&quot;Telescope&quot;, &quot;Vtarget change n:&quot;+n+&quot;km from:&quot;+vm+&quot; to:&quot;+who);//debug
						if( !who_isPlanet &amp;&amp; !who_isSun ) ps.target = ps_target = who;
						if( ps.target !== who &amp;&amp; //yes, it is possible! Hohoho showed when a ship jumped!
	//						player.consoleMessage(&quot;Hohoho!&quot;);//debug
					//bugfix against non-lockable Military Jammer awarded by ShipVersion to avoid repeated scan
							ws.$TelescopePrevWho !== who ) {
	//						player.consoleMessage(&quot;Hohoho!&quot;);//debug
	//;					log(&quot;Telescope&quot;, &quot;ScanV: &quot;+who+&quot; - &quot;+ws.$TelescopePrevWho);//debug
							ws.$TelescopePrevWho = who; //store to scan only once
							telescope_Scan(); //forced scan to remove the invalid ball
						}
						ws.$TelescopeTarget = ps_target; //save the real target after(!) set
	//;					log(&quot;Telescope&quot;, &quot;Vtarget changed n:&quot;+n+&quot;km from:&quot;+vm+&quot; to:&quot;+who);//debug
						ws.$TelescopeTargetSet = false;
					}
					if( vm &amp;&amp; !vm.isVisualEffect ) { vm.remove(); vm = null; } //remove markership
					if( !vm &amp;&amp; ps_target ) { //check player target to remove shadow marker after scooped
						vm = system_addVisualEffect(&quot;telescope-shadow&quot;, mp);
						ws.$TelescopeVMark = vm;
					} else if( vm ) vm.position = mp;
				}
			} else if( !vm || vm.isVisualEffect ) { //markership to can virtually target far ships
				vm = _VFCBVisualTargetMarker();
			} else vm.position = mp;
			if( vm &amp;&amp; vm.isValid &amp;&amp; !vm.isVisualEffect ) {
				if( n &gt;= ps_scannerRange ) {
					n -= ps.collisionRadius;
					if( !who_isPlanet &amp;&amp; !who_isSun ) n -= 2 * who.collisionRadius;
					var km = Math.floor( n / 1000 );
					if( km &lt; 100 ) {
						var m = Math.floor( n - km * 1000 ); //rest after km
						var lz = &quot;&quot;; //leading zeros
						if( m &lt; 10 ) lz = &quot;00&quot;;
						else if( m &lt; 100 ) lz = &quot;0&quot;;
						//ws.$TelescopeVMark.name =
						ws.$TelescopeVMark.displayName =
	//						formatInteger( Math.round( n ) ) + //missing a dot after km
							km + &quot;.&quot; + lz + m + &quot; km &quot; + wdn;
					} else {
						if( km &lt; 1000000 ) ws.$TelescopeVMark.displayName = km + &quot; km &quot; + wdn;
						else ws.$TelescopeVMark.displayName = Math.floor( km / 1000000 ) + &quot; Mkm &quot; + wdn;
					}
				} else ws.$TelescopeVMark.displayName = wdn; //clear previous km
				ws.$TelescopeVMark.velocity = ps.velocity;//keep target over Torus speeds in FarPlanets OXP
			}
		}
	//;	log(&quot;Telescope&quot;, &quot;VFCB end, target:&quot;+ps.target); //debug
	}
	return _VFCBVisualTarget;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/telescope_refundeq.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;telescope_refundeq&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Refund an equipment if undamaged and not cheaply repaired only.&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context)
{
	if(eqKey===&quot;EQ_TELESCOPE_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPE&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedTel != 1 )
		return true;
	if(eqKey===&quot;EQ_TELESCOPEEXT_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPEEXT&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedTel != 1 )
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_GRAVSCANNER&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedGS != 1 )
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER2_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_GRAVSCANNER2&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedGS != 1 )
		return true;
	if(eqKey===&quot;EQ_SMALLDISH_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_SMALLDISH&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedSD != 1)
		return true;
	if(eqKey===&quot;EQ_LARGEDISH_REFUND&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_LARGEDISH&quot;) === &quot;EQUIPMENT_OK&quot;
		&amp;&amp; missionVariables.$TelescopeFixedLD != 1)
		return true;
	return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/telescope_repaireq.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;telescope_repaireq&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Repair an equipment if damaged only, full repairs if cheaply fixed.&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context)
{
	if(eqKey===&quot;EQ_TELESCOPE_REPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_TELESCOPE&quot;) === &quot;EQUIPMENT_DAMAGED&quot;)
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER_REPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_GRAVSCANNER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;)
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER2_REPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_GRAVSCANNER2&quot;) === &quot;EQUIPMENT_DAMAGED&quot;)
		return true;
	if(eqKey===&quot;EQ_SMALLDISH_REPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_SMALLDISH&quot;) === &quot;EQUIPMENT_DAMAGED&quot;)
		return true;
	if(eqKey===&quot;EQ_LARGEDISH_REPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; player.ship.equipmentStatus(&quot;EQ_LARGEDISH&quot;) === &quot;EQUIPMENT_DAMAGED&quot;)
		return true;
	if(eqKey===&quot;EQ_TELESCOPE_FULLREPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; missionVariables.$TelescopeFixedTel == 1 )
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER_FULLREPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; missionVariables.$TelescopeFixedGS == 1 )
		return true;
	if(eqKey===&quot;EQ_GRAVSCANNER2_FULLREPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; missionVariables.$TelescopeFixedGS == 1 )
		return true;
	if(eqKey===&quot;EQ_SMALLDISH_FULLREPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; missionVariables.$TelescopeFixedLD == 1)
		return true;
	if(eqKey===&quot;EQ_LARGEDISH_FULLREPAIR&quot; &amp;&amp; ship === player.ship &amp;&amp; context === &quot;purchase&quot;
		&amp;&amp; missionVariables.$TelescopeFixedLD == 1)
		return true;
	return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/telescopeeq.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;telescopeeq&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;Commands and settings, press mode to cycle, activate to accept or change.&quot;;
this.version     = &quot;1.9&quot;;

this.$Telescopeeq_Menu = [ [ &quot;Nearest target&quot; ],
	[ &quot;Rescan&quot; ],
	[ &quot;Step forward in the target list&quot; ],
	[ &quot;Step back in the target list&quot; ],
	[ &quot;Lightballs:&quot;, &quot;off&quot;, &quot;navigation only&quot;, &quot;ships&quot;, &quot;masslock borders&quot;, &quot;bright masslock borders&quot;, &quot;large&quot; ],
	[ &quot;Sniper ring km:&quot;, &quot;off&quot;, &quot;5-25.6&quot;, &quot;10-25.6&quot;, &quot;15-25.6&quot;, &quot;5-30&quot;, &quot;10-30&quot;, &quot;15-30&quot;], //off=10-10
	[ &quot;Steering:&quot;, &quot;off&quot;, &quot;nearest target only&quot;, &quot;both nearest and step in the list&quot;],
	[ &quot;Targets:&quot;, &quot;20 and limitation in red alert&quot;, 50, 100, 200 ],
	[ &quot;Visual target:&quot;, &quot;off&quot;, &quot;weapons off&quot;, &quot;no ring&quot;, &quot;no station&quot;, &quot;no question mark&quot;, &quot;all&quot; ],
	[ &quot;Visual target size:&quot;, 1, 2, 3, 4, 5, 6, 7, 8 ] ];
this.$Telescopeeq_MenuItem = 0; //current item in the commands or settings menu

//equipment events
this.activated = function ()
{
	var w = worldScripts[&quot;telescope&quot;];
	var menu = this.$Telescopeeq_Menu;
	var item = this.$Telescopeeq_MenuItem;
	if( item &lt; 4 ) { //commands
		switch( item ) {
			case 0: //Nearest target
				w.$Telescope_Nearest(); //lock the nearest target
				if( w.$TelescopeSteering &gt; 0 )
					w.$Telescope_Steer();//turn to the target
				break;
			case 1: //Rescan
				w.$TelescopeListi = w.$TelescopeList.length;
				w.$Telescope_List( 1 ); //rescan and show found due to the end of list
				break;
			case 2: //Step forward in the target list
				w.$Telescope_List( 1 );//step forward, scan after the end of the list
				if( w.$TelescopeSteering &gt; 1 )
					w.$Telescope_Steer();//turn to the target
				break;
			case 3: //Step back in the target list
				w.$Telescope_List( -1 );//step forward, scan after the end of the list
				if( w.$TelescopeSteering &gt; 1 )
					w.$Telescope_Steer();//turn to the target
				break;
		}
//		player.consoleMessage( menu[ this.$Telescopeeq_MenuItem ][ 0 ], 5 );//debug
	} else { //settings
		var subitem = this.$Telescopeeq_GetSubItem( item ) + 1; //step to the next subitem in the current settings
		var submenu = menu[ item ];
		if( subitem &gt;= submenu.length ) subitem = 1; //back to the first subitem (0. is the menuitem)
		switch( item ) {
			case 4: //Lightballs
				missionVariables.$TelescopeMenuLightballs = subitem;
				w.$Telescope_SetLightballs( subitem );
				break;
			case 5: //Sniper ring km
				missionVariables.$TelescopeMenuSniper = subitem;
				w.$Telescope_SetSniper( subitem );
				break;
			case 6: //Steering
				missionVariables.$TelescopeMenuSteering = subitem;
				w.$Telescope_SetSteering( subitem );
				break;
			case 7: //Targets
				missionVariables.$TelescopeMenuTargets = subitem;
				w.$Telescope_SetTargets( subitem );
				break;
			case 8: //Visual target
				missionVariables.$TelescopeMenuVisual = subitem;
				w.$Telescope_SetVisual( subitem );
				w.$Telescope_VClearS();
				if( w.$TelescopeFixedTel != 1 )
					w.$Telescope_VShow(); //repaint visual target and ring
				else player.consoleMessage(&quot;Your cheaply fixed Telescope can not show visual target, buy full repair.&quot;,5);
//				player.consoleMessage(w.$TelescopeVSize+&quot; &quot;+w.$TelescopeVZoomSize ); //debug
				break;
			case 9: //Visual target size
				missionVariables.$TelescopeMenuVisualSize = subitem;
				if(!(missionVariables.$TelescopeMenuVisual &gt; 0)
					|| missionVariables.$TelescopeMenuVisual == 1 ) {
					missionVariables.$TelescopeMenuVisual = 2; //must at least wp off
					w.$Telescope_SetVisual( 2 );
				}
				w.$Telescope_SetVisualSize( subitem );
				w.$Telescope_VClearS();
				if( w.$TelescopeFixedTel != 1 )
					w.$Telescope_VShow(); //repaint visual target and ring
				else player.consoleMessage(&quot;Your cheaply fixed Telescope can not show visual target, buy full repair.&quot;,5);
//				player.consoleMessage(subitem+&quot; &quot;+w.$TelescopeVSize+&quot; &quot;+w.$TelescopeVZoomSize ); //debug
				break;
		}
		//show subitem in settings
		player.consoleMessage( menu[ this.$Telescopeeq_MenuItem ][ 0 ]
			+&quot; &quot;+menu[ this.$Telescopeeq_MenuItem ][ subitem ], 5 );
	}
}

this.mode = function ()
{
	this.$Telescopeeq_MenuItem++;//step forward in the current menu
	var menu = this.$Telescopeeq_Menu;
	if( this.$Telescopeeq_MenuItem &gt;= menu.length ) this.$Telescopeeq_MenuItem = 0; //back to the first menu item
	var sub = &quot;&quot;;
	var item = this.$Telescopeeq_MenuItem;
	var subitem = this.$Telescopeeq_GetSubItem( item );
	if( menu[ item ][ subitem ] ) sub = &quot; &quot; + menu[ item ][ subitem ]; //no subitem with commands
	player.consoleMessage( menu[ item ][ 0 ] + sub, 5 );
}


//Telescope primable equipment method
this.$Telescopeeq_GetSubItem = function ( item ) {
	var w = worldScripts[&quot;telescope&quot;];
	switch( item ) {
		case 4: //Lightballs
			var m = missionVariables.$TelescopeMenuLightballs;
			if( m &gt; 0 ) return( m );
			if( !w.$TelescopeLightBalls ) return( 1 ); //off
			if( !w.$TelescopeShipLightBalls ) return( 2 ); //ship off
			if( !w.$TelescopeMassLockBorders ) return( 3 ); //masslockborders off
			if( !w.$TelescopeLargeLightBalls ) return( 4 ); //small
			return( 4 ); //large
		case 5: //Sniper ring km
			var m = missionVariables.$TelescopeMenuSniper;
			if( m &gt; 0 ) return( m );
			var max = w.$TelescopeSniperRange;
			var min = w.$TelescopeSniperMinRange;
			if( max == min ) return( 1 ); //off
			var p = 0; //max = 25.6km
			if( max &gt; 25600 ) p = 3; //add this to reach subitems with max = 30km
			if( min &lt;= 5000 ) return( 2 + p ); // &quot;5-25.6&quot; or &quot;5-30&quot;
			if( min &gt;= 15000 ) return( 4 + p ); // &quot;15-25.6&quot; or &quot;15-30&quot;
			return( 3 + p ); // &quot;10-25.6&quot; or &quot;10-30&quot;
		case 6: //Steering
			var m = missionVariables.$TelescopeMenuSteering;
			if( m &gt; 0 ) return( m );
			return( w.$TelescopeSteering + 1 );
		case 7: //Targets
			var m = missionVariables.$TelescopeMenuTargets;
			if( m &gt; 0 ) return( m );
			if( w.$TelescopeRedAlertLimiter ) return( 1 ); //20 and limitation in red alert
			if( w.$TelescopeTargets &lt;= 50 ) return( 2 ); //50
			if( w.$TelescopeTargets &gt;= 200 ) return( 4 ); //200
			return( 3 ); //100
		case 8: //Visual target
			var m = missionVariables.$TelescopeMenuVisual;
			if( m &gt; 0 ) return( m );
			if( w.$TelescopeVZoomSize &lt;= 0 ) return( 1 ); //off
			if( !w.$TelescopeShowVisualTarget ) return( 2 ); //weapons off
			if( !w.$TelescopeRing ) return( 3 ); //no ring
			if( !w.$TelescopeShowVisualStation ) return( 4 ); //no station
			if( !w.$TelescopeShowVisualQuestionMark ) return( 5 ); //no &quot;?&quot;
			return( 6 ); //all
		case 9: //Visual target size (VZoomSize=0 if full off)
			var m = missionVariables.$TelescopeMenuVisualSize;
			if( m &gt; 0 ) return( m );
			var size = w.$TelescopeVSize;
			if( !w.$TelescopeRing ) size -= 2;
			if( !size ) return( 5 ); //default
			if( size &lt; 2 ) return( 1 );
			if( size &gt; 7 ) return( 8 );
			return( size );
	}
	return( -2 ); //no subitem with commands
}


/* //old events
this.activated = function ()
{	//lock the nearest target
	w.$Telescope_Nearest();
	w.$Telescope_Steer();//turn to the target
}

this.mode = function ()
{	//lock the most centered target
	w.$Telescope_MostCentered( null, &quot;mode&quot;, false );
	w.$Telescope_Steer();//turn to the current target
//	w.$Telescope_List( 0 );//show target name
}
*/

//this.___ = function () { //step forward - need new button
//	w.$Telescope_List( 1 );
//}

//this.___ = function () { //step backward - need new button
//	w.$Telescope_List( -1 );
//}

//this.___ = function () { //turn on and off visual target - need new button
//	if( w.$TelescopeShowVisualTarget )
//		w.$TelescopeShowVisualTarget = false;
//	else w.$TelescopeShowVisualTarget = true;
//}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/xlonly.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;xlonly&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;This equipment is usable only for ships from 400t like Anaconda or Hard Python.&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context)
{
//	player.consoleMessage( eqKey+&quot; &quot;+ship+&quot; &quot;+context );//debug
	if( ship.mass &gt;= 400000 ) return true;
	else return false;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
