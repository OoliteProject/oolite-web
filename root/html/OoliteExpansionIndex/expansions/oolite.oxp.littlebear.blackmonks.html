<html>
    <head>
        <title>Expansion Bank of the Black Monks</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Bank of the Black Monks</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">14 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">8 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Bank of the Black Monks invites you to undertake a short term financial pilgrimage for the Black Monks of St. Herod. In addition monasteries, that can be found in safe and advanced systems, sell blessed Holy Fuel. Beware of the Black Monk Gunships that persecute defaulters.</td>
                    <td>Bank of the Black Monks invites you to undertake a short term financial pilgrimage for the Black Monks of St. Herod. In addition monasteries, that can be found in safe and advanced systems, sell blessed Holy Fuel. Beware of the Black Monk Gunships that persecute defaulters.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.littlebear.blackmonks</td>
                    <td>oolite.oxp.littlebear.blackmonks</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Bank of the Black Monks</td>
                    <td>Bank of the Black Monks</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Activities</td>
                    <td>Activities</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>LittleBear, Griff, spara</td>
                    <td>LittleBear, Griff, spara</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>2.2.1</td>
                    <td>2.2.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Black_Monk_Monastery">http://wiki.alioth.net/index.php/Black_Monk_Monastery</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/a/a6/Blackmonks_2.2.1.oxz">https://wiki.alioth.net/img_auth.php/a/a6/Blackmonks_2.2.1.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873403</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Bank%20of%20the%20Black%20Monks'>http://wiki.alioth.net/index.php/Bank%20of%20the%20Black%20Monks</a></p>
        <h3>readme.txt</h3>
        <pre>			      Bank of the Black Monks OXP - V2.2.1
			     ------------------------------------

* Original concept (v1.x), reconcepting and flavor texts by &quot;LittleBear&quot;
* Reconcepting and scripting by &quot;spara&quot;
* Models, textures and shaders by &quot;Griff&quot;

------------------------------------------------------------------------------------------------

An addon for Oolite by Giles Williams.

Based on &quot;Elite&quot; by Ian Bell and David Braben.

Update history
---------------
Version 2.2.1 - A missing semicolon added to the shipdata.
Version 2.2 - Texts reproofread and aged by Diziet Sma. A new one shot welcome page shown when entering a monastery for the first time. New names for Defence Ships. Renamed gunship to be &quot;Holy Avenger Mark II&quot; and defence ship to be &quot;Holy Defender Mark I&quot;.
Version 2.1.1 - Texts proofread and corrected by Cody.
Version 2.1 - screenIDs idded to the mission screens for compatibility with other OXPs. Monk image added as an overlay instead of background picture. New bigger monk image. Bug fixes.
Version 2.0 - A full rewrite and reconcepting of the OXP. (25.6.2015)

Version 1.46 - Corrected typo in equipment.plist
Version 1.45 - Corrected another typo in equipment.plist
version 1.44 - Added copy of minesweeperAI from Randon Hits oxp to remove the dependancy on that OXP being installed
Version 1.43 - Lengthened the dock object to workaround defence ship calmness - they now get angry faster :)
Version 1.42 - fixed incorrect weapon rage &amp; energy stats on one of the defence ship turrets
Version 1.41 - removed bounty setting from defence ship, set scan_class to Neutral. Increased defence ship toughness stats
Version 1.4 - added Blackmonk Station Defence Ship
Version 1.3 - fixed the wrong shader vertex applied to station turrets 
Version 1.2 - um, can&#39;t remember the changes
Version 1.12 - Updated shaders slightly to avoid ATI missing texture bug. Added Materials so some shader effects work for on computers unable to run shaders
Version 1.1 - 27th January 2007. 


-------------------------------------------------------------------------------------------------

Added:-
-------

- Vast Black Monk Monasterys appear in safe high tech Systems.
- Players can to undertake a short term financial pilgrimage for the Black Monks.
- The dreaded Black Monk Gunships can be seen shooting down NPC debtors who failed to pay up.
- Players who fail to repay on time will also find themselves in a Gunship&#39;s sights!
- Holy Fuel buyable from the Monasteries.

LittleBear, Griff &amp; spara
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_HOLY_FUEL.html">Holy Fuel</a></td>
                    <td>yes</td>
                    <td align="right">800</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_defenceship_engineblock.html">Blackmonk Station Defence</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_defenceship_exhaust.html">Blackmonk Station Defence</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_defenceship_mainhull.html">Holy Defender Mark I</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_defenceship_turret.html">Blackmonk Station Defence</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_gunship.html">Holy Avenger Mark II</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_gunship_turret.html">Blackmonk Gunship</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_gunship_wing_l.html">Blackmonk Gunship</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_gunship_wing_r.html">Blackmonk Gunship</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_mineradar.html">Mine Sweeper Satellite Radar Dish</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_minesweeper.html">Mine Sweeper Satellite</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_monastery.html">Black Monk Monastery</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_monastery_dock.html">Docking Bay</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_monastery_subents.html">Blackmonk Monastery</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/blackmonk_monastery_turret.html">Turret</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           =    &quot;blackmonk_conditions&quot;;

this.allowAwardEquipment = function(eqKey, ship, context) {
	if (!player.ship.dockedStation.hasRole(&quot;blackmonk_monastery&quot;))
		return false;
	return true;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_defence.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;blackmonk_defence&quot;;
this.description    = &quot;defence script to name the ship&quot;;

this.shipSpawned = function() {
	ship.shipUniqueName = expandDescription(&quot;[monk-defence-ship-name]&quot;);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_fuel.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name               = &quot;blackmonk_fuel&quot;;

this.startUp = function() {
	this.$fillSound = new SoundSource;
	this.$fillSound.sound = &quot;blackmonk_fill.ogg&quot;;
	if (missionVariables.blackmonk_fuel) {
		this.$condensedFuel = missionVariables.blackmonk_fuel;
	} else this.$condensedFuel = 0;
}

this.playerWillSaveGame = function() {
	missionVariables.blackmonk_fuel = this.$condensedFuel;
}

this.playerBoughtEquipment = function(equipment) {
	if (equipment === &quot;EQ_HOLY_FUEL&quot;) {
		player.ship.removeEquipment(equipment);
		player.ship.fuel = 7;
		this.$condensedFuel = 10.5;//1.5*7 = 10.5
	}
	else if (equipment === &quot;EQ_FUEL&quot;) this.$condensedFuel = 0;
}

this.shipWillLaunchFromStation = function() {
	if (this.$condensedFuel &gt; 7) {
		this.$fuelMonitor = new Timer(this, this._fuelMonitor, 0, 1);
	}
}

this.shipWillDockWithStation = function() {
	if (this.$fuelMonitor) {
		this.$fuelMonitor.stop();
		delete this.$fuelMonitor;
	}
}

this._fuelMonitor = function() {
	if (player.ship.fuel &lt; 7 &amp;&amp; this.$condensedFuel &gt; player.ship.fuel &amp;&amp; !this.$fuelAnimation) {
		this.$fuelAnimation = addFrameCallback(this._fuelAnimation.bind(this));
	}
}

this._fuelAnimation = function() {
	if (player.ship.fuel &lt; 7 &amp;&amp; this.$condensedFuel &gt; player.ship.fuel) {
		player.ship.fuel += 0.1;
		this.$condensedFuel -= 0.1;
		if (!this.$fillSound.isPlaying) this.$fillSound.play();
	}
	else {
		removeFrameCallback(this.$fuelAnimation);
		delete this.$fuelAnimation;
		//all gone?
		if (player.ship.fuel &lt; 7) {
			this.$condensedFuel = 0;
			this.$fuelMonitor.stop();
			delete this.$fuelMonitor;
		}
	}
}

</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_gunship.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;blackmonk_gunship&quot;;
this.description    = &quot;gunship script to trigger debtor pleas and name the ship&quot;;

this.shipAttackedOther = function(other){
	if (other.$monkDebtor &amp;&amp; Math.random() &lt; 0.1) {
		other.commsMessage(&quot;[debtor-plea]&quot;);
	}
}

this.shipSpawned = function() {
	ship.shipUniqueName = expandDescription(&quot;[monk-ships]&quot;);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_main.js</td>
                    <td><pre>//17.7.2015 -spara-

&quot;use strict&quot;;

this.name               = &quot;blackmonks&quot;;
this.author				= &quot;spara&quot;;
this.description		= &quot;Main script for Black Monks&quot;;

this.startUp = function() {
	if (missionVariables.blackmonk_contract) {
		this.$contract = JSON.parse(missionVariables.blackmonk_contract);
		delete missionVariables.blackmonk_contract;
	}
	this._setMonkSystems();
	//control payback on docking
	this.$offerOnce = false;
	//control one shot welcome screen
	if (!missionVariables.blackmonk_intro) this.$monkIntro = true;
	else this.$monkIntro = false;
}

this.playerEnteredNewGalaxy = function() {
	this._setMonkSystems();
}

//make a list of suitable monk systems
this._setMonkSystems = function() {
	this.$monkSystems = new Array();
	this.$monkSystemIDs = new Array();
	
	//first we&#39;ll utilize the basic rules
	var systems = SystemInfo.filteredSystems(this, function(other) {
		if (other.government &gt;= 6 &amp;&amp; other.techlevel &gt;= 11 &amp;&amp; !other.sun_gone_nova) {
			return (other);
		}
	});
	
	//only systems that are connected to others so that missions work are accepted
	for (var i = 0; i &lt; systems.length; i++) {
		var destinations = 0;
		for (var j = 0; j &lt; systems.length; j++) {
			var routeInfo = System.infoForSystem(galaxyNumber, systems[i].systemID).routeToSystem(systems[j]);
			if (routeInfo &amp;&amp; routeInfo.route.length &gt; 9) destinations++;
		}
		if (destinations &gt; 0) {
			this.$monkSystems.push(systems[i]);
			this.$monkSystemIDs.push(systems[i].systemID);
		}
	}
}

this.playerWillSaveGame = function() {
	if (this.$contract) {
		missionVariables.blackmonk_contract = JSON.stringify(this.$contract);
	}
}

this.startUpComplete = this.shipDockedWithStation = function() {
	if (player.ship.dockedStation.name === &quot;Black Monk Monastery&quot;) {
		player.ship.dockedStation.setInterface(&quot;blackmonks&quot;,{ 
			title: expandMissionText(&quot;monk_interface_title&quot;),
			category: &quot;Contracts&quot;,
			summary: expandMissionText(&quot;monk_interface_summary&quot;),
			callback: this._bankingInterface.bind(this)
		});
	}
}

this.shipWillDockWithStation = function(station) {
	//offer payback on docking
	this.$offerOnce = true;
}

//force payback the the player is late and the destination is correct
this.missionScreenOpportunity = function() {
	//one shot welcome screen
	if (this.$monkIntro &amp;&amp; player.ship.dockedStation.name === &quot;Black Monk Monastery&quot;) {
		mission.runScreen({
			titleKey: &quot;monk_title&quot;,
			screenID: &quot;blackmonks&quot;,
			messageKey: &quot;monk_first_visit_one_off_intro&quot;, 
		});
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
		this.$monkIntro = false;
		missionVariables.blackmonk_intro = 1;
	}
	if (player.ship.dockedStation.name === &quot;Black Monk Monastery&quot; &amp;&amp; this.$contract) {
		//correct destination
		if ((this.$contract.galaxy === galaxyNumber &amp;&amp; this.$contract.system === system.ID) || this.$contract.galaxy !== galaxyNumber) {
			missionVariables.monk_dest_name = System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name;
			//late, force payback
			if (this.$contract[&quot;dealine&quot;] - clock.seconds &lt; 0) {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_late&quot;,
						choicesKey: &quot;monk_payback_force&quot;
					},
					function (choice) {
						this._payback();
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
			}
			//enough credits
			else if (this.$offerOnce &amp;&amp; player.credits &gt;= 30000) {screenID: &quot;blackmonks&quot;,
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_early&quot;, 
						choicesKey: &quot;monk_payback_choices&quot;
					},
					function (choice) {
						if (choice === &quot;1_YES&quot;) {
							this._payback();
						}
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
			}
			delete missionVariables.monk_dest_name;
		}
	}
	this.$offerOnce = false;
}

this._bankingInterface = function(page) {
	//contract running
	if (this.$contract) {
		//correct destination early with sufficient credits
		if (((this.$contract.galaxy === galaxyNumber &amp;&amp; this.$contract.system === system.ID) || (this.$contract.galaxy !== galaxyNumber)) &amp;&amp; player.credits &gt;= 30000) {
			mission.runScreen({
					titleKey: &quot;monk_title&quot;,
					screenID: &quot;blackmonks&quot;,
					messageKey: &quot;monk_payback_early&quot;, 
					choicesKey: &quot;monk_payback_choices&quot;,
					exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
				},
				function (choice) {
					if (choice === &quot;1_YES&quot;) {
						this._payback();
					}
				}
			);
		}
		//wrong destination or early without sufficient funds
		else {
			missionVariables.monk_dest_name = System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name;	//in time, godspeed to the player
			if (this.$contract[&quot;dealine&quot;] - clock.seconds &gt;= 0) {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_wrong_destination&quot;, 
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);
			}
			//too late, hurry the player up
			else {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_wrong_destination_late&quot;, 
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);			
			}
			delete missionVariables.monk_dest_name;
		}
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
	}
	//offer contract, if there isn&#39;t one running
	else {
		switch (page) {
			case &quot;blackmonks&quot;: 
				//only offer for hyperspace capable ships
				if (player.ship.hasHyperspaceMotor) {
					mission.runScreen({
							titleKey: &quot;monk_title&quot;,
							screenID: &quot;blackmonks&quot;,
							messageKey: &quot;monk_welcome&quot;, 
							choicesKey: &quot;monk_welcome_choices&quot;,
							exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
						},
						function (choice) {
							if (choice === &quot;1_YES&quot;) {
								this._bankingInterface(&quot;offer_list&quot;);
							}
						}
					);
				}
				else {
					mission.runScreen({
							titleKey: &quot;monk_title&quot;,
							screenID: &quot;blackmonks&quot;,
							messageKey: &quot;monk_welcome_no_dice&quot;, 
							exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
						}
					);
				}
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
			case &quot;offer_list&quot;:
				this.$destinations = new Array();
				for (var i = 0; i &lt; this.$monkSystems.length; i++) {
					var routeInfo = system.info.routeToSystem(this.$monkSystems[i]);
					if (routeInfo &amp;&amp; routeInfo.route.length &gt; 9) {
						this.$destinations.push(this.$monkSystems[i]);
					}
				}

				//offer max five shortest routest
				this.$destinations.sort(function(a, b){return system.info.routeToSystem(a).route.length - system.info.routeToSystem(b).route.length});
				if (this.$destinations.length &gt; 5) {
					this.$destinations = this.$destinations.slice(0, 5);
				}
				var options = {};
				for (var i = 0; i &lt; this.$destinations.length; i++) {
					var info = system.info.routeToSystem(this.$destinations[i]);
					var origHours = info.time;
					var days = Math.ceil(origHours/24) + Math.ceil(info.route.length / 12); //extra 0.5 hours per system on route rounded up
					var distance = System.infoForSystem(galaxyNumber, system.ID).distanceToSystem(this.$destinations[i]).toFixed(1);
					options[i+&quot;_DEST&quot;] = this.$destinations[i].name + &quot;, &quot; + distance + &quot; light years in &quot; + days + &quot; days&quot;;
				}
				options[&quot;99_EXIT&quot;] = &quot;Exit&quot;;
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_offer_list&quot;,
						choices: options,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}, 
					function (choice) {
						if (choice !== &quot;99_EXIT&quot;) {
							this.$offerPointer = choice.split(&#39;_&#39;)[0];
							this._setOffer(&quot;init&quot;);
							this.$mapMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
							this.$prevChoice = &quot;3_NEXT&quot;;
							this.$restoreDestination = player.ship.targetSystem;
							this._bankingInterface(&quot;offer_map&quot;);
						}
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
			case &quot;offer_map&quot;:
				player.ship.hudHidden = true;
				player.ship.targetSystem = this.$destinations[this.$offerPointer].systemID;
				
				var options = new Object;
				options[&quot;2_PREV&quot;] = expandMissionText(&quot;monk_map_prev&quot;);
				options[&quot;3_NEXT&quot;] = expandMissionText(&quot;monk_map_next&quot;);
				options[&quot;4_BACK&quot;] = expandMissionText(&quot;monk_map_back&quot;);
				options[&quot;5_SIGN&quot;] = expandMissionText(&quot;monk_map_sign&quot;);
				options[&quot;6_EXIT&quot;] = expandMissionText(&quot;monk_map_exit&quot;);
				if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
					if (this.$mapMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) {
						options[&quot;1_MODE&quot;] = expandMissionText(&quot;monk_map_mode1&quot;);
					}
					else {
						options[&quot;1_MODE&quot;] = expandMissionText(&quot;monk_map_mode2&quot;);
					}
				}

				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks-map&quot;,
						backgroundSpecial: this.$mapMode,
						messageKey: &quot;monk_offer_details&quot;,
						choices: options,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
						initialChoicesKey: this.$prevChoice
					},
					function (choice) {
						this.$prevChoice = choice;
						if (choice === &quot;1_MODE&quot;) {
							if (this.$mapMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) {
								this.$mapMode = &quot;LONG_RANGE_CHART_QUICKEST&quot;;
							}
							else {
								this.$mapMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
							}
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;3_NEXT&quot;) {
							this._setOffer(&quot;next&quot;);
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;2_PREV&quot;) {
							this._setOffer(&quot;prev&quot;);
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;4_BACK&quot;) {
							this._cleanUp();
							this._bankingInterface(&quot;offer_list&quot;);
						}
						else if (choice === &quot;5_SIGN&quot;) {
							player.ship.hudHidden = false;
							this._bankingInterface(&quot;offer_sign&quot;);
						}
						else this._cleanUp();
					}
				);
				break;
			case &quot;offer_sign&quot;:
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						messageKey: &quot;monk_offer_sign&quot;,
						screenID: &quot;blackmonks&quot;,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);
				//tip the player about the ANA
				if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) !== &quot;EQUIPMENT_OK&quot;) {				
					mission.addMessageTextKey(&quot;monk_offer_sign_tip&quot;);
				}
				this._cleanUp();
				this.$contract = new Object;
				this.$contract[&quot;galaxy&quot;] = galaxyNumber;
				this.$contract[&quot;system&quot;] = this.$destinations[this.$offerPointer].systemID;
				this.$contract[&quot;dealine&quot;] = clock.seconds + this.$days * 86400;
				player.credits += 20000;
				mission.markSystem({system: this.$contract[&quot;system&quot;], name: &quot;blackmonks&quot;});
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
		}
	}
}

this._payback = function() {
	//clear the marker
	mission.unmarkSystem({system: this.$contract[&quot;system&quot;], name: &quot;blackmonks&quot;});
	//enough credits
	if (player.credits &gt;= 30000) {
		player.credits -= 30000;
		delete this.$contract;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
	}
	//not enough credits, but enough equipment
	else if (this._evaluateEquipment() + player.credits &gt;= 30000) {
		var sellOutcome = this._sellEquipment();
		missionVariables.monk_equipment_total = formatCredits(sellOutcome[1], true, true);
		missionVariables.monk_equipment_list = sellOutcome[0].join(&quot;, &quot;);
		player.credits -= 30000;
		delete this.$contract;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_not_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		mission.addMessageTextKey(&quot;monk_payback_equipment&quot;);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
		delete missionVariables.monk_equipment_total;
		delete missionVariables.monk_equipment_list;
	}
	//not enough credits, not enough equipment, have to sell the ship
	else {
		var sellOutcome = this._sellEquipment();
		missionVariables.monk_equipment_total = formatCredits(sellOutcome[1], true, true);
		missionVariables.monk_equipment_list = sellOutcome[0].join(&quot;, &quot;);
		missionVariables.monk_old_ship = formatCredits(0.5 * player.ship.price, true, true);
		this._sellShip();
		missionVariables.monk_new_ship = formatCredits(player.ship.price, true, true);
		player.credits -= 30000;
		player.credits -= player.ship.price;
		delete this.$contract;
		player.ship.hudHidden = true;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_not_nearly_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		missionVariables.monk_balance = formatCredits(player.credits, true, true);	
		mission.addMessageTextKey(&quot;monk_payback_equipment&quot;);
		mission.addMessageTextKey(&quot;monk_payback_ship&quot;);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
		
		delete missionVariables.monk_equipment_total;
		delete missionVariables.monk_equipment_list;
		delete missionVariables.monk_old_ship;
		delete missionVariables.monk_new_ship;
		delete missionVariables.monk_balance;
	}
}

//calculate the value of weapons, missiles and the installed equipment
this._evaluateEquipment = function() {
	var value = 0;
	var equipments = player.ship.equipment;
	for (var i = 0; i &lt; equipments.length; i++) {
		if (equipments[i].price &gt; 0 &amp;&amp; player.ship.equipmentStatus(equipments[i]) === &quot;EQUIPMENT_OK&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_CARGO_BAY&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_PASSENGER_BERTH&quot;) {
			value += equipments[i].price;
		}
	}
	var missiles = player.ship.missiles;
	for (var i = 0; i &lt; missiles.length; i++) {
		if (missiles[i].price &gt; 0) {
			value += missiles[i].price;
		}
	}
	if (player.ship.portWeapon &amp;&amp; player.ship.portWeapon.price &gt; 0) {
		value += player.ship.portWeapon.price;
	}
	if (player.ship.aftWeapon &amp;&amp; player.ship.aftWeapon.price &gt; 0) {
		value += player.ship.aftWeapon.price;
	}
	if (player.ship.starboardWeapon &amp;&amp; player.ship.starboardWeapon.price &gt; 0) {
		value += player.ship.starboardWeapon.price;
	}
	if (player.ship.forwardWeapon &amp;&amp; player.ship.forwardWeapon.price &gt; 0) {
		value += player.ship.forwardWeapon.price;
	}
	return value / 10;
}

//pay with equipment
this._sellEquipment = function() {
	
	var stripped = new Array();
	var oldBalance = player.credits;
	
	//strip the missiles
	var missiles = player.ship.missiles;
	for (var i = 0; i &lt; missiles.length; i++) {
		if (player.credits &lt; 30000) {
			if (missiles[i].price &gt; 0) {
				player.credits += missiles[i].price / 10;
				stripped.push(missiles[i].name);
				player.ship.removeEquipment(missiles[i]);
			}
		}
	}
	//strip equipment except for LCB and berths. EQ_CARGO_BAY,EQ_PASSENGER_BERTH
	var equipments = player.ship.equipment;
	for (var i = 0; i &lt; equipments.length; i++) {
		if (player.credits &lt; 30000) {
			if (equipments[i].price &gt; 0 &amp;&amp; player.ship.equipmentStatus(equipments[i]) === &quot;EQUIPMENT_OK&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_CARGO_BAY&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_PASSENGER_BERTH&quot;) {
				player.credits += equipments[i].price / 10;
				stripped.push(equipments[i].name);
				player.ship.removeEquipment(equipments[i]);
			}
		}
	}
	//strip lasers
	if (player.credits &lt; 30000) {
		if (player.ship.portWeapon &amp;&amp; player.ship.portWeapon.price &gt; 0) {
			player.credits += player.ship.portWeapon.price / 10;
			stripped.push([player.ship.portWeapon.name, player.ship.portWeapon.price / 10]);
			player.ship.boardWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.starboardWeapon &amp;&amp; player.ship.starboardWeapon.price &gt; 0) {
			player.credits += player.ship.starboardWeapon.price / 10;
			stripped.push(player.ship.starboardWeapon.name);
			player.ship.starboardWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.aftWeapon &amp;&amp; player.ship.aftWeapon.price &gt; 0) {
			player.credits += player.ship.aftWeapon.price / 10;
			stripped.push(player.ship.aftWeapon.name);
			player.ship.aftWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.forwardWeapon &amp;&amp; player.ship.forwardWeapon.price &gt; 0) {
			player.credits += player.ship.forwardWeapon.price / 10;
			stripped.push(player.ship.forwardWeapon.name);
			player.ship.forwardWeapon = null;
		}
	}
	
	
	return([stripped, player.credits - oldBalance]);
}

this._sellShip = function() {
	//no matter in what condition the player ship is, always sell for 50% of mint price
	var refundFactor = 0.5;
	player.credits += player.ship.price * refundFactor;
	player.replaceShip(&quot;adder-player&quot;);
	player.ship.removeEquipment(&quot;EQ_HEAT_SHIELD&quot;);
	player.ship.removeEquipment(&quot;EQ_MISSILE&quot;);
	player.ship.serviceLevel = 75;
}


//clean up mission variables and restore target system
this._cleanUp = function() {
	if (missionVariables.monk_dest_name) {
		player.ship.hudHidden = false;
		delete missionVariables.monk_dest_name;
		delete missionVariables.monk_time;
		delete missionVariables.monk_deadline;
		player.ship.targetSystem = this.$restoreDestination;
	}
}

this.guiScreenWillChange = function(to, from) {
	if (this.$contract &amp;&amp; to === &quot;GUI_SCREEN_MANIFEST&quot;) {
		var secsLeft = this.$contract[&quot;dealine&quot;] - clock.seconds;
		var hoursLeft = Math.floor((secsLeft) / 3600);
		if (hoursLeft &gt; 0) {
			var daysText = &quot; in &quot; + hoursLeft + &quot; hours.&quot;;
		}
		else if (hoursLeft === 0) {
			var daysText = &quot; in less than an hour!&quot;;
		}
		else var daysText = &quot;. Deadline has passed!&quot;;
		mission.setInstructions(&quot;Pay 30 000 credits to the Black Monk Monastery at &quot; + System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name + daysText);
	}
	else if (!this.$contract) {
		player.ship.hudHidden = false;
		mission.setInstructions(null);
	}
}

this._setOffer = function(action) {
	if (action === &quot;next&quot;) {
		this.$offerPointer++;
		if (this.$offerPointer &gt;= this.$destinations.length) {
			this.$offerPointer = 0;
		}
	}
	else if (action === &quot;prev&quot;) {
		this.$offerPointer--;
		if (this.$offerPointer &lt;= 0) {
			this.$offerPointer = this.$destinations.length - 1;
		}
	}
	var info = system.info.routeToSystem(this.$destinations[this.$offerPointer]);
	var origHours = info.time;
	this.$days = Math.ceil(origHours/24) + Math.ceil(info.route.length / 12);//0.5 hours per system on route rounded up to full days
	missionVariables.monk_dest_name = this.$destinations[this.$offerPointer].name;
	missionVariables.monk_time = this.$days + &quot; days (&quot; + this.$days * 24 + &quot; hours)&quot;;
	missionVariables.monk_deadline = clock.days + this.$days;
}

this.systemWillPopulate = function() {

	if (this.$monkSystemIDs.indexOf(system.ID) !== -1) {
		system.setPopulator(&quot;blackmonk_station&quot;, {
			
			callback: function(pos) {
				var monastery = system.addShips(&quot;blackmonk_monastery&quot;, 1, pos, 0)[0];
				monastery.orientation = [1, 0, 1, 0];
				var minesweepers = system.addShips(&quot;blackmonk_minesweeper&quot;, 10, pos, 15E3);
				for (var i = 0; i &lt; minesweepers.length; i++) {
					//init the alert mechanism of minesweepers.
					minesweepers[i].script.$mother = monastery;
				}
			}.bind(this),
			location: &quot;LANE_WP&quot;,
			locationSeed: 937,
			deterministic: true
		});
	}
	
	//retribution time
	
	//now the player is in trouble. increasing number of gunships are being spawned close to the witchpoint every time the player enters a system.
	if (this.$contract &amp;&amp; this.$contract[&quot;dealine&quot;] - clock.seconds &lt; 0) {
		var count = Math.ceil((clock.seconds -this.$contract[&quot;dealine&quot;]) / 86400);
		if (count &gt; 5) count = 5;
		system.setPopulator(&quot;blackmonk_punishers&quot;, {
			callback: function(pos) {
				system.addGroup(&quot;blackmonk_gunship&quot;, count, pos);
			}.bind(this),
			location: &quot;WITCHPOINT&quot;
		});
	}
	
	//ambiance
	
	//gunships are ridiculously powerful, but very rare. roughly every tenth system has one cruising. running contract doubles the odds to start with and ramps them up close to the deadline.
	if (this.$contract) {
		var div = (Math.ceil(this.$contract[&quot;dealine&quot;] - clock.seconds) / 86400);
		if (div &gt;= 2) {
			var prob = 2 / (Math.ceil(this.$contract[&quot;dealine&quot;] - clock.seconds) / 86400);
			if (prob &lt; 0.2) prob = 0.2;
		}
		else var prob = 1;
	}
	else var prob = 0.1;
	
	if (Math.random() &lt; prob) {
		system.setPopulator(&quot;blackmonk_ambiance_gunship&quot;, {
			callback: function(pos) {
				//half the time, spawn ambiance ships close to the witchpoint and move them a bit closer to the planet. a bit is a 0.75 * scanner range. it&#39;s a bit boring to all the time have them sitting next to the witchpoint. a bit too staged to my liking.
				if (Math.random() &lt; 0.5) {
					var gunship = system.addShips(&quot;blackmonk_gunship&quot;, 1)[0];
					gunship.position = gunship.position.add([0, 0, 19200]);
					var debtor = system.addShips(&quot;trader&quot;, 1, gunship.position)[0];
				}
				else {
					var gunship = system.addShips(&quot;blackmonk_gunship&quot;, 1, pos)[0];
					var debtor = system.addShips(&quot;trader&quot;, 1, gunship.position)[0];
				}
				debtor.$monkDebtor = true;
				debtor.fuel = 0;//no escape
			}.bind(this),
			location: &quot;LANE_WP&quot;
		});
		//this is a long shot, a lonely debtor leisurely cruising the lane. with some seriusly bad load of luck it just might meet a blackmonk gunship.
		system.setPopulator(&quot;blackmonk_ambiance_wandering_debtor&quot;, {
			callback: function(pos) {
				var debtor = system.addShips(&quot;trader&quot;, 1, pos)[0];
				debtor.$monkDebtor = true;
				debtor.fuel = 0;//no escape
			}.bind(this),
			location: &quot;LANE_WP&quot;
		});
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_minesweeper.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;blackmonk_minesweeper&quot;;
this.description    = &quot;Minesweeper ship script.&quot;;

//this.$mother is set from the populator

this.shipBeingAttacked = function(whom){
	//relay attack to the possible mother
	if (this.$mother) {
		this.$mother.script.shipBeingAttacked(whom);
		this.$mother.AIScript.shipBeingAttacked(whom);
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/blackmonk_station.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;blackmonk_station&quot;;
this.description    = &quot;Monastery ship script.&quot;;

//give a hostile player a warning when fired upon.
this.shipBeingAttacked = function(whom){
	var aiScript = ship.AIScript;
	if (whom.isPlayer &amp;&amp; aiScript.$warn) {
		aiScript.$warn = false;
		ship.commsMessage(&quot;[monk-warning]&quot;);
		if (aiScript.$adTimer) {
			aiScript.$adTimer.stop();
			delete aiScript.$adTimer;
		}
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/copy of blackmonk_main.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name               = &quot;blackmonks&quot;;
this.author				= &quot;spara&quot;;
this.description		= &quot;Main script for Black Monks&quot;;

this.startUp = function() {
	if (missionVariables.blackmonk_contract) {
		this.$contract = JSON.parse(missionVariables.blackmonk_contract);
		delete missionVariables.blackmonk_contract;
	}
	this._setMonkSystems();
	//control payback on docking
	this.$offerOnce = false;
}

this.playerEnteredNewGalaxy = function() {
	this._setMonkSystems();
}

//make a list of suitable monk systems
this._setMonkSystems = function() {
	this.$monkSystems = new Array();
	this.$monkSystemIDs = new Array();
	
	//first we&#39;ll utilize the basic rules
	var systems = SystemInfo.filteredSystems(this, function(other) {
		if (other.government &gt;= 6 &amp;&amp; other.techlevel &gt;= 11 &amp;&amp; !other.sun_gone_nova) {
			return (other);
		}
	});
	
	//only systems that are connected to others so that missions work are accepted
	for (var i = 0; i &lt; systems.length; i++) {
		var destinations = 0;
		for (var j = 0; j &lt; systems.length; j++) {
			var routeInfo = System.infoForSystem(galaxyNumber, systems[i].systemID).routeToSystem(systems[j]);
			if (routeInfo &amp;&amp; routeInfo.route.length &gt; 9) destinations++;
		}
		if (destinations &gt; 0) {
			this.$monkSystems.push(systems[i]);
			this.$monkSystemIDs.push(systems[i].systemID);
		}
	}
}

this.playerWillSaveGame = function() {
	if (this.$contract) {
		missionVariables.blackmonk_contract = JSON.stringify(this.$contract);
	}
}

this.startUpComplete = this.shipDockedWithStation = function() {
	if (player.ship.dockedStation.name === &quot;Black Monk Monastery&quot;) {
		player.ship.dockedStation.setInterface(&quot;blackmonks&quot;,{ 
			title: expandMissionText(&quot;monk_interface_title&quot;),
			category: &quot;Contracts&quot;,
			summary: expandMissionText(&quot;monk_interface_summary&quot;),
			callback: this._bankingInterface.bind(this)
		});
	}
}

this.shipWillDockWithStation = function(station) {
	//offer payback on docking
	this.$offerOnce = true;
}

//force payback the the player is late and the destination is correct
this.missionScreenOpportunity = function() {
	if (player.ship.dockedStation.name === &quot;Black Monk Monastery&quot; &amp;&amp; this.$contract) {
		//correct destination
		if ((this.$contract.galaxy === galaxyNumber &amp;&amp; this.$contract.system === system.ID) || this.$contract.galaxy !== galaxyNumber) {
			missionVariables.monk_dest_name = System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name;
			//late, force payback
			if (this.$contract[&quot;dealine&quot;] - clock.seconds &lt; 0) {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_late&quot;,
						choicesKey: &quot;monk_payback_force&quot;
					},
					function (choice) {
						this._payback();
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
			}
			//enough credits
			else if (this.$offerOnce &amp;&amp; player.credits &gt;= 30000) {screenID: &quot;blackmonks&quot;,
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_early&quot;, 
						choicesKey: &quot;monk_payback_choices&quot;
					},
					function (choice) {
						if (choice === &quot;1_YES&quot;) {
							this._payback();
						}
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
			}
			delete missionVariables.monk_dest_name;
		}
	}
	this.$offerOnce = false;
}

this._bankingInterface = function(page) {
	//contract running
	if (this.$contract) {
		//correct destination early with sufficient credits
		if (((this.$contract.galaxy === galaxyNumber &amp;&amp; this.$contract.system === system.ID) || (this.$contract.galaxy !== galaxyNumber)) &amp;&amp; player.credits &gt;= 30000) {
			mission.runScreen({
					titleKey: &quot;monk_title&quot;,
					screenID: &quot;blackmonks&quot;,
					messageKey: &quot;monk_payback_early&quot;, 
					choicesKey: &quot;monk_payback_choices&quot;,
					exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
				},
				function (choice) {
					if (choice === &quot;1_YES&quot;) {
						this._payback();
					}
				}
			);
		}
		//wrong destination or early without sufficient funds
		else {
			missionVariables.monk_dest_name = System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name;	//in time, godspeed to the player
			if (this.$contract[&quot;dealine&quot;] - clock.seconds &gt;= 0) {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_wrong_destination&quot;, 
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);
			}
			//too late, hurry the player up
			else {
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_payback_wrong_destination_late&quot;, 
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);			
			}
			delete missionVariables.monk_dest_name;
		}
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
	}
	//offer contract, if there isn&#39;t one running
	else {
		switch (page) {
			case &quot;blackmonks&quot;: 
				//only offer for hyperspace capable ships
				if (player.ship.hasHyperspaceMotor) {
					mission.runScreen({
							titleKey: &quot;monk_title&quot;,
							screenID: &quot;blackmonks&quot;,
							messageKey: &quot;monk_welcome&quot;, 
							choicesKey: &quot;monk_welcome_choices&quot;,
							exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
						},
						function (choice) {
							if (choice === &quot;1_YES&quot;) {
								this._bankingInterface(&quot;offer_list&quot;);
							}
						}
					);
				}
				else {
					mission.runScreen({
							titleKey: &quot;monk_title&quot;,
							screenID: &quot;blackmonks&quot;,
							messageKey: &quot;monk_welcome_no_dice&quot;, 
							exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
						}
					);
				}
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
			case &quot;offer_list&quot;:
				this.$destinations = new Array();
				for (var i = 0; i &lt; this.$monkSystems.length; i++) {
					var routeInfo = system.info.routeToSystem(this.$monkSystems[i]);
					if (routeInfo &amp;&amp; routeInfo.route.length &gt; 9) {
						this.$destinations.push(this.$monkSystems[i]);
					}
				}

				//offer max five shortest routest
				this.$destinations.sort(function(a, b){return system.info.routeToSystem(a).route.length - system.info.routeToSystem(b).route.length});
				if (this.$destinations.length &gt; 5) {
					this.$destinations = this.$destinations.slice(0, 5);
				}
				var options = {};
				for (var i = 0; i &lt; this.$destinations.length; i++) {
					var info = system.info.routeToSystem(this.$destinations[i]);
					var origHours = info.time;
					var days = Math.ceil(origHours/24) + Math.ceil(info.route.length / 12); //extra 0.5 hours per system on route rounded up
					var distance = System.infoForSystem(galaxyNumber, system.ID).distanceToSystem(this.$destinations[i]).toFixed(1);
					options[i+&quot;_DEST&quot;] = this.$destinations[i].name + &quot;, &quot; + distance + &quot; light years in &quot; + days + &quot; days&quot;;
				}
				options[&quot;99_EXIT&quot;] = &quot;Exit&quot;;
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks&quot;,
						messageKey: &quot;monk_offer_list&quot;,
						choices: options,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}, 
					function (choice) {
						if (choice !== &quot;99_EXIT&quot;) {
							this.$offerPointer = choice.split(&#39;_&#39;)[0];
							this._setOffer(&quot;init&quot;);
							this.$mapMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
							this.$prevChoice = &quot;3_NEXT&quot;;
							this.$restoreDestination = player.ship.targetSystem;
							this._bankingInterface(&quot;offer_map&quot;);
						}
					}
				);
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
			case &quot;offer_map&quot;:
				player.ship.hudHidden = true;
				player.ship.targetSystem = this.$destinations[this.$offerPointer].systemID;
				
				var options = new Object;
				options[&quot;2_PREV&quot;] = expandMissionText(&quot;monk_map_prev&quot;);
				options[&quot;3_NEXT&quot;] = expandMissionText(&quot;monk_map_next&quot;);
				options[&quot;4_BACK&quot;] = expandMissionText(&quot;monk_map_back&quot;);
				options[&quot;5_SIGN&quot;] = expandMissionText(&quot;monk_map_sign&quot;);
				options[&quot;6_EXIT&quot;] = expandMissionText(&quot;monk_map_exit&quot;);
				if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
					if (this.$mapMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) {
						options[&quot;1_MODE&quot;] = expandMissionText(&quot;monk_map_mode1&quot;);
					}
					else {
						options[&quot;1_MODE&quot;] = expandMissionText(&quot;monk_map_mode2&quot;);
					}
				}

				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						screenID: &quot;blackmonks-map&quot;,
						backgroundSpecial: this.$mapMode,
						messageKey: &quot;monk_offer_details&quot;,
						choices: options,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
						initialChoicesKey: this.$prevChoice
					},
					function (choice) {
						this.$prevChoice = choice;
						if (choice === &quot;1_MODE&quot;) {
							if (this.$mapMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) {
								this.$mapMode = &quot;LONG_RANGE_CHART_QUICKEST&quot;;
							}
							else {
								this.$mapMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
							}
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;3_NEXT&quot;) {
							this._setOffer(&quot;next&quot;);
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;2_PREV&quot;) {
							this._setOffer(&quot;prev&quot;);
							this._bankingInterface(&quot;offer_map&quot;);
						}
						else if (choice === &quot;4_BACK&quot;) {
							this._cleanUp();
							this._bankingInterface(&quot;offer_list&quot;);
						}
						else if (choice === &quot;5_SIGN&quot;) {
							player.ship.hudHidden = false;
							this._bankingInterface(&quot;offer_sign&quot;);
						}
						else this._cleanUp();
					}
				);
				break;
			case &quot;offer_sign&quot;:
				mission.runScreen({
						titleKey: &quot;monk_title&quot;,
						messageKey: &quot;monk_offer_sign&quot;,
						screenID: &quot;blackmonks&quot;,
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
					}
				);
				//tip the player about the ANA
				if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) !== &quot;EQUIPMENT_OK&quot;) {				
					mission.addMessageTextKey(&quot;monk_offer_sign_tip&quot;);
				}
				this._cleanUp();
				this.$contract = new Object;
				this.$contract[&quot;galaxy&quot;] = galaxyNumber;
				this.$contract[&quot;system&quot;] = this.$destinations[this.$offerPointer].systemID;
				this.$contract[&quot;dealine&quot;] = clock.seconds + this.$days * 86400;
				player.credits += 20000;
				mission.markSystem({system: this.$contract[&quot;system&quot;], name: &quot;blackmonks&quot;});
				setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
				break;
		}
	}
}

this._payback = function() {
	//clear the marker
	mission.unmarkSystem({system: this.$contract[&quot;system&quot;], name: &quot;blackmonks&quot;});
	//enough credits
	if (player.credits &gt;= 30000) {
		player.credits -= 30000;
		delete this.$contract;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
	}
	//not enough credits, but enough equipment
	else if (this._evaluateEquipment() + player.credits &gt;= 30000) {
		var sellOutcome = this._sellEquipment();
		missionVariables.monk_equipment_total = formatCredits(sellOutcome[1], true, true);
		missionVariables.monk_equipment_list = sellOutcome[0].join(&quot;, &quot;);
		player.credits -= 30000;
		delete this.$contract;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_not_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		mission.addMessageTextKey(&quot;monk_payback_equipment&quot;);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
		delete missionVariables.monk_equipment_total;
		delete missionVariables.monk_equipment_list;
	}
	//not enough credits, not enough equipment, have to sell the ship
	else {
		var sellOutcome = this._sellEquipment();
		missionVariables.monk_equipment_total = formatCredits(sellOutcome[1], true, true);
		missionVariables.monk_equipment_list = sellOutcome[0].join(&quot;, &quot;);
		missionVariables.monk_old_ship = formatCredits(0.5 * player.ship.price, true, true);
		this._sellShip();
		missionVariables.monk_new_ship = formatCredits(player.ship.price, true, true);
		player.credits -= 30000;
		player.credits -= player.ship.price;
		delete this.$contract;
		player.ship.hudHidden = true;
		mission.runScreen({
				titleKey: &quot;monk_title&quot;,
				messageKey: &quot;monk_payback_not_nearly_enough&quot;,
				screenID: &quot;blackmonks&quot;
			}
		);
		missionVariables.monk_balance = formatCredits(player.credits, true, true);	
		mission.addMessageTextKey(&quot;monk_payback_equipment&quot;);
		mission.addMessageTextKey(&quot;monk_payback_ship&quot;);
		mission.addMessageTextKey(&quot;monk_payback_welcome_back&quot;);
		setScreenOverlay({ name: &quot;monk.png&quot;, height: 480 });
		
		delete missionVariables.monk_equipment_total;
		delete missionVariables.monk_equipment_list;
		delete missionVariables.monk_old_ship;
		delete missionVariables.monk_new_ship;
		delete missionVariables.monk_balance;
	}
}

//calculate the value of weapons, missiles and the installed equipment
this._evaluateEquipment = function() {
	var value = 0;
	var equipments = player.ship.equipment;
	for (var i = 0; i &lt; equipments.length; i++) {
		if (equipments[i].price &gt; 0 &amp;&amp; player.ship.equipmentStatus(equipments[i]) === &quot;EQUIPMENT_OK&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_CARGO_BAY&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_PASSENGER_BERTH&quot;) {
			value += equipments[i].price;
		}
	}
	var missiles = player.ship.missiles;
	for (var i = 0; i &lt; missiles.length; i++) {
		if (missiles[i].price &gt; 0) {
			value += missiles[i].price;
		}
	}
	if (player.ship.portWeapon &amp;&amp; player.ship.portWeapon.price &gt; 0) {
		value += player.ship.portWeapon.price;
	}
	if (player.ship.aftWeapon &amp;&amp; player.ship.aftWeapon.price &gt; 0) {
		value += player.ship.aftWeapon.price;
	}
	if (player.ship.starboardWeapon &amp;&amp; player.ship.starboardWeapon.price &gt; 0) {
		value += player.ship.starboardWeapon.price;
	}
	if (player.ship.forwardWeapon &amp;&amp; player.ship.forwardWeapon.price &gt; 0) {
		value += player.ship.forwardWeapon.price;
	}
	return value / 10;
}

//pay with equipment
this._sellEquipment = function() {
	
	var stripped = new Array();
	var oldBalance = player.credits;
	
	//strip the missiles
	var missiles = player.ship.missiles;
	for (var i = 0; i &lt; missiles.length; i++) {
		if (player.credits &lt; 30000) {
			if (missiles[i].price &gt; 0) {
				player.credits += missiles[i].price / 10;
				stripped.push(missiles[i].name);
				player.ship.removeEquipment(missiles[i]);
			}
		}
	}
	//strip equipment except for LCB and berths. EQ_CARGO_BAY,EQ_PASSENGER_BERTH
	var equipments = player.ship.equipment;
	for (var i = 0; i &lt; equipments.length; i++) {
		if (player.credits &lt; 30000) {
			if (equipments[i].price &gt; 0 &amp;&amp; player.ship.equipmentStatus(equipments[i]) === &quot;EQUIPMENT_OK&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_CARGO_BAY&quot; &amp;&amp; equipments[i].equipmentKey !== &quot;EQ_PASSENGER_BERTH&quot;) {
				player.credits += equipments[i].price / 10;
				stripped.push(equipments[i].name);
				player.ship.removeEquipment(equipments[i]);
			}
		}
	}
	//strip lasers
	if (player.credits &lt; 30000) {
		if (player.ship.portWeapon &amp;&amp; player.ship.portWeapon.price &gt; 0) {
			player.credits += player.ship.portWeapon.price / 10;
			stripped.push([player.ship.portWeapon.name, player.ship.portWeapon.price / 10]);
			player.ship.boardWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.starboardWeapon &amp;&amp; player.ship.starboardWeapon.price &gt; 0) {
			player.credits += player.ship.starboardWeapon.price / 10;
			stripped.push(player.ship.starboardWeapon.name);
			player.ship.starboardWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.aftWeapon &amp;&amp; player.ship.aftWeapon.price &gt; 0) {
			player.credits += player.ship.aftWeapon.price / 10;
			stripped.push(player.ship.aftWeapon.name);
			player.ship.aftWeapon = null;
		}
	}
	if (player.credits &lt; 30000) {
		if (player.ship.forwardWeapon &amp;&amp; player.ship.forwardWeapon.price &gt; 0) {
			player.credits += player.ship.forwardWeapon.price / 10;
			stripped.push(player.ship.forwardWeapon.name);
			player.ship.forwardWeapon = null;
		}
	}
	
	
	return([stripped, player.credits - oldBalance]);
}

this._sellShip = function() {
	//no matter in what condition the player ship is, always sell for 50% of mint price
	var refundFactor = 0.5;
	player.credits += player.ship.price * refundFactor;
	player.replaceShip(&quot;adder-player&quot;);
	player.ship.removeEquipment(&quot;EQ_HEAT_SHIELD&quot;);
	player.ship.removeEquipment(&quot;EQ_MISSILE&quot;);
	player.ship.serviceLevel = 75;
}


//clean up mission variables and restore target system
this._cleanUp = function() {
	if (missionVariables.monk_dest_name) {
		player.ship.hudHidden = false;
		delete missionVariables.monk_dest_name;
		delete missionVariables.monk_time;
		delete missionVariables.monk_deadline;
		player.ship.targetSystem = this.$restoreDestination;
	}
}

this.guiScreenWillChange = function(to, from) {
	if (this.$contract &amp;&amp; to === &quot;GUI_SCREEN_MANIFEST&quot;) {
		var secsLeft = this.$contract[&quot;dealine&quot;] - clock.seconds;
		var hoursLeft = Math.floor((secsLeft) / 3600);
		if (hoursLeft &gt; 0) {
			var daysText = &quot; in &quot; + hoursLeft + &quot; hours.&quot;;
		}
		else if (hoursLeft === 0) {
			var daysText = &quot; in less than an hour!&quot;;
		}
		else var daysText = &quot;. Deadline has passed!&quot;;
		mission.setInstructions(&quot;Pay 30 000 credits to the Black Monk Monastery at &quot; + System.infoForSystem(this.$contract[&quot;galaxy&quot;], this.$contract[&quot;system&quot;]).name + daysText);
	}
	else if (!this.$contract) {
		player.ship.hudHidden = false;
		mission.setInstructions(null);
	}
}

this._setOffer = function(action) {
	if (action === &quot;next&quot;) {
		this.$offerPointer++;
		if (this.$offerPointer &gt;= this.$destinations.length) {
			this.$offerPointer = 0;
		}
	}
	else if (action === &quot;prev&quot;) {
		this.$offerPointer--;
		if (this.$offerPointer &lt;= 0) {
			this.$offerPointer = this.$destinations.length - 1;
		}
	}
	var info = system.info.routeToSystem(this.$destinations[this.$offerPointer]);
	var origHours = info.time;
	this.$days = Math.ceil(origHours/24) + Math.ceil(info.route.length / 12);//0.5 hours per system on route rounded up to full days
	missionVariables.monk_dest_name = this.$destinations[this.$offerPointer].name;
	missionVariables.monk_time = this.$days + &quot; days (&quot; + this.$days * 24 + &quot; hours)&quot;;
	missionVariables.monk_deadline = clock.days + this.$days;
}

this.systemWillPopulate = function() {

	if (this.$monkSystemIDs.indexOf(system.ID) !== -1) {
		system.setPopulator(&quot;blackmonk_station&quot;, {
			
			callback: function(pos) {
				var monastery = system.addShips(&quot;blackmonk_monastery&quot;, 1, pos, 0)[0];
				monastery.orientation = [1, 0, 1, 0];
				var minesweepers = system.addShips(&quot;blackmonk_minesweeper&quot;, 10, pos, 15E3);
				for (var i = 0; i &lt; minesweepers.length; i++) {
					//init the alert mechanism of minesweepers.
					minesweepers[i].script.$mother = monastery;
				}
			}.bind(this),
			location: &quot;LANE_WP&quot;,
			locationSeed: 937,
			deterministic: true
		});
	}
	
	//retribution time
	
	//now the player is in trouble. increasing number of gunships are being spawned close to the witchpoint every time the player enters a system.
	if (this.$contract &amp;&amp; this.$contract[&quot;dealine&quot;] - clock.seconds &lt; 0) {
		var count = Math.ceil((clock.seconds -this.$contract[&quot;dealine&quot;]) / 86400);
		if (count &gt; 5) count = 5;
		system.setPopulator(&quot;blackmonk_punishers&quot;, {
			callback: function(pos) {
				system.addGroup(&quot;blackmonk_gunship&quot;, count, pos);
			}.bind(this),
			location: &quot;WITCHPOINT&quot;
		});
	}
	
	//ambiance
	
	//gunships are ridiculously powerful, but very rare. roughly every tenth system has one cruising. running contract doubles the odds to start with and ramps them up close to the deadline.
	if (this.$contract) {
		var div = (Math.ceil(this.$contract[&quot;dealine&quot;] - clock.seconds) / 86400);
		if (div &gt;= 2) {
			var prob = 2 / (Math.ceil(this.$contract[&quot;dealine&quot;] - clock.seconds) / 86400);
			if (prob &lt; 0.2) prob = 0.2;
		}
		else var prob = 1;
	}
	else var prob = 0.1;
	
	if (Math.random() &lt; prob) {
		system.setPopulator(&quot;blackmonk_ambiance_gunship&quot;, {
			callback: function(pos) {
				//half the time, spawn ambiance ships close to the witchpoint and move them a bit closer to the planet. a bit is a 0.75 * scanner range. it&#39;s a bit boring to all the time have them sitting next to the witchpoint. a bit too staged to my liking.
				if (Math.random() &lt; 0.5) {
					var gunship = system.addShips(&quot;blackmonk_gunship&quot;, 1)[0];
					gunship.position = gunship.position.add([0, 0, 19200]);
					var debtor = system.addShips(&quot;trader&quot;, 1, gunship.position)[0];
				}
				else {
					var gunship = system.addShips(&quot;blackmonk_gunship&quot;, 1, pos)[0];
					var debtor = system.addShips(&quot;trader&quot;, 1, gunship.position)[0];
				}
				debtor.$monkDebtor = true;
				debtor.fuel = 0;//no escape
			}.bind(this),
			location: &quot;LANE_WP&quot;
		});
		//this is a long shot, a lonely debtor leisurely cruising the lane. with some seriusly bad load of luck it just might meet a blackmonk gunship.
		system.setPopulator(&quot;blackmonk_ambiance_wandering_debtor&quot;, {
			callback: function(pos) {
				var debtor = system.addShips(&quot;trader&quot;, 1, pos)[0];
				debtor.$monkDebtor = true;
				debtor.fuel = 0;//no escape
			}.bind(this),
			location: &quot;LANE_WP&quot;
		});
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
