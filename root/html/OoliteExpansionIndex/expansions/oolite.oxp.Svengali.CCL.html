<html>
    <head>
        <title>Expansion Cabal Common Library</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Cabal Common Library</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">3 Equipment</a></li>
          <li><a href="#ships">8 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">12 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Collection of snippets and helpers for OXPs.</td>
                    <td>Collection of snippets and helpers for OXPs.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Svengali.CCL</td>
                    <td>oolite.oxp.Svengali.CCL</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Cabal Common Library</td>
                    <td>Cabal Common Library</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Miscellaneous</td>
                    <td>Miscellaneous</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Cmd.Cheyd, PhantorGorth and Svengali</td>
                    <td>Cmd.Cheyd, PhantorGorth and Svengali</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.7.2</td>
                    <td>1.7.2</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Cabal_Common_Library">http://wiki.alioth.net/index.php/Cabal_Common_Library</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/a/ab/CabalLibray-1.7.2.oxz">https://wiki.alioth.net/img_auth.php/a/ab/CabalLibray-1.7.2.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 3</td>
                    <td>CC BY-NC-SA 3</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873407</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Cabal%20Common%20Library'>http://wiki.alioth.net/index.php/Cabal%20Common%20Library</a></p>
        <h3>Cabal_Common_Library1.7_Readme.rtf</h3>
        <pre>{\rtf1\ansi\ansicpg1252\deff0{\fonttbl{\f0\fnil\fcharset0 Helvetica;}{\f1\fswiss\fprq2\fcharset0 Helvetica;}{\f2\fnil\fcharset238 Helvetica;}}
{\colortbl ;\red128\green128\blue128;\red128\green0\blue128;\red0\green0\blue0;}
{\*\generator Msftedit 5.41.15.1515;}\viewkind4\uc1\pard\lang1031\ul\b\f0\fs24 Cabal_Common_Library1.7\ulnone\b0\fs28  \fs24 for Oolite\f1\par
\cf1\f0\fs18 (C) 2010-2013 by Cmd.Cheyd, PhantorGorth and Svengali\par
License: CC-by.\par
January 2013.\par
\cf0\fs20\par
\ul\fs24 OVERVIEW:\ulnone\fs20\par
\fs22 CCL is a collection of useful snippets and helpers.\par
\par
Its main purpose is to simplify some common tasks used by OXPs and also includes a few\par
unique features. It contains functions to check requirements, helper functions for arrays, strings,\par
numbers and vectors, an encrypt/decrypt algorithm, and functions for missionscreen models,\par
an onscreen keyboard, a comms channel, special market deals, a event driven script for music,\par
a system description based script to coordinate OXPs actions, a tool to check the player ship\par
and NPCs and a tool for inflight overlay handling.\par
\par
In other words it offers new possibilities for OXPs.\par
\par
Over time it will grow and include more functions and features. The library does not alter any native\par
JS objects (like Array or String) to avoid clashes and does not clutter the global namespace.\par
\par
Documentation: \cf2 http://wiki.alioth.net/index.php/Category:OXPDoc\par
\par
\cf3\ul INTERNAL_VERSION:\ulnone  15\cf0\par
\fs20\par
\ul\fs24 REQUIREMENTS:\par
\ulnone\fs22 - Oolite v1.77.\fs20\par
\par
\ul\fs24 PROBLEMS:\par
\ulnone\fs22 In case of problems, please report it: \cf2 http://aegidian.org/bb/viewtopic.php?f=4&amp;t=8839.\par
I\cf0 nclude the following infos:\par
- Oolites version (and if trunk or nightly is used the revision number)\par
- OS, Graphics card (and driver version)\par
- Fullscreen/Windowed mode\par
- Shader mode\par
- List of used OXPs (incl. versions)\fs20\par
\cf3\fs24 _________________________________________________________________________\par
\fs20\par
Thanks to:\par
  - \ul The development team\ulnone\par
  Giles Williams (aegidian), Jens Ayton (Ahruman), Nikos Barkas (another_commander), David Taylor (dajt),\par
  Chris Crowther (hikari), James (cmdrjames), Darren Salt (dsalt), Eddy Petri\f2\&#39;baor\f0  (\f2 eddyp\f0 ), \f2 Erich Ritz\f0  (\f2 eritz\f0 ),\par
  \f2 Konstantinos Sykas\f0  (\f2 getafix\f0 ),  K\f2 aks\f0 , \f2 Nic \f0 (\f2 nic_asdf\f0 ), \f2 Michael Werle\f0  (\f2 mwerle\f0 ), \f2 Dave Hughes\f0  (s\f2 elezen\f0 ),\par
  Eric Walch, \f2 Dylan Smith\f0  (\f2 winston\f0 ).\f2\par
\f0\par
Special thanks:\par
  - Michael Werle for his patience and help to get a much better documentation,\par
  - Ahruman (pseudoRand),\par
  - Commander McLane (strDateFromMinutes),\par
  - Eric Walch (mapCoordsDirection),\par
  - Thargoid (strAddAlignedText, strAddEdgeText, strAddIndentedText, strAdd2Columns and strAdd3Columns)\par
  - Terry Yuen (En/Decryption),\par
  - Dr.J R Stockton (rand, randSpan, msbPos, baseChange, strLZ, strLZZ, arrShuffle),\par
  - Nicholas Zakas (Cabal_Common_BinSearch is heavenly based on his ideas),\par
  - Paul Bourke (pointOnLineB).\f2\par
\f0\fs18\par
\fs24 _________________________________________________________________________\par
\fs20\par
- The content of this OXP is licensed under the Creative Commons Attribution 3.0 Unported License.\par
 To view a copy of this license, visit \cf2 http://creativecommons.org/licenses/by/3.0/\cf3  or send a letter to\par
 Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.\par
\par
DISCLAIMER:\par
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY\par
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\par
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT\par
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\par
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT\par
OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)\par
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR\par
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\par
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\par
\par
A SMALL PERCENTAGE OF USERS MAY EXPERIENCE EPILEPTIC SEIZURES WHEN EXPOSED TO\par
CERTAIN LIGHT PATTERNS OR BACKGROUNDS ON A COMPUTER SCREEN OR WHILE USING THIS OXP.\par
CERTAIN CONDITIONS MAY INDUCE PREVIOUSLY UNDETECTED EPILEPTIC SYMPTOMS EVEN IN USERS\par
WHO HAVE NO HISTORY OF PRIOR SEIZURES OR EPILEPSY. IF YOU, OR ANYONE IN YOUR FAMILY,\par
HAVE AN EPILEPTIC CONDITION, CONSULT YOUR PHYSICIAN PRIOR TO USING THIS OXP. IMMEDIATELY\par
DISCONTINUE USE OF THIS OXP AND CONSULT YOUR PHYSICIAN IF YOU EXPERIENCE ANY OF THE\par
FOLLOWING SYMPTOMS WHILE USING THIS OXP: DIZZINESS, ALTERED VISION, EYE OR MUSCLE\par
TWITCHES, LOSS OF AWARENESS, DISORIENTATION, ANY INVOLUNTARY MOVEMENT, OR CONVULSIONS.\par
\fs24 _________________________________________________________________________\par
\fs20\par
\par
\par
\par
}
 </pre>
        <h3>Cabal_Common_Library1.7_Readme.txt</h3>
        <pre>﻿Cabal_Common_Library1.7 for Oolite
(C) 2010-2013 by Cmd.Cheyd, PhantorGorth and Svengali
License: CC-by.
January 2013.

OVERVIEW:
CCL is a collection of useful snippets and helpers.

Its main purpose is to simplify some common tasks used by OXPs and also includes a few
unique features. It contains functions to check requirements, helper functions for arrays, strings,
numbers and vectors, an encrypt/decrypt algorithm, and functions for missionscreen models,
an onscreen keyboard, a comms channel, special market deals, a event driven script for music,
a system description based script to coordinate OXPs actions, a tool to check the player ship
and NPCs and a tool for inflight overlay handling.

In other words it offers new possibilities for OXPs.

Over time it will grow and include more functions and features. The library does not alter any native
JS objects (like Array or String) to avoid clashes and does not clutter the global namespace.

Documentation: http://wiki.alioth.net/index.php/Category:OXPDoc

INTERNAL_VERSION: 15

REQUIREMENTS:
- Oolite v1.77.

PROBLEMS:
In case of problems, please report it: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=8839.
Include the following infos:
- Oolites version (and if trunk or nightly is used the revision number)
- OS, Graphics card (and driver version)
- Fullscreen/Windowed mode
- Shader mode
- List of used OXPs (incl. versions)
_________________________________________________________________________

Thanks to:
  - The development team
  Giles Williams (aegidian), Jens Ayton (Ahruman), Nikos Barkas (another_commander), David Taylor (dajt),
  Chris Crowther (hikari), James (cmdrjames), Darren Salt (dsalt), Eddy Petrişor (eddyp), Erich Ritz (eritz),
  Konstantinos Sykas (getafix),  Kaks, Nic (nic_asdf), Michael Werle (mwerle), Dave Hughes (selezen),
  Eric Walch, Dylan Smith (winston).

Special thanks:
  - Michael Werle for his patience and help to get a much better documentation,
  - Ahruman (pseudoRand),
  - Commander McLane (strDateFromMinutes),
  - Eric Walch (mapCoordsDirection),
  - Thargoid (strAddAlignedText, strAddEdgeText, strAddIndentedText, strAdd2Columns and strAdd3Columns)
  - Terry Yuen (En/Decryption),
  - Dr.J R Stockton (rand, randSpan, msbPos, baseChange, strLZ, strLZZ, arrShuffle),
  - Nicholas Zakas (Cabal_Common_BinSearch is heavenly based on his ideas),
  - Paul Bourke (pointOnLineB).

_________________________________________________________________________

- The content of this OXP is licensed under the Creative Commons Attribution 3.0 Unported License.
 To view a copy of this license, visit http://creativecommons.org/licenses/by/3.0/ or send a letter to
 Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.

DISCLAIMER:
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

A SMALL PERCENTAGE OF USERS MAY EXPERIENCE EPILEPTIC SEIZURES WHEN EXPOSED TO
CERTAIN LIGHT PATTERNS OR BACKGROUNDS ON A COMPUTER SCREEN OR WHILE USING THIS OXP.
CERTAIN CONDITIONS MAY INDUCE PREVIOUSLY UNDETECTED EPILEPTIC SYMPTOMS EVEN IN USERS
WHO HAVE NO HISTORY OF PRIOR SEIZURES OR EPILEPSY. IF YOU, OR ANYONE IN YOUR FAMILY,
HAVE AN EPILEPTIC CONDITION, CONSULT YOUR PHYSICIAN PRIOR TO USING THIS OXP. IMMEDIATELY
DISCONTINUE USE OF THIS OXP AND CONSULT YOUR PHYSICIAN IF YOU EXPERIENCE ANY OF THE
FOLLOWING SYMPTOMS WHILE USING THIS OXP: DIZZINESS, ALTERED VISION, EYE OR MUSCLE
TWITCHES, LOSS OF AWARENESS, DISORIENTATION, ANY INVOLUNTARY MOVEMENT, OR CONVULSIONS.
_________________________________________________________________________




</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_CABAL_COMMON_COMM.html">Secure channels</a></td>
                    <td>no</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_CABAL_COMMON_SPECIALMARKETS.html">Access Special Markets</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_CCL_OXPS_MINE.html">CleanerMine</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_exhaust.html">cabal_common_exhaust</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_key.html">cabal_common_key</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_laser.html">cabal_common_laser</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_modelview.html">cabal_common_modelview</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_oxps_mine.html">CleanerMine</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cabal_common_oxps_minesub.html">CleanerMineSub</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ccl_crateA.html">Cargo container</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ccl_crateB.html">Cargo container</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Briefing.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Briefing&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Helper for Mission - Briefings.&quot;;
this.version = &quot;1.7&quot;;

this.startUp = function()
{
	delete this.startUp;
	this.helper = new this.Cabal_Common_ScreenFCB();
	this.briefingSoundA = new SoundSource();
	this.briefingSoundB = new SoundSource();
}
// Can be called via worldScripts.Cabal_Common_Briefing.startBriefing(obj);
this.startBriefing = function(obj)
{
	if(!player.ship.docked || !obj) return(false);
	if(!obj.capture){
		if(!obj.title) obj.title = &quot;Briefing&quot;;
		if(!obj.background) obj.background = null;
		if(!obj.fadeIn){
			if(!obj.overlay){
				var check = expandMissionText(&#39;BGS-IMAGESWITCH&#39;);
				if(check===&quot;Yes&quot;) obj.overlay = &quot;bgs-i_overlay_none.png&quot;;
				else obj.overlay = null;
			}
		} else obj.overlay = {name:&quot;cabal_common_briefing_blend10.png&quot;,width:1024,height:480};
		if(!obj.music) obj.music = null;
		this.briefing = obj.briefing;
		if(obj.callbackc) this.briefing.cbc = obj.callbackc;
		else obj.callbackc = null;
		mission.runScreen({title:obj.title,model:obj.role,spinModel:false,background:obj.background,overlay:obj.overlay,music:obj.music,choicesKey:obj.callbackc},this.choiceEval);
		if(obj.cornerPos) this.helper.screenCornerPos(obj.cornerPos[0],obj.cornerPos[1],obj.cornerPos[2],obj.cornerPos[3]);
		if(obj.absolutePos) mission.displayModel.position = [obj.absolutePos[0],obj.absolutePos[1],obj.absolutePos[2]];
		if(obj.ori) mission.displayModel.orientation = obj.ori;
		if(obj.getOri) mission.displayModel.orientation = mission.displayModel.scriptInfo[obj.getOri].split(&quot;,&quot;);
		if(obj.getPos) mission.displayModel.position = mission.displayModel.scriptInfo[obj.getPos].split(&quot;,&quot;);
		if(obj.prepareProps){
			var prop;
			for(prop in obj.prepareProps){
				mission.displayModel[prop] = obj.prepareProps[prop];
				if(mission.displayModel.subEntities){
					for(var i=0;i&lt;mission.displayModel.subEntities.length;i++) mission.displayModel.subEntities[i][prop] = obj.prepareProps[prop];
				}
			}
		}
		if(obj.prepareBindings) for(var b=0;b&lt;obj.prepareBindings.length;b++) this.helper.fcbSetBinding(obj.prepareBindings[b][0],obj.prepareBindings[b][1],obj.prepareBindings[b][2],obj.prepareBindings[b][3],obj.prepareBindings[b][4],obj.prepareBindings[b][5],obj.prepareBindings[b][6]);
		if(obj.preparePositions) for(var p=0;p&lt;obj.preparePositions.length;p++) this.helper.rePosition(obj.preparePositions[p][0],obj.preparePositions[p][1],obj.preparePositions[p][2]);
		if(obj.prepareOrientations) for(var o=0;o&lt;obj.prepareOrientations.length;o++) this.helper.reOrient(obj.prepareOrientations[o][0],obj.prepareOrientations[o][1],obj.prepareOrientations[o][2]);
	} else this.helper.fcbRemoveAll();
	if(obj.repRelative){ // relativePosition is meaningless for missionscreens
		var ar = [mission.displayModel],flagM,flag;
		if(mission.displayModel.subEntities &amp;&amp; mission.displayModel.subEntities.length){
			for(var i=0;i&lt;mission.displayModel.subEntities.length;i++) ar.push(mission.displayModel.subEntities[i]);
		}
		for(var s=0;s&lt;ar.length;s++){
			flag = 0;
			flagM = 0;
			var a = ar[s].getShaders();
			var b = Object.keys(a);
			if(!b.length){
				a = ar[s].getMaterials();
				b = Object.keys(a);
				flagM = 1;
			}
			if(b.length){
				if(a[b[0]].hasOwnProperty(&quot;uniforms&quot;)){
					var prop;
					for(prop in a[b[0]].uniforms){
						if(a[b[0]].uniforms[prop]===&quot;relativePosition&quot;){
							a[b[0]].uniforms[prop]=&quot;position&quot;;
							flag = 1;
						}
					}
				}
				if(flag){
					if(flagM) ar[s].setMaterials(a);
					else ar[s].setShaders(a);
				}
			}
		}
	}
	if(obj.fadeIn) this.briefingFadeIn = obj.fadeIn;
	else this.briefingFadeIn = null;
	if(obj.screenHUD){
		player.ship.hud = obj.screenHUD;
		player.ship.hudHidden = false;
	}
	this.briefingCounter = 0;
	this.briefingIndex = 0;
	this.briefing = obj.briefing;
	if(obj.callback &amp;&amp; obj.callbackf){
		this.briefing.cb = obj.callback;
		this.briefing.cbf = obj.callbackf;
	}
	if(obj.delta) this.helper.ccl_defaultDelta = obj.delta;
	else this.helper.ccl_defaultDelta = 0.015;
	if(!this.briefingTimer) this.briefingTimer = new Timer(this,this.doBriefingTimer,0,0.25);
	else this.briefingTimer.start();
	return(true);
}
this.cleanUp = function()
{
	if(this.briefingTimer){
		this.briefingTimer.stop();
		delete this.briefingTimer;
	}
}
this.choiceEval = function(choice){worldScripts.Cabal_Common_Briefing.delayChoice(choice); return;}
this.delayChoice = function(choice)
{
	this.cleanUp();
	this.helper.fcbRemoveAll();
	if(this.briefing.cb &amp;&amp; this.briefing.cbf) worldScripts[this.briefing.cb][this.briefing.cbf](choice);
	if(this.briefingSoundA.isPlaying) this.briefingSoundA.stop();
	if(this.briefingSoundB.isPlaying) this.briefingSoundB.stop();
	this.helper.ccl_defaultDelta = 0.015;
	delete this.briefing;
	player.ship.hud = null;
	return;
}
this.doBriefingTimer = function()
{
	if(!this.briefing.length || !mission.displayModel || !mission.displayModel.isValid || this.briefingIndex&gt;=this.briefing.length){
		this.cleanUp();
		this.helper.fcbRemoveAll();
		return;
	}
	if(this.soundStopper &amp;&amp; this.briefingCounter &gt;= this.soundStopper[0]){
		if(this.soundStopper[1]) if(this.briefingSoundB.isPlaying) this.briefingSoundB.stop();
		else if(this.briefingSoundA.isPlaying) this.briefingSoundA.stop();
		delete this.soundStopper;
	}
	var current = this.briefing[this.briefingIndex];
	if(this.briefingCounter &gt;= current[0]){
		// Action commands
		switch(current[1]){
			case &quot;bgzoom&quot;:
				this.helper.fcbZoomBackground(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
			case &quot;bind&quot;:
				this.helper.fcbSetBinding(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
			case &quot;check&quot;:
				this.helper.fcbCheckAll();
				break;
			case &quot;clean&quot;:
				this.helper.fcbRemoveAll();
				break;
			case &quot;continue&quot;:
				var checked=false;
				if(this.briefing.cb){
					if(worldScripts[this.briefing.cb][current[2][0]]){
						checked = worldScripts[this.briefing.cb][current[2][0]](current[2][1]);
						if(typeof(checked)===&#39;number&#39;){ // Goto
							this.helper.fcbRemoveAll();
							this.briefingCounter = checked-1;
							this.briefingIndex = checked-1;
						}
					}
				}
				if(!checked &amp;&amp; typeof(checked)!==&#39;number&#39;){
					this.cleanUp();
					this.helper.fcbRemoveAll();
					if(this.briefingSoundA.isPlaying &amp;&amp; (this.briefingSoundA.repeatCount&gt;1 || this.briefingSoundA.loop)) this.briefingSoundA.stop()
					if(this.briefingSoundB.isPlaying &amp;&amp; (this.briefingSoundB.repeatCount&gt;1 || this.briefingSoundB.loop)) this.briefingSoundB.stop()
				}
				break;
			case &quot;face&quot;:
				this.helper.fcbFace(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7]);
				break;
			case &quot;flightTo&quot;:
				this.helper.fcbFlightTo(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7]);
				break;
			case &quot;revolution&quot;:
				this.helper.fcbKIRevolution(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4]);
				break;
			case &quot;kill&quot;:
				this.cleanUp();
				this.helper.fcbRemoveAll();
				if(this.briefingSoundA.isPlaying) this.briefingSoundA.stop();
				if(this.briefingSoundB.isPlaying) this.briefingSoundB.stop();
				if(this.briefing.cb &amp;&amp; this.briefing.cbf) worldScripts[this.briefing.cb][this.briefing.cbf](current[2]);
				break;
			case &quot;shadeprop&quot;:
				this.helper.reShaderProps(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4]);
				break;
			case &quot;mes&quot;:
				mission.addMessageText(current[2]);
				break;
			case &quot;mSpeed&quot;:
				this.helper.fcbModelSpeed(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
			case &quot;mVelo&quot;:
				this.helper.fcbModelVelo(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7],current[2][8]);
				break;
			case &quot;mVeloTo&quot;:
				this.helper.fcbModelVeloTo(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7],current[2][8],current[2][9],current[2][10]);
				break;
			case &quot;prop&quot;:
				this.helper.fcbSetProp(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
			case &quot;reback&quot;:
				this.helper.reBackground(current[2][0]);
				break;
			case &quot;reover&quot;:
				this.helper.reOverlay(current[2][0]);
				break;
			case &quot;reori&quot;:
				this.helper.reOrient(current[2][0],current[2][1],current[2][2]);
				break;
			case &quot;repos&quot;:
				this.helper.rePosition(current[2][0],current[2][1],current[2][2]);
				break;
			case &quot;retex&quot;:
				this.helper.reTexture(current[2][0],current[2][1],current[2][2],current[2][3]);
				break;
			case &quot;rot&quot;:
				this.helper.fcbRotation(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7],current[2][8]);
				break;
			case &quot;stopSound&quot;:
				if(this.briefingSoundA.isPlaying) this.briefingSoundA.stop();
				if(this.briefingSoundB.isPlaying) this.briefingSoundB.stop();
				break;
			case &quot;stopVelo&quot;:
				this.helper.stopVelo(current[2][0],current[2][1]);
				break;
			case &quot;turn&quot;:
				this.helper.fcbFlight(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
			case &quot;walk&quot;:
				this.helper.fcbWalk(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6],current[2][7]);
				break;
			case &quot;zoom&quot;:
				this.helper.fcbZoom(current[2][0],current[2][1],current[2][2],current[2][3],current[2][4],current[2][5],current[2][6]);
				break;
		}
		if(current[3]) mission.addMessageText(current[3]);
		if(current[4]){
			if(!this.briefingSoundA.isPlaying){
				this.briefingSoundA.sound = current[4];
				if(current[5]) this.briefingSoundA.repeatCount = current[5];
				else this.briefingSoundA.repeatCount = 0;
				this.briefingSoundA.play();
				if(current[6]){
					if(!current[7]) this.briefingSoundB.stop();
					else this.soundStopper = [current[6],0]
				}
			} else {
				this.briefingSoundB.sound = current[4];
				if(current[5]) this.briefingSoundB.repeatCount = current[5];
				else this.briefingSoundB.repeatCount = 0;
				this.briefingSoundB.play();
				if(current[6]){
					if(!current[7]) this.briefingSoundA.stop();
					else this.soundStopper = [current[6],1]
				}
			}
		}
		this.briefingIndex++;
	}
	if(this.briefingCounter&lt;11 &amp;&amp; this.briefingFadeIn){
		var ind = 10-this.briefingCounter;
		var ovn = &quot;cabal_common_briefing_blend&quot;+ind+&quot;.png&quot;;
		setScreenOverlay({name:ovn,width:1024,height:480});
	}
	this.briefingCounter++;
	return;
}
this.shipWillLaunchFromStation = function()
{
	this.cleanUp();
	if(this.helper.ccl_briefing_fcbs.length) this.helper.fcbRemoveAll();
	if(this.briefingSoundA.isPlaying) this.briefingSoundA.stop();
	if(this.briefingSoundB.isPlaying) this.briefingSoundB.stop();
	delete this.briefing;
}
// API
this.Cabal_Common_ScreenFCB = function(){}
Cabal_Common_ScreenFCB.prototype = {
	constructor: Cabal_Common_ScreenFCB,
	internalVersion: 15,
	ccl_briefing_fcb: 0,
	ccl_briefing_fcbs: [],
	ccl_briefing_bg: 1,
	ccl_defaultDelta: 0.015,
	/* Face target.
		ent			Entity. To be reoriented. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		tar			Entity. Target entity. If -1 player.ship is used.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for rotation start.
		dampb		Number. Linear dampening duration for rotation end.
		away		Number. Multiplier to head away from target. -1...1. */
	fcbFace: function(ent,sub,last,tar,basez,dampa,dampb,away){
		var ccl_sum = 0,ccl_ent = ent,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_tar = tar,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb,ccl_away = away;
		if(!ent){
			if(ccl_sub===-1) ccl_ent = mission.displayModel;
			else ccl_ent = mission.displayModel.subEntities[ccl_sub];
			if(tar===-1) ccl_tar = player.ship;
			else ccl_tar = mission.displayModel.subEntities[tar];
		} else {
			if(tar===-1) ccl_tar = player.ship;
		}
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_tar || !ccl_ent.isValid || !ccl_tar.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1;
			if(ccl_basez) bz = 1-1/Math.sqrt(Math.max(Math.abs(ccl_ent.position.z),0.001));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			var targetVector = ccl_tar.heading.subtract(ccl_ent.position).direction();
			var angle = (ccl_ent.heading.angleTo(targetVector)*bz*da*db/ccl_last/8)*ccl_away*f;
			var cross = ccl_ent.heading.cross(targetVector).direction();
			ccl_ent.orientation = ccl_ent.orientation.rotate(cross,-angle);
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Flight.
		ent			Entity. To be reoriented and/or accelerated. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		rU			Number. Rotate vectorUp by rU (radians).
		rR			Number. Rotate vectorRight by rR /radians).
		rF			Number. Rotate vectorForward by rF (radians).
		velo		Number. Multiply vectorForward and set velocity. If -1 no velocity set. */
	fcbFlight: function(ent,sub,last,rU,rR,rF,velo){
		var ccl_sum = 0,ccl_ent = ent,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_rU = rU,ccl_rR = rR,ccl_rF = rF,ccl_velo = velo;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			if(ccl_sub&gt;-1){
				if(ccl_rU) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotate(ccl_ent.subEntities[ccl_sub].vectorUp,ccl_rU*f);
				if(ccl_rR) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotate(ccl_ent.subEntities[ccl_sub].vectorRight,ccl_rR*f);
				if(ccl_rF) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotate(ccl_ent.subEntities[ccl_sub].vectorForward,ccl_rF*f);
				if(ccl_velo!==-1) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorForward.multiply(ccl_velo*f);
			} else {
				if(ccl_rU) ccl_ent.orientation = ccl_ent.orientation.rotate(ccl_ent.vectorUp,ccl_rU*f);
				if(ccl_rR) ccl_ent.orientation = ccl_ent.orientation.rotate(ccl_ent.vectorRight,ccl_rR*f);
				if(ccl_rF) ccl_ent.orientation = ccl_ent.orientation.rotate(ccl_ent.vectorForward,ccl_rF*f);
				if(ccl_velo!==-1) ccl_ent.velocity = ccl_ent.vectorForward.multiply(ccl_velo*f);
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* FlightTo.
		ent			mission.displayModel.subentity. To be reoriented and/or accelerated.
		tar			mission.displayModel.subentity. Target.position
		last		Number. Duration for fcb.
		dampa		Number. Linear dampening duration for rotation start.
		dampb		Number. Linear dampening duration for rotation end.
		mul			Number. Multiplier for rotation.
		velo		Number. Multiply vectorForward and set velocity.
		offset		Vector/Array. Offset position for target. */
	fcbFlightTo: function(ent,tar,last,dampa,dampb,mul,velo,offset){
		var ccl_sum = 0,ccl_ent = mission.displayModel.subEntities[ent],ccl_tar = mission.displayModel.subEntities[tar],ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_dampa = dampa,ccl_dampb = dampb,ccl_mul = mul,ccl_velo = velo,ccl_offset = new Vector3D(offset);
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_tar || !ccl_ent.isValid || !ccl_tar.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var da = 1,db = 1;
			if(ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			var targetVector = ccl_tar.position.add(ccl_offset).subtract(ccl_ent.position).direction();
			var angle = (ccl_ent.heading.angleTo(targetVector)*da*db/ccl_mul)*f;
			var cross = ccl_ent.heading.cross(targetVector).direction();
			ccl_ent.orientation = ccl_ent.orientation.rotate(cross,-angle);
			if(ccl_velo!==-1){
				var s = ccl_tar.position.add(ccl_offset).distanceTo(ccl_ent.position);
				if(s&lt;ccl_ent.collisionRadius){ccl_sum=9999999; return;}
				var c = ccl_tar.collisionRadius*2;
				var m = 1;
				if(s&lt;c) m = 1/Math.sqrt(c/s);
				ccl_ent.velocity = ccl_ent.vectorForward.multiply(ccl_velo*m*f);
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Forward KI for revolution joints
		start		Number. Subentity #
		end			Number. Subentity #
		last		Number. Duration for fcb.
		joints		Array. Vectors for connection points
		angles		Array. Max angle (dot product) before reorientation starts
	*/
	fcbKIRevolution: function(start,end,last,joints,angles){
		var ccl_sum=0,ccl_substart=start+1,ccl_subend=end+1,ccl_last=last,ccl_delta=this.ccl_defaultDelta,ccl_joints=joints,ccl_angles=angles;
		var ccl_ent = mission.displayModel,ccl_stepBack = [];
		for(var o=0;o&lt;ccl_subend-ccl_substart;o++) ccl_stepBack.push(0);
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var vtr;
			for(var i=ccl_substart;i&lt;ccl_subend;i++){
				var offset = new Vector3D(ccl_joints[i-1]),n0 = ccl_ent.subEntities[i-1],n1=ccl_ent.subEntities[i];
				var vt0 = n0.vectorForward,vt1=n1.vectorForward;
				var dt = vt0.dot(vt1);
				if(dt&lt;ccl_angles[i-1] || ccl_stepBack[i]){
					var vt = n0.position.subtract(n1.position).direction();
					var angle = vt1.angleTo(vt)*0.01*f;
					var cross = vt1.cross(vt).direction();
					n1.orientation = n1.orientation.rotate(cross,angle);
					ccl_stepBack[i] = 1;
				}
				if(dt&gt;0.999) ccl_stepBack[i] = 0;
				vtr = offset.rotateBy(n0.orientation);
				n1.position = vtr.add(n0.position);
				if(n0.velocity.magnitude()) n1.velocity=n0.velocity;
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Pseudospeed.
		ent			Entity. To be accelerated. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		velo		Number. Multiply vectorForward and set velocity.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for velo start.
		dampb		Number. Linear dampening duration for velo end. */
	fcbModelSpeed: function(ent,sub,last,velo,basez,dampa,dampb){
		var ccl_sum = 0,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_ent = ent,ccl_velo = velo,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1;
			if(ccl_basez) bz = Math.sqrt(Math.abs(ccl_ent.position.z));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_sub&gt;-1) ccl_ent.subEntities[sub].velocity = ccl_ent.vectorForward.multiply((ccl_velo*bz*da*db)*f);
			else ccl_ent.velocity = ccl_ent.vectorForward.multiply((ccl_velo*bz*da*db)*f);
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Velocities.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		mU			Number. Multiplier vectorUp.
		mR			Number. Multiplier vectorRight.
		mF			Number. Multiplier vectorForward.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbModelVelo: function(ent,sub,last,mU,mR,mF,basez,dampa,dampb){
		var ccl_sum = 0,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_mU = mU,ccl_mR = mR,ccl_mF = mF,ccl_ent = ent,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1;
			if(ccl_basez) bz = Math.sqrt(Math.abs(ccl_ent.position.z));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_sub&gt;-1){
				if(ccl_mU) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorUp.multiply((ccl_mU*bz*da*db)*f);
				if(ccl_mR) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorRight.multiply((ccl_mR*bz*da*db)*f);
				if(ccl_mF) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorForward.multiply((ccl_mF*bz*da*db)*f);
			} else {
				if(ccl_mU) ccl_ent.velocity = ccl_ent.vectorUp.multiply((ccl_mU*bz*da*db)*f);
				if(ccl_mR) ccl_ent.velocity = ccl_ent.vectorRight.multiply((ccl_mR*bz*da*db)*f);
				if(ccl_mF) ccl_ent.velocity = ccl_ent.vectorForward.multiply((ccl_mF*bz*da*db)*f);
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Velocities.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		mU			Number. Multiplier vectorUp.
		mR			Number. Multiplier vectorRight.
		mF			Number. Multiplier vectorForward.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end.
		tar			SubEntity.
		offset		Vector/Array. Offset for target position. */
	fcbModelVeloTo: function(ent,sub,last,mU,mR,mF,basez,dampa,dampb,tar,offset){
		var ccl_sum = 0,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_mU = mU,ccl_mR = mR,ccl_mF = mF,ccl_ent = ent,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb,ccl_tar = mission.displayModel.subEntities[tar],ccl_offset=offset;
		if(!ent) ccl_ent = mission.displayModel;
		else ccl_ent = mission.displayModel.subEntity[ent];
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1;
			if(ccl_basez) bz = Math.sqrt(Math.abs(ccl_ent.position.z));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_sub&gt;-1){
				if(ccl_mU) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorUp.multiply((ccl_mU*bz*da*db)*f);
				if(ccl_mR) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorRight.multiply((ccl_mR*bz*da*db)*f);
				if(ccl_mF) ccl_ent.subEntities[ccl_sub].velocity = ccl_ent.subEntities[ccl_sub].vectorForward.multiply((ccl_mF*bz*da*db)*f);
			} else {
				if(ccl_mU) ccl_ent.velocity = ccl_ent.vectorUp.multiply((ccl_mU*bz*da*db)*f);
				if(ccl_mR) ccl_ent.velocity = ccl_ent.vectorRight.multiply((ccl_mR*bz*da*db)*f);
				if(ccl_mF) ccl_ent.velocity = ccl_ent.vectorForward.multiply((ccl_mF*bz*da*db)*f);
			}
			var s = ccl_tar.position.add(ccl_offset).distanceTo(ccl_ent.subEntities[ccl_sub].position);
			if(s&lt;ccl_ent.subEntities[ccl_sub].collisionRadius*2){ccl_sum=9999999;}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Rotation.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		rX			Number. Radians X.
		rY			Number. Radians Y.
		rZ			Number. Radians Z.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbRotation: function(ent,sub,last,rX,rY,rZ,basez,dampa,dampb){
		var ccl_sum = 0,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_rX = rX,ccl_rY = rY,ccl_rZ = rZ,ccl_ent = ent,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1;
			if(ccl_basez) bz = Math.sqrt(Math.abs(ccl_ent.position.z));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_sub&gt;-1){
				if(ccl_rX) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotateX((ccl_rX*bz*da*db)*f);
				if(ccl_rY) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotateY((ccl_rY*bz*da*db)*f);
				if(ccl_rZ) ccl_ent.subEntities[ccl_sub].orientation = ccl_ent.subEntities[ccl_sub].orientation.rotateZ((ccl_rZ*bz*da*db)*f);
			} else {
				if(ccl_rX) ccl_ent.orientation = ccl_ent.orientation.rotateX((ccl_rX*bz*da*db)*f);
				if(ccl_rY) ccl_ent.orientation = ccl_ent.orientation.rotateY((ccl_rY*bz*da*db)*f);
				if(ccl_rZ) ccl_ent.orientation = ccl_ent.orientation.rotateZ((ccl_rZ*bz*da*db)*f);
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Preserve orientation/position.
		ent			Entity. To be reoriented. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		tar			Entity. Target subEntity.
		dist		Boolean. Keep its distance.
		inheritFE	Boolean. Bind fuel and energy too.
		swap		Boolean. Flip orientation. */
	fcbSetBinding: function(ent,sub,last,tar,dist,inheritFE,swap){
		var ccl_sum = 0,ccl_ent = ent,ccl_sub = sub,ccl_last = last,ccl_tar = tar,ccl_dist = new Vector3D(),ccl_inherit = inheritFE,ccl_swap = swap;
		if(ccl_sub===-1) ccl_ent = mission.displayModel;
		else ccl_ent = mission.displayModel.subEntities[ccl_sub];
		if(tar===-1) ccl_tar = mission.displayModel;
		else ccl_tar = mission.displayModel.subEntities[tar];
		if(swap) ccl_swap = ccl_ent.orientation;
		if(dist) ccl_dist = ccl_tar.position.subtract(ccl_ent.position);
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_tar || !ccl_ent.isValid || !ccl_tar.isValid) return;
			ccl_sum += delta;
			if(ccl_sum&gt;=ccl_last) return;
			var p = ccl_tar.position;
			var o = ccl_tar.orientation;
			if(ccl_dist) p = p.subtract(ccl_dist.rotateBy(o));
			if(ccl_swap) o = o.rotate(ccl_tar.vectorUp,-Math.PI);
			ccl_ent.orientation = o;
			ccl_ent.position = p;
			if(ccl_inherit){
				ccl_ent.energy = ccl_tar.energy;
				ccl_ent.fuel = ccl_tar.fuel;
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Set Property
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		prop		String. Property name.
		value		Value for the property. If last specified current value added last times.
		last		Number. Duration for fcb.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbSetProp: function(ent,sub,prop,value,last,dampa,dampb){
		var ccl_ent = ent;
		if(!ent) ccl_ent = mission.displayModel;
		if(!last){
			if(sub&gt;-1) ccl_ent.subEntities[sub][prop] = value;
			else ccl_ent[prop] = value;
		} else {
			var ccl_sum = 0,ccl_sub = sub,ccl_last = last,ccl_prop = prop,ccl_value = value,ccl_dampa = dampa,ccl_dampb = dampb,ccl_delta=this.ccl_defaultDelta;
			this.ccl_briefing_fcb = addFrameCallback(function(delta){
				if(!delta || !ccl_ent || !ccl_ent.isValid) return;
				var f=1-(ccl_delta-delta);
				ccl_sum += (delta*f);
				if(ccl_sum&gt;=ccl_last) return;
				var da = 1,db = 1;
				if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
				if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
				if(ccl_sub&gt;-1) ccl_ent.subEntities[ccl_sub][ccl_prop] += ccl_value;
				else ccl_ent[ccl_prop] += ccl_value*f;
				return;
			});
			this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
			return;
		}
		return;
	},
	/* Walk.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		steps		Number. Divider for duration.
		movez		Number.
		friction	Number. Modifier for Y movement
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbWalk: function(ent,sub,last,steps,movez,friction,dampa,dampb){
		var ccl_sum = 0,ccl_ent = ent,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_dampa = dampa,ccl_dampb = dampb,ccl_fac = last/steps,ccl_movez = movez,ccl_friction = friction;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var friction = 0,da = 1,db = 1,mf = 1;
			if(ccl_friction){
				friction = Math.cos(ccl_last*ccl_fac*ccl_sum*ccl_friction);
				var abs = Math.abs(friction);
				abs = abs/((1/0.9-2)*(1-abs)+1); // Bias
				friction *= abs*0.065;
			}
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			mf = 1+(da*db);
			if(ccl_sub&gt;-1) ccl_ent.subEntities[ccl_sub].position = ccl_ent.subEntities[ccl_sub].position.subtract([0,friction,ccl_movez*mf*f]);
			else ccl_ent.position = ccl_ent.position.subtract([0,friction,ccl_movez*mf*f]);
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Zoom.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		last		Number. Duration for fcb.
		amz			Number. Multiplier for Z.
		basez		Boolean. If true Z position will be taken into account.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbZoom: function(ent,sub,last,amz,basez,dampa,dampb){
		var ccl_sum = 0,ccl_ent = ent,ccl_sub = sub,ccl_last = last,ccl_delta=this.ccl_defaultDelta,ccl_amz = amz,ccl_basez = basez,ccl_dampa = dampa,ccl_dampb = dampb;
		if(!ent) ccl_ent = mission.displayModel;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_ent || !ccl_ent.isValid) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var bz = 1,da = 1,db = 1,mf = 1;
			if(ccl_basez) bz = 1-1/Math.sqrt(Math.max(Math.abs(ccl_ent.position.z),0.001));
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_amz&gt;1) mf = 1+(da*db*bz*(ccl_amz%1));
			else mf = 1-(f*da*db*bz*(1%ccl_amz));
			if(ccl_sub&gt;-1){
				var pos = ccl_ent.subEntities[ccl_sub].position.multiply(mf);
				ccl_ent.subEntities[ccl_sub].position = pos;
			} else {
				var pos = ccl_ent.position.multiply(mf);
				ccl_ent.position = pos;
			}
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Zoom background.
		bg			String. Filename with extension
		last		Number. Duration for fcb.
		w			Number. Dimension width.
		h			Number. Dimension height.
		factor		Number. Multiplier Z.
		dampa		Number. Linear dampening duration for start.
		dampb		Number. Linear dampening duration for end. */
	fcbZoomBackground: function(bg,last,w,h,factor,dampa,dampb){
		var ccl_bgf = this.ccl_briefing_bg;
		var ccl_sum = 0,ccl_bg = bg,ccl_delta=this.ccl_defaultDelta,ccl_w = w*ccl_bgf,ccl_h = h*ccl_bgf,ccl_last = last,ccl_factor = factor,ccl_dampa = dampa,ccl_dampb = dampb;
		this.ccl_briefing_bg *= factor;
		this.ccl_briefing_fcb = addFrameCallback(function(delta){
			if(!delta || !ccl_bg) return;
			var f=1-(ccl_delta-delta);
			ccl_sum += (delta*f);
			if(ccl_sum&gt;=ccl_last) return;
			var da = 1,db = 1,mf = 1;
			if(ccl_dampa &amp;&amp; ccl_sum&lt;ccl_dampa) da = 1-((ccl_dampa-ccl_sum)/ccl_dampa);
			if(ccl_dampb &amp;&amp; ccl_sum&gt;ccl_last-ccl_dampb) db = (ccl_last-ccl_sum)/ccl_dampb;
			if(ccl_factor&gt;1) mf = 1+(da*db*(ccl_factor%1));
			else mf = 1-(f*da*db*(1%ccl_factor));
			setScreenBackground({name:bg,width:ccl_w*mf,height:ccl_h*mf});
			return;
		});
		this.ccl_briefing_fcbs.push(this.ccl_briefing_fcb);
		return;
	},
	/* Check fcbs and log them. */
	fcbCheckAll: function(){
		if(!this.ccl_briefing_fcbs.length) return(false);
		for(var i=0;i&lt;this.ccl_briefing_fcbs.length;i++){
			if(isValidFrameCallback(this.ccl_briefing_fcbs[i])) log(&quot;fcbCheck&quot;,&quot;valid i:&quot;+i+&quot; fcb:&quot;+this.ccl_briefing_fcbs[i]+&quot; typeof:&quot;+typeof(this.ccl_briefing_fcbs[i]));
			else log(&quot;fcbCheck&quot;,&quot;invalid i:&quot;+i);
		}
		return(true);
	},
	/* Clean fcbs. */
	fcbRemoveAll: function(){
		if(!this.ccl_briefing_fcbs.length) return(false);
		for(var i=0;i&lt;this.ccl_briefing_fcbs.length;i++){
			if(isValidFrameCallback(this.ccl_briefing_fcbs[i])) removeFrameCallback(this.ccl_briefing_fcbs[i]);
		}
		this.ccl_briefing_fcb = 0;
		this.ccl_briefing_fcbs = [];
		this.ccl_briefing_bg = 1;
		return(true);
	},
	/* Stop velocity.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub]. */
	stopVelo: function(ent,sub){
		var ccl_ent = ent;
		if(!ent) ccl_ent = mission.displayModel;
		if(sub&gt;-1) ccl_ent.subEntities[sub].velocity = [0,0,0];
		else ccl_ent.velocity = [0,0,0];
		return;
	},
	/* Set background image.
		png			Filename. */
	reBackground: function(png){
		setScreenBackground(png);
		return;
	},
	/* Set overlay image.
		png			Filename. */
	reOverlay: function(png){
		setScreenOverlay(png);
		return;
	},
	/* Set position.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		pos			Vector. */
	rePosition: function(ent,sub,pos){
		var ccl_ent = ent;
		if(!ent) ccl_ent = mission.displayModel;
		if(sub&gt;-1) ccl_ent.subEntities[sub].position = pos;
		else ccl_ent.position = pos;
		return;
	},
	/* Set orientation.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		ori			Quaternion. */
	reOrient: function(ent,sub,ori){
		var ccl_ent = ent;
		if(!ent) ccl_ent = mission.displayModel;
		if(sub&gt;-1) ccl_ent.subEntities[sub].orientation = ori;
		else ccl_ent.orientation = ori;
		return;
	},
	/* Set materials and/or shaders.
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		mat			materials object.
		sha			shader object. */
	reTexture: function(ent,sub,mat,sha){
		var ccl_ent = ent;
		if(!ent) ccl_ent = mission.displayModel;
		if(sub&gt;-1) ccl_ent.subEntities[sub].setMaterials(mat,sha);
		else ccl_ent.setMaterials(mat,sha);
		return;
	},
	/* Set Shader properties
		ent			Entity. If not specified mission.displayModel.
		sub			SubEntity. If -1 main entity is used, otherwise ent.subEntities[sub].
		tex			Array. Textures.
		uni			Array. Property names.
		values		Array. Values for the property. */
	reShaderProps: function(ent,sub,tex,uni,values){
		var ccl_ent = ent,a,b,flagM;
		if(!ent) ccl_ent = mission.displayModel;
		if(sub&gt;-1) a = ccl_ent.subEntities[sub].getShaders();
		else a = ccl_ent.getShaders();
		b = Object.keys(a);
		if(!b.length){
			if(sub&gt;-1) a = ccl_ent.subEntities[sub].getMaterials();
			else a = ccl_ent.getMaterials();
			flagM = 1;
			b = Object.keys(a);
		}
		if(!b.length) return;
		if(tex.length) for(var i=0;i&lt;tex.length;i++) a[b[0]].textures=tex;
		if(uni.length) for(var i=0;i&lt;uni.length;i++) a[b[0]].uniforms[uni[i]].value=values[i];
		if(flagM){
			if(sub&gt;-1) ccl_ent.subEntities[sub].setMaterials(a);
			else ccl_ent.setMaterials(a);
		} else {
			if(sub&gt;-1) ccl_ent.subEntities[sub].setShaders(a);
			else ccl_ent.setShaders(a);
		}
		return;
	},
	/* Missionscreen model corner positioning
		level		Number. Works best with values between 0 and 0.35.
		signx		Number. Used as sign mantissa (-1...1) for X axis.
		signy		Number. Used as sign mantissa (-1...1) for Y axis.
		further		Number. Multiplier for Z axis. Defaults to 1.3. */
	screenCornerPos: function(level,signx,signy,further){
		var pos = mission.displayModel.position,w = 1024/oolite.gameSettings.gameWindow.width,h = 768/oolite.gameSettings.gameWindow.height;
		pos.x = level*pos.z*signx;
		pos.y = level*pos.z*0.75*signy;
		if(further) pos.z *= further;
		else pos.z *= 1.3;
		var wh = w/h;
		pos = pos.add([w*wh-1,h*wh-1,0]);
		mission.displayModel.position=pos;
		return;
	}
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Comms.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Comms&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Secure comms channels - controlling script.&quot;;
this.version = &quot;1.7.2&quot;;

this.startUp = function()
{
    delete this.startUp;
    this.helper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
    this.commChannels = [{display:&quot;Discard&quot;},{display:&quot;Open channel&quot;}];
    this.commChannelChanged = true;
    this.patchedIDs = [];
};
/* function: addToComm()
Parameters:
display - String. Used for onscreen display.
who - Entity/String. The entity or worldScript.
ent - Boolean. Must be true for entities, blank for worldScripts.
pID - Number/String. Must be entityPersonality for entities and this.name for worldScripts.
callback - String. The function that handles the actions.
noDist - Boolean. Optional. If true keep entity entry if out of scanner range.
react - Array. Holds the names of the actions.
*/
this.addToComm = function(obj)
{
    if(obj){
        if(!obj.who || !obj.display || !obj.callback || !obj.react || !obj.hasOwnProperty(&quot;pID&quot;)){
            log(this.name,this.name+&quot; **ERROR: Script has passed invalid settings!&quot;);
            var prop;
            for(prop in obj){log(this.name,&quot;Settings: &quot;+prop+&quot; : &quot;+obj[prop]);}
            return(false);
        }
        this.commChannels.push(obj);
        if(obj.pID) this.patchedIDs.push(obj.pID);
        this.commChannelChanged = true;
        this.checkEQ(&#39;EQ_CABAL_COMMON_COMM&#39;);
        return(true);
    }
    return(false);
};
this.commsMessageReceived = function(message,sender)
{
    if(sender &amp;&amp; sender.scriptInfo &amp;&amp; sender.scriptInfo.ccl_secureChannel){
        if(this.patchedIDs.indexOf(sender.entityPersonality)===-1){
            var channel = sender.scriptInfo.ccl_secureChannel;
            if(sender.script[channel]) this.checkEQ(&#39;EQ_CABAL_COMMON_COMM&#39;);
        }
    }
};
/* function: removeFromComm()
Removes object from the list.

&gt; worldScripts.Cabal_Common_Comms.removeFromComm(this.myComm);
*/
this.removeFromComm = function(obj)
{
    if(obj){
        this.patchedIDs = this.helper.arrRemoveByValue(this.patchedIDs,obj.pID);
        this.commChannels = this.helper.arrRemoveByValue(this.commChannels,obj);
        this.commChannelChanged = true;
        return(true);
    }
    return(false);
};
/* function: changeChoicesComm()
Changes the stored actions for a specific entry.
*/
this.changeChoicesComm = function(pID,newSet)
{
    if(this.patchedIDs.indexOf(pID)===-1) return(false);
    var l = this.commChannels.length;
    if(l&gt;2){
        while(l--){
            if(this.commChannels[l].pID===pID){
                this.commChannels[l].react=newSet;
                this.commChannelChanged = true;
                this.checkEQ(&#39;EQ_CABAL_COMMON_COMM&#39;);
                return(true);
            }
        }
    }
    return(false);
};
this.shipWillEnterWitchspace = function()
{
    this.cleanTimer(); // Avoid eating time
    this.commChannels = [{display:&quot;Discard&quot;},{display:&quot;Open channel&quot;}];
    this.commChannelChanged = false;
    if(player.ship.equipmentStatus(&#39;EQ_CABAL_COMMON_COMM&#39;)!==&#39;EQUIPMENT_UNAVAILABLE&#39;) player.ship.removeEquipment(&#39;EQ_CABAL_COMMON_COMM&#39;);
};
this.doCleanUpTimer = function()
{
    if(!player.ship.isValid) return;
    var l = this.commChannels.length;
    if(l&gt;2){
        while(l--){
            if(this.commChannels[l].noDist) continue;
            if(this.commChannels[l].ent){
                if(this.commChannels[l].who.isValid &amp;&amp; this.commChannels[l].who.position.distanceTo(player.ship.position)&lt;25600) continue;
                else {
                    if(this.commChannels[l].pID) this.patchedIDs = this.helper.arrRemoveByValue(this.patchedIDs,this.commChannels[l].pID);
                    this.commChannels = this.helper.arrRemoveByValue(this.commChannels,this.commChannels[l]);
                    this.commChannelChanged = true;
                    break; // Avoid eating time
                }
            } else if(this.commChannels[l].eID){
                if(this.commChannels[l].eID.isValid &amp;&amp; this.commChannels[l].eID.position.distanceTo(player.ship.position)&lt;25600) continue;
                else {
                    if(this.commChannels[l].pID) this.patchedIDs = this.helper.arrRemoveByValue(this.patchedIDs,this.commChannels[l].pID);
                    this.commChannels = this.helper.arrRemoveByValue(this.commChannels,this.commChannels[l]);
                    this.commChannelChanged = true;
                    break; // Avoid eating time
                }
            }
        }
    } else this.cleanTimer(); // Avoid eating time
    return;
};
this.equipmentDamaged = this.equipmentDestroyed = function(equipmentKey)
{
    if(!player.ship.isValid) return;
    if(equipmentKey===&#39;EQ_CABAL_COMMON_COMM&#39;) this.checkEQ(&#39;EQ_CABAL_COMMON_COMM&#39;);
};
this.checkEQ = function()
{
    if(player.ship.equipmentStatus(&#39;EQ_CABAL_COMMON_COMM&#39;)===&#39;EQUIPMENT_UNAVAILABLE&#39;) player.ship.awardEquipment(&#39;EQ_CABAL_COMMON_COMM&#39;);
    else if(player.ship.equipmentStatus(&#39;EQ_CABAL_COMMON_COMM&#39;)===&#39;EQUIPMENT_DAMAGED&#39;) player.ship.setEquipmentStatus(&#39;EQ_CABAL_COMMON_COMM&#39;,&#39;EQUIPMENT_OK&#39;);
    if(!this.cleanUpTimer) this.cleanUpTimer = new Timer(this,this.doCleanUpTimer,0,25);
    else this.cleanUpTimer.start();
    return;
};
this.shipDied = function()
{
    this.cleanTimer();
};
this.cleanTimer = function()
{
    if(this.cleanUpTimer){
        this.cleanUpTimer.stop();
        delete this.cleanUpTimer;
    }
    return;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Functions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Functions&quot;;
this.author = &quot;Cmd.Cheyd, PhantorGorth and Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Libraryscript&quot;;
this.version = &quot;1.7&quot;;

/* class: Cabal_Common
This is the main class for the helper library with its members. Scripts can instantiate a copy, e.g.
&gt; this.myHelper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
*/
this.Cabal_Common = function(){}
Cabal_Common.prototype = {
	constructor: Cabal_Common,
	// Property to give OXPs a chance to check the required lib min. version easily.
	internalVersion: 15,
	// v1.77 spacer
	spacer: String.fromCharCode(31),
	spacerWidth: defaultFont.measureString(String.fromCharCode(31)),
	spacerStandard: String.fromCharCode(32),
	spacerWidthStandard: defaultFont.measureString(String.fromCharCode(32)),
	/* method: baseChange(). Changes the base of n.
	Parameters:
		n - Number. To be changed.
		to - Number. Base which should be used to convert to. Usually 2,10 or 16.
		from - Number. Optional. Base from which should be converted. Usually 2,10 or 16.
	Returns:
		str - String. Base changed.
	Author: Dr.J R Stockton.
	*/
	baseChange: function(n,to,from){
		return(parseInt(n,from || 10).toString(to));
	},
	/* method: clamp()
	Clamps value to max...min.
	Paramaters:
		value - Number. To be clamped.
		max - Number. Maximum.
		min - Number. Minimum.
	Returns:
		n - Number. Clamped.
	*/
	clamp: function(value,max,min){
		return(((value&gt;max)?max:(value&lt;min)?min:value));
	},
	/* method: msbPos()
	Returns position of most significant bit of n.
	Paramaters:
		n - Number. To be evaluated.
	Returns:
		n - Number. The position of the most significant bit or 0 (zero).
	Author: Dr.J R Stockton.
	*/
	msbPos: function(n){
		var e = 15;
		for(var r=8;r&gt;0;r&gt;&gt;=1){
			e = (n&lt;1&lt;&lt;e)?e-r:e+r;
		}
		return((n&lt;1&lt;&lt;e)?e:e+1);
	},
	/* method: nBitsUsed()
	Returns number of bits set in n. If n&lt;0 a bitwise NOT will be applied before execution.
	Parameters:
		n - Number. To be evaluated.
	Returns:
		e - Number. The counted number of bits set to 1.
	*/
	nBitsUsed: function(n){
		var e = 0;
		if(n&lt;0) n = ~n;
		while(n&gt;0){
			if((n&amp;1)) e++;
			n&gt;&gt;=1;
		}
		return(e);
	},
	/* method: num2Prec()
	Returns rounded number with specified precision. Unlike .toFixed() or .toPrecision() trailing zeros are capped.
	Parameters:
		x - Number. To be evaluated.
		p - Number. Decimals.
	Returns:
		e - Number. The rounded number.
	*/
	num2Prec: function(x,p){
		if(!x) return 0;
		var n = Math.pow(10,p);
		return Math.round(x*n)/n;
	},
	/* method: pseudoRand()
	LCG (Linear congruential generator) pseudo-random number generator with salt (and pepper).
	Can be used to generate deterministic unique values, e.g. to decide if a specific entity should be spawned.
	Parameters:
		salt - Number. This is used to generate a pseudo random number.
		mode - Boolean. Optional. If specified and true the returned value is integer (Math.floor(n*100)).
	Returns:
		n - Number. If no mode specified in range [0...1] otherwise [0...100].
	Author: Jens Ayrton (Ahruman).
	*/
	pseudoRand: function(salt,mode){
		var n = system.scrambledPseudoRandomNumber(salt);
		if(mode) n = Math.floor(n*100);
		return(n);
	},
	/* method: rand()
	Random number in range 0...n.
	Parameters:
		n - Number. Maximum value.
	Returns:
		n - Number. Returns the random Number.
	Author: Dr.J R Stockton.
	*/
	rand: function(n){
		return(n*(Math.random()%1) | 0);
	},
	/* method: randSpan()
	Random number in range minN...maxN.
	Paramaters:
		minN - Number. Minimum.
		maxN - Number. Maximum.
	Returns:
		n - Number. The newly generated random Number.
	Author: Dr.J R Stockton.
	*/
	randSpan: function(minN,maxN){
		return minN+this.rand(maxN-minN+1);
	},
	/* method: strAddAlignedText()
	Returns padded text for a single line.
	Parameters:
		text		- String.
		alignment	- String. Optional. Either L, C or R. Default L.
	Returns:
		str			- String. Padded text.
	Author: Thargoid */
	strAddAlignedText: function(text,alignment){
		if(!text) return(&quot;&quot;);
		var validAlignment = &quot;LCR&quot;,textWidth,padCount,padString;
		if(!alignment || validAlignment.indexOf(alignment)===-1) alignment = &quot;L&quot;;
		alignment = alignment.toUpperCase();
		textWidth = defaultFont.measureString(text);
		if(textWidth&gt;32 || alignment===&quot;L&quot;) return(text);
		padCount = Math.floor((32-textWidth)/this.spacerWidth);
		if(alignment===&quot;C&quot;) padCount = Math.floor(padCount/2);
		padString = this.strCreatePadString(padCount);
		return(padString+text);
	},
	/* method: strAddEdgeText()
	Returns two edge-aligned columns, one on the left and the other on the right for a single line.
	Parameters:
		leftText	- String.
		rightText	- String.
	Returns:
		str			- String. Aligned text.
	Author: Thargoid */
	strAddEdgeText: function(leftText,rightText){
		if(!rightText){
			if(leftText) return(leftText);
		}
		var textWidth = defaultFont.measureString(leftText)+defaultFont.measureString(rightText);
		if(textWidth&gt;32){
			log(&quot;CCL strAdEdgeText&quot;,&quot;Text &quot;+leftText+&quot; plus &quot;+rightText+&quot; is too long for a single screen line!&quot;);
			return(&quot;&quot;);
		}
		var padCount = Math.floor((32-textWidth)/this.spacerWidth);
		var padString = this.strCreatePadString(padCount);
		return(leftText+padString+rightText);
	},
	/* method: strAddIndentedText()
	Returns indented line of text by the given distance (in ems) from the left.
	Parameters:
		text		- String.
		indent		- Number.
	Returns:
		str			- String. Indented text.
	Author: Thargoid */
	strAddIndentedText: function(text,indent){
		if(!text) return(&quot;&quot;);
		var textWidth = defaultFont.measureString(text);
		if(textWidth&gt;32 || typeof(indent)!==&#39;number&#39; || indent&lt;0 || indent&gt;31.8) return(text);
		var padCount = Math.floor(indent/this.spacerWidth);
		var padString = this.strCreatePadString(padCount);
		return(padString+text);
	},
	/* method: strAdd2Columns()
	Returns line of text with two columns indented from the left margin by the given amount (in ems, 0-32).
	Parameters:
		leftText	- String.
		leftIndent	- Number.
		rightText	- String.
		rightIndent	- Number.
	Returns:
		str			- String. Text with 2 columns.
	Author: Thargoid */
	strAdd2Columns: function(leftText,leftIndent,rightText,rightIndent){
		if(!leftText || !rightText || typeof(leftIndent)!==&#39;number&#39; || typeof(rightIndent)!==&#39;number&#39; || leftIndent&gt;rightIndent || leftIndent&lt;0 || leftIndent&gt;31.8 || rightIndent&lt;0 || rightIndent&gt;31.8) return(&quot;&quot;);
		var textWidth = defaultFont.measureString(leftText)+defaultFont.measureString(rightText);
		if(textWidth&gt;32){
			log(&quot;CCL strAdd2Columns&quot;,&quot;2 column text is too long for a single screen line!&quot;);
			return(&quot;&quot;);
		}
		var leftPad = this.strCreatePadString(Math.floor(leftIndent/this.spacerWidth));
		var rightCount = rightIndent-(leftIndent+defaultFont.measureString(rightText));
		var rightPad;
		if(rightCount&lt;=0){
			log(&quot;CCL strAdd2Columns&quot;,&quot;Left column overrun!&quot;);
			rightPad = &quot;&quot;;
		} else rightPad = this.strCreatePadString(Math.floor(rightCount/this.spacerWidth));
		return(leftPad+leftText+rightPad+rightText);
	},
	/* method: strAdd3Columns()
	Returns text with three columns, left, centre and right.
	Parameters:
		leftText	- String.
		leftIndent	- Number.
		centreText	- String.
		centreIndent- Number.
		rightText	- String.
		rightIndent	- Number.
	Returns:
		str			- String. Text with 3 columns.
	Author: Thargoid */
	strAdd3Columns: function(leftText,leftIndent,centreText,centreIndent,rightText,rightIndent){
		if(!leftText || !centreText || !rightText || typeof(leftIndent)!==&#39;number&#39; || typeof(centreIndent)!==&#39;number&#39; || typeof(rightIndent)!==&#39;number&#39; || leftIndent&gt;centreIndent || centreIndent&gt;rightIndent || leftIndent&lt;0 || leftIndent&gt;32 || centreIndent&lt;0 || centreIndent&gt;32 || rightIndent&lt;0 || rightIndent&gt;32) return(&quot;&quot;);
		var textWidth = defaultFont.measureString(leftText)+defaultFont.measureString(centreText)+defaultFont.measureString(rightText);
		if(textWidth&gt;32){
			log(&quot;CCL atrAdd3Columns&quot;,&quot;3 column text is too long for a single screen line!&quot;);
			return(&quot;&quot;);
		}
		var leftPad = this.strCreatePadString(Math.floor(leftIndent/this.spacerWidth));
		var centreCount = centreIndent-(leftIndent+defaultFont.measureString(centreText));
		var centrePad,rightPad;
		if(centreCount&lt;=0){
			log(&quot;CCL strAdd3Columns&quot;,&quot;Left column overrun!&quot;);
			centrePad = &quot;&quot;;
		} else centrePad = this.strCreatePadString(Math.floor(centreCount/this.spacerWidth));
		var rightCount = rightIndent-(centreIndent+defaultFont.measureString(rightText));
		if(rightCount&lt;=0){
			log(&quot;CCL strAdd3Columns&quot;,&quot;Centre column overrun!&quot;);
			rightPad = &quot;&quot;;
		} else rightPad = this.strCreatePadString(Math.floor(rightCount/this.spacerWidth));
		return(leftPad+leftText+centrePad+centreText+rightPad+rightText);
	},
	/* method: strCompareVersion()
	Compares version strings (like &quot;2.0.3&quot;) against each other and returns number.
	It also strips pre/suffixes like &quot;Build&quot; or &quot;Beta&quot;.
	Parameters:
		strA - String. Actual version.
		strB - String. Version to be compared against.
	Returns:
		0 - Number. If strA &lt; strB
		1 - Number. If strA = strB
		2 - Number. If strA &gt; strB
	*/
	strCompareVersion: function(strA,strB){
		var x = strA.split(&#39;.&#39;),y = strB.split(&#39;.&#39;);
		if(isNaN(parseInt(x[0],null))){
			var n = x[0].search(/\d+/);
			if(n!==-1) x[0] = parseFloat(x[0].substr(n),null);
			else x.shift();
		}
		var xl = x.length,yl = y.length;
		if(!xl) return(0);
		for(var i=0;i&lt;yl;i++){
			if(xl&lt;=i) return(0);
			if(parseInt(x[i],null)&gt;y[i]) return(2);
			if(parseInt(x[i],null)&lt;y[i]) return(0);
		}
		return(1);
	},
	/* Internal method
	Author: Thargoid */
	strCreatePadString: function(count){
		var padString = &quot;&quot;;
		if(!count || count&lt;=0) return(padString);
		var counter = 0;
		for(counter=0;counter&lt;count;counter++){
			padString = padString+this.spacer;
		}
		return(padString);
	},
	/* method: strEncrypt()
	Encrypts string.
	Parameters:
		str - String. To be encrypted. Minimum length 6 chars.
		pwd - String. Password. Minimum length 4 chars.
	Returns:
		enc_str - String/Boolean. Encrypted string or false.
	Author: Terry Yuen.
	*/
	strEncrypt: function(str,pwd){
		if(!str || !pwd || str.length&lt;6 || pwd.length&lt;4){log(&quot;Cabal_Common&quot;,&quot;Parameters error in encrypt.&quot;); return(false);}
		var prand = &quot;&quot;;
		for(var i=0;i&lt;pwd.length;i++) prand += pwd.charCodeAt(i).toString();
		var sPos = Math.floor(prand.length/5);
		var mult = parseInt(prand.charAt(sPos)+prand.charAt(sPos*2)+prand.charAt(sPos*3)+prand.charAt(sPos*4)+prand.charAt(sPos*5),null);
		var incr = Math.ceil(pwd.length/2);
		var modu = Math.pow(2,31)-1;
		if(mult&lt;2){log(&quot;Cabal_Common&quot;,&quot;Algorithm cannot find a suitable hash.&quot;); return(false);}
		var salt = Math.round(Math.random()*1000000000)%100000000;
		prand += salt;
		while(prand.length&gt;10) prand = (parseInt(prand.substring(0,10),null)+parseInt(prand.substring(10,prand.length),null)).toString();
		prand = (mult*prand+incr)%modu;
		var enc_chr = &quot;&quot;,enc_str = &quot;&quot;;
		for(var i=0;i&lt;str.length;i++){
			enc_chr = parseInt(str.charCodeAt(i)^Math.floor((prand/modu)*255),null);
			if(enc_chr&lt;16) enc_str += &quot;0&quot;+enc_chr.toString(16);
			else enc_str += enc_chr.toString(16);
			prand = (mult*prand+incr)%modu;
		}
		salt = salt.toString(16);
		while(salt.length&lt;8) salt = &quot;0&quot;+salt;
		enc_str += salt;
		return(enc_str);
	},
	/* method: strDecrypt()
	Decrypts string.
	Parameters:
		str - String. To be decrypted. Minimum length 6 chars.
		pwd - String. Password. Minimum length 4 chars.
	Returns:
		dec_str - String/Boolean. Decrypted string or false.
	Author: Terry Yuen.
	*/
	strDecrypt: function(str,pwd){
		if(!str || !pwd || str.length&lt;6 || pwd.length&lt;4){log(&quot;Cabal_Common&quot;,&quot;Parameters error.&quot;); return(false);}
		var prand = &quot;&quot;;
		for(var i=0;i&lt;pwd.length;i++) prand += pwd.charCodeAt(i).toString();
		var sPos = Math.floor(prand.length/5);
		var mult = parseInt(prand.charAt(sPos)+prand.charAt(sPos*2)+prand.charAt(sPos*3)+prand.charAt(sPos*4)+prand.charAt(sPos*5),null);
		var incr = Math.round(pwd.length/2);
		var modu = Math.pow(2,31)-1;
		var salt = parseInt(str.substring(str.length-8,str.length),16);
		str = str.substring(0,str.length-8);
		prand += salt;
		while(prand.length&gt;10) prand = (parseInt(prand.substring(0,10),null)+parseInt(prand.substring(10,prand.length),null)).toString();
		prand = (mult*prand+incr)%modu;
		var enc_chr = &quot;&quot;,dec_str = &quot;&quot;;
		for(var i=0;i&lt;str.length;i+=2){
			enc_chr = parseInt(parseInt(str.substring(i,i+2),16)^Math.floor((prand/modu)*255),null);
			dec_str += String.fromCharCode(enc_chr);
			prand = (mult*prand+incr)%modu;
		}
		return(dec_str);
	},
	/* method: strGetCRC()
	Simple CRC from string. Does not create unique checksums. It uses Unicodes, but limits every char via &amp;0xff and the output via &amp;0x3fff.
	Parameters:
		str - String. Which should be used to create a CRC.
	Returns:
		crc - Number. The CRC.
	*/
	strGetCRC: function(str){
		var crc = 0, i = str.length;
		while(i--) crc += (str.charCodeAt(i)&amp;0xff);
		return((crc&amp;0x3fff));
	},
	/* method: strDateFromMinutes()
	Takes an integer number of minutes and converts it into a string.
	The returned string has the form &#39;d&#39; days, &#39;h&#39; hours and &#39;m&#39; minutes, accomodating all cases of singular, plural, and 0.
	Parameters:
		minutes - Number. The time in minutes.
	Returns:
		timeString - String.
	Author: Commander McLane.
	*/
	strDateFromMinutes: function(minutes){
		var ago = false;
		if(minutes&lt;0) ago = true;
		minutes = Math.abs(minutes);
		var daysComponent = Math.floor(minutes/24/60);
		var hoursComponent = Math.floor((minutes%(24*60))/60);
		var minutesComponent = minutes%60;
		var timeString = &quot;&quot;;
		if(daysComponent&gt;0) timeString += daysComponent + &quot; day&quot;;
		if(daysComponent&gt;1) timeString += &quot;s&quot;;
		if(timeString!==&quot;&quot;){
			if(hoursComponent&gt;0 &amp;&amp; minutesComponent&gt;0) timeString += &quot;, &quot;;
			else if(hoursComponent&gt;0) timeString += &quot; and &quot;;
		}
		if(hoursComponent&gt;0) timeString += hoursComponent + &quot; hour&quot;;
		if(hoursComponent&gt;1) timeString += &quot;s&quot;;
		if(timeString!==&quot;&quot; &amp;&amp; minutesComponent&gt;0) timeString += &quot; and &quot;;
		if(minutesComponent&gt;0) timeString += minutesComponent + &quot; minute&quot;;
		if(minutesComponent&gt;1) timeString += &quot;s&quot;;
		if(timeString===&quot;&quot;) timeString = &quot;no time&quot;;
		if(ago) timeString += &quot; ago&quot;;
		return timeString;
	},
	/* method: strDateRelative()
	Returns string (e.g. &#39;4 minutes ago&#39;).
	Parameters:
		inSec - Number. In seconds.
	Returns:
		str - String.
	*/
	strDateRelative: function(inSec){
		var reference = clock.absoluteSeconds,delta,formats,format,i,len;
		var sec = 1; var min = 60*sec; var hour = 60*min; var day = 24*hour; var week = 7*day; var year = day*365; var month = year/12;
		if(inSec&lt;=0){
			delta = reference-(clock.absoluteSeconds+inSec);
			formats = [[0.7*min,&#39;just now&#39;],[1.5*min,&#39;a minute ago&#39;],[60*min,&#39;minutes ago&#39;,min],[1.5*hour,&#39;an hour ago&#39;],
				[0.7*day,&#39;hours ago&#39;,hour],[day,&#39;today&#39;],[2*day,&#39;yesterday&#39;],[7*day,&#39;days ago&#39;,day],[1.5*week,&#39;a week ago&#39;],
				[month,&#39;weeks ago&#39;,week],[1.5*month,&#39;a month ago&#39;],[year,&#39;months ago&#39;,month],[1.5*year,&#39;a year ago&#39;],
				[Number.MAX_VALUE,&#39;years ago&#39;,year]];
		} else {
			delta = (clock.absoluteSeconds+inSec)-reference;
			formats = [[0.7*min,&#39;just now&#39;],[1.5*min,&#39;a minute&#39;],[60*min,&#39;minutes&#39;,min],[1.5*hour,&#39;an hour&#39;],
				[0.7*day,&#39;hours&#39;,hour],[day,&#39;today&#39;],[2*day,&#39;tomorrow&#39;],[7*day,&#39;days&#39;,day],[1.5*week,&#39;a week&#39;],
				[month,&#39;weeks&#39;,week],[1.5*month,&#39;a month&#39;],[year,&#39;months&#39;,month],[1.5*year,&#39;a year&#39;],
				[Number.MAX_VALUE,&#39;years&#39;,year]];
		}
		for(i=-1,len=formats.length;++i&lt;len;){
			format = formats[i];
			if(delta&lt;format[0]) return format[2] == undefined?format[1]:Math.round(delta/format[2])+&#39; &#39;+format[1];
		}
	},
	/* method: strLZ()
	Returns string with a leading zero if n&lt;10.
	Parameters:
		n - Number. To be evaluated.
	Returns:
		str - String. With leading zero if necessary.
	Author: Dr.J R Stockton.
	*/
	strLZ: function(n){
		return (n!=null&amp;&amp;n&lt;10&amp;&amp;n&gt;=0?&quot;0&quot;:&quot;&quot;)+n;
	},
	/* method: strLZZ()
	Returns string with a leading zeros if n&lt;100. Uses &lt;strLZ()&gt; as subfunction.
	Parameters:
		n - Number. To be evaluated.
	Returns:
		str - String. With leading zeros if necessary.
	Author: Dr.J R Stockton.
	*/
	strLZZ: function(n){
		return(n!=null&amp;&amp;n&lt;100&amp;&amp;n&gt;=0?&quot;0&quot;+this.strLZ(n):&quot;&quot;+n);
	},
	/* method: strNLZ()
	Returns string with length of len filled with leading zeros.
	Parameters:
		n - Number. To be evaluated.
		len - Number. Length. Maximum is 10.
	Returns:
		str - String. Filled up with leading zeros.
	*/
	strNLZ: function(n,len){
		var s = n.toString();
		if(!len || len&lt;s.length) len = s.length;
		if(len &amp;&amp; len&gt;10) len = 10;
		if(s.length&lt;len) s = (&quot;0000000000&quot;+s).slice(-len);
		return s;
	},
	/* method: strRandom()
	Returns random string with length of l.
	Parameters:
		l - Number. Length.
	Returns:
		str - String.
	*/
	strRandom: function(l){
		var str = &quot;&quot;;
		for(var j=0;j&lt;l;j++) str += String.fromCharCode(97+this.rand(26));
		return str;
	},
	/* method: strRandomInt()
	Returns random numbered string with length of l.
	Parameters:
		l - Number. Length in range of 1...9.
	Returns:
		str - String.
	*/
	strRandomInt: function(l){
		var str = String(1000000000+Math.random()*1000000000 | 0);
		return str.substr(0,l);
	},
	/* method: strScreenSubString()
	Formats the string str into lines of at most chrs characters in length.
	Parameters:
		str - String. To be used.
		chrs - Number. The length.
	Returns:
		out - String. With specified length.
	*/
	strScreenSubString: function(str,chrs){
		var out = &quot;&quot;;
		for(var d=0;d&lt;(str.length/chrs);d++) out += str.substr(d*chrs,chrs)+&quot;\n&quot;;
		return(out);
	},
	/* method: strScreenString()
	Splits string in pieces of chrs, with intermediate linebreaks for missionscreens and fills up current line.
	If splitting is not possible or a word is longer than chrs, &lt;strScreenSubString()&gt; will be used.
	Parameters:
		str - String. To be used.
		mode - Boolean. Optional. If mode is false or not specified it replaces special signs like linebreaks with spaces.
		chrs - Number. Optional. Length. If not specified default of 70 is used.
	Returns:
		display - String. With linebreaks.
	*/
	strScreenString: function(str,mode,chrs){
		if(!mode) str = str.replace(/[\t\r\f\n\v]/g,&quot; &quot;);
		if(!chrs) chrs = 70;
		var display = &quot;&quot;, splob = str.split(&quot; &quot;);
		var l = splob.length, temp = &quot;&quot;;
		if(l&lt;2) display = this.strScreenSubString(str,chrs);
		else {
			for(var o=0;o&lt;l;o++){
				if(splob[o].length&gt;chrs){
					display += temp+&quot;\n&quot;;
					display += this.strScreenSubString(splob[o],chrs);
					temp = &quot;&quot;;
					continue;
				}
				if(!o &amp;&amp; splob[o].length&lt;chrs){
					temp = splob[o];
					continue;
				}
				if((temp.length+splob[o].length)&lt;chrs){
					if(temp!==&quot;&quot;) temp += &quot; &quot;+splob[o];
					else temp += splob[o];
				} else {
					display += temp+&quot;\n&quot;;
					temp = splob[o];
				}
			}
			if(temp!==&quot;&quot;) display += temp;
		}
		return(display);
	},
	/* method: strSplitToPhrases()
	Splits string into n words phrases.
	Parameters:
		str - String. To be used.
		n - Number. Words.
	Returns:
		out - Array. Containing Strings with n words per element.
	*/
	strSplitToPhrases: function(str,n){
		var arr = str.split(&quot; &quot;);
		var l = arr.length, out = [], sub = &quot;&quot;;
		for(var o=0;o&lt;l;o++){
			if(!arr[o] || arr[o]===&quot;&quot;) continue;
			if(o&gt;l-n) break;
			sub = &quot;&quot;;
			for(var i=o;i&lt;Math.min(o+n,l);i++){
				if(!arr[i] || arr[i]==&quot;&quot;) continue;
				sub += arr[i]+&quot; &quot;;
			}
			sub = sub.substr(0,sub.length-1);
			out.push(sub);
		}
		return(out);
	},
	/* method: strToWidth()
	Returns string with specific length based on Oolites font size.
	If stringwidth &gt; max it is truncated, otherwise filled up with space or specified chr.
	Parameters:
		str - String. To be used.
		max - Number. Maximum width.
		chr - String. Char to be used to fill up if stringwidth &lt; max.
	Returns:
		str - String. With specified width.
	*/
	strToWidth: function(str,max,chr){
		var l = defaultFont.measureString(str),c,d;
		if(chr) c = defaultFont.measureString(chr);
		if(l&gt;max){
			while(l&gt;max){
				str = str.substr(0,str.length-1);
				d = defaultFont.measureString(str[str.length-1]);
				l -= d;
			}
		} else {
			while(l&lt;max){
				if(chr &amp;&amp; chr!==&quot; &quot;){
					str += chr;
					l += c;
				} else {
					if(max-l&gt;1.7){
						str += this.spacerStandard;
						l += this.spacerWidthStandard;
					} else {
						if(max-l&gt;0.1){
							str += this.spacer;
							l += this.spacerWidth;
						} else break;
					}
				}
			}
		}
		return(str);
	},
	/* method: strTrim()
	Returns trimmed string.
	Parameters:
		str  - String.
	Returns:
		str - String.
	*/
	strTrim: function(str){
		return(str.replace(/[\b\f\r\n]/g,&quot;&quot;).toString().replace(/\s+$|^\s+/g,&quot;&quot;));
	},
	/* method: arrDiff()
	Returns difference between two arrays.
	Parameters:
		ar1 - Array. First.
		ar2 - Array. Second.
	Returns:
		diff - Array. Difference between two arrays.
	*/
	arrDiff: function(ar1,ar2){
		var a=[], diff=[];
		for(var i=0;i&lt;ar1.length;i++) a[ar1[i]]=true;
		for(var i=0;i&lt;ar2.length;i++){
			if(a[ar2[i]]) delete a[ar2[i]];
			else a[ar2[i]]=true;
		}
		return diff;
	},
	/* method: arrRemoveByValue()
	Removes specific entry from array.
	Parameters:
		arr - Array. From which things should be removed.
		val - Object. Value that has to be removed.
	Returns:
		arr - Array. The cleaned array.
	*/
	arrRemoveByValue: function(arr,val){
		for(var i=0;i&lt;arr.length;i++){
			if(arr[i]===val){
				arr.splice(i,1);
				break;
			}
		}
		return(arr);
	},
	/* method: arrShuffle()
	Returns shuffled array.
	Parameters:
		arr - Array.
	Returns:
		SHU - Array.
	Author: Dr.J R Stockton.
	*/
	arrShuffle: function(arr){
		var J,K,T,SHU=[].concat(arr);
		for(J=SHU.length-1;J&gt;0;J--){
			K = this.rand(J+1);
			T = SHU[J];
			SHU[J] = SHU[K];
			SHU[K] = T;
		}
		return SHU;
	},
	/* method: arrSortByProperty()
	Sort array containing objects by specific property.
	Parameters:
		arr - Array. To be sorted.
		prop - String. Propertyname.
	Returns:
		what - Array. Sorted by specified property.
	*/
	arrSortByProperty: function(arr,prop){
		function sortByPropName(a,b){
			var x = a[prop];
			var y = b[prop];
			return((x&lt;y)?-1:((x&gt;y)?1:0));
		}
		arr.sort(sortByPropName);
		return(arr);
	},
	/* method: arrUnique()
	Removes duplicates from array.
	Parameters:
		arr - Array. The input array, from which duplicates are to be removed.
	Returns:
		r - Array. The cleaned array.
	*/
	arrUnique: function(arr){
		var r = [];
		o:for(var i=0,n=arr.length;i&lt;n;i++){
			for(var x=0,y=r.length;x&lt;y;x++) if(r[x]==arr[i]) continue o;
			r[r.length] = arr[i];
		}
		return r;
	},
	/* method: mapCoordsDirection()
	Returns the general direction of the target coordinates compared to the current (or specified) system coordinates.
	Parameters:
		posA - Vector/ID. Map coordinates in LYs or simply a system.ID.
		posB - Vector/ID. Optional. Map coordinates in LYs or simply a system.ID. Defaults to current system coordinates.
	Returns:
		str - String.
	Author: Eric Walch.
	*/
	mapCoordsDirection: function(posA,posB){
		if(typeof(posA)===&#39;undefined&#39; || (typeof(posA)===&#39;object&#39; &amp;&amp; !posA)) return(&quot;current system&quot;);
		var pos1,pos2,dx,dy,x2,y2;
		if(typeof(posA)===&#39;number&#39;) pos2 = System.infoForSystem(galaxyNumber,posA).coordinates;
		else pos2 = new Vector3D(posA);
		if(typeof(posB)===&#39;number&#39;) pos1 = System.infoForSystem(galaxyNumber,posB).coordinates;
		else if(!posB) pos1 = system.info.coordinates;
		else pos1 = new Vector3D(posB);
		if(pos1.distanceTo(pos2)&lt;0.00001) return(&quot;current system&quot;);
		dx = pos2.x-pos1.x;
		dy = pos2.y-pos1.y;
		x2 = Math.abs(dx);
		y2 = Math.abs(dy);
		if(x2&gt;2.41421*y2) return(dx&gt;0?&quot;east&quot;:&quot;west&quot;);
		if(y2&gt;1.732*x2) return(dy&lt;0?&quot;north&quot;:&quot;south&quot;);
		if(dx&gt;0) return(dy&lt;0?&quot;north-east&quot;:&quot;south-east&quot;);
		return(dy&lt;0?&quot;north-west&quot;:&quot;south-west&quot;);
	},
	/* method: oxpVersionTest()
	Checks required OXPs and versions. The array is expected to contain two elements for each script and version must be null for legacy scripts!
	Parameters:
		who - String. Actual scriptname. It&#39;s only used to log for which OXP the requirements are not fullfilled.
		requires - Array. Holds for every required OXP the scriptname and version. To check only for existance set version to null.
		quiet - Boolean. Optional. If true don&#39;t log, only check.
	Returns:
		checked - Boolean.
		- false - If a requirement is not fullfilled or OXP is deactivated,
		- true - Otherwise.
	Note:
	The method checks for a property &#39;deactivated&#39; in OXPs to determine if they are deactived.
	*/
	oxpVersionTest: function(who,requires,quiet){
		var checked = true;
		for(var i=0;i&lt;requires.length;i+=2){
			if(typeof(worldScripts[requires[i]])===&#39;undefined&#39;){
				if(!requires[i+1]){checked = false; if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; not installed.&quot;);}
				else {checked = false; if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; min. version &quot;+requires[i+1]+&quot; not installed.&quot;);}
				continue;
			} else {
				if(requires[i+1] &amp;&amp; !this.strCompareVersion(worldScripts[requires[i]].version,requires[i+1])){checked = false;
					if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; required min. version &quot;+requires[i+1]+&quot; not found.&quot;);
					continue;
				}
			}
			if(worldScripts[requires[i]].deactivated) checked = false;
		}
		return(checked);
	},
	/* method: oxpVersionTest2Array()
	Checks required OXPs and versions. The array is expected to contain two elements for each script and version must be null for legacy scripts!
	Parameters:
		who - String. Actual scriptname. It&#39;s only used to log for which OXP the requirements are not fullfilled.
		requires - Array. Holds for every required OXP the scriptname and version. To check only for existance set version to null.
		quiet - Boolean. Optional. If true don&#39;t log, only check.
	Returns:
		checked - Array. With values for checked elements of requires.
		- 2 - version is greater,
		- 1 - version is equal,
		- 0 - not installed,
		- -1 - OXP is deactivated,
		- -2 - version is lower.
	*/
	oxpVersionTest2Array: function(who,requires,quiet){
		var checked = [],check = 0,loop = requires.length;
		for(var i=0;i&lt;loop;i+=2){
			if(typeof(worldScripts[requires[i]])===&#39;undefined&#39;){
				checked.push(0);
				if(!requires[i+1]){if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; not installed.&quot;);}
				else {if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; min. version &quot;+requires[i+1]+&quot; not installed.&quot;);}
				continue;
			} else {
				if(worldScripts[requires[i]].deactivated) checked.push(-1);
				else if(requires[i+1]){
					check = this.strCompareVersion(worldScripts[requires[i]].version,requires[i+1]);
					if(!check){
						checked.push(-2);
						if(!quiet) log(&quot;Check&quot;,who+&quot; requirement not matched : &quot;+requires[i]+&quot; required min. version &quot;+requires[i+1]+&quot; not found.&quot;);
						continue;
					} else checked.push(check);
				}
			}
		}
		return(checked);
	},
	/* method: entModelView()
	Spawns or resets the modelview entity and returns it.
	Parameters:
		which - String. Optional. Role to be used for modelview. If not specified defaults to &#39;cabal_common_modelview&#39;.
	Returns:
		mv - Entity. Returns modelview Entity or null.
	*/
	entModelView: function(which){
		if(!player.ship.docked) return(false);
		var mv = null;
		if(!which) which = &#39;cabal_common_modelview&#39;;
		if(!system.countShipsWithRole(which)) mv = system.addShips(which,1,player.ship.position,5000.0)[0];
		else mv = system.shipsWithPrimaryRole(which)[0];
		if(mv) mv.AIState = &#39;GLOBAL&#39;;
		return(mv);
	},
	/* method: entFaceEntity()
	This function causes ent1 to be reorientated such that it faces ent2. A common use-case is when spawning stations whose docking
	tunnel should face another entity, typically the main planet. Reorienting is instantly.
	Parameters:
		ent1 - Entity. To be reoriented.
		ent2 - Entity. To which ent1 should be oriented.
	Returns:
		nothing.
	*/
	entFaceEntity: function(ent1,ent2){
		var targetVector = ent2.position.subtract(ent1.position).direction();
		var angle = ent1.heading.angleTo(targetVector);
		var cross = ent1.heading.cross(targetVector).direction();
		ent1.orientation = ent1.orientation.rotate(cross,-angle);
		return;
	},
	/* method: entScreenCornerPos()
	Missionscreen model corner positioning.
	Parameters:
		level - Number. Works best with values between 0 and 0.35.
		signx - Number. Used as sign mantissa (-1...1) for X axis.
		signy - Number. Used as sign mantissa (-1...1) for Y axis.
		further - Number. Multiplier for Z axis. Defaults to 1.3.
	Returns:
		nothing.
	*/
	entScreenCornerPos: function(level,signx,signy,further){
		var pos = mission.displayModel.position,w = 1024/oolite.gameSettings.gameWindow.width,h = 768/oolite.gameSettings.gameWindow.height;
		pos.x = level*pos.z*signx;
		pos.y = level*pos.z*0.75*signy;
		if(further) pos.z *= further;
		else pos.z *= 1.3;
		var wh = w/h;
		pos = pos.add([w*wh-1,h*wh-1,0]);
		mission.displayModel.position=pos;
		return;
	},
	/* method: screenGCD()
	Returns greatest common denominator. Subfunction.
	Parameters:
		a - Number.
		b - Number.
	Returns:
		n - Number.
	*/
	screenGCD: function(a,b){
		return((b==0)?a:this.screenGCD(b,a%b));
	},
	/* method: screenAspect()
	Returns aspect ratio. Subfunction.
	Parameters:
		w - Number. Width.
		h - Number. Height.
		d - Number. Denominator.
	Returns:
		n - Number.
	*/
	screenAspect: function(w,h,d){
		if(!d) d = this.screenGCD(w,h);
		return((w/d)/(h/d));
	},
	/* method: screenChecks()
	Returns array with width,height,denominator and aspect ratio.
	Parameters:
		w - Number. Width. Optional.
		h - Number. Height. Optional.
	Returns:
		a - Array.
	*/
	screenChecks: function(w,h){
		if(!w) w = oolite.gameSettings.gameWindow.width;
		if(!h) h = oolite.gameSettings.gameWindow.height;
		var d = this.screenGCD(w,h);
		var a = this.screenAspect(w,h,d);
		return([w,h,d,a]);
	}
};

/* class: Cabal_Common_BinSearch
This is the main class for the binary search tree with its members. This search tree uses two corresponding entries.
*/
this.Cabal_Common_BinSearch = function(){this._cclbinsearch = null;}
Cabal_Common_BinSearch.prototype = {
	constructor: Cabal_Common_BinSearch,
	/* property: internalVersion
	Property to give OXPs a chance to check the required lib min. version easily.
	*/
	internalVersion: 15,
	/* method: add()
	Adds nodes to the search tree with the corresponding entry.
	Parameters:
		key - String. Add node with key.
		value - Object. Corresponding entry
	Returns:
		nothing
	*/
	add: function(key,value){
		var node = {key: key,left: null,right: null, value: value},current;
		if(this._cclbinsearch === null) this._cclbinsearch = node;
		else {
			current = this._cclbinsearch;
			while(true){
				if(key &lt; current.key){
					if(current.left === null){
						current.left = node;
						break;
					} else current = current.left;
				} else if(key &gt; current.key){
					if(current.right === null){
						current.right = node;
						break;
					} else current = current.right;
				} else break;
			}
		}
		return;
	},
	/* method: contains()
	Returns corresponing entry or false.
	Parameters:
		key - String. Search for entry.
	Returns:
		value - Object. Corresponding entry or false.
	*/
	contains: function(key){
		var found = false,current = this._cclbinsearch;
		while(!found &amp;&amp; current){
			if(key &lt; current.key) current = current.left;
			else if(key &gt; current.key) current = current.right;
			else found = true;
		}
		if(!found) return (false);
		return (current.value);
	},
	// Internal
	traverse: function(process){
		function inOrder(node){
			if(node){
				if(node.left !== null) inOrder(node.left);
				process.call(this, node);
				if(node.right !== null) inOrder(node.right);
			}
		}
		inOrder(this._cclbinsearch);
	},
	/* method: size()
	Returns the number of nodes in the search tree.
	Parameters:
		none
	Returns:
		length - Number. Number of nodes in searchtree.
	*/
	size: function(){
		var length = 0;
		this.traverse(function(node){length++;});
		return length;
	},
	/* method: toArray()
	Returns an array conaining all nodes in the search tree. The nodes are processed in-order.
	Parameters:
		none
	Returns:
		result - Array. Entries in search tree.
	*/
	toArray: function(){
		var result = [];
		this.traverse(function(node){result.push(node.key,node.value);});
		return result;
	},
	/* method: toString()
	Returns a comma-separated string consisting of all entries. The nodes are processed in-order.
	Parameters:
		separator - String. Optional. If specified separator is used to separate the elements instead of a commata.
	Returns:
		result - String. Concatenation of all entries in search tree.
	*/
	toString: function(separator){
		if(separator) return this.toArray().join(separator);
		else return this.toArray().toString();
	}
};

/* class: Cabal_Common_2DCollision
This is the main class for the 2D checks with its members.
*/
this.Cabal_Common_2DCollision = function(){}
Cabal_Common_2DCollision.prototype = {
	constructor: Cabal_Common_2DCollision,
	/* property: internalVersion
	Property to give OXPs a chance to check the required lib min. version easily.
	*/
	internalVersion: 15,
	/* method: boundingBox()
	Checks if point is inside the bounding box.
	Parameters:
		minmax - Array. 4 positions in a.x,a.y,b.x,b.y
		pos - Vector. Position to be checked.
	Returns:
		inside - Boolean. True if inside.
	*/
	boundingBox: function(minmax,pos){
		if(pos.x&lt;minmax[0] || pos.x&gt;minmax[1] || pos.y&lt;minmax[2] || pos.y&gt;minmax[3]) return(false);
		return(true);
	},
	/* method: pointInPoly()
	Checks if a point is inside a polygon.
	Parameters:
		nvert - Number of vertices in the polygon.
		vertx, verty - Arrays containing the x- and y-coordinates of the polygon&#39;s vertices.
		pos - Vector. x- and y-coordinate of the test point.
		con - Boolean. Concave shapes may need to set it.
	Return:
		inside - Boolean. True if inside.
	*/
	pointInPoly: function(nvert,vertx,verty,pos,con){
		var i,j,c = false,r1=0;
		for(i=0,j=nvert-1;i&lt;nvert;j=i++){
			if(((verty[i]&gt;pos.y)!==(verty[j]&gt;pos.y)) &amp;&amp; (pos.x&lt;(vertx[j]-vertx[i])*(pos.y-verty[i])/(verty[j]-verty[i])+vertx[i])){
				c = !c;
				r1++;
			}
			if(!con &amp;&amp; r1&gt;1) break;
		}
		return(c);
	},
	/* method: pointOnLine()
	Checks if point is on a specified line with a tolerance of 0.4.
	This method has a problem with vertical lines. If it needs to be more accurate use .pointOnLineB()
	Parameters:
		pa - Vector. Starting point of the line.
		pb - Vector. End point of the line.
		pos - Vector. Position to be checked.
	Return:
		online - Boolean. True if on line (within tolerance).
	*/
	pointOnLine: function(pa,pb,pos){
		var f = function(somex){return(pb.y-pa.y)/(pb.x-pa.x)*(somex-pa.x)+pa.y;};
		if((pa.x&gt;pos.x+0.4 &amp;&amp; pb.x&gt;pos.x+0.4) || (pa.x&lt;pos.x-0.4 &amp;&amp; pb.x&lt;pos.x-0.4)) return(false);
		if(pb.x&lt;pa.x){var t = pa; pa = pb; pb = t;} //Switch
		if(pa.x&gt;pb.x+0.4 || pa.x&lt;pb.x-0.4) return(Math.abs(f(pos.x)-pos.y)&lt;0.4 &amp;&amp; pos.x&gt;=pa.x &amp;&amp; pos.x&lt;=pb.x);
		return(((pos.y&gt;=pa.y &amp;&amp; pos.y&lt;=pb.y) || (pos.y&lt;=pa.y &amp;&amp; pos.y&gt;=pb.y)) &amp;&amp; (pos.x&gt;=pa.x &amp;&amp; pos.x&lt;=pb.x) || (pos.x&lt;=pa.x &amp;&amp; pos.x&gt;=pb.x));
	},
	/* method: pointOnLineB()
	Checks if point is on a specified line.
	Parameters:
		p1 - Vector. Starting point of the line.
		p2 - Vector. End point of the line.
		p3 - Vector. Position to be checked.
		tol - Number. Tolerance. Default 0.01.
	Return:
		online - Boolean. True if on line (within tolerance).
	Author: Paul Bourke
	*/
	pointOnLineB: function(p1,p2,p3,tol){
		var s,rnum,denom,check,distanceLine,distanceSegment,dist1,dist2;
		if(typeof(tol)!==&#39;number&#39;) tol = 0.01;
		rnum = (p3.x - p1.x) * (p2.x - p1.x) + (p3.y - p1.y) * (p2.y - p1.y);
		denom = (p2.x - p1.x) * (p2.x - p1.x) + (p2.y - p1.y) * (p2.y - p1.y);
		check = rnum / denom;
		s = ((p1.y-p3.y) * (p2.x - p1.x) - (p1.x - p3.x) * (p2.y - p1.y) ) / denom;
		distanceLine = Math.abs(s) * Math.sqrt(denom);
		if(check &gt;= 0 &amp;&amp; check &lt;= 1) distanceSegment = distanceLine;
		else {
			dist1 = (p3.x - p1.x) * (p3.x - p1.x) + (p3.y - p1.y) * (p3.y - p1.y);
			dist2 = (p3.x - p2.x) * (p3.x - p2.x) + (p3.y - p2.y) * (p3.y - p2.y);
			if(dist1 &lt; dist2) distanceSegment = Math.sqrt(dist1);
			else distanceSegment = Math.sqrt(dist2);
		}
		return((distanceSegment&lt;tol));
	}
};

// Functionality to check systems and get more infos about the session
this.moreInfo = {
	jumpCount: 0,
	lastJumpTime: clock.absoluteSeconds,
	lastJumpDiff: 0,
	avgEnts: system.allShips.length,
	conEnts: [system.allShips.length],
	avgEntsOXP: system.allShips.length,
	conEntsOXP: [system.allShips.length],
	galaxyStats : null,
	connected : null
};
this.startUp = function()
{
	delete this.startUp;
	this.getGalaxy(); // planetinfo.plist is already processed
	this.consTimer = new Timer(this,this.checkConnection,0.1);
};
this.playerEnteredNewGalaxy = function()
{
	this.getGalaxy();
	this.consTimer = new Timer(this,this.checkConnection,0.1);
};
this.shipWillEnterWitchspace = function()
{
	if(this.delayedTimer){this.delayedTimer.stop(); delete this.delayedTimer;}
	this.moreInfo.lastJumpDiff = clock.absoluteSeconds-this.moreInfo.lastJumpTime;
	this.moreInfo.lastJumpTime = clock.absoluteSeconds;
	this.moreInfo.jumpCount++;
	this.updateGalaxyStats();
};
this.shipWillExitWitchspace = function()
{
	this.updateGalaxyStats();
};
this.shipExitedWitchspace = function()
{
	if(!system.isInterstellarSpace &amp;&amp; this.moreInfo.jumpCount&lt;30){
		this.moreInfo.conEnts.push(system.allShips.length);
		var n=0;
		for(var a=0;a&lt;this.moreInfo.conEnts.length;a++) n+=this.moreInfo.conEnts[a];
		this.moreInfo.avgEnts = Math.ceil(n/this.moreInfo.conEnts.length);
		if(this.moreInfo.lastJumpDiff&gt;10) this.delayedTimer = new Timer(this,this.delayedShipExitedWitchspace,10);
	}
};
this.delayedShipExitedWitchspace = function()
{
	if(this.moreInfo.jumpCount&lt;30){
		this.moreInfo.conEntsOXP.push(system.allShips.length);
		var n=0;
		for(var a=0;a&lt;this.moreInfo.conEntsOXP.length;a++) n+=this.moreInfo.conEntsOXP[a];
		this.moreInfo.avgEntsOXP = Math.ceil(n/this.moreInfo.conEntsOXP.length);
	}
	delete this.delayedTimer;
};
this.updateGalaxyStats = function()
{
	if(system.isInterstellarSpace) return;
	var inf = this.moreInfo.galaxyStats.contains(system.ID),what = [&quot;coordinates&quot;,&quot;description&quot;,&quot;economy&quot;,&quot;government&quot;,&quot;inhabitant&quot;,&quot;inhabitants&quot;,[&quot;market&quot;,&quot;market&quot;],&quot;name&quot;,&quot;population&quot;,&quot;productivity&quot;,&quot;radius&quot;,[&quot;sun&quot;,&quot;sun_gone_nova&quot;],&quot;techlevel&quot;];
	var l = what.length,temp;
	for(var i=0;i&lt;l;i++){
		temp = what[i];
		if(typeof(temp)!==&quot;string&quot;){
			if(inf[temp[0]]===system.info[temp[1]]) continue;
			if(typeof(inf[temp[0]])!==&quot;undefined&quot;) inf[temp[0]] = (system.info[temp[1]]?false:true);
		} else {
			if(inf[temp]===system.info[temp]) continue;
			inf[temp] = system.info[temp];
		}
	}
	return;
};
this.getGalaxy = function()
{
	this.moreInfo.galaxyStats = new this.Cabal_Common_BinSearch(); // Binary tree by ID
	var c,gn=galaxyNumber,sy,r;
	this.gInfo = [];
	// Accessing system properties adds &gt;250 ms
	// except coordinates - this adds only ~4 ms
	for(var i=0;i&lt;256;i++){
		c=System.infoForSystem(gn,i);
		sy = {
			coordinates: {
				x:c.coordinates.x,
				y:c.coordinates.y,
				z:c.coordinates.z
			},
			description: c.description,
			economy: c.economy,
			government: c.government,
			ID: i,
			inhabitant: c.inhabitant,
			inhabitants: c.inhabitants,
			market: c.market,
			name: c.name,
			population: c.population,
			productivity: c.productivity,
			radius: c.radius,
			sun: (c.sun_gone_nova?false:true),
			techlevel: c.techlevel
		};
		r = {
			x: c.coordinates.x,
			y: c.coordinates.y,
			id: i,
			done: 0
		};
		this.gInfo.push(r);
		this.moreInfo.galaxyStats.add(i,sy);
	}
	return;
};
// Find connections
this.checkConnection = function()
{
	var helper = new this.Cabal_Common();
	var m = 1.0214285714285714285714285714286;
	var check = [],cur = [],cpp = player.ship.galaxyCoordinatesInLY,dist,temp;
	var cp = {
		x: cpp.x,
		y: cpp.y,
		z: 0
	};
	this.gInfo = helper.arrSortByProperty(this.gInfo,&quot;x&quot;);
	this.moreInfo.connected = [];
	// Start loop
	for(var i=0;i&lt;256;i++){
		temp = this.gInfo[i];
		if(temp.x&gt;cp.x+7.15) break;
		if(temp.x&lt;cp.x-7.15 || temp.y&lt;cp.y-7.15 || temp.y&gt;cp.y+7.15) continue;
		dist = Math.sqrt(((cp.x-temp.x)*(cp.x-temp.x)*m)+(cp.y-temp.y)*(cp.y-temp.y));
		if(dist&lt;7.341) cur.push(temp);
	}
	// Grow
	while(cur.length){
		check = check.concat(cur);
		cur = [];
		for(var o=0;o&lt;check.length;o++){
			cp = check[o];
			if(cp.id===system.ID || cp.done) continue;
			for(var i=0;i&lt;256;i++){
				temp = this.gInfo[i];
				if(temp.x&gt;cp.x+7.15) break;
				if(temp.x&lt;cp.x-7.15 || temp.y&lt;cp.y-7.15 || temp.y&gt;cp.y+7.15) continue;
				dist = Math.sqrt(((cp.x-temp.x)*(cp.x-temp.x)*m)+(cp.y-temp.y)*(cp.y-temp.y));
				if(dist&lt;7.341 &amp;&amp; check.indexOf(temp)===-1 &amp;&amp; cur.indexOf(temp)===-1) cur.push(temp);
			}
		}
		for(var m=0;m&lt;check.length;m++){
			temp = this.gInfo.indexOf(check[m]);
			this.gInfo[temp].done = 1;
		}
	}
	for(var t=0;t&lt;check.length;t++) this.moreInfo.connected.push(check[t].id);
	if(this.consTimer) delete this.consTimer;
	delete this.gInfo;
	return;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Keyboard.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Keyboard&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Libraryscript Keyboard&quot;;
this.version = &quot;1.7&quot;;
/* function: start()
Parameters:
	who - String. The name of a worldScript which implements the keyboard callback.
	min - Number. Optional - minimum length for completion, default(4).
	mode - Number. Optional - 1(only alphabetical), 2(only numeric), 3(hexadecimal), default 4(alphanumeric).
	scpic - String. Optional. Name for screenbackground build upon scpic + suffix. The mode defines which one will be used.
	scovl - String. Optional. Filename for screenoverlay (with fileextension). Default null.
	scmod - String. Optional. Role for the used model. Default &#39;cabal_common_key&#39;.

Returns:
nothing
&gt; worldScripts.Cabal_Common_Keyboard.start(this.name,5,1);

Suffixes are :
- 1 - &#39;_keyboard_alpha.png&#39;
- 2 - &#39;_keyboard_nums.png&#39;
- 3 - &#39;_keyboard_hex.png&#39;
- 4 - &#39;_keyboard.png&#39;
*/
this.start = function(who,min,mode,scpic,scovl,scmod)
{
	if(!player.ship.docked) return;
	this.keyboard = new Object({ini: true,input: &quot;&quot;,keyboardSound: new SoundSource(),loop: false,sound: &#39;cabal_common_key.ogg&#39;,
		maxRows: 4,model: &#39;cabal_common_key&#39;,modelSC: null,pic: &#39;cabal_common_keyboard.png&#39;,overlay: null,ratioX: 1,ratioY: 1,
		rowsT: [],rowsX: [],rowsY: [],toCall: null,toMin: 4,X: 4,Y: 2});
	if(who) this.keyboard.toCall = who;
	if(min &amp;&amp; !isNaN(min) &amp;&amp; min&gt;0) this.keyboard.toMin = min;
	else this.keyboard.toMin = 4;
	var rowsY_c = [69,46,23,-1],rowsX_c = [[-109,-85,-61,-36,-12.5,12,36.5,61,85,110],[-109.5,-85,-60.5,-36,-12.5,12.5,36.5,61,85,110],[-99.5,-75,-51,-26,-2,22,46.5,71,95],[-86,-61.5,-37.5,-13,12,36,61]];
	var rowsT_c = [[&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;0&quot;],[&quot;Q&quot;,&quot;W&quot;,&quot;E&quot;,&quot;R&quot;,&quot;T&quot;,&quot;Y&quot;,&quot;U&quot;,&quot;I&quot;,&quot;O&quot;,&quot;P&quot;],[&quot;A&quot;,&quot;S&quot;,&quot;D&quot;,&quot;F&quot;,&quot;G&quot;,&quot;H&quot;,&quot;J&quot;,&quot;K&quot;,&quot;L&quot;],[&quot;Z&quot;,&quot;X&quot;,&quot;C&quot;,&quot;V&quot;,&quot;B&quot;,&quot;N&quot;,&quot;M&quot;]];
	var rowsY_ch = [69,46],rowsX_ch = [[-109,-85,-61,-36,-12.5,12,36.5,61,85,110],[-60.5,-36,-12.5,12.5,36.5,61]];
	var rowsT_ch = [[&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;0&quot;],[&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;,&quot;E&quot;,&quot;F&quot;]];
	switch(mode){
		case 1: this.keyboard.rowsX = [rowsX_c[1],rowsX_c[2],rowsX_c[3]];
			this.keyboard.rowsY = [rowsY_c[1],rowsY_c[2],rowsY_c[3]];
			this.keyboard.rowsT = [rowsT_c[1],rowsT_c[2],rowsT_c[3]];
			this.keyboard.Y = 1;
			this.keyboard.maxRows = 2;
			if(scpic) this.keyboard.pic = scpic+&#39;_keyboard_alpha.png&#39;;
			else this.keyboard.pic = &#39;cabal_common_keyboard_alpha.png&#39;;
			break;
		case 2: this.keyboard.rowsX = [rowsX_c[0]];
			this.keyboard.rowsY = [rowsY_c[0]];
			this.keyboard.rowsT = [rowsT_c[0]];
			this.keyboard.Y = 0;
			this.keyboard.maxRows = 0;
			if(scpic) this.keyboard.pic = scpic+&#39;_keyboard_nums.png&#39;;
			else this.keyboard.pic = &#39;cabal_common_keyboard_nums.png&#39;;
			break;
		case 3: this.keyboard.rowsX = rowsX_ch;
			this.keyboard.rowsY = rowsY_ch;
			this.keyboard.rowsT = rowsT_ch;
			this.keyboard.Y = 0;
			this.keyboard.maxRows = 1;
			if(scpic) this.keyboard.pic = scpic+&#39;_keyboard_hex.png&#39;;
			else this.keyboard.pic = &#39;cabal_common_keyboard_hex.png&#39;;
			break;
		default: this.keyboard.rowsX = rowsX_c;
			this.keyboard.rowsY = rowsY_c;
			this.keyboard.rowsT = rowsT_c;
			this.keyboard.Y = 2;
			this.keyboard.maxRows = 3;
			if(scpic) this.keyboard.pic = scpic+&#39;_keyboard.png&#39;;
			else this.keyboard.pic = &#39;cabal_common_keyboard.png&#39;;
	}
	this.keyboard.X = 4;
	var r = (oolite.gameSettings.gameWindow.width/oolite.gameSettings.gameWindow.height),c = 1024/768;
	if(r&gt;c){
		var ccX = (r%c)/1.5,ccY = (r%c)/2;
		this.keyboard.ratioX = 1-ccX;
		this.keyboard.ratioY = 1-ccY;
	} else {
		this.keyboard.ratioX = 1;
		this.keyboard.ratioY = 1;
	}
	if(!player.ship.docked){
		if(this.keyboard) delete this.keyboard;
		return;
	}
	if(scovl) this.keyboard.overlay = scovl;
	if(scmod) this.keyboard.model = scmod;
	this.keyboard.keyboardSound.loop = false;
	this.keyboard.keyboardSound.sound = &#39;cabal_common_key.ogg&#39;;
	this.keyboardShow();
	this.keyboard.modelSC.lightsActive = true;
	return;
};
/* function: keyboardEval()
Workaround to change the context of this!!!
*/
this.keyboardEval = function(choice){worldScripts.Cabal_Common_Keyboard.keyboardChoice(choice); return;};
/* function: keyboardChoice()
Evaluates the user choice.
When &lt;keyboard.toCall&gt; is specified and user confirms or aborts the keyboard input.

Callback:
- &quot;&quot; - String. if user aborts.
- &lt;keyboard.input&gt; - String. If user confirmed input.
&gt; worldScripts[this.keyboard.toCall].Cabal_Common_Keyboard_Output(this.keyboard.input);
*/
this.keyboardChoice = function(choice)
{
	switch(choice){
		case &#39;CABAL_COMMON_KEYBOARDA&#39;:
			this.keyboard.X--;
			if(this.keyboard.X&lt;0) this.keyboard.X = this.keyboard.rowsX[this.keyboard.Y].length-1;
			this.keyboardShow(); break;
		case &#39;CABAL_COMMON_KEYBOARDB&#39;:
			this.keyboard.Y--;
			if(this.keyboard.Y&lt;0) this.keyboard.Y = this.keyboard.maxRows;
			if(this.keyboard.X&gt;this.keyboard.rowsX[this.keyboard.Y].length-1) this.keyboard.X = this.keyboard.rowsX[this.keyboard.Y].length-1;
			this.keyboardShow(); break;
		case &#39;CABAL_COMMON_KEYBOARDC&#39;:
			this.keyboard.Y++;
			if(this.keyboard.Y&gt;this.keyboard.maxRows) this.keyboard.Y = 0;
			if(this.keyboard.X&gt;this.keyboard.rowsX[this.keyboard.Y].length-1) this.keyboard.X = this.keyboard.rowsX[this.keyboard.Y].length-1;
			this.keyboardShow(); break;
		case &#39;CABAL_COMMON_KEYBOARDD&#39;:
			this.keyboard.input += this.keyboard.rowsT[this.keyboard.Y][this.keyboard.X];
			this.keyboardShow(); break;
		case &#39;CABAL_COMMON_KEYBOARDE&#39;:
			if(this.keyboard.input.length) this.keyboard.input = this.keyboard.input.substr(0,this.keyboard.input.length-1);
			this.keyboardShow(); break;
		case &#39;CABAL_COMMON_KEYBOARDY&#39;:
			if(this.keyboard.toCall) worldScripts[this.keyboard.toCall].Cabal_Common_Keyboard_Output(&quot;&quot;);
			this.killModelview(); break;
		case &#39;CABAL_COMMON_KEYBOARDZ&#39;:
			if(this.keyboard.toCall) worldScripts[this.keyboard.toCall].Cabal_Common_Keyboard_Output(this.keyboard.input);
			this.killModelview(); break;
	}
	return;
};
this.keyboardShow = function()
{
	this.keyboard.keyboardSound.play();
	if(this.keyboard.input.length&lt;this.keyboard.toMin){
		if(this.keyboard.overlay) mission.runScreen({title:&quot;Terminal&quot;,choicesKey:&#39;CABAL_COMMON_KEYBOARD_A&#39;,model:this.keyboard.model,spinModel:false,background:this.keyboard.pic,overlay:this.keyboard.overlay},this.keyboardEval);
		else mission.runScreen({title:&quot;Terminal&quot;,choicesKey:&#39;CABAL_COMMON_KEYBOARD_A&#39;,model:this.keyboard.model,spinModel:false,background:this.keyboard.pic},this.keyboardEval);
	} else {
		if(this.keyboard.overlay) mission.runScreen({title:&quot;Terminal&quot;,choicesKey:&#39;CABAL_COMMON_KEYBOARD_B&#39;,model:this.keyboard.model,spinModel:false,background:this.keyboard.pic,overlay:this.keyboard.overlay},this.keyboardEval);
		else mission.runScreen({title:&quot;Terminal&quot;,choicesKey:&#39;CABAL_COMMON_KEYBOARD_B&#39;,model:this.keyboard.model,spinModel:false,background:this.keyboard.pic},this.keyboardEval);
	}
	this.keyboard.modelSC = mission.displayModel;
	this.keyboard.modelSC.orientation = [1,-1,0,0]; // Makes the model invisible
	if(this.keyboard.ini){
		this.keyboard.modelSC.position = [this.keyboard.rowsX[this.keyboard.Y][4]*this.keyboard.ratioX,this.keyboard.rowsY[this.keyboard.Y]*this.keyboard.ratioY,500];
		delete this.keyboard.ini;
	} else this.keyboard.modelSC.position = [this.keyboard.rowsX[this.keyboard.Y][this.keyboard.X]*this.keyboard.ratioX,this.keyboard.rowsY[this.keyboard.Y]*this.keyboard.ratioY,500];
	mission.addMessageText(&quot;\n    User input: &quot;+this.keyboard.input+&quot;\n\n\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\f\fMinimum length: &quot;+this.keyboard.toMin+&quot; signs.&quot;);
	this.keyboard.modelSC.lightsActive = true;
	return;
};
this.killModelview = this.shipWillLaunchFromStation = function()
{
	if(this.keyboard) delete this.keyboard;
	return;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_MissionHandling.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_MissionHandling&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Coordinate mission offerings based on system descriptions.&quot;;
this.version = &quot;1.7&quot;;

this.mPool = [];
this.startUp = function()
{
	delete this.startUp;
	this.helper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
	this.binSearch = new worldScripts.Cabal_Common_Functions.Cabal_Common_BinSearch();
	this.checked = false;
	this.runningMission = false;
	this.logging = false;
};
this.prepare = function()
{
	var s = [],r = this.mPool.length;
	if(r){
		var merged = [],pos=0;
		for(var m=0;m&lt;r;m++){
			s = this.mPool[m];
			if(s.length!==2 || !s[1].name || typeof(s[1].name)!==&#39;string&#39; || !s[1].func || typeof(s[1].func)!==&#39;string&#39;) continue;
			if(s[1].hasOwnProperty(&quot;incOXP&quot;)){
				var temp = s[1].incOXP;
				for(var i=0;i&lt;temp.length;i++){
					if(worldScripts[temp[i]]!==&#39;undefined&#39;){
						log(this.name,&quot;Dropping token &quot;+s[0]+&quot; : &quot;+s[1].name+&quot;.&quot;+s[1].func+&quot; because of incompatibility with &quot;+temp[i]+&quot;.&quot;);
						continue;
					}
				}
			}
			if(!s[1].hasOwnProperty(&quot;mutalEx&quot;) || typeof(s[1].mutalEx)!==&#39;number&#39;) s[1].mutalEx = 0;
			pos = merged.indexOf(s[0]);
			if(pos===-1) merged.push(s[0],{0:s[1]});
			else {
				var q = merged[pos+1];
				for(var p=1;p&lt;10;p++){
					if(q.hasOwnProperty(p)) continue;
					q[p] = s[1];
					break;
				}
			}
		}
		r = merged.length;
		for(var i=0;i&lt;r;i+=2){
			this.binSearch.add(merged[i],merged[i+1]);
		}
		if(this.logging) log(this.name,&quot;merged: &quot;+JSON.stringify(merged));
	} else {
		delete this.performCheck;
		delete this.shipWillExitWitchspace;
		delete this.shipWillLaunchFromStation;
		this.checked = true;
	}
	delete this.alertConditionChanged;
	delete this.guiScreenChanged;
	delete this.prepare;
	return;
};
this.performCheck = function(early)
{
	this.checked = true;
	if(this.runningMission) return;
	var test = system.description,prop;
	var pRand = this.helper.pseudoRand(system.ID,true);
	var rest = test.replace(/[^a-zA-Z]/g,&#39; &#39;);
	rest = rest.split(&quot; &quot;);
	rest = this.helper.arrUnique(rest);
	var fflag = false, l = rest.length, muteGroup = [];
	for(var s=0;s&lt;l;s++){
		fflag = this.binSearch.contains(rest[s]);
		if(fflag &amp;&amp; typeof(fflag)!==&#39;false&#39;){
			for(prop in fflag){
				var c = fflag[prop];
				if((early &amp;&amp; !c.early) || (!early &amp;&amp; c.early)) continue;
				if(muteGroup.indexOf(c.mutalEx)!==-1) continue;
				if(c.chance &amp;&amp; Math.random()&gt;c.chance) continue;
				if(c.gal &amp;&amp; c.gal.indexOf(galaxyNumber)===-1) continue;
				if(c.ID &amp;&amp; c.ID.indexOf(system.ID)===-1) continue;
				if(c.gov &amp;&amp; c.gov.indexOf(system.government)===-1) continue;
				if(c.seeds &amp;&amp; c.seeds.indexOf(pRand)===-1) continue;
				if(c.exToken &amp;&amp; rest.indexOf(c.exToken)!==-1) continue;
				if(this.logging) log(this.name,&quot;check: &quot;+c.name+&quot; - muteGroup: &quot;+c.mutalEx+&quot; rest[s]:&quot;+rest[s]);
				if(worldScripts[c.name]){
					var act = false;
					if(c.func &amp;&amp; worldScripts[c.name][c.func]) act = worldScripts[c.name][c.func](rest[s]);
					if(act){
						muteGroup.push(c.mutalEx);
						this.runningMission = true;
					}
				}
			}
		}
	}
	return;
};
this.alertConditionChanged = this.guiScreenChanged = function()
{
	if(this.prepare) this.prepare();
	if(!this.checked &amp;&amp; this.performCheck) this.performCheck();
};
this.shipWillExitWitchspace = function()
{
	this.runningMission = false;
	if(this.performCheck) this.performCheck(1);
};
this.shipExitedWitchspace = function()
{
	if(this.performCheck) this.performCheck();
};
this.shipWillLaunchFromStation = function()
{
	if(this.prepare) this.prepare();
	if(!this.checked &amp;&amp; this.performCheck) this.performCheck(1);
};
this.shipLaunchedFromStation = function()
{
	if(!this.checked &amp;&amp; this.performCheck) this.performCheck();
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Music.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Music&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Music helper for missions&quot;;
this.version = &quot;1.7&quot;;

this.startUp = function()
{
	delete this.startUp;
	this.helper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
	this.mediaFade = new SoundSource();
	this.mediaFade.sound = &quot;[cabal_common_music_fade1]&quot;;
	this.mediaQueue = null;
	this.mediaPool = {
		allListed:[],
		aegis:{enter:[],exit:[]},
		alert:{red:[],yellow:[],green:[]},
		destroyed:{ent:[]},
		exitWS:{inter:[],goneNova:[],doNova:[],standard:[],any:[]},
		launch:{ent:[],inter:[],goneNova:[],doNova:[],main:[],any:[]},
		planet:{ent:[],enterMain:[],enterSun:[],exitMain:[],exitSun:[]},
		scooped:{ent:[],fuel:[]},
		track:{byName:[],byRole:[]}
	};
	this.currentFile = null;
	this.currentTrack = null;
	this.requestHandlerSet = [];
	this.blockAlert = 1;
	this.blockPlanet = 1;
	this.blockFuel = 1;
	var handler = Object.keys(this.mediaPool);
	handler.shift();
	for(var i=0;i&lt;handler.length;i++){
		var c = Object.keys(this.mediaPool[handler[i]]);
		c.unshift(handler[i]);
		this.requestHandlerSet.push(c);
	}
};
// Register events
this.addMedia = function(obj)
{
	if(this.startUp) this.startUp();
	if(!obj || !Object.isExtensible(obj) || !obj.who || !worldScripts[obj.who] || !obj.hasOwnProperty(&quot;start&quot;)) return(false);
	var pid = -1;
	if(this.mediaPool.allListed.length){
		for(var i=0;i&lt;this.mediaPool.allListed.length;i++){
			if(obj.who===this.mediaPool.allListed[i][0]){
				pid = i;
				break;
			}
		}
	}
	if(pid===-1){
		pid = this.mediaPool.allListed.length;
		this.mediaPool.allListed.push([obj.who,obj.start]);
	}
	for(var handler in this.mediaPool){
		if(handler===&quot;allListed&quot;) continue;
		if(obj.hasOwnProperty(handler)){
			for(var what in this.mediaPool[handler]){
				if(obj[handler].hasOwnProperty(what)){
					var cur = obj[handler][what];
					for(var i=0;i&lt;cur.length;i++){
						cur[i].sid = pid;
						this.mediaPool[handler][what].push(cur[i]);
					}
				}
			}
		}
	}
	if(!player.ship.docked) this.checkTrack();
	return(true);
};
// Unregister events
this.removeMedia = function(who)
{
	if(!who) return(false);
	var pid;
	for(var i=0;i&lt;this.mediaPool.allListed.length;i++){
		if(who===this.mediaPool.allListed[i][0]){
			pid = i;
			this.mediaPool.allListed = this.helper.arrRemoveByValue(this.mediaPool.allListed,this.mediaPool.allListed[pid]);
			break;
		}
	}
	if(typeof(pid)===&quot;undefined&quot;) return(false);
	for(var handler in this.mediaPool){
		if(handler===&quot;allListed&quot;) continue;
		for(var what in this.mediaPool[handler]){
			for(var i=0;i&lt;this.mediaPool[handler][what].length;i++){
				if(this.mediaPool[handler][what][i].sid===pid){
					this.mediaPool[handler][what] = this.helper.arrRemoveByValue(this.mediaPool[handler][what],this.mediaPool[handler][what][i]);
					if(i&gt;-1) i--;
				} else if(this.mediaPool[handler][what][i].sid&gt;pid) this.mediaPool[handler][what][i].sid--;
			}
		}
	}
	return(true);
};
// Change status flag
this.changeStatus = function(who,status)
{
	for(var i=0;i&lt;this.mediaPool.allListed.length;i++){
		if(who===this.mediaPool.allListed[i][0]){
			this.mediaPool.allListed[i][1] = status;
			if(!player.ship.docked) this.checkTrack();
			return(true);
		}
	}
	return(false);
};
this.cclm_findActive = function(element){return(this.mediaPool.allListed[element.sid][1]);};
this.performMedia = function(handler,specifier,followup)
{
	var cur,found=false;
	// Handle ent + followup
	if(followup &amp;&amp; this.mediaPool[handler].hasOwnProperty(&quot;ent&quot;)){
		cur = this.mediaPool[handler].ent.filter(this.cclm_findActive,this);
		if(cur.length) found = this.loopChecks(cur,followup);
		if(found &amp;&amp; (handler===&quot;aegis&quot; || handler===&quot;planet&quot;)) this.blockPlanet = clock.absoluteSeconds+10;
		return;
	}
	// Handle standard specifier
	if(!found){
		cur = this.mediaPool[handler][specifier].filter(this.cclm_findActive,this);
		if(cur.length) found = this.loopChecks(cur);
		if(found &amp;&amp; handler===&quot;scooped&quot; &amp;&amp; specifier===&quot;fuel&quot;) this.blockFuel = clock.absoluteSeconds+10;
		if(!found){
			// Handle - any
			if(this.mediaPool[handler].hasOwnProperty(&quot;any&quot;)){
				cur = this.mediaPool[handler].any.filter(this.cclm_findActive,this);
				if(!cur.length) return;
				found = this.loopChecks(cur);
			}
		}
	}
	if(found &amp;&amp; (handler===&quot;aegis&quot; || handler===&quot;planet&quot;)) this.blockPlanet = clock.absoluteSeconds+10;
	this.blockAlert = clock.absoluteSeconds;
	return;
};
this.isClose = function(entity)
{
	return(entity.isShip &amp;&amp; entity.isValid);
};
this.performTracker = function()
{
	if(!player.ship.isValid){
		this.trackerTimer.stop();
		return;
	}
	var ents = system.filteredEntities(this,this.isClose,player.ship,25600);
	var cur = this.mediaPool.track.byName.filter(this.cclm_findActive,this),disable = true;
	for(var i=0;i&lt;cur.length;i++){
		var sub = cur[i];
		if(!this.mediaPool.allListed[sub.sid][1]) continue;
		disable = false;
		var ws = this.mediaPool.allListed[sub.sid][0];
		if(sub.hasOwnProperty(&quot;prop&quot;) &amp;&amp; !worldScripts[ws][sub.prop]) continue;
		for(var e=0;e&lt;ents.length;e++){
			if(sub.ent!==ents[e].name || sub.ent===this.currentTrack) continue;
			if(sub.dist&lt;player.ship.position.distanceTo(ents[e].position)) continue;
			if(sub.fadeQ){
				this.mediaFade.sound = &quot;[cabal_common_music_fade&quot;+sub.fadeQ+&quot;]&quot;;
				this.mediaFade.play();
			}
			var cl = 1, bp = 0, rp = 0, nq = 0;
			if(sub.bypassQ){
				bp = sub.bypassQ;
				cl = 0;
			}
			if(sub.leaveQ) cl = 0;
			if(sub.onlyRepQ) rp = 1;
			if(sub.forceQ) nq = 1;
			this.runMedia(sub.music,cl,bp,rp,nq);
			this.currentTrack = sub.ent;
			return(true);
		}
	}
	// If all OXPs are off stop - re-enabling via changeStatus
	if(disable){
		this.trackerTimer.stop();
		delete this.trackerTimer;
	}
	return(false);
};
this.loopChecks = function(cur,followup)
{
	for(var i=0;i&lt;cur.length;i++){
		var sub = cur[i];
		if(!this.mediaPool.allListed[sub.sid][1]) continue;
		var ws = this.mediaPool.allListed[sub.sid][0];
		if(sub.hasOwnProperty(&quot;prop&quot;) &amp;&amp; !worldScripts[ws][sub.prop]) continue;
		if(followup &amp;&amp; followup!==sub.ent) continue;
		if(sub.fadeQ){
			this.mediaFade.sound = &quot;[cabal_common_music_fade&quot;+sub.fadeQ+&quot;]&quot;;
			this.mediaFade.play();
		}
		var cl = 1, bp = 0, rp = 0, nq = 0;
		if(sub.bypassQ){
			bp = sub.bypassQ;
			cl = 0;
		}
		if(sub.leaveQ) cl = 0;
		if(sub.onlyRepQ) rp = 1;
		if(sub.forceQ) nq = 1;
		this.runMedia(sub.music,cl,bp,rp,nq);
		return(true);
	}
	return(false)
};
this.runMedia = function(list,clear,bypass,replace,force)
{
	if(typeof(list)===&quot;string&quot;){
		Sound.playMusic(list);
		this.currentFile = list;
		if(clear) this.mediaQueue = null;
		else if(bypass){
			if(this.mediaTimer){
				if(this.mediaTimer.isRunning){
					this.mediaTimer.stop();
					this.mediaTimer.nextTime = clock.absoluteSeconds+bypass;
					this.mediaTimer.start();
				}
			}
		}
	} else {
		var flag=false;
		if((replace &amp;&amp; !this.mediaQueue) || force) flag=true;
		this.mediaQueue = list;
		if(flag){
			if(force) this.doMediaTimer(1);
			else if(replace) this.doMediaTimer();
		}
	}
	return;
};
this.doMediaTimer = function(force)
{
	if(this.mediaTimer){
		if(this.mediaTimer.isRunning) this.mediaTimer.stop();
		delete this.mediaTimer;
	}
	if(!this.mediaQueue) return;
	var entry = 0;
	if(!force) entry = Math.floor(Math.random()*this.mediaQueue.length);
	var dura = this.mediaQueue[entry].duration;
	var rep = this.mediaQueue[entry].repeat;
	var delay = (dura+1)*(rep?rep:1);
	Sound.playMusic(this.mediaQueue[entry].file,rep);
	this.currentFile = this.mediaQueue[entry].file;
	this.mediaTimer = new Timer(this,this.doMediaTimer,delay);
	return;
};
this.shipWillDockWithStation = this.shipWillEnterWitchspace = this.shipDied = function()
{
	if(this.mediaTimer){
		if(this.mediaTimer.isRunning) this.mediaTimer.stop();
		delete this.mediaTimer;
	}
	if(this.trackerTimer){
		if(this.trackerTimer.isRunning) this.trackerTimer.stop();
		delete this.trackerTimer;
	}
	this.mediaQueue = null;
	this.currentTrack = null;
	this.currentFile = null;
};
this.shipWillLaunchFromStation = this.shipWillExitWitchspace = function()
{
	this.checkTrack();
};
this.shipTargetLost = function(target)
{
	if(!player.ship.isValid) return;
	if(target &amp;&amp; target.name &amp;&amp; target.name===this.currentTrack &amp;&amp; target.position.distanceTo(player.ship)&gt;25600) this.currentTrack = null;
};
this.checkTrack = function()
{
	if(!this.trackerTimer &amp;&amp; this.mediaPool.track.byName.filter(this.cclm_findActive,this).length) this.trackerTimer = new Timer(this,this.performTracker,0,10);
	return;
};
this.alertConditionChanged = function(to)
{
	if(!player.ship.isValid || player.ship.status!==&quot;STATUS_IN_FLIGHT&quot;) return;
	switch(to){
		case 3: this.performMedia(&quot;alert&quot;,&quot;red&quot;); break;
		case 2: if(clock.absoluteSeconds&gt;this.blockAlert) this.performMedia(&quot;alert&quot;,&quot;yellow&quot;); break;
		case 1: if(clock.absoluteSeconds&gt;this.blockAlert) this.performMedia(&quot;alert&quot;,&quot;green&quot;); break;
	}
	this.blockAlert = clock.absoluteSeconds+10;
};
this.shipEnteredPlanetaryVicinity = function(planet)
{
	if(!player.ship.isValid || !planet || clock.absoluteSeconds&lt;this.blockPlanet) return;
	if(planet.isMainPlanet) this.performMedia(&quot;planet&quot;,&quot;enterMain&quot;);
	else if(planet.isSun) this.performMedia(&quot;planet&quot;,&quot;enterSun&quot;);
	else this.performMedia(&quot;planet&quot;,&quot;ent&quot;,planet.radius);
};
this.shipEnteredStationAegis = function(station)
{
	if(!player.ship.isValid || !station || clock.absoluteSeconds&lt;this.blockPlanet) return;
	this.performMedia(&quot;aegis&quot;,&quot;enter&quot;);
};
this.shipExitedPlanetaryVicinity = function(planet)
{
	if(!player.ship.isValid || !planet || clock.absoluteSeconds&lt;this.blockPlanet) return;
	if(planet.isMainPlanet) this.performMedia(&quot;planet&quot;,&quot;exitMain&quot;);
	if(planet.isSun) this.performMedia(&quot;planet&quot;,&quot;exitSun&quot;);
};
this.shipExitedStationAegis = function(station)
{
	if(!player.ship.isValid || !station || clock.absoluteSeconds&lt;this.blockPlanet) return;
	this.performMedia(&quot;aegis&quot;,&quot;exit&quot;);
};
this.shipExitedWitchspace = function()
{
	if(!player.ship.isValid) return;
	if(system.isInterstellarSpace) this.performMedia(&quot;exitWS&quot;,&quot;inter&quot;);
	else if(system.sun.hasGoneNova) this.performMedia(&quot;exitWS&quot;,&quot;goneNova&quot;);
	else if(system.sun.isGoingNova) this.performMedia(&quot;exitWS&quot;,&quot;doNova&quot;);
	else this.performMedia(&quot;exitWS&quot;,&quot;standard&quot;);
	this.checkTrack();
};
this.shipLaunchedFromStation = function(station)
{
	if(!player.ship.isValid || !station) return;
	if(station.isMainStation) this.performMedia(&quot;launch&quot;,&quot;main&quot;);
	else this.performMedia(&quot;launch&quot;,&quot;ent&quot;,station.name);
};
this.shipScoopedOther = function(whom)
{
	if(!player.ship.isValid || !whom || !whom.name) return;
	this.performMedia(&quot;scooped&quot;,&quot;ent&quot;,whom.name);
};
this.shipScoopedFuel = function()
{
	if(!player.ship.isValid || clock.absoluteSeconds&lt;this.blockFuel) return;
	this.performMedia(&quot;scooped&quot;,&quot;fuel&quot;);
};
this.shipTargetDestroyed = function(target)
{
	if(!player.ship.isValid || !target || !target.name) return;
	this.performMedia(&quot;destroyed&quot;,&quot;ent&quot;,target.name);
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_OXPStrength.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_OXPStrength&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Checks and/or cleans out entities and suspends OXPs.&quot;;
this.version = &quot;1.7.1&quot;;

this.ccl_strengthExclEntByName = []; // Array of entity names to be excluded
this.startUp = function()
{
	delete this.startUp; // PhantorGorth&#39; chain handling
	this.checkOXPStrength = new this.Cabal_Common_OXPStrengthAPI(); // Get instance
	this.helper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
	this.gJump = false; // Flag for galactic jump
	this.current = null; // Holds current settings object or null
	this.watchLocations = [[],[],[],[],[],[],[],[]]; // Storage for settings splitted in galaxies to keep loops small
	this.resetValues(); // Default settings
	this.leftSystem = system.ID; // For interstellar checks
	this.suspendedOXPs = []; // Holds suspended OXPs
	for(var w in worldScripts){
		if(!w) continue;
		var s = worldScripts[w];
		if(!s) continue;
		for(var prop in s){
			var p = s[prop];
			if(!prop || !p) continue;
			if(typeof(p)===&quot;function&quot;){
				var temp = p.toString();
				if(temp.search(/restoreSubEntities/gi)!==-1) this.checkOXPStrength.wayoff.push(w.toLowerCase());
				if(temp.search(/EQ_RENOVATION/gi)!==-1) this.checkOXPStrength.wayoff.push(w.toLowerCase());
			}
		}
	}
};
this.guiScreenChanged = this.alertConditionChanged = this.missionScreenOpportunity = function()
{
	delete this.guiScreenChanged;
	delete this.alertConditionChanged;
	delete this.missionScreenOpportunity;
	// Excluded entities?
	if(this.ccl_strengthExclEntByName.length){
		for(var i=0;i&lt;this.ccl_strengthExclEntByName.length;i++){
			if(typeof(this.ccl_strengthExclEntByName[i])===&quot;string&quot;) this.checkOXPStrength.binAdd(this.ccl_strengthExclEntByName[i],true);
			else {
				for(var j=0;j&lt;this.ccl_strengthExclEntByName[i].length;j++){
					this.checkOXPStrength.binAdd(this.ccl_strengthExclEntByName[i][j],true);
				}
			}
		}
	}
	this.checkWatchLocations(system.ID,false);
};
// Interface for other OXPS to register settings
this.registerLocation = function(obj)
{
	if(obj &amp;&amp; obj.hasOwnProperty(&quot;Gal&quot;) &amp;&amp; obj.hasOwnProperty(&quot;ID&quot;) &amp;&amp; obj.hasOwnProperty(&quot;ISS&quot;) &amp;&amp; obj.CSS &amp;&amp; obj.CSP){
		this.watchLocations[obj.Gal].push(obj);
		return(true);
	}
	return(false);
};
// Oktis approach - callback
this.suspendOXP = function()
{
	if(this.current &amp;&amp; this.suspendedOXPs.length) return(true);
	return(false);
};
this.playerWillSaveGame = function()
{
	this.tempS = missionVariables.CCL_OXPStrength;
	missionVariables.CCL_OXPStrength = 9; //Save only default
	this.guiScreenChanged = function(){
		missionVariables.CCL_OXPStrength = this.tempS;
		delete this.guiScreenChanged;
	}
};
// Defaults
this.resetValues = function(full)
{
	this.checkOXPStrength.checkCoef = 999999; // Minimum coef
	this.checkOXPStrength.checkKill = 999999; // Minimum coef for removing
	this.checkOXPStrength.logIt = false; // Logging flag
	this.checkOXPStrength.checkLocation = 0; // Location to be checked
	missionVariables.CCL_OXPStrength = 9; // For conditions in shipdata
	this.current = null;
	if(full) this.suspendedOXPs = [];
	return;
};
this.playerStartedJumpCountdown = function(jump)
{
	if(jump===&quot;galactic&quot;) this.gJump = true;
};
this.playerCancelledJumpCountdown = this.playerJumpFailed = function()
{
	this.gJump = false;
};
// Interstellar and normal space checks
this.shipWillExitWitchspace = this.shipWillLaunchFromStation = function()
{
	this.gJump = false;
	if(system.isInterstellarSpace) this.checkWatchLocations(this.leftSystem,true);
	else this.checkWatchLocations(system.ID,false);
	if(this.current) this.startCleaning(this.current);
	else this.resetValues(1);
};
// Reset and prepare next checks. MV has to be set before jumping to prevent spawning by populator
this.shipWillEnterWitchspace = function()
{
	if(this.repeatTimer){
		this.repeatTimer.stop();
		delete this.repeatTimer;
	}
	this.leftSystem = system.ID;
	if(this.current &amp;&amp; !this.current.Permanent) this.watchLocations[galaxyNumber] = this.checkOXPStrength.arrRemoveByValue(this.watchLocations[galaxyNumber],this.current);
	this.resetValues();
	if(!this.gJump){
		if(player.ship.scriptedMisjump) this.checkWatchLocations(this.leftSystem,true);
		else this.checkWatchLocations(player.ship.targetSystem,false);
		this.current = null;
	} else {
		var loc = player.ship.galacticHyperspaceFixedCoordsInLY.toArray(); // Rounding!!!
		for(var r=0;r&lt;3;r++){
			loc[r] = parseFloat(loc[r].toFixed(1));
		}
		this.checkWatchLocations(loc,false);
	}
};
// Check if it should be activated
this.checkWatchLocations = function(ID,ISS)
{
	var c=[],temp;
	// Grab subset
	if(this.gJump){
		if(galaxyNumber&lt;7) c = this.watchLocations[galaxyNumber+1];
		else c = this.watchLocations[0];
	} else c = this.watchLocations[galaxyNumber];
	for(var i=0;i&lt;c.length;i++){
		if(c[i].ID===ID || (this.gJump &amp;&amp; c[i].GJump &amp;&amp; c[i].GJump[0]===ID[0] &amp;&amp; c[i].GJump[1]===ID[1])){
			temp = null;
			if(c[i].CSS &amp;&amp; c[i].CSP &amp;&amp; !worldScripts[c[i].CSS][c[i].CSP]) continue; // Check status
			if((system.isInterstellarSpace || player.ship.scriptedMisjump) &amp;&amp; ISS &amp;&amp; c[i].ISS) temp = c[i];
			else if(!system.isInterstellarSpace &amp;&amp; !player.ship.scriptedMisjump &amp;&amp; !ISS &amp;&amp; !c[i].ISS) temp = c[i];
			else if(system.isInterstellarSpace &amp;&amp; !player.ship.scriptedMisjump &amp;&amp; !ISS &amp;&amp; !c[i].ISS) temp = c[i];
			if(temp){
				if(!this.current) this.current = temp;
				else {
					if(temp.Strength &amp;&amp; temp.Strength&lt;this.current.Strength || !this.current.hasOwnProperty(&quot;Strength&quot;)) this.current.Strength = temp.Strength;
					if(temp.checkC &amp;&amp; temp.checkC&lt;this.current.checkC || !this.current.hasOwnProperty(&quot;checkC&quot;)) this.current.checkC = temp.checkC;
					if(temp.checkK &amp;&amp; temp.checkK&lt;this.current.checkK || !this.current.hasOwnProperty(&quot;checkK&quot;)) this.current.checkK = temp.checkK;
					if(temp.delay &amp;&amp; temp.delay&lt;this.current.delay || !this.current.hasOwnProperty(&quot;delay&quot;)) this.current.delay = temp.delay;
					if(temp.repeat &amp;&amp; temp.repeat&gt;this.current.repeat || !this.current.hasOwnProperty(&quot;repeat&quot;)) this.current.repeat = temp.repeat;
					if(temp.locate &amp;&amp; temp.locate!==this.current.locate || !this.current.hasOwnProperty(&quot;locate&quot;)) this.current.locate = 0;
					if(temp.logging &amp;&amp; !this.current.logging) this.current.logging = 1;
					if(temp.Suspend) this.current.Suspend = this.suspendedOXPs.concat(temp.Suspend);
				}
			}
		}
	}
	if(this.current){
		if(this.current.Strength) missionVariables.CCL_OXPStrength = this.current.Strength; // Set mV for strength
		if(this.current.Suspend &amp;&amp; this.current.Suspend.length){
			for(var s=0;s&lt;this.current.Suspend.length;s++){
				c = this.current.Suspend[s];
				if(this.suspendedOXPs.indexOf(c)!==-1) continue;
				if(worldScripts[c] &amp;&amp; worldScripts[c].addToCallbacks){
					worldScripts[c].addToCallbacks({worldScript:this.name,callBack:&quot;suspendOXP&quot;});
					this.suspendedOXPs.push(this.current.Suspend[s]);
				}
			}
		}
	} else {
		if(this.infoTimer){this.infoTimer.stop(); delete this.infoTimer;}
		if(this.repeatTimer){this.repeatTimer.stop(); delete this.repeatTimer;}
		if(this.suspendedOXPs.length){
			for(var s=0;s&lt;this.suspendedOXPs.length;s++){
				c = this.suspendedOXPs[s];
				if(worldScripts[c] &amp;&amp; worldScripts[c].removeFromCallbacks){
					worldScripts[c].removeFromCallbacks({worldScript:this.name,callBack:&quot;suspendOXP&quot;});
				}
			}
			this.suspendedOXPs = [];
		}
	}
	return;
};
// Set cleaning params
this.startCleaning = function(obj)
{
	if(!obj.checkC) return;
	else {
		this.checkOXPStrength.checkCoef = obj.checkC;
		if(obj.checkK) this.checkOXPStrength.checkKill = obj.checkK;
	}
	if(obj.logging) this.checkOXPStrength.logIt = obj.logging;
	// One shot timer
	if(!this.infoTimer){
		if(obj.delay) this.infoTimer = new Timer(this,this.checkAll,obj.delay);
		else this.infoTimer = new Timer(this,this.checkAll,10);
	}
	if(obj.locate) this.checkOXPStrength.checkLocation = obj.locate;
	// Repeat timer
	if(obj.repeat){
		if(!this.repeatTimer){
			if(obj.delay) this.repeatTimer = new Timer(this,this.checkAll,0,10+obj.delay);
			else this.repeatTimer = new Timer(this,this.checkAll,0,10);
		}
	}
	return;
};
this.checkAll = function()
{
	if(guiScreen===&quot;GUI_SCREEN_LOAD&quot;){
		if(this.infoTimer){this.infoTimer.stop(); delete this.infoTimer;}
		if(this.repeatTimer){this.repeatTimer.stop(); delete this.repeatTimer;}
		return;
	}
	this.checkOXPStrength.checkPower();
	if(this.infoTimer){this.infoTimer.stop(); delete this.infoTimer;}
	if(this.current.repeat) this.current.repeat--;
	else if(this.repeatTimer){this.repeatTimer.stop(); delete this.repeatTimer;}
	return;
};
// API
this.Cabal_Common_OXPStrengthAPI = function(){this._cclstrength = null;}
Cabal_Common_OXPStrengthAPI.prototype = {
	// Threshold distance to MainStation, WP or the lanes WP,WS,PS
	maxDist: 50000,
	// Threshold energy
	checkE: 800,
	// Threshold speed
	checkS: 500,
	// Threshold standard missiles
	checkM: 6,
	// Threshold escorts
	checkEsc: 4,
	// Threshold for putting in list
	checkCoef: 999999,
	// Threshold for killing
	checkKill: 999999,
	// Act only for location
	checkLocation: 0,
	logIt: false,
	weapons: [&quot;EQ_WEAPON_PULSE_LASER&quot;,1,&quot;EQ_WEAPON_BEAM_LASER&quot;,3,&quot;EQ_WEAPON_MILITARY_LASER&quot;,5,&quot;EQ_WEAPON_MINING_LASER&quot;,4,&quot;EQ_WEAPON_THARGOID_LASER&quot;,8,&quot;EQ_WEAPON_TWIN_PLASMA_CANNON&quot;,4],
	smissile: [&quot;EQ_MISSILE&quot;,0,&quot;EQ_HARDENED_MISSILE&quot;,0.6,&quot;EQ_ARMOURY_STANDARD_MISSILE&quot;,0.1,&quot;EQ_ARMOURY_HARD_MISSILE&quot;,0.7,&quot;EQ_MILITARY_MISSILE&quot;,0.8,&quot;EQ_RMB_CASCADE_MISSILE&quot;,0.6,
		&quot;EQ_RMB_FRAG_MISSILE&quot;,0.4,&quot;EQ_RMB_LAW_MISSILE&quot;,0.5,&quot;EQ_RMB_THARGOID_MISSILE&quot;,0.1,&quot;EQ_RMB_INTERCEPT_MISSILE&quot;,0.3,&quot;EQ_RMB_OVERRIDE_MISSILE&quot;,0.3,&quot;EQ_HARPOON_NUKE1_MISSILE&quot;,0.7,
		&quot;EQ_HARPOON_ABM_MISSILE&quot;,0.5,&quot;EQ_MANCHI_MISSILE&quot;,0.4,&quot;EQ_VECTOR_FUNA_MISSILE&quot;,1.1,&quot;EQ_VECTOR_FUNB_MISSILE&quot;,1.1,&quot;EQ_VECTOR_FUNC_MISSILE&quot;,1.1,&quot;EQ_KILLIT_MISSILE&quot;,2.0,
		&quot;EQ_CT_MINE&quot;,1.2,&quot;EQ_ECD_MINE&quot;,1.1],
	srole: [&quot;sunskim-trader&quot;,0.6,&quot;trader&quot;,0.6,&quot;hunter&quot;,1.1,&quot;police&quot;,1.1,&quot;wingman&quot;,1.1,&quot;interceptor&quot;,1.1,&quot;pirate&quot;,1.1,&quot;blackdog&quot;,1.1,&quot;scavenger&quot;,0.3,&quot;shuttle&quot;,0.2,&quot;miner&quot;,0.2,
		&quot;hermit-ship&quot;,0.4,&quot;escort&quot;,0.9,&quot;thargoid&quot;,0.9,&quot;tharglet&quot;,0.9],
	storage: [],
	wayoff : [],
	checkSpaceLane: function(entity){
		if(system.isInterstellarSpace){
			if(this.checkLocation){
				var d = this.maxDist+1;
				return([0,d,entity.position.distanceTo(new Vector3D([0,0,0])),d,d,d]);
			} else return([-1,0,0,0,0,0]);
		}
		if(!system.sun || system.sun.isGoingNova || system.sun.hasGoneNova) return([1,0,0,0,0,0]);
		var distMS = entity.position.distanceTo(system.mainStation.position);
		var distWP = entity.position.distanceTo(new Vector3D([0,0,0]));
		var distLWP = Math.sqrt(entity.position.x*entity.position.x+entity.position.y*entity.position.y);
		var lanePS = new Vector3D(system.mainPlanet.position.subtract(system.sun.position));
		var SEV = new Vector3D(entity.position.subtract(system.sun.position));
		var distS = SEV.magnitude();
		var distLPS = distS*Math.sin(lanePS.angleTo(SEV));
		var laneWS = new Vector3D(new Vector3D([0,0,0]).subtract(system.sun.position));
		var distLWS = distS*Math.sin(laneWS.angleTo(SEV));
		if(distMS&gt;this.maxDist &amp;&amp; distWP&gt;this.maxDist &amp;&amp; distLWP&gt;this.maxDist &amp;&amp; distLPS&gt;this.maxDist &amp;&amp; distLWS&gt;this.maxDist) return([2,Math.floor(distMS),Math.floor(distWP),Math.floor(distLWP),Math.floor(distLPS),Math.floor(distLWS)]);
		return([0,Math.floor(distMS),Math.floor(distWP),Math.floor(distLWP),Math.floor(distLPS),Math.floor(distLWS)]);
	},
	checkSubs: function(entity){
		var tur=0,wea=0,slots=0,w=0,wtype=&quot;&quot;,s=0,subwtype=&quot;&quot;,temp;
		if(entity.forwardWeapon){slots++; temp = this.weapons[this.weapons.indexOf(entity.forwardWeapon.equipmentKey)+1]; wtype += &quot;&quot;+temp; w += temp;}
		if(entity.aftWeapon){slots++; temp = this.weapons[this.weapons.indexOf(entity.aftWeapon.equipmentKey)+1]; wtype += &quot;&quot;+temp; w += temp;}
		if(entity.portWeapon){slots++; temp = this.weapons[this.weapons.indexOf(entity.portWeapon.equipmentKey)+1]; wtype += &quot;&quot;+temp; w += temp;}
		if(entity.starboardWeapon){slots++; temp = this.weapons[this.weapons.indexOf(entity.starboardWeapon.equipmentKey)+1]; wtype += &quot;&quot;+temp; w += temp;}
		if(entity.isPlayer &amp;&amp; !slots){slots=4; w=32; wtype=&quot;0000&quot;;} // All null, treat as highest
		if(!entity.subEntityCapacity) return([slots,0,0,w,wtype,0,0]);
		for(var prop in entity.subEntities){
			if(entity.subEntities[prop].status===&quot;STATUS_ACTIVE&quot;) tur += 4;
			if(entity.subEntities[prop].forwardWeapon){wea++; temp = this.weapons[this.weapons.indexOf(entity.subEntities[prop].forwardWeapon.equipmentKey)+1]; subwtype += &quot;&quot;+temp; s += temp;}
			if(entity.subEntities[prop].aftWeapon){wea++; temp = this.weapons[this.weapons.indexOf(entity.subEntities[prop].aftWeapon.equipmentKey)+1]; subwtype += &quot;&quot;+temp; s += temp;}
			if(entity.subEntities[prop].portWeapon){wea++; temp = this.weapons[this.weapons.indexOf(entity.subEntities[prop].portWeapon.equipmentKey)+1]; subwtype += &quot;&quot;+temp; s += temp;}
			if(entity.subEntities[prop].starboardWeapon){wea++; temp = this.weapons[this.weapons.indexOf(entity.subEntities[prop].starboardWeapon.equipmentKey)+1]; subwtype += &quot;&quot;+temp; s += temp;}
		}
		if(!tur &amp;&amp; entity.subEntityCapacity&gt;2 &amp;&amp; entity.subEntities &amp;&amp; entity.subEntities.length&lt;3) tur = entity.subEntityCapacity*4; // no cheats
		return([slots,tur,wea,w,wtype,s,subwtype]);
	},
	checkMissiles: function(entity){
		if(!entity.missileCapacity) return(0);
		var slot,mtype=0;
		for(var prop in entity.missiles){
			if(entity.missiles[prop].equipmentKey){
				slot = this.smissile.indexOf(entity.missiles[prop].equipmentKey+1);
				if(slot===-1) mtype += 2;
				else mtype += slot;
			}
		}
		if(!mtype){
			if(entity.missileCapacity&gt;this.checkM) return([1,entity.missileCapacity]);
			else return(0);
		}
		return([(1+mtype)*entity.missileCapacity,entity.missileCapacity]);
	},
	checkRole: function(entity){
		var r = entity.primaryRole,mul=1;
		var ind = this.srole.indexOf(r);
		if(ind!==-1) mul = this.srole[ind+1];
		return(mul);
	},
	checkPower: function(p){
		if(!player.ship.isValid) return(0);
		function isBad(entity){return(entity.isShip &amp;&amp; entity.isValid &amp;&amp; (!entity.isStation || (entity.isStation &amp;&amp; !entity.isMainStation)) &amp;&amp; entity.maxEnergy&gt;this.checkE || entity.maxSpeed&gt;this.checkS || this.checkSubs(entity) || this.checkMissiles(entity) || (entity.escorts &amp;&amp; entity.escorts.length&gt;this.checkEsc));}
		var ents,temp,en,sp,wep,def,coef,mis,esc,dist,rol,bomb=false;
		this.storage = [];
		if(p){
			if(p.isPlayer) ents = [player.ship];
			else if(p.isValid) ents =[p];
			else return(0);
		} else ents = system.filteredEntities(this,isBad,player.ship);
		if(ents.length){
			for(var i=0;i&lt;ents.length;i++){
				if(!ents[i].name) continue;
				if(!p || (p &amp;&amp; !p.isPlayer)){
					var exFlag=this.binContains(ents[i].name);
					if(exFlag) continue;
				}
				en = ents[i].maxEnergy;
				if(ents[i].isStation &amp;&amp; !ents[i].maxSpeed) coef = Math.log(en);
				else {
					if(en&gt;256) en += Math.sqrt(en);
					if(p &amp;&amp; p.isPlayer){
						en += ents[i].maxAftShield*ents[i].aftShieldRechargeRate;
						en += ents[i].maxForwardShield*ents[i].forwardShieldRechargeRate;
					} else if(en&gt;800) en *= 2;
					coef = Math.sqrt(en);
				}
				sp = ents[i].maxSpeed;
				if(ents[i].equipmentStatus(&quot;EQ_FUEL_INJECTION&quot;)===&quot;EQUIPMENT_OK&quot;) sp *= 4;
				if(ents[i].isPiloted &amp;&amp; !ents[i].isStation &amp;&amp; ents[i].maxSpeed &amp;&amp; ents[i].maxThrust&gt;40) sp *= Math.log(ents[i].maxThrust);
				if(sp) coef += Math.sqrt(sp);
				else sp = 0;
				temp = this.checkSubs(ents[i]);
				if(typeof(temp)!==&quot;number&quot;){
					if(this.logIt) wep = &quot;L:&quot;+temp[0]+&quot; T:&quot;+temp[1]+&quot; S:&quot;+temp[2]+&quot; &quot;+temp[4]+&quot;,&quot;+temp[6];
					if(temp[0]) coef += Math.pow(1.4,temp[0])*Math.log(temp[3]); // Standard Laser
					if(temp[1]) coef += Math.min(Math.pow(1.4,temp[1])*2,0xfffff); // Turrets
					if(temp[2]) coef += Math.min(Math.pow(1.5,temp[2])*(2*Math.log(temp[5])),0xfffff); // Subent Laser
				} else if(this.logIt) wep = &quot;L:0 T:0 S:0 -,-&quot;;
				temp = this.checkMissiles(ents[i]);
				if(temp[0]){
					coef += Math.pow(temp[1],1.7);
					mis = temp[1];
				} else mis = 0;
				if(ents[i].escorts &amp;&amp; ents[i].escorts.length) esc = ents[i].escorts.length;
				else esc = 0;
				coef += Math.pow(esc,1.8);
				if(ents[i].isStation){
					def = ents[i].dockedDefenders;
				} else def = 0;
				coef += Math.pow(def,1.8);
				if(p &amp;&amp; p.isPlayer){
					coef *= 1.5;
					if(missionVariables.targetAutolock===&quot;TRUE&quot;) coef += 5;
					var eq = [&quot;EQ_ECM&quot;,&quot;EQ_ENERGY_BOMB&quot;,&quot;EQ_TARGET_AUTOLOCK&quot;,&quot;EQ_ENERGY_UNIT&quot;,&quot;EQ_NAVAL_ENERGY_UNIT&quot;,&quot;EQ_CLOAKING_DEVICE&quot;,&quot;EQ_QC_MINE&quot;,&quot;EQ_SHIELD_BOOSTER&quot;,&quot;EQ_NAVAL_SHIELD_BOOSTER&quot;,&quot;EQ_MILITARY_JAMMER&quot;,
						&quot;EQ_MILITARY_SCANNER_FILTER&quot;,&quot;EQ_SHIELD_ENHANCER&quot;,&quot;EQ_AMS&quot;,&quot;EQ_EEU&quot;,&quot;EQ_IRONHIDE_FORWARD&quot;,&quot;EQ_IRONHIDE_AFT&quot;,&quot;EQ_VORTEX_TURRET&quot;];
					var eqi = eq.length;
					while(eqi--){if(EquipmentInfo.infoForKey(eq[eqi])!==null &amp;&amp; player.ship.equipmentStatus(eq[eqi])===&quot;EQUIPMENT_OK&quot;) coef += 5;}
					dist = &quot;-&quot;;
					rol = 1;
				} else {
					dist = this.checkSpaceLane(ents[i]);
					if(dist[0]===0){
						if(this.checkLocation &amp;&amp; dist[this.checkLocation]&gt;this.maxDist) continue;
						if(dist[1]&lt;this.maxDist) coef *= 1.5; // Main Station
						else if(dist[2]&lt;this.maxDist) coef *= 1.5; // WP
						else if(dist[3]&lt;this.maxDist) coef *= 1.3; // Lane WP
						else if(dist[4]&lt;this.maxDist) coef *= 1.1; // Lane PS
						else if(dist[5]&lt;this.maxDist) coef *= 1.2; // Lane WS
					}
					if(dist[0]===2) coef *= 1/Math.log(dist[3]-this.maxDist);
					rol = this.checkRole(ents[i]);
					coef *= rol;
				}
				var eq = ents[i].equipment,eqpoints=1;
				for(var eqq=0;eqq&lt;eq.length;eqq++){
					var reg = eq[eqq].equipmentKey;
					var des = eq[eqq].description;
					if(reg.search(/TARGET/gi)!==-1) eqpoints *= 1.15;
					if(reg.search(/MISSILE/gi)!==-1) eqpoints *= 1.15;
					if(reg.search(/ENERGY/gi)!==-1) eqpoints *= 1.25;
					if(reg.search(/SHIELD/gi)!==-1) eqpoints *= 1.25;
					if(reg.search(/BOOST/gi)!==-1) eqpoints *= 1.4;
					if(reg.search(/NAVAL/gi)!==-1) eqpoints *= 1.4;
					if(reg.search(/TURRET/gi)!==-1) eqpoints *= 1.5;
					if(des.search(/ARMOUR/gi)!==-1) eqpoints *= 1.5;
					if(reg.search(/LASER/gi)!==-1 || des.search(/LASER/gi)!==-1) coef *= 2.5;
					if(reg.search(/LAZER/gi)!==-1 || des.search(/LAZER/gi)!==-1) coef *= 2.5;
				}
				coef += eqpoints;
				if(ents[i].equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;)===&quot;EQUIPMENT_OK&quot;) coef *= 1.3;
				if(ents[i].equipmentStatus(&quot;EQ_MILITARY_JAMMER&quot;)===&quot;EQUIPMENT_OK&quot;) coef *= 1.5;
				if(ents[i].equipmentStatus(&quot;EQ_MILITARY_SCANNER_FILTER&quot;)===&quot;EQUIPMENT_OK&quot;) coef *= 1.5;
				coef = Math.floor(coef);
				if(coef&gt;this.checkCoef){
					if(this.logIt) this.storage.push(&quot;COEF:&quot;+this.pad(coef,6)+&quot; E:&quot;+this.pad(en,7)+&quot; : S:&quot;+this.pad(sp,5)+&quot; : C:&quot;+ents[i].scanClass+&quot; : &quot;+ents[i].name+&quot; (&quot;+ents[i].primaryRole+&quot;) : W:&quot;+wep+&quot; : M:&quot;+mis+&quot; : Esc:&quot;+esc+&quot; : Def:&quot;+def+&quot; : dist:&quot;+dist+&quot; : roleMul:&quot;+rol);
					if(!p &amp;&amp; coef&gt;this.checkKill &amp;&amp; ents[i].isValid){
						if(ents[i].scriptInfo &amp;&amp; ents[i].scriptInfo.ccl_missionShip===&quot;true&quot;) continue;
						if(ents[i].script &amp;&amp; ents[i].script.ccl_missionShip) continue;
						if(ents[i].AI &amp;&amp; ents[i].AI===&quot;cabal_common_leaveHotspotAI.plist&quot;) continue;
						if(ents[i].isMainStation || (ents[i].isStation &amp;&amp; !ents[i].distanceTravelled)) continue;
						var custSc = false;
						if(!ents[i].script || (ents[i].script &amp;&amp; (ents[i].script.hasOwnProperty(&quot;shipRemoved&quot;) || ents[i].script.hasOwnProperty(&quot;entityDestroyed&quot;)))) custSc = true;
						if(ents[i].status!==&quot;STATUS_IN_FLIGHT&quot;) continue; // Avoid early calls resulting in undefined properties
						var rDist = ents[i].position.distanceTo(player.ship.position);
						if(rDist&gt;Math.pow(ents[i].collisionRadius,2) &amp;&amp; rDist&gt;25600){
							if(ents[i].escorts &amp;&amp; ents[i].escorts.length){
								var es = ents[i].escorts.length;
								while(es--){
									if(!ents[i].escorts[es].isValid) continue;
									if(!ents[i].escorts[es].script || ents[i].escorts[es].script.hasOwnProperty(&quot;shipRemoved&quot;) || ents[i].escorts[es].script.hasOwnProperty(&quot;entityDestroyed&quot;)) ents[i].escorts[es].remove(true);
									else ents[i].escorts[es].remove();
								}
							}
							if(custSc) ents[i].remove(true);
							else ents[i].remove();
							if(this.logIt) log(&quot;KILL&quot;,&quot;Kill: &quot;+ents[i].name);
						} else {
							if(rDist&gt;3000){
								if(this.logIt) log(&quot;KILL&quot;,&quot;Bomb: &quot;+ents[i].name);
								if(!bomb){
									ents[i].spawn(&quot;cabal_common_oxps_mine&quot;,2);
									bomb = true;
								} else ents[i].spawn(&quot;cabal_common_oxps_minesub&quot;,2);
								if(custSc) ents[i].remove(true);
								else ents[i].remove();
							} else {
								if(ents[i].maxSpeed&gt;100){
									ents[i].setScript(&quot;oolite-default-ship-script.js&quot;);
									ents[i].switchAI(&quot;cabal_common_leaveHotspotAI.plist&quot;);
									if(this.logIt) log(&quot;KILL&quot;,&quot;Switching Script/AI for: &quot;+ents[i].name);
								} else if(this.logIt) log(&quot;KILL&quot;,&quot;Not possible. Player close to: &quot;+ents[i].name);
							}
						}
					}
				}
			}
		}
		if(!p){
			if(this.logIt){
				if(system.isInterstellarSpace) log(&quot;Check&quot;,&quot;System: Interstellar.&quot;);
				else log(&quot;Check&quot;,&quot;System: &quot;+system.name+&quot; ID:&quot;+system.ID+&quot; Gov:&quot;+system.government+&quot; Eco:&quot;+system.economy);
				log(&quot;Check&quot;,&quot;COEF=coefficient, E=energy, S=speed, C=scanClass, name(role), W=weapons (Lasers,Turrets,SubentLaser), M=missiles, Esc=escorts, Def=Defenders, dist=distance Station,WP,Lanes(WP,WS,PS), roleMul:multiplier.&quot;);
				var list = this.storage.sort();
				for(var i=0;i&lt;list.length;i++){log(&quot;Check&quot;,list[i]);}
			}
		} else {
			var boo = player.ship.name.toLowerCase();
			if(this.wayoff.length){
				var patt1 = new RegExp(boo);
				for(var i=0;i&lt;this.wayoff.length;i++){
					if(patt1.test(this.wayoff[i])) coef *= 2;
				}
			}
			if(this.logIt){
				if(p.isPlayer) log(&quot;Check&quot;,&quot;Playership checked in with coef: &quot;+coef);
				else log(&quot;Check&quot;,&quot;Entity &quot;+p.name+&quot; checked in with coef: &quot;+coef);
				log(&quot;Check&quot;,&quot;COEF=coefficient, E=energy, S=speed, C=scanClass, name(role), W=weapons (Lasers,Turrets,SubentLaser), M=missiles, Esc=escorts, Def=Defenders, dist=distance Station,WP,Lanes(WP,WS,PS), roleMul:multiplier.&quot;);
				log(&quot;Check&quot;,this.storage);
			}
			return(parseFloat(coef));
		}
		return(0);
	},
	pad: function(n,len){
		n = n.toFixed(0);
		var s = n.toString();
		if(s.length&lt;len) s = (&quot;0000000000&quot;+s).slice(-len);
		return s;
	},
	arrRemoveByValue: function(arr,val){
		for(var i=0;i&lt;arr.length;i++){
			if(arr[i]===val){
				arr.splice(i,1);
				break;
			}
		}
		return(arr);
	},
	binAdd: function(key,value){
		var node = {key: key,left: null,right: null, value: value},current;
		if(this._cclstrength === null) this._cclstrength = node;
		else {
			current = this._cclstrength;
			while(true){
				if(key&lt;current.key){
					if(current.left===null){current.left = node; break;}
					else current = current.left;
				} else if(key&gt;current.key){
					if(current.right===null){current.right = node; break;}
					else current = current.right;
				} else break;
			}
		}
		return;
	},
	binContains: function(key){
		var found = false,current = this._cclstrength;
		while(!found &amp;&amp; current){
			if(key&lt;current.key) current = current.left;
			else if(key&gt;current.key) current = current.right;
			else found = true;
		}
		if(!found) return (false);
		return (current.value);
	}
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_Overlay.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_Overlay&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Overlay handling&quot;;
this.version = &quot;1.7&quot;;

this.startUp = function()
{
	delete this.startUp;
	this.ovList = [[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0]];
	this.ovListObj = [[0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0],[0]];
	this.ovInstrumentPos = [[8,8,9],[6,8,9],[4,8,9],[2,8,9],[0,8,9],[-2,8,9],[-4,8,9],[-6,8,9],[-8,8,9]];
	this.ovCharacterPos = [[8,5,9],[8,3,9],[8,1,9],[8,-1,9],[8,-3,9],[-8,5,9],[-8,3,9],[-8,1,9],[-8,-1,9],[-8,-3,9]];
	this.ovDeadSpotPos = [[0,0,1]];
	this.ovPredicate = null;
	if(oolite.gameSettings.shaderEffectsLevel===&#39;SHADERS_OFF&#39; || oolite.gameSettings.shaderEffectsLevel===&#39;SHADERS_NOT_SUPPORTED&#39;) this.ovShadersOff = true;
};
this.shipWillLaunchFromStation = this.shipWillExitWitchspace = function()
{
	this.doAdd();
};
this.shipLaunchedFromStation = this.shipExitedWitchspace = function()
{
	this.cleanupTimer = new Timer(this,this.doCleanup,0,2);
};
this.shipWillDockWithStation = this.shipWillEnterWitchspace = function()
{
	if(this.cleanupTimer){this.cleanupTimer.stop(); delete this.cleanupTimer;}
	this.ovRemoveAll();
};
this.doCleanup = function()
{
	for(var c=0;c&lt;3;c++){
		for(var cc=0;cc&lt;this.ovList[c].length;cc++){
			if(!this.ovList[c][cc].isValid){
				this.ovList[c][cc] = 0;
				this.ovListObj[c][cc] = 0;
			}
		}
	}
	return;
};
this.doAdd = function()
{
	for(var o=0;o&lt;3;o++){
		for(var i=0;i&lt;this.ovListObj[o].length;i++) if(this.ovListObj[o][i]) this.ovAdd(this.ovListObj[o][i],1);
	}
	for(var c=0;c&lt;3;c++){
		for(var cc=0;cc&lt;this.ovList[c].length;cc++) if(!this.ovList[c][cc]) this.ovListObj[c][cc] = 0;
	}
	return;
};
// API
/* worldScripts.Cabal_Common_Overlay.ovAdd(obj,off)
	obj		Object. see below
	off		Boolean. If true overlay is added, but offscreen
	
	obj:
	cclov_id			String. Identifier.
	cclov_type			Number. 0=Notification, 1=Character, 2=Fullscreen
	cclov_autoremove	Boolean. Removes effect after cclov_blend seconds
	cclov_blend			Number. Duration for effect.
	cclov_fx			Entity. VisualEffect to be used instead.
	cclov_png			Texture. Must be specified if cclov_fx is not used.
	cclov_color			Array. RGB values in range 0...3 for character overlays.
	
	Returns:
		Visual Effect (when docked true) or false */
this.ovAdd = function(obj,off){
	if(!obj || typeof(obj.cclov_type)!==&#39;number&#39; || !obj.cclov_id) return(false);
	if(!obj.whom) obj.whom = player.ship;
	if(!obj.whom.isValid) return(false);
	if(!obj.cclov_type) obj.cclov_type = 0;
	var where = obj.whom.position,ind = -1,result,f,ents,lookup=&quot;ovList&quot;;
	// Check if exists already
	this.ovPredicate = obj.cclov_id;
	if(player.ship.docked){
		ents = this.ovFindDocked(0).concat(this.ovFindDocked(1));
		lookup = &quot;ovListObj&quot;;
	} else ents = this.ovFind(0).concat(this.ovFind(1));
	if(ents.length) return(false);
	for(var i=0;i&lt;this[lookup][obj.cclov_type].length;i++){
		if(this[lookup][obj.cclov_type][i]===0){
			ind = i;
			break;
		}
	}
	if(ind!==-1){
		if(player.ship.docked){
			this.ovListObj[obj.cclov_type][ind] = obj; // Store
			return(true);
		} else {
			if(obj.cclov_fx){
				f = system.addVisualEffect(obj.cclov_fx,where);
			} else {
				if(obj.cclov_color) f = system.addVisualEffect(&quot;ccl_overlay_color&quot;,where);
				else f = system.addVisualEffect(&quot;ccl_overlay&quot;,where);
			}
			if(f){
				if(obj.cclov_png) this.ovTexChange(f,obj.cclov_png);
				f.script.cclov_tar = obj.whom;
				if(this.ovShadersOff) f.script.cclov_noShade = true;
				this.ovList[obj.cclov_type][ind] = f;
				switch(obj.cclov_type){
					case 0: result = this.ovInstrumentPos[ind]; break;
					case 1: result = this.ovCharacterPos[ind]; break;
					case 2: result = this.ovDeadSpotPos[ind]; break;
				}
				f.shaderVector1 = result;
				if(obj.cclov_blend &amp;&amp; obj.cclov_blend&gt;0){
					if(obj.cclov_type===0) f.script.cclov_blendI = clock.absoluteSeconds+obj.cclov_blend;
					if(obj.cclov_type===1) f.script.cclov_blendC = clock.absoluteSeconds+obj.cclov_blend;
					if(obj.cclov_type===2) f.script.cclov_blendA = clock.absoluteSeconds+obj.cclov_blend;
				}
				f.script.cclov_id = obj.cclov_id;
				f.script.cclov_type = obj.cclov_type;
				this.ovListObj[obj.cclov_type][ind] = obj; // Store
				if(off &amp;&amp; obj.cclov_blend!==-1){
					if(obj.cclov_type===0) f.shaderInt2 = 20;
					if(obj.cclov_type===1) f.shaderInt1 = 20;
				}
				if(obj.cclov_autoremove) f.script.cclov_autoremove = true;
				if(obj.cclov_type===1){
					if(obj.cclov_color) f.shaderVector2 = obj.cclov_color;
				}
				return(f);
			}
		}
	}
	return(false);
};
this.ovTexChange = function(what,cclov_png){
	var mat = what.getMaterials();
	var k = Object.keys(mat);
	if(typeof(mat[k[0]].textures[0])===&#39;string&#39;) mat[k[0]].textures[0] = cclov_png;
	else mat[k[0]].textures[0].name = cclov_png;
	mat[k[0]].emission_map = cclov_png;
	mat[k[0]].ambient_color = [0,0,0,0];
	mat[k[0]].diffuse_color = [0,0,0,0];
	mat[k[0]].shininess = 0;
	what.setMaterials(mat);
	return(true);
};
this.ovSearch = function(element){
	return(element.isVisualEffect &amp;&amp; element.script.cclov_id===this.ovPredicate);
};
this.ovFind = function(cclov_type,who){
	if(who) this.ovPredicate = who;
	return(this.ovList[cclov_type].filter(this.ovSearch,this));
};
this.ovFindDocked = function(cclov_type,who){
	if(who) this.ovPredicate = who;
	return(this.ovListObj[cclov_type].filter(this.ovSearch,this));
};
/* worldScripts.Cabal_Common_Overlay.ovSpeak(who,cclov_blend,message,whom,autoremove)
	who				String. Identifier.
	cclov_blend		Number. Duration for effect.
	message			String.
	whom			Entity.
	autoremove		Boolean. Removes effect after cclov_blend seconds. */
this.ovSpeak = function(who,cclov_blend,message,whom,autoremove){
	if(!who || !cclov_blend || !player.ship.isValid || player.ship.docked) return(false);
	this.ovPredicate = who;
	var ents = this.ovFind(0).concat(this.ovFind(1));
	if(!ents.length) return(false);
	var sc = ents[0].script;
	ents[0].shaderFloat2 = cclov_blend;
	if(message){
		if(whom){
			if(whom.isValid &amp;&amp; whom.isShip) whom.commsMessage(message);
		} else {
			if(sc.cclov_type===1) player.commsMessage(who+&quot;: &quot;+message,cclov_blend);
			else player.consoleMessage(who+&quot;: &quot;+message,cclov_blend);
		}
		var snd = new SoundSource();
		snd.sound = &quot;[cabal_common_commbeep]&quot;;
		snd.play();
	}
	if(cclov_blend){
		if(sc.cclov_type===0 &amp;&amp; sc.cclov_blendI!==-1) sc.cclov_blendI = clock.absoluteSeconds+cclov_blend;
		if(sc.cclov_type===1 &amp;&amp; sc.cclov_blendC!==-1) sc.cclov_blendC = clock.absoluteSeconds+cclov_blend;
	}
	if(sc.valueUpdate) sc.valueUpdate();
	if(autoremove) sc.cclov_autoremove = true;
	return(true);
};
this.ovLog = function(){
	for(var o=0;o&lt;3;o++){
		for(var i=0;i&lt;this.ovList[o].length;i++) if(this.ovList[o][i]) log(&quot;CCL_FX&quot;,&quot;List: cclov_type:&quot;+o+&quot; index:&quot;+i+&quot; : &quot;+this.ovList[o][i].script.cclov_id);
		for(var i=0;i&lt;this.ovListObj[o].length;i++) if(this.ovListObj[o][i]) for(var prop in this.ovListObj[o][i]) log(&quot;CCL_FX&quot;,prop+&quot; : &quot;+this.ovListObj[o][i][prop]);
	}
	return;
};
/* worldScripts.Cabal_Common_Overlay.ovRemove(who)
	who				String. Identifier. */
this.ovRemove = function(who){
	if(!player.ship.isValid) return(false);
	var ind = -1, li = 0,lookup = &quot;ovList&quot;;
	if(player.ship.docked){
		lookup = &quot;ovListObj&quot;;
		for(var i=0;i&lt;this[lookup][0].length;i++) if(this[lookup][0][i] &amp;&amp; this[lookup][0][i].cclov_id===who){
			ind = i; li = 0; break;
		}
		if(ind===-1){
			for(var i=0;i&lt;this[lookup][1].length;i++) if(this[lookup][1][i] &amp;&amp; this[lookup][1][i].cclov_id===who){
				ind = i; li = 1; break;
			}
		}
	} else {
		for(var i=0;i&lt;this[lookup][0].length;i++) if(this[lookup][0][i] &amp;&amp; this[lookup][0][i].script.cclov_id===who){
			ind = i; li = 0; break;
		}
		if(ind===-1){
			for(var i=0;i&lt;this[lookup][1].length;i++) if(this[lookup][1][i] &amp;&amp; this[lookup][1][i].script.cclov_id===who){
				ind = i; li = 1; break;
			}
		}
	}
	if(ind===-1) return(false);
	if(!player.ship.docked){
		this.ovList[li][ind].remove();
		this.ovList[li][ind] = 0;
	}
	this.ovListObj[li][ind] = 0;
	return(true);
};
this.ovRemoveAll = function(){
	var ar = 0;
	for(var o=0;o&lt;3;o++){
		for(var i=0;i&lt;this.ovList[o].length;i++){
			ar = 0;
			if(this.ovList[o][i]){
				if(!this.ovList[o][i].isValid){
					this.ovListObj[o][i] = 0;
					this.ovList[o][i] = 0;
				} else {
					if(this.ovList[o][i].script.cclov_autoremove) ar = 1;
					this.ovList[o][i].remove();
					this.ovList[o][i] = 0;
					if(ar) this.ovListObj[o][i] = 0;
				}
			}
		}
	}
	return(true);
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Cabal_Common_SpecialMarkets.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Cabal_Common_SpecialMarkets&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Additional Market for special goods&quot;;
this.version = &quot;1.7&quot;;

this.registerLocation = function(obj)
{
	if(this.startUp || !obj || !Object.isExtensible(obj)) return(0);
	var req = [&quot;item&quot;,&quot;galaxy&quot;,&quot;buyID&quot;,&quot;sellID&quot;,&quot;cb&quot;,&quot;cbb&quot;,&quot;priceclass&quot;,&quot;refresh&quot;,&quot;desc&quot;,&quot;stationID&quot;];
	var typ = [&quot;string&quot;,&quot;object&quot;,&quot;object&quot;,&quot;object&quot;,&quot;string&quot;,&quot;string&quot;,&quot;number&quot;,&quot;number&quot;,&quot;string&quot;,&quot;object&quot;];
	var ctyp = [&quot;gemStones&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;alienItems&quot;,&quot;alloys&quot;,&quot;computers&quot;,&quot;firearms&quot;,&quot;food&quot;,&quot;furs&quot;,&quot;liquorWines&quot;,&quot;luxuries&quot;,&quot;machinery&quot;,&quot;minerals&quot;,&quot;narcotics&quot;,&quot;radioactives&quot;,&quot;slaves&quot;,&quot;textiles&quot;];
	for(var i=0;i&lt;req.length;i++) if(!obj.hasOwnProperty(req[i]) || typeof(obj[req[i]])!=typ[i]) return(0);
	for(var id=0;id&lt;obj.buyID.length;id++) if(obj.sellID.indexOf(obj.buyID[id])!==-1) return(0);
	var item,galaxy,buyID,sellID,stationID,cb,cbb,priceclass,refresh,desc,block,contract,contractUnit,contractDesc,offset,avail,times,decrease,blackFriday,legal,model,oneShot,blend;
	item = obj.item.substr(0,40);
	galaxy = obj.galaxy;
	buyID = obj.buyID;
	sellID = obj.sellID;
	stationID = obj.stationID;
	cb = obj.cb;
	cbb = obj.cbb;
	desc = obj.desc;
	priceclass = this.helper.clamp(obj.priceclass,100,5);
	refresh = this.helper.clamp(obj.refresh,1,0.06);
	if(!obj.hasOwnProperty(&quot;block&quot;) || typeof(obj.block)!==&quot;boolean&quot;) block=false;
	else block = true;
	if(block || !obj.hasOwnProperty(&quot;contract&quot;) || typeof(obj.contract)!==&quot;string&quot;) contract=false;
	else contract=true;
	if(contract){
		var c = ctyp.indexOf(obj.contract);
		if(c===-1) contract=false;
		else {
			if(!c) contractUnit = &quot;g&quot;;
			else if(c===1 || c===2) contractUnit = &quot;kg&quot;;
			else contractUnit = &quot;t&quot;;
			contractDesc = displayNameForCommodity(ctyp[c]);
			stationID=[[&quot;main&quot;],[&quot;main&quot;]];
		}
	}
	if(!obj.hasOwnProperty(&quot;offset&quot;) || typeof(obj.offset)!==&quot;number&quot;) offset=1.3;
	else offset = this.helper.clamp(obj.offset,5,1.3);
	if(!obj.hasOwnProperty(&quot;avail&quot;) || typeof(obj.avail)!==&quot;number&quot;) avail=0;
	else avail = this.helper.clamp(obj.avail,25,0);
	if(!obj.hasOwnProperty(&quot;times&quot;) || typeof(obj.times)!==&quot;number&quot;) times=clock.days;
	else times = this.helper.clamp(obj.times,clock.days,clock.days-900);
	if(!obj.hasOwnProperty(&quot;decrease&quot;) || typeof(obj.decrease)!==&quot;number&quot;) decrease=0.1;
	else decrease = this.helper.clamp(obj.decrease,0.5,0.1);
	if(!obj.hasOwnProperty(&quot;blackFriday&quot;) || typeof(obj.blackFriday)!==&quot;number&quot;) blackFriday=0;
	else blackFriday = this.helper.clamp(obj.blackFriday,0.2,0);
	if(!obj.hasOwnProperty(&quot;legal&quot;) || typeof(obj.legal)!==&quot;boolean&quot;) legal=true;
	else legal=false;
	if(!obj.hasOwnProperty(&quot;model&quot;) || typeof(obj.model)!==&quot;string&quot;) model=&quot;cargopod&quot;;
	else model = obj.model;
	if(!obj.hasOwnProperty(&quot;oneShot&quot;) || typeof(obj.oneShot)!==&quot;boolean&quot;) oneShot=null;
	else oneShot = obj.oneShot;
	for(var goc=0;goc&lt;galaxy.length;goc++){
		for(var loc=0;loc&lt;buyID.length;loc++){
			if(this.hold){
				for(var o=0;o&lt;8;o++){
					for(var i=0;i&lt;this.hold[o].length;i++){
						if(item===this.hold[o][i].item &amp;&amp; buyID[loc]===this.hold[o][i].buyID){
							times = this.hold[o][i].times;
							if(this.hold[o][i].hasOwnProperty(&quot;blend&quot;)) blend = this.hold[o][i].blend;
							if(this.hold[o][i].hasOwnProperty(&quot;hold&quot;) &amp;&amp; !legal){
								this.inspection++;
								this.rockOn.push(item);
							}
							break;
						}
					}
				}
			}
			var place = {item:item,galaxy:galaxy[goc],buyID:buyID[loc],sellID:sellID,stationID:stationID,cb:cb,cbb:cbb,priceclass:priceclass,refresh:refresh,
				desc:desc,block:block,contract:contract,contractUnit:contractUnit,contractDesc:contractDesc,offset:offset,avail:avail,times:times,
				decrease:decrease,blackFriday:blackFriday,legal:legal,model:model,oneShot:oneShot,blend:blend};
			this.marketLocations[galaxy[goc]].push(place);
		}
	}
	return(1);
};
// Removes item from lists
this.removeTradeItem = function(item,immediate)
{
	if(!immediate &amp;&amp; this.delayRemove &amp;&amp; player.ship.docked) this.delayRemove.push(item);
	else {
		for(var o=0;o&lt;8;o++){
			for(var i=0;i&lt;this.marketLocations[o].length;i++){
				if(item===this.marketLocations[o][i].item){
					this.marketLocations[o] = this.helper.arrRemoveByValue(this.marketLocations[o],this.marketLocations[o][i]);
					--i;
				}
			}
		}
	}
	return;
};
// Check players hold and return amount
this.checkPSHold = function(item)
{
	if(this.psHold.length){
		for(var i=0;i&lt;this.psHold.length;i++){
			if(this.psHold[i].item===item) return(this.psHold[i].store);
		}
	}
	return(0);
};
this.cleanHold = function()
{
	if(this.psHold.length){
		for(var i=0;i&lt;this.psHold.length;i++){
			if(!this.psHold[i].stored){
				this.psHold = this.helper.arrRemoveByValue(this.psHold,this.psHold[i]);
				--i;
			}
		}
	}
	return;
};
this.startUp = function()
{
	delete this.startUp;
	this.helper = new worldScripts.Cabal_Common_Functions.Cabal_Common();
	this.marketLocations = [[],[],[],[],[],[],[],[]];
	this.rockOn = [];
	this.psHold = [];
	this.holdPage = 0;
	this.prep(1);
	this.mso = false;
	this.inspection = 0;
	if(missionVariables.ccl_markets){
		this.hold = JSON.parse(missionVariables.ccl_markets);
		for(var o=0;o&lt;8;o++){
			for(var i=0;i&lt;this.hold[o].length;i++){
				if(this.hold[o][i].hasOwnProperty(&quot;hold&quot;)) this.psHold.push({item:this.hold[o][i].item,stored:this.hold[o][i].hold});
			}
		}
		missionVariables.ccl_markets = null;
	}
};
this.playerWillSaveGame = function()
{
	this.shipWillLaunchFromStation();
	var data = [[],[],[],[],[],[],[],[]],temp,check,ind;
	for(var o=0;o&lt;8;o++){
		for(var i=0;i&lt;this.marketLocations[o].length;i++){
			this.curItem = this.marketLocations[o][i];
			temp = {item:this.curItem.item,buyID:this.curItem.buyID,times:this.curItem.times};
			check = this.psHold.filter(this.ccls_findPSHold,this);
			if(!check.length) continue;
			ind = this.psHold.indexOf(check[0]);
			if(ind!==-1) temp.hold = check[0].stored;
			if(this.curItem.hasOwnProperty(&quot;blend&quot;)) temp.blend = this.curItem.blend;
			data[o].push(temp);
		}
	}
	missionVariables.ccl_markets = JSON.stringify(data);
	this.saved = true;
};
this.guiScreenChanged = function()
{
	if(!player.ship.docked) return;
	if(this.saved){
		missionVariables.ccl_markets = null;
		delete this.saved;
	}
};
this.shipWillExitWitchspace = function()
{
	this.prep(1);
};
this.guiScreenWillChange = function(to)
{
	if(to!==&quot;GUI_SCREEN_EQUIP_SHIP&quot;) return;
	var buys = this.marketLocations[galaxyNumber].filter(this.ccls_findBuy,this);
	var sells = this.marketLocations[galaxyNumber].filter(this.ccls_findSell,this);
	var temp;
	sells = this.helper.arrSortByProperty(sells,&quot;times&quot;);
	for(var w=0;w&lt;sells.length;w++){
		if(temp &amp;&amp; temp===sells[w].item){
			sells = this.helper.arrRemoveByValue(sells,sells[w]);
			--w;
		} else temp = sells[w].item;
	}
	this.trades = buys.concat(sells);
	if(this.trades.length){
		this.prep();
		EquipmentInfo.infoForKey(&quot;EQ_CABAL_COMMON_SPECIALMARKETS&quot;).effectiveTechLevel = 1;
	} else missionVariables.TL_FOR_EQ_CABAL_COMMON_SPECIALMARKETS = null;
};
this.prep = function(n)
{
	var temp = 0;
	if(!n) temp = this.store.rnd
	this.store = {diffTime:0,avail:0,totUnits:0,totBuy:0,totSell:0};
	this.snd = new SoundSource();
	if(n) this.store.rnd=this.helper.clamp(Math.random(),0.81,0.6);
	else this.store.rnd = temp;
	return;
};
this.ccls_findBuy = function(element){return(element.buyID===system.ID &amp;&amp; ((player.ship.dockedStation.isMainStation &amp;&amp; element.stationID[0].indexOf(&quot;main&quot;)!==-1) || (!player.ship.dockedStation.isMainStation &amp;&amp; element.stationID[0].indexOf(player.ship.dockedStation.name)!==-1)));};
this.ccls_findSell = function(element){return(!element.contract &amp;&amp; element.sellID.indexOf(system.ID)!==-1 &amp;&amp; ((player.ship.dockedStation.isMainStation &amp;&amp; element.stationID[1].indexOf(&quot;main&quot;)!==-1) || (!player.ship.dockedStation.isMainStation &amp;&amp; element.stationID[1].indexOf(player.ship.dockedStation.name)!==-1)));};
this.ccls_findPSHold = function(element){return(element.item==this.curItem.item);};
this.shipWillLaunchFromStation = function()
{
	if(this.delayRemove){
		for(var i=0;i&lt;this.delayRemove.length;i++) this.removeTradeItem(this.delayRemove[i],1);
		delete this.delayRemove;
	}
	missionVariables.TL_FOR_EQ_CABAL_COMMON_SPECIALMARKETS = null;
	delete this.curItem;
	delete this.curIndex;
	delete this.curPSHold;
	delete this.scr;
	delete this.snd;
	delete this.buy;
	this.mso = false;
	this.cleanHold();
};
this.shipWillEnterWitchspace = function()
{
	delete this.store;
};
this.playerBoughtEquipment = function(equipmentKey)
{
	if(equipmentKey===&quot;EQ_CABAL_COMMON_SPECIALMARKETS&quot;){
		player.ship.removeEquipment(&quot;EQ_CABAL_COMMON_SPECIALMARKETS&quot;);
		if(!this.delayRemove) this.delayRemove = [];
		this.cycleScreens();
	}
	return;
};
this.cycleScreens = function(){worldScripts.Cabal_Common_SpecialMarkets.cycler(); return;};
this.cycler = function()
{
	if(typeof(this.scr)===&quot;undefined&quot;) this.scr=0;
	var chc = 0,txt = &quot;&quot;,temp,l,blendOut=false;
	this.curItem = this.trades[this.scr];
	if(this.curItem.hasOwnProperty(&quot;blend&quot;) &amp;&amp; clock.days&lt;this.curItem.blend) blendOut=true;
	if(this.trades.length&gt;1) chc += 4;
	if(this.curItem.buyID===system.ID) chc += 1;
	if(this.curItem.sellID.indexOf(system.ID)!==-1) chc += 2;
	if(this.curItem.model) this.showScreen(&quot;CABAL_COMMON_SPECIALMARKET_&quot;+chc,this.curItem.model);
	else this.showScreen(&quot;CABAL_COMMON_SPECIALMARKET_&quot;+chc,null);
	txt += this.curItem.item+(this.curItem.contract?&quot; (&quot;+this.curItem.contractDesc+&quot;)&quot;:&quot;&quot;)+&quot;\n-----------------------------------------------------\n&quot;;
	if(this.curItem.contract){
		this.store.tarSys = this.curItem.sellID[Math.floor(Math.random()*this.curItem.sellID.length)];
		this.store.tarSysName = System.systemNameForID(this.store.tarSys);
	}
	this.store.diffTime = this.helper.clamp(clock.days-this.curItem.times,1000,0);
	var dec = Math.log((1+this.curItem.decrease*this.store.diffTime)+(this.curItem.avail?Math.log(this.curItem.avail):0));
	var prod = this.curItem.refresh*this.store.diffTime;
	var prodTot = prod/(dec&gt;1?1/dec:1);
	var us = (this.store.diffTime?(this.curItem.avail+(prod?prod:0.1)/(prodTot?prodTot:1)*(this.store.diffTime-dec)/(dec&gt;1?dec:1))/(this.curItem.offset&gt;1?this.curItem.offset:1.3)/Math.log(this.curItem.priceclass*0.3)*this.curItem.refresh:0);
	this.store.totUnits = Math.floor(us);
	if((chc&amp;1) &amp;&amp; blendOut) this.store.totUnits = 0;
	var pricernd = Math.sqrt(this.curItem.priceclass*this.store.rnd);
	this.store.totBuy = (((Math.random()&gt;0,5?this.curItem.priceclass-pricernd:this.curItem.priceclass+pricernd)/(Math.log(us+3)*this.store.rnd)/(dec&gt;1?dec:1))/this.curItem.decrease*(this.curItem.refresh?1/this.curItem.refresh:1))/Math.sqrt(this.curItem.offset);
	this.store.totBuy = parseFloat(this.store.totBuy.toFixed(1));
	this.store.totSell = this.store.totBuy*(this.curItem.offset-(1/(1/this.curItem.decrease)*this.store.rnd));
	this.store.totSell = parseFloat(this.store.totSell.toFixed(1));
	if(chc&amp;1){
		temp=this.store.totUnits+&quot; &quot;+(this.curItem.block?&quot;t&quot;:(this.curItem.contract?this.curItem.contractUnit:&quot;g&quot;))+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Units:&quot;,14-l,&quot; &quot;)+temp;
		temp=global.formatCredits(this.store.totBuy,1,1)+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Buy:&quot;,14-l,&quot; &quot;)+temp;
		temp=global.formatCredits(0,1,1)+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Sell:&quot;,14-l,&quot; &quot;)+temp;
	} else {
		temp=this.store.totUnits+&quot; &quot;+(this.curItem.block?&quot;t&quot;:(this.curItem.contract?this.curItem.contractUnit:&quot;g&quot;))+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Units:&quot;,14-l,&quot; &quot;)+temp;
		temp=global.formatCredits(0,1,1)+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Buy:&quot;,14-l,&quot; &quot;)+temp;
		temp=global.formatCredits(this.store.totSell,1,1)+&quot;\n&quot;;
		l=defaultFont.measureString(temp);
		txt += this.helper.strToWidth(&quot;Sell:&quot;,14-l,&quot; &quot;)+temp;
	}
	this.curPSHold = this.psHold.filter(this.ccls_findPSHold,this);
	this.curIndex = this.psHold.indexOf(this.curPSHold[0]);
	if(this.curPSHold.length) temp=this.curPSHold[0].stored+&quot; &quot;+(this.curItem.block?&quot;t&quot;:(this.curItem.contract?this.curItem.contractUnit:&quot;g&quot;))+&quot; / (&quot;+player.ship.cargoSpaceAvailable+&quot;)\n&quot;;
	else temp=&quot;0 &quot;+(this.curItem.block?&quot;t&quot;:(this.curItem.contract?this.curItem.contractUnit:&quot;g&quot;))+&quot; / (&quot;+player.ship.cargoSpaceAvailable+&quot;)\n&quot;;
	if((chc&amp;1) &amp;&amp; player.ship.specialCargo) temp=&quot;- SEALED -\n&quot;;
	l=defaultFont.measureString(temp);
	txt += this.helper.strToWidth(&quot;Cargohold:&quot;,14-l,&quot; &quot;)+temp;
	txt += &quot;-----------------------------------------------------\n&quot;;
	if((chc&amp;1)){
		txt += &quot;Cost for all available:\f(&quot;+global.formatCredits(this.store.totUnits*this.store.totBuy,1,1)+&quot;)\n&quot;;
		txt += &quot;Estimated TradeIn:\f\f(&quot;+global.formatCredits(this.store.totUnits*this.store.totSell,1,1)+&quot;)\n&quot;;
	} else {
		txt += &quot;\n&quot;;
		if(this.curPSHold.length) txt += &quot;Estimated TradeIn:\f\f(&quot;+global.formatCredits(this.curPSHold[0].stored*this.store.totSell,1,1)+&quot;)\n&quot;;
		else txt += &quot;Estimated TradeIn:\f\f(&quot;+global.formatCredits(0,1,1)+&quot;)\n&quot;;
	}
	if(this.curItem.contract){
		var t = System.infoForSystem(galaxyNumber,system.ID).distanceToSystem(System.infoForSystem(galaxyNumber,this.store.tarSys));
		txt +=this.helper.strToWidth(&quot;Credits available:\f\f  (&quot;+global.formatCredits(player.credits,1,1)+&quot;)&quot;,20,&quot; &quot;);
		if(this.store.tarSys!==system.ID) txt += this.store.tarSysName+&quot;, &quot;+t.toFixed(2)+&quot;LY, &quot;+this.helper.mapCoordsDirection(this.store.tarSys,system.ID)+&quot;\n&quot;;
		else txt += &quot;\n&quot;;
	} else txt += &quot;Credits available:\f\f  (&quot;+global.formatCredits(player.credits,1,1)+&quot;)\n&quot;;
	txt += &quot;\nDescription:\n&quot;+this.curItem.desc.substr(0,350);
	mission.addMessageText(txt);
	delete this.buy;
	this.mso = false;
	return;
};
this.showScreen = function(chc,model)
{
	var spin = null,ov=&quot;cabal_common_specialmarkets_ov.png&quot;;
	if(typeof(model)!==&quot;undefined&quot;) spin = true;
	if(this.curItem.block){
		if(this.curItem.buyID===system.ID) ov=&quot;cabal_common_specialmarkets_ovSeal.png&quot;;
		else ov=&quot;cabal_common_specialmarkets_ovUnseal.png&quot;;
	} else if(this.curItem.contract) ov=&quot;cabal_common_specialmarkets_ovContract.png&quot;;
	mission.runScreen({title:system.name+&quot; Special Market&quot;,background:&quot;cabal_common_specialmarkets.png&quot;,overlay:ov,choicesKey:chc,music:&quot;cabal_common_specialmarkets.ogg&quot;,model:model,spinModel:spin},this.choiceEval);
	if(model) this.helper.entScreenCornerPos(0.8,0.9,1.1,3.2);
	return;
};
this.choiceEval = function(choice){worldScripts.Cabal_Common_SpecialMarkets.choiceEvaluation(choice); return;};
this.choiceEvaluation = function(choice)
{
	if(!choice) return;
	switch(choice){
		case &quot;CABAL_COMMON_SPECIALMARKETA&quot;: this.scr++; if(this.scr&gt;=this.trades.length) this.scr=0; this.cycleScreens(); break;
		case &quot;CABAL_COMMON_SPECIALMARKETBA&quot;:
			if(!player.ship.cargoSpaceAvailable || player.ship.cargoSpaceAvailable&lt;this.store.totUnits){
				this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
			} else if(player.credits&gt;=this.store.totUnits*this.store.totBuy){
				if(!this.store.totUnits){
					this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
				} else {
					if(!this.curItem.contract){
						if(this.curItem.block &amp;&amp; player.ship.cargoSpaceAvailable&lt;player.ship.cargoSpaceCapacity){
							this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
							this.snd.play();
							this.cycleScreens();
							return;
						}
						if(this.curIndex===-1) this.psHold.push({item:this.curItem.item,stored:this.store.totUnits});
						else this.psHold[this.curIndex].stored += this.store.totUnits;
					}
					player.credits -= this.store.totUnits*this.store.totBuy;
					this.trades[this.scr].blend = clock.days+Math.ceil(Math.log(this.curItem.priceclass));
					if(!this.curItem.legal){
						this.inspection++;
						this.rockOn.push(this.curItem.item);
					}
					if(this.curItem.block) player.ship.useSpecialCargo(this.curItem.item);
					else if(this.curItem.contract){
						var t = System.infoForSystem(galaxyNumber,system.ID).distanceToSystem(System.infoForSystem(galaxyNumber,this.store.tarSys))*1.3;
						player.ship.awardContract(this.store.totUnits,this.curItem.contractDesc,system.ID,this.store.tarSys,clock.seconds+t*24*3600,this.store.totUnits*this.store.totSell)
					}
					this.snd.sound = &quot;ccl_markets_bought.ogg&quot;;
				}
			} else this.snd.sound = &quot;ccl_markets_creditsfail.ogg&quot;;
			this.snd.play();
			this.cycleScreens();
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETBN&quot;:
			if(!player.ship.cargoSpaceAvailable || player.ship.cargoSpaceAvailable&lt;this.store.totUnits){
				this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
				this.snd.play();
				this.cycleScreens();
			} else if(!this.store.totUnits){
				this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
				this.snd.play();
				this.cycleScreens();
			} else {
				worldScripts.Cabal_Common_Keyboard.start(this.name,1,2);
				this.mso = true;
				this.buy = true;
			}
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETSA&quot;:
			if(this.curIndex!==-1){
				if(this.curPSHold.length &amp;&amp; this.psHold[this.curIndex].stored){
					if(worldScripts[this.trades[this.scr].cb] &amp;&amp; worldScripts[this.trades[this.scr].cb][this.trades[this.scr].cbb]){
						if(this.curItem.buyID===system.ID) this.trades[this.scr].avail += this.psHold[this.curIndex].stored;
						player.credits += this.psHold[this.curIndex].stored*this.store.totSell;
						var cr = this.psHold[this.curIndex].stored;
						this.psHold[this.curIndex].stored = 0;
						if(this.curItem.block &amp;&amp; player.ship.specialCargo===this.curItem.item) player.ship.removeAllCargo();
						var check = worldScripts[this.trades[this.scr].cb][this.trades[this.scr].cbb](this.psHold[this.curIndex].item,cr);
						if(!this.curItem.legal){
							this.inspection--;
							if(this.inspection&lt;0) this.inspection=0;
							this.rockOn = this.helper.arrRemoveByValue(this.rockOn,this.curItem.item);
						}
						if(this.curItem.oneShot) this.removeTradeItem(this.curItem.item);
						if(check) this.snd.sound = &quot;ccl_markets_complete.ogg&quot;;
						else {
							this.snd.sound = &quot;ccl_markets_sold.ogg&quot;;
							this.snd.play();
							this.mso = true;
							return; // OXPs displays own screen
						}
					} else this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
				} else this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
			} else this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
			this.snd.play();
			this.cycleScreens();
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETSN&quot;:
			if(this.curPSHold.length || this.curIndex===-1 || !this.psHold[this.curIndex].stored){
				this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
				this.snd.play();
				this.cycleScreens();
			} else {
				worldScripts.Cabal_Common_Keyboard.start(this.name,1,2);
				this.mso = true;
				this.buy = false;
			}
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETP&quot;:
			this.holdPage++;
			if(this.holdPage*10&gt;this.psHold.length-1) this.holdPage = 0;
			var a = this.holdPage*10,chc;
			if(a&gt;this.psHold.length-1) a = 0;
			chc = &quot;CABAL_COMMON_SPECIALMARKET_OVERVIEW_3&quot;;
			var b = this.helper.clamp(this.psHold.length,99,0);
			b = Math.min(b,a+10);
			mission.runScreen({title:&quot;Loaded Cargo&quot;,background:&quot;cabal_common_specialmarkets.png&quot;,overlay:&quot;cabal_common_specialmarkets_ov.png&quot;,choicesKey:chc,music:&quot;cabal_common_specialmarkets.ogg&quot;},this.choiceEval);
			for(var c=a;c&lt;b;c++) mission.addMessageText(this.helper.strToWidth(this.psHold[c].item,14)+&quot; : &quot;+this.psHold[c].stored);
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETX&quot;:
			this.cycleScreens();
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETY&quot;:
			if(!this.psHold.length){
				mission.runScreen({title:&quot;Loaded Cargo&quot;,background:&quot;cabal_common_specialmarkets.png&quot;,overlay:&quot;cabal_common_specialmarkets_ov.png&quot;,choicesKey:&quot;CABAL_COMMON_SPECIALMARKET_OVERVIEW_2&quot;,music:&quot;cabal_common_specialmarkets.ogg&quot;},this.choiceEval);
				mission.addMessageText(&quot;No special good in your hold.&quot;);
			} else {
				var a = this.holdPage*10,chc;
				if(this.psHold.length-1&lt;10){
					a = 0;
					chc = &quot;CABAL_COMMON_SPECIALMARKET_OVERVIEW_2&quot;;
				} else chc = &quot;CABAL_COMMON_SPECIALMARKET_OVERVIEW_3&quot;;
				var b = this.helper.clamp(this.psHold.length,99,0);
				b = Math.min(b,a+10);
				mission.runScreen({title:&quot;Loaded Cargo&quot;,background:&quot;cabal_common_specialmarkets.png&quot;,overlay:&quot;cabal_common_specialmarkets_ov.png&quot;,choicesKey:chc,music:&quot;cabal_common_specialmarkets.ogg&quot;},this.choiceEval);
				for(var c=a;c&lt;b;c++) mission.addMessageText(this.helper.strToWidth(this.psHold[c].item,14)+&quot; : &quot;+this.psHold[c].stored);
			}
			break;
		case &quot;CABAL_COMMON_SPECIALMARKETZ&quot;:
			this.shipWillLaunchFromStation();
			break;
		default: log(&quot;Choice not handled.&quot;);
	}
	return;
};
this.Cabal_Common_Keyboard_Output = function(input){worldScripts.Cabal_Common_SpecialMarkets.keyboardEval(input); return;};
this.keyboardEval = function(input)
{
	if(!input || input===&quot;&quot; || input===&quot;0&quot;){
		this.cycleScreens();
		return;
	}
	var cr = parseInt(input,null);
	if(this.buy){
		if(!player.ship.cargoSpaceAvailable || player.ship.cargoSpaceAvailable&lt;this.store.totUnits){
			this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
		} else if(player.credits&gt;=cr*this.store.totBuy){
			if(!this.store.totUnits){
				this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
			} else {
				if(this.store.totUnits&lt;cr) cr = this.store.totUnits;
				if(!this.curItem.contract){
					if(player.ship.cargoSpaceAvailable&lt;player.ship.cargoSpaceCapacity){
						this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
						this.snd.play();
						this.cycleScreens();
						return;
					}
					if(this.curIndex===-1) this.psHold.push({item:this.curItem.item,stored:cr});
					else this.psHold[this.curIndex].stored += cr;
				}
				player.credits -= cr*this.store.totBuy;
				this.trades[this.scr].blend = clock.days+Math.ceil(Math.log(this.curItem.priceclass)); // Only one trade? - TODO
				if(!this.curItem.legal){
					this.inspection++;
					if(this.rockOn.indexOf(this.curItem.item)===-1) this.rockOn.push(this.curItem.item);
				}
				if(this.curItem.block) player.ship.useSpecialCargo(this.curItem.item);
				else if(this.curItem.contract){
					var t = System.infoForSystem(galaxyNumber,system.ID).distanceToSystem(System.infoForSystem(galaxyNumber,this.store.tarSys))*1.3;
					player.ship.awardContract(cr,this.curItem.contractDesc,system.ID,this.store.tarSys,clock.seconds+t*24*3600,cr*this.store.totSell)
				}
				this.snd.sound = &quot;ccl_markets_bought.ogg&quot;;
			}
		} else this.snd.sound = &quot;ccl_markets_creditsfail.ogg&quot;;
		this.snd.play();
		this.cycleScreens();
	} else {
		if(this.psHold[this.curIndex].stored){
			if(this.psHold[this.curIndex].stored&lt;cr) cr = this.psHold[this.curIndex].stored;
			if(worldScripts[this.trades[this.scr].cb] &amp;&amp; worldScripts[this.trades[this.scr].cb][this.trades[this.scr].cbb]){
				if(this.curItem.buyID===system.ID) this.trades[this.scr].avail += cr;
				player.credits += cr*this.store.totSell;
				this.psHold[this.curIndex].stored -= cr;
				if(this.curItem.block &amp;&amp; player.ship.specialCargo===this.curItem.item) player.ship.removeAllCargo();
				if(!this.psHold[this.curIndex].stored){
					this.inspection--;
					if(this.inspection&lt;0) this.inspection=0;
					this.rockOn = this.helper.arrRemoveByValue(this.rockOn,this.psHold[this.curIndex].item);
				}
				var check = worldScripts[this.trades[this.scr].cb][this.trades[this.scr].cbb](this.psHold[this.curIndex].item,cr);
				if(!this.psHold[this.curIndex].stored &amp;&amp; this.curItem.oneShot) this.removeTradeItem(this.curItem.item);
				if(check) this.snd.sound = &quot;ccl_markets_complete.ogg&quot;;
				else {
					this.snd.sound = &quot;ccl_markets_sold.ogg&quot;;
					this.snd.play();
					this.mso = true;
					return; // OXPs displays own screen
				}
			} else this.snd.sound = &quot;ccl_markets_fail.ogg&quot;;
		} else this.snd.sound = &quot;ccl_markets_nounits.ogg&quot;;
		this.snd.play();
		this.cycleScreens();
	}
	return;
};
this.missionScreenOpportunity = function()
{
	if(this.mso) this.cycleScreens();
};
this.shipEnteredStationAegis = function(station)
{
	if(station &amp;&amp; this.inspection &amp;&amp; player.ship.isValid){
		if(this.rockOn.length &amp;&amp; Math.random()&gt;0.9){
			if(worldScripts.vector_insp) worldScripts.vector_insp.startInspection(station,this.rockOn);
			else {
				var pen = Math.ceil(Math.sqrt(system.government+1)*this.rockOn.length);
				player.addMessageToArrivalReport(&quot;You&#39;re fined with &quot;+pen+&quot; Credits for trading in illegal goods without license.&quot;);
				player.credits -= pen;
			}
		}
	}
};
/*
this.specialCargo = function(what,amount)
{
	return(true);
};
*/
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cabal_common_comm_eq.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;cabal_common_comm_eq&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Secure comms channels - EQ script.&quot;;
this.version = &quot;1.7&quot;;

this.activated = function()
{
	if(!this.beep){
		this.beep = new SoundSource();
		this.beep.sound = &quot;[cabal_common_commbeep]&quot;;
	}
	if(worldScripts.Cabal_Common_Comms.commChannelChanged){
		this.store = worldScripts.Cabal_Common_Comms.commChannels;
		worldScripts.Cabal_Common_Comms.commChannelChanged = false;
		if(this.control) delete this.control;
	}
	if(!this.store) return;
	if(!this.control || ((new Date()).getTime()-this.control.lastPress)&gt;5000){
		this.control = {actions:this.store,mode:0,cycleA:0,cycleB:0,selected:0,lastPress:1};
		var current = this.control.actions[this.control.cycleA];
		player.consoleMessage(current.display,2);
	} else {
		if(((new Date()).getTime()-this.control.lastPress)&lt;1200){
			var current;
			if(!this.control.mode){
				this.control.cycleA++;
				if(this.control.cycleA&gt;this.control.actions.length-1) this.control.cycleA = 0;
				this.control.selected = this.control.cycleA;
				current = this.control.actions[this.control.cycleA];
			} else {
				this.control.cycleB++;
				if(this.control.cycleB&gt;this.control.actions[this.control.cycleA].react.length-1) this.control.cycleB = 0;
				current = this.control.actions[this.control.cycleA].react[this.control.cycleB];
			}
			player.consoleMessage(current.display,2);
		} else {
			var current,shorter;
			if(!this.control.mode) current = this.control.actions[this.control.cycleA];
			else current = this.control.actions[this.control.cycleA].react[this.control.cycleB];
			switch(this.control.mode){
				case 0:
					if(current.display===&quot;Discard&quot;){
						this.beep.play();
						delete this.control;
						player.consoleMessage(&#39;Cleared.&#39;,2);
						return;
					} else {
						if(current.display===&quot;Open channel&quot;){
							if(player.ship.target) this.requestChannel();
							else player.consoleMessage(&#39;No target.&#39;,2);
							delete this.control;
							this.beep.play();
							return;
						} else {
							this.control.cycleB = 0;
							this.control.mode = 1;
							current = this.control.actions[this.control.cycleA].react[this.control.cycleB];
						}
					}
					player.consoleMessage(current.display,2);
					break;
				case 1:
					if(current.display===&quot;Back&quot;){
						this.control.cycleA = this.control.selected;
						this.control.cycleB = 0;
						this.control.mode = 0;
						current = this.control.actions[this.control.cycleA];
					} else {
						shorter = this.control.actions[this.control.cycleA];
						if(shorter.ent){
							if(shorter.who.isValid){
								if(shorter.noDist || shorter.who.position.distanceTo(player.ship.position)&lt;25600){
									shorter.who.script[shorter.callback](this.control.cycleB);
								} else player.consoleMessage(&#39;Signal weak&#39;,2);
							}
						} else {
							if(worldScripts[shorter.who] &amp;&amp; !worldScripts[shorter.who].deactivated){
								if(shorter.eID &amp;&amp; shorter.eID.isValid){
									if(shorter.eID.position.distanceTo(player.ship.position)&lt;25600){
										worldScripts[shorter.who][shorter.callback](this.control.cycleB,shorter.pID,shorter.react[this.control.cycleB]);
									} else player.consoleMessage(&#39;Signal weak&#39;,2);
								} else worldScripts[shorter.who][shorter.callback](this.control.cycleB,shorter.pID);
							}
						}
						delete this.control;
						this.beep.play();
						return;
					}
					player.consoleMessage(current.display,2);
					break;
			}
		}
	}
	this.control.lastPress = (new Date()).getTime();
	this.beep.play();
};
this.requestChannel = function()
{
	var pst = player.ship.target;
	if(!pst.isShip || pst.isCargo || pst.isWeapon || pst.isRock || pst.isDerelict || !pst.isPiloted){
		player.consoleMessage(&#39;Not possible.&#39;,2);
		return;
	}
	this.patchedIDs = worldScripts.Cabal_Common_Comms.patchedIDs;
	if(this.patchedIDs.indexOf(pst.entityPersonality)===-1){
		if(pst.scriptInfo &amp;&amp; pst.scriptInfo.ccl_secureChannel){
			var channel = pst.scriptInfo.ccl_secureChannel;
			if(pst.script[channel]){
				if(worldScripts.Cabal_Common_Comms.addToComm(pst.script[channel])) player.consoleMessage(&#39;Channel created.&#39;,2);
				return;
			} else {
				if(pst.scriptInfo.ccl_secureChannelPrep){
					if(pst.script[pst.scriptInfo.ccl_secureChannelPrep]){
						pst.script[pst.scriptInfo.ccl_secureChannelPrep]();
						var channel = pst.scriptInfo.ccl_secureChannel;
						if(worldScripts.Cabal_Common_Comms.addToComm(pst.script[channel])) player.consoleMessage(&#39;Channel created.&#39;,2);
						return;
					} else player.consoleMessage(&#39;Not available.&#39;,2);
				} else player.consoleMessage(&#39;Not available.&#39;,2);
			}
		} else player.consoleMessage(&#39;Request denied.&#39;,2);
	} else player.consoleMessage(&#39;Already done.&#39;,2);
	return;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cabal_common_oxps_mine.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;cabal_common_oxps_mine&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Boooh.&quot;;
this.version = &quot;1.7&quot;;

this.shipDied = function()
{
	if(this.ship.name===&quot;CleanerMine&quot;) this.ship.spawn(&quot;cabal_common_oxps_minesub&quot;,5);
	else return;
	if(player.ship.isValid &amp;&amp; this.ship.position.distanceTo(player.ship.position)&lt;25600){
		var s = new SoundSource();
		s.sound = &quot;cabal_common_bang.ogg&quot;;
		s.play();
	}
	return;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cabal_common_oxps_ov.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;cabal_common_oxps_ov&quot;;
this.author = &quot;Svengali&quot;;
this.copyright = &quot;(C)2010-2013, License:CC-by&quot;;
this.description = &quot;Generic Overlay script.&quot;;
this.version = &quot;1.7&quot;;

/*	As view_positions are not exposed positioning is practically impossible
	if shaders are off and therefor only roughly implemented.
*/
// Defaults
this.cclov_tar = player.ship;
this.cclov_blendC = -1;
this.cclov_blendI = -1;
this.cclov_blendA = -1;
this.cclov_noShade = false;

this.effectSpawned = function()
{
	this.ovFCBID = addFrameCallback(this.repos.bind(this));
}
this.effectRemoved = function()
{
	removeFrameCallback(this.ovFCBID);
}
this.repos = function(delta)
{
	if(!player.ship.isValid || !this.cclov_tar.isValid) this.visualEffect.remove();
	if(!delta) return;
	if(this.cclov_blendA!==-1 &amp;&amp; clock.absoluteSeconds&gt;this.cclov_blendA) this.visualEffect.remove();
	else {
		if(this.visualEffect.shaderFloat1&lt;1) this.visualEffect.shaderFloat1 += delta;
		if(this.visualEffect.shaderFloat2&gt;0){
			this.visualEffect.shaderFloat2 -= delta;
			if(this.visualEffect.shaderInt1&gt;0) this.visualEffect.shaderInt1 -= 1;
			if(this.visualEffect.shaderInt2&gt;0) this.visualEffect.shaderInt2 -= 1;
		} else {
			if(this.cclov_blendC!==-1 &amp;&amp; clock.absoluteSeconds&gt;this.cclov_blendC){
				if(this.visualEffect.shaderInt1&lt;20) this.visualEffect.shaderInt1 += 1;
				else if(this.cclov_autoremove){
					this.visualEffect.remove();
					return;
				}
			}
			if(this.cclov_blendI!==-1 &amp;&amp; clock.absoluteSeconds&gt;this.cclov_blendI){
				if(this.visualEffect.shaderInt2&lt;20) this.visualEffect.shaderInt2 += 1;
				else if(this.cclov_autoremove){
					this.visualEffect.remove();
					return;
				}
			}
		}
		if(!this.cclov_tar.isValid) return; // needs this check. strange.
		var bb = this.cclov_tar.boundingBox;
		if(this.cclov_tar.isPlayer){
			switch(this.cclov_tar.viewDirection){
				case &quot;VIEW_FORWARD&quot;:
					if(!this.cclov_noShade) this.visualEffect.position = this.cclov_tar.position.add(this.cclov_tar.vectorForward.multiply(bb.z));
					else this.visualEffect.position = this.cclov_tar.position.add(this.cclov_tar.vectorForward.multiply(75)).add(this.cclov_tar.vectorUp.multiply(15)).subtract(this.visualEffect.shaderVector1.multiply(1.2).rotateBy(this.cclov_tar.orientation));
					break;
				case &quot;VIEW_AFT&quot;:
					if(!this.cclov_noShade) this.visualEffect.position = this.cclov_tar.position.subtract(this.cclov_tar.vectorForward.multiply(bb.z));
					else this.visualEffect.position = this.cclov_tar.position.subtract(this.cclov_tar.vectorForward.multiply(75)).add(this.cclov_tar.vectorUp.multiply(15)).subtract(this.visualEffect.shaderVector1.multiply(1.2).rotateBy(this.cclov_tar.orientation));
					break;
				case &quot;VIEW_PORT&quot;:
					if(!this.cclov_noShade) this.visualEffect.position = this.cclov_tar.position.subtract(this.cclov_tar.vectorRight.multiply(bb.x));
					else this.visualEffect.position = this.cclov_tar.position.subtract(this.cclov_tar.vectorRight.multiply(85)).add(this.cclov_tar.vectorUp.multiply(10)).subtract(this.visualEffect.shaderVector1.multiply(1.2).rotateBy(this.cclov_tar.orientation));
					break;
				case &quot;VIEW_STARBOARD&quot;:
					if(!this.cclov_noShade) this.visualEffect.position = this.cclov_tar.position.add(this.cclov_tar.vectorRight.multiply(bb.x));
					else this.visualEffect.position = this.cclov_tar.position.add(this.cclov_tar.vectorRight.multiply(85)).add(this.cclov_tar.vectorUp.multiply(10)).subtract(this.visualEffect.shaderVector1.multiply(1.2).rotateBy(this.cclov_tar.orientation));
					break;
				case &quot;VIEW_CUSTOM&quot;:
					this.visualEffect.position = this.cclov_tar.position;
					break;
				case &quot;VIEW_GUI_DISPLAY&quot;:
					this.visualEffect.shaderFloat1 = 0;
					break;
			}
		}
		if(!this.cclov_tar.isValid) return; // needs this check. strange.
		if(this.cclov_noShade) this.visualEffect.orientation = this.cclov_tar.orientation;
	}
	return;
};
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
