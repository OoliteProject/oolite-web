<html>
    <head>
        <title>Expansion Ship Repurchase</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Ship Repurchase</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Implements a &#39;repurchase&#39; methodology when the player ship is destroyed.</td>
                    <td>Implements a &#39;repurchase&#39; methodology when the player ship is destroyed.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.ShipRepurchase</td>
                    <td>oolite.oxp.phkb.ShipRepurchase</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Ship Repurchase</td>
                    <td>Ship Repurchase</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.6.2</td>
                    <td>0.6.2</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.37</li>
                    </td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.37</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/e/ef/ShipRepurchase.oxz">https://wiki.alioth.net/img_auth.php/e/ef/ShipRepurchase.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1657067260</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Ship%20Repurchase'>http://wiki.alioth.net/index.php/Ship%20Repurchase</a></p>
        <h3>readme.txt</h3>
        <pre>Ship Repurchase
By Nick Rogers

Overview
========
This OXP aims to make the experience of using an escape pod a bit more interesting and realistic. The first change is that the player will be auto-ejected from their ship just before it is destroyed, in all cases, even if they don&#39;t have an escape pod. If the player has not fitted an escape pod, they will eject from their ship in a life-support suit only, which provides a means of keeping the pilot in stasis until they can be recovered. If an escape pod is fitted, it will auto-eject the player when it is clear the ship can no longer support life. Players can also choose when they eject if they have an escape pod, rather than waiting for the auto-eject process to kick in. Also, any parcels or passengers currently on board, and any gold, platinum or gem-stones will not fit into the life-support suit, and so will be lost with the rest of the cargo and ship. If an escape pod is fitted, these items will be preserved.

Once the player has been recovered, they then need to decide what to do about replacing their ship. They will be given (at most) three options: 
   (1) to replace their previous ship plus all the equipment on it; 
   (2) to just replace their existing ship, leaving out any equipment; or 
   (3) choosing a lower cost ship as a replacement.

For options (1) and (2) there is a cost involved: 10% of the original cost. If, however, you have purchased an escape pod, there is an insurance component to the purchase that reduces the amount to be only 5% of the original cost. A more expensive escape pod option, named &quot;Escape Pod Plus&quot;, will reduce the amount further, to 2.5% of the original cost. 

Option (3) is always free. Potentially two ships will be offered, depending on the base value of your current ship. The following table outlines the ships that will be offered (Offer 1 ships are generally trader-type ships, while Offer 2 ships are generally hunter-type ships):

    Current ship
    Base Value      Offer 1             Offer 2
    -------------   ------------------  ---------------
    650001+         Anaconda            Fer-de-Lance
    495001-650000   Boa Class Cruiser   Fer-de-Lance
    485001-495000   Boa                 Fer-de-Lance
    450001-485000   Boa                 Asp Mark II
    375001-450000   Python              Asp Mark II
    200001-375000   Python              Cobra Mark III
    150001-200000   Cobra Mark III
    145001-150000   Moray Medical Boat  Moray Star Boat
    125001-145000   Moray Star Boat
    100001-125000   Cobra Mark I
    0-100000        Adder

If a full ship plus equipment replacement is chosen, the ship will arrive in a fully working condition. That is, any equipment that was damaged at the time of destruction will be in a working order on the replacement(*), and the ship will not be in need of an overhaul. 

If the player has insufficient funds to purchase either the full replacement, or the stock replacement ship, they will be forced to accept the lower value ship as their free ship to continue their galactic journey.

Note that, if you have passengers on board, choosing option (2) or (3) will result in those passengers being abandoned at the station and the contracts terminated.

(*) Note: The one exception to this rule is the cloaking device, which, because of the nature of the device and how it came to be in your posession, constitutes a real problem for insurance repair coverage. However, if you are rescued at a station that has a suitably high tech level, the device will be repaired.

Frequent Ejecting Penalty
=========================
In order to curb misuse (or instance, ejecting from a badly damaged ship to avoid repair bills), players who eject frequently will suffer a repurchase penalty. The calculation is (1 + ((monthly_eject_count - 1) x 2) / 10) x original_percentage. So, ejecting 2 times in a month will increase the percentage to 12%. Ejecting 3 times in a month will increase the percentages to 14%. If you were to eject 16 times in a month, that would change the 10% of original cost of the ship to be 40%.

As a player progresses through the game, the length of time used for picking up ejecting events in the calculation will increase. Players with less than 32 kills will stay at the 30 day mark. After 32 kills, the period increases to 60 days (2 months). At 64 kills, the period is 90 days (3 months); at 128 kills, the period is 4 months; at 512 kills the period is 6 months; at 2560 kills, the period is 9 months; and at 6400+ kills, the period is 1 year.

*News Flash*: GalCop intervenes in the Insurance sector, ordering the suspension of any penalty for frequency of ejecting. The Head of Pilot Relations noted: &quot;The life as a pilot in the galaxy is already hard. To penalise the majority of pilots based on the actions of a few cases is unfair.&quot; Given the lack of any formal notification by the insurance sector, speculation has arisen that GalCop is funding the insurance premiums through other means.

Insurance
=========
Due to the high number of total-loss payments insurance providers have been forced to make over the last decade, no-cost replacement insurance is no longer a complimentary part of an escape pod purchase. Instead, as noted above, any escape pod purchase will instead reduce the cost of any repurchase event. 

However, many clients still find even the reduced costs difficult to bear. So insurance providers have introduced &quot;Ship Repurchase Insurance&quot;, which covers the holder of the policy for a maximum of 60 days from date of purchase, and will reduce the cost of any ship plus equipment replacement to just 1000cr. A ship-only replacement will cost just 500cr. This insurance can be purchased at any GalCop-aligned station in all systems. The insurance is a once-only policy - if the policy is invoked, the terms state that the policy is then terminated.

New Jamesons
============
Insurance providers understand that new pilots need more protection than experienced ones. To help new pilots on their way, these payments will only be required for pilots who have attained an Elite rank of &quot;Poor&quot;. If a &quot;Harmless&quot; or &quot;Mostly Harmless&quot; pilot ejects, the cost of a full replacement ship will be greatly reduced: 200cr for a full ship and equipment replacement, 100cr for a ship-only replacement.

Interstellar space
==================
Ejecting in interstellar space is generally fatal - there is usually no one close enough to your location to render assistance, and the limited fuel on the escape pod is insufficient to enable a return to normal space. 

However, occasionally there are rescue options even in interstellar space. If one of these options is close by (like a naval station or carrier), there is a chance a rescue will take place. However, insurance operators cannot provide replacement ships in this situation. Instead, the player will be given a used ship and will have to make their way back to normal space in this. When they dock at a GalCop station they will at that time be presented with options for ship replacement.

History
=======
The standard escape pod in the core game operates in a strange way. While the description indicates there is some sort of insurance policy involved in purchasing the pod, if you eject with a ship full of damaged equipment, you will be given a replacement ship with the same damaged equipment in it. This reflects what happened in the 8-bit versions of Elite, and was likely a result of limited resources to do anything more complex.

Required OXP&#39;s
==============
This OXP uses the &quot;Ship Storage Helper&quot; OXP to store and recover the players ship.

Compatibility
=============
This OXP should be fully compatible with the &quot;Auto-Eject&quot; OXP by Commander McLane. The &quot;Auto-Eject&quot; equipment will eject the player ahead of the auto-eject function of this pack, and the repurchasing process will apply in both situations.

It should also be fully compatible with the &quot;Interstellar Tweaks&quot; OXP by UK Eliter. When ejecting in interstellar space, the recovery options of this OXP will ceed control to Interstellar Tweaks, allowing it to choose the destination. The repurchasing process will apply after recovery.

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Rocket image from http://simpleicon.com/rocket.html
Shield image from https://www.iconfinder.com/icons/175318/shield_icon#size=512

Version History
===============
0.6.2
- Preventing recovery from a Generation ship.

0.6.1
- Increased required version level for Ship Storage Helper.

0.6
- Adjusted the method for determining when the ship is about to die, to allow for other OXP&#39;s to potentially change the player ship energy before ejecting the player.
- Changed insurance premium coverage period to 60 days.
- If insurance lapses while in transit, it will still be valid at next dock if the player needs to use it.
- Reduced cost of Escape Pod Plus to 3000 credits, and set techlevel requirement to same as for a normal escape pod.
- If the Escape Pod Plus is installed, rescue time will be reduced to less than 12 hours. Also, 50% of cargo will be recovered.
- Cost of Repurchase Insurance reduced to 2500 credits.
- Removed the frequent ejection penalty calculation (although it could be returned based on feedback).
- Raised minimum Oolite version to 1.89 (now utilising equipment-overrides.plist file and new escape pod rescue time property).

0.5
- Better handling of multiple damage events taking place at the same time.

0.4
- Better integration with Ship Configuration OXP armour settings.
- Better integration with Battle Damage OXP.
- Code refactoring.

0.3
- Added integration with Email System, so contract termination emails are sent if the player loses parcel or passenger contracts due to using the life-support suit when ejecting.

0.2
- Now considering player score when determining how far back to include ejecting events in the frequent ejecting penalty calculation.
- Free ship offer can be one of 2 types: a trader ship, or a hunter/assassin ship.
- Fixed issue where equipment items that can be multiple were not all being repaired after an eject event.
- Enforced consistency with Cobra Mark III and Mark I base prices.
- Fixed issue where interstellar space mode was being activated incorrectly.

0.1
- Initial version.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ESCAPE_POD_PLUS.html">Escape Pod Plus</a></td>
                    <td>yes</td>
                    <td align="right">30000</td>
                    <td align="center">7+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_REPURCHASE_INSURANCE.html">Ship Repurchase Insurance</a></td>
                    <td>yes</td>
                    <td align="right">25000</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;ShipRepurchase&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2017 phkb&quot;;
this.description = &quot;Implements a ship repurchase process for when the player&#39;s ship is destroyed.&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

this._debug = true;
this._doRepurchase = false;
this._repurchasePercent = 0.1;
this._baseShipCost = 0;
this._fullShipCost = 0;
this._jamesonPoint = 16;
this._portable = [];
this._roles = [];
this._lastEjectDates = [];
this._ejectDate = 0;
this._simulator = false;
this._insuranceDate = 0;
this._scTimer = null;
this._cargoRecovery = [];
this._cargoRecoverySummary = &quot;&quot;;
this._applyPenalty = false;
this._interstellarRecovery = false;
this._interstellarMode = false;
this._interstellarFreeShip = {
    key: &quot;cobramk1-player&quot;,
    name: &quot;Cobra Mark I&quot;
};
this._storedShip = &quot;&quot;;

// dictionary of equipment key/min techlevel items to apply as an override when auto-repairing equipment
// additional equipment items could be added here for further restrictions on auto-repair
this._autoRepairMinTL = {
    &quot;EQ_CLOAKING_DEVICE&quot;: 14,
    &quot;EQ_MILITARY_JAMMER&quot;: 99,
    &quot;EQ_MILITARY_SCANNER_FILTER&quot;: 99
};
// used to calculate how far back the premium calculation will look for repurchase events. based on player.score
this._periodLevels = {
    &quot;0&quot;: 30,
    &quot;8&quot;: 30,
    &quot;16&quot;: 30,
    &quot;32&quot;: 60,
    &quot;64&quot;: 90,
    &quot;128&quot;: 120,
    &quot;512&quot;: 180,
    &quot;2560&quot;: 270,
    &quot;6400&quot;: 365
};

// dictionary of min values and key/name dictionary
// used to determine which free ship is available based on the original cost of the players current ship
this._freeShipTrader = {
    &quot;650000&quot;: {
        key: &quot;anaconda-player&quot;,
        name: &quot;Anaconda&quot;
    },
    &quot;495000&quot;: {
        key: &quot;boa-mk2-player&quot;,
        name: &quot;Boa Class Cruiser&quot;
    },
    &quot;450000&quot;: {
        key: &quot;boa-player&quot;,
        name: &quot;Boa&quot;
    },
    &quot;200000&quot;: {
        key: &quot;python-player&quot;,
        name: &quot;Python&quot;
    },
    &quot;150000&quot;: {
        key: &quot;cobra3-player&quot;,
        name: &quot;Cobra Mark III&quot;
    },
    &quot;145000&quot;: {
        key: &quot;morayMED-player&quot;,
        name: &quot;Moray Medical Boat&quot;
    },
    &quot;125000&quot;: {
        key: &quot;moray-player&quot;,
        name: &quot;Moray Star Boat&quot;
    },
    &quot;100000&quot;: {
        key: &quot;cobramk1-player&quot;,
        name: &quot;Cobra Mark I&quot;
    },
    &quot;65000&quot;: {
        key: &quot;adder-player&quot;,
        name: &quot;Adder&quot;
    }
};
this._freeShipHunter = {
    &quot;485000&quot;: {
        key: &quot;ferdelance-player&quot;,
        name: &quot;Fer-de-Lance&quot;
    },
    &quot;375000&quot;: {
        key: &quot;asp-player&quot;,
        name: &quot;Asp Mark II&quot;
    },
    &quot;150000&quot;: {
        key: &quot;cobra3-player&quot;,
        name: &quot;Cobra Mark III&quot;
    },
    &quot;125000&quot;: {
        key: &quot;moray-player&quot;,
        name: &quot;Moray Star Boat&quot;
    },
};
this._freePick1 = null; // ship key of the free ship the player chose
this._freePick2 = null;

// some OXP ship packs change the default price of Cobra Mark III&#39;s and Mark I&#39;s. 
// We&#39;re putting overrides in here so we can be consistent.
this._overrideBasePrice = {
    &quot;Cobra Mark III&quot;: 150000,
    &quot;Cobra Mark I&quot;: 100000
};

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
    var trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];
    if (missionVariables.ShipRepurchase_LastEjectDates) this._lastEjectDates = JSON.parse(missionVariables.ShipRepurchase_LastEjectDates);
    if (missionVariables.ShipRepurchase_InsuranceDate) this._insuranceDate = missionVariables.ShipRepurchase_InsuranceDate;
    if (missionVariables.ShipRepurchase_StoredShip) this._storedShip = missionVariables.ShipRepurchase_StoredShip;
    if (missionVariables.ShipRepurchase_InterstellarMode) this._interstellarMode = (trueValues.indexOf(missionVariables.ShipRepurchase_InterstellarMode) &gt;= 0 ? true : false);

    /*if (worldScripts.ShipConfiguration_Armour) {
        // monkey patch shipconfig armour so we can make sure things get done in the right sequence
        var sca = worldScripts.ShipConfiguration_Armour;
        sca.$sr_shipLaunchedFromStation = sca.shipLaunchedFromStation;
        delete sca.shipLaunchedFromStation;
    }*/
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
    if (this._lastEjectDates.length &gt; 0) {
        missionVariables.ShipRepurchase_LastEjectDates = JSON.stringify(this._lastEjectDates);
    } else {
        delete missionVariables.ShipRepurchase_LastEjectDates;
    }
    missionVariables.ShipRepurchase_InsuranceDate = this._insuranceDate;
    if (this._storedShip != &quot;&quot;) {
        missionVariables.ShipRepurchase_StoredShip = this._storedShip;
    } else {
        delete missionVariables.ShipRepurchase_StoredShip;
    }
    missionVariables.ShipRepurchase_InterstellarMode = this._interstellarMode;
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedEscapePod = function (pod) {
    if (this._simulator) return;
    this._ejectDate = clock.adjustedSeconds;
}

//-------------------------------------------------------------------------------------------------------------
// todo: what happens if multiple events turn up simultaneously?
this.shipTakingDamage = function (amount, whom, type) {
    if (this._simulator) return;
    // are we just about to die?
    // award the escape pod and eject
    if (this._debug) log(this.name, &quot;shipTakingDamage &quot; + amount + &quot;, &quot; + type + &quot; : current ship energy &quot; + (player.ship ? player.ship.energy : &quot;no player ship!&quot;));
    if (player.ship &amp;&amp; player.ship.energy &lt;= 0) {
        // turn off ship config functions
        var sc = worldScripts.ShipConfiguration_Core;
        if (sc) {
            sc._repairing = true;
            sc._adding = true;
        }
        var p = player.ship;
        if (this._debug) log(this.name, &quot;attempting to award escape pod&quot;);
        var result = p.awardEquipment(&quot;EQ_ESCAPE_POD&quot;);
        if (this._debug) log(this.name, &quot;award escape pod result &quot; + result);
        // if the result of adding an escape pod was false, this means the player already had a functional one
        this._cargoRecoverySummary = &quot;&quot;;
        if (result === false) {
            var eq;
            if (p.equipmentStatus(&quot;EQ_ESCAPE_POD&quot;) == &quot;EQUIPMENT_OK&quot;) {
                eq = EquipmentInfo.infoForKey(&quot;EQ_ESCAPE_POD&quot;);
                this._cargoRecoverySummary = &quot;some&quot;;
            }
            if (p.equipmentStatus(&quot;EQ_ESCAPE_POD_PLUS&quot;) == &quot;EQUIPMENT_OK&quot;) {
                eq = EquipmentInfo.infoForKey(&quot;EQ_ESCAPE_POD_PLUS&quot;)
                this._cargoRecoverySummary = &quot;most&quot;;
            }
            var tm = parseInt(eq.scriptInfo[&quot;max_rescue_time&quot;]);
            // set the amount of time for the rescue
            if (p.hasOwnProperty(&quot;escapePodRescueTime&quot;)) p.escapePodRescueTime = ((tm / 2) + (Math.random() * (tm / 2))) * 3600;
            this._repurchasePercent = parseFloat(eq.scriptInfo[&quot;repurchase_percent&quot;]);

            // grab a copy of all the cargo on board
            this._cargoRecovery.length = 0;
            var cr = parseFloat(eq.scriptInfo[&quot;cargo_recovery&quot;]);
            if (cr &gt; 0) {
                var t = 0;
                var m = p.manifest;
                if (m.list &amp;&amp; m.list.length &gt; 0) {
                    for (var i = 0; i &lt; m.list.length; i++) {
                        if (m.list[i].unit == &quot;t&quot; &amp;&amp; m.list[i].quantity &gt; 0) {
                            this._cargoRecovery.push(m.list[i]);
                            t += m.list[i].quantity;
                        }
                    }
                }
                var rm = parseInt((1 - cr) * t); // amount of cargo to remove
                if (rm &gt; 0) {
                    var pt = 0;
                    var end = false;
                    do {
                        if (this._cargoRecovery[pt].quantity &gt; 0) {
                            this._cargoRecovery[pt].quantity -= 1;
                            rm -= 1;
                        }
                        pt += 1;
                        if (pt &gt;= this._cargoRecovery.length) pt = 0;
                        if (rm &lt;= 0) end = true;
                    } while (end == false);
                } else {
                    this._cargoRecoverySummary = &quot;&quot;;
                    this._cargoRecovery.length = 0;
                }
            } else {
                this._cargoRecoverySummary = &quot;&quot;;
            }
        } else {
            // null out any gold, platinum and gems - they won&#39;t fit in the lifesuit
            this._cargoRecovery = [];
            p.manifest[&quot;gold&quot;] = 0;
            p.manifest[&quot;platinum&quot;] = 0;
            p.manifest[&quot;gem_stones&quot;] = 0;
            // manually remove passengers and parcels
            // remove parcels - these won&#39;t fit either
            for (var i = p.parcels.length - 1; i &gt;= 0; i--) {
                // tell player about this via an arrival report
                player.addMessageToArrivalReport(expandDescription(&quot;[parcel-lost]&quot;, {
                    name: p.parcels[i].name
                }));
                // send an email message for our special case
                var w = worldScripts.EmailSystem;
                if (w) {
                    var sndr = expandDescription(&quot;[parcel-contract-sender]&quot;);
                    var msg = expandDescription(&quot;[sr-parcel-contract-terminated]&quot;, {
                        contractname: p.parcels[i].name,
                        systemname: System.systemNameForID(p.parcels[i].destination),
                        time: global.clock.clockStringForTime(clock.seconds + p.parcels[i].eta)
                    });
                    var subj = expandDescription(&quot;[sr-parcel-contract-terminated-subject]&quot;);

                    w.$createEmail({
                        sender: sndr,
                        subject: subj,
                        date: global.clock.seconds,
                        message: msg,
                        expiryDays: worldScripts.GalCopAdminServices._defaultExpiryDays
                    });
                }

                var bb = worldScripts.BulletinBoardSystem;
                var cobb = worldScripts.ContractsOnBB;
                if (bb &amp;&amp; cobb) {
                    for (var j = 0; j &lt; bb._data.length; j++) {
                        var itm = bb._data[j];
                        if (itm != null &amp;&amp; itm.accepted === true) {
                            // is this item the one we&#39;re dealing with?
                            if (itm.destination === p.parcels[i].destination &amp;&amp; itm.payment === p.parcels[i].fee &amp;&amp; itm.source === p.parcels[i].start) {
                                bb.$removeBBMission(itm.ID);
                                break;
                            }
                        }
                    }
                }

                p.removeParcel(p.parcels[i].name);
                player.decreaseParcelReputation();
            }
            // remove passengers - they won&#39;t fit either
            var list = &quot;&quot;;
            var count = p.passengers.length;
            if (count &gt;= 1) {
                for (var i = count - 1; i &gt;= 0; i--) {
                    list += (list === &quot;&quot; ? &quot;&quot; : (i === count - 1 ? &quot; and &quot; : &quot;, &quot;)) + p.passengers[i].name;
                    // send an email message for our special case
                    var w = worldScripts.EmailSystem;
                    if (w) {
                        var sndr = expandDescription(&quot;[passenger-contract-sender]&quot;);
                        var msg = expandDescription(&quot;[sr-passenger-contract-terminated]&quot;, {
                            contractname: p.passengers[i].name,
                            systemname: System.systemNameForID(p.passengers[i].destination),
                            time: clock.clockStringForTime(clock.seconds + p.passengers[i].eta)
                        });
                        var subj = expandDescription(&quot;[sr-passenger-contract-terminated-subject]&quot;);

                        w.$createEmail({
                            sender: sndr,
                            subject: subj,
                            date: global.clock.seconds,
                            message: msg,
                            expiryDays: worldScripts.GalCopAdminServices._defaultExpiryDays
                        });
                    }

                    var bb = worldScripts.BulletinBoardSystem;
                    var cobb = worldScripts.ContractsOnBB;
                    if (bb &amp;&amp; cobb) {
                        for (var j = 0; j &lt; bb._data.length; j++) {
                            var itm = bb._data[j];
                            if (itm != null &amp;&amp; itm.accepted === true) {
                                // is this item the one we&#39;re dealing with?
                                if (itm.destination === p.passengers[i].destination &amp;&amp; itm.payment === p.passengers[i].fee &amp;&amp; itm.source === p.passengers[i].start) {
                                    bb.$removeBBMission(itm.ID);
                                    break;
                                }
                            }
                        }
                    }

                    p.removePassenger(p.passengers[i].name);
                    player.decreasePassengerReputation();
                }
                if (count &gt; 1) {
                    player.addMessageToArrivalReport(expandDescription(&quot;[passengers-lost]&quot;, {
                        names: list
                    }));
                } else {
                    player.addMessageToArrivalReport(expandDescription(&quot;[passenger-lost]&quot;, {
                        name: list
                    }));
                }
            }
        }
        if (this._debug) log(this.name, &quot;auto-ejecting...&quot;);
        p.abandonShip();
        if (sc) {
            sc._repairing = false;
            sc._adding = false;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.escapePodSequenceOver = function () {
    if (this._simulator) return;
    this._doRepurchase = true;
    // stop hull repairs from showing up
    if (missionVariables.BattleDamage_status != &quot;OK&quot;) missionVariables.BattleDamage_status = &quot;OK&quot;;
    if (system.isInterstellarSpace) {
        this._interstellarRecovery = true;
        this._cargoRecovery.length = 0; // no cargo recovery in interstellar space
        this._cargoRecoverySummary = &quot;&quot;;
        // only continue if IST is not installed - it will control the recovery chance and end-point
        if (!worldScripts[&quot;IST_masterScript&quot;]) {
            if (system.stations.length &gt; 0) {
                // similar logic as for IST
                // naval rescue - near
                if (this._debug === true || Math.random() &lt;= 0.8) {
                    var navalCarriers = system.filteredEntities(this, this.$isNavalCarrier, player.ship, 30000);
                    if (navalCarriers.length &gt; 0) {
                        player.setEscapePodDestination(navalCarriers[0]);
                        return;
                    }
                }
                // naval rescue - further away
                if (this._debug === true || Math.random() &lt;= 0.4) {
                    navalCarriers = system.filteredEntities(this, this.$isNavalCarrier, player.ship, 100000);
                    if (navalCarriers.length &gt; 0) {
                        player.setEscapePodDestination(navalCarriers[0]);
                        return;
                    }
                }
                // other station types (eg Erehwon)
                if (this._debug === true || Math.random() &lt;= 0.4) {
                    var nonNavalCarriers = system.filteredEntities(this, this.$isNotNavalCarrier, player.ship, 200000);
                    if (nonNavalCarriers.length &gt; 0) player.setEscapePodDestination(nonNavalCarriers[0]);
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function (equipmentKey) {
    if (equipmentKey === &quot;EQ_REPURCHASE_INSURANCE&quot;) this._insuranceDate = clock.adjustedSeconds;
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
    // check if our insurance has lapsed
    if (this._insuranceDate != 0 &amp;&amp; (clock.adjustedSeconds - this._insuranceDate) &gt; (86400 * 60) &amp;&amp; this._doRepurchase === false) {
        player.ship.removeEquipment(&quot;EQ_REPURCHASE_INSURANCE&quot;);
        this._insuranceDate = 0;
        mission.runScreen({
            screenID: &quot;oolite-insurance-expiry-map&quot;,
            title: &quot;Repurchase Insurance&quot;,
            overlay: {
                name: &quot;shiprepurchase_logo.png&quot;,
                height: 546
            },
            message: expandDescription(&quot;[insurance_lapsed]&quot;),
            exitScreen: &quot;GUI_SCREEN_STATUS&quot;
        });
        return;
    }
    if (this._passengerList &amp;&amp; this._passengerList.length &gt; 0) {
        if (this._passengerList.length &gt; 1) {
            // more than 1 passenger
            var list = &quot;&quot;;
            for (var i = 0; i &lt; this._passengerList.length; i++) {
                list += (list === &quot;&quot; ? &quot;&quot; : (i === this._passengerList.length - 1 ? &quot; and &quot; : &quot;, &quot;)) + this._passengerList[i];
                player.decreasePassengerReputation();
            }
            mission.runScreen({
                screenID: &quot;oolite-passengers-stranded-map&quot;,
                title: &quot;Passengers&quot;,
                message: expandDescription(&quot;[passengers-stranded]&quot;, {
                    names: list,
                    location: system.name
                }),
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;
            });
        } else {
            // just 1 passenger
            player.decreasePassengerReputation();
            mission.runScreen({
                screenID: &quot;oolite-passenger-stranded-map&quot;,
                title: &quot;Passengers&quot;,
                message: expandDescription(&quot;[passenger-stranded]&quot;, {
                    name: this._passengerList[0],
                    location: system.name
                }),
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;
            });
        }
        this._passengerList.length = 0;
        return;
    }
    // have we been rescued in interstellar space?
    if (this._interstellarRecovery === true) {
        this._interstellarRecovery = false;
        // turn on the interstellar mode
        this._interstellarMode = true;
        // turn off the standard repurchase screen
        this._doRepurchase = false;
        var p = player.ship;
        var hud = p.hud;
        var eq = p.equipment;
        // populate the portable list
        this._portable.length = 0;
        for (var i = 0; i &lt; eq.length; i++) {
            var item = eq[i];
            if (item.isPortableBetweenShips === true) this._portable.push(item.equipmentKey);
        }
        this.$rememberPassengers();
        // switch to the &quot;loaner&quot;
        player.replaceShip(this._interstellarFreeShip.key);
        // portable equipment is not automatically transferred if the shipkey changes
        this.$addPortable();
        p.serviceLevel = 75;
        p.hud = hud;
        if (p.dockedStation.isPolice) {
            mission.runScreen({
                screenID: &quot;oolite-naval-recovery-map&quot;,
                title: &quot;Naval Command&quot;,
                message: expandDescription(&quot;[interstellar_rescue_navy]&quot;, {
                    shiptype: this._interstellarFreeShip.name
                }),
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;
            });
        } else {
            // a non-police/navy station in interstellar space
            mission.runScreen({
                screenID: &quot;oolite-interstellar-recovery-map&quot;,
                title: &quot;Station Control&quot;,
                message: expandDescription(&quot;[interstellar_rescue_normal]&quot;, {
                    shiptype: this._interstellarFreeShip.name
                }),
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;
            });
        }
        return;
    }
    // are we doing the repurchase process now?
    if (this._doRepurchase === true) {
        this._doRepurchase = false;
        this.$showRepurchaseScreen();
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
    if (this.$simulatorRunning()) {
        this._simulator = true;
        return;
    }
    this._simulator = false;

    // what&#39;s our repurchase percentage? make an initial setting here but we&#39;ll recheck before an auto-eject
    var p = player.ship;
    this._repurchasePercent = 0.1;
    if (p.equipmentStatus(&quot;EQ_ESCAPE_POD&quot;) == &quot;EQUIPMENT_OK&quot;) this._repurchasePercent = parseFloat(EquipmentInfo.infoForKey(&quot;EQ_ESCAPE_POD&quot;).scriptInfo[&quot;repurchase_percent&quot;]);
    if (p.equipmentStatus(&quot;EQ_ESCAPE_POD_PLUS&quot;) == &quot;EQUIPMENT_OK&quot;) this._repurchasePercent = parseFloat(EquipmentInfo.infoForKey(&quot;EQ_ESCAPE_POD_PLUS&quot;).scriptInfo[&quot;repurchase_percent&quot;]);;
    if (worldScripts.ShipConfiguration_Armour) {
        this._scTimer = new Timer(this, this.$getSCArmour, 0.5, 0);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$getSCArmour = function $getSCArmour() {
    var p = player.ship;
    this._holdSCAArmourFrontType = p.script._frontArmourType;
    this._holdSCAArmourAftType = p.script._aftArmourType;
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
    // check if we&#39;ve been recovered in interstellar space, and if so, turn on the repurchase screen
    if (this._interstellarMode === true) {
        // in case we have a misjump in interstellar space
        if (system.isInterstellarSpace === false) this._doRepurchase = true;
        return;
    }

    // store ship and equipment (but not cargo) in case we need it later
    // but only if we&#39;re not already in interstellar recovery mode
    var shipinfo = worldScripts[&quot;Ship_Storage_Helper.js&quot;].storeCurrentShip();
    var data = JSON.parse(shipinfo);
    data[8].length = 0; // remove any cargo
    data[10].length = 0; // remove any passengers
    this._storedShip = JSON.stringify(data);
}

//-------------------------------------------------------------------------------------------------------------
this.$showRepurchaseScreen = function $showRepurchaseScreen() {
    // at this point we should have a new ship + equipment (damaged or otherwise) to work with
    // calculate cost of replacement ship + equipment
    var p = player.ship;
    var col1 = 22;
    var col2 = 32 - col1;
    p.hudHidden = true;

    // store the current list of player roles
    this._roles = [];
    for (var i = 0; i &lt; p.roleWeights.length; i++) {
        this._roles.push(p.roleWeights[i]);
    }

    // check for an interstellar mode recovery
    if (system.isInterstellarSpace === false &amp;&amp; this._interstellarMode === true &amp;&amp; this._storedShip != &quot;&quot;) {
        var lmss = worldScripts.LMSS_Core;
        if (lmss) lmss._switching = true;
        // restore the players original ship
        worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(this._storedShip);
        this._storedShip = &quot;&quot;;
        if (lmss) lmss._switching = false;
    }

    // first, repair everything, so the ship price will be accurate
    var eq = p.equipment;
    this._portable.length = 0;
    for (var i = 0; i &lt; eq.length; i++) {
        var item = eq[i];
        var sts = &quot;&quot;;
        var count = 0;
        var m_sts = p.equipmentStatus(item.equipmentKey, true);
        if (m_sts[&quot;EQUIPMENT_DAMAGED&quot;] &gt; 0) {
            sts = &quot;EQUIPMENT_DAMAGED&quot;;
            count = m_sts[&quot;EQUIPMENT_DAMAGED&quot;];
        }
        if (sts === &quot;EQUIPMENT_DAMAGED&quot;) {
            var autoRepair = this._autoRepairMinTL[item.equipmentKey];
            if (!autoRepair || parseInt(autoRepair) &lt;= p.dockedStation.equivalentTechLevel) {
                for (var j = 1; j &lt;= count; j++) {
                    p.setEquipmentStatus(item.equipmentKey, &quot;EQUIPMENT_OK&quot;);
                }
            }
        }
        if (item.isPortableBetweenShips === true) this._portable.push(item.equipmentKey);
    }
    // repair any ship config armour
    if (worldScripts.ShipConfiguration_Armour) {
        if (this._holdSCAArmourFrontType != &quot;&quot;) {
            if (p.equipmentStatus(this._holdSCAArmourFrontType) != &quot;EQUIPMENT_OK&quot;) p.awardEquipment(this._holdSCAArmourFrontType);
            p.script._armourFront = 100;
        }
        if (this._holdSCAArmourAftType != &quot;&quot;) {
            if (p.equipmentStatus(this._holdSCAArmourAftType) != &quot;EQUIPMENT_OK&quot;) p.awardEquipment(this._holdSCAArmourAftType);
            p.script._armourAft = 100;
        }
    }
    // battle damage OXP
    if (worldScripts[&quot;Battle Damage&quot;]) {
        p.awardEquipment(&quot;EQ_HULL_REPAIR&quot;);
        missionVariables.BattleDamage_status = &quot;OK&quot;;
    }

    // get the cost
    this._fullShipCost = p.price;

    if (this._overrideBasePrice[p.name]) {
        this._baseShipCost = this._overrideBasePrice[p.name];
        // if we needed to override the price, we should update the full ship/equipment price as well
        var sd = Ship.shipDataForKey(p.dataKey);
        if (sd._oo_shipyard) {
            var base = sd._oo_shipyard.price;
            this._fullShipCost = (this._fullShipCost - base) + this._baseShipCost;
        }
    } else {
        var sd = Ship.shipDataForKey(p.dataKey);
        if (sd._oo_shipyard) {
            this._baseShipCost = sd._oo_shipyard.price;
        } else {
            sd = this.$getShipDataEntryWithShipyard(p.name);
            if (sd) {
                this._baseShipCost = sd._oo_shipyard.price;
            } else {
                // this should never happen, but, you know...
                log(this.name, &quot;!!ERROR: Unable to find valid shipyard price value for shipkey &quot; + p.dataKey);
                this._baseShipCost = p.price;
            }
        }
    }

    var ins = false;
    if (this._repurchasePercent &lt; 0.1) {
        if (p.equipmentStatus(&quot;EQ_REPURCHASE_INSURANCE&quot;) === &quot;EQUIPMENT_OK&quot;) ins = true;
    }

    var repurchase = this._fullShipCost * (this._repurchasePercent * this.$calculatePremium());
    if (ins &amp;&amp; player.score &gt;= this._jamesonPoint) repurchase = 1000;
    if (player.score &lt; this._jamesonPoint) repurchase = 200;

    var curChoices = {};
    var text = &quot;Current credit balance: &quot; + formatCredits(player.credits, true, true) + &quot;\n\n&quot;;

    if (this._interstellarMode === false) {
        text += &quot;Your ship has been destroyed. &quot;;
    } else {
        text += &quot;We have received word that your ship was destroyed in interstellar space. &quot;;
    }
    text += &quot;Please select your preferred ship repurchase option:&quot;;
    if (this._cargoRecoverySummary != &quot;&quot;) {
        text += &quot;\n\nNote: All repurchase options include the recovery of &quot; + this._cargoRecoverySummary + &quot; of your cargo.&quot;;
    }
    var label = &quot;Current ship&quot;;
    if (this._interstellarMode === true) label = &quot;Original ship&quot;;

    curChoices[&quot;01_CURRENT&quot;] = {
        text: this.$padTextRight(label + &quot; (&quot; + p.shipClassName + &quot;) with all equipment&quot;, col1) +
            this.$padTextLeft((repurchase === 0 ? &quot;free&quot; : formatCredits(repurchase, true, true)), col2),
        unselectable: (player.credits &gt;= repurchase ? false : true)
    };

    this._freePick1 = null;
    this._freePick2 = null;
    var types = Object.keys(this._freeShipTrader);
    for (var i = 0; i &lt; types.length; i++) {
        if (parseInt(types[i]) &lt; this._baseShipCost &amp;&amp; this._freePick1 == null &amp;&amp; this._freeShipTrader[types[i]].name != p.shipClassName) {
            this._freePick1 = this._freeShipTrader[types[i]];
        }
    }
    // if we didn&#39;t get a hit, just choose the lowest value one (Adder)
    if (this._freePick1 == null) {
        this._freePick1 = this._freeShipTrader[types[types.length - 1]];
    } else {
        var types = Object.keys(this._freeShipHunter);
        for (var i = 0; i &lt; types.length; i++) {
            if (parseInt(types[i]) &lt; this._baseShipCost &amp;&amp; this._freePick2 == null &amp;&amp; this._freeShipHunter[types[i]].name != p.shipClassName) {
                this._freePick2 = this._freeShipHunter[types[i]];
            }
        }
        // if they&#39;re the same, just show first one
        if (this._freePick2 != null &amp;&amp; this._freePick2.name == this._freePick1.name) this._freePick2 = null;
    }

    // if the player is already in an adder, we have to show a free Adder as a replacement
    // so don&#39;t show a &quot;ship only&quot; repurchase option if we&#39;re going to offer a free one anyway
    if (p.shipClassName != &quot;Adder&quot;) {
        var baseRepurchase = this._baseShipCost * (this._repurchasePercent * this.$calculatePremium());
        if (ins &amp;&amp; player.score &gt;= this._jamesonPoint) baseRepurchase = 500;
        if (player.score &lt; this._jamesonPoint) baseRepurchase = 100;

        curChoices[&quot;01_CURRENT_BASE&quot;] = {
            text: this.$padTextRight(&quot;Stock model of &quot; + label.toLowerCase() + &quot; (&quot; + p.shipClassName + &quot;)&quot;, col1) +
                this.$padTextLeft((baseRepurchase === 0 ? &quot;free&quot; : formatCredits(baseRepurchase, true, true)), col2),
            unselectable: (player.credits &gt;= baseRepurchase ? false : true)
        }
    }

    // a stock stepdown is always free
    curChoices[&quot;04_BASE_SHIP&quot;] = {
        text: this.$padTextRight(&quot;Stock &quot; + this._freePick1.name, col1) +
            this.$padTextLeft(&quot;free&quot;, col2),
        unselectable: false
    };
    if (this._freePick2 != null) {
        curChoices[&quot;04_BASE_SHIP2&quot;] = {
            text: this.$padTextRight(&quot;Stock &quot; + this._freePick2.name, col1) +
                this.$padTextLeft(&quot;free&quot;, col2),
            unselectable: false
        }
    }

    var opts = {
        screenID: &quot;oolite-shiprepurchase-details-map&quot;,
        title: &quot;Ship Repurchase Options&quot;,
        overlay: {
            name: &quot;shiprepurchase_logo.png&quot;,
            height: 546
        },
        allowInterrupt: false,
        exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
        choices: curChoices,
        initialChoicesKey: &quot;01_CURRENT&quot;,
        message: text
    };

    mission.runScreen(opts, this.$screenHandler, this);

    this._interstellarMode = false;
}

//-------------------------------------------------------------------------------------------------------------
this.$screenHandler = function $screenHandler(choice) {
    var p = player.ship;
    var hud = p.hud;
    p.hudHidden = false;

    var ins = false;
    if (this._repurchasePercent &lt; 0.1) {
        if (p.equipmentStatus(&quot;EQ_REPURCHASE_INSURANCE&quot;) === &quot;EQUIPMENT_OK&quot;) ins = true;
    }

    if (choice === &quot;01_CURRENT&quot;) {
        // nothing to do for this option: current ship and equipment should already be present.
        var repurchase = (this._fullShipCost * (this._repurchasePercent * this.$calculatePremium()));
        if (ins &amp;&amp; player.score &gt;= this._jamesonPoint) {
            repurchase = 1000;
            p.removeEquipment(&quot;EQ_REPURCHASE_INSURANCE&quot;);
        }
        if (player.score &lt; this._jamesonPoint) repurchase = 200;
        player.credits -= repurchase;
        p.serviceLevel = 95; // replacement ship shouldn&#39;t need to be serviced any time soon.
        player.consoleMessage(formatCredits(repurchase, true, true) + &quot; has been deducted from your account.&quot;);
    } else {
        // make a note of any passengers who will be getting dumped here.
        this.$rememberPassengers();

        // remove any secondary lasers
        if (worldScripts.LMSS_Core) {
            var lmss = worldScripts.LMSS_Core;
            if (lmss._forwardAltKey &amp;&amp; lmss._forwardAltKey != &quot;EQ_WEAPON_NONE&quot;) lmss._forwardAltKey = &quot;EQ_WEAPON_NONE&quot;;
            if (lmss._aftAltKey &amp;&amp; lmss._aftAltKey != &quot;EQ_WEAPON_NONE&quot;) lmss._aftAltKey = &quot;EQ_WEAPON_NONE&quot;;
            if (lmss._portAltKey &amp;&amp; lmss._portAltKey != &quot;EQ_WEAPON_NONE&quot;) lmss._portAltKey = &quot;EQ_WEAPON_NONE&quot;;
            if (lmss._starboardAltKey &amp;&amp; lmss._starboardAltKey != &quot;EQ_WEAPON_NONE&quot;) lmss._starboardAltKey = &quot;EQ_WEAPON_NONE&quot;;
        }
        // do we need to clean up any other 3rd party packs that have data stored in mission or local variables?
        // note: some base models come with an escape pod - should we remove it after changing the player ship?

        var cost = this._baseShipCost;
        if (choice === &quot;01_CURRENT_BASE&quot;) {
            player.replaceShip(p.dataKey, p.entityPersonality);
            var deduct = (cost * (this._repurchasePercent * this.$calculatePremium()));
            if (ins &amp;&amp; player.score &gt;= this._jamesonPoint) {
                deduct = 500;
                p.removeEquipment(&quot;EQ_REPURCHASE_INSURANCE&quot;);
            }
            if (player.score &lt; this._jamesonPoint) deduct = 100;
            player.credits -= deduct;
            p.serviceLevel = 95; // replacement ship shouldn&#39;t need to be serviced any time soon.
            player.consoleMessage(formatCredits(deduct, true, true) + &quot; has been deducted from your account.&quot;);
        }

        if (choice === &quot;04_BASE_SHIP&quot;) {
            player.replaceShip(this._freePick1.key);
            p.serviceLevel = 95; // replacement ship shouldn&#39;t need to be serviced any time soon.
            // portable equipment is not automatically transferred if the shipkey changes
            this.$addPortable();
        }
        if (choice === &quot;04_BASE_SHIP2&quot;) {
            player.replaceShip(this._freePick2.key);
            p.serviceLevel = 95; // replacement ship shouldn&#39;t need to be serviced any time soon.
            // portable equipment is not automatically transferred if the shipkey changes
            this.$addPortable();
        }

        p.hud = hud;
    }

    // restore any recovered cargo
    this.$restoreCargo();
    // make sure the player has a complimentary fuel load
    p.fuel = 7;

    // add the date to our array here, so that it&#39;s only amended after the replacement is bought
    if (player.score &gt;= this._jamesonPoint) this._lastEjectDates.push(this._ejectDate);

    // restore the previous list of roles
    for (var i = 0; i &lt; p.roleWeights.length; i++) {
        if (this._roles.length - 1 &gt;= i) p.setPlayerRole(this._roles[i], i);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$addPortable = function $addPortable() {
    if (this._portable.length &gt; 0) {
        var p = player.ship;
        for (var i = 0; i &lt; this._portable.length; i++) {
            p.awardEquipment(this._portable[i]);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$restoreCargo = function $restoreCargo() {
    if (this._cargoRecovery.length &gt; 0) {
        var p = player.ship;
        var m = p.manifest;
        for (var i = 0; i &lt; this._cargoRecovery.length; i++) {
            m[this._cargoRecovery[i].commodity] += this._cargoRecovery[i].quantity;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$calculatePremium = function $calculatePremium() {
    if (this._applyPenalty == false) {
        return 1;
    } else {
        // how many times has the player ejected in period?
        var period = 365;
        // get a period based on the player score.
        var keys = Object.keys(this._periodLevels);
        for (var i = 0; i &lt; keys.length; i++) {
            if (player.score &gt;= parseInt(keys[i])) {
                period = parseInt(this._periodLevels[keys[i]]);
            }
        }
        var mth = clock.adjustedSeconds - (86400 * period);
        var count = 0;
        if (this._lastEjectDates.length &gt; 0) {
            for (var i = 0; i &gt; this._lastEjectDates.length; i++) {
                if (this._lastEjectDates[i] &gt; mth) count += 1;
            }
        }
        // return a (1.n) value as a multiplier
        var result = 1 + ((count * 2) / 10);
        return result;
    }
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function $padTextRight(currentText, desiredLength, leftSwitch) {
    if (currentText == null) currentText = &quot;&quot;;
    var hairSpace = String.fromCharCode(31);
    var ellip = &quot;…&quot;;
    var currentLength = defaultFont.measureString(currentText.replace(/%%/g, &quot;%&quot;));
    var hairSpaceLength = defaultFont.measureString(hairSpace);
    // calculate number needed to fill remaining length
    var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
    if (padsNeeded &lt; 1) {
        // text is too long for column, so start pulling characters off
        var tmp = currentText;
        do {
            tmp = tmp.substring(0, tmp.length - 2) + ellip;
            if (tmp === ellip) break;
        } while (defaultFont.measureString(tmp.replace(/%%/g, &quot;%&quot;)) &gt; desiredLength);
        currentLength = defaultFont.measureString(tmp.replace(/%%/g, &quot;%&quot;));
        padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
        currentText = tmp;
    }
    // quick way of generating a repeated string of that number
    if (!leftSwitch || leftSwitch === false) {
        return currentText + new Array(padsNeeded).join(hairSpace);
    } else {
        return new Array(padsNeeded).join(hairSpace) + currentText;
    }
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function $padTextLeft(currentText, desiredLength) {
    return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
// routine to check the combat simulator worldscript, to see if it&#39;s running or not
this.$simulatorRunning = function $simulatorRunning() {
    var w = worldScripts[&quot;Combat Simulator&quot;];
    if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) return true;
    return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$isNavalCarrier = function $isNavalCarrier(e) {
    return e.isShip &amp;&amp; e.isPolice &amp;&amp; e.isStation;
}

//-------------------------------------------------------------------------------------------------------------
this.$isNotNavalCarrier = function $isNotNavalCarrier(e) {
    return e.isShip &amp;&amp; !e.isPolice &amp;&amp; e.isStation &amp;&amp; !e.hasRole(&quot;generationship&quot;) &amp;&amp; (e.allegiance == null || e.allegiance != &quot;thargoid&quot;);
}

//-------------------------------------------------------------------------------------------------------------
// gets a list of all the current passenger names
this.$rememberPassengers = function $rememberPassengers() {
    var p = player.ship;
    if (p.passengers.length &gt; 0) {
        this._passengerList = [];
        for (var i = 0; i &lt; p.passengers.length; i++) {
            this._passengerList.push(p.passengers[i].name);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// finds a shipdata entry that has a corresponding shipyard value, so we can get an accurate base ship cost
this.$getShipDataEntryWithShipyard = function $getShipDataEntryWithShipyard(shipName) {
    var keys = Ship.keysForRole(&quot;player&quot;);
    for (var i = 0; i &lt; keys.length; i++) {
        var sd = Ship.shipDataForKey(keys[i]);
        if (sd.name === shipName) {
            // did we find a match that has a shipyard entry?
            if (sd._oo_shipyard) return sd;
        }
    }
    return null;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/repurchase_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;ShipRepurchase_Conditions&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2017 phkb&quot;;
this.description = &quot;Condition script for determining whether to include the &#39;Repurchase Insurance&#39; item on the F3 screen&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function (equipment, ship, context) {
	if (context === &quot;scripted&quot;) return true;
	if (equipment == &quot;EQ_REPURCHASE_INSURANCE&quot;) {
		if (player.ship.dockedStation.allegiance != &quot;galcop&quot;) return false;
	}
	// otherwise allowed
	return true;
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
