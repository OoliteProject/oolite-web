<html>
    <head>
        <title>Expansion Market Ads</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Market Ads</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Enhances the market screen by showing ads when docked.</td>
                    <td>Enhances the market screen by showing ads when docked.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.spara.market_ads</td>
                    <td>oolite.oxp.spara.market_ads</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Market Ads</td>
                    <td>Market Ads</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ambiance</td>
                    <td>Ambiance</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>spara</td>
                    <td>spara</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.0</td>
                    <td>1.0</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/MarketObserver">http://wiki.alioth.net/index.php/MarketObserver</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/1/1f/Market_ads_1.0.oxz">https://wiki.alioth.net/img_auth.php/1/1f/Market_ads_1.0.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873245</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Market%20Ads'>http://wiki.alioth.net/index.php/Market%20Ads</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/market_ads.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name = &quot;market_ads&quot;;
this.author = &quot;spara&quot;;
this.description = &quot;Add ads to the market screen when docked&quot;;

this.startUp = function() {
	this.$marketHud = &quot;market_ads_hud.plist&quot;;//init market hud
	this.$restoreHud = player.ship.hud;//init restore hud
	this.$restoreTargetSensitivity = player.ship.reticleTargetSensitive;//for restoring target sensivity
}

this.guiScreenChanged = function(to, from) {
	//no ads in-flight
	if (!player.ship.docked) return;
	if (guiScreen.indexOf(&quot;GUI_SCREEN_MARKET&quot;) !== -1) { //swap to market hud
		if (player.ship.hud !== this.$marketHud) {
			this.$restoreHud = player.ship.hud;
			this.$restoreTargetSensitivity = player.ship.reticleTargetSensitive;
		}
		
		//set ads &amp; swap hud
		var adService = worldScripts[&quot;market_ads_service&quot;];
		var leftAd = adService._getHorizontalAd();
		var rightAd = adService._getHorizontalAd();
		
		player.ship.setCustomHUDDial(&quot;marketAdLeft&quot;, leftAd);
		player.ship.setCustomHUDDial(&quot;marketAdRight&quot;, rightAd);
		
		player.ship.hud = this.$marketHud;
	} 
	//restore hud
	else if (player.ship.hud === this.$marketHud) {
		player.ship.hud = this.$restoreHud;
		player.ship.reticleTargetSensitive = this.$restoreTargetSensitivity;
	}
}

</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/market_ads_service.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;market_ads_service&quot;; 
this.author      = &quot;spara&quot;;
this.description = &quot;Pooling ad service&quot;;

this.$horzAdPool = [];

//public function for adding horizontal ad to pool. the parameter is the filename of the ad.
this._setHorzAd = function(ad) {
  this.$horzAdPool.push(ad);
}

this.startUp = function() {
  //add horizontal ads to pools
  for (var i = 1; i &lt;= 379; i++) {
    this.$horzAdPool.push(&quot;market_ad_horz_&quot; + i + &quot;.png&quot;);
  }
}

this.startUpComplete = function() {
  //shuffle the pools
  this.$horzAdPool = this._shuffle(this.$horzAdPool);
  
	//Pools are divided to two parts to prevent the same ad to be seen in a quick succession. Pools are split into two parts and a primary part is randomly selected. When the active part is emptied, then the secondary part is used. When that is emptied too, pool is initialized and we draw from the primary part again.

  this._initHorzPool();
	this.$horzPrimary = Math.round(Math.random());
}

this._shuffle = function(pool) {
  var shuffled = new Array();
  var poolSize = pool.length;
  for (var i = poolSize; i &gt; 0; i--) {
    shuffled.push(pool.splice(Math.floor(Math.random() * i), 1)[0]);
  }
  return shuffled;
}

this._initHorzPool = function() {
	var horzPoolSize = this.$horzAdPool.length;
  this.$horzPool = [this.$horzAdPool.slice(0, Math.floor(horzPoolSize / 2)), this.$horzAdPool.slice(Math.ceil(horzPoolSize / 2), horzPoolSize - 1)];
}

//public function that returns a random horizontal ad filename from the pool
this._getHorizontalAd = function() {
	if (this.$horzPool[this.$horzPrimary].length === 0) {
		this.$horzPrimary = (this.$horzPrimary + 1) % 2;
		if (this.$horzPool[this.$horzPrimary].length === 0) {
			this._initHorzPool();
		};
	};
	var adNum = Math.floor(Math.random() * this.$horzPool[this.$horzPrimary].length);
	return this.$horzPool[this.$horzPrimary].splice(adNum, 1)[0];
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
