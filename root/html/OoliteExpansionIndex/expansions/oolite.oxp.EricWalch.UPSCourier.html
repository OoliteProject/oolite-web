<html>
    <head>
        <title>Expansion UPS Courier</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion UPS Courier</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">6 Equipment</a></li>
          <li><a href="#ships">91 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">40 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Description mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.EricWalch.UPSCourier</td>
                    <td>oolite.oxp.EricWalch.UPSCourier</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>UPS Courier</td>
                    <td>UPS Courier</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Missions</td>
                    <td>Missions</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Eric Walch, spara, Keeper, phkb, Rorschachhamster</td>
                    <td>Eric Walch, spara, Keeper, phkb, Rorschachhamster</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>2.1.1</td>
                    <td>2.1.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Svengali.Snoopers:2.5</li>
                            <li>oolite.oxp.Svengali.GNN:1.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Svengali.Snoopers:2.5</li>
                            <li>oolite.oxp.Svengali.GNN:1.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/8/8e/UPS_Courier.oxz">https://wiki.alioth.net/img_auth.php/8/8e/UPS_Courier.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-SA 3.0</td>
                    <td>CC-BY-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873363</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/UPS%20Courier'>http://wiki.alioth.net/index.php/UPS%20Courier</a></p>
        <h3>readme.txt</h3>
        <pre>Universe Parcel Shipment - courier (version 2.0)

An add-on for Oolite by Giles Williams.
Based on the good old &quot;Elite&quot; by Ian Bell and David Braben.

Intro
=====
In the universe there is a lot of commercial traffic. Goods and documents are transported from one solar system to the other system. Like transportation on earth, only a small number of the jobs are offered on the open market. Almost everybody can accept such free contracts provided their ship has the right cargo capacity.
However, most of the lucrative transport jobs aren&#39;t offered on the open market. You have to use connections to gain such contracts.

UPS is only one of the many organization in the universe for delivering goods between planet systems. Normally they use their own ships and pilots. On rare occasions they ask strangers to do some deliveries for them. If they do it well, the chance of getting more offers increases. Only the very skilled pilots get the best offers. UPS is present in the whole universe with business points in every solar-system with a political level of Multi-Government and higher. They don&#39;t have their own combat ships to protect their transport ships, but rely on police and occasionally on independent fighters like yourself.

Earning money is hard and competition is strong in the universe. For regular transport missions UPS pays very little. If you don&#39;t find the payment enough, go to the passenger / cargo contract market - you might find a better offer there. But bear in mind: For their regular delivery pilots UPS sometimes has very good paying jobs to offer.

The UPS Courier OXP
===================
This OXP adds several random mission that can run simultaneously - up to 5 missions active at once. The first set of missions offered are mainly various transport missions. After you complete enough transport missions, a series of combat jobs is offered, but the main focus of the OXP stays with friendly transports. You can view these missions as more advanced versions of the Passenger/Cargo contracts that are offered via the F4 interface screens. Unlike most mission OXP&#39;s that offer a story that is only run once, this OXP will continually offer random missions, but with a low probability of appearing. You will get an end message when the last type of regular combat mission has successfully ended and nothing new is to be expected. There could still be some small variations on existing missions. The OXP itself never ends as long as it stays in the AddOns folder of Oolite.

When you remove the OXP from the AddOns folder, the last settings of the mission variables stay in your saved file, doing nothing. The only thing that does not disappear is the mission destination in the long-range-galaxy chart. (red cross). If you put the OXP again in place, the missions goes on were you left them (or the missions are reset if you switched galaxies).

Most missions only work as long one stays in the galaxy where the mission is accepted. On intergalactic jumps those mission are aborted as there is no solution in the new galaxy, but a new mission will be presented in the new galaxy soon enough. So intergalactic jumping in the middle of a mission should do no real harm.
Because of the nature of this OXP you can leave it in place and forget about it. It should be compatible with most other mission OXP&#39;s.

All missions start at random, but the first mission will start in a democratic system with a 20% chance. All missions are rare, so you better focus on something else and let yourself be surprised by the offers. During the game it is always safe to refuse a mission if you have better things to do. The mission, or a similar one, will be offered again later on. Most missions have a counter which can come into play where new types of missions are only available after you have completed a certain number of the old ones.

Some missions have a time limit, others only claim that there is urgency but the time only starts on entering the target system. If there is a time limit, the Oolite clock will be used. Be aware that hyperspace jumps take more time if the jump is over a longer distance. So jumping a certain distance in one big jump takes significantly more oolite-time than traveling the same distance with two smaller jumps. 

Transport reputation
--------------------
Couriers with a good reputation are more likely to get an offer for a new mission. For transporting documents you don&#39;t need a good reputation but you do need at least a good reputation to get parcel transport offers. The variable to keep track of the reputation is the same as that used by Oolite itself for the built-in transport reputation. So you can also increase your reputation by taking these transport missions. It is even advisable to do some regular cargo transports frequently because this reputation erodes with time, so completing transport missions will maintain your reputation. Your current reputation is also dependent on the system you are in and will be shown at the F5/F5 screen.

Other OXP&#39;s
-----------
This oxp checks for &quot;Transports.OXP&quot; or &quot;Dictators.OXP&quot; being installed. When a version of those is present, UPS couriers uses some of these ships instead of generic ships. It is not necessary to have them installed.

Performance
-----------
Because it is intended that this OXP always stays active, great effort is taken to reduce the amount of computing. It will only do its necessary computing when missions are busy. It will add no additional ships when no mission is active. Later on in the game, some custom ships may appear without a mission active, but these ships are selected by the system instead of a default ship and don&#39;t add additional ships to a system. Controlling files of custom ships take no more calculation power than standard ships. So from performance point of view, there is no reason to remove this OXP with other OXP&#39;s active.

Mission groups
==============
Document missions: Several missions involving document transportation.
Parcel missions: Several missions involving parcel transportation.
Container missions: Several missions involving combat.
Solar missions: Several missions around a solar station.
Slave missions: Several missions involving rescuing slaves.

Some of these missions are triggered by parts of other mission groups. All mission groups have their own mission descriptions and can run simultaneously. Within a mission group there can only be one mission active.

Version requirements
====================
This OXP runs in every galaxy and with every combat rating. However, with higher combat ratings the chances rise to get more opponents in combat.
UPS version 2.0 requires the features added with Oolite 1.82.

Eric Walch,
Raalte, the Netherlands

Former player of Elite on a Commodore 64 in another universe and another century.

I can be contacted as member at: http://aegidian.org/bb
Information and discussion about the original OXP (pre v1.9) can be found on: http://oolite.aegidian.org/bb/viewtopic.php?f=4&amp;t=3814
Information and discussion about spara&#39;s 1.9 version can be found on: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=16379
Information and discussion about the newer OXP (2.0ff) can be found on: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=18520
The latest version is available at the Wiki page: http://wiki.alioth.net/index.php/UPS_Courier

Copyright notes
Copyright 2008-2013 by Eric Walch
UPS Courier is distributed under the Creative Commons Attribution-Noncommercial-Share Alike license, version 3.0 or later.
Please visit http://creativecommons.org/licenses/by-nc-sa/3.0/ for more info.

Version history
1.0     Initial release with document, parcel, container and solar missions.
1.1     Added restart of trumble-mission.
        Added slave mission. (this mission needs oolite version 1.65 or newer to be offered)
        Made sure no ships are unintended placed in witchspace during misjump.
1.1.1   Added one new mission to the slavemissions.
1.1.2   Fixed unwanted ship launching from special stations under oolite 1.69
1.1.3   Added a non-combat mission in the container series.
        Increased minimum Oolite version to 1.63 to allow for consoleMessages.
        Distinguishing between player and NPC scooping of scripted cargopods.
        Fixed bug in trumble restart not always working.
1.2     Added a mining mission in the document series.
        Changed the behaviour of the ships in the slave mission that was added in version 1.1.1
        Made some opponents stronger after several encounters.
        Added two pieces of equipment buyable by the player. For the private escorts you must have scored a lot of mission points. 
        The other is a scanner and only comes available to elite players that completed the last mission for at least the second time. 
        Just two fun things to waist your money on.
1.2.1   Added the &quot;no_boulder&quot; key that was introduced in Oolite 1.70
        Restructuring of the code for speed performance. As little as possible conditions are evaluated at idle time.
        Removed a bug introduced in version 1.1.3 that certain missions in the container series prevented from happening.
1.2.2   UPS deliveries now also count for the overall players transport reputation.
        Bugfix in the 2nd container mission. But was introduced in version 1.2.1
1.2.3   AI improvements off several ships and introduced java scripting for some ships. 
        (they fall back on the legacy scripting when running on a pre 1.70 Oolite version)
1.3     Start implementation of Java Script. All new things in following versions will only be available in JS. Meaning on oolite 1.70 or newer.
1.3.0   The slave- and solar missions will use Java Script when Oolite 1.70 or newer is used. Under Oolite 1.65 the old Legacy scripting is used.
1.3.1   Translation of the parcel missions into Java script.
1.3.2   Translation of the docs missions into Java script.
1.3.3   Translation of the container missions into Java script. Added timers to mission offerings for multiple offerings on one station.
1.3.4   Added Java scripts to some ships for a rare mid-air encounter.
1.3.5   Added option to look at long range chart first, before accepting a mission.
1.3.6   The JS version of the &quot;private Escort&quot; now works. 
        Added rotating ships on some missions (added this also to the legacy version). 
        Added celebration messages when a main target was destroyed.
1.3.7   Added ups barrels to the game. Used for missions but also in used in the general barrel pool. 
        Removed a bug in the docs series that inhibited  doc-mission offers.
1.3.8   Bugfix of transferring solar mission

1.4.0   First release with oolite 1.71 adoptions.
1.4.1   Bugfixes
1.4.2   Bugfix and 1.72 preparations. Changed several scripted containers into normal containers now script added normal containers work well with 1.71
1.4.3   Added better counter measures against all new types of oxp added missiles for the final mission. 
        Removed bug (introduced in 1.4.2) with boa mission. Removed some other minor bugs.
1.4.4   Hired escorts now can attack a hostile player target and not just pirates. Doubled the cost for hiring escorts.

1.5.0   Removed any compatibility with older Oolite versions.
        Raised minimum Oolite version to 1.72. Reinstalled the &quot;long range chart looking&quot; for some mission offers.
        Made some parcel missions dependent on contract reputation. One now needs a positive reputation to get a parcel offer.
1.5.1   Added two new transport missions after suggestion of Pagroove: Tionisla chronicle delivery and medicine delivery. 
        Fixed a situation were the player jumps to another galaxy when ups was not installed. 
        UPS will now reset missions properly after re-instalation of the oxp in an other galaxy. 
        Fixed several occasions of to much spam messages by mission pirates. Spam messages are now just not sent when the last was very recent. 
        Raised minimum version to 1.72.1 (1.72.0 will crash on a certain specific command I need for the new mission)
1.5.2   Changed bounty of the Boa mission. Ship should now get less chased by police.
1.5.3   Added extra code for the Boa mission. Because of an Oolite timer bug, version 1.5.2 could crash oolite during this Boa mission.
1.5.4   Fixed bug with private escorts. Bug was introduced in version 1.5.0
1.5.5   Added time left in days&amp;hours for two mission descriptions.
1.5.6   Removed bug in Python mission. (Bug added with 1.5.5)
1.6.0   Raised minimum Oolite version to 1.73
1.6.1   Changed maximum version to 1.73.x (will be incompatible with 1.74)
1.7.0   Implemented the new mission offering code introduced with Oolite 1.74. Minimum version is now 1.74.
        Added one new mission that makes use of the new possibility to read player cargo.
1.7.1   Fixed a problem with inconsistent casing that gives problems on Lunux systems.
1.7.3   Fixed a casing error with JS. This error was accepted until Oolite 1.74.2 but will generate errors in later versions.
1.7.4   Added a &#39;null&#39; parameter to setInstructionsKey() to avoid warnings after Oolite 1.74.2
1.7.5   Found another casing error with &quot;System&quot;.
1.7.6   Found another casing error with &quot;Manifest&quot;. (thanks Okti)
1.7.7   Fixed a problem of some ships not being added at the intended location with Oolite 1.75.
1.8.0   Raised minimum Oolite to 1.75.1 Added randomized pilots to some ships. (Unreleased yet)
1.8.1   Fixed a bug from version 1.8.0 were some missions did not start or finish.
1.8.2   Fixed an equipment bug that accidentally removed the cloak from the player in pirate-rock mission. 
        Bug was already present in the very first version 1.0, but only blows into your face when using Oolite 1.77 or newer.
1.8.3   Fixed a few text expansions with DockedStationName_string.
        Fixed a bug with the reward in the Python mission.
1.8.4   Fixed a bug from the 1.8.3 version.
1.9     Update by spara
        For compatibility with various shipsets, all references to core models have been removed and replaced with like_ships.
        Ships
            For compatibility, removed special exhausts
            Replaced oxp specific boas and python with like_ships
            Unified ship naming overall and updated to use randomshipnames oxp, if present.
            Updated escorts to use escort formations oxp, if present
        Asteroids
            No more custom asteroids in missions. Uses any available asteroids now.
            Special splinter models are now re-textured Griff models. Corrected to work with Ore Processor&#39;s scan function.
        Stations
            Solar research station is replaced with a turretless Kiota Solar station, if present.
            Pirate bases are replaced with Griff&#39;s hermit, if present
        Other
            Fixed black box to work correctly with Griff&#39;s barrel
            Metal plates normal mapped by Keeper
            Ground radars enhanced with normal &amp; emission maps
            Fixed ground radars from being stations with docking possibilities
2.0     Update by phkb
        Updates to ship/container models to better fit with the Griff models post-Oolite 1.80.
        Switched Black Box to be the same as cim&#39;s Black box from Rescue Stations.
        Added screenID&#39;s to all mission screens.
        Update to UPS mission screen overlay image.
        Spelling/grammar corrections in missiontext.plist and descriptions.plist.
        Update of market data to work with newer system post-Oolite 1.82.
        Converted readme.rtf to txt file.
        Bug fixes.
2.0.1   Update by phkb
        Removed legacy script that added AstroFactories after launching.
        Removed code relating to pre-1.77 versions of Oolite. Minimum version now 1.82.
        Fixed Javascript error in slaves market adjustment code.
2.0.2   Added new texture for Solar Researcher, provided by Keeper.
        Added role-categories.plist file to replace the &quot;pirate-victim-roles.plist&quot; file.
        Converted demoships.plist file to OpenStep format.
2.0.3   Really fixed errors in slave market adjustment code.
2.0.4   Added code to prevent missions to unreachable destinations.
        Displaying a mission destination on a system map will no longer reset the current hyperspace destination.
        Small adjustments to missiontext items.
2.0.5   Small changes to some beacon labels in shipdata.plist.
        Added additional entries to save game data.
2.0.6   Changed ship naming convention used on Solar Shuttles.
        Hopefully stopped issue of mission completion screens being displayed more than once.
2.0.7   Added chart marker cleanup routine.
2.0.8   Fixed issue with Sun Stations not being recognised as dockable stations.
2.1.0   Changed slave satellite radar to be a variant of Rorschachhamster&#39;s spy satellite.
        Added missing dock to ground radar definition to fix communications between radars. 
        Made Snoopers optional, and made use of the new GNN OXP (if installed).
        Mission text updates
        Spelling/grammar corrections.
2.1.1   Small correction to a comms message in the fuel leak AI.</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_CRIPPLED_CLOAKING.html">Cloaking Device</a></td>
                    <td>yes</td>
                    <td align="right">1500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_UPS_IDCLEANER.html">Pirate ID Cleaner</a></td>
                    <td>yes</td>
                    <td align="right">20000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_UPS_POLICE_SCANNER.html">GalCop Scanner</a></td>
                    <td>yes</td>
                    <td align="right">30000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_UPS_PRIVATE_ESCORT.html">Private Escort</a></td>
                    <td>no</td>
                    <td align="right">42000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_UPS_UNIVERSAL_SCANNER.html">Universal Scanner</a></td>
                    <td>yes</td>
                    <td align="right">800000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_UPS_UNIVERSAL_SCANNER_REMOVER.html">Remove Universal Scanner</a></td>
                    <td>yes</td>
                    <td align="right">200</td>
                    <td align="center">14+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda-derelict2_ptt.html">anaconda-derelict2_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda-derelict_ptt.html">anaconda-derelict_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda_ptt.html">anaconda_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/asp_ambush_escort.html">asp_ambush_escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/asp_ambush_ptt.html">Asp Mark IV</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/asp_ptt.html">asp_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/black-box-ptt.html">Black Box</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa-mk2_ptt.html">boa-mk2_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa2_ptt.html">boa2_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa3_ptt.html">boa3_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa4_ptt.html">boa4_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa_ptt.html">boa_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/krait_ptt.html">krait_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/pirate-upsbase-core.html">Pirate Rock</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/pirate-upsbase-griff.html">Pirate Rock</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/pirate-upsbase2-core.html">pirate-upsbase2-core</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/pirate-upsbase2-griff.html">pirate-upsbase2-griff</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/pirate-upscapsule.html">pirate-upscapsule</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-derelict_ptt.html">python-derelict_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-scavenger-ups.html">python-scavenger-ups</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python2_ptt.html">python2_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python3_ptt.html">python3_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python_ptt.html">python_ptt</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/sunbase-upscapsule.html">sunbase-upscapsule</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/template_barrel.html">Cargo container</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/template_boa-mk2_star.html">Boa Class Cruiser</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/template_boa_star.html">Boa</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-alloy.html">Metal fragment</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-alloy2.html">ups-alloy2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-alloy3.html">ups-alloy3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-asp-escort.html">ups-asp-escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel.html">Cargo container</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel1.html">ups-barrel1</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel2.html">Cargo container</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel3.html">ups-barrel3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel4.html">ups-barrel4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel5.html">ups-barrel5</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel6.html">ups-barrel6</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel7.html">ups-barrel7</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-barrel8.html">ups-barrel8</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-blackbox-template.html">Black Box</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-buoy.html">Solar Navigation Buoy</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-cobra-escort.html">ups-cobra-escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-cobra3.html">ups-cobra3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-cobra3-miner.html">ups-cobra3-miner</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-container.html">UPS container</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance-core.html">Sun Research Station Alpha</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance-kiota.html">Sun Research Station Alpha</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance2-core.html">Sun Research Station Beta</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance2-kiota.html">Sun Research Station Beta</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance3-core.html">Sun Research Station Omega</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance3-kiota.html">Sun Research Station Omega</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance4-core.html">Sun Research Station Delta</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dependance4-kiota.html">Sun Research Station Delta</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-dock-no-dock.html">No-Dock dock</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-ferdelance-l.html">ups-ferdelance-l</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-fuelship1.html">ups-fuelship1</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-fuelship2.html">ups-fuelship2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-gecko-escort.html">ups-gecko-escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-satellite-asp.html">ups-satellite-asp</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-satellite-cobra.html">ups-satellite-cobra</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-satellite-cobra3.html">ups-satellite-cobra3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-satellite-gecko.html">ups-satellite-gecko</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-satellite-moray.html">ups-satellite-moray</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slave-convoy-f.html">ups-slave-convoy-f</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slave-convoy-l.html">ups-slave-convoy-l</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slave-satellite.html">Ground Radar</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slave-shuttle.html">ups-slave-shuttle</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slave_convoy_barrel.html">ups-slave_convoy_barrel</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slavebarrel.html">ups-slavebarrel</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-slavecobra.html">ups-slavecobra</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-solar-researcher.html">Solar Research Ship</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-solar-researcher2.html">Solar Research Ship II</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-solar-researcher3.html">Corona Research Shuttle</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-solar-shuttle.html">Surface Research Shuttle</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter1.html">ups-splinter1</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter2.html">ups-splinter2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter3.html">ups-splinter3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter4.html">ups-splinter4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter5.html">ups-splinter5</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter6.html">ups-splinter6</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter7.html">ups-splinter7</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-splinter8.html">ups-splinter8</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun-anaconda.html">ups-sun-anaconda</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun-boa-mk2.html">ups-sun-boa-mk2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun-python-trader.html">ups-sun-python-trader</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun-viper.html">ups-sun-viper</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun2-anaconda.html">ups-sun2-anaconda</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-sun2-python-trader.html">ups-sun2-python-trader</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-viper-escort.html">ups-viper-escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ups-viper-escort2.html">ups-viper-escort2</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/demoScript.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;demo&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;ï¿½ 2008 eric walch.&quot;;
this.description = &quot;Empty script structure that handles population and mission offering&quot;;
this.version     = &quot;0.0&quot;;

// N.B. Works only with 1.74.


// startUp only runs once at startup before the demoscreen shows up and after loading in a saved game.
this.startUp = function (){
    this.mustPopulate = true;
    /* used for adding ships after a first launch.
    This way you don&#39;t have to time consuming check every launch if a ship was already there.
    */
};

this.shipWillDockWithStation = function (station){
    /*
    This is the place to add your messages to the arrival report with:
    if(condition) player.addMessageToArrivalReport(expandDescription(&quot;Your message&quot;));
    */
};

this.shipDockedWithStation = function (station){
    // do your stuff here.
};

this.missionScreenOpportunity = function (){
    /*
    This handler triggers:
    - After loading a saved game.
    - After docking.
    - After a missionscreen ended.
    It will only trigger for one oxp at a time and stop triggering when an oxp takes the Opportunity.
    There is no need to do additional tests: when an opportunity is given, it is safe to display a missioncreen.
    */
    if (!player.ship.docked) return;
    this.missionOffers();
};

this.missionOffers = function (){
    if (player.ship.dockedStation.isMainStation) {
        //  Your stuff for the main station
        /*
        Missionscreens are set up using the command:
        mission.runScreen({title: &quot;&quot;, messageKey: &quot;&quot;, etc...}, this.choiceEvaluation)

        When you do an offer it is often advisable to set a variable to tell an offer is made. (e.g. this.offering)
        This prefents comming in a loop of offering. There is no need to use a missionVarriable for this,
        a &quot;this.Foo&quot; will do. But always remember that a player can launch without making a selection, so
        you must clear such variables on launch.
        */
    } else if (player.ship.dockedStation.shipDescription == &quot;My Station&quot;){
        // Your stuff for a special named station
    }
};

this.choiceEvaluation = function (choice){
    if (this.offering === &quot;MY_OFFER&quot;){
         /*
         the choise is only offered to the oxp that created the page, so there is no longer the risk
         of other oxp reacting on a chosen answer.
         */
        if (choice === &quot;YES_MISSION&quot;){
            // put your code here.
        }else{
            if (choice === &quot;NO_MISSION&quot;){
                // put your code here
            }
        }
    }
    this.offering = null;
};

this.setUpShips = function (){
    // Put here your code that populates the system.
};

this.shipExitedWitchspace = function (){
    if (system.isInterstellarSpace) return;
    this.setUpShips();
    // Put here your code else than setting ships up.
};

this.playerEnteredNewGalaxy = function (Galaxy){
    // This handler will be rarely needed.
};

this.shipLaunchedFromStation = function (){
   /* The first launch after a restart the system must be populated after a launch.
   The other times it happens after a WitchspaceJump */
   if (this.mustPopulate) {this.setUpShips(); this.mustPopulate = false}
   this.offering = null; // in case a ship launched from within a missionscreen without making a choice.
    // put here your other code.
};</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsAsteroid.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;upsAsteroid&quot;;
this.author      = &quot;spara&quot;;
this.copyright   = &quot;2014 Mika Spara&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Code for special asteroids/boulders/splinters&quot;;

//add position marker when asteroid/boulder with this ship_script is destroyed to script the spawned debris.
this.shipDied = function() {
	system.addVisualEffect(&quot;ups_position_marker&quot;, this.ship.position);
    if (worldScripts[&quot;ups_docs&quot;].ups_docs === &quot;ASTEROID&quot; &amp;&amp; ship.$upsAsteroid)
    {
        // doing the asteroid mission
        missionVariables.ups_asteroid_count-- ;
    }
}

//marker has been spawned, wait for 0.1 seconds so that the game has time to spawn boulders/splinters
this.effectSpawned = function() {
	this.debrisTimer = new Timer(this, this.$scanDebris, 0.1);
}

//scan for boulders/splinters and script accordingly
this.$scanDebris = function() {
	//if there are asteroids/boulders close by, assume that they are products of just destroyed asteroid and script them. this method also works with asteroids from asteroid storm oxp and griffs rock chunks.
	var rocks = system.entitiesWithScanClass(&quot;CLASS_ROCK&quot;, this.visualEffect, 1000);
	for (var i = 0; i &lt; rocks.length; i++) {
		rocks[i].setScript(&quot;upsAsteroid.js&quot;);
	}
	//if there are splinters close by, assume that they are products of just destroyed boulder and add valuables to them.
	var splinters = system.shipsWithPrimaryRole(&quot;splinter&quot;, this.visualEffect, 1000)

	for (var i = 0; i &lt; splinters.length; i++) {
		if (splinters[i].commodity === &quot;minerals&quot;) {
			var position = splinters[i].position;
			splinters[i].explode();
			splinters[i] = system.addShips(&quot;ups-splinter&quot;, 1, position, 0)[0];
			splinters[i].temperature = 0.99;
			splinters[i].primaryRole = &quot;splinter&quot;;
			var amount = Math.ceil(Math.random() * 12);
			var metal = Math.random() &lt; 0.40 ? &quot;platinum&quot; : &quot;gold&quot;;
			splinters[i].setCargo(metal, amount);
			//make the splinters to be identified with the ore processors scanning function correctly
			splinters[i].$oreProcessor = {
				type: metal,
				quantity: amount
			};
		}
	}
	this.visualEffect.remove();
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsBlackBox.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name		 = &quot;upsBlackBox&quot;;
this.author		 = &quot;eric Walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.comment	 = &quot;Script for the ups-black box sun mission&quot;

this.shipWasScooped = function (scooper)
{
	 if (scooper.isPlayer)
	 {
		worldScripts[&quot;ups_sun&quot;].ups_s2count++;
		worldScripts[&quot;ups_sun&quot;].ups_s2award += 250;
	 }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsBoa.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsBoa&quot;;
this.author    = &quot;eric walch, spara&quot;;
this.copyright = &quot;2008 eric walch. 2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.oldStatus = 100; // real ship bounty
	this.checkPlayerTimer = new Timer(this, this.checkPlayer, 20, 10);
	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
    delete this.shipSpawned;
}

this.shipDied = function (whom, why)
{
   log(&quot;UPS-Courier&quot;, &quot;Hostile BOA killed by &quot; + whom + &quot; by means of &quot; + why);
   if (whom &amp;&amp; whom.isPlayer &amp;&amp; !player.ship.isCloaked)
   {
      missionVariables.ups_closecontact = &quot;YES&quot;; // Killer was the player
   }
   else
   {
      missionVariables.ups_closecontact = &quot;NO&quot;; // Killer was an NPC or player was cloaked.
   }
    this.ship.commsMessage(&quot;I&#39;ll be back with help for revenge!!&quot;);
    this.ship.spawn(&quot;ups-spilled-container&quot;, 5);
    this.ship.spawn(&quot;ups-textilecontainer&quot;, 15);
    worldScripts[&quot;ups_container&quot;].ups_container_count = 0;
	worldScripts[&quot;ups_container&quot;].ups_total_container_count = 0;
	worldScripts[&quot;ups_container&quot;].ups_container_award = 0;
    worldScripts[&quot;ups_container&quot;].ups_container = &quot;FOUND&quot;;
    worldScripts[&quot;ups_container&quot;].upsUnmarkSystem(missionVariables.ups_cplanet, &quot;ups_container&quot;);
    mission.setInstructionsKey(&quot;ups_containers_small1c&quot;, &quot;ups_container&quot;);
	if (this.checkPlayerTimer) {this.checkPlayerTimer.stop(); delete this.checkPlayerTimer};
    delete this.shipDied;
}

this.shipBeingAttacked = function (whom)
{
	if (this.ship.escorts &amp;&amp; Math.random() &gt; 0.7) this.ship.deployEscorts();
	if (!whom.isPlayer &amp;&amp; player.ship.position &amp;&amp; player.ship.position.distanceTo(this.ship) &gt; 20E3) whom.reactToAIMessage(&quot;TARGET_LOST&quot;);
}

// is only activated on real dockings. Sometimes ships are also removed from the docking queue on player launch.
this.shipDockedWithStation = function (station)
{
    log(&quot;UPS-Courier&quot;, &quot;Hostile BOA docked at station: &quot;+ station.name);
    mission.setInstructionsKey(&quot;ups_container_boa_docked_small&quot;, &quot;ups_container&quot;);
	missionVariables.ups_closecontact = &quot;DOCKED&quot;;
	if (this.checkPlayerTimer) {this.checkPlayerTimer.stop(); delete this.checkPlayerTimer};
}

this.entityDestroyed = function ()
{
    if (this.checkPlayerTimer) {this.checkPlayerTimer.stop(); delete this.checkPlayerTimer};
}

this.sendAwayOffender = function ()
{
	if (!this.ship.target.isPlayer &amp;&amp; player.ship.position &amp;&amp; player.ship.position.distanceTo(this.ship) &gt; 20E3) this.ship.target.reactToAIMessage(&quot;TARGET_LOST&quot;);
}

// Setting clean on/off is only to draw no police attention when there is no player nearby.
this.checkPlayer = function ()
{
	if (this.ship &amp;&amp; !this.ship.isValid)
	{
		log(this.name, &quot;ERROR detected, this.ship is undefined&quot;); // Oolite bug
		if (this.checkPlayerTimer) {this.checkPlayerTimer.stop(); delete this.checkPlayerTimer};
		if (this.checkPlayer) delete this.checkPlayer;
		return;
	}
	if (player.ship.position &amp;&amp; player.ship.position.distanceTo(this.ship) &gt; 30E3) this.setClean()
	else this.setFugitive();
}

this.setClean = function ()
{
    if (this.oldStatus == 0)
    {
        this.oldStatus = this.ship.bounty;
        this.ship.bounty = 0;
		if (this.ship.escorts) this.setEscortBounty(0);
    }
}

this.setFugitive = function ()
{
    if (this.oldStatus &gt; 0)
    {
        this.ship.bounty = this.oldStatus;
        this.oldStatus = 0;
		if (this.ship.escorts) this.setEscortBounty(30);
    }
}

this.setEscortBounty = function (bounty)
{
	var escorts = this.ship.escorts;
    for (var i=0; i&lt;escorts.length; i++)
	{
		if (escorts[i].AIState == &quot;FLYING_ESCORT&quot;)
        {
            escorts[i].bounty = Math.round(Math.random()*bounty + bounty/10);
        }
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsBoaPilot.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsBoaPilot&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2010 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.unloadCharacter = function ()
{
    player.addMessageToArrivalReport(expandMissionText(&quot;eric_thanks&quot;))
    player.credits +=150;
    missionVariables.ups_ecount++;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsDefender.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsDefender&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;2008 eric walch&quot;;
this.description    = &quot;1.71 integration&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.neutralyseMine = function ()
{
    if (this.ship.target &amp;&amp; this.ship.target.AI != &quot;upsTimebombAI.plist&quot;)
    {
        this.ship.target.switchAI(&quot;upsTimebombAI.plist&quot;);
        this.ship.commsMessage(&quot;It&#39;s my mine&quot;);
        this.ship.fireECM();
    }
}

this.neutralyseMissile = function ()
{
    if (this.ship.target &amp;&amp; this.ship.target.AI != &quot;upsTimebombAI.plist&quot; &amp;&amp; this.ship.target.owner &amp;&amp; this.ship.target.owner.isPlayer)
    {
        this.ship.target.switchAI(&quot;upsTimebombAI.plist&quot;);
        this.ship.commsMessage(&quot;It&#39;s my missile&quot;);
        this.ship.fireECM();
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsDependance.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name      = &quot;ups_sun_station_alpha&quot;;
this.author    = &quot;eric walch, spara&quot;;
this.copyright = &quot;2008 eric walch. 2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.playerArrived = false;

this.shipSpawned = function ()
{
    if (worldScripts[&quot;ups_sun&quot;].ups_sun === &quot;RESCUE&quot; || worldScripts[&quot;ups_sun&quot;].ups_sun === &quot;EXPLOSION&quot;)
    {
        this.ship.switchAI(&quot;upsSunStationFinalAI.plist&quot;); // switch AI script on final mission.
        this.ship.requiresDockingClearance = false;
    }

    //don&#39;t use buoy, if station is Kiota station -spara-
    if (!ship.hasRole(&quot;ups_kiota&quot;)) {
		var targetVector = system.sun.position.subtract(this.ship.position).direction();
		this.ship.orientation = targetVector.rotationTo(new Vector3D(0,0,1));
		this.buoy =  (this.ship.primaryRole == &quot;ups_dependance&quot;) ? &quot;ups-sun-buoy&quot; : &quot;ups-sun-buoy2&quot;;
		system.addShips(this.buoy, 1, this.ship.position.add(this.ship.heading.multiply(10E3)), 1);
    }
    //remove turrets from Kiota solar station -spara-
    var subEnts = ship.subEntities;
    for (var i = 0; i &lt; subEnts.length; i++) {
		if (subEnts[i].primaryRole === &quot;wildShips_kiotaTurret&quot;)
			subEnts[i].remove();
	}

    delete this.shipSpawned;
}

this.shipDied = function ()
{
    if (worldScripts[&quot;ups_sun&quot;].ups_sun === &quot;RESCUE&quot; || worldScripts[&quot;ups_sun&quot;].ups_sun === &quot;EXPLOSION&quot;)
    {
        log(this.name, &quot;Station position is: &quot;+this.ship.position);
        var escapees = system.addShips(&quot;sunbase-upscapsule&quot;, 15, this.ship.position, 500);
        for (var i=0; i&lt;escapees.length; i++)
        {
            // escapees[i].position = this.ship.position.add(Vector3D.random().multiply(500));
            // escapees[i].velocity = escapees[i].position.subtract(this.ship.position);
            // log(this.name, &quot;escapees position nr: &quot;+i+&quot; is: &quot;+escapees[i].position);
        }
        worldScripts[&quot;ups_sun&quot;].ups_rescue = &quot;YES&quot;;
        worldScripts[&quot;ups_sun&quot;].ups_sun = &quot;EXPLOSION&quot;;
        delete this.shipDied;
    }
}

this.entityDestroyed = function ()
{
	if (this.heatTimer) {this.heatTimer.stop(); delete this.heatTimer;};
}

this.takeHeatDamage = function ()
{
     if (!this.playerArrived)
     {
        this.playerArrived = true;
        this.heatTimer = new Timer(this, this.increaseHeat, 1, 1);
        this.ship.commsMessage(&quot;Help us evacuate our last soles.&quot;);
     }
     else
	 {
		var temp = Math.round(100 - 60 * this.ship.energy / this.ship.maxEnergy);
		this.ship.commsMessage(&quot;Hurry up, station core temperature is at &quot;+temp+&quot; degr C and still rising.&quot;);
	 }
}

this.increaseHeat = function ()
{
    this.ship.temperature += 0.01;
    if (this.ship.temperature &gt;= 1) {this.heatTimer.stop(); delete this.heatTimer};
}

this.launchMainstation = function ()
{
    var main = system.mainStation;
    if (main) main.launchShipWithRole(&quot;sunskim-trader&quot;);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsDerelict.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsderelict&quot;;
this.author    = &quot;eric walch, spara&quot;;
this.copyright = &quot;2008 eric walch. 2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.collisionDistance = this.ship.collisionRadius + player.ship.collisionRadius;
    this.shipName = this.ship.displayName;
    this.countdown = 5;
    this.maxFuel = 1;

	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);

    delete this.shipSpawned;
}

this.checkFuel = function ()
{
    if(player.ship.fuel &gt; 0)
    {
        this.ship.commsMessage(&quot;Help anyone, we are out of fuel.&quot;);
    }
    else
    {
        this.ship.switchAI(&quot;route1TraderAI.plist&quot;);
    }
}

this.checkDistance = function ()
{
  var distance = Math.round(player.ship.position.distanceTo(this.ship));
  if (distance &lt; 6000)
  {
      player.consoleMessage(&quot;You are on final approach, lower your speed&quot;, 9);
      if (!worldScripts.randomshipnames)
		this.ship.displayName = this.shipName + &quot; without fuel&quot;;
      this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
  }
}

this.guideIn = function ()
{
    var distance = Math.round(player.ship.position.distanceTo(this.ship) - this.collisionDistance);
    if (distance &lt; 0) distance = 0;
    var speed = Math.round(player.ship.speed);
    if (distance &gt; 7000)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_LEAVING&quot;);
        return;
    }
    if (distance &gt; 1500)
    {
        if(speed &gt; 100) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed.&quot;, 4);
    }
    else
    {
        if(speed &gt; 50) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed to 50 km/h.&quot;, 4);
        player.consoleMessage(&quot;You are at &quot; + distance + &quot; meters, come to a complete standstill within 100 meters.&quot;, 4);
    }
    if(distance &lt; 100 &amp;&amp; speed == 0)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_CLOSE&quot;);
        this.oldOrientation = player.ship.orientation;
    }
}

this.checkSpeed = function ()
{
  if (player.ship.speed &gt; 0.001 || this.oldOrientation.dot(player.ship.orientation) &lt; 0.999)
  {
    player.consoleMessage(&quot;You are moving to much, hold still&quot;, 4);
    this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
    this.countdown = 5;
  }
  else if(this.ship.speed &gt; 0)
  {
    player.consoleMessage(&quot;That was to close&quot;, 4);
    this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
    this.countdown = 5;
  }
  else
  {
    player.consoleMessage(&quot;Transfering fuel..... &quot; +this.countdown, 3);
    if(player.ship.fuel &gt; 0 &amp;&amp; this.maxFuel &gt; 0)
    {
        player.ship.fuel -= 0.2;
        this.maxFuel -= 0.2;
    }
    this.countdown--;
    if(this.countdown&lt;0) this.ship.reactToAIMessage(&quot;UPS_TRANSFERING&quot;);
  }
}

this.thankPlayer = function ()
{
    if(player.ship.fuel &gt; 0)
    {
        this.ship.commsMessage(expandDescription(&quot;Thank you for the fuel [commander_shipname].&quot;));
    }
    else
    {
        this.ship.commsMessage(expandDescription(&quot;Thank you for giving you last bit of fuel [commander_shipname].&quot;));
    }
    if (!worldScripts.randomshipnames)
		this.ship.displayName = this.shipName;
}

this.tranferPayment = function ()
{
    player.ship.manifest[&quot;gem_stones&quot;] += 50;
    missionVariables.ups_tcount++;
}

this.subtractAllFuel = function ()
{
    this.ship.commsMessage(expandDescription(&quot;Thank you for giving you last bit of fuel [commander_shipname].&quot;));
    player.ship.fuel = 0;
    if (!worldScripts.randomshipnames)
		this.ship.displayName = this.shipName;
    this.ship.bounty += 50;
    if(this.ship.escorts.length&gt;0)
    {
        for(let i=0; i&lt;this.ship.escorts.length;i++)
        {
            if(this.ship.escorts[i].isValid) this.ship.escorts[i].bounty += 25;
        }
    }
}

this.shipExitedWormhole = function ()
{
	this.ship.primaryRole = &quot;trader&quot;;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsEscorts.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsescorts&quot;;
this.author    = &quot;spara&quot;;
this.copyright = &quot;2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);

    delete this.shipSpawned;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsFuelLeak.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;fuelLeakUps&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2008 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.collisionDistance = this.ship.collisionRadius + player.ship.collisionRadius;
    this.shipName = this.ship.displayName;
    delete this.shipSpawned;
}

this.shipDied = function (whom, why)
{
    if(this.ship.subEntities &amp;&amp; this.ship.subEntities.length &gt; 0) // ship still has subentities.
    {
        for (var i=0; i&lt;this.ship.subEntities.length; i++)
        {
            var silo = this.ship.spawnOne(this.ship.subEntities[i].primaryRole);
            var siloPosition = this.ship.subEntities[i].position;
            siloPosition = siloPosition.multiply(3);
            siloPosition = this.localToGlobal(siloPosition);
            if (silo &amp;&amp; silo.isValid)
            {
                silo.orientation = this.ship.orientation;
                silo.position = siloPosition;
            }
        }
    }
}

this.localToGlobal = function (position)
{
	return this.ship.position.add(position.rotateBy(this.ship.orientation));
}

this.payment = 0;

this.checkLocation = function ()
{
  if (system.isInterstellarSpace)
  {
    player.consoleMessage(&quot;I&#39;ll give you fuel for &quot; + 1500 * (7 - player.ship.fuel) + &quot; credits.&quot;, 9);
    this.amount = 1500;
  }
  else
  {
    player.consoleMessage(&quot;This entry point iS unsafe and causes fuel leaks.&quot;, 9);
    this.amount = 150;
    player.ship.fuelLeakRate = 20;
  }
}

this.checkDistance = function ()
{
  var distance = Math.round(player.ship.position.distanceTo(this.ship));
  if (distance &lt; 6000)
  {
      player.consoleMessage(&quot;You are on approach, lower your speed&quot;, 9);
      this.ship.displayName = this.shipName + &quot; with fuel&quot;;
      this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
  }
}

this.guideIn = function ()
{
    var distance = Math.round(player.ship.position.distanceTo(this.ship) - this.collisionDistance);
    if (distance &lt; 0) distance = 0;
    var speed = Math.round(player.ship.speed);
    if (distance &gt; 7000)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_LEAVING&quot;);
        return;
    }
    if (distance &gt; 1500)
    {
        if (speed &gt; 100) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed.&quot;, 4);
    }
    else
    {
        if (speed &gt; 50) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed to 50 km/h.&quot;, 4);
        player.consoleMessage(&quot;You are at &quot; + distance + &quot; meters, come to a complete standstill within 100 meters.&quot;, 4);
    }
    if (distance &lt; 100 &amp;&amp; speed == 0)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_CLOSE&quot;);
        this.oldOrientation = player.ship.orientation;
    }
}

this.checkSpeed = function ()
{
    if (player.ship.speed &gt; 0.001 || this.oldOrientation.dot(player.ship.orientation) &lt; 0.999)
    {
        player.consoleMessage(&quot;You are moving to much, hold stil&quot;, 4);
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
    }
    else
    {
        if (player.ship.fuel &lt; 7 &amp;&amp; player.credits &gt; this.amount)
        {
            player.consoleMessage(&quot;Transfering fuel... &quot; + Math.round(player.ship.fuel), 3);
            player.ship.fuel += 1;
            this.payment += this.amount;
            player.credits -= this.amount;
        }
        else
        {
            if (this.payment === 0)
            {
                player.commsMessage(&quot;No money no fuel. I can&#39;t help you&quot;, 6);
            }
            else
            {
                player.commsMessage(&quot;I took &quot; + this.payment + &quot; credits as payment.&quot;,6)
                this.ship.reactToAIMessage(&quot;UPS_TRANSFERING_OK&quot;);
                this.ship.target = null;
            }
        }
        this.ship.displayName = this.shipName; // restore original name
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsMarket_dependance.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsMarket_dependance&quot;;
this.author    = &quot;spara&quot;;
this.copyright = &quot;2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 4.0&quot;;

this.$originalDefs = {
    &quot;food&quot;: [0, 0, 19, -2, -2, 6, 1, 1, 0],
    &quot;textiles&quot;: [0, 0, 20, -1, -1, 10, 3, 3, 0],
    &quot;radioactives&quot;: [0, 0, 65, -3, -3, 2, 7, 7, 0],
    &quot;slaves&quot;: [0, 0, 40, -5, -5, 226, 31, 31, 0],
    &quot;liquor_wines&quot;: [0, 0, 83, -5, -5, 251, 15, 15, 0],
    &quot;luxuries&quot;: [0, 0, 196, 8, 8, 54, 3, 3, 0],
    &quot;narcotics&quot;: [0, 0, 235, 29, 29, 8, 120, 120, 0],
    &quot;computers&quot;: [0, 0, 154, 14, 14, 56, 3, 3, 0],
    &quot;machinery&quot;: [0, 0, 117, 6, 6, 40, 7, 7, 0],
    &quot;alloys&quot;: [0, 0, 78, 1, 1, 17, 31, 31, 0],
    &quot;firearms&quot;: [0, 0, 124, 13, 13, 29, 7, 7, 0],
    &quot;furs&quot;: [0, 0, 176, -9, -9, 220, 63, 63, 0],
    &quot;minerals&quot;: [0, 0, 32, -1, -1, 53, 3, 3, 0],
    &quot;gold&quot;: [0, 0, 97, -1, -1, 66, 7, 7, 1],
    &quot;platinum&quot;: [0, 0, 171, -2, -2, 55, 31, 31, 1],
    &quot;gem_stones&quot;: [0, 0, 45, -1, -1, 250, 15, 15, 2],
    &quot;alien_items&quot;: [0, 0, 53, 15, 0, 0, 7, 0, 0]
};

this.updateLocalCommodityDefinition = function(goodDefinition) {
	var commodity = goodDefinition.key;
	var oldDefs = this.$originalDefs[commodity];
	//old style definition found for the good. calculate it the old way
	if (oldDefs) {
		var market_base_price = oldDefs[2];
		var market_eco_adjust_price = oldDefs[3];
		var market_eco_adjust_quantity = oldDefs[4];
		var market_base_quantity = oldDefs[5];
		var market_mask_price = oldDefs[6];
		var market_mask_quantity = oldDefs[7];
		var market_rnd = Math.floor(Math.random() * 256);

		var economy = system.economy;

		var price = (market_base_price + (market_rnd &amp; market_mask_price) + (economy * market_eco_adjust_price)) &amp; 255;
		price *= 0.4;

		var quantity = (market_base_quantity + (market_rnd &amp; market_mask_quantity) - (economy * market_eco_adjust_quantity)) &amp; 255;
		if (quantity &gt; 127) quantity = 0;
		quantity &amp;= 63;

		goodDefinition.price = price * 10;
		goodDefinition.quantity = quantity;
	}
	//no definition found. nullify the goods.
	else {
		goodDefinition.price = 0;
		goodDefinition.quantity = 0;
	}
	return goodDefinition;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsMarket_earthquake.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsMarket_earthquake&quot;;
this.author    = &quot;spara&quot;;
this.copyright = &quot;2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 4.0&quot;;

this.$originalDefs = {
    &quot;food&quot;: [0, 0, 19, -2, -2, 0, 1, 1, 0 ],
    &quot;textiles&quot;: [0, 0, 20, -1, -1, 0, 3, 3, 0 ],
    &quot;radioactives&quot;: [0, 0, 65, -3, -3, 0, 7, 3, 0 ],
    &quot;slaves&quot;: [0, 0, 40, -5, 0, 0, 31, 0, 0],
    &quot;liquor_wines&quot;: [0, 0, 83, -5, -5, 0, 15, 7, 0 ],
    &quot;luxuries&quot;: [0, 0, 196, 8, 8, 0, 3, 3, 0 ],
    &quot;narcotics&quot;: [0, 0, 235, 29, 29, 0, 120, 63, 0 ],
    &quot;computers&quot;: [0, 0, 154, 14, 14, 0, 3, 1, 0 ],
    &quot;machinery&quot;: [0, 0, 196, 6, 6, 0, 7, 0, 0 ],
    &quot;alloys&quot;: [0, 0, 78, 1, 1, 0, 31, 15, 0 ],
    &quot;firearms&quot;: [0, 0, 124, 13, 13, 0, 7, 3, 0 ],
    &quot;furs&quot;: [0, 0, 176, -9, -9, 0, 63, 31, 0 ],
    &quot;minerals&quot;: [0, 0, 32, -1, -1, 0, 3, 1, 0 ],
    &quot;gold&quot;: [0, 0, 97, -1, -1, 0, 7, 3, 1 ],
    &quot;platinum&quot;: [0, 0, 171, -2, -2, 0, 31, 15, 1 ],
    &quot;gem_stones&quot;: [0, 0, 45, -1, -1, 0, 15, 7, 2 ],
    &quot;alien_items&quot;: [0, 0, 53, 15, 0, 0, 7, 0, 0 ]
};

this.updateLocalCommodityDefinition = function(goodDefinition) {
    if (system.ID !== worldScripts.ups_docs.ups_dplanet || worldScripts.ups_docs.mark === false) {
        return goodDefinition;
    }
	var commodity = goodDefinition.key;
	var oldDefs = this.$originalDefs[commodity];
	//old style definition found for the good. calculate it the old way
	if (oldDefs) {
		var market_base_price = oldDefs[2];
		var market_eco_adjust_price = oldDefs[3];
		var market_eco_adjust_quantity = oldDefs[4];
		var market_base_quantity = oldDefs[5];
		var market_mask_price = oldDefs[6];
		var market_mask_quantity = oldDefs[7];
		var market_rnd = Math.floor(Math.random() * 256);

		var economy = system.economy;

		var price = (market_base_price + (market_rnd &amp; market_mask_price) + (economy * market_eco_adjust_price)) &amp; 255;
		price *= 0.4;

		var quantity = (market_base_quantity + (market_rnd &amp; market_mask_quantity) - (economy * market_eco_adjust_quantity)) &amp; 255;
		if (quantity &gt; 127) quantity = 0;
		quantity &amp;= 63;

		goodDefinition.price = price * 10;
		goodDefinition.quantity = quantity;
	}
	//no definition found. nullify the goods.
	else {
		goodDefinition.price = 0;
		goodDefinition.quantity = 0;
	}
	return goodDefinition;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsMarket_pirateupsbase.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsMarket_pirateupsbase&quot;;
this.author    = &quot;spara&quot;;
this.copyright = &quot;2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 4.0&quot;;

this.$originalDefs = {
    &quot;food&quot;: [0, 0, 19, -2, 0, 0, 1, 0, 0],
    &quot;textiles&quot;: [0, 0, 20, -1, 0, 0, 3, 0, 0],
    &quot;radioactives&quot;: [0, 0, 42, -3, -3, 1, 7, 3, 0],
    &quot;slaves&quot;: [0, 0, 40, -5, 0, 0, 31, 0, 0],
    &quot;liquor_wines&quot;: [0, 0, 105, -5, 0, 0, 15, 0, 0],
    &quot;luxuries&quot;: [0, 0, 236, 8, 0, 0, 3, 0, 0],
    &quot;narcotics&quot;: [0, 0, 235, 29, 0, 0, 120, 0, 0],
    &quot;computers&quot;: [0, 0, 51, 14, 0, 0, 3, 0, 0],
    &quot;machinery&quot;: [0, 0, 117, 6, 0, 0, 7, 0, 0],
    &quot;alloys&quot;: [0, 0, 78, 1, 0, 0, 31, 0, 0],
    &quot;firearms&quot;: [0, 0, 32, 13, 0, 0, 7, 0, 0],
    &quot;furs&quot;: [0, 0, 36, -9, 0, 0, 63, 0, 0],
    &quot;minerals&quot;: [0, 0, 16, -1, -1, 85, 3, 3, 0],
    &quot;gold&quot;: [0, 0, 73, -1, -1, 5, 7, 3, 1],
    &quot;platinum&quot;: [0, 0, 145, -2, -2, 6, 31, 7, 1],
    &quot;gem_stones&quot;: [0, 0, 25, -1, -1, 250, 15, 15, 2],
    &quot;alien_items&quot;: [0, 0, 22, 15, 0, 0, 7, 0, 0]
};

this.updateLocalCommodityDefinition = function(goodDefinition) {
	var commodity = goodDefinition.key;
	var oldDefs = this.$originalDefs[commodity];
	//old style definition found for the good. calculate it the old way
	if (oldDefs) {
		var market_base_price = oldDefs[2];
		var market_eco_adjust_price = oldDefs[3];
		var market_eco_adjust_quantity = oldDefs[4];
		var market_base_quantity = oldDefs[5];
		var market_mask_price = oldDefs[6];
		var market_mask_quantity = oldDefs[7];
		var market_rnd = Math.floor(Math.random() * 256);

		var economy = system.economy;

		var price = (market_base_price + (market_rnd &amp; market_mask_price) + (economy * market_eco_adjust_price)) &amp; 255;
		price *= 0.4;

		var quantity = (market_base_quantity + (market_rnd &amp; market_mask_quantity) - (economy * market_eco_adjust_quantity)) &amp; 255;
		if (quantity &gt; 127) quantity = 0;
		quantity &amp;= 63;

		goodDefinition.price = price * 10;
		goodDefinition.quantity = quantity;
	}
	//no definition found. nullify the goods.
	else {
		goodDefinition.price = 0;
		goodDefinition.quantity = 0;
	}
	return goodDefinition;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsMidair.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsMidair&quot;;
this.author    = &quot;eric walch, spara&quot;;
this.copyright = &quot;2008 eric walch. 2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.collisionDistance = this.ship.collisionRadius + player.ship.collisionRadius;
    if (!worldScripts.randomshipnames)
		this.shipName = this.ship.displayName;
    this.countdown = 5;

	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);

    delete this.shipSpawned;
}

this.checkDistance = function ()
{
  var distance = Math.round(player.ship.position.distanceTo(this.ship));
  if (distance &lt; 6000)
  {
      player.consoleMessage(&quot;You are on final approach, lower your speed&quot;, 9);
      if (!worldScripts.randomshipnames)
		this.ship.displayName = this.shipName + &quot; with packages&quot;;
      this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
  }
}

this.guideIn = function ()
{
    var distance = Math.round(player.ship.position.distanceTo(this.ship) - this.collisionDistance);
    if (distance &lt; 0) distance = 0;
    var speed = Math.round(player.ship.speed);
    if (distance &gt; 7000)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_LEAVING&quot;);
        return;
    }
    if (distance &gt; 1500)
    {
        if (speed &gt; 100) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed.&quot;, 5);
    }
    else
    {
        if (speed &gt; 50) player.consoleMessage(&quot;Approaching with: &quot; + speed + &quot;km/h, lower your speed to 50 km/h.&quot;, 4);
        player.consoleMessage(&quot;You are at &quot; + distance + &quot; meters, come to a complete standstill within 100 meters.&quot;, 4);
    }
    if (distance &lt; 100 &amp;&amp; speed == 0)
    {
        this.ship.reactToAIMessage(&quot;UPS_PLAYER_CLOSE&quot;);
    }
}

this.checkSpeed = function ()
{
  if (player.ship.speed &gt; 5)
  {
    player.consoleMessage(&quot;You are moving to much, lower your speed&quot;, 4);
    this.ship.reactToAIMessage(&quot;UPS_PLAYER_APPROACHING&quot;);
    this.countdown = 5;
  }
  else
  {
    player.consoleMessage(&quot;Transfering parcels..... &quot; +this.countdown, 3);
    this.countdown--;
    if (this.countdown&lt;0)
    {
        this.ship.reactToAIMessage(&quot;UPS_TRANSFERING&quot;);
    }
  }
}

this.transfer_package = function ()
{
    player.consoleMessage(&quot;Make room or you will be sucked in my wormhole... &quot;, 8);
    if (!worldScripts.randomshipnames)
		this.ship.displayName = this.shipName + &quot; without packages&quot;;
    missionVariables.ups_pplanetname = system.name;
    worldScripts[&quot;ups_parcel&quot;].ups_pplanet = system.ID;
    missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] [ups_colors] %I&quot;);
    mission.setInstructionsKey(&quot;ups_parcel_midair&quot;, &quot;ups_parcel&quot;);
    worldScripts[&quot;ups_parcel&quot;].upsMarkSystem(system.ID, &quot;ups_parcel&quot;);
    worldScripts[&quot;ups_parcel&quot;].ups_parcel = &quot;MIDAIR_DELIVERY&quot;;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsPirateCapsule.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;upsPirateCapsule&quot;;
this.author			= &quot;eric Walch&quot;;
this.copyright		= &quot;2008 eric walch&quot;;
this.comment		= &quot;Script for the pirate escape pods in the phyton mission&quot;
this.version		= &quot;1.1&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    // this.ship.setCargo(&quot;slaves&quot;, 1)
};



this.shipWasScooped = function (scooper)
{
	 if (scooper.isPlayer &amp;&amp; worldScripts[&quot;ups_container&quot;].ups_container === &quot;FOUND2&quot;)
	 {
		worldScripts[&quot;ups_container&quot;].ups_container_award += 750;
        if (++worldScripts[&quot;ups_container&quot;].ups_container_count &lt; 5)
        {
            this.ship.displayName = expandDescription(&quot;Pirate capsule nr &quot; + worldScripts[&quot;ups_container&quot;].ups_container_count);
        }
        else
        {
            this.ship.displayName = expandDescription(&quot;Last pirate capsule&quot;);
            mission.setInstructionsKey(&quot;ups_containers_small2a&quot;, &quot;ups_container&quot;);
        }
	 }
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsPiratebase.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsPiratebase&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2008 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.ReserveEnergy = this.ship.maxEnergy * missionVariables.ups_c2count * 0.25
    // make ship 25% stronger on every kill.
    delete this.shipSpawned;

	if (this.ship.group)
    {
        this.ship.group.name = &quot;Pirate Group&quot;;
        var defenders = system.shipsWithRole(&quot;upsdefender&quot;, this.ship, 50000)
        for (var i=0; i&lt;defenders.length; i++)
        {
            this.ship.group.addShip(defenders[i]);
        }
    }
}

this.shipDied = function ()
{
    var ups_container = worldScripts[&quot;ups_container&quot;].ups_container;
    if (ups_container === &quot;SEARCHING3&quot; || ups_container === &quot;JOINED_PIRATES&quot; || ups_container === &quot;JOINED_PIRATES2&quot;) worldScripts[&quot;ups_container&quot;].ups_container = &quot;FOUND3&quot;;
    if (ups_container === &quot;SEARCHING4&quot;) worldScripts[&quot;ups_container&quot;].ups_container = &quot;FOUND4&quot;;
    missionVariables.TL_FOR_EQ_UPS_POLICE_SCANNER = null;
    missionVariables.TL_FOR_EQ_UPS_IDCLEANER = null;
    this.ship.commsMessage(&quot;Next time we will have an even stronger base!&quot;);
    if (worldScripts[&quot;ups_container&quot;].ups_cloaking &amp;&amp; worldScripts[&quot;ups_container&quot;].ups_cloaking === &quot;CRIPPLED&quot;)
    {
        var damaged = (player.ship.equipmentStatus(&quot;EQ_CRIPPLED_CLOAKING&quot;) === &quot;EQUIPMENT_DAMAGED&quot;); // even the cripled one can get damaged in fight.

        if (player.ship.equipmentStatus(&quot;EQ_CRIPPLED_CLOAKING&quot;) !== &quot;EQUIPMENT_UNAVAILABLE&quot;) // player has the equipment
		{
			player.ship.removeEquipment(&quot;EQ_CRIPPLED_CLOAKING&quot;);
			player.ship.awardEquipment(&quot;EQ_CLOAKING_DEVICE&quot;);
            if (damaged) player.ship.setEquipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
		}
		if (!damaged) player.consoleMessage(&quot;Cloaking ability restored&quot;, 4);
    }
	mission.setInstructionsKey(&quot;ups_containers_small4b&quot;, &quot;ups_container&quot;);
    worldScripts[&quot;ups_container&quot;].upsUnmarkSystem(missionVariables.ups_cplanet, &quot;ups_container&quot;);

    delete this.shipDied;
}

this.shipBeingAttacked = function (attacker)
{
    if (this.ship.energy &lt; this.ship.maxEnergy * 0.5 &amp;&amp; this.ReserveEnergy &gt; 0)
    {
        if (this.ReserveEnergy &gt; 500)
        {
            this.ReserveEnergy -= 500;
            this.ship.energy += 500;
            this.ship.commsMessage(&quot;You can shoot now, but we win at the end.&quot;);
        }
        else
        {
            this.ship.energy += this.ReserveEnergy;
            this.ReserveEnergy = 0;
        }
    }
}

this.stationLaunchedShip = function (ship)
{
    if (ship.primaryRole == &quot;defense_ship&quot;) ship.switchAI(&quot;upsPirateBasePirateAI.plist&quot;);
	if (ship.primaryRole == &quot;scavenger&quot;  &amp;&amp; !ship.bounty) ship.bounty = Math.random()*30;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsPoliceScanner.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;upsPoliceScanner&quot;;
this.author			= &quot;Eric Walch&quot;;
this.copyright		= &quot;2010 Eric&quot;;
this.description	= &quot;Script for special ups equipment.&quot;;
this.version		= &quot;1.0&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;


this.activated = function()
{
    worldScripts[&quot;ups_container&quot;].upsPoliceScanner();
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsPrivateEscort.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsPrivateEscort&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;2008 eric walch&quot;;
this.description    = &quot;Script for the escorts as equipment&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;


this.shipDied = function()
{
    if (missionVariables.ups_private_escorts &gt; 0) --missionVariables.ups_private_escorts
    player.consoleMessage(&quot;Trainee escort died, &quot; + missionVariables.ups_private_escorts + &quot; escorts left.&quot;, 6)
}

this.findPlayerHostiles = function()
{
    function isHostileToPlayer(entity)
    {
        return (entity.isShip &amp;&amp; entity.target &amp;&amp; entity.target === player.ship &amp;&amp; entity.hasHostileTarget);
    }
    if (this.ship.target == player.ship &amp;&amp; player.ship.target &amp;&amp; player.ship.target.bounty &gt; 10)
    {
        this.ship.target = player.ship.target
        this.ship.reactToAIMessage(&quot;TARGET_FOUND&quot;);
        //log(this.name, &quot;UPS escort is going to attack: &quot;+this.ship.target.name);
        this.sendMessage(&quot;I&#39;ll help you killing that &quot;+this.ship.target.name+&quot;.&quot;)
    }
    else
    {
        var targets = system.filteredEntities(this, isHostileToPlayer, this.ship, this.ship.scannerRange)
        if (targets.length &gt; 0)
        {
            this.ship.target = targets[0];
            this.ship.reactToAIMessage(&quot;TARGET_FOUND&quot;);
            //log(this.name, &quot;UPS escort is going to attack: &quot;+targets[0].name);
            this.sendMessage(&quot;I&#39;ll take care of the &quot;+this.ship.target.name+&quot;.&quot;)
        }
        else this.ship.reactToAIMessage(&quot;NOTHING_FOUND&quot;);
    }
}

this.signOn = function()
{
    if(missionVariables.ups_private_escorts == 1) this.sendMessage(&quot;I&#39;ll escort you.&quot;)
    else this.sendMessage(&quot;All &quot; + missionVariables.ups_private_escorts + &quot; of us will escort you.&quot;)
}

this.searchMother = function()
{
    this.ship.target = player.ship;
}

this.sendMessage = function(message)
{
	if (worldScripts[&quot;ups_docs&quot;].messageAllowed()) this.ship.commsMessage(message)
    // no messages within 5 secs to avoid screen clutter.
}


/*
This is currently not working because of mass locking.
Should work with Oolite 1.75 in a different form though because of the introduced player wormhole.

this.playerWillEnterWitchspace = function ()
{
    if (missionVariables.ups_private_escorts &amp;&amp; missionVariables.ups_private_escorts &gt; 0)
    {
        this.ship.fuel = 7;
        this.ship.position = new Vector3D(-10E6*Math.random(), -50E8*Math.random(), -60E9);
        var success = this.ship.exitSystem(player.ship.targetSystem);
        if (!success) log(this.ship, &quot;A private escort had a mass lock problem&quot;);
    }
}
*/
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsPython.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsPython&quot;;
this.author    = &quot;eric walch, spara&quot;;
this.copyright = &quot;2008 eric walch. 2014 spara&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.difficulty = parseInt(this.ship.scriptInfo.difficulty);
    var missilesAvailable = [&quot;EQ_HARDENED_MISSILE&quot;, &quot;EQ_HARDENED_MISSILE&quot;];
    if (worldScripts[&quot;Missiles &amp; Bombs&quot;])
    {
        // if M&amp;B is installed, use some of that missiles.
        missilesAvailable.push(&quot;EQ_RMB_FRAG_MISSILE&quot;, &quot;EQ_RMB_OVERRIDE_MISSILE&quot;);
    }
    if (this.difficulty &gt;= 2)
    {
        if (EquipmentInfo.infoForKey(&quot;EQ_HARPOON_NUKE1_MISSILE&quot;))
        {
            // if nukes.oxp is installed, use some of that missiles.
            missilesAvailable.push(&quot;EQ_HARPOON_NUKE1_MISSILE&quot;, &quot;EQ_HARPOON_NUKE3_MISSILE&quot;);
        }
    }
    if (this.difficulty == 3)
    {
        if (EquipmentInfo.infoForKey(&quot;EQ_I_MISSILE&quot;))
        {
            // if i-missile.oxp is installed, use some of that missiles.
            if (Math.random() &lt; 0.33) missilesAvailable.push(&quot;EQ_I_MISSILE&quot;);
        }
    }
    var missileCount = missilesAvailable.length;
    var capacity = this.ship.missileCapacity;

    for (var i=0; i &lt; capacity; i++)
    {
        // now fill the bay randomly with above missiles
        this.ship.awardEquipment(missilesAvailable[Math.floor(Math.random() * missileCount)]);
    }
	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
    delete this.shipSpawned;
}


this.shipDied = function (whom, why)
{
   log(&quot;UPS-Courier&quot;, &quot;Hostile Python killed by &quot; + whom + &quot; by means of &quot; + why);
   if ((whom &amp;&amp; whom.isPlayer) || (this.time &amp;&amp; this.time + 10 &gt; clock.absoluteSeconds))
   {
        this.ship.commsMessage(&quot;I&#39;ll be back with help for revenge!!&quot;);
        this.ship.spawn(&quot;pirate-upscapsule&quot;, 5);
        this.ship.spawn(&quot;ups-metalcontainer&quot;, 7);
        this.ship.spawn(&quot;cargopod&quot;, 8);
        worldScripts[&quot;ups_container&quot;].ups_container_count = 0;
        worldScripts[&quot;ups_container&quot;].ups_container_award = 0;
        worldScripts[&quot;ups_container&quot;].ups_container = &quot;FOUND2&quot;;
        mission.setInstructionsKey(&quot;ups_containers_small2c&quot;, &quot;ups_container&quot;);
        worldScripts[&quot;ups_container&quot;].upsUnmarkSystem(worldScripts[&quot;ups_container&quot;].ups_cplanet, &quot;ups_container&quot;);
    }
    else
    {
        // when python is killed by NPC, no variable is set and the mainscript adds a new one on next launch.
        log(&quot;UPS-Courier&quot;, &quot;New target Python will be added on next launch or witchspace jump&quot;);
    }
    delete this.shipDied;
}

this.shipBeingAttacked = function (whom)
{
    // check to ensure the player gets the award, even when he did not make the final kill.
    if (whom &amp;&amp; whom.isPlayer) this.time = clock.absoluteSeconds;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsRevoltingSlavePilot.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsRevoltingSlavePilot.js&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2010 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

// Unloading this pilot will start the homelands slave mission.

this.unloadCharacter = function ()
{
    worldScripts[&quot;ups_slaves&quot;].ups_slavename = expandDescription(&quot;[nom11] [nom1]&quot;);
    player.addMessageToArrivalReport(expandMissionText(&quot;ups_slave_thanks&quot;,
            {ups_slavename: worldScripts[&quot;ups_slaves&quot;].ups_slavename, dockedStationName: player.ship.dockedStation.displayName}));
    player.credits += 150;
    worldScripts[&quot;ups_slaves&quot;].ups_slaves = &quot;SLAVE&quot;;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSatelite.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;upsSatelite&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.description = &quot;Code for an upright satelite&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
	var targetVector = this.ship.position.subtract(system.mainPlanet.position).direction();
    this.ship.orientation = targetVector.rotationTo(new Vector3D(0,0,1));

	delete this.shipSpawned;
}

this.shipDied = function ()
{
    this.ship.commsMessage(&quot;Mayday, mayday, radar down!&quot;);
    var orientation = this.ship.orientation;
    if (--worldScripts[&quot;ups_slaves&quot;].ups_satellitecount == 0)
    {
        worldScripts[&quot;ups_slaves&quot;].ups_slaves = &quot;DEBRIEFING&quot;;
        this.ship.spawn(&quot;ups-slave-shuttle&quot;, 5).forEach(function (ship) {ship.orientation = orientation});
    }
}

this.launchSatelliteDefenders = function ()
{
	var orientation = this.ship.orientation;
	if (this.ship.target)
    {
		if (this.ship.target.alertCondition &lt; 3) this.ship.target.alertCondition++;
        this.ship.target.spawn(&quot;ups_satellite_defense&quot;, 3).forEach(function (ship) {ship.orientation = orientation});
    }
}
this.increaseTargetAlertLevel = function ()
{
	if (this.ship.target)
    {
		if (this.ship.target.alertCondition &lt; 3) this.ship.target.alertCondition++;
    }
}

/*
This satelite has role &quot;station&quot; for historical reasons: This way they could communicate over alert
levels with the legacy scripting.
*/
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsScavenger.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsScavenger&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2008 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

this.shipDied = function ()
{
    this.ship.spawn(&quot;ups-cargopod&quot;, Math.round(Math.random()*5) + 1);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSlaveCobra.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsSlaveCobra&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;2008 eric walch&quot;;
this.description    = &quot;ship far the slave missions&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.shipDied = function ()
{
    this.ship.spawn(&quot;ups-slavebarrel&quot;, 1);
}

/*
This slave barrel starts the slave missions
*/
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSlaveConvoy.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsSlaveConvoy&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;2008 eric walch&quot;;
this.description    = &quot;1.72 integration&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.shipDied = function (whom)
{
    this.ship.spawn(&quot;ups-slave_convoy_barrel&quot;, 2)
    if (whom &amp;&amp; whom.isPlayer)  worldScripts[&quot;ups_slaves&quot;].ups_convoy = &quot;KILLED&quot;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSlaveConvoyPilot.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsSlaveConvoyPilot&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2010 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

// Unloading pilots for the slave convoy mission.

this.unloadCharacter = function ()
{
    worldScripts[&quot;ups_slaves&quot;].ups_sl2count++;
    if (worldScripts[&quot;ups_slaves&quot;].ups_convoy &amp;&amp; worldScripts[&quot;ups_slaves&quot;].ups_convoy == &quot;ADDED&quot;)
    {
        worldScripts[&quot;ups_slaves&quot;].ups_convoy = &quot;KILLED&quot;;
        player.addMessageToArrivalReport(expandMissionText(&quot;ups_slave_rescue_docking&quot;), {ups_slavename: worldScripts[&quot;ups_slaves&quot;].ups_slavename});
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSlaveRunnerPilot.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsSlaveRunnerPilot&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2010 - 2013, eric walch.&quot;;

// Unloading this pilot for the first time will start the slave missions.

this.unloadCharacter = function ()
{
    if (!worldScripts[&quot;ups_slaves&quot;].ups_slaverescue &amp;&amp; worldScripts[&quot;ups_parcel&quot;].ups_pcount &gt; 8)
    {
        // start the slave missions when not already active.
        worldScripts[&quot;ups_slaves&quot;].ups_slaverescue = true;
    }
    var credits = (0 &lt; oolite.compareVersion(&quot;1.77&quot;)) ?
                    Math.ceil(Math.random()*90) + 10 :
                    player.ship.dockedStation.market.slaves.price / 10;
    player.addMessageToArrivalReport(expandMissionText(&quot;ups_slave_runner&quot;,{ups_credits: credits.toFixed(1)}));
    player.credits += credits;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSlaveShuttle.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsSlaveShuttle&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;April 2008 eric walch&quot;;
this.description    = &quot;Rising shuttle for slave mission&quot;;
this.version        = &quot;1.00&quot;;

this.shipDied = function ()
{
    worldScripts[&quot;ups_slaves&quot;].ups_slavesrescued--;
};

/*
Maybe we should select a random ship with &quot;shuttle&quot; role and attach this script in future instead of a predefined ship?
*/</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSpilledBarrel.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;upsSpilledBarrel&quot;;
this.author			= &quot;eric Walch&quot;;
this.copyright		= &quot;2008 eric walch&quot;;
this.comment		= &quot;Script for the ups-spilled-container. Used by the Boa mission and the spillage mission.&quot;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.shipWasScooped = function (scooper)
{
	 ++worldScripts[&quot;ups_container&quot;].ups_total_container_count;
	 --worldScripts[&quot;ups_container&quot;].ups_container_remaining;
	 if (scooper.isPlayer)
	 {
		++worldScripts[&quot;ups_container&quot;].ups_container_count;
		worldScripts[&quot;ups_container&quot;].ups_container_award += 500;
	 }
	 else
	 {
		player.consoleMessage(&quot;ups-container nr &quot; + worldScripts[&quot;ups_container&quot;].ups_total_container_count + &quot; scooped by &quot;+scooper.displayName);
	 }

	 if (worldScripts[&quot;ups_container&quot;].ups_container === &quot;SPILLAGE3&quot;)
     {
        if (worldScripts[&quot;ups_container&quot;].ups_container_remaining &gt; 0)
        {
            mission.setInstructionsKey(expandMissionText(&quot;ups_container_scattered_small1&quot;,
                {ups_container_remaining: worldScripts[&quot;ups_container&quot;].ups_container_remaining}), &quot;ups_container&quot;);
        }
        else
        {
            mission.setInstructionsKey(&quot;ups_container_scattered_small3&quot;, &quot;ups_container&quot;);
            player.consoleMessage(expandDescription(&quot;Last ups-container scooped, return to base.&quot;));
        }
     }
	 // do something with NPC once possible
}

this.shipDied = function()
{
	 ++worldScripts[&quot;ups_container&quot;].ups_total_container_count;
	 --worldScripts[&quot;ups_container&quot;].ups_container_remaining;
	 player.consoleMessage(&quot;ups-container nr &quot; + worldScripts[&quot;ups_container&quot;].ups_total_container_count + &quot; is destroyed&quot;);
	 if (worldScripts[&quot;ups_container&quot;].ups_container === &quot;SPILLAGE3&quot;) mission.setInstructionsKey(&quot;ups_container_scattered_small1&quot;, &quot;ups_container&quot;);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSplinter.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;upsSplinter&quot;;
this.author			= &quot;Eric Walch&quot;;
this.copyright		= &quot;2008 eric walch&quot;;
this.comment		= &quot;Ship script for gold/platinum splinters.&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

// initialising splinter
this.initialising = function ()
{
	//log(&quot;ups&quot;, &quot;added valuabels&quot;);
    this.amount = Math.ceil(Math.random() * 12);
    this.metal = Math.random() &lt; 0.40 ? &quot;platinum&quot; : &quot;gold&quot;;
    this.ship.setCargo(this.metal, this.amount);
    this.init = true;
}

this.shipWasScooped = function (scooper)
{
	//log(&quot;ups&quot;, &quot;scooped&quot;);
	if (!this.init) this.initialising();
    if (scooper.isPlayer)
	{
		player.consoleMessage(this.amount + (this.amount === 1 ? &quot; kilogram &quot; : &quot; kilograms &quot;) + this.metal);
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSunResearcher.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsSunResearcher&quot;;
this.author         = &quot;Eric Walch&quot;;
this.copyright      = &quot;2008 eric walch&quot;;
this.description    = &quot;ship far the solar missions&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

this.shipDied = function (whom)
{
    worldScripts[&quot;ups_sun&quot;].researcher_count++;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsSunResearcherPilot.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name      = &quot;upsSunResearcherPilot&quot;;
this.author    = &quot;eric walch&quot;;
this.copyright = &quot;2010 eric walch.&quot;;
this.license   = &quot;CC BY-NC-SA 3.0&quot;;

// Unloading pilots for the final sun mission.

this.unloadCharacter = function ()
{
    worldScripts[&quot;ups_sun&quot;].ups_s2count++;
    worldScripts[&quot;ups_sun&quot;].ups_s2award += 150;
    if (worldScripts[&quot;ups_sun&quot;].ups_rescue == &quot;YES&quot;)
    {
        player.addMessageToArrivalReport(expandMissionText(&quot;ups_researcher_thanks&quot;, {dockedStationName: player.ship.dockedStation.displayName}));
        worldScripts[&quot;ups_sun&quot;].ups_rescue = &quot;PILOT&quot;;
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsTrader.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;upsTrader&quot;;
this.author      = &quot;eric walch, spara&quot;;
this.copyright   = &quot;2008 eric walch. 2014 spara&quot;;
this.description = &quot;Code for a generic ups-trader&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;

this.shipSpawned = function ()
{
    this.cargo = Math.round(this.ship.cargoSpaceCapacity / 10);
	//name escorts with randomshipnames, if present -spara-
	if (worldScripts.randomshipnames &amp;&amp; this.ship.escorts) {
		for (var i = 0; i &lt; this.ship.escorts.length; i++) {
			var shipName = worldScripts.randomshipnames.$randomHunterName(ship);
			this.ship.escorts[i].displayName = this.ship.escorts[i].displayName + &quot;: &quot; + shipName;
		}
	}
	//order escorts with escort formations, if present -spara-
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
    delete this.shipSpawned;
}

this.shipDied = function ()
{
    var genericCargo = Math.ceil(this.cargo * 0.66);
    this.ship.spawn(&quot;cargopod&quot;, genericCargo);
    this.ship.spawn(&quot;ups-cargopod&quot;, this.cargo - genericCargo);
}

this.shipBeingAttacked = function ()
{
    if(Math.random() &lt; 0.05 &amp;&amp; this.cargo &gt; 0)
    {
        this.ship.ejectItem(&quot;cargopod&quot;);
        this.cargo--;
    }
}

this.checkStation = function ()
{
   var stations = system.shipsWithRole(&quot;station&quot;, this.ship, 50000);
   if(stations.length &gt; 0 &amp;&amp; stations[0] !== this.lastStation)
   {
		this.lastStation = stations[0];
		if (Math.random() &lt; 0.5 &amp;&amp; stations[0] != system.mainStation &amp;&amp; stations[0].hasNPCTraffic)
		{
			this.ship.target = stations[0];
			this.ship.reactToAIMessage(&quot;UPS_STATION_FOUND&quot;);
		}
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsUniversalScanner.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;upsUniversalScanner&quot;;
this.author			= &quot;Eric Walch&quot;;
this.copyright		= &quot;2010 Eric&quot;;
this.description	= &quot;Script for special ups equipment.&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;


this.activated = function()
{
    worldScripts[&quot;ups_container&quot;].upsUniversalScanner();
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/upsViperEscort.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;upsViperEscort&quot;;
this.author         = &quot;Eric Walch, spara&quot;;
this.copyright      = &quot;2008 eric walch, 2014 spara&quot;;
this.description    = &quot;Escorts used for one single parcel mission&quot;;
this.license        = &quot;CC BY-NC-SA 3.0&quot;;

//use randomshipnames oxp, if present -spara-
this.shipSpawned = function() {
	if (worldScripts.randomshipnames) {
		var shipName = worldScripts.randomshipnames.$randomPoliceName(ship);
		shipName = shipName.slice(0, shipName.length - 2) + &quot;TR&quot;;
		ship.displayName = ship.name + &quot;: &quot; + shipName;
	}
}

this.shipDied = function ()
{
    if (missionVariables.ups_escorts &gt; 0) --missionVariables.ups_escorts;
    player.consoleMessage(&quot;Trainee escort died, &quot; + missionVariables.ups_escorts + &quot; escorts left.&quot;, 6);
}

this.signOn = function ()
{
    if (missionVariables.ups_escorts === 1) this.sendMessage(&quot;I&#39;ll escort you.&quot;)
    else this.sendMessage(&quot;All &quot; + missionVariables.ups_escorts + &quot; of us will escort you.&quot;);
}

this.startAttack = function ()
{
    if (this.ship.target.bounty === 0)
    {
        this.ship.reactToAIMessage(&quot;TARGET_LOST&quot;);
        return;
    }

    if (player.ship.target &amp;&amp; player.ship.target === this.ship.target)
        this.sendMessage(&quot;I&#39;ll help you killing that &quot; + this.ship.target.name + &quot;.&quot;)
    else
        this.sendMessage(&quot;I&#39;ll take care of the &quot; + this.ship.target.name + &quot;.&quot;);
}

this.sendMessage = function (message)
{
	if (worldScripts[&quot;ups_docs&quot;].messageAllowed()) this.ship.commsMessage(message);
    // no messages within 5 secs to avoid screen clutter.
}

this.searchMother = function ()
{
    this.ship.target = player.ship;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;UPS_Conditions&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2015 phkb&quot;;
this.description = &quot;Condition script for equipment.&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function(equipment, ship, context) {

	if (context == &quot;scripted&quot;) return true;
	if (context == &quot;npc&quot;) return false;

	switch (equipment) {
		case &quot;EQ_CRIPPLED_CLOAKING&quot;: return false;
		case &quot;EQ_UPS_POLICE_SCANNER&quot;:
		case &quot;EQ_UPS_IDCLEANER&quot;:
			if (system.info.government == 0) {
				return true;
			} else {
				return false;
			}
		case &quot;EQ_UPS_UNIVERSAL_SCANNER&quot;: return false;
		case &quot;EQ_UPS_PRIVATE_ESCORT&quot;:
			if (system.info.government &gt; 3 &amp;&amp; !missionVariables.ups_private_escorts &amp;&amp; player.ship.dockedStation.isMainStation &amp;&amp; player.bounty == 0) {
				return true;
			} else {
				return false;
			}
	}

	return true;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_container.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;ups_container&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Container missions of UPS Courier&quot;;

this.startUp = function ()
{
    this.pirate = &quot;pirate&quot;; // since 1.73 pirates get a bounty
    this.tiger = (worldScripts.TigersTurf) ? &quot;tigers&quot; : this.pirate;
    this.upsMarkSystem = worldScripts[&quot;ups_docs&quot;].upsMarkSystem;
    this.upsUnmarkSystem = worldScripts[&quot;ups_docs&quot;].upsUnmarkSystem;
}

this.shipLaunchedFromStation = function ()
{
    this.setUpShips();
    if (this.ups_container === &quot;SPILLAGE2&quot;)
    {
        this.ups_container = &quot;SPILLAGE3&quot;;
        this.spillCargo();
    }
    this.startScanners();
}

this.missionScreenOpportunity = function ()
{
    if (player.ship.docked)
    {
        this.missionOffers();
    }
}

this.guiScreenChanged = function (newScreen, oldScreen)
{
    if (this.restartMissionOffer &amp;&amp; newScreen !== &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
    {
        this.restartMissionOffer = false;
        if (guiScreen !== &quot;GUI_SCREEN_MISSION&quot;) this.missionOffers();
    }
}

this.missionOffers = function ()
{
    if (this._savedTargetSet) player.ship.targetSystem = this._savedTarget
    this._savedTarget = null;
    this._savedTargetSet = false;

	var containerStatus = this.ups_container;
    if (player.ship.dockedStation.isMainStation)
    {
        var ups_choices;
        if (containerStatus === &quot;BOA&quot; &amp;&amp; worldScripts[&quot;ups_parcel&quot;].ups_pcount &gt; 2 &amp;&amp; system.government &gt; 3
                        &amp;&amp; player.ship.bounty &lt; 3 &amp;&amp; this._reputation() &gt; 2 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
        {
            ups_choices = &quot;ups_container_accepted_yesnolook&quot;;
            if (!this.mark)
            {
                var infoList = this._getSystemsInRange(35);
                var targetSystem = infoList[Math.floor(Math.random()*infoList.length)];
                this.ups_cplanet = targetSystem.systemID;
                missionVariables.ups_cplanetname = targetSystem.name;
                this.ups_distance = system.info.distanceToSystem(targetSystem).toFixed(1)
                            + &quot; LY to the &quot;+this.positionToDirection(targetSystem.coordinates);
                this.mark = true;
            }
            var key;
			switch (this.ups_ccount)
			{
				case 0: key = &quot;ups_container_1st_offer&quot;; break;
				case 1: key = &quot;ups_container_offer&quot;; break;
				default: key = &quot;ups_container_offer_bis&quot;; break;
			}
            var message = expandMissionText(key, {ups_distance: this.ups_distance, ups_cplanet: this.ups_cplanet});
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Boa Mission&quot;, message: message, overlay: this._overlay(),
                                choicesKey: ups_choices, model: this.boa()}, this.choiceEvaluation);
            this.offering = &quot;UPS_CONTAINER1&quot;;
            this.ups_container_count = 0;
            this.ups_container_award = 0;
        }
        if (containerStatus === &quot;SEARCHING&quot;)
        {
            var daysPast = clock.days - this.ups_timerstart;
            if (daysPast &gt; 30 &amp;&amp; system.government &gt; 1)
            {
                this.ups_container = &quot;NOT_NOW&quot;;
                var message = expandMissionText(&quot;ups_container_boa_withdraw&quot;, {ups_days_past: daysPast});
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Boa Mission&quot;, message: message, overlay: this._overlay()});
                delete this.ups_timerstart;
                this.upsUnmarkSystem(this.ups_cplanet, this.name);
                mission.setInstructionsKey(null);
            }
            else if (this.ups_cplanet === system.ID &amp;&amp; (missionVariables.ups_closecontact === &quot;DOCKED&quot; || system.countShipsWithRole(&quot;boa_ptt&quot;) === 0))
            {
                this.upsUnmarkSystem(this.ups_cplanet, this.name);
                var infoList = this._getSystemsInRange(7);
                var info = infoList[Math.floor(Math.random()*infoList.length)];
                this.ups_cplanet = info.systemID;
                missionVariables.ups_cplanetname = System.systemNameForID(info.systemID);
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Boa Mission&quot;, messageKey: &quot;ups_container_missed&quot;, overlay: this._overlay()});
                mission.setInstructions(expandMissionText(&quot;ups_containers_small1b&quot;, {ups_cplanet: this.ups_cplanet}));
                this.upsMarkSystem(this.ups_cplanet, this.name);
				missionVariables.ups_closecontact = &quot;NO&quot;;
            }
        }
        if (containerStatus === &quot;FOUND&quot; &amp;&amp; system.government &gt; 1)
        {
            this.ups_container = &quot;NOT_NOW&quot;;
            this.upsUnmarkSystem(this.ups_cplanet, this.name);
            mission.setInstructionsKey(null);
            var key;
            if (!this.ups_container_count)
            {
                // no containers scooped.
                if (missionVariables.ups_closecontact === &quot;YES&quot;)
                {
                    key = &quot;ups_container_destroyed0&quot;;
                    player.credits += 100;
                }
                else
                {
                    key = &quot;ups_container_destroyed0a&quot;;
                }
            }
            else
            {
                if (this.ups_container_count === 5)
                {
                    // all containers scooped.
                    this.ups_container_award += 1000;
                    key = &quot;ups_container_destroyed2&quot;;
                }
                else
                {
                    // some containers scooped.
                    key = &quot;ups_container_destroyed1&quot;;
                }
                this.ups_ccount++;
                player.credits += this.ups_container_award;
            }
            var message = expandMissionText(key, {ups_container_count: this.ups_container_count, ups_container_award: this.ups_container_award});
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Boa Mission&quot;, message: message, overlay: this._overlay()});
            missionVariables.ups_target = &quot;hostile Boa&quot;;
            if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
            if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
			this.ups_timerstart = clock.days;
			worldScripts[&quot;ups_docs&quot;].increaseReputation(5);
            delete missionVariables.ups_closecontact;
            delete missionVariables.ups_b2planet; // no longer used variables
            delete missionVariables.ups_b2planetname; // no longer used variables
			if (this.ups_total_container_count &lt; 5) // there are still containers out there.
			{
				this.ups_container = &quot;SPILLAGE3&quot;; // go further as spillage mission.
				this.ups_cplanet = system.ID;
				this.ups_container_remaining = system.countShipsWithPrimaryRole(&quot;ups-spilled-container&quot;);
				this.ups_container_count = 0;
				this.ups_container_award = 0;
			}
			else
			{
				delete this.ups_total_container_count;
			}
        }
        if (containerStatus === &quot;LOGGING&quot;)
        {
            var daysPast = clock.days - this.ups_timerstart;
            if (system.government &gt; 3 &amp;&amp; player.ship.bounty &lt; 3 &amp;&amp; daysPast &gt; 8
                        &amp;&amp; this._reputation() &gt; 3 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
            {
                ups_choices = &quot;ups_container_accepted2_yesnolook&quot;;
                var messageKey = (!this.ups_c1count ? &quot;ups_container_1st_logging&quot; : &quot;ups_container_logging&quot;);
                var message = expandMissionText(messageKey, {ups_days_past: daysPast, ups_cplanet: this.ups_cplanet});
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Python Mission&quot;, message: message,
                                    overlay: this._overlay(), choicesKey: ups_choices,
                                    model: this.python()}, this.choiceEvaluation)
                this.offering = &quot;UPS_CONTAINER2&quot;;
                this.ups_container_count = 0;
                this.ups_container_award = 0;
            }
        }
        if (containerStatus === &quot;FOUND2&quot;)
        {
            if (system.government &gt; 1)
            {
                this.ups_container = &quot;NOT_NOW&quot;;
                this.upsUnmarkSystem(this.ups_cplanet, this.name);
                mission.setInstructionsKey(null);
                var key;
                if (!this.ups_container_count)
                {
                    key = &quot;ups_container_destroyed02&quot;;
                    player.credits += 100;
                }
                else
                {
                    if (this.ups_container_count === 5)
                    {
                        this.ups_container_award += 1000;
                        key = &quot;ups_container_destroyed22&quot;;
                    }
                    else
                    {
                        key = &quot;ups_container_destroyed12&quot;;
                    }
                    this.ups_c1count += 1;
                    player.credits += this.ups_container_award;
                }
                var message = expandMissionText(key, {ups_container_count: this.ups_container_count, ups_container_award: this.ups_container_award});
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Python Mission&quot;, message: message, overlay: this._overlay()});
                delete this.ups_container_award;
                delete this.ups_container_count;
				worldScripts[&quot;ups_docs&quot;].increaseReputation(3);
                if (this.ups_c1count &gt; 4 &amp;&amp; !missionVariables.TL_FOR_EQ_UPS_PRIVATE_ESCORT) {this.ups_container_message = 2};
                missionVariables.ups_target = &quot;pirate python&quot;;
                if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
                if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
				this.ups_timerstart = clock.days;
                delete this.ups_container_destroyed;
            }
            else
            {
                if (!this.ups_container_destroyed)
                {
                    var message = expandMissionText(&quot;ups_container_destroyed3&quot;, {ups_container_count: this.ups_container_count, dockedStationName: player.ship.dockedStation.displayName});
                    mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Python Mission&quot;, message: message, overlay: this._overlay()});
                    this.upsUnmarkSystem(this.ups_cplanet, this.name);
                    if (!this.ups_container_count) mission.setInstructionsKey(&quot;ups_containers_small2b&quot;)
                    else mission.setInstructionsKey(&quot;ups_containers_small2a&quot;);
                    this.ups_container_destroyed = true;
                }
            }
        }
        if (containerStatus === &quot;LOGGING2&quot;)
        {
            var daysPast = clock.days - this.ups_timerstart;
            if (system.government &gt; 3 &amp;&amp; player.ship.bounty &lt; 3 &amp;&amp; daysPast &gt; 8
                            &amp;&amp; this._reputation() &gt; 4 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
            {
                ups_choices = &quot;ups_container_accepted3_yesnolook&quot;;
                var key;
                if (player.ship.equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;) === &quot;EQUIPMENT_OK&quot;)
                {
                    key = (!this.ups_c2count) ? &quot;ups_container_1st_logging2cloaked&quot; : &quot;ups_container_logging2cloaked&quot;;
                }
                else
                {
                    key = (!this.ups_c2count) ? &quot;ups_container_1st_logging2&quot; : &quot;ups_container_logging2&quot;;
                }
                var message = expandMissionText(key, {ups_days_past: daysPast});
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Base Mission&quot;, message: message, overlay: this._overlay(),
                                    choicesKey: ups_choices}, this.choiceEvaluation)
                this.offering = &quot;UPS_CONTAINER3&quot;;
                this.ups_container_award = 0;
                this.ups_container_count = 0;
            }
        }
        if (containerStatus === &quot;SEARCHING3&quot; &amp;&amp; this.ups_c2count &gt; 2)
        {
            if (!missionVariables.ups_switch) missionVariables.ups_switch = this.ups_c2count
            else missionVariables.ups_switch += this.ups_c2count;
            if ((missionVariables.ups_switch - Math.random()*100) &gt; 30 &amp;&amp; system.ID !== this.ups_cplanet)
            {
                this.ups_container = &quot;SEARCHING4&quot;;
                delete missionVariables.ups_switch;
                this.ups_timerstart = clock.days;
            }
        }
        if (containerStatus === &quot;FOUND3&quot; &amp;&amp; system.government &gt; 1)
        {
            this.ups_container = &quot;NOT_NOW&quot;;
            this.upsUnmarkSystem(this.ups_cplanet, this.name);
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Base Mission&quot;, messageKey: &quot;ups_container_base_destroyed&quot;, overlay: this._overlay()});
            mission.setInstructionsKey(null);
            if (!this.ups_c2count) this.ups_c2count = 0;
            this.ups_c2count++;
            player.credits += 2000;
			worldScripts[&quot;ups_docs&quot;].increaseReputation(5);
            delete missionVariables.ups_switch;
            missionVariables.ups_target = &quot;pirate base&quot;;
            if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
            if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
			this.ups_timerstart = clock.days;
        }
        if (containerStatus === &quot;SEARCHING4&quot; &amp;&amp; system.government &gt; 3)
        {
            if (clock.days - this.ups_timerstart &gt; 15)
            {
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Base Mission&quot;, messageKey: &quot;ups_container_qbomb&quot;, overlay: this._overlay()});
                this.ups_timerstart = clock.days;
            }
        }
        if (containerStatus === &quot;FOUND4&quot; &amp;&amp; system.government &gt; 1)
        {
            this.ups_container = &quot;NOT_NOW&quot;;
            this.upsUnmarkSystem(this.ups_cplanet, this.name);
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Base Mission&quot;, messageKey: &quot;ups_container_base2_destroyed&quot;, overlay: this._overlay()});
            mission.setInstructionsKey(null);
            if (!this.ups_c3count) this.ups_c3count = 0;
            this.ups_c3count++;
            player.credits += 4000;
            if (this.ups_c3count == 1) this.ups_container_message = 1;
            if (this.ups_c3count &gt; 1 &amp;&amp; player.score &gt; 6400 &amp;&amp; !missionVariables.TL_FOR_EQ_UPS_UNIVERSAL_SCANNER)
            {
                this.ups_container_message = 3
            };
			worldScripts[&quot;ups_docs&quot;].increaseReputation(6);
            delete missionVariables.ups_switch;
            missionVariables.ups_target = &quot;guarded pirate base&quot;;
            if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
            if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_target_killed]&quot;)});
			this.ups_timerstart = clock.days;
        }
        if (containerStatus === &quot;JOINED_PIRATES&quot; &amp;&amp; system.government &gt; 3 &amp;&amp; Math.random() &lt; 0.2)
        {
            this.ups_container = &quot;JOINED_PIRATES2&quot;;
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Base Mission&quot;, messageKey: &quot;ups_container_piratelife&quot;, overlay: this._overlay()});
            player.ship.bounty += 1000;
            mission.setInstructionsKey(null);
            this.upsUnmarkSystem(this.ups_cplanet, this.name);
			worldScripts[&quot;ups_docs&quot;].increaseReputation(-25);
         }
        if (containerStatus === &quot;SPILLAGE&quot; &amp;&amp; system.government &gt; 3)
        {
            this.ups_container = &quot;SPILLAGE2&quot;;
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Container Retreival&quot;, messageKey: &quot;ups_container_scattered_1&quot;, overlay: this._overlay()});
            this.ups_cplanet = system.ID;
            this.upsMarkSystem(this.ups_cplanet, this.name);
            mission.setInstructionsKey(&quot;ups_container_scattered_small&quot;);
        }
        if (containerStatus === &quot;SPILLAGE3&quot;)
        {
            if (this.ups_container_count &gt; 0)
            {
                var message = expandMissionText(&quot;ups_container_scattered_2&quot;, {ups_container_count: this.ups_container_count, ups_container_award: this.ups_container_award});
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Container Retreival&quot;, message: message, overlay: this._overlay()});
                this.ups_container_remaining = system.countShipsWithRole(&quot;ups-spilled-container&quot;);
                player.credits += this.ups_container_award;
				worldScripts[&quot;ups_docs&quot;].increaseReputation(Math.ceil(this.ups_container_count/5));
                if (this.ups_container_remaining &gt; 0)
                {
                    message = expandMissionText(&quot;ups_container_scattered_3&quot;, {ups_container_remaining: this.ups_container_remaining});
                    mission.addMessageText(message);
                    mission.setInstructionsKey(&quot;ups_container_scattered_small2&quot;);
					this.ups_container_award = 0;
					this.ups_container_count = 0;
					this.ups_total_container_count = 0;
                }
                else
                {
                    this.ups_container = &quot;NOT_NOW&quot;;
                    this.upsUnmarkSystem(this.ups_cplanet, this.name);
                    mission.setInstructionsKey(null);
                    delete this.ups_cplanet;
					delete this.ups_container_remaining;
					delete this.ups_container_award;
					delete this.ups_container_count;
					delete this.ups_total_container_count;
                }
            }
        }
        if (this.ups_container_message &gt; 0 &amp;&amp; guiScreen !== &quot;GUI_SCREEN_MISSION&quot;)
        {
            var replacements = {ups_doc_count: worldScripts[&quot;ups_docs&quot;].ups_dcount, ups_parcel_count: worldScripts[&quot;ups_parcel&quot;].ups_pcount,
                                ups_boa_count: this.ups_ccount, ups_python_count: this.ups_c1count, ups_base1_count: this.ups_c2count,
                                ups_base2_count: this.ups_c3count}; // used to update variables in the missiontext below.
            var message;
            if (this.ups_container_message === 1)
            {
                message = expandMissionText(&quot;ups_container_the_end&quot;, replacements);
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Container Endmessage&quot;, message: message, overlay: this._overlay()});
                delete this.ups_container_message;
            }
            if (this.ups_container_message === 2 &amp;&amp; system.government &gt; 1 &amp;&amp; Math.random() &gt; 0.9)
            {
                message = expandMissionText(&quot;ups_container_message2&quot;, replacements);
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;UPS Escort Offer&quot;, message: message, overlay: this._overlay()});
                missionVariables.TL_FOR_EQ_UPS_PRIVATE_ESCORT = 7;
                delete this.ups_container_message;
            }
            if (this.ups_container_message === 3 &amp;&amp; system.government &gt; 1 &amp;&amp; system.techLevel &gt; 11 &amp;&amp; Math.random() &gt; 0.5)
            {
                message = expandMissionText(&quot;ups_container_message3&quot;, replacements);
                mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;UPS Scanner Offer&quot;, message: message, overlay: this._overlay()});
                missionVariables.TL_FOR_EQ_UPS_UNIVERSAL_SCANNER = 12;
                delete this.ups_container_message;
            }
        }
		if ((containerStatus === &quot;NO&quot; || containerStatus ===&quot;NOT_NOW&quot;) &amp;&amp; system.government &gt; 1)
		{
			if (player.ship.equipmentStatus(&quot;EQ_UPS_POLICE_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot; &amp;&amp; Math.random() &lt; 0.2)
			{
				player.ship.removeEquipment(&quot;EQ_UPS_POLICE_SCANNER&quot;);
				missionVariables.ups_galcop_punishment += 40;
				mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Scanner Removal&quot;, messageKey: &quot;ups_container_scannerremoved&quot;, overlay: this._overlay()});
				player.ship.bounty += missionVariables.ups_galcop_punishment;
			}
			else if (player.ship.equipmentStatus(&quot;EQ_UPS_IDCLEANER&quot;) === &quot;EQUIPMENT_OK&quot; &amp;&amp; Math.random() &lt; 0.2)
			{
				player.ship.removeEquipment(&quot;EQ_UPS_IDCLEANER&quot;);
				missionVariables.ups_galcop_punishment += 15;
				mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;ID Removal&quot;, messageKey: &quot;ups_container_idcleanerremoved&quot;, overlay: this._overlay()});
				player.ship.bounty += missionVariables.ups_galcop_punishment;
			}
		}
    }
    else if (player.ship.dockedStation.name === &quot;Pirate Rock&quot;)
    {
        var containerOffer = this.offering;
        if (missionVariables.ups_ecount &gt; 1 &amp;&amp; (containerStatus === &quot;LOGGING&quot; || containerStatus === &quot;LOGGING2&quot; || containerStatus === &quot;SEARCHING3&quot; || containerStatus === &quot;SEARCHING4&quot;))
        {
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Offer&quot;, messageKey: &quot;ups_container_pirateoffer&quot;,
                                choicesKey: &quot;ups_container_pirateoffer_yesno&quot;}, this.choiceEvaluation);
            this.offering = &quot;UPS_CONTAINER_PIRATE&quot;;
        }
        if (containerOffer === &quot;UPS_CONTAINER_PIRATE1&quot;)
        {
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Offer&quot;, messageKey: &quot;ups_container_pirateoffer2&quot;});
            this.offering = &quot;UPS_CONTAINER_PIRATE2&quot;;
        }
        if (containerOffer === &quot;UPS_CONTAINER_PIRATE2&quot;)
        {
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Offer&quot;, messageKey: &quot;ups_container_pirateoffer2a&quot;});
            this.offering = &quot;UPS_CONTAINER_PIRATE3&quot;;
        }
        if (containerOffer === &quot;UPS_CONTAINER_PIRATE3&quot;)
        {
            mission.runScreen({screenID: &quot;ups-container&quot;, title: &quot;Pirate Offer&quot;, messageKey: &quot;ups_container_pirateoffer2b&quot;});
            delete this.offering;
        }
    }
}

this.choiceEvaluation = function (choice)
{
    var containerOffer = this.offering;
    delete this.offering; // delete here in case a choice creates a new offer.
    if (this.mark)
    {
        mission.unmarkSystem({
                   system: this.ups_cplanet,
                   name: &quot;ups_marker&quot;
        })
    }
    switch (containerOffer)
    {
        case &quot;UPS_CONTAINER1&quot;:
        {
            this.mark = false
            if (choice === &quot;YESCon&quot;)
            {
                mission.setInstructionsKey(&quot;ups_containers_small1b&quot;, &quot;ups_container&quot;);
                this.upsMarkSystem(this.ups_cplanet, this.name);
                this.ups_container = &quot;SEARCHING&quot;;
                this.ups_timerstart = clock.days;
                missionVariables.ups_closecontact = &quot;NO&quot;;
                delete this.ups_distance;
            }
            else if (choice === &quot;LOOKCon&quot;)
            {
                this.upsShowDestination(this.ups_cplanet);
            }
            else if (choice === &quot;NOCon&quot;)
            {
                delete this.ups_distance;
                this.ups_container = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_CONTAINER2&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESCon&quot;)
            {
                mission.setInstructionsKey(&quot;ups_containers_small2&quot;, &quot;ups_container&quot;);
                this.upsMarkSystem(this.ups_cplanet, this.name);
                this.ups_container = &quot;SEARCHING2&quot;;
                }
            else if (choice === &quot;LOOKCon&quot;)
            {
                this.upsShowDestination(this.ups_cplanet);
            }
            else if (choice === &quot;NOCon&quot;)
            {
                this.ups_container = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_CONTAINER3&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESCon&quot;)
            {
                mission.setInstructionsKey(&quot;ups_containers_small4&quot;, &quot;ups_container&quot;);
                this.upsMarkSystem(this.ups_cplanet, this.name);
                this.ups_container = &quot;SEARCHING3&quot;;
            }
            else if (choice === &quot;LOOKCon&quot;)
            {
                this.upsShowDestination(this.ups_cplanet);
            }
            else if (choice === &quot;NOCon&quot;)
            {
                this.ups_container = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_CONTAINER_PIRATE&quot;:
        {
            if (choice === &quot;YESCon&quot;)
            {
                player.credits += 5000;
                this.offering = &quot;UPS_CONTAINER_PIRATE1&quot;;
                this.ups_container = &quot;JOINED_PIRATES&quot;;
                missionVariables.TL_FOR_EQ_UPS_POLICE_SCANNER = 3;
                missionVariables.TL_FOR_EQ_UPS_IDCLEANER = 5;
            }
            else if (choice === &quot;NOCon&quot;)
            {
                player.ship.launch();
                player.commsMessage(&quot;Yes, destroy the pirates.&quot;, 5);
                this.disableCloakingDevice();
            }
            break;
        }
        default: log(this.name, &quot;Encountered an illegal mission offer: &quot;+this.offering);
    }
}

this.upsShowDestination = function (ID)
{
    if (!this._savedTargetSet) this._savedTarget = player.ship.targetSystem;
    this._savedTargetSet = true;
    
    this.mark = true; // Keep this selected system.
    if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) == &quot;EQUIPMENT_OK&quot;)
    {
        player.ship.targetSystem = ID;
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, backgroundSpecial: &quot;LONG_RANGE_CHART_SHORTEST&quot;});
    }
    else
    {
        mission.markSystem({
                   system: ID,
                   name: &quot;ups_marker&quot;,
                   markerColor: &quot;cyanColor&quot;,
                   markerScale: 2.0,
                   markerShape: &quot;MARKER_DIAMOND&quot;
        })
        var message = expandMissionText(&quot;ups_long_range_screen&quot;, {ups_system: System.systemNameForID(ID)});
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, message: message, backgroundSpecial: &quot;LONG_RANGE_CHART&quot;});
    }
}

this.shipWillEnterWitchspace = function ()
{
    this.stopScanners();
}

this.shipExitedWitchspace = function ()
{
    if (system.isInterstellarSpace)
    {
        if (player.credits &gt; 10000 &amp;&amp; missionVariables.ups_tcount &gt; 2 &amp;&amp; player.ship.fuel &lt; 3 &amp;&amp; Math.random() &lt; 0.5)
        {
            if (worldScripts.transportSchedule || worldScripts.transportschedule !== undefined)  // has Transports.OXP installed
                system.addShipsToRoute(&quot;ups-womafueltanker&quot;, 1, 0.2, &#39;wp&#39;)
            else
                system.addShipsToRoute(&quot;ups-fueltanker&quot;, 1, 0.2, &#39;wp&#39;);
        }
        // this.startScanners();  // no scanning in interstellar space? One can still do it with the primed key.
        return;
    }
    this.setUpShips();
	var containerStatus = this.ups_container;
    if (containerStatus === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.11 &amp;&amp; !missionVariables.ups_target) this.ups_container = &quot;NO&quot;;
    if (containerStatus === &quot;NO&quot;)
    {
        if (system.government &gt; 3 &amp;&amp; Math.random() &lt; 0.05)
        {
            if (this.ups_ccount &lt; 10 || Math.random() &lt; 0.25)
                this.ups_container = &quot;BOA&quot;;
        }
        else if (this.ups_ccount &gt; 1 &amp;&amp; system.government &lt; 2 &amp;&amp; Math.random() &lt; 0.15 &amp;&amp; !system.sun.hasGoneNova)
        {
            if (this.ups_c1count &gt; 10 &amp;&amp; Math.random() &gt; 0.33)
            {
                if (Math.random() &gt; 0.50) this.ups_container = &quot;SPILLAGE&quot;;
            }
            else
            {
                this.ups_container = &quot;LOGGING&quot;;
                this.ups_cplanet = system.ID;
                missionVariables.ups_planetname = system.name;
                this.ups_timerstart = clock.days;
            }
        }
        else if (this.ups_c1count &gt; 1 &amp;&amp; system.government === 0 &amp;&amp; Math.random() &lt; 0.2 &amp;&amp; !system.sun.hasGoneNova)
        {
            if (this.ups_c2count &lt; 10 || Math.random() &lt; 0.33)
            {
                this.ups_container = &quot;LOGGING2&quot;;
                this.ups_cplanet = system.ID;
                missionVariables.ups_planetname = system.name;
                this.ups_timerstart = clock.days;
            }
        }
        else if (player.credits &gt; 10000 &amp;&amp; system.techLevel &lt; 6 &amp;&amp; Math.random() &lt; 0.04 &amp;&amp; missionVariables.ups_tcount &gt; 2 &amp;&amp; !system.sun.isGoingNova)
        {
            player.ship.fuelLeakRate = 20;
            player.consoleMessage(expandDescription(&quot;[danger-fuel-leak]&quot;), 4);
            if (worldScripts.transportSchedule)  // has Transports.OXP installed
                system.addShips(&quot;ups-womafueltanker&quot;, 1); else system.addShips(&quot;ups-fueltanker&quot;, 1);
            system.addShipsToRoute(&quot;sunskim-trader&quot;, 2, Math.random(), &quot;sw&quot;);
            system.addShipsToRoute(&quot;sunskim-trader&quot;, 2, Math.random(), &quot;sw&quot;);
            system.addShipsToRoute(&quot;ups-sunskim&quot;, 2, Math.random(), &quot;sw&quot;);
            system.addShipsToRoute(&quot;ups-sunskim&quot;, 2, Math.random(), &quot;sw&quot;);
            system.addShipsToRoute(&quot;ups-sunskim&quot;, 2, Math.random(), &quot;sw&quot;);
        }
    }
    else
    {
		if (containerStatus.indexOf(&quot;SEARCHING&quot;) === 0) // one of the 4 searching modi.
        {
            if (player.score &gt; 1000)
            {
                system.addShipsToRoute(this.pirate, 4, Math.random(), &quot;wp&quot;);
                system.addShipsToRoute(this.tiger, 4, Math.random(), &quot;wp&quot;);
                system.addShipsToRoute(&quot;trader&quot;, 1, Math.random(), &quot;wp&quot;);
            }
        }
        if (containerStatus.indexOf(&quot;JOINED_PIRATES&quot;) === 0) // one of the 2 joining modi.
        {
            system.addShipsToRoute(&quot;trader&quot;, (8 - system.economy), 0.25, &quot;wp&quot;);
            if (system.economy &lt; 4) system.addShipsToRoute(&quot;upstrader&quot;, 1);
            if (system.economy &lt; 2)
            {
                system.addShipsToRoute(&quot;upstrader&quot;, 2, Math.random(), &quot;wp&quot;);
                system.addShipsToRoute(&quot;upstrader&quot;, 1, Math.random(), &quot;wp&quot;);
            }
            if (system.government &gt; 4)
            {
                system.addShipsToRoute(&quot;police&quot;, 3, Math.random(), &quot;wp&quot;);
                system.addShipsToRoute(&quot;police&quot;, 3);
            }
        }
        if (containerStatus === &quot;SPILLAGE3&quot;)
        {
            if (!this.ups_container_count)
            {
                this.ups_container = &quot;NOT_NOW&quot;;
                if (this.ups_cplanet)
                {
                    this.upsUnmarkSystem(this.ups_cplanet, this.name);
                    mission.setInstructionsKey(null);
                    delete this.ups_cplanet;
                    delete this.ups_container_award;
                    delete this.ups_container_count;
                    delete this.ups_total_container_count;
					delete this.ups_container_remaining;
                }
            }
        }
        if (missionVariables.ups_target)
        {
            var pasedTime = clock.days - this.ups_timerstart;
            if (pasedTime &gt; 15)
			{
				delete missionVariables.ups_target;
                delete this.ups_timerstart;
				this.ups_container = &quot;NO&quot;;
			}
            else
            {
            var happyTraders = system.shipsWithPrimaryRole(&quot;trader&quot;, player.ship);
            for (var i=0; i&lt;happyTraders.length;i++)
                if (happyTraders[i].isValid) //could have already been destroyed or not present
                {
                    if (happyTraders[i].AI === &quot;route1traderAI.plist&quot; &amp;&amp; pasedTime &lt; 15 * Math.random())
						happyTraders[i].switchAI(&quot;upsHailingTraderAI.plist&quot;);
                }
            }
        }
    }
    if (player.ship.equipmentStatus(&quot;EQ_UPS_IDCLEANER&quot;) === &quot;EQUIPMENT_OK&quot;)
    {
        if (!missionVariables.ups_status_backup &amp;&amp; system.government === 0)
        {
            missionVariables.ups_status_backup = player.ship.bounty;
            player.ship.bounty = 0;
        }
        if (missionVariables.ups_status_backup &amp;&amp; missionVariables.ups_status_backup &gt; -1 &amp;&amp; system.government &gt; 0)
        {
            player.ship.bounty += missionVariables.ups_status_backup;
            delete missionVariables.ups_status_backup;
        }
    }
    if (system.government &gt; 3 &amp;&amp; this.ups_c1count &gt; 2 &amp;&amp; Math.random() &lt; 0.04)
    {
        system.addShipsToRoute(&quot;derelict_ptt&quot;, 1, Math.random(), &quot;wp&quot;);
    }
    this.startScanners();
}

this.playerEnteredNewGalaxy = function (newGalaxyNumber)
{
    //reset missions on switching galaxy
    this.ups_container = &quot;NOT_NOW&quot;;
    delete this.ups_cplanet;
	delete missionVariables.ups_cplanetname;
    delete this.ups_container_count;
	delete this.ups_container_award;
    delete this.ups_total_container_count;
	delete missionVariables.ups_planet;
	delete missionVariables.ups_planetname; // variable only used for missiontext &amp; choices.
	delete this.ups_timerstart;
    mission.setInstructionsKey(null);
    delete missionVariables.TL_FOR_EQ_UPS_POLICE_SCANNER;
    delete missionVariables.TL_FOR_EQ_UPS_IDCLEANER;
}

this.setUpShips = function ()
{
    var containerStatus = this.ups_container;
	if (this.ups_cloaking) this.enableCloakingDevice();
    if (containerStatus === &quot;SEARCHING&quot; &amp;&amp; this.ups_cplanet === system.ID  &amp;&amp; missionVariables.ups_closecontact !== &quot;DOCKED&quot;)
    {
        if (system.countShipsWithRole(&quot;boa_ptt&quot;) === 0)
        {
            system.addShipsToRoute(this.boa(), 1, Math.random() * 0.5 + 0.2, &quot;wp&quot;);
        }
        missionVariables.ups_closecontact = &quot;NO&quot;;
    }
    if (containerStatus === &quot;SEARCHING2&quot; &amp;&amp; this.ups_cplanet === system.ID)
    {
        if (system.countShipsWithRole(&quot;python_ptt&quot;) === 0)
        {
            system.addShipsToRoute(this.python(), 1, Math.random(), &quot;pw&quot;);
        }
    }
    if (containerStatus === &quot;SEARCHING3&quot;)
    {
        if (this.ups_cplanet === system.ID)
        {
            if (system.countShipsWithRole(&quot;upsbase&quot;) === 0)
            {
                this.addPirateRock(&quot;pirate-upsbase&quot;, false);
            };
			this.disableCloakingDevice();
        }
    }
    if (containerStatus.indexOf(&quot;JOINED_PIRATES&quot;) === 0)
    {
        if ((system.government === 0 &amp;&amp; system.pseudoRandom100 &lt; 5) || this.ups_cplanet === system.ID)
        {
            if (system.countShipsWithRole(&quot;upsbase&quot;) === 0)
            {
                this.addPirateRock(&quot;pirate-upsbase&quot;, false);
            };
			this.disableCloakingDevice();
        }

    }
    if (containerStatus === &quot;SEARCHING4&quot; &amp;&amp; this.ups_cplanet === system.ID)
    {
        if (system.countShipsWithRole(&quot;upsbase&quot;) === 0)
        {
            this.addPirateRock(&quot;pirate-upsbase2&quot;, true);
            this.ups_timerstart = clock.days;
        };
		this.disableCloakingDevice();
    }
    if (missionVariables.ups_private_escorts)
    {
        if ((clock.days - missionVariables.ups_private_escorts_date) &lt; 11)
        {
            if (system.countShipsWithRole(&quot;ups_private_escort&quot;) === 0)
            {
                system.addGroup(&quot;ups_private_escort&quot;, missionVariables.ups_private_escorts, player.ship.position, 15000);
            }
        }
        else
        {
            var myEscorts = system.shipsWithRole(&quot;ups_private_escort&quot;);
            for (var i=0; i &lt; myEscorts.length; i++)
            {
                if (myEscorts[i].isValid) myEscorts[i].AIState = &quot;CANCEL_CONTRACT&quot;;
            }
            delete missionVariables.ups_private_escorts;
            delete missionVariables.ups_private_escorts_date;
            player.consoleMessage(expandDescription(&quot;[ups_escort_expired]&quot;), 6);
            player.ship.removeEquipment(&quot;EQ_UPS_PRIVATE_ESCORT&quot;);  // Code for comatibility with old versions.
        }
    }
}

this.addPirateRock = function (rock, strong)
{
    var baseposition = Math.random()*0.2+0.3;
    var position1 = Vector3D(0, 0, baseposition).fromCoordinateSystem(&quot;wpu&quot;);
    var position2 = Vector3D(0, 0, baseposition - 0.15).fromCoordinateSystem(&quot;wpu&quot;);
    var rock = system.addShips(rock, 1, position1)[0];
    system.addShips(&quot;asteroid&quot;, 8, rock.position, 15E3);
    system.addShips(&quot;police&quot;, 2, position2);
    system.addShips(this.pirate, 2, position2);
    if (strong)
    {
        system.addShips(&quot;upsdefender&quot;, 8, rock.position, 15E3);
        system.addShips(this.tiger, this.ups_c3count, rock.position, 15E3);
    }
    rock.orientation = [1,0,0,0]; // entrance towards planet.
}

this.enableCloakingDevice = function ()
{
    if (this.ups_cloaking &amp;&amp; this.ups_cloaking === &quot;CRIPPLED&quot;)
    {
        var damaged = (player.ship.equipmentStatus(&quot;EQ_CRIPPLED_CLOAKING&quot;) === &quot;EQUIPMENT_DAMAGED&quot;); // even the cripled one can get damaged in fight.

        if (player.ship.equipmentStatus(&quot;EQ_CRIPPLED_CLOAKING&quot;) !== &quot;EQUIPMENT_UNAVAILABLE&quot;) // player has the equipment
		{
			player.ship.removeEquipment(&quot;EQ_CRIPPLED_CLOAKING&quot;);
			player.ship.awardEquipment(&quot;EQ_CLOAKING_DEVICE&quot;);
            if (damaged) player.ship.setEquipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
		}

        delete this.ups_cloaking;
    };
}

this.disableCloakingDevice = function ()
{
	if (player.ship.equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;) === &quot;EQUIPMENT_OK&quot;)
	{
		player.consoleMessage(&quot;Cloaking jammed&quot;, 3);
		player.ship.removeEquipment(&quot;EQ_CLOAKING_DEVICE&quot;);
		player.ship.awardEquipment(&quot;EQ_CRIPPLED_CLOAKING&quot;);
		this.ups_cloaking = &quot;CRIPPLED&quot;;
	}
}

this.playerBoughtEquipment = function (equipment)
{
	if (equipment === &quot;EQ_UPS_PRIVATE_ESCORT&quot;)
	{
			missionVariables.ups_private_escorts = 8;
			missionVariables.ups_private_escorts_date = clock.days;
			// player.ship.removeEquipment(&quot;EQ_UPS_PRIVATE_ESCORT&quot;); // is now invisible equipment.
	}
	if (equipment === &quot;EQ_UPS_IDCLEANER&quot;)
	{
		missionVariables.ups_status_backup = player.ship.bounty;
		player.ship.bounty = 0;
	}
	if (equipment === &quot;EQ_UPS_UNIVERSAL_SCANNER_REMOVER&quot;)
	{
		var refund = EquipmentInfo.infoForKey(&quot;EQ_UPS_UNIVERSAL_SCANNER&quot;).price/10 * 0.75;
        if (player.ship.equipmentStatus(&quot;EQ_UPS_UNIVERSAL_SCANNER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) refund /= 10;
        player.ship.removeEquipment(&quot;EQ_UPS_UNIVERSAL_SCANNER&quot;);
		player.ship.removeEquipment(&quot;EQ_UPS_UNIVERSAL_SCANNER_REMOVER&quot;);
		player.credits += refund;
	}
}

this.boa = function ()
{
	// all variations have the common role &quot;boa_ptt&quot;.
	var boa;
    var count = Math.floor(this.ups_ccount / 4);
    switch (count)
    {
        case 0: boa = &quot;boa_ptt_easy&quot;; break;
        case 1: boa = &quot;boa_ptt_medium&quot;; break;
        case 2: boa = &quot;boa_ptt_hard&quot;; break;
        default: boa = &quot;boa_ptt_very_hard&quot;;
    }
	return boa;
}

this.python = function ()
{
	// all variations have the common role &quot;python_ptt&quot;.
	var python
    var count = Math.floor(this.ups_ccount / 5);
    switch (count)
    {
        case 0: python = &quot;python_ptt_easy&quot;; break;
        case 1: python = &quot;python_ptt_medium&quot;; break;
        default: python = &quot;python_ptt_hard&quot;;
    }
	return python;
}

this.spillCargo = function ()
{
    for (var i=0; i &lt; 4; i++)
    {
        var scavenger = system.addShipsToRoute(&quot;scavenger&quot;, 1)[0];
        if (scavenger &amp;&amp; scavenger.isValid) scavenger.switchAI(&quot;route1UpsScavengerAI.plist&quot;);
        system.addShipsToRoute(&quot;ups-spilled-container&quot;, 5);
        system.addShipsToRoute(&quot;cargopod&quot;, 5);
    }
    this.ups_container_count = 0;
    this.ups_total_container_count = 0;
    this.ups_container_remaining = 20;
 }

this.ups_scanners = function ups_scnners()
{
    if (player.ship.status !== &quot;STATUS_IN_FLIGHT&quot;)
    {
        this.scannertimer.stop();
        return;
    }
    if (player.ship.equipmentStatus(&quot;EQ_UPS_POLICE_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot;)
    {
        this.upsPoliceScanner();
    }
    else if (player.ship.equipmentStatus(&quot;EQ_UPS_UNIVERSAL_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot;)
    {
        this.upsUniversalScanner();
    }
}

this.upsPoliceScanner = function()
{
    // function is also called from equipment script.
    player.consoleMessage(&quot;scanned: &quot;
        + system.countEntitiesWithScanClass(&quot;CLASS_POLICE&quot;) +&quot; GalCop ships, &quot;
        + system.countShipsWithPrimaryRole(&quot;hunter&quot;) + &quot; hunters &quot;
        + system.countShipsWithPrimaryRole(&quot;trader&quot;) + &quot; traders and &quot;
        + system.countShipsWithPrimaryRole(&quot;escort&quot;) + &quot; escorts.&quot;, 6
    );
    if (system.government &gt; 0 &amp;&amp; Math.random() &lt; 0.06)
    {
        player.ship.bounty++;
        system.addShipsToRoute(&quot;police&quot;, 1);
        system.addShipsToRoute(&quot;police&quot;, 1, Math.random(), &quot;wp&quot;);
        if (system.government &gt; 5) system.addShips(&quot;police&quot;, 1);
    }
}

this.upsUniversalScanner = function()
{
    // function is also called from equipment script.
    player.consoleMessage(&quot;Scanned: &quot;
        + system.countShipsWithPrimaryRole(&quot;pirate&quot;) + &quot; pir, &quot;
        + system.countEntitiesWithScanClass(&quot;CLASS_POLICE&quot;) + &quot; pol, &quot;
        + system.countShipsWithPrimaryRole(&quot;hunter&quot;) + &quot; hunt, &quot;
        + system.countShipsWithPrimaryRole(&quot;trader&quot;) + &quot; trad, &quot;
        + system.countShipsWithPrimaryRole(&quot;escort&quot;) + &quot; esc, &quot;
        + system.countEntitiesWithScanClass(&quot;CLASS_THARGOID&quot;) + &quot; tharg.&quot;, 6
    );
}

this.positionToDirection = function(pos)
{
    var pos1 = system.info.coordinates;
    var pos2 = new Vector3D(pos);
    var dx, dy, x2, y2;

    dx = pos2.x - pos1.x;
    dy = pos2.y - pos1.y;
    x2 = Math.abs(dx);
    y2 = Math.abs(dy);

    if (x2 &gt; 2.41421 * y2)
    {  // x2 &gt; y2 / Math.tan(Math.PI/8)
        return dx &gt; 0? &quot;east&quot; : &quot;west&quot;;
    }
    if (y2 &gt; 1.732 * x2)
    {
        return dy &lt; 0? &quot;north&quot; : &quot;south&quot;;
    }
    if (dx &gt; 0)
    {
        return dy &lt; 0? &quot;north-east&quot; : &quot;south-east&quot;;
    }
    else
    {
        return dy &lt; 0? &quot;north-west&quot; : &quot;south-west&quot;;
    }
};

this.startScanners = function ()
{
    if (player.ship.equipmentStatus(&quot;EQ_UPS_UNIVERSAL_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_UPS_POLICE_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot;)
    {
        if (this.scannertimer)
        {
            if (!this.scannertimer.isRunning) this.scannertimer.nextTime = clock.absoluteSeconds + 20;
            this.scannertimer.start();
        }
        else
        {
            this.scannertimer = new Timer(this, this.ups_scanners, 20, 60);
        }
    }
}

this.stopScanners = function ()
{
    if (this.scannertimer) this.scannertimer.stop();
}

this._reputation = function ()
{
    return player.parcelReputation;
}

this._overlay = function() {
    if (player.ship.hudHidden || player.ship.hudAllowsBigGui) {
        return {name:&quot;upsnews-large.png&quot;, height:546};
    } else {
        return {name:&quot;upsnews-small.png&quot;, height:546};
    }
}

this._getSystemsInRange = function(range) {
    var infoList = SystemInfo.systemsInRange(range);
    // remove any systems you can&#39;t reach
    for (var i = infoList.length - 1; i &gt;= 0; i--) {
        var myRoute = System.infoForSystem(galaxyNumber, system.ID).routeToSystem(infoList[i], player.ship.routeMode);
        if (!myRoute || myRoute.route.length === 0) {
            infoList.splice(i, 1);
        }
        myRoute = null;
    }
    return infoList;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_docs.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;ups_docs&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Docs missions of UPS Courier&quot;;

//1.9 asteroids are chosen from any asteroid available instead of using special scripted asteroids.

this.startUp = function ()
{
    this.pirate = &quot;pirate&quot;;
    if (!missionVariables.ups_docs) this.$initialise();
    this.$loadVariables();
    this.mark = false;
	if (missionVariables.ups_galaxy != galaxyNumber)
	{
		log(this.name, &quot;UPS detected the player is in an other galaxy than the last save with UPS installed. Now resetting missions.&quot;)
		var galaxy = missionVariables.ups_galaxy;
		if (++galaxy === 8) galaxy = 0;  // simulate jump in next galaxy since last save for proper resetting old missions.
        worldScripts[&quot;ups_docs&quot;].playerEnteredNewGalaxy(galaxy);
        worldScripts[&quot;ups_parcel&quot;].playerEnteredNewGalaxy(galaxy);
        worldScripts[&quot;ups_container&quot;].playerEnteredNewGalaxy(galaxy);
        worldScripts[&quot;ups_sun&quot;].playerEnteredNewGalaxy(galaxy);
        worldScripts[&quot;ups_slaves&quot;].playerEnteredNewGalaxy(galaxy);
        missionVariables.ups_galaxy = galaxyNumber;
	}
    if (!missionVariables.upsVersionUpdated)
    {
        // Uses bits to remember changes so this varriable can be used also for furure changes
        // bit 1: Markers are updated.
        this.updateUpsMarkers();
        missionVariables.upsVersionUpdated = &quot;1&quot;;
    }
    this.cleanUpMarkers();
}

this.$initialise = function ()
{   // setting up all mission variables.
	missionVariables.ups_docs = &quot;NO&quot;;
	missionVariables.ups_parcel = &quot;NO&quot;;
	missionVariables.ups_container = &quot;NO&quot;;
    missionVariables.ups_slaves = &quot;NO&quot;;
    var initialitations = [&quot;dcount&quot;, &quot;pcount&quot;, &quot;ccount&quot;, &quot;c1count&quot;, &quot;c2count&quot;, &quot;ecount&quot;, &quot;galcop_punishment&quot;, &quot;reputation&quot;];
    for (var i=0; i&lt;initialitations.length; i++) missionVariables[&quot;ups_&quot;+initialitations[i]] = 0;
	missionVariables.ups_galaxy = galaxyNumber;  // needed to detect jumps with ups de-installed.
    // galaxyNumber is GLOBAL and may change to player.galaxyNumber  in future!!!
}

this.vars = {
    // table used for translation between missionVariables and worldScript variables. MissionVarriables are slow, so
    // the most frequent used ones are maintained as real varriables during game and only turned back into
    // missionVariables on saving.
    &quot;ups_docs&quot;: [&quot;ups_docs&quot;, &quot;ups_dcount&quot;, &quot;ups_dplanet&quot;, &quot;ups_reputation&quot;],
    &quot;ups_parcel&quot;: [&quot;ups_parcel&quot;, &quot;ups_pcount&quot;, &quot;ups_pplanet&quot;, &quot;ups_ptimerstart&quot;],
    &quot;ups_container&quot;: [&quot;ups_container&quot;, &quot;ups_ccount&quot;, &quot;ups_c1count&quot;, &quot;ups_c2count&quot;, &quot;ups_c3count&quot;, &quot;ups_cplanet&quot;,
                      &quot;ups_timerstart&quot;, &quot;ups_container_count&quot;, &quot;ups_container_award&quot;, &quot;ups_container_message&quot;,
                      &quot;ups_container_destroyed&quot;],
    &quot;ups_slaves&quot;: [&quot;ups_slaves&quot;, &quot;ups_slaverescue&quot;, &quot;ups_slplanet&quot;, &quot;ups_sl2planet&quot;, &quot;ups_slcount&quot;, &quot;ups_slavesrescued&quot;, &quot;ups_sl2count&quot;, &quot;ups_slavename&quot;],
    &quot;ups_sun&quot;: [&quot;ups_sun&quot;, &quot;ups_blackbox&quot;, &quot;ups_sunvisits&quot;, &quot;ups_sunbase&quot;, &quot;ups_splanet&quot;, &quot;ups_splanetname&quot;, &quot;ups_stimerstart&quot;,
                &quot;ups_rescue&quot;, &quot;ups_s2count&quot;, &quot;ups_s2award&quot;, &quot;ups_stationparts&quot;]
}

this.$loadVariables = function ()
{
    // Make sure the next variables always exist.
    var initialitations = [&quot;dcount&quot;, &quot;pcount&quot;, &quot;ccount&quot;, &quot;c1count&quot;, &quot;c2count&quot;, &quot;ecount&quot;, &quot;galcop_punishment&quot;, &quot;reputation&quot;, &quot;galaxy&quot;];
    for (var i=0; i&lt;initialitations.length; i++)
    {
        if (!missionVariables[&quot;ups_&quot;+initialitations[i]]) missionVariables[&quot;ups_&quot;+initialitations[i]] = 0;
    }

	// missionvariables are very slow. Convert the most intensive used ones to local JS variables.
    // do it in the script with the initialisation code because we don&#39; know if the other scripts will initialise after this one.
    var missions = Object.getOwnPropertyNames(this.vars);
    var i, j;
    for (j=0; j &lt; missions.length; j++)
    {
        var m = missions[j];
        for (i=0; i &lt; this.vars[m].length; i++)
        {
            worldScripts[m][this.vars[m][i]] = missionVariables[this.vars[m][i]];
        }
    }
    if (missionVariables.ups_difference) delete missionVariables.ups_difference; // no longer used.
}

this.playerWillSaveGame = function ()
{
    // update missionvariables to be stored.
    // I do it this way to stay compatible with old versions. For a new OXP it is
    // better to use the JSON function to convert all into a single mission variable.
    var missions = Object.getOwnPropertyNames(this.vars);
    var i, j;
    for (j=0; j &lt; missions.length; j++)
    {
        var m = missions[j];
        for (i=0; i &lt; this.vars[m].length; i++)
        {
            if (worldScripts[m][this.vars[m][i]])
            {
                // only create mission variables for existing variables
                missionVariables[this.vars[m][i]] = worldScripts[m][this.vars[m][i]];
            }
            else
            {
                // make sure we don&#39;t leave unused missionVariables from a loaded game.
                delete missionVariables[this.vars[m][i]];
            }
        }
    }
    this.cleanUpMarkers();
}

this.shipWillDockWithStation = function (station)
{
    if (station.isMainStation)
    {
        this.ups_reports(station);
    }
}

this.shipLaunchedFromStation = function ()
{
    this.setUpShips();
    if (this.ups_docs === &quot;ASTEROID&quot;) this.setUpAsteroidMission();
}

this.missionScreenOpportunity = function ()
{
    if (player.ship.docked)
    {
        this.missionOffers();
    }
}

this.requestLongRangeChart = function (system, script)
{
    this.lookLongRangeChartScreen = true;
    this.askingScript = script;
    this.planetShowNumber = system;
}

this.longRangeChart = function longRangeChart() // routine used by 4 ups world scripts
{
    if (guiScreen === &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
    {
        if (this.mark) {this.upsUnmarkSystem(this.planetShowNumber, this.name); this.mark = false}
        else {this.upsMarkSystem(this.planetShowNumber, &quot;ups_docs&quot;); this.mark = true};
    }
    else
    {
        this.missionChartTimer.stop();
        this.upsUnmarkSystem(this.planetShowNumber, this.name);
        this.mark = true; // Keep this selected system.
    }
}

this.guiScreenChanged = function (newScreen, oldScreen)  // routine used by all 5 ups world scripts
{
    if (this.restartMissionOffer &amp;&amp; newScreen !== &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
    {
        this.restartMissionOffer = false;
        if (guiScreen !== &quot;GUI_SCREEN_MISSION&quot;) this.missionOffers();
    }
	if (!this.lookLongRangeChartScreen) return;
	if (!player.ship.docked) this.lookLongRangeChartScreen = null;
	if (guiScreen === &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
	{
		this.lookLongRangeChartScreen = null;
		if (this.missionChartTimer) this.missionChartTimer.start()
		else this.missionChartTimer = new Timer(this, this.longRangeChart, 0.5, 0.5);
        worldScripts[this.askingScript].restartMissionOffer = true;
	}
	else player.consoleMessage(&quot;Go to the long range screen: F6/F6&quot;, 10);
}

this.ups_reports = function (station)
{
    if (system.government === 6 &amp;&amp; this.ups_docs === &quot;SMALL_DELIVERY&quot;)
    {
        if (this.ups_dplanet !==  system.ID  &amp;&amp; this.ups_dcount &gt; 0) // The case (this.ups_dcount == 0) is handled in a missionscreen.
        {
            this.ups_docs = &quot;NOT_NOW&quot;;
            player.credits += 100;
            player.addMessageToArrivalReport(expandMissionText(&quot;ups_docs_arrival_report&quot;));
            mission.setInstructionsKey(null);
            this.ups_dcount++;
            missionVariables.ups_docs_appearance = null;
            this.increaseReputation(1);
        }
    }
    if (this.ups_docs === &quot;EARTHQUAKE_DELIVERY&quot; &amp;&amp; this.ups_dplanet ===  system.ID)
    {
        if (missionVariables.ups_earthquake_cargo &gt; 0 &amp;&amp; manifest[&quot;machinery&quot;] &gt; 0)
        {
            var machinery = manifest[&quot;machinery&quot;];
            if (machinery &gt; missionVariables.ups_earthquake_cargo) machinery = missionVariables.ups_earthquake_cargo;
            player.addMessageToArrivalReport(expandMissionText(&quot;ups_earthquake_arrival_report&quot;,{machine_count: machinery}));
            manifest[&quot;machinery&quot;] -= machinery;
            missionVariables.ups_earthquake_cargo -= machinery;
            this.machineDelivery = true;
        }
    }
};

this.addUpsContract = function ()
{
    var thisSystem = system.info;

    var targetSystems = SystemInfo.filteredSystems(this, function(other){
           return (other.systemID !== thisSystem.systemID) &amp;&amp; other.government == 6 &amp;&amp; !system.sun.hasGoneNova;
    });
    var count = Math.ceil(Math.random()*5);

    for (var i = 0; i&lt;count; i++)
    {
        var contractSystem = targetSystems[Math.floor(Math.random() * targetSystems.length)];
        var contractRoute = system.info.routeToSystem(contractSystem);
		// if there is no route to the destination, skip this one
		if (contractRoute == null) continue;
        var contractDescription = expandDescription(&quot;[ups_condition] [ups_document_description]&quot;);
        contractDescription = contractDescription.charAt(0).toUpperCase() + contractDescription.slice(1);

        var parcel =
        {
            destination: contractSystem.systemID,
            sender: &quot;UPS courier&quot;,
            deadline: clock.seconds + contractRoute.time * 3600 + 3600*24*2,
            payment: Math.floor(contractRoute.distance * (3+Math.random()) + (Math.pow(contractRoute.route.length,1+(0.3*player.parcelReputation))) + 50),
            description: contractDescription,
            route: contractRoute
        }

        worldScripts[&quot;oolite-contracts-parcels&quot;]._addParcelToSystem(parcel);
    }
};

this.missionOffers = function ()
{
    if (this._savedTargetSet) player.ship.targetSystem = this._savedTarget
    this._savedTarget = null;
    this._savedTargetSet = false;

	var docsStatus = this.ups_docs;
    if (player.ship.dockedStation.isMainStation)
    {

        if (docsStatus === &quot;YES&quot;  &amp;&amp; system.government === 6 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
        {
            var chronicleSystem = new Array(124, 39, 36, 41, 198, 73, 149, 226)[galaxyNumber]; // define one per galaxy
			if (player.ship.bounty &lt; 2 &amp;&amp; this.ups_dcount &gt; 20 &amp;&amp;
                    system.ID != chronicleSystem &amp;&amp; (Math.random() &lt; 0.2 || this.mark))
            {
                this.ups_dplanet = chronicleSystem;
				missionVariables.ups_dplanetname = System.systemNameForID(chronicleSystem);
				missionVariables.ups_docs_appearance = expandDescription(&quot;[ups_numbers] [ups_condition] %I&quot;);
				if (!missionVariables.ups_chronicle_content)
                {
					missionVariables.ups_chronicle_content = expandDescription(&quot;the [25] [27] on %H and the recent [8]&quot;);
                }
                var message = expandMissionText(&quot;ups_docs_chronicle_offer&quot;, {ups_inhabitants: system.inhabitantsDescription, dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message,
                                    overlay: this._overlay(), choicesKey: &quot;ups_docs_accepted_yesnolook&quot;},
                                    this.choiceEvaluation);
                this.offering = &quot;UPS_DOCS_CHRONICLE&quot;;
            }
            else if (player.ship.bounty &lt; 3)
            {
                missionVariables.ups_docs_appearance = expandDescription(&quot;[ups_numbers] [ups_condition] %I&quot;);
                this.today = new Date();
                if (this.today.getMonth()==11 &amp;&amp; this.today.getDate() &gt; 15 &amp;&amp; this.today.getDate() &lt; 26)
                    missionVariables.ups_docs_appearance += &quot; Christmas&quot;;

                var key = (!this.ups_dcount) ? &quot;ups_docs_1st_offer&quot; : &quot;ups_docs_offer&quot;;
                var message = expandMissionText(key, {dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message,
                                        overlay: this._overlay(), choicesKey: &quot;ups_docs_accepted_yesno&quot;},
                                        this.choiceEvaluation)
                this.offering = &quot;UPS_DOCS&quot;;
            }
        }
        if (docsStatus === &quot;SMALL_DELIVERY&quot; &amp;&amp; system.government === 6)
        {
            if (this.ups_dplanet ===  system.ID)
            {
                this.ups_docs = &quot;ACCEPTED&quot;;
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_back_at_home_docs&quot;, overlay: this._overlay()});
                this.increaseReputation(-1);
            }
            else
            {
                if (!this.ups_dcount)
                {
                    this.ups_docs = &quot;NOT_NOW&quot;;
                    player.credits += 100;
                    var message = expandMissionText(&quot;ups_docs_1st_unloading&quot;, {populationCount: system.population * 100});
                    mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message, overlay: this._overlay()})
                    mission.setInstructionsKey(null);
                    this.ups_dcount++;
                    missionVariables.ups_docs_appearance = null;
                    this.increaseReputation(1);
                }
                else
                {
                    // written in arrival report now.
                };
                if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
                if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
            }
        }
        if (docsStatus === &quot;LOGGING&quot; &amp;&amp; system.government === 6)
        {
            if (this._reputation() &gt; 3)
            {
                if (this.ups_dplanet != system.ID &amp;&amp; !worldScripts.ups_docs.lookLongRangeChartScreen)
                {
                    missionVariables.ups_docs_appearance = expandDescription(&quot;[ups_numbers] secret %I&quot;);
                    var message = expandMissionText(&quot;ups_docs_offer2&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                    mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message,
                                        overlay: this._overlay(), choicesKey: &quot;ups_docs_accepted_yesnolook&quot;},
                                        this.choiceEvaluation);
                    this.offering = &quot;UPS_DOCS2&quot;;
                }
                else if (this._reputation() &lt; 0)
                {
                   this.ups_docs = &quot;NOT_NOW&quot;;
                }
            }
        }
        if (docsStatus === &quot;SPECIAL_DELIVERY&quot;)
        {
            if (this.ups_dplanet === system.ID &amp;&amp; !missionVariables.ups_docbriefing)
            {
                missionVariables.ups_docbriefing = &quot;YES&quot;;
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_docs_unloading2a&quot;, overlay: this._overlay()});
                mission.setInstructionsKey(&quot;ups_docs_small3&quot;);
            }
        }
        if (docsStatus === &quot;CHRONICLE_DELIVERY&quot;)
        {
            if (this.ups_dplanet === system.ID)
			{
                this.ups_docs = &quot;NOT_NOW&quot;;
				if (clock.hours/24 &lt;= missionVariables.ups_dtimer)
				{
                    var message = expandMissionText(&quot;ups_docs_chronicle_unloading&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                    mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message, overlay: this._overlay()});
                    this.ups_dcount++;
                    player.credits += 3000;
                    this.increaseReputation(4);
                    if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
                    if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
				}
				else
				{
                    mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_docs_chronicle_unloading_late&quot;, overlay: this._overlay()});
                    this.increaseReputation(-3);
				}
				this.upsUnmarkSystem(this.ups_dplanet, this.name);
				missionVariables.ups_docs_appearance = null;
                this.ups_dplanet = null
				mission.setInstructionsKey(null);
				missionVariables.ups_dtimer = null;
				missionVariables.ups_docs_type = null;
				missionVariables.ups_chronicle_content = null;
			}
			else
			{
                this.updateChronicleMessages();
				if (clock.hours/24 &gt; missionVariables.ups_dtimer + 5)
				{
					this.upsUnmarkSystem(this.ups_dplanet, this.name);
					this.ups_docs = &quot;NOT_NOW&quot;;
					mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_docs_chronicle_expired&quot;, overlay: this._overlay()});
					missionVariables.ups_docs_appearance = null;
                    this.ups_dplanet = null;
					missionVariables.ups_dtimer = null;
					missionVariables.ups_chronicle_content = null;
					mission.setInstructionsKey(null);
					this.increaseReputation(-5);
				}
			}
        }
        if (docsStatus === &quot;ASTEROID_OFFER&quot;)
        {
            if (system.countShipsWithRole(&quot;asteroid&quot;) &lt; 25) 
            {
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Asteroid Mission&quot;, messageKey: &quot;ups_docs_asteroid1&quot;,
                                    overlay: this._overlay(), choicesKey: &quot;ups_docs_asteroid_yesno&quot;},
                                    this.choiceEvaluation);
                this.offering = &quot;UPS_DOCS_ASTEROID&quot;;
            }
        }
        if (player.trumbleCount &gt; 0 &amp;&amp; (docsStatus === &quot;NOT_NOW&quot; || docsStatus === &quot;NO&quot;))
        {
            if (Math.random() &lt; player.trumbleCount/20 &amp;&amp; player.credits &gt; 2000)
            {
                var message = expandMissionText(&quot;ups_trumble_repellant&quot;, {ups_trumble_count: player.trumbleCount, ups_trumble_plural: (player.trumbleCount === 1 ? &quot;&quot; : &quot;s&quot;)});
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, message: message,
                                    overlay: &quot;trumblebox.png&quot;, choicesKey: &quot;ups_trumble_repellant_yesno&quot;},
                                    this.choiceEvaluation);
                this.offering = &quot;UPS_DOCS_REPELLANT&quot;;
            }
        }
        if (docsStatus === &quot;TRUMBLE_REPELLANT&quot; &amp;&amp; clock.days &gt; missionVariables.ups_dtimer + 8)
        {
            this.ups_docs = &quot;NOT_NOW&quot;;
            if (Math.random() &lt; 0.5) mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_trumble_repellant_warning&quot;,
                overlay: this._overlay()});
            missionVariables.ups_dtimer = null;
        }
        if (docsStatus === &quot;EARTHQUAKE_OFFER&quot; &amp;&amp; system.government === 6 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
        {
            if (!this.mark)
            {
                var infoList = worldScripts.ups_container._getSystemsInRange(25);
                var targetSystem = infoList[Math.floor(Math.random()*infoList.length)];
                this.ups_dplanet = targetSystem.systemID;
                missionVariables.ups_dplanetname = targetSystem.name;
                missionVariables.ups_dplanet_inhabitants = targetSystem.inhabitants;
                targetSystem.description = expandDescription(&quot;The planet &quot;+ targetSystem.name
                        + &quot; is frequently plagued by earthquakes. The last big one however, largely destroyed the planetary production capacity.&quot;);
                targetSystem.productivity = targetSystem.productivity / 100;
                // now contralled through planetinfo.plist and upsMarket_earthquake.js
                //targetSystem.market = &quot;ups_earthquake&quot;;
                this.mark = true;
            }
            missionVariables.ups_earthquake_cargo = player.ship.cargoSpaceCapacity * 3;
            missionVariables.ups_earthquake_reward = missionVariables.ups_earthquake_cargo * 70;
            mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Machinery Transport&quot;, messageKey: &quot;ups_earthquake_offer&quot;,
                                choicesKey: &quot;ups_earthquake_yesnolook&quot;, overlay: this._overlay()},
                                this.choiceEvaluation);
            this.offering = &quot;UPS_DOCS_EARTHQUAKE_OFFER&quot;;
        }
        if (this.ups_docs === &quot;EARTHQUAKE_DELIVERY&quot; &amp;&amp; this.machineDelivery)
        {
            if (missionVariables.ups_earthquake_cargo &gt; 0)
            {
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Machinery Transport&quot;, messageKey: &quot;ups_earthquake_delivery&quot;,
                                    overlay: this._overlay()});
                mission.setInstructionsKey(&quot;ups_docs_earthquake&quot;);
                this.launchEarthquakeRescue(3);
            }
            else
            {
                this.ups_docs = &quot;NOT_NOW&quot;;
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Machinery Transport&quot;, messageKey: &quot;ups_earthquake_final&quot;,
                                    overlay: this._overlay()});
                mission.setInstructionsKey(&quot;ups_docs_earthquake&quot;);
                this.upsUnmarkSystem(this.ups_dplanet, this.name);
                // an undefined marget throws an exception in 1.74, so explicit check for existence
                if (system.info.hasOwnProperty(&quot;market&quot;)) system.info.market = null;
                system.info.description = null;
                system.info.productivity = null;
                player.credits += missionVariables.ups_earthquake_reward;
                missionVariables.ups_earthquake_reward = null;
                missionVariables.ups_earthquake_cargo = null;
                mission.setInstructionsKey(null);
                this.increaseReputation(5);
            }
            this.machineDelivery = false;
        }
    }
	else if (player.ship.dockedStation.name.indexOf(&quot;Sun Research Station&quot;) === 0) // docked on one of the 4 research stations
    {
        if (docsStatus === &quot;SPECIAL_DELIVERY&quot;)
        {
            this.ups_docs = &quot;NOT_NOW&quot;;
            player.credits += 250;
            mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Document Transport&quot;, messageKey: &quot;ups_docs_unloading2&quot;, overlay: this._overlay()});
            mission.setInstructionsKey(null);
            this.ups_dcount++;
            this.upsUnmarkSystem(this.ups_dplanet, this.name);
            this.increaseReputation(3);
            if (player.ship.dockedStation.name === &quot;Sun Research Station Alpha&quot; &amp;&amp; !worldScripts[&quot;ups_sun&quot;].ups_sun)
            {
                worldScripts[&quot;ups_sun&quot;].initSunMission(missionVariables.ups_dplanetname, this.ups_dplanet);
            }
            missionVariables.ups_dplanetname = null;
            missionVariables.ups_docbriefing = null;
			missionVariables.ups_docs_type = null;
            missionVariables.ups_docs_appearance = null;
            if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
            if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_docs]&quot;)});
        }
    }
}

this.choiceEvaluation = function (choice)
{
    var docOffer = this.offering;
    delete this.offering;
    switch (docOffer)
    {
        case &quot;UPS_DOCS&quot;:
        {
            if (choice === &quot;YESDoc&quot;)
            {
                mission.setInstructionsKey(&quot;ups_docs_small&quot;);
                this.ups_docs = &quot;ACCEPTED&quot;;
                this.ups_dplanet = system.ID;
            }
            else
            {
                if (choice === &quot;NODoc&quot;)
                {
                    this.ups_docs = &quot;NOT_NOW&quot;;
                    missionVariables.ups_docs_appearance = null;
                    this.increaseReputation(-2);
                }
            }
            break;
        }
        case &quot;UPS_DOCS2&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESDoc&quot;)
            {
                mission.setInstructionsKey(&quot;ups_docs_small2&quot;);
                this.ups_docs = &quot;SPECIAL_DELIVERY&quot;;
                this.upsMarkSystem(this.ups_dplanet, this.name);
                missionVariables.ups_docs_type = &quot;secret documents&quot;;
            }
            else if (choice === &quot;LOOKDoc&quot;)
            {
                this.upsShowDestination(this.ups_dplanet);
            }
            else if (choice === &quot;NODoc&quot;)
            {
                this.ups_docs = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_DOCS_CHRONICLE&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESDoc&quot;)
            {
                this.ups_docs = &quot;CHRONICLE_DELIVERY&quot;;
                this.upsMarkSystem(this.ups_dplanet, this.name);
                missionVariables.ups_dtimer = clock.hours/24 + 15;
                missionVariables.ups_docs_type = &quot;chronicle articles&quot;;
            }
            else if (choice === &quot;LOOKDoc&quot;)
            {
                this.upsShowDestination(this.ups_dplanet);
            }
            else if (choice === &quot;NODoc&quot;)
            {
                this.ups_docs = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_DOCS_ASTEROID&quot;:
        {
            if (choice === &quot;YESDoc&quot;)
            {
                this.offering === &quot;UPS_DOCS_ASTEROID2&quot;;
                mission.runScreen({screenID: &quot;ups-docs&quot;, title: &quot;Asteroid Mission&quot;, messageKey: &quot;ups_docs_asteroid2&quot;, model: &quot;ups-splinter&quot;});
                mission.setInstructionsKey(&quot;ups_docs_asteroid_short&quot;);
                this.ups_docs = &quot;ASTEROID&quot;;
                missionVariables.ups_asteroid_count = 16;
            }
            else if (choice === &quot;NODoc&quot;)
            {
                this.ups_docs = &quot;NOT_NOW&quot;;
            }
            break;
        }
        case &quot;UPS_DOCS_REPELLANT&quot;:
        {
            if (choice === &quot;YESDoc&quot;)
            {
                player.credits -= 2000;
                this.ups_docs = &quot;TRUMBLE_REPELLANT&quot;;
                missionVariables.ups_dtimer = clock.days;
            }
            else if (choice === &quot;NODoc&quot;)
            {
                if (Math.random() &lt; 0.3) this.trumbleRepellant = true;
            }
            break;
        }
        case &quot;UPS_DOCS_EARTHQUAKE_OFFER&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESDoc&quot;)
            {
                this.ups_docs = &quot;EARTHQUAKE_DELIVERY&quot;;
                this.upsMarkSystem(this.ups_dplanet, this.name);
                mission.setInstructionsKey(&quot;ups_docs_earthquake&quot;);
                missionVariables.ups_dplanet_inhabitants = missionVariables.ups_dplanet_inhabitants.toLowerCase();
            }
            else if (choice === &quot;LOOKDoc&quot;)
            {
                this.upsShowDestination(this.ups_dplanet);
            }
            else if (choice === &quot;NODoc&quot;)
            {
                this.ups_docs = &quot;NOT_NOW&quot;;
            }
            break;
        }
        default: log(this.name, &quot;Encountered an illegal mission offer: &quot;+this.offering);
    }
}

this.upsShowDestination = function (ID)
{
    if (!this._savedTargetSet) this._savedTarget = player.ship.targetSystem;
    this._savedTargetSet = false;
    
    this.mark = true; // Keep this selected system.
    if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) == &quot;EQUIPMENT_OK&quot;)
    {
        player.ship.targetSystem = ID;
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, backgroundSpecial: &quot;LONG_RANGE_CHART_SHORTEST&quot;});
    }
    else
    {
        mission.markSystem({
                   system: ID,
                   name: &quot;ups_marker&quot;,
                   markerColor: &quot;magentaColor&quot;,
                   markerScale: 2.0,
                   markerShape: &quot;MARKER_DIAMOND&quot;
        });
        var message = expandMissionText(&quot;ups_long_range_screen&quot;, {ups_system: System.systemNameForID(ID)});
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, message: message, backgroundSpecial: &quot;LONG_RANGE_CHART&quot;});
    }
}

this.shipExitedWitchspace = function ()
{
    if (system.isInterstellarSpace) return;
    this.setUpShips();
	var docStatus = this.ups_docs;
    if (docStatus === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.11) this.ups_docs = &quot;NO&quot;;
    if (docStatus === &quot;ACCEPTED&quot;)
    {
        this.ups_docs = &quot;SMALL_DELIVERY&quot;;
        system.addShipsToRoute(&quot;trader&quot;, 2, Math.random(), &quot;pw&quot;);
    }
    if (docStatus === &quot;NO&quot;)
    {
        if (Math.random() &lt; 0.2 &amp;&amp; system.government === 6)
        {
            if (this.ups_dcount &gt; 30 &amp;&amp; Math.random() &lt; 0.2)
                this.ups_docs = &quot;EARTHQUAKE_OFFER&quot;
            else
                this.ups_docs = &quot;YES&quot;;
        }
        else if (Math.random() &lt; 0.05 &amp;&amp; system.government === 6 &amp;&amp; this.ups_dcount &gt; 5 &amp;&amp; !system.sun.hasGoneNova)
        {
            this.ups_docs = &quot;LOGGING&quot;;
            this.ups_dplanet = system.ID;
            missionVariables.ups_dplanetname = system.name;
        }
        else if (Math.random() &lt; 0.035 &amp;&amp; this.ups_dcount &gt; 20 &amp;&amp; system.countShipsWithRole(&quot;asteroid&quot;) &lt; 15)
        {
            this.ups_docs = &quot;ASTEROID_OFFER&quot;;
        }
    }
    else
    {
        if (docStatus === &quot;ASTEROID&quot;)
        {
            this.ups_docs = &quot;NOT_NOW&quot;;
            missionVariables.ups_asteroid_count = null;
            mission.setInstructionsKey(null);
        }
        if (docStatus === &quot;SMALL_DELIVERY&quot;)
        {
			system.addShipsToRoute(&quot;trader&quot;, 1);
			system.addShipsToRoute(&quot;trader&quot;, 2, Math.random(), &quot;pw&quot;);
		};
		if (docStatus === &quot;CHRONICLE_DELIVERY&quot;)
		{
			if (system.government &lt; 3) this.addDocPirates(10 - 4 * system.government)
			else if (Math.random() &lt; 0.1) this.addDocPirates(2);
            this.updateChronicleMessages();
		}
        if (docStatus === &quot;SPECIAL_DELIVERY&quot; &amp;&amp; system.government &lt; 2)
        {
			this.addDocPirates(10 - 5 * system.government);
        }
    }
    if (system.government === 6 &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.mainStation)
    {
        this.addUpsContract();
    }
}

this.updateChronicleMessages = function ()
{
    if (this.messagesTimer)
    {
        this.messagesTimer.start();
    }
    else
    {
        this.messagesTimer = new Timer(this, this.updateChronicleMessagesDelayed, 0, 2); // clock might not be valid yet.
    }
}

this.updateChronicleMessagesDelayed = function updateChronicleMessagesDelayed()
{
    if (missionVariables.ups_dtimer)
    {
        // we need a delayed clock readout after a jump or launch.
        var message;
        if (clock.isAdjusting)
        {
            message = expandMissionText(&quot;ups_docs_small4&quot;, {ups_days_left: &quot;updating....&quot;});
        }
        else
        {
            message = expandMissionText(&quot;ups_docs_small4&quot;, {ups_days_left: this.getTimeToGo(missionVariables.ups_dtimer)});
            this.messagesTimer.stop();
        }
        mission.setInstructions(message);
    }
    else
    {
        // mission has ended
        mission.setInstructionsKey(null);
        this.messagesTimer.stop();
    }
}

this.addDocPirates = function (count)
{
    system.addShips(this.pirate, count);
	system.addShipsToRoute(this.pirate, count, 0.15, &quot;wp&quot;);
	system.addGroupToRoute(&quot;pirate&quot;, 5, Math.random(), &quot;wp&quot;);
    var docpirates = system.shipsWithPrimaryRole(&quot;pirate&quot;);
    if (docpirates)
    {
        for (var i=0; i&lt;docpirates.length; i++)
            if (docpirates[i].isValid &amp;&amp; docpirates[i].AI === &quot;pirateAI.plist&quot;)
            {
                this.changePirateAI(docpirates[i], &quot;upsSecDocPirateAI.plist&quot;, this.sendUpsDocMessage);
                if (docpirates[i].bounty === 0) docpirates[i].bounty = Math.ceil(Math.random()*30+5);
            }
    }
	if (this.ups_dcount &gt; 15 &amp;&amp; count &gt; 5)
	{
		system.addShipsToRoute(&quot;ups_pirate_leader&quot;, 1, 0.35, &quot;pw&quot;);
		system.addShipsToRoute(&quot;ups_pirate_leader&quot;, 1, 0.85); // station route
		system.addShipsToRoute(&quot;ups_pirate_leader&quot;, 1, 0.75, &quot;pw&quot;);
	}
}

this.changePirateAI = function (pirate, AI, message)
{
    if (pirate &amp;&amp; pirate.isValid)
    {
        pirate.switchAI(AI);
        pirate.script.sendUpsMessage = message; // message is the function to attach that sends the messages.
    }
}

this.playerEnteredNewGalaxy = function ()
{
    // reset missions on galactic jump
    if (this.ups_docs != &quot;SMALL_DELIVERY&quot;)
    {
        this.ups_docs = &quot;NOT_NOW&quot;;
        mission.setInstructionsKey(null);
        var deletions = [&quot;dplanetname&quot;, &quot;docsbriefing&quot;, &quot;dtimer&quot;, &quot;docs_appearance&quot;, &quot;docs_type&quot;, &quot;chronicle_content&quot;];
        for (var i=0; i&lt;deletions.length; i++) delete missionVariables[&quot;ups_&quot;+deletions[i]];
        delete this.ups_dplanet;
    }
    missionVariables.ups_galaxy = galaxyNumber;
}

this.setUpShips = function ()
{
	if (this.ups_docs === &quot;SPECIAL_DELIVERY&quot; &amp;&amp; this.ups_dplanet === system.ID)
    {

        var dependancePos = Vector3D(0, 0, 2.6).fromCoordinateSystem(&quot;sps&quot;);
        var stationRole = (worldScripts[&quot;ups_sun&quot;].ups_sun ? &quot;ups_dependance2&quot; : &quot;ups_dependance&quot;);
        if (system.countShipsWithRole(stationRole) === 0)
        {
            system.addShips(stationRole, 1, dependancePos);
            system.addShips(&quot;ups-sunskim&quot;, 3, dependancePos);
            system.addShips(&quot;ups_shuttle&quot;, 8, dependancePos);
            worldScripts[&quot;ups_sun&quot;].researcher_count = 0;
			worldScripts[&quot;ups_sun&quot;].sunShips(&quot;ups-sunskim&quot;, 3, &quot;sp&quot;);
			worldScripts[&quot;ups_sun&quot;].sunShips(this.pirate, 2, &quot;sp&quot;);
			worldScripts[&quot;ups_sun&quot;].sunShips(&quot;ups-sun-police&quot;, 3, &quot;sp&quot;);
			worldScripts[&quot;ups_sun&quot;].sunShips(&quot;ups-sunskim&quot;, 4, &quot;sw&quot;);
            if (worldScripts.transportSchedule)  // has Transports.OXP installed
            {
                worldScripts[&quot;ups_sun&quot;].sunShips(&quot;fueltransport&quot;, 3, &quot;sp&quot;);
            }
        }
    }
}

this.setUpAsteroidMission = function ()
{
    function locationAt (pos) {return basePosition.add(planetVector.multiply(pos));};
    var count = missionVariables.ups_asteroid_count;
    if (system.countShipsWithRole(&quot;ups-miner&quot;) === 0 &amp;&amp; count &gt; 8)
    {
        var basePosition = system.mainPlanet.position;
        var planetVector = Vector3D([0,0,1]); // unit vector pointing behind planet
        count = Math.ceil(count/2);

        system.addShips(&quot;asteroid&quot;, count, locationAt(180E3), 15E3);
        var specialAsteroids = system.addShips(&quot;asteroid&quot;, count, locationAt(225E3), 15E3);
        //add ups script to the spawned special asteroids. doing it this way allows asteroid storm scripts to run their spawn part that sets the color. does not work for the asteroid storm boulders though. I think we can live with it.
        for (var i = 0; i &lt; specialAsteroids.length; i++) {
			specialAsteroids[i].setScript(&quot;upsAsteroid.js&quot;);
			//this is for the mission counter
            specialAsteroids[i].$upsAsteroid = true;
		}
        system.addShips(&quot;asteroid&quot;, count, locationAt(270E3), 15E3);
        specialAsteroids = system.addShips(&quot;asteroid&quot;, count, locationAt(315E3), 15E3);
        //add ups script to the spawned special asteroids. doing it this way allows asteroid storm scripts to run their spawn part that sets the color. does not work for the asteroid storm boulders though. I think we can live with it.
        for (i = 0; i &lt; specialAsteroids.length; i++) {
			specialAsteroids[i].setScript(&quot;upsAsteroid.js&quot;);
			//this is for the mission counter
			specialAsteroids[i].$upsAsteroid = true;
		}
        var miners = system.addShips(&quot;miner&quot;, 2, locationAt(270E3), 5E3);
        miners = miners.concat(system.addShips(&quot;miner&quot;, 5, locationAt(360E3)), 5E3);
        miners = miners.concat(system.addShips(&quot;miner&quot;, 5, locationAt(450E3)), 5E3);

        for (var i=0; i&lt;miners.length; i++)
            if (miners[i].isValid)
            {
                miners[i].switchAI(&quot;route1UpsMinerAI.plist&quot;);
                miners[i].primaryRole = &quot;ups-miner&quot;;
            }
    }
}

this.getTimeToGo = function (deadline)
{
	var timer = deadline - clock.minutes/24/60;
	var days = Math.floor(timer)
	var hours = Math.round((timer - days)*24)
	var hoursText = &quot;&quot;
	if (hours&gt;1) hoursText = &quot; &quot; + hours +&quot; hrs&quot;; else if (hours==1) hoursText = &quot; &quot; + hours +&quot; hr&quot;;
	if (days &gt; 1) return &quot;within &quot; + days + &quot; days&quot; + hoursText;
	if (days === 1) return &quot;within 1 day&quot; + hoursText;
	if (days === 0 &amp;&amp; hours &gt; 0) return &quot;within&quot; + hoursText;
	if (days === 0) return &quot;now&quot;;
	return &quot;by yesterday&quot;;
}

this.increaseReputation = function (reputation)
{
        if (!this.ups_reputation) this.ups_reputation = 0
        this.ups_reputation += reputation;
        while (this.ups_reputation &gt;=3)
        {
            player.increaseParcelReputation();
            this.ups_reputation -= 3;
        };
        while (this.ups_reputation &lt;= -3)
        {
            player.decreaseParcelReputation();
            this.ups_reputation += 3;
        }
}

this._reputation = function ()
{
    return player.parcelReputation;
}

this.launchEarthquakeRescue = function (count)
{
    for (var i=0; i&lt;count; i++)
    {
        var shuttle = player.ship.dockedStation.launchShipWithRole(&quot;shuttle&quot;);
        shuttle.displayName = shuttle.displayName + &quot; (earthquake resque)&quot;;
        shuttle.switchAI(&quot;fallingShuttleAI.plist&quot;);
    }
}

this.upsMarkSystem = function (ID, oxp_name)
{
    mission.markSystem({
               system: ID,
               name: oxp_name,
               markerColor: &quot;magentaColor&quot;,
               markerShape: &quot;MARKER_X&quot;
    })
}

this.upsUnmarkSystem = function (ID, oxp_name)
{
    mission.unmarkSystem({
               system: ID,
               name: oxp_name
    })
}

this.updateUpsMarkers = function ()
{
    // one-time-only function to update pre-Oolite 1.77 markers to the new structure
    if (worldScripts[&quot;ups_docs&quot;].ups_dplanet != null &amp;&amp; worldScripts[&quot;ups_docs&quot;].ups_dplanet &gt;= 0)
    {
        if ([&quot;SPECIAL_DELIVERY&quot;, &quot;CHRONICLE_DELIVERY&quot;, &quot;EARTHQUAKE_DELIVERY&quot;].indexOf(worldScripts[&quot;ups_docs&quot;].ups_docs) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_docs&quot;].ups_dplanet, &quot;ups_docs&quot;);
        }
    }
    if (worldScripts[&quot;ups_parcel&quot;].ups_pplanet != null &amp;&amp; worldScripts[&quot;ups_parcel&quot;].ups_pplanet &gt;= 0)
    {
        if ([&quot;SPECIAL_DELIVERY&quot;, &quot;MEDICIN_DELIVERY&quot;, &quot;MEDICIN_DELIVERY_2&quot;, &quot;ASTRO_ACCEPTED&quot;].indexOf(worldScripts[&quot;ups_parcel&quot;].ups_parcel) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_parcel&quot;].ups_pplanet, &quot;ups_parcel&quot;);
        }
    }
    if (worldScripts[&quot;ups_container&quot;].ups_cplanet != null &amp;&amp; worldScripts[&quot;ups_container&quot;].ups_cplanet &gt;= 0)
    {
        if ([&quot;SEARCHING&quot;, &quot;SEARCHING2&quot;, &quot;SEARCHING3&quot;].indexOf(worldScripts[&quot;ups_container&quot;].ups_container) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_container&quot;].ups_cplanet, &quot;ups_container&quot;);
        }
    }
    if (worldScripts[&quot;ups_slaves&quot;].ups_slplanet != null &amp;&amp; worldScripts[&quot;ups_slaves&quot;].ups_slplanet &gt;= 0)
    {
        if ([&quot;HOMELAND&quot;, &quot;FINAL&quot;].indexOf(worldScripts[&quot;ups_slaves&quot;].ups_slaves) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_slaves&quot;].ups_slplanet, &quot;ups_slaves&quot;);
        }
    }
    if (worldScripts[&quot;ups_slaves&quot;].ups_sl2planet != null &amp;&amp; worldScripts[&quot;ups_slaves&quot;].ups_sl2planet &gt;= 0)
    {
        if ([&quot;RESCUE&quot;].indexOf(worldScripts[&quot;ups_slaves&quot;].ups_slaves) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_slaves&quot;].ups_sl2planet, &quot;ups_slaves&quot;);
        }
    }
    if (worldScripts[&quot;ups_sun&quot;].ups_splanet != null &amp;&amp; worldScripts[&quot;ups_sun&quot;].ups_splanet &gt;= 0)
    {
        if ([&quot;SMALL_DELIVERY&quot;, &quot;RESCUE&quot;].indexOf(worldScripts[&quot;ups_sun&quot;].ups_sun) &gt; -1)
        {
            this.checkUpsMarker(worldScripts[&quot;ups_sun&quot;].ups_splanet, &quot;ups_sun&quot;);
        }
    }
}

this.checkUpsMarker = function (ID, oxp_name)
{
    var markedSystems = mission.markedSystems;
    for (var i=0; i&lt;markedSystems.length; i++)
    {
        if (markedSystems[i].system == ID &amp;&amp; markedSystems[i].name == &quot;__oolite_legacy_destinations&quot;)
        {
            mission.unmarkSystem(ID); // unmark legacy marker
            this.upsMarkSystem(ID, oxp_name);// add the new marker
        }
    }
}

// Code below is used by ship scripts
this.messageTime = clock.absoluteSeconds // for use of spacing NPC messages by ship scripts.

this.messageAllowed = function ()
{
    if ((clock.absoluteSeconds - this.messageTime) &gt; 5)
    {
        this.messageTime = clock.absoluteSeconds;
		return true;
    }
	else return false;
}

// Code below is linked to ship scripts
this.sendUpsDocMessage = function ()
{
	if (worldScripts[&quot;ups_docs&quot;].messageAllowed() &amp;&amp; this.ship.target &amp;&amp; this.ship.target.isPlayer)
		this.ship.commsMessage(expandDescription(&quot;[ups_secret_talk]&quot;))
    // no messages within 5 secs to avoid screen clutter.
}

this._overlay = function() {
    if (player.ship.hudHidden || player.ship.hudAllowsBigGui) {
        return {name:&quot;upsnews-large.png&quot;, height:546};
    } else {
        return {name:&quot;upsnews-small.png&quot;, height:546};
    }
}

this.cleanUpMarkers = function() {
    var ended = [&quot;NO&quot;, &quot;NOT_NOW&quot;];
    var marked = mission.markedSystems;
    for (var i = marked.length - 1; i &gt;= 0; i--) {
        if (marked[i].name === &quot;ups_docs&quot; &amp;&amp; ended.indexOf(missionVariables.ups_docs) &gt;= 0) mission.unmarkSystem({system:marked[i].system, name:&quot;ups_docs&quot;});
        if (marked[i].name === &quot;ups_parcel&quot; &amp;&amp; ended.indexOf(missionVariables.ups_parcel) &gt;= 0) mission.unmarkSystem({system:marked[i].system, name:&quot;ups_parcel&quot;});
        if (marked[i].name === &quot;ups_container&quot; &amp;&amp; ended.indexOf(missionVariables.ups_container) &gt;= 0) mission.unmarkSystem({system:marked[i].system, name:&quot;ups_container&quot;});
        if (marked[i].name === &quot;ups_slaves&quot; &amp;&amp; ended.indexOf(missionVariables.ups_slaves) &gt;= 0) mission.unmarkSystem({system:marked[i].system, name:&quot;ups_slaves&quot;});
    }
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_parcel.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;ups_parcel&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Parcel missions of UPS Courier&quot;;

this.startUp = function ()
{
    this.pirate = &quot;pirate&quot;;
    this.tiger =  (worldScripts.TigersTurf) ? &quot;tigers&quot; : this.pirate;
    this.dictatorsInstalled = (worldScripts.dictatorship_population !== undefined || worldScripts[&quot;dictators.js&quot;]) ? true : false; // test for old legacy script and 1.4+ js script
    this.mark = false;
    this.upsMarkSystem = worldScripts[&quot;ups_docs&quot;].upsMarkSystem;
    this.upsUnmarkSystem = worldScripts[&quot;ups_docs&quot;].upsUnmarkSystem;
}

this.shipWillDockWithStation = function (station)
{
    if (station.isMainStation)
    {
        this.ups_reports(station);
    }
}

this.missionScreenOpportunity = function ()
{
    if (player.ship.docked)
    {
        this.missionOffers();
    }
}

this.ups_reports = function (station)
{
    if (this.ups_parcel === &quot;SMALL_DELIVERY&quot; &amp;&amp; system.government === 4 &amp;&amp;
                this.ups_pplanet !==  system.ID &amp;&amp; this.ups_pcount &gt; 0 &amp;&amp;
                missionVariables.ups_ambush != &quot;YES&quot;)
    {
        this.reportDelivery(150);
    }
    if (this.ups_parcel === &quot;MIDAIR_DELIVERY&quot; &amp;&amp; this.ups_pplanet ===  system.ID)
    {
        this.reportDelivery(150);
    }
}

this.addUpsContract = function ()
{
    var thisSystem = system.info;

    var targetSystems = SystemInfo.filteredSystems(this, function(other){
           return (other.systemID !== thisSystem.systemID) &amp;&amp; other.government == 4 &amp;&amp; !system.sun.hasGoneNova;
    });
    var count = Math.ceil(Math.random()*5);

    for (var i = 0; i&lt;count; i++)
    {
        var contractSystem = targetSystems[Math.floor(Math.random() * targetSystems.length)];
        var contractRoute = system.info.routeToSystem(contractSystem);
        if (contractRoute) {
			var contractDescription = expandDescription(&quot;[ups_colors] [ups_parcel_description]&quot;);
			contractDescription = contractDescription.charAt(0).toUpperCase() + contractDescription.slice(1);

			var parcel =
			{
				destination: contractSystem.systemID,
				sender: &quot;UPS courier&quot;,
				deadline: clock.seconds + contractRoute.time * 3600 + 3600*24*2,
				payment: Math.floor(contractRoute.distance * (3+Math.random()) + (Math.pow(contractRoute.route.length,1+(0.3*player.parcelReputation))) + 50),
				description: contractDescription,
				route: contractRoute
			}

	        worldScripts[&quot;oolite-contracts-parcels&quot;]._addParcelToSystem(parcel);
		}
    }
};

this.reportDelivery = function (payment)
{
    var message = expandDescription(&quot;You deliver the [mission_ups_parcel_appearance] parcels to the UPS office at the station. In return you receive &quot;+payment+&quot; â¢.&quot;);
    player.addMessageToArrivalReport(message);
    player.credits += payment;
    this.ups_pcount++;
    mission.setInstructionsKey(null);
    this.ups_parcel = &quot;NOT_NOW&quot;;
    this.upsUnmarkSystem(this.ups_pplanet, this.name);
    missionVariables.ups_pplanetname = null;
    missionVariables.ups_ambush = null;
    missionVariables.ups_parcel_appearance = null;
    worldScripts[&quot;ups_docs&quot;].increaseReputation(1);
}

this.guiScreenChanged = function (newScreen, oldScreen)
{
    if (this.restartMissionOffer &amp;&amp; newScreen !== &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
    {
        this.restartMissionOffer = false;
        if (guiScreen !== &quot;GUI_SCREEN_MISSION&quot;) this.missionOffers();
    }
}

this.missionOffers = function ()
{
    if (this._savedTargetSet) player.ship.targetSystem = this._savedTarget
    this._savedTarget = null;
    this._savedTargetSet = false;

	var parcelStatus = this.ups_parcel // for speed reasons don&#39;t test to often against a mission variable.
    if (player.ship.dockedStation.isMainStation)
    {
        if (parcelStatus === &quot;YES&quot;)
        {
            if (system.government === 4 &amp;&amp; this.ups_pcount &gt; 20 &amp;&amp; player.ship.bounty &lt; 3 &amp;&amp;
                        this._reputation() &gt; 4 &amp;&amp; (Math.random() &lt; 0.25 || this.mark) &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
            {
                // Medicine offer.
                if (!this.mark)
                {
                    // a nova system has the market set. Also avoid other systems with customised markets from selection.
                    this.ups_pplanet = Math.round(Math.random()*255);
                }

				missionVariables.ups_pplanetname = System.systemNameForID(this.ups_pplanet);
				missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] [ups_colors] %I&quot;);
				if (!this.mark) missionVariables.ups_disease = expandDescription(&quot;[ups_diseases]&quot;);
                missionVariables.ups_medicine_inhabitants = System.infoForSystem(galaxyNumber, this.ups_pplanet).inhabitants;
                var message = expandMissionText(&quot;ups_parcel_medicin_offer&quot;, {dockedStationName: player.ship.dockedStation.displayName});
				mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, message: message,
                                overlay: this._overlay(), choicesKey: &quot;ups_parcel_accepted_yesnolook&quot;},
                                this.choiceEvaluation);
                this.offering =&quot;UPS_PARCEL_MEDICINS&quot;;
                missionVariables.ups_medicine_inhabitants = null;
            }
            else if (system.government === 4 &amp;&amp; worldScripts[&quot;ups_docs&quot;].ups_dcount &gt; 2 &amp;&amp; player.ship.bounty &lt; 3 &amp;&amp; this._reputation() &gt; 2)
            {
                // Parcel offer
                missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] [ups_colors] %I&quot;)
                var today = new Date()
                if (today.getMonth()==11 &amp;&amp; today.getDate() &gt; 15 &amp;&amp; today.getDate() &lt; 26)
                    missionVariables.ups_parcel_appearance += &quot; Christmas&quot;;
                if (!this.ups_pcount)
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_1st_offer&quot;,
                                        overlay: this._overlay(), choicesKey: &quot;ups_parcel_accepted_yesno&quot;},
                                        this.choiceEvaluation)
                else mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_offer&quot;,
                                        overlay: this._overlay(), choicesKey: &quot;ups_parcel_accepted_yesno&quot;},
                                        this.choiceEvaluation);
                this.offering =&quot;UPS_PARCELS&quot;;
            }
            else this.setUpsReputation();
        }
        if (parcelStatus === &quot;SMALL_DELIVERY&quot;)
        {
            if (system.government === 4)
            {
                if (this.ups_pplanet === system.ID)
                {
                    this.ups_parcel = &quot;ACCEPTED&quot;;
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_back_at_home_parcels&quot;, overlay: this._overlay()});
                    worldScripts[&quot;ups_docs&quot;].increaseReputation(-1);
                }
                else
                {
                    this.ups_parcel = &quot;NOT_NOW&quot;;
                    player.credits += 150;
                    mission.setInstructionsKey(null);
                    if (!this.ups_pcount)
                    {
                        mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_1st_unloading&quot;, overlay: this._overlay()});
                    }
                    else
                    {
                        if (missionVariables.ups_ambush === &quot;YES&quot;)
                        {
                            mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_ambush&quot;, overlay: this._overlay()});
                            player.credits += 500;
                        }
                        // else // written in arrival report
                    }
                    this.ups_pcount++;
                    worldScripts[&quot;ups_docs&quot;].increaseReputation(1);
                    missionVariables.ups_parcel_appearance = null;
                    missionVariables.ups_ambush = null;
                    missionVariables.ups_pplanetname = null;
                    if (!worldScripts.GNN &amp;&amp; worldScripts.snoopers &amp;&amp; worldScripts.snoopers.version &gt;= 2.0) worldScripts.snoopers.insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_parcels]&quot;)});
                    if (worldScripts.GNN &amp;&amp; worldScripts.GNN.version &gt;= 1.0) worldScripts.GNN._insertNews({ID: this.name, Agency: 1, Message: expandDescription(&quot;[ups_snoopers_parcels]&quot;)});
                }
            }
        }
        if (parcelStatus === &quot;MEDICIN_DELIVERY&quot;)
        {
            var passedTime = clock.minutes/24/60 - this.ups_ptimerstart; // time in days.
            if (this.ups_pplanet === system.ID)
            {
                missionVariables.ups_medicine_government = system.government;
                missionVariables.ups_medicine_population = system.population;
                missionVariables.ups_medicine_productivity = system.productivity;
                missionVariables.ups_medicine_description = system.description;
                missionVariables.ups_medicine_inhabitants = system.inhabitantsDescription;
                mission.setInstructionsKey(null);
                this.upsUnmarkSystem(this.ups_pplanet, this.name);
                this.ups_ptimerstart = clock.days;

                if (passedTime &lt; 15)
                {
                    this.ups_parcel = &quot;MEDICIN_SUCCESS&quot;;
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, messageKey: &quot;ups_parcel_medicin_unloading&quot;, overlay: this._overlay()});
                    player.credits += 4500;
                    this.ups_pcount++;
                    worldScripts[&quot;ups_docs&quot;].increaseReputation(4);
                }
                else
                {
                    this.ups_parcel = &quot;MEDICIN_FAILURE&quot;;
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, messageKey: &quot;ups_parcel_medicin_unloading_late&quot;, overlay: this._overlay()});
                    worldScripts[&quot;ups_docs&quot;].increaseReputation(-3);
                    this.ups_ptimerstart = clock.days;
                }
            }
            else if (passedTime &gt; 30)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, messageKey: &quot;ups_parcel_medicin_expired&quot;, overlay: this._overlay()});
                mission.setInstructionsKey(null);
                this.resetMedicines(galaxyNumber, false);
                this.upsUnmarkSystem(this.ups_pplanet);
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-6);
            }
            else
            {
                this.updateMessages();
            }
        }
        if (parcelStatus === &quot;MEDICIN_SUCCESS&quot;)
        {
            if (this.ups_pplanet != system.ID  &amp;&amp; (clock.hours/24 - this.ups_ptimerstart) &gt; 10)
            {
                missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] [ups_colors] %I&quot;);
                var message = expandMissionText(&quot;ups_parcel_medicin_offer_2a&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, message: message,
                                    overlay: this._overlay(), choicesKey: &quot;ups_parcel_accepted_yesno&quot;},
                                    this.choiceEvaluation);
                this.offering =&quot;UPS_PARCEL_MEDICINS_2&quot;;
            }
            else this.setUpsReputation();
        }
        if (parcelStatus === &quot;MEDICIN_FAILURE&quot;)
        {
            if (this.ups_pplanet != system.ID  &amp;&amp; (clock.hours/24 - this.ups_ptimerstart) &gt; 10)
            {
                missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] [ups_colors] %I&quot;);
                var message = expandMissionText(&quot;ups_parcel_medicin_offer_2b&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, message: message,
                                    overlay: this._overlay(), choicesKey: &quot;ups_parcel_accepted_yesno&quot;},
                                    this.choiceEvaluation);
                this.offering =&quot;UPS_PARCEL_MEDICINS_2&quot;;
            }
            else this.setUpsReputation();
        }
        if (parcelStatus === &quot;MEDICIN_DELIVERY_2&quot; &amp;&amp; this.ups_pplanet === system.ID)
        {
            this.ups_parcel = &quot;NOT_NOW&quot;;
            var success = false;
            if ((clock.hours/24 - this.ups_ptimerstart) &lt; 15)
            {
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, messageKey: &quot;ups_parcel_medicin_unloading_2&quot;, overlay: this._overlay()});
                player.credits += 4500;
                this.ups_pcount++;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(4);
                success = true;
            }
            else
            {
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Medicine Transport&quot;, messageKey: &quot;ups_parcel_medicin_unloading_late&quot;, overlay: this._overlay()});
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-5);
            }

            this.resetMedicines(galaxyNumber, success);
            this.upsUnmarkSystem(this.ups_pplanet, this.name);
            missionVariables.ups_pplanetname = null;
            missionVariables.ups_museumGoods = null;
            mission.setInstructionsKey(null);
        }
        if (parcelStatus === &quot;LOGGING&quot;)
        {
            if (system.government === 4 &amp;&amp; player.credits &gt; 15000 &amp;&amp; this.ups_pplanet != system.ID &amp;&amp; (clock.days - this.ups_ptimerstart) &gt; 8 &amp;&amp; this._reputation() &gt; 3 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
            {
                if (!this.mark) //has not seen this offer before, aka not used the long range chart option.
                {
                    missionVariables.ups_museumGoods = expandDescription(&quot;[ups_museumGoods]&quot;);
                    if (!missionVariables.ups_trumbles &amp;&amp; missionVariables.trumbles === &quot;TRUMBLE_BOUGHT&quot; &amp;&amp; Math.random() &lt; 0.75 &amp;&amp; player.trumbleCount === 0)
                    {
                        if (player.ship.equipmentStatus(&quot;EQ_TRUMBLE&quot;) === &quot;EQUIPMENT_OK&quot;) player.ship.removeEquipment(&quot;EQ_TRUMBLE&quot;);
                        missionVariables.ups_museumGoods = expandDescription(&quot;[ups_trumbles]&quot;);
                        missionVariables.ups_trumbles = &quot;ESCAPED&quot;;
                    }
                }
                var message = expandMissionText(&quot;ups_parcel_offer2&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, message: message,
                                    overlay: this._overlay(), choicesKey: &quot;ups_parcel_museum_accepted_yesnolook&quot;},
                                    this.choiceEvaluation);
                this.offering = &quot;UPS_PARCELS2&quot;;
            }
            else this.setUpsReputation();
        }
        if (parcelStatus === &quot;SPECIAL_DELIVERY&quot;)
        {
            if (this.ups_pplanet == system.ID)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                if (missionVariables.ups_trumbles === &quot;ESCAPED&quot;)
                {
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_trumbles&quot;, overlay: &quot;trumblebox.png&quot;});
                    player.credits -= 1000;
                    missionVariables.ups_trumbles = &quot;YES&quot;;
					this.playSound(&quot;trumblesqueal.ogg&quot;);
                }
                else
                {
                    mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_parcel_unloading2&quot;, overlay: this._overlay()})
                }
                player.credits += 15000;
                this.ups_pcount++;
                mission.setInstructionsKey(null);
                missionVariables.ups_pplanetname = null;
                missionVariables.ups_museumGoods = null;
                missionVariables.ups_escorts = null;
                this.upsUnmarkSystem(this.ups_pplanet, this.name);
                this.ups_ptimerstart = null;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(3);
				 // clean up escorts by docking them.
				var escorts = system.shipsWithPrimaryRole(&quot;escort_ups&quot;, player.ship);
				for (var i=0; i&lt; escorts.length;i++) if (escorts[i].isValid) escorts[i].switchAI(&quot;dockingAI.plist&quot;);
             }
        }
        if (parcelStatus === &quot;ASTRO_OFFER&quot; &amp;&amp; system.government === 3 &amp;&amp; system.economy &lt; 3)
        {
            if (system.countShipsWithRole(&quot;astrofactory&quot;) &gt; 0)
            {
                missionVariables.ups_parcel_appearance = expandDescription(&quot;[ups_numbers] astro factory&quot;);
                var message = expandMissionText(&quot;ups_parcel_astroAttack&quot;, {dockedStationName: player.ship.dockedStation.displayName});
                mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, message: message, model: &quot;astrofactory&quot;,
                                    overlay: this._overlay(), choicesKey: &quot;ups_astro_parcel_accepted_yesno&quot;},
                                    this.choiceEvaluation);
                this.addAstroPirates(20);
                this.offering = &quot;UPS_PARCEL_ASTRO&quot;;
            }
            else parcelStatus = this.ups_parcel = &quot;NO&quot;;
        }
        if (parcelStatus === &quot;ASTRO_ACCEPTED&quot; &amp;&amp; system.countShipsWithRole(&quot;astrofactory&quot;) === 0)
        {
            this.ups_parcel = &quot;NOT_NOW&quot;;
            if (this.ups_pplanet === system.ID)
                            mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_astro_parcel_destroyed&quot;, overlay: this._overlay()});
            mission.setInstructionsKey(null);
            this.upsUnmarkSystem(this.ups_pplanet, this.name);
            missionVariables.ups_pplanetname = null;
            missionVariables.ups_parcel_appearance = null;
            worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
        }
        if (parcelStatus === &quot;ASTRO_DELIVERY&quot; &amp;&amp; this.ups_pplanet === system.ID)
        {
            this.ups_parcel = &quot;NOT_NOW&quot;;
            mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_astro_parcel_unloading&quot;, overlay: this._overlay()});
            player.credits += 250;
            this.ups_pcount++;
            mission.setInstructionsKey(null);
            this.upsUnmarkSystem(this.ups_pplanet, this.name);
            missionVariables.ups_pplanetname = null;
            missionVariables.ups_parcel_appearance = null;
            worldScripts[&quot;ups_docs&quot;].increaseReputation(3);
        }
		if (parcelStatus === &quot;NO&quot; || this.ups_parcel === &quot;NOT_NOW&quot;)
		{
            this.setUpsReputation();
		}
    };
	// Not at a mainStation
    if (parcelStatus === &quot;ASTRO_ACCEPTED&quot; &amp;&amp; player.ship.dockedStation.name === &quot;Imperial AstroFactory&quot;)
    {
        this.ups_parcel = &quot;ASTRO_DELIVERY&quot;;
        mission.runScreen({screenID: &quot;ups-parcel&quot;, title: &quot;Parcel Transport&quot;, messageKey: &quot;ups_astro_parcel_loading&quot;, overlay: this._overlay()});
        mission.setInstructionsKey(&quot;ups_astro_parcel_small2&quot;);
        var astroPirates = system.shipsWithPrimaryRole(&quot;pirate&quot;, player.ship, 40E3); // all pirates in a radius of 40000 m around the player
        for (var i=0; i&lt;astroPirates.length;i++)
        {
            if (astroPirates[i].isValid)
            {
                astroPirates[i].switchAI(&quot;upsAmbushPirateAI.plist&quot;);
                if (astroPirates[i].script.name != &quot;oolite-default-ship-script&quot;) astroPirates[i].setScript(&quot;oolite-default-ship-script.js&quot;);
            }
        }
        player.ship.fuel = 7;
    }
}

this.choiceEvaluation = function (choice)
{
    switch (this.offering)
    {
        case &quot;UPS_PARCELS&quot;:
        {
            if (choice === &quot;YESParcel&quot;)
            {
                mission.setInstructionsKey(&quot;ups_parcel_small&quot;);
                this.ups_parcel = &quot;ACCEPTED&quot;;
                this.ups_pplanet = system.ID;
                missionVariables.ups_pplanetname = system.name;
                if (Math.random() &lt; 0.2 &amp;&amp; this.ups_pcount &gt; 1) missionVariables.ups_ambush = &quot;POSSIBLE&quot;
            }
            else if (choice === &quot;NOParcel&quot;)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                missionVariables.ups_parcel_appearance = null;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
            }
            break;
        }
        case &quot;UPS_PARCELS2&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESParcel&quot;)
            {
                mission.setInstructionsKey(&quot;ups_parcel_small2&quot;, &quot;ups_parcel&quot;);
                this.ups_parcel = &quot;SPECIAL_DELIVERY&quot;;
                this.upsMarkSystem(this.ups_pplanet, this.name);
                player.credits -= 10000;
                missionVariables.ups_escorts = 8;
            }
            else if (choice === &quot;LOOKParcel&quot;)
            {
                this.upsShowDestination(this.ups_pplanet);
            }
            else if (choice === &quot;NOParcel&quot;)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
            }
            break;
        }
        case &quot;UPS_PARCEL_MEDICINS&quot;:
        {
            this.mark = false;
            if (choice === &quot;YESParcel&quot;)
            {
                mission.setInstructions(expandMissionText(&quot;ups_parcel_small3&quot;, {ups_days_left: &quot;within 15 days&quot;}));
                this.ups_parcel = &quot;MEDICIN_DELIVERY&quot;;
                this.upsMarkSystem(this.ups_pplanet, this.name);
                this.ups_ptimerstart = clock.minutes/24/60; // time in days
                missionVariables.ups_museumGoods = missionVariables.ups_disease + &quot; medicine&quot;;
            }
            else if (choice === &quot;LOOKParcel&quot;)
            {
                this.upsShowDestination(this.ups_pplanet);
            }
            else if (choice === &quot;NOParcel&quot;)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
            }
            break;
        }
        case &quot;UPS_PARCEL_MEDICINS_2&quot;:
        {
            if (choice === &quot;YESParcel&quot;)
            {
                mission.setInstructions(expandMissionText(&quot;ups_parcel_small3&quot;, {ups_days_left: &quot;within 15 days&quot;}));
                this.ups_parcel = &quot;MEDICIN_DELIVERY_2&quot;;
                this.upsMarkSystem(this.ups_pplanet, this.name);
                this.ups_ptimerstart = clock.minutes/24/60;
                var targetSystem = System.infoForSystem(galaxyNumber, this.ups_pplanet);
                targetSystem.description = &quot;The &quot;+ missionVariables.ups_medicine_inhabitants+ &quot; that are living on this planet are dying from an outbreak of &quot; + missionVariables.ups_disease+&quot;.&quot;;
                if (missionVariables.ups_medicine_inhabitants.indexOf(&quot;Very pale looking&quot;) &lt; 0) // don&#39;t change this twice.
                    targetSystem.inhabitants = &quot;Very pale looking &quot; + missionVariables.ups_medicine_inhabitants;
                targetSystem.population = Math.round(missionVariables.ups_medicine_population/10);
                targetSystem.productivity = Math.round(missionVariables.ups_medicine_productivity/40);
                targetSystem.government = 0;
            }
            else if (choice === &quot;NOParcel&quot;)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
                this.resetMedicines(galaxyNumber, false);
            }
            break;
        }
        case &quot;UPS_PARCEL_ASTRO&quot;:
        {
            if (choice === &quot;YESParcel&quot;)
            {
                mission.setInstructionsKey(&quot;ups_astro_parcel_small&quot;);
                this.ups_parcel = &quot;ASTRO_ACCEPTED&quot;;
                missionVariables.ups_parcel_appearance = &quot;imperial astrofactory&quot;;
                this.ups_pplanet = system.ID;
                missionVariables.ups_pplanetname = system.name;
                this.upsMarkSystem(this.ups_pplanet, this.name);
            }
            else if (choice === &quot;NOParcel&quot;)
            {
                this.ups_parcel = &quot;NOT_NOW&quot;;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
            }
            break;
        }
        default: log(this.name, &quot;Encountered an illegal mission offer: &quot;+this.offering);
    }
    this.offering = null;
}

this.upsShowDestination = function (ID)
{
    if (!this._savedTargetSet) this._savedTarget = player.ship.targetSystem;
    this._savedTargetSet = true;
    
    this.mark = true; // Keep this selected system.
    if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) == &quot;EQUIPMENT_OK&quot;)
    {
        player.ship.targetSystem = ID;
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, backgroundSpecial: &quot;LONG_RANGE_CHART_SHORTEST&quot;});
    }
    else
    {
        mission.markSystem({
                   system: ID,
                   name: &quot;ups_marker&quot;,
                   markerColor: &quot;cyanColor&quot;,
                   markerScale: 2.0,
                   markerShape: &quot;MARKER_DIAMOND&quot;
        })
        var message = expandMissionText(&quot;ups_long_range_screen&quot;, {ups_system: System.systemNameForID(ID)});
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, message: message, backgroundSpecial: &quot;LONG_RANGE_CHART&quot;});
    }
}

this.addAstroPirates = function (amount)
{
    var astroFactory = system.shipsWithPrimaryRole(&quot;astrofactory&quot;)[0];
    var astroPirates = system.addGroup(&quot;pirate&quot;, amount, astroFactory.position.add([0,20E3,0]), 5E3).ships;
    for (var i=0; i&lt;amount;i++)
        if (astroPirates[i].isValid)
        {
            astroPirates[i].switchAI(&quot;upsAstroPirateAI.plist&quot;);
            if (astroPirates[i].script.name != &quot;oolite-default-ship-script&quot;) astroPirates[i].setScript(&quot;oolite-default-ship-script.js&quot;);
            if (astroPirates[i].bounty === 0) astroPirates[i].bounty = Math.random()*100;
        }
}

this.shipExitedWitchspace = function ()
{
    if (system.isInterstellarSpace) return;
	var parcelStatus = this.ups_parcel;
    if (parcelStatus === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.11) this.ups_parcel = &quot;NO&quot;;
    if (parcelStatus === &quot;NO&quot;)
    {
        if (Math.random() &lt; 0.2 &amp;&amp; system.government === 4)
        {this.ups_parcel = &quot;YES&quot;}
        else if (Math.random() &lt; 0.05 &amp;&amp; system.government === 4 &amp;&amp; player.credits &gt; 15000 &amp;&amp; !system.sun.hasGoneNova &amp;&amp; this.ups_pcount &gt; 5)
        {
            this.ups_parcel = &quot;LOGGING&quot;;
            this.ups_pplanet = system.ID;
            missionVariables.ups_pplanetname = system.name;
            this.ups_ptimerstart = clock.days;
        }
        else if (Math.random() &lt; 0.1)
        {
            if (system.government &gt; 3 &amp;&amp; system.economy &gt; 3 &amp;&amp; missionVariables.ups_tcount &gt; 1 &amp;&amp; this._reputation() &gt; 3)
            system.addShipsToRoute(&quot;derelict2_ptt&quot;, 1, Math.random(), &quot;wp&quot;);
        }
        else if (missionVariables.ups_trumbles === &quot;YES&quot;)
        {
            if (Math.random() &lt; 0.85) this.playTrumble = new Timer(this, this.trumbleSound, 30+ Math.random()*120);
			else
			{
				player.ship.awardEquipment(&quot;EQ_TRUMBLE&quot;);
				missionVariables.ups_trumbles = &quot;INFECTED&quot;;
                // Variable stays &quot;INFECTED&quot; to prefent a second infection in this galaxy.
			}
        }
        else if (Math.random() &lt; 0.2 &amp;&amp; this.dictatorsInstalled &amp;&amp; system.government === 3 &amp;&amp; system.economy &lt; 3 &amp;&amp; this.ups_pcount &gt; 10)
        {
            this.ups_parcel = &quot;ASTRO_OFFER&quot;;
        }
    }
    else
    {
        if (parcelStatus === &quot;ACCEPTED&quot;){parcelStatus = &quot;SMALL_DELIVERY&quot;; this.ups_parcel = parcelStatus; }
        if (parcelStatus === &quot;SMALL_DELIVERY&quot; &amp;&amp; !system.isInterstellarSpace)
        {
            system.addShipsToRoute(this.pirate, 3, 0.33)
            if (Math.random() &lt; 0.1 &amp;&amp; missionVariables.ups_ambush === &quot;POSSIBLE&quot;)
            {
				missionVariables.ups_ambush = &quot;YES&quot;;
				player.consoleMessage(expandDescription(&quot;You are spotted with your [mission_ups_parcel_appearance] parcels.&quot;), 6)
			}
			if (missionVariables.ups_ambush === &quot;YES&quot; &amp;&amp; Math.random() &lt; 0.5)
			{
				system.addShips(this.tiger, 1);
				system.addShipsToRoute(this.tiger, 2, 0.2, &quot;wp&quot;);
				if (player.score &gt; 1000 &amp;&amp; (Math.random()*100 + this.ups_pcount - 2*system.government) &gt; 70)
				{
					system.addGroupToRoute(this.pirate, 3, 0, &quot;wp&quot;);
					system.addGroup(this.tiger, 3, this.randomPositionOnRoute(), 5E3);
					system.addShipsToRoute(&quot;ups_pirate_leader&quot;, 1, Math.random(), &quot;wp&quot;);
				}
				if (player.score &gt; 2500 &amp;&amp; (Math.random()*100 + this.ups_pcount - 2*system.government) &gt; 70)
				{
					system.addGroupToRoute(this.tiger, 3, 0, &quot;wp&quot;);
					system.addGroup(this.tiger, 3, this.randomPositionOnRoute(), 5E3);
					system.addShipsToRoute(&quot;ups_pirate_leader&quot;, 1, Math.random(), &quot;wp&quot;);
					if (worldScripts.hardpirates1 !== undefined)
					{
						var hardpirates = system.addShips(&quot;hardpirates&quot;, 1);
                        this.changePirateAI(hardpirates[0], &quot;upsAmbushPirateAI.plist&quot;, this.sendUpsAmbushMessage);
					}
				}
				var ambushpirates = system.shipsWithPrimaryRole(&quot;pirate&quot;, player.ship);
				for (var i=0; i&lt;ambushpirates.length;i++)
                {
					if (ambushpirates[i].isValid) //could have already been destroyed or not present
					{
						this.changePirateAI(ambushpirates[i], &quot;upsAmbushPirateAI.plist&quot;, this.sendUpsAmbushMessage);
                        if (player.score &gt; 2500 * Math.random()) this.awardShields(ambushpirates[i], &quot;EQ_SHIELD_BOOSTER&quot;);
                        if (player.score &gt; 4500 * Math.random()) this.awardShields(ambushpirates[i], &quot;EQ_SHIELD_ENHANCER&quot;);
					}
                }
			}
        }
        if (parcelStatus === &quot;SPECIAL_DELIVERY&quot;)
        {
            if (system.countShipsWithPrimaryRole(&quot;escort_ups&quot;) == 0 &amp;&amp; missionVariables.ups_escorts &gt; 0)
                                        system.addShips(&quot;escort_ups&quot;, missionVariables.ups_escorts, player.ship.position, 10000);
            if (Math.random() &lt; 0.5)
            {
                system.addGroupToRoute(this.pirate, 4, 0.05, &quot;wp&quot;);
                system.addGroupToRoute(this.pirate, 3, 0.075, &quot;wp&quot;);
                system.addGroupToRoute(this.pirate, 3, 0.10, &quot;wp&quot;);
                system.addGroupToRoute(this.pirate, 2, 0.125, &quot;wp&quot;);
                system.addShipsToRoute(this.pirate, 1, 0.15, &quot;wp&quot;);
                var parcelpirates1 = system.shipsWithPrimaryRole(this.pirate, player.ship);
                for (var i=0; i&lt;13;i++) this.changePirateAI(parcelpirates1[i], &quot;upsParcelPirateAI.plist&quot;, this.sendUpsParcelMessage);
            }
            if (Math.random() &lt; 0.25)
            {
				var parcelpirates2 = system.addGroupToRoute(this.tiger, 5, 0, &quot;wp&quot;);
				for (var i=0; i&lt;5;i++) this.changePirateAI(parcelpirates2.ships[i], &quot;upsParcelPirateAI.plist&quot;, this.sendUpsParcelMessage);
            }
			this.addParcelPirates(&quot;pirate&quot;, 5);
			if (missionVariables.ups_trumbles &amp;&amp; missionVariables.ups_trumbles !== &quot;INFECTED&quot; &amp;&amp; Math.random() &lt; 0.50)
            {
                this.playTrumble = new Timer(this, this.trumbleSound, 30+ Math.random()*120);
            }
        }
        if (parcelStatus === &quot;MEDICIN_DELIVERY&quot;)
		{
			if (Math.random() &lt; 0.25) this.addParcelPirates(&quot;pirate&quot;, 5);
            this.updateMessages();
		}
        if (parcelStatus === &quot;MEDICIN_DELIVERY_2&quot;)
		{
			if (Math.random() &lt; 0.25) system.addGroup(this.tiger, 3, this.randomPositionOnRoute(), 5E3);
			if (Math.random() &lt; 0.25) system.addGroup(this.tiger, 3, this.randomPositionOnRoute(), 5E3);
			if (Math.random() &lt; 0.5) this.addParcelPirates(&quot;pirate&quot;, Math.ceil(Math.random()*5));

            this.updateMessages();
		}
		if (parcelStatus === &quot;ASTRO_ACCEPTED&quot;)
		{
			mission.setInstructionsKey(null);
			this.ups_parcel = &quot;NOT_NOW&quot;;
			this.upsUnmarkSystem(this.ups_pplanet);
			missionVariables.ups_pplanetname = null;
			missionVariables.ups_parcel_appearance = null;
		}
    }
    if (system.government === 4 &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.mainStation)
    {
        this.addUpsContract();
    }
}

this.updateMessages = function ()
{
    if (this.messagesTimer)
    {
        this.messagesTimer.start();
    }
    else
    {
        this.messagesTimer = new Timer(this, this.delayedMessageUpdate, 0, 2); // clock might be not valid yet.
    }
}

this.delayedMessageUpdate = function delayedMessageUpdate()
{
    // we need a delayed clock readout after a jump.
    if (clock.isAdjusting)
    {
        mission.setInstructions(expandMissionText(&quot;ups_parcel_small3&quot;, {ups_days_left: &quot;updating....&quot;}));
    }
    else
    {
        mission.setInstructions(expandMissionText(&quot;ups_parcel_small3&quot;,
                    {ups_days_left: worldScripts[&quot;ups_docs&quot;].getTimeToGo(this.ups_ptimerstart + 15)}));
        this.messagesTimer.stop();
    }
}

this.addParcelPirates = function (role, count)
{
    var parcelpirates = system.addGroup(role, count, this.randomPositionOnRoute(), 5E3);
    if (parcelpirates)
    {
        parcelpirates.name = &quot;parcelpirates&quot;;
        for (var i=0; i&lt;parcelpirates.count; i++)
        {
            this.changePirateAI(parcelpirates.ships[i], &quot;upsParcelPirateAI.plist&quot;, this.sendUpsParcelMessage);
            if (parcelpirates.ships[i].isValid)
            {
                this.awardShields(parcelpirates.ships[i], &quot;EQ_SHIELD_ENHANCER&quot;);
            }
        }
    }
}

this.changePirateAI = function (pirate, AI, message)
{
    if (pirate &amp;&amp; pirate.isValid)
    {
        pirate.switchAI(AI);
        // if (pirate.script.name != &quot;oolite-default-ship-script&quot;) pirate.setScript(&quot;oolite-default-ship-script.js&quot;); // should we reset this?
        pirate.script.sendUpsMessage = message; // message is the function to attach that sends the messages.
    }
}

this.randomPositionOnRoute = function ()
{
    var end = system.mainPlanet.position;
    end.z -= 2 * system.mainPlanet.radius;
    return Vector3D.interpolate([0,0,0], end, Math.random()).add(Vector3D.randomDirectionAndLength(20E3));
};

this.awardShields = function (ship, equipment)
{
    if (ship.equipmentStatus(equipment) === &quot;EQUIPMENT_UNAVAILABLE&quot;)
    {
        ship.awardEquipment(equipment);
        ship.energy = ship.maxEnergy;
    }
}

this.playerEnteredNewGalaxy = function (galaxy)
{
    // reset missions on galactic jump
	if (--galaxy &lt; 0) galaxy = 8;
	if (this.ups_parcel.indexOf(&quot;MEDICINE&quot;) &gt; -1) this.resetMedicines(galaxy, false);
    if (this.ups_parcel != &quot;SMALL_DELIVERY&quot;)
    {
            missionVariables.ups_pplanetname = null;
			missionVariables.ups_parcel_appearance = null;
            mission.setInstructionsKey(null);
            this.ups_pplanet = null;
            this.ups_parcel = &quot;NOT_NOW&quot;;
            this.ups_ptimerstart = null;
    }
    if (player.ship.equipmentStatus(&quot;EQ_TRUMBLE&quot;) !== &quot;EQUIPMENT_OK&quot;) delete missionVariables.ups_trumbles;
}

this.trumbleSound = function trumbleSound()
{
	this.playSound(&quot;trumblesqueal.ogg&quot;)
}

this.playSound = function (song)
{
	if (!this.mySound) this.mySound = new SoundSource;
	this.mySound.sound = song; // this.playSound(&quot;trumblesqueal.ogg&quot;);
	this.mySound.play();
}

this.resetMedicines = function (galaxy, success)
{
    var targetSystem = System.infoForSystem(galaxy, this.ups_pplanet);
	if (missionVariables.ups_medicine_government)
	{
		missionVariables.ups_medicine_description = null;
		missionVariables.ups_medicine_inhabitants = null;
		missionVariables.ups_medicine_population = null;
		missionVariables.ups_medicine_government = null;
		missionVariables.ups_medicine_productivity = null;
        if (success)
        {
            // reset descriptions for a successful mission.
            targetSystem.description = null;
            targetSystem.inhabitants = null;
            targetSystem.population = null;
            targetSystem.government = null;
            targetSystem.productivity = null;
        }
		// targetSystem.market = null; // not possible to read correctly in 1.74 ?
	}
	missionVariables.ups_disease = null;
	missionVariables.ups_museumGoods = null;
    this.ups_ptimerstart = null;
}

this._reputation = function ()
{
    return player.parcelReputation;
}

this.setUpsReputation = function ()
{
    if (system.government &lt;= 1) return; // No update in anarchy and feudal!

    var message;
    switch (this._reputation())
    {
        case 7: message = &quot;outstanding&quot;; break;
        case 6: message = &quot;excellent&quot;; break;
        case 5: message = &quot;dedicated&quot;; break;
        case 4: message = &quot;very good&quot;; break;
        case 3: message = &quot;good&quot;; break;
        case 2: message = &quot;above average&quot;; break;
        case 1: message = &quot;average&quot;; break;
        case 0: message = &quot;rookie&quot;; break;
        case -1: message = &quot;incompetent&quot;; break;
        case -2: message = &quot;unreliable&quot;; break;
        case -3: message = &quot;irresponsible&quot;; break;
        default: message = &quot;not trustworthy&quot;; // for all other negative numbers
    }
    mission.setInstructions(expandMissionText(&quot;ups_parcel_reputation&quot;, {ups_reputation: message}));
}

// Code below is linked to ship scripts
this.sendUpsParcelMessage = function ()
{
	if (worldScripts[&quot;ups_docs&quot;].messageAllowed() &amp;&amp; this.ship.target &amp;&amp; this.ship.target.isPlayer)
		this.ship.commsMessage(expandDescription(&quot;[ups_parceltalk]&quot;));
    // no messages within 5 secs to avoid screen clutter.
}

this.sendUpsAmbushMessage = function ()
{
	if (worldScripts[&quot;ups_docs&quot;].messageAllowed() &amp;&amp; this.ship.target &amp;&amp; this.ship.target.isPlayer)
		this.ship.commsMessage(expandDescription(&quot;[ups_ambush_talk]&quot;));
    // no messages within 5 secs to avoid screen clutter.
}

this._overlay = function() {
    if (player.ship.hudHidden || player.ship.hudAllowsBigGui) {
        return {name:&quot;upsnews-large.png&quot;, height:546};
    } else {
        return {name:&quot;upsnews-small.png&quot;, height:546};
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_slaves.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;ups_slaves&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Slaves missions of UPS Courier&quot;;

this.startUp = function ()
{
    this.mark = false;
    this.upsMarkSystem = worldScripts[&quot;ups_docs&quot;].upsMarkSystem;
    this.upsUnmarkSystem = worldScripts[&quot;ups_docs&quot;].upsUnmarkSystem;
}

this.startUpComplete = function() 
{
    // fixing issue where ups_slaves hasn&#39;t been initialised properly.
    //if (this.ups_slaves == null) this.ups_slaves = &quot;NO&quot;;
}

this.shipLaunchedFromStation = function ()
{
  if (this.ups_slaverescue)
  {
    this.setUpShips();
  }
}

this.missionScreenOpportunity = function ()
{
    // this.ups_slaverescue is set to &quot;true&quot; by a scooping a special escape_pod generated by a cobraIII.
    if (player.ship.docked &amp;&amp; this.ups_slaverescue)
    {
        this.missionOffers();
    }
}

this.guiScreenChanged = function (newScreen, oldScreen)
{
    if (this.restartMissionOffer &amp;&amp; newScreen !== &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;)
    {
        this.restartMissionOffer = false;
        if (guiScreen !== &quot;GUI_SCREEN_MISSION&quot;) this.missionOffers();
    }
}

this.missionOffers = function ()
{
    if (this._savedTargetSet) player.ship.targetSystem = this._savedTarget
    this._savedTarget = null;
    this._savedTargetSet = false;

	var slaveStatus = this.ups_slaves;
    if (player.ship.dockedStation.isMainStation)
    {
        if (slaveStatus === &quot;SLAVE&quot; &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
        {
            var message = expandMissionText(&quot;ups_slave_homeland&quot;, {ups_slavename: this.ups_slavename});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message,
                                overlay: this._overlay(), choicesKey: &quot;ups_slave_accepted_yesnolook&quot;},
                                this.choiceEvaluation);
            this.offering =&quot;UPS_SLAVES_HOMELANDS&quot;;
        }
        if (slaveStatus === &quot;HOMELAND&quot; &amp;&amp; this.ups_slplanet === system.ID)
        {
            this.ups_slaves = &quot;NOT_NOW&quot;;
            this.upsUnmarkSystem(this.ups_slplanet, this.name);
            var message = expandMissionText(&quot;ups_slave_homeland2&quot;, {ups_slavename: this.ups_slavename});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message, overlay: this._overlay()});
            mission.setInstructionsKey(null);
            player.ship.manifest[&quot;gem_stones&quot;] += 15;
            this.ups_slcount++;
            player.increasePassengerReputation();
        }
        if (slaveStatus === &quot;RESCUEOFFER&quot; &amp;&amp; system.government &gt; 3 &amp;&amp; system.economy &lt; 3 &amp;&amp; !worldScripts[&quot;ups_docs&quot;].lookLongRangeChartScreen)
        {
            var message = expandMissionText(&quot;ups_slave_rescueoffer&quot;, {ups_slavename: this.ups_slavename});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message,
                            overlay: this._overlay(), choicesKey: &quot;ups_slave_accepted2_yesnolook&quot;},
                            this.choiceEvaluation);
            this.offering =&quot;UPS_SLAVES_RESCUE&quot;;
        }
        if (slaveStatus === &quot;RESCUE&quot; &amp;&amp; system.ID === this.ups_sl2planet)
        {
			if (this.ups_convoy === &quot;KILLED&quot;)
			{
				var key;
                if (this.ups_sl2count &gt; 10)
				{
					// rescued all
                    key = &quot;ups_slave_rescue10&quot;;
                    player.ship.manifest[&quot;gem_stones&quot;] += 50;
				}
				else
				{
					if (this.ups_sl2count &gt; 0) key = &quot;ups_slave_rescue&quot;
					else key = &quot;ups_slave_rescue0&quot;; // rescued none!
				}
                var message = expandMissionText(key, {ups_slavesrescued: this.ups_sl2count, ups_slavename: this.ups_slavename});
                mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message});
				this.resetConvoyMission();
				this.ups_slcount += 3;
			}
			else if (this.ups_convoy === &quot;ADDED&quot; &amp;&amp; system.countShipsWithRole(&quot;ups-slaveconvoy&quot;) === 0)
			{
                var message = expandMissionText(&quot;ups_slave_rescue_failure&quot;, {ups_slavename: this.ups_slavename});
				mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message});
				this.resetConvoyMission();
				this.ups_slcount -= 2;
			};
        }
        if (slaveStatus === &quot;FINALOFFER&quot; &amp;&amp; system.government &gt; 2)
        {
            var message = expandMissionText(&quot;ups_slave_final&quot;, {ups_slavename: this.ups_slavename});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message,
                            choicesKey: &quot;ups_slave_accepted_yesno&quot;}, this.choiceEvaluation);
            this.offering = &quot;UPS_SLAVES_FINAL&quot;;
        }
        if (slaveStatus === &quot;FINAL&quot; &amp;&amp; this.ups_slplanet === system.ID)
        {
            this.ups_slaves = &quot;GROUNDBATTLE&quot;;
            var message = expandMissionText(&quot;ups_slave_groundbattle&quot;, {ups_slavename: this.ups_slavename});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message, model: &quot;ups_slave_satellite&quot;, spinModel: false});
            this.$startCallback();
            mission.setInstructionsKey(&quot;ups_slave_groundbattle_small&quot;);
            this.ups_slavesrescued = 5;
        }
        if (slaveStatus === &quot;DEBRIEFING&quot; &amp;&amp; this.ups_slplanet === system.ID)
        {
            this.ups_slaves = &quot;NOT_NOW&quot;;
            mission.setInstructionsKey(null);
            var key;
            if (this.ups_slavesrescued == 5)
            {
                key = &quot;ups_slave_debriefing&quot;; // rescued all
                player.credits += 6000;
            }
            else
            {
                if (!this.ups_slavesrescued)
                {
                    key = &quot;ups_slave_debriefing2&quot;; // rescued none
                }
                else
                {
                    key = &quot;ups_slave_debriefing1&quot;;
                    player.credits += 4000;
                }
            }
            var message = expandMissionText(key, {ups_slavesrescued: this.ups_slavesrescued});
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, message: message});
            mission.setInstructionsKey(null);
			this.upsUnmarkSystem(this.ups_slplanet, this.name);
            this.resetSlaves(galaxyNumber);
            return;
        }
    }
    if (player.ship.dockedStation.name === &quot;Ground Radar&quot;)
    {
        if (slaveStatus === &quot;DEBRIEFING&quot; || slaveStatus === &quot;GROUNDBATTLE&quot;)
        {
            this.ups_slaves = &quot;FAILED&quot;;
            mission.runScreen({screenID: &quot;ups-slaves&quot;, title: &quot;Slave Mission&quot;, messageKey: &quot;ups_slave_trapped&quot;});
			this.upsUnmarkSystem(this.ups_slplanet, this.name)
            this.resetSlaves(galaxyNumber);
            // should this end the game now?
        }
    }
}

this.choiceEvaluation = function (choice)
{
    switch (this.offering)
    {
        case &quot;UPS_SLAVES_HOMELANDS&quot;:
        {
            this.mark = false
            if (choice === &quot;YESSlave&quot;)
            {
                this.upsMarkSystem(this.ups_slplanet, this.name);
                mission.setInstructions(expandMissionText(&quot;ups_slave_small&quot;, {ups_slavename: this.ups_slavename}));
                this.ups_slaves = &quot;HOMELAND&quot;;
            }
            else if (choice === &quot;LOOKSlave&quot;)
            {
                this.upsShowDestination(this.ups_slplanet);
            }
            else if (choice === &quot;NOSlave&quot;)
            {
                this.ups_slaves = &quot;NOT_NOW&quot;;
                if (Math.random()&lt;0.5) player.decreasePassengerReputation();
            }
            break;
        }

        case &quot;UPS_SLAVES_RESCUE&quot;:
        {
            if (choice === &quot;YESSlave&quot;)
            {
                this.upsMarkSystem(this.ups_sl2planet, this.name);
                mission.setInstructionsKey(&quot;ups_slave_small3&quot;);
                this.ups_slaves = &quot;RESCUE&quot;;
                this.ups_sl2count = 0;
                this.ups_convoy = null;
            }
            else if (choice === &quot;LOOKSlave&quot;)
            {
                this.upsShowDestination(this.ups_sl2planet);
            }
            else if (choice === &quot;NOSlave&quot;)
            {
                this.ups_slaves = &quot;NOT_NOW&quot;;
            }
            break;
        }

        case &quot;UPS_SLAVES_FINAL&quot;:
        {
            if (choice === &quot;YESSlave&quot;)
            {
                this.upsMarkSystem(this.ups_slplanet, this.name);
                mission.setInstructions(expandMissionText(&quot;ups_slave_small2&quot;, {ups_slavename: this.ups_slavename}));
                this.ups_slaves = &quot;FINAL&quot;;
            }
            else if (choice === &quot;NOSlave&quot;)
            {
                this.ups_slaves = &quot;NOT_NOW&quot;;
            }
            break;
        }
        default: log(this.name, &quot;Encountered an illegal mission offer: &quot;+this.offering);
    }
    this.offering = null;
}

this.upsShowDestination = function (ID)
{
    if (!this._savedTargetSet) this._savedTarget = player.ship.targetSystem;
    this._savedTargetSet = true;
    
    this.mark = true; // Keep this selected system.
    if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) == &quot;EQUIPMENT_OK&quot;)
    {
        player.ship.targetSystem = ID;
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, backgroundSpecial: &quot;LONG_RANGE_CHART_SHORTEST&quot;});
    }
    else
    {
        mission.markSystem({
            system: ID,
            name: &quot;ups_marker&quot;,
            markerColor: &quot;cyanColor&quot;,
            markerScale: 2.0,
            markerShape: &quot;MARKER_DIAMOND&quot;
        })
        var message = expandMissionText(&quot;ups_long_range_screen&quot;, {ups_system: System.systemNameForID(ID)});
        mission.runScreen({title: &quot;Long Range Chart&quot;, screenID:&quot;ups-map&quot;, message: message, backgroundSpecial: &quot;LONG_RANGE_CHART&quot;});
    }
}

this.setUpShips = function ()
{
    if (this.ups_slaves === &quot;GROUNDBATTLE&quot;)
    {
        if (system.ID === this.ups_slplanet &amp;&amp; system.countShipsWithRole(&quot;ups_slave_satellite&quot;) === 0)
        {
            //system.legacy_addShipsAtPrecisely(&quot;ups_slave_satellite&quot;, 1, &quot;pwp&quot;, [0, 0, 1.004]);
            //system.legacy_addShipsAtPrecisely(&quot;ups_slave_satellite&quot;, 1, &quot;pwp&quot;, [0, 0.05, 1.004]);
            //system.legacy_addShipsAtPrecisely(&quot;ups_slave_satellite&quot;, 1, &quot;pwp&quot;, [0.05, 0, 1.004]);
            //system.legacy_addShipsAtPrecisely(&quot;ups_slave_satellite&quot;, 1, &quot;pwp&quot;, [0.05, 0.05, 1.004]);
            system.addShips(&quot;ups_slave_satellite&quot;, 1, Vector3D(0, 0, 1.008).fromCoordinateSystem(&quot;pwp&quot;), 1);
            system.addShips(&quot;ups_slave_satellite&quot;, 1, Vector3D(0, 0.05, 1.008).fromCoordinateSystem(&quot;pwp&quot;), 1);
            system.addShips(&quot;ups_slave_satellite&quot;, 1, Vector3D(0.05, 0, 1.008).fromCoordinateSystem(&quot;pwp&quot;), 1);
            system.addShips(&quot;ups_slave_satellite&quot;, 1, Vector3D(0.05, 0.05, 1.008).fromCoordinateSystem(&quot;pwp&quot;), 1);
            this.ups_satellitecount = 4;
            // Smallest planet radius = 30 000 meters. 0.004*30 000 = 120 meters. This just fits for the towers.
            // phkb: adjusted to 0.008, as the planet is rotating and the radars are not being moved with the planet
            //       so having them slightly more above the surface reduces the break in mimesis
        }
    }
    if (this.ups_slaves === &quot;RESCUE&quot;)
    {
        if (system.ID === this.ups_sl2planet &amp;&amp; system.countShipsWithRole(&quot;ups-slaveconvoy&quot;) === 0 &amp;&amp; !this.ups_convoy)
        {
            log(this.name, &quot;adding ups-convoy-l to system&quot;);
            system.addShipsToRoute(&quot;ups-convoy-l&quot;, 1, 0.5, &quot;wp&quot;);
			this.ups_convoy = &quot;ADDED&quot;;
        }
    }
}

this.shipExitedWitchspace = function ()
{
    if (system.isInterstellarSpace) return;
    if (this.ups_slaverescue)
    {
        this.setUpShips();
        if (!this.ups_slaves)
        { // selection of a target system for all slave missions. And make sure you don&#39;t select a Nova system.
            if (system.government === 2 &amp;&amp; system.economy &gt; 5 &amp;&amp; !system.sun.hasGoneNova &amp;&amp; !this.ups_splanet)
            // original had &#39; &amp;&amp; (!system.info.hasOwnProperty(&quot;market&quot;) || !system.info.market)&#39; in above clause
            // replaced with &quot; &amp;&amp; !this.ups_splanet&quot;
            // even this clause may not be required
            {
                this.ups_slaves = &quot;NO&quot;;
                this.ups_slplanet = system.ID;
                missionVariables.ups_slplanetname = system.name;
                this.ups_slcount = 0;
                missionVariables.ups_slplanetdescription = system.description;
                system.description += &quot; Currently this planet is in civil war and is selling a lot of its inhabitants as slaves.&quot;;
                //system.info.market = &quot;ups_slaveplanet&quot;;
                // There are a couple of options here to do the update of the slave market.
                // We could create an updateGeneralCommodityDefinition or updateLocalCommodityDefinition routine
                // but the downside is that we would have to change the logic for the decision making process,
                // changing the time the decision is made to be before we exit witchspace.
                // To keep the logic as similar to the original as possible, we&#39;re instead going to force an
                // update to market prices and quantities after the system is generated.
                // We&#39;re assuming that the only thing that needs to be adjusted is the &quot;slaves&quot; price and quantity,
                // and that all other trade goods remain the same.
                this._updateLocalSlaveMarket();
                // we should only have to do this once, as the adjusted definition will be saved and restored
                // as part of a player save game.
            }
        }
        var slaveStatus = this.ups_slaves;
        if (slaveStatus === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.11) this.ups_slaves = &quot;NO&quot;;
        if (slaveStatus === &quot;NO&quot;)
        {
            if (this.ups_slcount &gt; 5 &amp;&amp; system.government &gt; 2 &amp;&amp; Math.random() &gt; 0.9)
            {
                this.ups_slaves = &quot;FINALOFFER&quot;;
            }
            else if (this.ups_slcount &gt; 1 &amp;&amp; Math.random() &gt; 0.9 &amp;&amp; system.government === 2 &amp;&amp; !system.sun.hasGoneNova)
            {
                this.ups_slaves = &quot;RESCUEOFFER&quot;;
                this.ups_sl2planet = system.ID;
                missionVariables.ups_sl2planetname = system.name;
            }
            else if (!system.isInterstellarSpace &amp;&amp; Math.random() &gt; 0.75 &amp;&amp; system.economy &lt; 3)
            {
                log(this.name, &quot;adding ups-slavecobra ship to system&quot;);
                system.addShipsToRoute(&quot;ups-slavecobra&quot;, 1, Math.random() * 0.8 + 0.1); // station route
            }
        }
    }
    else if (system.government === 2 &amp;&amp; Math.random() &gt; 0.5)
    {
        log(this.name, &quot;adding ups_slave_start ship to system&quot;);
        system.addShipsToRoute(&quot;ups_slave_start&quot;, 1, Math.random(), &quot;wp&quot;);
    }
}

this.resetConvoyMission = function ()
{
    this.ups_sl2count = null;
    this.upsUnmarkSystem(this.ups_sl2planet, this.name);
    this.ups_sl2planet = null;
    missionVariables.ups_sl2planetname = null;
    this.ups_convoy = null;
    mission.setInstructionsKey(null);
    this.ups_slaves = &quot;NOT_NOW&quot;;
}

this.resetSlaves = function (galaxy)
{
    // do some cleanup of variables
    mission.setInstructionsKey(null)
	if (missionVariables.ups_slplanetdescription)
	{
		System.infoForSystem(galaxy, this.ups_slplanet).description = null;
        /*if (System.infoForSystem(galaxy, this.ups_slplanet).hasOwnProperty(&quot;market&quot;))
        {
            System.infoForSystem(galaxy, this.ups_slplanet).market = null;
        }*/
		missionVariables.ups_slplanetdescription = null;
	}
    var deletions = [&quot;slavename&quot;, &quot;slplanetname&quot;, &quot;sl2count&quot;, &quot;sl2planetname&quot;];
    for (var i = 0; i &lt; deletions.length; i++) delete missionVariables[&quot;ups_&quot; + deletions[i]];
    var deletions2 = [&quot;slaves&quot;, &quot;slaverescue&quot;, &quot;slplanet&quot;, &quot;sl2planet&quot;, &quot;slcount&quot;, &quot;slavesrescued&quot;];
    for (var i = 0; i &lt; deletions2.length; i++) this[&quot;ups_&quot; + deletions2[i]] = null;
}

this.playerEnteredNewGalaxy = function (galaxy)
{
	if (this.ups_slaves)
	{
		var oldGalaxy = --galaxy;
		if (oldGalaxy &lt; 0) oldGalaxy = 8;
		this.resetSlaves(oldGalaxy);
	}
}

this.$startCallback = function ()
{
    if (!isValidFrameCallback(this.$callbackID)) this.$callbackID = addFrameCallback(this.rotateDisplayModel.bind(this));
    this.displayModel = mission.displayModel;
}

this.rotateDisplayModel = function (delta)
{
    if (guiScreen != &quot;GUI_SCREEN_MISSION&quot; || !mission.displayModel || this.displayModel != mission.displayModel)
    {
        // we are finisched, or the missionscreen has changed.
        this.$cleanupCallback();
        return;
    };
    var q = new Quaternion(1,0,0,0);
    q = q.rotateY(0.1 * delta);
    mission.displayModel.orientation = mission.displayModel.orientation.multiply(q);

}

this.$cleanupCallback = function ()
{
	if (this.$callbackID &amp;&amp; isValidFrameCallback(this.$callbackID))
	{
		removeFrameCallback(this.$callbackID);
        delete this.$callbackID;
	}
}

this._overlay = function() {
    if (player.ship.hudHidden || player.ship.hudAllowsBigGui) {
        return {name:&quot;upsnews-large.png&quot;, height:546};
    } else {
        return {name:&quot;upsnews-small.png&quot;, height:546};
    }
}

this._updateLocalSlaveMarket = function() {
    var oldDefs = [0, 0, 52, -3, -5, 8, 7, 31, 0 ];
    var market_base_price = oldDefs[2];
    var market_eco_adjust_price = oldDefs[3];
    var market_eco_adjust_quantity = oldDefs[4];
    var market_base_quantity = oldDefs[5];
    var market_mask_price = oldDefs[6];
    var market_mask_quantity = oldDefs[7];
    var market_rnd = Math.floor(Math.random() * 256);

    var economy = system.economy;

    var price = (market_base_price + (market_rnd &amp; market_mask_price) + (economy * market_eco_adjust_price)) &amp; 255;
    price *= 0.4;

    var quantity = (market_base_quantity + (market_rnd &amp; market_mask_quantity) - (economy * market_eco_adjust_quantity)) &amp; 255;
    if (quantity &gt; 127) quantity = 0;
    quantity &amp;= 63;

    system.mainStation.setMarketPrice(&quot;slaves&quot;, price * 10);
    system.mainStation.setMarketQuantity(&quot;slaves&quot;, quantity);
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ups_sun.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name        = &quot;ups_sun&quot;;
this.author      = &quot;eric walch&quot;;
this.copyright   = &quot;2008 eric walch.&quot;;
this.license     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Solar missions of UPS Courier&quot;;

// TODO: move station creation into systemWillPopulate

this.startUp = function ()
{
	this.firstLaunch = true;
    this.upsMarkSystem = worldScripts[&quot;ups_docs&quot;].upsMarkSystem;
    this.upsUnmarkSystem = worldScripts[&quot;ups_docs&quot;].upsUnmarkSystem;
}

this.initSunMission = function (planetName, planetID)
{
    // initialise the sun missions. Called by an ups_doc mission.
    worldScripts[&quot;ups_sun&quot;].ups_sun = &quot;NOT_NOW&quot;;
    worldScripts[&quot;ups_sun&quot;].ups_sunbase = true;
    worldScripts[&quot;ups_sun&quot;].ups_sunvisits = 0;
    worldScripts[&quot;ups_sun&quot;].ups_splanetname = planetName;
    worldScripts[&quot;ups_sun&quot;].ups_splanet = planetID;
}

this.playerEnteredNewGalaxy = function ()
{
    if (this.ups_sun) this.sunReset(); // reset everything in a new galaxy.
}

this.shipLaunchedFromStation = function ()
{
    if (this.ups_sunbase)
    {
        if (this.firstLaunch) {this.setUpShips(); this.firstLaunch = false};
        if (this.ups_blackbox === &quot;YES&quot; &amp;&amp; this.researcher_count &gt; 0)
        {
                this.ups_blackbox = &quot;SEARCHING&quot;;
                this.ups_s2count = 0;
                this.ups_s2award = 0;
                system.addShips(&quot;UPS-black_box&quot;, this.researcher_count, Vector3D(0, 0, 1.1).fromCoordinateSystem(&quot;sps&quot;));
                this.researcher_count = 0; // reset counter
        }
    }
}

this.missionScreenOpportunity = function ()
{
    // this.ups_sunbase is set to &#39;true&#39; by a mission in ups_docs.
    if (player.ship.docked &amp;&amp; this.ups_sunbase)
    {
        this.missionOffers();
    }
}

this.missionOffers = function ()
{
	var sunStatus = this.ups_sun;
    if (player.ship.dockedStation.isMainStation)
    {
        if (sunStatus === &quot;YES&quot;)
        {
            if (system.techLevel &gt; 10)
            {
                this.ups_stationparts = expandDescription(&quot;[ups_stationparts]&quot;);
                missionVariables.ups_stationparts = this.ups_stationparts; // missionVariable is needed in choices.
                this.offering =&quot;UPS_SOLAR1&quot;;
                var message = expandMissionText(&quot;ups_sun_offer&quot;, {ups_splanetname: this.ups_splanetname, ups_stationparts: this.ups_stationparts});
                mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Transport&quot;, message: message, overlay: this._overlay(),
                                    choicesKey: &quot;ups_sun_accepted_yesno&quot;}, this.choiceEvaluation)
            }
        }
        else if (sunStatus === &quot;RESCUEOFFER&quot;)
        {
            if (system.government &gt; 1)
            {
                this.offering = &quot;UPS_SOLAR3&quot;;
                var message = expandMissionText(&quot;ups_sun_offer3&quot;, {ups_splanetname: this.ups_splanetname});
                mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Resque&quot;, message: message, overlay: &quot;solar.png&quot;,
                                    choicesKey: &quot;ups_sun_accepted3_yesno&quot;}, this.choiceEvaluation);
                this.ups_stimerstart = clock.days;
            }
        }
        else if (sunStatus === &quot;EXPLOSION&quot;)
        {
            var key = (!this.ups_s2count) ? &quot;ups_sun_unloading3a&quot; : &quot;ups_sun_unloading3&quot;;
            var message = expandMissionText(key,
                    {ups_splanetname: this.ups_splanetname, ups_s2count: this.ups_s2count, ups_s2award: this.ups_s2award, ups_s2plural: (this.ups_s2count === 1 ? &quot;&quot; : &quot;s&quot;)});
            mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Resque&quot;, message: message, overlay: this._overlay()});
			this.ups_sunvisits++;
			mission.setInstructionsKey(null);
			this.upsUnmarkSystem(this.ups_splanet, this.name);
			player.credits += this.ups_s2award;
			this.sunReset();
            return;
        }
        else if (sunStatus === &quot;RESCUE&quot;)
        {
            var daysPast = clock.days - this.ups_stimerstart;
            if (daysPast &gt; 20)
            {
                var message = expandMissionText(&quot;ups_sun_explosion&quot;, {ups_days_past: daysPast, ups_splanetname: this.ups_splanetname});
                mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Resque&quot;, message: message, overlay: &quot;solar.png&quot;});
                mission.setInstructionsKey(null);
                this.upsUnmarkSystem(this.ups_splanet, this.name);
                this.sunReset();
            }
        }
        return;
    }
    if (player.ship.dockedStation.name === &quot;Sun Research Station Alpha&quot;)
    {
        if (sunStatus === &quot;SMALL_DELIVERY&quot;)
        {
            this.ups_sun = &quot;NOT_NOW&quot;;
            var message = expandMissionText(&quot;ups_sun_unloading&quot;, {ups_stationparts: this.ups_stationparts});
            mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Transport&quot;, message: message, overlay: this._overlay()});
            this.ups_sunvisits++;
            player.credits += 250;
            mission.setInstructionsKey(null);
            delete this.ups_stationparts;
            this.upsUnmarkSystem(this.ups_splanet, this.name);
            worldScripts[&quot;ups_docs&quot;].increaseReputation(3);
            return;
        }
        if (!this.ups_blackbox &amp;&amp; this.researcher_count &gt; 0)
        {
            var message = expandMissionText(&quot;ups_sun_offer2&quot;,{ups_vessels_lost: this.researcher_count});
            mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Retrieval&quot;, message: message,
                                overlay: this._overlay(), choicesKey: &quot;ups_sun_accepted2_yesno&quot;},
                                this.choiceEvaluation);
            this.offering = &quot;UPS_SOLAR_BLACKBOX&quot;;
        }
        if (this.ups_blackbox === &quot;SEARCHING&quot;)
        {
            var key;
            if (!this.ups_s2count)
            {
                key = &quot;ups_sun_unloading2a&quot;;
                delete this.ups_blackbox;
            }
            else
            {
                key = &quot;ups_sun_unloading2&quot;;
                this.ups_blackbox = &quot;FINISHED&quot;;
            }
            var message = expandMissionText(key,{ups_s2count: this.ups_s2count, ups_s2award: this.ups_s2award, ups_s2plural:(this.up_s2count === 1 ? &quot;&quot; : &quot;es&quot;)});
            mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Retrieval&quot;, message: message, overlay: this._overlay()});
            player.credits += this.ups_s2award;
            worldScripts[&quot;ups_docs&quot;].increaseReputation(3);
            mission.setInstructionsKey(null);
            delete this.ups_s2count;
            delete this.ups_s2award;
        }
        if (sunStatus === &quot;RESCUE&quot; &amp;&amp; !this.ups_rescue)
        {
            this.ups_sun = &quot;EXPLOSION&quot;;
            mission.runScreen({screenID: &quot;ups-sun&quot;, title: &quot;Solar Resque&quot;, messageKey: &quot;ups_sun_rescue&quot;, overlay: &quot;solar.png&quot;, music: &quot;siren.ogg&quot;});
            mission.setInstructionsKey(&quot;ups_sun_small4&quot;);
            this.ups_rescue = &quot;YES&quot;;
            this.ups_s2count = 10;
            this.ups_s2award = 1500;
            player.ship.dockedStation.energy = player.ship.dockedStation.maxEnergy * 0.15;
        }
    }
}

this.choiceEvaluation = function (choice)
{
    switch (this.offering)
    {
        case &quot;UPS_SOLAR1&quot;:
        {
            if (choice === &quot;YESSun&quot;)
            {
                this.upsMarkSystem(this.ups_splanet, this.name);
                mission.setInstructions(expandMissionText(&quot;ups_sun_small&quot;,
                        {ups_splanetname: this.ups_splanetname, ups_stationparts: this.ups_stationparts}));
                this.ups_sun = &quot;SMALL_DELIVERY&quot;;
            }
            else
            {
                this.ups_sun = &quot;NOT_NOW&quot;;
                delete this.ups_stationparts;
                worldScripts[&quot;ups_docs&quot;].increaseReputation(-2);
            }
            break;
        }
        case &quot;UPS_SOLAR3&quot;:
        {
            if (choice === &quot;YESSun&quot;)
            {
                this.upsMarkSystem(this.ups_splanet, this.name);
                mission.setInstructions(expandMissionText(&quot;ups_sun_small3&quot;, {ups_splanetname: this.ups_splanetname}));
            }
            this.ups_sun = &quot;RESCUE&quot;; // mission is always active, even when not choosen by player.
            break;
        }
        case &quot;UPS_SOLAR_BLACKBOX&quot;:
        {
            if (choice === &quot;YESSun&quot;)
            {
                this.ups_blackbox = &quot;YES&quot;;
                mission.setInstructions(expandMissionText(&quot;ups_sun_small2&quot;, {ups_splanetname: this.ups_splanetname}));
            }
            else
            {
                this.ups_blackbox = &quot;NO&quot;;
            }
            break;
        }
        default: log(this.name, &quot;Encountered an illegal mission offer: &quot;+this.offering);
    }
    this.offering = null;
}

this.setUpShips = function ()
{
        if (this.ups_splanet === system.ID)
        {
            if (system.countShipsWithRole(&quot;ups_dependance&quot;) === 0 &amp;&amp; !this.ups_rescue)
            {
					if (this.ups_sun === &quot;RESCUE&quot;)
                    {
                        system.addShips(&quot;ups_dependance&quot;, 1, Vector3D(0, 0, 1.5).fromCoordinateSystem(&quot;sps&quot;));
                        this.ups_s2count = 0;
						this.sunTraders(2, &quot;sw&quot;);
                    }
                    else
                    {
                        system.addShips(&quot;ups_dependance&quot;, 1, Vector3D(0, 0, 2.6).fromCoordinateSystem(&quot;sps&quot;));
                        system.addShips(&quot;ups_shuttle&quot;, 8, Vector3D(0, 0, 2.6).fromCoordinateSystem(&quot;sps&quot;));
                        this.researcher_count = 0;
                    }
					this.sunShips(&quot;ups-sun-police&quot;, 2, &quot;sp&quot;);
					this.sunShips(&quot;pirate&quot;, 2, &quot;sw&quot;);
					this.sunShips(&quot;pirate&quot;, 2, &quot;sp&quot;);
					this.sunTraders(2, &quot;sw&quot;);
                    if (worldScripts.transportSchedule)  // has Transports.OXP installed
                    {
                         this.sunShips(&quot;fueltransport&quot;, 2, &quot;sp&quot;);
                    }
					else
                    {
                        this.sunTraders(2, &quot;sp&quot;);
                    }
            }
        }
}

this.sunShips = function (role, count, coordSystem)
{
    // also used by &quot;ups_docs&quot;
    for(var i=0;i&lt;count;i++) system.addShipsToRoute(role, 1, Math.random(), coordSystem);
}

this.sunTraders = function (count, coordSystem)
{
    for(var i=0; i&lt;count; i++)
    {
        var trader = system.addShipsToRoute(&quot;sunskim-trader&quot;, 1, Math.random(), coordSystem)[0];
        trader.switchAI(&quot;route2sunskimUpsAI.plist&quot;);
        trader.primaryRole = &quot;trader&quot;;
        if (coordSystem == &quot;sw&quot;) trader.AIState = &quot;HEAD_FOR_SUN&quot;;
        trader.heatInsulation = (1000 / trader.maxSpeed) + 1;
        if (trader.escorts) for (var j=0; j &lt; trader.escorts.length; j++)
        {
            trader.escorts[j].heatInsulation = trader.heatInsulation;
        }
    }
}

this.shipExitedWitchspace = function ()
{
    if (system.isInterstellarSpace) return;
    if (this.ups_sunbase)
    {
        this.setUpShips();
        if (this.ups_blackbox === &quot;FINISHED&quot;)
        {
            if (this.ups_sunvisits &gt; 3  &amp;&amp; Math.random() &lt; 0.3)
            {
                delete this.ups_blackbox; // restarts mission
            }
        }
        else
        {
            if (this.ups_blackbox === &quot;SEARCHING&quot;) mission.setInstructionsKey(null);
            delete this.ups_blackbox;
            delete this.researcher_count;
        }
        if (this.ups_sun === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.1) this.ups_sun = &quot;NO&quot;;
        if (this.ups_sun === &quot;NO&quot;)
        {
            if (system.techLevel &gt; 10 &amp;&amp; Math.random() &lt; 0.2 &amp;&amp; this._reputation() &gt; 4)
            {
                this.ups_sun = &quot;YES&quot;;
            }
            else if (system.government &gt; 1 &amp;&amp; this.ups_sunvisits &gt; 4 &amp;&amp; Math.random() &lt; 0.1)
            {
                this.ups_sun = &quot;RESCUEOFFER&quot;;
            };
        }
    }
}

this.sunReset = function ()
{
    mission.setInstructionsKey(null);
    var deletions = [&quot;sun&quot;, &quot;sunbase&quot;, &quot;sunvisits&quot;, &quot;blackbox&quot;, &quot;splanet&quot;, &quot;stimerstart&quot;, &quot;rescue&quot;, &quot;splanetname&quot;, &quot;s2award&quot;, &quot;s2count&quot;, &quot;stationparts&quot;];
    for (var i=0; i&lt;deletions.length; i++) delete this[&quot;ups_&quot;+deletions[i]];
}

this._reputation = function ()
{
    return (0 &lt; oolite.compareVersion(&quot;1.77&quot;)) ? player.contractReputation : player.parcelReputation;
}

this._overlay = function() {
    if (player.ship.hudHidden || player.ship.hudAllowsBigGui) {
        return {name:&quot;upsnews-large.png&quot;, height:546};
    } else {
        return {name:&quot;upsnews-small.png&quot;, height:546};
    }
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
