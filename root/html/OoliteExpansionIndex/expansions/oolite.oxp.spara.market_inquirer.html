<html>
    <head>
        <title>Expansion Market Inquirer</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Market Inquirer</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Market Inquirer adds an MFD that shows the markets of the main station and selected stations closest to the player. ASC is needed. When docked, information about distances and markets is available from the interfaces (f4).</td>
                    <td>Market Inquirer adds an MFD that shows the markets of the main station and selected stations closest to the player. ASC is needed. When docked, information about distances and markets is available from the interfaces (f4).</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.spara.market_inquirer</td>
                    <td>oolite.oxp.spara.market_inquirer</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Market Inquirer</td>
                    <td>Market Inquirer</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>spara</td>
                    <td>spara</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.14.1</td>
                    <td>1.14.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Market_Inquirer">http://wiki.alioth.net/index.php/Market_Inquirer</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/0/06/Market_inquirer_1.14.1.oxz">https://wiki.alioth.net/img_auth.php/0/06/Market_inquirer_1.14.1.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873215</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Market%20Inquirer'>http://wiki.alioth.net/index.php/Market%20Inquirer</a></p>
        <h3>market_inquirer_readme_&amp;_license.txt</h3>
        <pre>Market Inquirer OXP ver 1.14.1 (12.10.2020)

Author: spara with additions by phkb

_Overview_

Market Inquirer adds an interface screen (f4) that shows the distances in system and an interface screen that shows the markets (prices and quantities) of the main station and selected stations closest to the player. Stations selected (if present) are

* Sfep stations (as secondary GalCop stations)

Interface screens are always available when docked to the selected stations and if ASC is installed, then at every station.

This oxp also enhances the ASC equipment by adding a free primable equipment Inquirer (prime with shift-n) that shows aforementioned market screen when pressing n and b using MFD. Inquirer MFD costs 1050.

If there are more than six stations to show the markets of, the inquirer uses multiple pages for the information. Pages can be switched by choosing &quot;swap&quot;.

If Navigation MFD is installed, distances are shown in the same unit it uses. Otherwise kilOometes are used.

If you want to add a station to the list of selected stations, you can add one of it&#39;s roles to the this.$inquirerStations list of this oxp or you can add the role &quot;inquirer_station&quot; to the station&#39;s roles.

_Recommended oxps in addition to the aforementioned ones_

* Market Observer. This oxp shows in-flight information from Market Observer, if present.
* Distant Suns by Wildeblood (for sun names)
* Planetary Compass by Thargoid (for planet/moon names)

_Requirements_

* Oolite 1.81

_Installing_

Install the OXP by copying market_inquirer.oxp to your AddOns-folder.

------

This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_MARKET_INQUIRER_MFD.html">Market Inquirer MFD</a></td>
                    <td>yes</td>
                    <td align="right">10500</td>
                    <td align="center">7+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_MARKET_INQUIRER_MFD_REMOVE.html">Remove Market Inquirer MFD</a></td>
                    <td>yes</td>
                    <td align="right">100</td>
                    <td align="center">7+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;market_inquirer&quot;; 

//1.14.1 Added the current station to the station interface when the current station is not registered
//1.14.1 Changed the default from exit to swap in the station interface -fix by phkb-
//1.14 Fixed breakage from updating Nav MFD (phkb)
//1.13.1 Fixed main station undefined bug (apparent when not using smugglers underground oxp)
//1.13 Added ability to select the commodities to be shown on F4 screen. Not to mention quite a few lines of compatiblity fixes to better work with phkb&#39;s other oxps -changes by phkb-
//1.12.1 fixed the dublication issue when the main station is an inquirer station.
//1.12 Kiotas are back in the mix
//1.11 for Oolite 1.81 and Market Observer 3.x
//1.11 enabled the market screen and destinations screen to appear on start up.
//1.10.1 bug fix from mossfoot&#39;s report
//1.10 market observer buy log link
//1.10 mfd equipment
//1.9.1 fixed navi_mfd link in distances interface
//1.9 mission screen replaced with mfd and market hack is removed
//1.8 brought mission screens back and tidied up a bit
//1.7 removed in-flight mission screens and equipment and replaced them with a market hack.
//1.6 rename Navigation buoy to main station.
//1.6 hide the beacon of the station you&#39;re docked
//1.5 added pager to market viewer
//1.5 added sirf to inquirer stations
//1.5 limit station service to inquirerStations
//1.5 distances interface
//1.4 added more stations and inquirer_station role to the inquirer.
//1.4 moved station definitions to startUp.

this._menuColor = &quot;yellowColor&quot;;
this._itemColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._maxslots = 17; // maximum number of commodity viewing slots

this.startUp = function() {
	//stations noted by market inquirer. any role of the station will do.
	this.$inquirerStations = [&quot;sfep_station&quot;, &quot;wildShips_kiota&quot;, &quot;inquirer_station&quot;];
	//this.$inquirerStations = [&quot;inquirer_station&quot;, &quot;sfep_station&quot;, &quot;wildShips_kiota&quot;, &quot;sothis&quot;, &quot;constore&quot;, &quot;pagroove_superhub&quot;, &quot;casinoship&quot;, &quot;rescue_station&quot;, &quot;GRS-Station&quot;, &quot;SIRF-YARD&quot;];
	this.$commodity = 0;
	if (worldScripts[&quot;market_observer3&quot;])
		this.$marketObserver = true;
	else this.$marketObserver = false;
}

this.startUpComplete = function() {
	this.$commodities = this.$gatherCommodities();
	this.shipDockedWithStation(player.ship.dockedStation);
	if (missionVariables.MarketInquirer_SelectedCommodities) this._selected = JSON.parse(missionVariables.MarketInquirer_SelectedCommodities);
	if (!this._selected) {
		// default to core commodities
		this._selected = [&quot;food&quot;, &quot;textiles&quot;, &quot;radioactives&quot;, &quot;slaves&quot;, &quot;liquor_wines&quot;, &quot;luxuries&quot;, &quot;narcotics&quot;, &quot;computers&quot;, &quot;machinery&quot;, &quot;alloys&quot;, &quot;firearms&quot;, &quot;furs&quot;, &quot;minerals&quot;, &quot;gold&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;, &quot;alien_items&quot;];
		// remove anything that doesn&#39;t exist anymore (eg if an OXP has removed this commodity altogether)
		for (var i = this._selected.length - 1; i &gt;= 0; i--) {
			if (!system.mainStation.market[this._selected[i]]) this._selected.splice(i, 1);
		}
	}
}

this.playerWillSaveGame = function() {
	missionVariables.MarketInquirer_SelectedCommodities = JSON.stringify(this._selected);
}

//make a list of commodities
this.$gatherCommodities = function() {
	var tempCommodities = new Array();
	for (var i in system.mainStation.market) {
		tempCommodities.push([i, system.mainStation.market[i].sort_order]);
	}
	//first order by name
	tempCommodities.sort();
	//then order by sort_order
	tempCommodities.sort(function(a, b) {return a[1] - b[1]});
	var commodities = new Array();
	for (var i = 0; i &lt; tempCommodities.length; i++)
		commodities.push(tempCommodities[i][0]);
	return commodities;
}

this.$changeCommodity = function(action) {
	if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_COMPASS&quot;) === &quot;EQUIPMENT_OK&quot;) {
		this.$commodity = this.$commodity + action;
		if (this.$commodity &lt; 0)
			this.$commodity = this.$commodities.length - 1;
		else if (this.$commodity &gt; this.$commodities.length - 1)
			this.$commodity = 0;
		this.$commodityPrices();
	}
	else player.consoleMessage(&quot;Inquirer malfunction. ASC is not responding.&quot;);
}

this.shipLaunchedFromStation = this.shipExitedWitchspace = function() {
	this.$commodityPrices();
}

this.$commodityPrices = function() {
	if (player.ship.equipmentStatus(&quot;EQ_MARKET_INQUIRER_MFD&quot;) !== &quot;EQUIPMENT_OK&quot;) {
		player.ship.setMultiFunctionText(&quot;inquirer_mfd&quot;, null);
		return;
	}
	if (!system.mainStation)
		var message = &quot;No market data available.&quot;;
	else {
		var commodity = this.$commodities[this.$commodity];
		var hairSpace = String.fromCharCode(31);
		var noUnits = &quot;--&quot;;
		var width = global.defaultFont.measureString(666);
		while (global.defaultFont.measureString(&quot; &quot; + noUnits) &lt; width)
			noUnits = &quot; &quot; + noUnits;
		while (global.defaultFont.measureString(hairSpace + noUnits) &lt; width)
			noUnits = hairSpace + noUnits;
		var stations = system.filteredEntities(this, this.$stations, player.ship);
		var price = formatCredits(system.mainStation.market[commodity].price);
		var quantity = system.mainStation.market[commodity].quantity;
		if (quantity === 0) quantity = noUnits;
		else quantity = formatUnits(quantity);
        var lgl = &quot;&quot;;
		if (worldScripts.Smugglers_Illegal) {
			if (system.mainStation.market[commodity].legality_import != 0) lgl = &quot; (Imp)&quot;;
			if (system.mainStation.market[commodity].legality_export != 0) lgl = &quot; (Exp)&quot;;
		}
		var statBlock = price + &quot; /&quot; + quantity + &quot; Main Station&quot; + lgl + &quot;\n&quot;;
		for (var i = 0; i &lt; stations.length; i++) {
			var name = stations[i].displayName;
			price = formatCredits(stations[i].market[commodity].price);
			quantity = stations[i].market[commodity].quantity;
			if (quantity === 0) quantity = noUnits;
			else quantity = formatUnits(quantity);
			lgl = &quot;&quot;;
			if (stations[i].market[commodity].legality_import != 0) lgl = &quot; (Imp)&quot;;
			if (stations[i].market[commodity].legality_export != 0) lgl = &quot; (Exp)&quot;;
			statBlock = statBlock + truncate(price + &quot; /&quot; + quantity + &quot; &quot; + name + lgl) + &quot;\n&quot;;
		}

		var message = expandDescription(&quot;[commodity-name &quot; + commodity +&quot;]&quot;);
			
		if (manifest[commodity] &gt; 0)
			message += &quot; (&quot; + manifest[commodity] + &quot;)&quot;;
		if (this.$marketObserver &amp;&amp; worldScripts[&quot;market_observer3&quot;].$priceData[commodity]) {
			var observer = worldScripts[&quot;market_observer3&quot;];
			var referencePrice = &quot;Avg: &quot; + global.formatCredits(observer.$priceData[commodity].average/10, true, false);
			while (global.defaultFont.measureString(message + &quot; &quot; + referencePrice) &lt; 14.3) {
				referencePrice = &quot; &quot; + referencePrice;
			}
			var hairSpace = String.fromCharCode(31);
			while (global.defaultFont.measureString(message + hairSpace + referencePrice) &lt; 14.3) {
				referencePrice = hairSpace + referencePrice;
			}
			message += referencePrice;
			var buyLog = observer.$buyLog;
			if (buyLog[this.$commodities[this.$commodity]]) {
				//add buy log to the second line
				var logLine = &quot;(&quot;;
				for (var i = 0; i &lt; buyLog[commodity].length; i++) {
					var logEvent = buyLog[commodity][i][0] + &quot; x &quot; +  global.formatCredits(buyLog[commodity][i][1]/10, true, false);
					if (global.defaultFont.measureString(logLine + logEvent + &quot;...)&quot;) &lt; 14.5) 
						logLine += logEvent + &quot;, &quot;;
					else break;
				}
				message += &quot;\n&quot; + logLine;
				message = message.slice(0, -2);
				//too many log events to show?
				if (buyLog[commodity].length &gt; i)
					message += &quot;...&quot;; 
				message += &quot;)&quot;;
			}
			else message += &quot;\n&quot;;
		}
		message += &quot;\n&quot;;
		message += statBlock;
	}
	player.ship.setMultiFunctionText(&quot;inquirer_mfd&quot;, message);
	//helper function to truncate lines
	function truncate(line) {
		var lastChar = &quot;&quot;;
		while (global.defaultFont.measureString(line) &gt; 14) {
			lastChar = line.charAt(line.length - 1);
			line = line.slice(0, -1);
		}
		if (lastChar === &quot;&quot;) return line;
		if (line.charAt(line.length - 1) === &quot; &quot; || lastChar === &quot; &quot;)
			return line;
		if (line.charAt(line.length - 2) === &quot; &quot;) 
			return line.slice(0, -1);
		line = line + &quot;.&quot;;
		while (global.defaultFont.measureString(line) &gt; 14) {
			line = line.slice(0, -2);
			line = line + &quot;.&quot;;
		}
		return line;
	}
	//helper function to format credits
	function formatCredits(credits) {
		if (credits &lt; 99.5) 
			return &quot;    &quot; + global.formatCredits(credits/10, true, false);
		else if (credits &lt; 999.5)
			return &quot;  &quot; + global.formatCredits(credits/10, true, false);
		else return global.formatCredits(credits/10, true, false);
	};
	//helper function to format units
	function formatUnits(units) {
		if (units &lt; 10) return &quot;    &quot; + units;
		else if (units &lt; 100 ) return &quot;  &quot; + units;
		else return units;
	};
}

//Add f4 interfaces when docked
this.shipDockedWithStation = function(station) {
	if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_COMPASS&quot;) === &quot;EQUIPMENT_OK&quot; || this.$stations(station) || station.isMainStation)
		this.$marketInquirerInterface();
};

//remove interfaces
this.$removeInterfaces = this.shipWillLaunchFromStation = function() {
	player.ship.dockedStation.setInterface(&quot;inquirer_market&quot;,null);
	player.ship.dockedStation.setInterface(&quot;inquirer_distances&quot;,null);
}

//Add interfaces
this.$marketInquirerInterface = function() {
	player.ship.dockedStation.setInterface(&quot;inquirer_market&quot;,{
		title: &quot;Commodity markets&quot;,
		category: &quot;Commerce&quot;,
		summary: &quot;Show commodity markets of selected stations in system.&quot;,
		callback: this.$showMarkets.bind(this)
	});
	player.ship.dockedStation.setInterface(&quot;inquirer_distances&quot;,{
		title: &quot;In-system distances&quot;,
		category: &quot;Informational&quot;,
		summary: &quot;Show distances to the star, planets, moons and beacons in system.&quot;,
		callback: this.$showDistances.bind(this)
	});	
};

//function to filter suitable stations
this.$stations = function(entity) {	
	if (entity.isStation &amp;&amp; !entity.isMainStation) {
		var k;
		for (k = 0; k &lt; this.$inquirerStations.length; k++) {
			if (entity.hasRole(this.$inquirerStations[k]))
				return true;
		}	
	}
	return false;
};

//build and show markets screen
this.$showMarkets = function(page) {
	
	var text = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var stations = new Array();
	//No asc
	if (player.ship.docked &amp;&amp; (player.ship.equipmentStatus(&quot;EQ_ADVANCED_COMPASS&quot;) !== &quot;EQUIPMENT_OK&quot; &amp;&amp; !player.ship.dockedStation.isMainStation &amp;&amp; !this.$stations(player.ship.dockedStation))) {
		text = &quot;No market data available.&quot;;
		this.$removeInterfaces();
	}
	//sanity check
	else if (system.isInterstellarSpace || !system.sun || system.sun.isGoingNova || system.sun.hasGoneNova || !system.mainStation) {
		text = &quot;No market data available.&quot;;
	}
	//let&#39;s rock
	else {
		if (typeof page === &#39;undefined&#39; || page === &#39;inquirer_market&#39;) page = 0;
		var commodities  = this.$gatherCommodities();
		var i,j, quantity;
		// remove unselected commodities
		for (i = commodities.length - 1; i &gt;= 0; i--) {
			if (this._selected.indexOf(commodities[i]) === -1) commodities.splice(i, 1);
		}
		//description column width
		var descriptionWidth = Math.ceil(global.defaultFont.measureString(&quot;Liquor/Wines:&quot;));
		//width for market data columns
		var dataWidth = 31 - descriptionWidth;
		//minimum width for market data column
		var minColWidth = global.defaultFont.measureString(&quot; &quot;+formatCredits(1020)+&quot; / 64 &quot;);
		//maximum number of data columns per page
		var maxCols = Math.floor(dataWidth / minColWidth);
		//filtered stations
		stations = system.filteredEntities(this, this.$stations, player.ship);
		// add the current, possibly unregistered, station to the start of the list
		if (!this.$stations(player.ship.dockedStation) &amp;&amp; !player.ship.dockedStation.isMainStation) {
			stations.unshift(player.ship.dockedStation);
		}
		// add main station to the start of the list
		stations.unshift(system.mainStation);
		//handle swapping back to start
		if (page &gt; stations.length / maxCols) page = 0;
		var sfepStations = new Array();
		//page handling
		var startInd = page * maxCols;
		//show full pages
		if (startInd &gt; 0 &amp;&amp; stations.length &gt; maxCols &amp;&amp; startInd + maxCols &gt; stations.length - 1)
			startInd = stations.length - maxCols;
		//select stations to show
		for (i = startInd; i &lt; startInd + maxCols; i++) {
			sfepStations.push(stations[i]);
			if (i &gt; stations.length - 2) break;
		}
		//calculate actual data column width
		if (sfepStations.length &gt;= maxCols) var colWidth = dataWidth / maxCols;
		else var colWidth = (dataWidth) / (sfepStations.length);
		//array for formatted (truncated and centered) stations names
		var statNames = new Array();
		//add the station names to the array
		for (i = 0; i &lt; sfepStations.length; i++) {
			if (sfepStations[i].isMainStation)
				statNames.push(format(&quot;Main Station&quot;, colWidth));
			else statNames.push(format(sfepStations[i].displayName, colWidth));
		}
		//tabulate over the description column
		while (global.defaultFont.measureString(text) &lt; descriptionWidth - 0.1)
			text = text + &quot; &quot;;
		while (global.defaultFont.measureString(text) &lt; descriptionWidth)
			text = text + hairSpace;

		//add and tabulate station names
		for (i = 0; i &lt; statNames.length; i++) {
			text = text + statNames[i];
			while (global.defaultFont.measureString(text) &lt; (descriptionWidth) + colWidth * (i + 1) - 0.1)
				text = text + &quot; &quot;;
			while (global.defaultFont.measureString(text) &lt; (descriptionWidth) + colWidth * (i + 1))
				text = text + hairSpace;
			if (i === maxCols - 1) break;
		}
		text += &quot;\n&quot;;
		// we can add an extra space when there will only be 2 menu options
		if (stations.length &lt;= maxCols || stations.length === 0) text += &quot;\n&quot;;
		//then the prices
		for (j = 0; j &lt; commodities.length; j++) {
			var line = &quot;&quot;;
			//add commodity name
			line = expandDescription(&quot;[commodity-name &quot; + commodities[j]+&quot;]&quot;)+&quot;: &quot;;
			//tabulate
			while (global.defaultFont.measureString(line) &lt; descriptionWidth - 0.1)
				line = line + &quot; &quot;;
			while (global.defaultFont.measureString(line) &lt; descriptionWidth)
				line = line + hairSpace;
			//add prices/quantities
			for (i = 0; i &lt; sfepStations.length; i++) {
				quantity = sfepStations[i].market[commodities[j]].quantity;
				if (quantity === 0) {
					quantity = &quot; --&quot;;
					var width = global.defaultFont.measureString(&quot;00&quot;);
					while (global.defaultFont.measureString(quantity) &lt; width)
						quantity = hairSpace + quantity;
				}
				else quantity = formatUnits(quantity);
				var price = sfepStations[i].market[commodities[j]].price;
				line = line + format(formatCredits(price)+&quot; / &quot;+quantity, colWidth);
				while (global.defaultFont.measureString(line) &lt; descriptionWidth + colWidth * (i + 1) - 0.1)
					line = line + &quot; &quot;;
				while (global.defaultFont.measureString(line) &lt; descriptionWidth + colWidth * (i + 1))
					line = line + hairSpace;
				if (i === maxCols - 1) break;
			}
			text = text + line + &quot;\n&quot;;
		}
	}
	//select the correct background image
	var bgImage = &quot;sfep_flight.png&quot;;
	if (player.ship.docked) bgImage = &quot;sfep_docked.png&quot;;
	//select correct options
	var options = {
		&quot;0_SELECT&quot; : &quot;Select commodities to view&quot;,
		&quot;1_NEXT&quot; : &quot;Swap&quot;,
		&quot;2_QUIT&quot; : &quot;Exit&quot;
	};
	var def = &quot;1_NEXT&quot;;
	if (stations.length &lt;= maxCols || stations.length === 0) {
		options = {
			&quot;0_SELECT&quot; : &quot;Select commodities to view&quot;,
			&quot;2_QUIT&quot; : &quot;Exit&quot;
		};
		def = &quot;2_QUIT&quot;; 
	}
	//finally, the mission screen
	mission.runScreen({
		title: &quot;Commodity Markets of &quot; + system.name,
		screenID:&quot;marketinquirer-markets&quot;,
		message: text,
		choices: options,
		background: bgImage,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		initialChoicesKey: def
	},
	function (choice) {
		if (choice === &quot;1_NEXT&quot;) worldScripts.market_inquirer.$showMarkets(page + 1);
		if (choice === &quot;0_SELECT&quot;) worldScripts.market_inquirer.$selectCommoditiesToView();
	});
	//helper function to format credits
	function formatCredits(credits) {
		if (credits &lt; 99.5) 
			return &quot;    &quot; + global.formatCredits(credits/10, true, false);
		else if (credits &lt; 999.5)
			return &quot;  &quot; + global.formatCredits(credits/10, true, false);
		else return global.formatCredits(credits/10, true, false);
	};
	//helper function to format units
	function formatUnits(units) {
		if (units &lt; 10) return &quot;  &quot; + units;
		else return units;
	};
	//helper function to truncate and center station names
	function format(string, width) {
		//if too wide, truncate
		if (global.defaultFont.measureString(string) &gt;= width) {
			var lastChar = &quot;&quot;;
			while (global.defaultFont.measureString(string) &gt; width - 1) {
				lastChar = string.charAt(string.length - 1);
				string = string.slice(0, -1);
			}
			if (string.charAt(string.length - 1) === &quot; &quot;)
				string = string.slice(0, -1);
			else if (lastChar !== &quot; &quot;)
				string = string + &quot;.&quot;;
		}
		var stringWidth = global.defaultFont.measureString(string);
		//if too narrow, center 
		if (stringWidth &lt; width) {
			var fill = (width - stringWidth) / 2;
			var tab = &quot; &quot;;
			while (global.defaultFont.measureString(tab) &lt; fill)
				tab = tab + &quot; &quot;;
			string = tab + string;
		};
		return string;
	};
};

this.$selectCommoditiesToView = function() {
	
	var list = this.$gatherCommodities();

	var text = &quot;Select commodities to view (&quot; + this._selected.length + &quot; of &quot; + this._maxslots + &quot; selected):\n\n&quot;;
	var itemcount = 0;
	var curChoices = {};
	var pagesize = 15;
	if (this.$isBigGuiActive() === true) pagesize = 21;

	if (typeof this._selpage === &quot;undefined&quot;) this._selpage = 0;
	if (list.length &gt; 0) {
		var maxpage = Math.ceil(list.length / pagesize);
		if (maxpage &lt; (this._selpage + 1)) this._selpage -= 1;
		var end = ((this._selpage * pagesize) + pagesize);
		if (end &gt; list.length) end = list.length;
		// note: then station equipmentPriceFactor has been removed to prevent exploitation of equipment sales at different stations (galcop =&gt; rock hermit)
		for (var i = (this._selpage * pagesize); i &lt; end; i++) {
			curChoices[&quot;01_CMDTY-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i]] =
				{text:this.$padTextRight((this._selected.indexOf(list[i]) &gt;= 0 ? &quot;X&quot; : &quot; &quot;), 3) +
					displayNameForCommodity(list[i]),
					alignment:&quot;LEFT&quot;, color:this._menuColor};
			itemcount += 1;
		}
		for (var i = 0; i &lt; ((pagesize + 1) - itemcount); i++) {
			curChoices[&quot;90_SPACER_&quot; + i] = &quot;&quot;;
		}
	} else {
		text += &quot;No commodities?&quot;;
	}

	if (maxpage &gt; 1 &amp;&amp; this._selpage &lt; (maxpage - 1)) {
		curChoices[&quot;95_NEXT&quot;] = {text:&quot;Next page&quot;, color:this._itemColor};
	} else {
		curChoices[&quot;95_NEXT&quot;] = {text:&quot;Next page&quot;, color:this._disabledColor, unselectable:true};
	}
	if (this._selpage &gt; 0) {
		curChoices[&quot;96_PREV&quot;] = {text:&quot;Previous page&quot;, color:this._itemColor};
	} else {
		curChoices[&quot;96_PREV&quot;] = {text:&quot;Previous page&quot;, color:this._disabledColor, unselectable:true};
	}
	curChoices[&quot;99_EXIT&quot;] = {text:&quot;Return&quot;, color:this._itemColor};

	var def = &quot;99_EXIT&quot;;
	if (this._lastChoice &amp;&amp; this._lastChoice !== &quot;&quot;) def = this._lastChoice;

	//select the correct background image
	var bgImage = &quot;sfep_flight.png&quot;;
	if (player.ship.docked) bgImage = &quot;sfep_docked.png&quot;;

	var opts = {
		screenID: &quot;marketinquirer-markets&quot;,
		title: &quot;Select Commodities&quot;,
		allowInterrupt: false,
		choices: curChoices,
		background: bgImage,
		initialChoicesKey: def,
		message: text
	};
	mission.runScreen(opts, this.$chooseCommodity, this);
}

this.$chooseCommodity = function(choice) {
	if (choice == null) return;

	if (choice.indexOf(&quot;01_CMDTY&quot;) &gt;= 0) {
		var sel = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		if (this._selected.indexOf(sel) &gt;= 0) {
			this._selected.splice(this._selected.indexOf(sel), 1);
		} else {
			if (this._selected.length &lt; this._maxslots) {
				this._selected.push(sel);
			} else {
				player.consoleMessage(&quot;Unable to add commodity - too many already selected&quot;, 5);
			}
		}
		this._lastChoice = choice;
	}
	if (choice === &quot;95_NEXT&quot;) {this._selpage += 1; this._lastChoice = choice;}
	if (choice === &quot;96_PREV&quot;) {this._selpage -= 1; this._lastChoice = choice;}

	if (choice !== &quot;99_EXIT&quot;) {
		this.$selectCommoditiesToView();
		return;
	}
	this.$showMarkets();
}

//build and show distances screen
this.$showDistances = function() {
	var text = &quot;&quot;;
	//No asc
	if (player.ship.docked &amp;&amp; player.ship.equipmentStatus(&quot;EQ_ADVANCED_COMPASS&quot;) !== &quot;EQUIPMENT_OK&quot; &amp;&amp; !player.ship.dockedStation.isMainStation &amp;&amp; !this.$stations(player.ship.dockedStation)) {
		text = &quot;No distance data available.&quot;;
		this.$removeInterfaces();
	}
	//sanity check;
	else if (system.isInterstellarSpace) {
		text = &quot;No distance data available.&quot;;
	}
	else {
		//define distance unit
		var unitBase = 1000;
		var unit = &quot;km&quot;;
		var rnd = 3;
		//use the same unit as Updating TSC
		if (worldScripts.navi_mfd) {
			var ver = worldScripts.navi_mfd.version.split(&quot;.&quot;);
			if (parseInt(ver[0]) &gt; 1 || (ver[0] === &quot;1&quot; &amp;&amp; parseInt(ver[1]) &gt;= 9)) {
				unitBase = worldScripts.navi_mfd.$ostronomicalUnits[worldScripts.navi_mfd.$unitSetting];
				unit = worldScripts.navi_mfd.$distUnits[worldScripts.navi_mfd.$unitSetting];
				rnd = worldScripts.navi_mfd.$rounding[worldScripts.navi_mfd.$unitSetting]
			} else {
				unitBase = worldScripts.navi_mfd.$ostronomicalUnit;
				unit = worldScripts.navi_mfd.$distUnit;
			}
		}
		var i;
		var lines = new Array();
		//star
		if (system.sun) {
			var name = &quot;Sun&quot;;
			if (system.info.sun_name) name = system.info.sun_name;
			lines.push([&quot;Star:&quot;,&quot;&quot;]);
			lines.push([&quot;* &quot; +name, dist(system.sun, rnd)]);
			lines.push([&quot; &quot;,&quot;&quot;]);
		};
		//planets
		var planets = system.filteredEntities(this, planets, player.ship);
		if (planets.length !== 0) {
			lines.push([&quot;Planets:&quot;,&quot;&quot;]);
			for (i = 0; i &lt; planets.length; i++) {
				if (planets[i].displayName)
					lines.push([&quot;* &quot; + planets[i].displayName.replace(&quot; (Planet)&quot;,&quot;&quot;),dist(planets[i], rnd)]);
				else lines.push([&quot;* Planet &quot; + (i+1),dist(planets[i], rnd)]);
			}
			lines.push([&quot; &quot;,&quot;&quot;]);
		};
		//moons
		var moons = system.filteredEntities(this, moons, player.ship);
		if (moons.length !== 0) {
			lines.push([&quot;Moons:&quot;,&quot;&quot;]);
			for (i = 0; i &lt; moons.length; i++) {
				if (moons[i].displayName)
					lines.push([&quot;* &quot; + moons[i].displayName.replace(&quot; (Moon)&quot;,&quot;&quot;),dist(moons[i], rnd)]);
				else lines.push([&quot;* Moon &quot; + (i+1),dist(moons[i], rnd)]);
			}
			lines.push([&quot; &quot;,&quot;&quot;]);
		};
		//beacons
		var beacons = system.filteredEntities(this, beacons, player.ship);
		if (beacons.length !== 0) {
			lines.push([&quot;Beacons:&quot;,&quot;&quot;]);
			for (i = 0; i &lt; beacons.length; i++) {
				if (beacons[i].displayName) {
					if (!player.ship.docked || player.ship.position.distanceTo(beacons[i]) &gt; 10E4) {
						if (beacons[i].displayName === &quot;Navigation Buoy&quot; &amp;&amp; system.mainStation.position.distanceTo(beacons[i]) &lt;= 10E4)
							lines.push([&quot;* &quot; + &quot;Main Station Buoy&quot;, dist(beacons[i], rnd)]);
						else
							lines.push([&quot;* &quot; + beacons[i].displayName, dist(beacons[i], rnd)]);
					}
				}
				else lines.push([&quot;* Beacon &quot; + (i+1)+&quot;: &quot;, dist(beacons[i], rnd)]);
			}
		}
		//build lines for mission screen
		var column1 = lines;
		var column2 = new Array();
		if (column1.length &gt; 19)
			column2 = column1.splice(19, column1.length - 19);
		for (i = 0; i &lt; column1.length; i++) {
			if (column2.length &gt; i)
				text = text + formatStrToCol(column1[i][0], column1[i][1], 15.5) + formatStrToCol(column2[i][0], column2[i][1], 15.5) + &quot;\n&quot;;
			else
			text = text + formatStrToCol(column1[i][0], column1[i][1], 31) + &quot;\n&quot;;
		}
	}
	//show mission screen
	var bgImage = &quot;sfep_flight.png&quot;;
	if (player.ship.docked) bgImage = &quot;sfep_docked.png&quot;;
	var options = {
			&quot;1_QUIT&quot; : &quot;Exit&quot;
	}
	mission.runScreen({
		title: &quot;Distances of &quot; + system.name,
		screenID:&quot;marketinquirer-distances&quot;,
		message: text,
		choices: options,
		background: bgImage,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	});

	//helper functions
	function planets(entity) {return (entity.isPlanet &amp;&amp; entity.hasAtmosphere)};
	function moons(entity) {return (entity.isPlanet &amp;&amp; !entity.hasAtmosphere)};
	function beacons(entity) {return entity.isBeacon};
	function dist(entity, rounding) {
		var distInKm = (player.ship.position.distanceTo(entity) - entity.collisionRadius)/unitBase;
		return (distInKm.toFixed(rounding) + &quot; &quot; + unit);
	};
	//format columns
	function formatStrToCol(name, distStr, colWidth) {
		//if too wide, truncate
		var punct = &quot;&quot;;
		if (distStr !== &quot;&quot;) punct = &quot;: &quot;;
		if (global.defaultFont.measureString(name+punct+distStr) &gt; colWidth) {
			var lastChar = &quot;&quot;;
			while (global.defaultFont.measureString(name+punct+distStr) &gt; colWidth) {
				lastChar = name.charAt(name.length - 1);
				name = name.slice(0, -1);
			}
			if (name.charAt(name.length - 1) === &quot; &quot;)
				name = name.slice(0, -1);
			else if (lastChar !== &quot; &quot;)
				name = name + &quot;.&quot;;
		}
		//if too narrow, add spaces to end 
		while (global.defaultFont.measureString(name+punct+distStr) &lt; colWidth) {
			distStr = distStr + &quot; &quot;;
		};
		if (distStr.charAt(distStr.length - 1) === &quot; &quot;)
			distStr = distStr.slice(0, -1);
		return name + punct + distStr;
	};	
}

this.playerBoughtEquipment = function(equipment) {
	if (equipment === &quot;EQ_MARKET_INQUIRER_MFD_REMOVE&quot;) {
		player.ship.removeEquipment(&quot;EQ_MARKET_INQUIRER_MFD&quot;);
		player.ship.removeEquipment(&quot;EQ_MARKET_INQUIRER_MFD_REMOVE&quot;);
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function(currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;…&quot;;
	var currentLength = defaultFont.measureString(currentText);
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1)	{
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp === ellip) break;
		} while (defaultFont.measureString(tmp) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch === false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function(currentText, desiredLength) {
	return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; 	// until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/market_inquirer.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;market_inquirer_equipment_script&quot;; 
this.author      = &quot;spara&quot;; 
this.copyright   = &quot;2013 - 2014 Mika Spara&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;; 
this.description = &quot;equipment activation script&quot;; 
this.version     = &quot;1.10&quot;;

//equipment activation n
this.activated = function() {
	worldScripts.market_inquirer.$changeCommodity(1);
};

//equipment activation b
this.mode = function() {
	worldScripts.market_inquirer.$changeCommodity(-1);
};

this.allowAwardEquipment = function() {
	if (player.ship.dockedStation.isMainStation || worldScripts.market_inquirer.$stations(player.ship.dockedStation))
		return true;
	return false;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
