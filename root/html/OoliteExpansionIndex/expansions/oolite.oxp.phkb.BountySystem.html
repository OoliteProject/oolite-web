<html>
    <head>
        <title>Expansion Bounty System</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Bounty System</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">5 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">4 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>(WIP) This OXP seeks to add depth and meaning to the bounty system by making crimes persistent (removing the old mechanic of having bounties slowly disappear over time). Bounties might persist, but they are not always visible in every location. A Warrant Scanner can be used by the player or NPC&#39;s to uncover bounties registered in other systems.</td>
                    <td>(WIP) This OXP seeks to add depth and meaning to the bounty system by making crimes persistent (removing the old mechanic of having bounties slowly disappear over time). Bounties might persist, but they are not always visible in every location. A Warrant Scanner can be used by the player or NPC&#39;s to uncover bounties registered in other systems.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.BountySystem</td>
                    <td>oolite.oxp.phkb.BountySystem</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Bounty System</td>
                    <td>Bounty System</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.13</td>
                    <td>0.13</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Bounty_System">http://wiki.alioth.net/index.php/Bounty_System</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/5/5d/BountySystem.oxz">https://wiki.alioth.net/img_auth.php/5/5d/BountySystem.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1627914066</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Bounty%20System'>http://wiki.alioth.net/index.php/Bounty%20System</a></p>
        <h3>readme.txt</h3>
        <pre>Bounty System
By Nick Rogers

Special thanks to Wildeblood for all his suggestions and input. Hopefully this OXP will restore something of his lost Criminal Record OXP! And yes, I have backups!
Thanks also to rustem, Cody, smivs, Day, Imaginos, and UK_Eliter for all their encouragement and input.

Overview
========
The bounty system in the core game of Oolite is somewhat primitive, a product of its 8-bit roots. If you commit a crime, regardless of the seriousness of that crime, your bounty is halved with each witchspace jump. So you can shoot down a flotilla of police ships in one system, but 8 to 10 jumps later you&#39;re clean again. Also, if you want to quickly erase your bounty you can purchase and use an escape pod, or do a galactic jump.

This OXP aims to add depth and meaning to the bounty system by making your crimes persistent. So, if you commit a crime in system A, and then come back to system A later, your bounty will be remembered. It will not degrade over time, nor will it vanish by using an escape pod or a galactic jump, or when buying a new ship.

Also, different crimes have a varying degree of severity, meaning there is a distinction between smuggling illegal goods to murdering a pilot by destroying their ship. The following table describes the different severities and levels of applicability:

Level                Example of crime               Applicability
---------------------------------------------------------------------------
Severity 1 (Minor)   Smuggling illegal goods        local systems only (within 5ly)
Severity 2 (Serious) Shooting main station          Across the current chart
Severity 3 (Major)   Destroying another ship        Across all charts

Local systems only: This means the crime only applies to systems within 5LY of the system where the crime was committed. So if you are caught smuggling goods in system A, then jump to system B (which is less than 5ly from system A), your crime is still applicable. Jump to system C, more than 5 LY from system A, then your crime is no longer applicable.

Across the current chart: This means the crime will apply to all systems in the current chart. So if you shoot the main station in system A, your crime is applicable in system B and system C and all systems in the current chart. But if you use a galactic jump and go to the next chart, those crimes will not be applicable.

Across all charts: This means the crime will apply to all systems in all charts. No matter where you go, your crime will be applicable and you will potentially be labelled a &quot;Fugitive&quot;.

The F7 System Data screen can help you in assessing your potential bounty in a given system. When you select a system on the F6 screen and then visit the F7 System Data screen the computer will scan your warrant list and determine how the system will likely view your presence. If you have committed crimes in that system one of the following things will be displayed:

	This system considers you [a criminal/an] offender: This text will be displayed if your overall bounty in the system is less than 50cr.
	This system considers you a [criminal] fugitive: This text will be displayed if your overall bounty in the system in greater than or equal to 50cr.

The &quot;criminal&quot; part of the text will be added if you committed crimes in that system in particular. If the &quot;criminal&quot; element is not present you haven&#39;t committed crimes in that system, but your crimes in other systems have become known and you will be considered an offender or fugitive if you visit that system.

GalCop Security Office
======================
All GalCop-aligned stations have either a security office (when at the main station), or a security kiosk (when at other GalCop-aligned stations), in which you can view any outstanding bounties you might have picked up in the current galactic sector, and when/where those crimes were committed. You can also view any outstanding you might have in other sectors. Through this interface you can view the details of each bounty, the crimes that were committed to generate the bounty and, if available, pay the fine to clear your record. The available of the payment option is dependent on the amount of time since the crime was committed, and the location the crime was committed. See Paying for fines below.

Warrant Scanner
===============
While your crimes might be applicable in multiple systems, that doesn&#39;t necessarily mean your crimes will be *visible* in all systems automatically. If you shoot at the main station in system A, and jump to system B, your status will initially be &quot;Clean&quot;. This means that this system currently doesn&#39;t have a record of your crimes.

However, all police and most bounty hunters can be equipped with a &quot;Warrant Scanner&quot;, a device that will scan your ship and perform a GalCop Criminal Database lookup based on the specifications of your ship and pilot registration. Should any criminal records be found they will become visible in this system. All GalCop police ships have this device installed and they will actively try to use it on all ships visible to them. Once your crimes have been revealed to system authorities, you will be wanted in that system whenever you visit.

You can purchase and install the Warrant Scanner yourself, and do the same thing on other ships. You must be within 15km of the target (police ships can scan from 20km), and when activated you must stay within that distance for 10 seconds (8 seconds for police) and keep the target locked for the scanner to work. The scanner won&#39;t work when your cloaking device is engaged, or if you&#39;re travelling at injector or torus speeds. If the target engages a cloak the scanning will stop.

The output of the scanner functions in two ways: MFD mode (which will use a spare MFD slot to display scanning messages), or non-MFD mode (which will output scanning messages to the message log). To switch between output modes, prime the equipment and press the &quot;b&quot; (mode) key. If MFD output mode is selected, but there are no MFD slots available when a scan starts, the Warrant Scanner will automatically switch to Non-MFD output mode.

Pilots will consider use of this scanner as hostile, and so their response may be hostile as well, particularly when not in the main station aegis.

Once you start a scan on a target, if you are forced to target another ship before the scan is completed, when you re-target the first ship the scan will automatically restart.

Further controls for the Warrant Scanner can be found in Library Config. The Warrant Scanner can be set to automatically scan offender and fugitive targets, or all targets. When the scanner is in automatic scan mode, scans will only start when the target is within 15km range. In order for the scan to detect offender or fugitive status, the Scanner Targeting Enhancement must be installed and operational, and weapons must be enabled. Non-combatant targets will not be scanned automatically when your ship&#39;s weapons are turned off.

Warrant Scanners can be purchased at TL7 systems, for 2570 Cr.

Paying For Fines
================
While bounties will not degrade over time, it is still possible to remove those fines from your record by paying a requisite fine. Fines can be paid in one of two places: the main stations of the system where the fine was committed, or at the GalCop HQ system in each sector. See below for the locations of GalCop HQ. You can only pay fines collected in other sectors at the GalCop HQ system in your current sector. If you choose to pay your fine at GalCop HQ, a 10% fine processing charge will be added to the total amount.

The amount of fine you pay will be based on the amount of bounty, the type of system where the offence was committed, and the amount of time since the offence was committed.

The calculation is:
For Anarchy, Feudal, Democracy and Corporate States
	100 * (Bounty Amount - (days since offence * severity degrade rate))
For other government types
	50 * (Bounty Amount - (days since offence * severity degrade rate))

Example 1: A bounty of 30 (severity 1), collected in Lave (a Dictatorship), 15 days ago:
	Fine amount = 50 * (30 - (15 * 0.8))	= 900 cr

Example 2: A bounty of 75 (severity 3), collected in Qube (a Corporate State), 90 days ago:
	Fine amount = 100 * (75 - (90 * 0.1))	= 6600 cr

The longer you leave the payment, the more the fine will reduce, but the more likely it is you will be discovered.

Depending on the severity of your offence, there will also be a delay before you will be able to pay. The following table lists the delay periods for each severity level, and how fast the fine will degrade over time:

Level        Delay period    Degrade rate
---------------------------------------------
Severity 1   1 day           0.8cr per day
Severity 2   10 days         0.5cr per day
Severity 3   30 days         0.1cr per day

Special note: If a police vessel flags your ship to pay fines upon docking, the fine you pay will be the full amount and will not be reduced by a degrading component. This will only happen if your bounty is small, however. If you have a large bounty, police ships are more likely to attack you.

GalCop HQ systems
Sector  Planet
--------------------------------------------------------
1       Lave (ID 7, TL 5, Dictatorship)
2       Diti (ID 33, TL 9, Democracy)
3       Rigebi (ID 26, TL 12, Corporate State)
4       Beesed (ID 49, TL 9, Multi-Government)
5       Bisoge (ID 102, TL 12, Corporate State)
6       Celaan (ID 85, TL 11, Corporate State)
7       Ceraxete (ID 202, TL 6, Dictatorship)
8       Maarabi (ID 184, TL 5, Multi-Government)

Appeals process
===============
In the event that you believe a bounty has been incorrectly applied to you, it is possible to submit an appeal against the crime. While viewing the details of the crime from the GalCop Security Office screen, you can select the &quot;Submit appeal against fine&quot; option. This will ask you to confirm that an appeal be lodged. There is a cost involved in the appeal, and it may take quite some time to have the appeal processed, depending on how far away from the GalCop HQ system you are. The results of any appeals will be shown to you when you next dock at a GalCop station.

You can only lodge an appeal against a severity 1 crime up to 10 days after the event, 5 days for a severity 2 crime. Severity 3 crimes cannot be appealed against. 

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Shield image from https://www.iconfinder.com/icons/175318/shield_icon#size=512
Gavel image from http://www.freepik.com and http://www.flaticon.com, licensed by CC BY 3.0

With special thanks to Milo for the performance improvements code, updates to the NPC scan function, and for implementing the &quot;no-repeat-bounty&quot; code.

Discussion
==========
This OXP is discussed at this forum link: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=17861

Version History
===============
0.13
- Stopped switching NPC&#39;s active target to prevent possible conflicts in the AI routines.
- Added the Warrant Scanner MFD to HUD Selector.

0.12
- Reduced the delay period for severity 3 offences to 30 days, and severity 2 offences to 10 days.
- All defined offence types should now be passed through to the logging routine.

0.11
- Scanner was auto-scanning in manual scan mode.
- Bug fixes.

0.10
- Additional code changes for NPC scanning and interfacing with Broadcast Comms MFD, provided by Milo.

0.9
- Date applied to any offences is the date of the first offence (was previously the date the player left the system).
- Bug fixes for appeal processing.

0.8
- Warrant Scanner in auto-scan mode will now open MFD even if target is out of range.
- Performance improvements for the scanning process.
- If player is scanned in a system and bounties uncovered, and they are forced to deal with those bounties at the station, subsequent scans will not reapply bounty.
- Code refactoring.

0.7
- Fixed issue where missile attacks from the player would not ever be considered for possible illegality.

0.6
- Fixed issue with repairing a damaged passive-mode Warrant scanner.
- Fixed error when attempting to change the configuration of the Warrant scanner.
- Tweaked some descriptions in the equipment.plist file.
- Renamed some variables to prevent possible OXP conflicts.

0.5
- Changing the mode of the Warrant Scanner via Library to an automatic scan will remove the primable equipment.

0.4.4
- Warrant Scanner will switch back from non-MFD mode if an MFD slot becomes available.
- An update to the Most Wanted list will now be requested whenever the Most Wanted list is displayed.

0.4.3
- Improved compatibility with Fuel Injection Cruise Control OXP.

0.4.2
- When a scanned ship goes through a wormhole and has their bounty reset, you can now rescan the ship in the destination system to re-reveal their bounty.
- Corrected misspelled variable &quot;galaxyNumber&quot;.
- General source code spelling corrections.

0.4.1
- Added the source ship which has performed a scan as a parameter into the $uncoverBounties function.

0.4.0
- The Warrant Scanner will now automatically continue scanning a ship that has only been partly scanned.
- The Warrant Scanner can now be set to automatically scan a ship as soon as it&#39;s targeted (controlled via Library).
- Eliminated need to keep array of scanned ships.
- Option to set course to a particular destination will be suppressed if that destination is on the player&#39;s currently plotted path.

0.3.4
- When setting a course to a target system, F7 screen will now display the new destination.
- Bug fixing Most Wanted interfaces.

0.3.3
- Added protection against NPC scan invalid conditions.
- Further tweaks to the Most Wanted interfaces.

0.3.2
- More improvements to the Most Wanted interfaces.
- Corrections to descriptions.plist.

0.3.1
- Further code changes to handle integration with GalCop Most Wanted OXP.
- Fixed issue where using an escape was still clearing any bounty.
- Bug fixes.
- Code refactoring.

0.3.0
- Added an appeals process, so the player can submit a request for minor (sev 1 or 2) crimes to be discarded.
- Further code changes to handle future OXP integration.
- Improvements to text layout of menu options containing distance and # jumps.
- Added the severity level to the fine details page.
- Removed debug message.

0.2.0
- Added number of jumps to various mission screens.
- Code changes to handle future OXP integration.
- Scans performed by police or bounty hunters will be passed on to all ships in range that have the same class, to prevent spamming.
- Cleaned up overlay image.
- Converted offence dates to real dates (eg &quot;25 Jan 3145&quot;);
- Security office now available on all GalCop-aligned stations, but is called the &quot;Security Kiosk&quot;. No payments can be paid there.
- Updated license.

0.1.14
- Added extra info to readme.txt
- Removed hard-coded scanner range value.
- Bug fixes.

0.1.13
- Better handling of situation where an OXP resets bounty to zero.
- Better handling of &quot;seen by police&quot; bounty changes.
- Fixed name reference bug when monkey patching NPC ships.

0.1.12
- Paying fines on transferred bounties was removing the original bounty, not just the transferred one.
- Better integration with the ANA.
- Police and bounty hunters may now decide not to perform a scan.

0.1.11
- Severity 1 crimes were being added multiple times if scanned by more than 1 police/bounty hunter.

0.1.10
- Medical ships are now excluded from getting a hidden bounty.
- Fixed issue with HUD not becoming visible again when launching while viewing the GalCop security office screens.

0.1.9
- Fixed issue where player destination was getting reset when a chart screen is exited by pressing a function key, rather than via the &quot;Exit&quot; command.
- Fixed Javascript error when player ship is destroyed.

0.1.8
- Fixed a minor issue where some bogus data could sometimes be captured and then acted on. It should now be dropped.

0.1.7
- Fixed Javascript bug &quot;itm is not defined&quot;.

0.1.6
- Ships that have had bounties revealed will have their bounty reset when exiting a wormhole in another system, same as the player.
- Added Ship Dock Control integration code, so hidden bounties will be kept after docking and reapplied on launching.
- Added some protection against OXP&#39;s adding items to the possible offence list, and then the OXP is subsequently removed.
- Hopefully fixed issue with timers being garbage collected when still running.
- Simplified the data storage method for performance improvements.
- Changed &quot;==&quot; comparisons to &quot;===&quot; for performance improvements.

0.1.5
- Fixed error where same offence can be discovered multiple times for the player.

0.1.4
- Added code to make use of enhanced F7 screen features in Oolite 1.83/4.

0.1.3
- Removed debug messages.

0.1.2
- Added a console message confirmation whenever the course is set to a destination.
- Refined the process of adding &quot;attacked police/innocent&quot; ships. Hopefully accidental hits won&#39;t be added to the run-sheet any more.

0.1.1
- Bounties collected in Interstellar space will no longer be added to your overall bounty.

0.1.0
- Initial release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WARRANT_SCANNER.html">Warrant Scanner</a></td>
                    <td>yes</td>
                    <td align="right">25700</td>
                    <td align="center">7+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WARRANT_SCANNER_PASSIVE.html">Warrant Scanner</a></td>
                    <td>yes</td>
                    <td align="right">25700</td>
                    <td align="center">7+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WARRANT_SCANNER_POLICE.html">Police Warrant Scanner</a></td>
                    <td>yes</td>
                    <td align="right">836900</td>
                    <td align="center">13+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WARRANT_SCANNER_POLICE_PASSIVE.html">Police Warrant Scanner</a></td>
                    <td>yes</td>
                    <td align="right">836900</td>
                    <td align="center">13+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WARRANT_SCANNER_REMOVAL.html">Remove Warrant Scanner</a></td>
                    <td>no</td>
                    <td align="right">3000</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/bountysystem_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;BountySystem_Conditions&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2020 phkb&quot;;
this.description = &quot;Condition script for determining when items are available&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function(equipment, ship, context) {
    if (context === &quot;scripted&quot;) return true;
    var p = player.ship;
    switch (equipment) {
        case &quot;EQ_WARRANT_SCANNER&quot;:
            if (p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;) return false;
            break;
        case &quot;EQ_WARRANT_SCANNER_PASSIVE&quot;:
            if (p.equipmentStatus(equipment) === &quot;EQUIPMENT_DAMAGED&quot;) return true;
            return false;
    }
    return true;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/bountysystem_core.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;BountySystem_Core&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2016 phkb&quot;;
this.description = &quot;Core routines for New Bounty System.&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

/*
	What this OXP attempts to do is to keep track of offences committed by the player. Based on the type of offence and where the offence was committed,
	different things will occur.

	For &quot;severity 1&quot;-classed offences, the bounty will be local systems only. That is, you will only have a bounty within 5LY of the system you committed the crime.
	For &quot;severity 2&quot;-classed offences, the bounty is chart-wide. That is, you will have a bounty no matter where you go in the chart, but they don&#39;t follow you to a new chart
	For &quot;severity 3&quot;-classed offences, the bounty is across all charts.

	Severity 1 crimes are invisible in the current system, but can be transferred if within a 5ly radius of the original offence when scanned with warrant scanner
	Severity 2 and 3 crimes are invisible in the current system (if they didn&#39;t originate there) but will be transferred if you are scanned with the warrant scanner.

	You can pay off fines at GalCopHQ or at the system where the crime was committed, but only after a certain time period.
	Paying for fines long distance will incur a 10% increase in fine

	TODO: check the order in which events fire: does shipAttackedOther occur before the bountyChange event?
	If so, we need to check if the player already has a bounty delta in play. If not, we need to skip adding the offence via shipAttackedOther
	If not, we need to send a flag to the shipAttacked other

	Ideas:
	- Statute of limitations on severity 1 crimes: 12 months and then they disappear
	- Appeals process? Give player opportunity to appeal a particular offence (eg if the police see you attacking an assassin and decide you must be the offender)
*/

this._disabled = false;
this._debug = false; // turns on/off debug messages in log file
this._severity1Transfer = true; // indicates whether severity 1 crimes can be transferred over distance

this._offences = []; // holds list of all players offences
this._galCopHQ = [7, 33, 26, 49, 102, 85, 202, 184]; // galcop hq locations in each sector
this._galCopHQFineSurcharge = 0.1; // increase to fine amount when paid at GalCop HQ (currently 10%)
this._lastOffenceDate = 0;
this._changing = false; // flag to indicate that a change to the players bounty is happening internally
this._holding = []; // holding array of offences incurred in the current system
this._holdingDate = 0; // date of first offence of the holding array
this._bountyDelta = 0; // how much the bounty has changed while in the current system
this._system = -1; // system ID where offences held in this._holding occurred
this._severity = 1; // how serious were the offences in this._holding
this._escapePod = false; // flag to indicate the player has just used an escape pod
this._displayType = 0; // which screen is currently being displayed
this._page = 0; // which page is currently being displayed
this._selectedItem = 0; // the index of the item selected fine item from the menu
this._selectedGalaxy = 0; // the galaxy number selected from the menu
this._selectedIndex = -1; // the index of the selected most wanted item
this._lastChoice = [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;]; // array to store last choice on menus
this._routeMode = &quot;SHORTEST&quot;; // default mode for long range chart
this._itemColor = &quot;yellowColor&quot;;
this._menuColor = &quot;orangeColor&quot;;
this._exitColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._anarchies = false; // flag indicating &quot;Anarchies.OXP&quot; is installed
this._bountyScreen = false; // flag indicating the bounty screen is open
this._holdingItem = {}; // used by the mission screen as the holding spot for offences in the current system
this._markers = [];
this._appeals = [];
this._registrars = [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;];
this._appealMessage = &quot;&quot;;
this._doAppealScreen = false;
this._secOffClerk = &quot;&quot;;
this._warrantScannerMode = 0;
this._alreadyScannedPlayerInThisSystem = false; // do-once-per-system (not cleared when docked, only when jumping out) for importing out-of-system bounties so if player pays off the locals, they don&#39;t get a bounty again from a subsequent scan

// configuration settings for use in Lib_Config
this._bountySystemConfig = {
	Name: this.name,
	Alias: &quot;Bounty System&quot;,
	Display: &quot;Config&quot;,
	Alive: &quot;_bountySystemConfig&quot;,
	Notify: &quot;$changeSettings&quot;,
	Bool: {
		B0: {
			Name: &quot;_severity1Transfer&quot;,
			Def: true,
			Desc: &quot;Sev 1 bounty transfer&quot;
		},
		Info: &quot;0 - When true, severity 1 bounties can be discovered up to 5 LY from point of origin. When false, severity 1 bounties are not transferable&quot;
	},
	SInt: {
		S0: {
			Name: &quot;_warrantScannerMode&quot;,
			Def: 0,
			Min: 0,
			Max: 2,
			Desc: &quot;Warrant scanner mode&quot;
		},
		Info: &quot;0: Scanner mode - 0 = manual scan, 1 = automatic scan (offenders only), 2 = automatic scan (all ships)&quot;
	},
};
this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];

// list of different offences and details thereof
this._offenceTypes = {
	&quot;killed police&quot;: {
		description: &quot;Murder of GalCop law enforcement officer by means of aggravated use of spacecraft weaponry.&quot;,
		severity: 3
	},
	&quot;killed innocent&quot;: {
		description: &quot;Murder of innocent pilot by means of aggravated use of spacecraft weaponry.&quot;,
		severity: 3
	},
	&quot;theft of ship&quot;: {
		description: &quot;Grand theft of spacecraft within GalCop space.&quot;,
		severity: 3
	},
	&quot;attacked police&quot;: {
		description: &quot;Apprehended violence against GalCop law enforcement officer with spacecraft weaponry.&quot;,
		severity: 2
	},
	&quot;attacked main station&quot;: {
		description: &quot;Apprehended violence against GalCop orbital space station with spacecraft weaponry.&quot;,
		severity: 2
	},
	&quot;attacked innocent&quot;: {
		description: &quot;Apprehended violence against innocent pilot with spacecraft weaponry.&quot;,
		severity: 2
	},
	&quot;illegal exports&quot;: {
		description: &quot;Exportation of illegal commodities for personal gain within GalCop-controlled orbital space stations.&quot;,
		severity: 1
	},
	&quot;illegal imports&quot;: {
		description: &quot;Importation of illegal commodities for personal gain within GalCop-controlled orbital space stations.&quot;,
		severity: 1
	},
	&quot;illegal equipment&quot;: {
		description: &quot;Installation and/or use of illegal and/or unregistered equipment in GalCop-controlled space.&quot;,
		severity: 1
	},
	&quot;assisting offenders&quot;: {
		description: &quot;Aiding and abetting known offenders with use of spacecraft weaponry against innocent third parties.&quot;,
		severity: 1
	},
	&quot;attempted bribe&quot;: {
		description: &quot;Attempting to influence the actions of an official of GalCop by offering money.&quot;,
		severity: 1
	},
	&quot;underworld activity&quot;: {
		description: &quot;Collusion with known underworld entities to deceive and/or defraud GalCop officials in order to bypass GalCop law, for personal gain.&quot;,
		severity: 1
	},
	&quot;act of piracy&quot;: {
		description: &quot;Coercing a non-combatant to relinquish materials for personal gain.&quot;,
		severity: 1
	},
	&quot;unspecified_small&quot;: {
		description: &quot;Unspecified minor offences.&quot;,
		severity: 1
	},
	&quot;unspecified_medium&quot;: {
		description: &quot;Unspecified serious offences.&quot;,
		severity: 2
	},
	&quot;unspecified_large&quot;: {
		description: &quot;Unspecified major offences, warranting use of lethal force.&quot;,
		severity: 3
	},
	&quot;unspecified_undefined&quot;: {
		description: &quot;Unspecified offences.&quot;,
		severity: 1
	},
};

// bountyMin is greater than or equal to
// bountyMax is less than or equal to
// degrade rate is rate in decimal credits fine will degrade per day
// transferLimit controls applicability range of sev 1 crimes (this._severity1Transfer must be true for this to apply)
// payableIn is how many days must pass before fine can be paid
// appeal is whether the crime can be appealed
// appealTime is how many days after the crime can it be appealed
this._severityMatrix = {
	1: {
		label: &quot;Minor&quot;,
		bountyMin: 1,
		bountyMax: 14,
		degradeRate: 0.8,
		transferLimit: 5,
		payableIn: 1,
		appeal: true,
		appealTime: 10
	},
	2: {
		label: &quot;Serious&quot;,
		bountyMin: 15,
		bountyMax: 49,
		degradeRate: 0.5,
		transferLimit: 0,
		payableIn: 10,
		appeal: true,
		appealTime: 5
	},
	3: {
		label: &quot;Major&quot;,
		bountyMin: 50,
		bountyMax: -1,
		degradeRate: 0.1,
		transferLimit: 0,
		payableIn: 30,
		appeal: false,
		appealTime: 0
	}
};

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	if (this._disabled) {
		delete this.playerWillSaveGame;
		delete this.shipBountyChanged;
		delete this.shipLaunchedEscapePod;
		delete this.playerBoughtNewShip;
		delete this.shipLaunchedFromStation;
		delete this.shipWillDockWithStation;
		delete this.shipDockedWithStation;
		delete this.shipWillEnterWitchspace;
		delete this.shipExitedWitchspace;
		delete this.shipKilledOther;
		delete this.shipAttackedOther;
		delete this.shipFiredMissile;
		delete this.guiScreenChanged;
		delete this.startUpComplete;
		delete this.infoSystemChanged;
		return;
	}

	// load up player data
	if (missionVariables.BountySystem_Offences) {
		this._offences = JSON.parse(missionVariables.BountySystem_Offences);
		delete missionVariables.BountySystem_Offences;
	}
	if (missionVariables.BountySystem_Holding) {
		this._holding = JSON.parse(missionVariables.BountySystem_Holding);
		delete missionVariables.BountySystem_Holding;
	}
	if (missionVariables.BountySystem_HoldingDate) {
		this._holdingDate = missionVariables.BountySystem_HoldingDate;
		delete missionVariables.BountySystem_HoldingDate;
	}
	if (missionVariables.BountySystem_Severity) {
		this._severity = parseInt(missionVariables.BountySystem_Severity);
		delete missionVariables.BountySystem_Severity;
	}
	if (missionVariables.BountySystem_Delta) {
		this._bountyDelta = missionVariables.BountySystem_Delta;
		delete missionVariables.BountySystem_Delta;
	}
	if (missionVariables.BountySystem_LastOffenceDate) {
		this._lastOffenceDate = missionVariables.BountySystem_LastOffenceDate;
		delete missionVariables.BountySystem_LastOffenceDate;
	}
	if (missionVariables.BountySystem_Appeals) {
		this._appeals = JSON.parse(missionVariables.BountySystem_Appeals);
		delete missionVariables.BountySystem_Appeals;
	}
	if (missionVariables.BountySystem_AppealRegistrars) {
		this._registrars = JSON.parse(missionVariables.BountySystem_AppealRegistrars);
		delete missionVariables.BountySystem_AppealRegistrars;
	}

	this.$resetBogusData();

	this._system = system.ID;

	// the Anarchies OXP also plays around with bounty processing. Rather than make that OXP incompatible with this one,
	// we&#39;re going to override Anarchies and essentially nullify what it does, so that all the bounty processing is contained here.
	if (worldScripts.Anarchies) {
		this._anarchies = true;
		// monkey patch the this.$newBountyCalculation2 function so we can override the calculations and apply our own logic
		if (this._debug) log(this.name, &quot;Monkey patching Anarchies...&quot;);
		var w = worldScripts.Anarchies;
		w.$saved_newBountyCalculation2 = w.$newBountyCalculation2;
		w.$newBountyCalculation2 = this.$anarchiesBountyCalcOverride;
		// we also don&#39;t want the anarchies &quot;shipLaunchedEscapePod&quot; routine.
		delete w.shipLaunchedEscapePod;
	}

	// if the player has a bounty we don&#39;t know about, add some generic offences to the array
	// this would happen the first time the player loads a game after installing the OXP.
	if (player.bounty &gt; 0 &amp;&amp; this.$calculateBounty(system.ID) === 0) {
		this.shipBountyChanged(player.bounty, &quot;scripted&quot;);
	}

	// add a mission screen exception to Xenon UI
	if (worldScripts.XenonUI) {
		var wx = worldScripts.XenonUI;
		wx.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen4-map&quot;);
		wx.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen8-map&quot;);
		wx.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen9-map&quot;);
	}
	// add a mission screen exception to Xenon Redux UI
	if (worldScripts.XenonReduxUI) {
		var wxr = worldScripts.XenonReduxUI;
		wxr.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen4-map&quot;);
		wxr.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen8-map&quot;);
		wxr.$addMissionScreenException(&quot;oolite-galcopsecoffice-screen9-map&quot;);
	}

	// add screen 9 to the display current course OXP
	var dcc = worldScripts.DisplayCurrentCourse;
	if (dcc) dcc._screenIDList.push(&quot;oolite-galcopsecoffice-screen9-map&quot;);

	this._suspendedDestination = null;
	this.$initInterface(player.ship.dockedStation);

	// clear this flag after the game has been loaded and any starting bounty applied
	this._changing = false;

	if (missionVariables.BountySystem_Sev1Transfer) this._severity1Transfer = (this._trueValues.indexOf(missionVariables.BountySystem_Sev1Transfer) &gt;= 0 ? true : false);

	// register our settings, if Lib_Config is present
	if (worldScripts.Lib_Config) worldScripts.Lib_Config._registerSet(this._bountySystemConfig);

	if (missionVariables.BountySystem_alreadyScannedPlayerInThisSystem) {
		this._alreadyScannedPlayerInThisSystem = missionVariables.BountySystem_alreadyScannedPlayerInThisSystem;
		delete missionVariables.BountySystem_alreadyScannedPlayerInThisSystem;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	if (this._offences.length &gt; 0) {
		missionVariables.BountySystem_Offences = JSON.stringify(this._offences);
	} else {
		delete missionVariables.BountySystem_Offences;
	}
	if (this._bountyDelta &gt; 0) {
		missionVariables.BountySystem_Holding = JSON.stringify(this._holding);
		missionVariables.BountySystem_HoldingDate = this._holdingDate;
		missionVariables.BountySystem_Severity = this._severity;
		missionVariables.BountySystem_Delta = this._bountyDelta;
	}
	missionVariables.BountySystem_Sev1Transfer = this._severity1Transfer;
	if (this._appeals.length &gt; 0) {
		missionVariables.BountySystem_Appeals = JSON.stringify(this._appeals);
	}
	missionVariables.BountySystem_AppealRegistrars = JSON.stringify(this._registrars);
	missionVariables.BountySystem_LastOffenceDate = this._lastOffenceDate;
	missionVariables.BountySystem_alreadyScannedPlayerInThisSystem = this._alreadyScannedPlayerInThisSystem;
}

//-------------------------------------------------------------------------------------------------------------
this.shipBountyChanged = function (delta, reason) {
	/* 
	Because of the way this event fires, there could be lots of messages with a delta of 0.
	Rather than try to work out the difference, I&#39;m just adding all offences to a run-sheet, but each different type is only added once.
	If the severity of the crimes increases, the overall severity of the run-sheet will also increase.
	What this means is that you could have severity 1 crimes listed with severity 3.
	*/

	// check to see if we&#39;re setting the bounty ourselves - in which case skip this process
	if (this._changing === true) return;

	// otherwise, check the reason for the change
	switch (reason) {
		case &quot;distress call&quot;:
		case &quot;setup actions&quot;:
		case &quot;new system&quot;:
		case &quot;new galaxy&quot;:
			return;
		case &quot;illegal exports&quot;:
		case &quot;illegal imports&quot;:
		case &quot;illegal equipment&quot;:
			// &quot;illegal exports&quot; events will happen with a delta value of zero, so check first
			if (delta &gt; 0) this.$addOffence(reason);
			break;
		case &quot;killed innocent&quot;:
		case &quot;killed police&quot;:
		case &quot;attempted bribe&quot;:
		case &quot;attacked police&quot;:
		case &quot;attacked main station&quot;:
		case &quot;attacked innocent&quot;:
		case &quot;assisting offenders&quot;:
			// only add the office if (a) the delta is positive, or (b) we currently have a holding bounty delta that&#39;s greater than zero, and we haven&#39;t seen this offence yet
			if (delta &gt; 0 || (this._bountyDelta &gt; 0 &amp;&amp; this._holding.indexOf(reason) === -1)) {
				this.$addOffence(reason);
			}
			break;
			// removed the seen by police element, in case a crime is noted (ie delta &gt; 0) with this reason
			//case &quot;seen by police&quot;:
			// for the moment I&#39;m assuming this reason will always be accompanied by another event, so we don&#39;t need to record it separately
			//break;
		default:
			// we should get here for &quot;scripted&quot; and any other unrecognised reason
			// but we only want to do something if there is a positive delta
			if (delta &gt; 0) {
				if (this._debug) log(this.name, &quot;adding unspecified for &#39;&quot; + reason + &quot;&#39;, delta &quot; + delta);
				if (this._offenceTypes[reason]) {
					this.$addOffence(reason);
				} else {
					if (delta &gt;= this._severityMatrix[1].bountyMin &amp;&amp; delta &lt;= this._severityMatrix[1].bountyMax) this.$addOffence(&quot;unspecified_small&quot;);
					if (delta &gt;= this._severityMatrix[2].bountyMin &amp;&amp; delta &lt;= this._severityMatrix[2].bountyMax) this.$addOffence(&quot;unspecified_medium&quot;);
					if (delta &gt;= this._severityMatrix[3].bountyMin) this.$addOffence(&quot;unspecified_large&quot;);
				}
			}
			break;
	}

	if (this._debug) log(this.name, &quot;bounty &quot; + player.bounty + &quot;, change &quot; + delta + &quot;, reason &quot; + reason);
	if (delta &gt; 0) this._bountyDelta += delta;

	// we&#39;re reducing our bounty or we&#39;re setting it to zero
	if ((delta &lt; 0 &amp;&amp; reason !== &quot;escape pod&quot;) || (delta === 0 &amp;&amp; reason === &quot;scripted&quot;)) {
		// if the bounty was reset to 0, clear out all bounties - something has reset the players bounty
		if (player.bounty === 0 &amp;&amp; this.$calculateBounty(system.ID) != 0 &amp;&amp; reason !== &quot;paid fine&quot;) {
			if (this._debug) log(this.name, &quot;full bounty reset occurred&quot;);
			this._offences.length = 0;
			this._holding.length = 0;
			this._holdingDate = 0;
			this._bountyDelta = 0;
			// exit at this point so it doesn&#39;t flow into the next sections.
			return;
		}
		// player was marked for fines by a police ship
		// note: if the player was scanned and offences were transferred to the current system, and then they were marked for fines
		// paying the fine will only remove the transferred fine from the current system - not the original crime. If the player comes back to 
		// the system again and is scanned again they might have to pay for the fines again.
		if (player.bounty === 0 &amp;&amp; this.$calculateBounty(system.ID) != 0 &amp;&amp; reason === &quot;paid fine&quot;) {
			if (this._debug) log(this.name, &quot;player paid fine&quot;);
			// clear out any offences that would apply in the current system
			var tfrlist = [];
			var found = false;
			for (var i = this._offences.length - 1; i &gt;= 0; i--) {
				var itm = this._offences[i];
				// theoretically, the only time this would happen is for severity 1 offences, but we&#39;ll check for the others as well
				//if ((itm.severity === 1 &amp;&amp; itm.galaxy === galaxyNumber &amp;&amp; itm.system === system.ID) || (itm.severity &gt;= 2 &amp;&amp; itm.transferred === false)) {
				if (itm.galaxy === galaxyNumber &amp;&amp; itm.system === system.ID) {
					// take a copy of the relevant data for transferred offence removal, but only if this is the original offence
					// to catch instances where a bounty has been transferred to another system (not this one), but because we&#39;ve paid the original, the transferred bounty should also be removed
					// that is, if we&#39;re deleting the parent offence, all child offences should be removed as well.
					if (itm.transferred === false) {
						tfrlist.push({
							bounty: itm.bounty,
							severity: itm.severity,
							galaxy: itm.galaxy,
							system: itm.system,
							systemName: itm.systemName,
							government: itm.government,
							date: itm.date
						});
					}
					// the item is paid, so we can remove it.
					if (itm.transferred === true || (itm.originatingGalaxy === galaxyNumber &amp;&amp; itm.originatingSystem === system.ID)) {
						this._offences.splice(i, 1);
						found = true;
					}
				}
			}
			// remove any transferred offences
			if (tfrlist.length &gt; 0) {
				for (var i = 0; i &lt; tfrlist.length; i++) {
					this.$removeTransferredOffences(tfrlist[i]);
				}
			}
			// exit at this point so it doesn&#39;t flow into the next sections, but only if we found and removed some bounties from the master list and there&#39;s nothing on the current run sheet
			if (found === true &amp;&amp; this._bountyDelta === 0) return;
			// if we didn&#39;t find any bounties in the master list, we might be paying a fine for current offences - we deal with that in the next bit
			if (this._debug) log(this.name, &quot;fine paid on current run sheet - continuing...&quot; + this._bountyDelta);
		}
		// we&#39;ve already recorded some bounty in this system, so reduce it
		if (this._bountyDelta &gt; Math.abs(delta)) {
			if (this._debug) log(this.name, &quot;adjusting current run sheet&quot;);
			this._bountyDelta += delta;
			// exit at this point so it doesn&#39;t flow into the next sections.
			return;
		}
		// the reduction will clear out the current run sheet - remove the data.
		if (this._bountyDelta &lt;= Math.abs(delta)) {
			if (this._debug) log(this.name, &quot;current run sheet cleared&quot;);
			delta -= this._bountyDelta;
			this._bountyDelta = 0;
			this._holding.length = 0;
			this._holdingDate = 0;
			this._severity = 0;
			// exit at this point so it doesn&#39;t flow into the next section.
			//return;
		}
		// we have no pending bounties in this system
		if (this._bountyDelta === 0 &amp;&amp; delta != 0) {
			// reduce any recorded bounties for the player, local first
			var amount = this.$reduceBounty(Math.abs(delta), 1, system.ID);
			if (amount &gt; 0) amount = this.$reduceBounty(amount, 2, system.ID);
			if (amount &gt; 0) amount = this.$reduceBounty(amount, 3, system.ID);
			this.$cleanUp();
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedEscapePod = function (escapepod) {
	this._escapePod = true;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtNewShip = function (ship, price) {
	this._changing = true;
	player.bounty = this.$calculateBounty(system.ID);
	this._changing = false;
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
	delete missionVariables.BountySystem_Offences;
	delete missionVariables.BountySystem_Holding;
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function (station) {
	if (this._escapePod === true) {
		this._changing = true;
		player.bounty += this.$calculateBounty(system.ID); // add instead of setting so other OXPs can update it (currently known: Broadcast Comms restores hidden bounty for players who surrendered to police)
		this._changing = false;
		this._escapePod = false;
	}
	if (station.allegiance === &quot;galcop&quot; &amp;&amp; this._appeals.length &gt; 0) {
		this._appealMessage = &quot;&quot;;
		for (var i = this._appeals.length - 1; i &gt;= 0; i--) {
			var appeal = this._appeals[i];
			if (appeal.completedBy &lt; clock.adjustedSeconds) {
				var result = &quot;&quot;;
				if (this._offences.length &gt; 1) result = &quot;other-offences&quot;;
				if (this._offences.length === 1 &amp;&amp; this._offences[0].date == appeal.data.date &amp;&amp; this._offences[0].system === appeal.data.system &amp;&amp; this._offences[0].severity == 3) result = &quot;severity-3&quot;;
				if (this._offences.length === 0) result = &quot;already-paid&quot;;
				if (appeal.data.date - appeal.data.lastOffenceDate &lt; 30) &quot;too-soon&quot;;
				if (result === &quot;&quot;) {
					for (var j = 0; j &lt; appeal.roles.length; j++) {
						if (appeal.roles[j].indexOf(&quot;pirate&quot;) &gt;= 0) {
							result = &quot;pirate&quot;;
							break;
						}
						if (appeal.roles[j].indexOf(&quot;assassin&quot;) &gt;= 0) {
							result = &quot;assassin&quot;;
							break;
						}
					}
				}
				if (result === &quot;&quot;) result = &quot;success&quot;;
				var appeal = expandDescription(&quot;[galcop-appealresult-&quot; + result + &quot;]&quot;, {
					system: appeal.data.systemName,
					date: this.$setDateSince(appeal.data.date * 86400)
				});
				this._appealMessage += (this._appealMessage === &quot;&quot; ? &quot;&quot; : &quot;\n\n&quot;) + appeal;

				// send an email confirmation
				var ga = worldScripts.GalCopAdminServices;
				if (ga) {
					if (this._registrars[galaxyNumber] === &quot;&quot;) this._registrars[galaxyNumber] = expandDescription(&quot;%N [nom]&quot;);
					var msg = expandDescription(&quot;[galcop-appealresult-email]&quot;, {
						result: appeal,
						sender: this._registrars[galaxyNumber]
					});
					var w = worldScripts.EmailSystem;
					w.$createEmail({
						sender: &quot;Appeals Registrar&quot;,
						subject: &quot;Appeal Result&quot;,
						date: global.clock.adjustedSeconds,
						sentFrom: this._galCopHQ[galaxyNumber],
						message: msg,
						expiryDays: ga._defaultExpiryDays
					});
				}

				// if the appeal was successful, remove the offence
				if (result === &quot;success&quot;) {
					for (var j = this._offences.length - 1; j &gt;= 0; j--) {
						var itm = this._offences[j];
						if (itm.galaxy === galaxyNumber &amp;&amp; itm.system === appeal.data.system &amp;&amp; itm.date === appeal.data.date) {
							// we want to remove all instances of this bounty, regardless of whether it&#39;s transferred or not.
							this._offences.splice(j, 1);
						}
					}
				}
				// we&#39;ll remove this appeal now that it&#39;s been finished
				this._appeals.splice(i, 1);
			}
		}
		if (this._appealMessage !== &quot;&quot;) this._doAppealScreen = true;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
	if (this._doAppealScreen === true) {
		this._doAppealScreen = false;
		mission.runScreen({
			screenID: &quot;oolite-bountysystem-appeal-map&quot;,
			title: &quot;Appeal Submission Response&quot;,
			overlay: {
				name: &quot;galcop_logo.png&quot;,
				height: 546
			},
			message: this._appealMessage,
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;
		});
		this._appealMessage = &quot;&quot;;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	this.$initInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillEnterWitchspace = function (cause, destination) {
	this._secOffClerk = &quot;&quot;;
	// push data into the array, but only if there is a bounty delta
	if (this._bountyDelta != 0 &amp;&amp; system.ID &gt;= 0) {
		// for case where we are about to add an offence but no description has been added
		if (this._holding.length === 0) {
			if (this._bountyDelta &gt;= this._severityMatrix[1].bountyMin &amp;&amp; this._bountyDelta &lt;= this._severityMatrix[1].bountyMax) this.$addOffence(&quot;unspecified_small&quot;);
			if (this._bountyDelta &gt;= this._severityMatrix[2].bountyMin &amp;&amp; this._bountyDelta &lt;= this._severityMatrix[2].bountyMax) this.$addOffence(&quot;unspecified_medium&quot;);
			if (this._bountyDelta &gt;= this._severityMatrix[3].bountyMin) this.$addOffence(&quot;unspecified_large&quot;);
		}
		this._offences.push({
			offenceList: JSON.stringify(this._holding),
			bounty: this._bountyDelta,
			severity: this._severity,
			galaxy: galaxyNumber,
			system: this._system,
			systemName: System.infoForSystem(galaxyNumber, this._system).name,
			government: System.infoForSystem(galaxyNumber, this._system).government,
			date: this._holdingDate, //global.clock.days,
			transferred: false,
			originatingSystem: this._system,
			originatingGalaxy: galaxyNumber,
			priorOffenceDate: this._lastOffenceDate
		});
		this._lastOffenceDate = this._holdingDate;
	}
	// clean up for next system
	this._holding.length = 0;
	this._holdingDate = 0;
	this._bountyDelta = 0;
	this._severity = 0;
	this._alreadyScannedPlayerInThisSystem = false;
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	this.$resetBogusData();
	// calculate the player&#39;s bounty in this system
	this._changing = true;
	player.bounty = this.$calculateBounty(system.ID);
	this._changing = false;
	this._system = system.ID;
}

//-------------------------------------------------------------------------------------------------------------
this.shipKilledOther = function (whom, damageType) {
	this.$targetAttacked(whom, damageType, true);
}

//-------------------------------------------------------------------------------------------------------------
this.shipAttackedOther = function (whom) {
	// only send the targetAttacked message if the player has a current bounty delta
	if (this._bountyDelta &gt; 0) this.$targetAttacked(whom, &quot;energy damage&quot;, false);
}

//-------------------------------------------------------------------------------------------------------------
this.shipFiredMissile = function (missile, whom) {
	this.$targetAttacked(whom, &quot;energy damage&quot;, false);
}

//-------------------------------------------------------------------------------------------------------------
// processes all the variations on attacking and killing other ships
this.$targetAttacked = function (whom, damageType, killed) {
	// don&#39;t record anything if this is a simulator run
	if (this.$simulatorRunning()) return;

	var msgType = &quot;attacked&quot;;
	if (killed) msgType = &quot;killed&quot;;

	// player shot and killed other with lasers, q-bomb, or by ramming them
	if (whom.isPiloted &amp;&amp; !whom.isDerelict &amp;&amp; !whom.isThargoid) {
		if (damageType === &quot;energy damage&quot; || damageType === &quot;cascade weapon&quot; || damageType === &quot;scrape damage&quot;) {
			// who did we just kill?
			if (whom.isPolice) {
				this.$addOffence(msgType + &quot; police&quot;);
			} else {
				// is there a police ship/station in range
				// (check the holding array first though, so we can avoid doing &quot;findLawVessels&quot; with every laser shot)
				if (whom.bounty === 0 &amp;&amp; this._holding.indexOf(msgType + &quot;innocent&quot;) === -1) {
					var police = this.$findLawVessels(player.ship);
					if (police.length &gt; 0) this.$addOffence(msgType + &quot; innocent&quot;);
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function (to, from) {
	if (to === &quot;GUI_SCREEN_SYSTEM_DATA&quot; &amp;&amp; from != &quot;GUI_SCREEN_SYSTEM_DATA&quot;) this.$updateSystemInfo();
	if (from === &quot;GUI_SCREEN_MISSION&quot; &amp;&amp; this._bountyScreen) {
		this._bountyScreen = false;
		if (this._hudHidden === false &amp;&amp; player.ship.hudHidden === true) player.ship.hudHidden = this._hudHidden;
		if (this._suspendedDestination) player.ship.targetSystem = this._suspendedDestination;
		this._suspendedDestination = null;
		// clean up all the marks on the chart
		this.$removeChartData();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.infoSystemChanged = function (to, from) {
	if (guiScreen === &quot;GUI_SCREEN_SYSTEM_DATA&quot;) this.$updateSystemInfo();
}

//--------------------------------------------------------------------------------------------------------------
this.$updateSystemInfo = function () {
	var sysID = player.ship.targetSystem;
	if (player.ship.hasOwnProperty(&quot;infoSystem&quot;)) sysID = player.ship.infoSystem;
	var bounty = this.$calculateBounty(sysID);
	var criminal = this.$playerIsCriminal(sysID);
	if (bounty &gt; 0 &amp;&amp; bounty &lt; 50) mission.addMessageText(&quot;This system considers you &quot; + (criminal === true ? &quot;a criminal&quot; : &quot;an&quot;) + &quot; offender.&quot;);
	if (bounty &gt; 50) mission.addMessageText(&quot;This system considers you &quot; + (criminal === true ? &quot;a criminal&quot; : &quot;a&quot;) + &quot; fugitive.&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$initInterface = function (station) {
	if (station.allegiance === &quot;galcop&quot;) {
		station.setInterface(this.name, {
			title: (station.isMainStation ? &quot;GalCop security office&quot; : &quot;GalCop security kiosk&quot;),
			category: &quot;Station Interfaces&quot;,
			summary: &quot;Accesses the GalCop security office services at this station.&quot;,
			callback: this.$startSecOfficeScreen.bind(this)
		});
	} else {
		station.setInterface(this.name, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$startSecOfficeScreen = function () {
	this._lastChoice = [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;];
	this._displayType = 0;
	this._page = 0;
	this.$showSecOffice();
}

//-------------------------------------------------------------------------------------------------------------
this.$showSecOffice = function () {
	function compare(a, b) {
		if (a.date &lt; b.date) return -1;
		if (a.date &gt; b.date) return 1;
		return 0;
	}

	function compareBounty(a, b) {
		return (b.bounty - a.bounty);
	}

	function compareDateDesc(a, b) {
		if (a.createdDate &gt; b.createdDate) return -1;
		if (a.createdDate &lt; b.createdDate) return 1;
		return 0;
	}
	var p = player.ship;

	var text = &quot;&quot;;
	var opts;
	var curChoices = {};
	var def = &quot;&quot;;
	var rows = 21;
	this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() === false) p.hudHidden = true;
	this._bountyScreen = true;
	var jmpIndent = 6.45;

	var govs = new Array();
	for (var i = 0; i &lt; 8; i++)
		govs.push(String.fromCharCode(i));
	var spc = String.fromCharCode(31);

	if (this._displayType === 0) {
		text = expandDescription(&quot;[galcop-office-welcome]&quot;, {
			officetype: (system.ID === this._galCopHQ[galaxyNumber] ? &quot;HQ&quot; : &quot;Local&quot;)
		});
		var itemcount = 2;

		curChoices[&quot;01_VIEWSTD&quot;] = {
			text: &quot;[galcop-local-fines]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;02_VIEWINTER&quot;] = {
			text: &quot;[galcop-inter-fines]&quot;,
			color: this._menuColor
		};
		if (worldScripts.BountySystem_MostWanted) {
			curChoices[&quot;03_WANTED&quot;] = {
				text: &quot;[galcop-mostwanted]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
			if (p.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
				curChoices[&quot;09_BOUNTY_TIPS&quot;] = {
					text: &quot;[galcop-mostwanted-tips]&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
			if (worldScripts.BountySystem_MostWanted._completed.length &gt; 0) {
				curChoices[&quot;03_WANTED_BONUS&quot;] = {
					text: &quot;[galcop-mostwanted-bonus-menu]&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}
		if (system.ID != this._galCopHQ[galaxyNumber]) {
			curChoices[&quot;04_GALCOPHQ&quot;] = {
				text: &quot;[galcop-hq]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
		}

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};
		var def = &quot;99_EXIT&quot;;

		for (var i = 0; i &lt; (rows - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen0-map&quot;,
			title: &quot;GalCop &quot; + (system.ID === this._galCopHQ[galaxyNumber] ? &quot;HQ&quot; : &quot;Local&quot;) + &quot; Security Office&quot;,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			overlay: {
				name: &quot;galcop_logo.png&quot;,
				height: 546
			},
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 1) { // outstanding fines
		text = this.$padTextRight(expandDescription(&quot;[galcop-fine-hdr-system]&quot;), 6) +
			this.$padTextRight(expandDescription(&quot;[galcop-fine-hdr-date]&quot;), 6) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-incidents]&quot;), 5) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-bounty]&quot;), 4) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-fine]&quot;), 5) + &quot;  &quot; + expandDescription(&quot;[galcop-fine-hdr-payable]&quot;);
		var list = [];
		for (var i = 0; i &lt; this._offences.length; i++) {
			var offence = this._offences[i];
			if (offence.transferred === false &amp;&amp; offence.galaxy === galaxyNumber) {
				if (this.$calculateItemBounty(offence, offence.system) &gt; 0) {
					var subitems = JSON.parse(offence.offenceList);
					var days = 0;
					if (this.$itemIsPayable(offence) === false) days = this.$daysUntilPayable(offence);

					var st = this.$setDateSince(parseFloat(offence.date) * 86400);
					list.push({
						text: this.$padTextRight(offence.systemName, 6) +
							this.$padTextRight(st, 6) + // offence.date
							this.$padTextLeft(subitems.length, 5) +
							this.$padTextLeft(formatCredits(this.$calculateItemBounty(offence, offence.system), false, true), 4) +
							(this.$itemIsPayable(offence) ? this.$padTextLeft(formatCredits(this.$calculateFine(offence), false, true), 5) : this.$padTextLeft(&quot; &quot;, 5)) +
							(days === 0 ? &quot;  Yes&quot; : &quot;  &quot; + days + &quot; day&quot; + (days &gt; 1 ? &quot;s&quot; : &quot;&quot;)),
						date: offence.date,
						index: i
					});
				}
			}
		}
		// add in any active offences that haven&#39;t been added to the main offence list
		if (this._holding.length &gt; 0) {
			this._holdingItem = {
				offenceList: JSON.stringify(this._holding),
				bounty: this._bountyDelta,
				severity: this._severity,
				galaxy: galaxyNumber,
				system: system.ID,
				systemName: system.name,
				government: system.info.government,
				date: this._holdingDate, //global.clock.days,
				transferred: false
			};
			list.push({
				text: this.$padTextRight(this._holdingItem.systemName, 6) +
					this.$padTextRight(this.$setDateSince(this._holdingItem.date * 86400), 6) + // this._holdingItem.date
					this.$padTextLeft(this._holding.length, 5) +
					this.$padTextLeft(formatCredits(this._bountyDelta, false, true), 4) +
					this.$padTextLeft(&quot; &quot;, 5) +
					&quot;  &quot;,
				date: global.clock.days,
				index: 9999
			});
		}

		def = &quot;98_CLOSE&quot;;

		if (list.length &gt; 0) {
			list.sort(compare);

			var maxpage = Math.ceil(list.length / (rows + 1));
			var end = ((this._page * (rows + 1)) + (rows + 1));
			var itemcount = 0;
			if (end &gt; list.length) end = list.length;
			for (var i = (this._page * (rows + 1)); i &lt; end; i++) {
				curChoices[&quot;01_FINE-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i].index] = {
					text: list[i].text,
					alignment: &quot;LEFT&quot;,
					color: this._itemColor
				};
				itemcount += 1;
			}

			curChoices[&quot;94_SPACER&quot;] = &quot;&quot;;

			if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._page &gt; 0) {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}

			for (var i = 0; i &lt; (rows - itemcount); i++) {
				curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
			}

			//if (this._lastChoice != &quot;&quot;) def = this._lastChoice;

		} else {
			text = expandDescription(&quot;[galcop-no-warrants]&quot;);
		}

		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen1-map&quot;,
			title: &quot;Outstanding Fines&quot;,
			overlay: {
				name: &quot;bounty-gavel.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 2) { // outstanding intergalactic fines
		// for this we summarise all the bounties from other sectors
		var hq = System.infoForSystem(galaxyNumber, this._galCopHQ[galaxyNumber]);
		var itemcount = 0;
		for (var i = 0; i &lt;= 7; i++) {
			if (i != galaxyNumber) {
				var bounty = this.$calculateIntergalacticBounty(i);
				if (bounty &gt; 0) {
					var fineamt = 0;
					for (var j = 0; j &lt; this._offences.length; j++) {
						if (this._offences[i].transferred === false &amp;&amp; this._offences[j].galaxy === i &amp;&amp; this.$itemIsPayable(this._offences[j]) === true) fineamt += this.$calculateFine(this._offences[j]);
					}
					curChoices[&quot;05_GAL~&quot; + i] = {
						text: this.$padTextRight(&quot;Sector &quot; + (i + 1), 10) + this.$padTextLeft(formatCredits(bounty, false, true), 10) + this.$padTextLeft(formatCredits(fineamt, false, true), 10),
						alignment: &quot;LEFT&quot;,
						color: this._itemColor
					};
					itemcount += 1;
				}
			}
		}

		if (itemcount &gt; 0) {
			text = this.$padTextRight(expandDescription(&quot;[galcop-sector]&quot;), 10) + this.$padTextLeft(expandDescription(&quot;[galcop-bounty]&quot;), 10) + this.$padTextLeft(expandDescription(&quot;[galcop-payable]&quot;), 10) + &quot;\n&quot;;
			curChoices[&quot;06_SPACER&quot;] = &quot;&quot;;
			for (var i = 0; i &lt; ((rows + 2) - itemcount); i++) {
				curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
			}

		} else {
			text = expandDescription(&quot;[galcop-no-inter-warrants]&quot;);
		}

		def = &quot;98_CLOSE&quot;;
		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen2-map&quot;,
			title: &quot;Outstanding Intergalactic Fines&quot;,
			overlay: {
				name: &quot;bounty-gavel.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 3) { // most wanted list
		// pilot name, bounty, last seen, updated
		text = this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-hdr-pilot]&quot;), 10) +
			this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-hdr-lastseen]&quot;), 10) +
			this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-hdr-updated]&quot;), 7.25) +
			this.$padTextLeft(expandDescription(&quot;[galcop-mostwanted-hdr-bounty]&quot;), 4.5);
		var list = [];
		var mw = worldScripts.BountySystem_MostWanted;
		if (mw._constantUpdates == true) mw.$updateDisplayList();
		var dl = mw._displayList;
		for (var i = 0; i &lt; dl.length; i++) {
			if (dl[i].lastVisibleSystem != -1) {
				list.push({
					pilotName: dl[i].pilotName,
					bounty: dl[i].bounty,
					lastSeen: System.systemNameForID(dl[i].lastVisibleSystem),
					lastVisibleSystem: dl[i].lastVisibleSystem,
					updated: dl[i].updated,
					index: i,
					ref: dl[i].index
				});
			} else {
				list.push({
					pilotName: dl[i].pilotName,
					bounty: dl[i].bounty,
					lastSeen: &quot;--unknown--&quot;,
					lastVisibleSystem: -1,
					updated: &quot;&quot;,
					index: i,
					ref: dl[i].index
				});
			}
		}

		def = &quot;98_CLOSE&quot;;

		if (list.length &gt; 0) {
			list.sort(compareBounty);

			var maxpage = Math.ceil(list.length / rows);
			var end = ((this._page * rows) + rows);
			var itemcount = 0;
			if (end &gt; list.length) end = list.length;
			for (var i = (this._page * rows); i &lt; end; i++) {
				var lastseen = &quot;&quot;;
				var updated = &quot;&quot;;
				if (list[i].lastVisibleSystem &gt;= 0) {
					var info = System.infoForSystem(galaxyNumber, list[i].lastVisibleSystem);
					var rt = system.info.routeToSystem(info);
					if (rt) {
						var dist = rt.distance;
					} else {
						var dist = system.info.distanceToSystem(info);
					}
					lastseen = list[i].lastSeen + &quot; (&quot; + govs[info.government] + spc + dist.toFixed(1) + &quot;ly)&quot;;
					updated = this.$adjustTime(clock.clockStringForTime(list[i].updated));
				} else {
					lastseen = &quot;--unknown--&quot;;
					updated = &quot;&quot;;
				}

				curChoices[&quot;50_MOSTWANTED-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i].index] = {
					text: this.$padTextRight((mw._missionList.indexOf(list[i].ref) &gt;= 0 ? &quot;• &quot; : &quot;&quot;) + list[i].pilotName, 10) +
						this.$padTextRight(lastseen, 10) +
						this.$padTextRight(updated, 7.25) +
						this.$padTextLeft(formatCredits(list[i].bounty, false, true), 4.5),
					alignment: &quot;LEFT&quot;,
					color: this._itemColor
				};
				itemcount += 1;
			}

			curChoices[&quot;94_SPACER&quot;] = &quot;&quot;;
			for (var i = 0; i &lt; (rows - itemcount); i++) {
				curChoices[&quot;94_SPACER_&quot; + i] = &quot;&quot;;
			}

			if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._page &gt; 0) {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}

		def = &quot;98_CLOSE&quot;;
		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen3-map&quot;,
			title: &quot;GalCop Most Wanted&quot; + (maxpage &gt; 1 ? &quot;: Page &quot; + (this._page + 1) + &quot; of &quot; + maxpage : &quot;&quot;),
			overlay: {
				name: &quot;mw_badge.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 4) { // galcop hq location
		// hold the player&#39;s destination
		var rtCurr = system.info.routeToSystem(System.infoForSystem(galaxyNumber, p.targetSystem));
		this._suspendedDestination = p.targetSystem;
		// override it for the display
		p.targetSystem = this._galCopHQ[galaxyNumber];

		var bg = &quot;LONG_RANGE_CHART&quot;;
		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			if (this._galCopHQ[galaxyNumber] != system.ID) {
				var rt = system.info.routeToSystem(System.infoForSystem(galaxyNumber, this._galCopHQ[galaxyNumber]), (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
				if (rt &amp;&amp; rt.route.length &gt; 1) {
					text = &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot; + this.$padTextRight(&quot;&quot;, jmpIndent) + expandDescription(&quot;[galcop-jumps]&quot;) + &quot; &quot; + (rt.route.length - 1);
				}
			}
			if (this._routeMode === &quot;SHORTEST&quot;) {
				bg += &quot;_SHORTEST&quot;;
				curChoices[&quot;90_SHORTEST&quot;] = {
					text: &quot;[galcop-short-route]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
				curChoices[&quot;91_QUICKEST&quot;] = {
					text: &quot;[galcop-quick-route]&quot;,
					color: this._menuColor
				};
			} else {
				bg += &quot;_QUICKEST&quot;;
				curChoices[&quot;90_SHORTEST&quot;] = {
					text: &quot;[galcop-short-route]&quot;,
					color: this._menuColor
				};
				curChoices[&quot;91_QUICKEST&quot;] = {
					text: &quot;[galcop-quick-route]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}

		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; (!rtCurr || rtCurr.route.indexOf(p.targetSystem) === -1)) {
			curChoices[&quot;96_SETCOURSE~&quot; + p.targetSystem] = {
				text: expandDescription(&quot;[galcop-set-course]&quot;, {
					destination: System.systemNameForID(p.targetSystem)
				}),
				color: this._menuColor
			};
		}

		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};
		def = &quot;98_CLOSE&quot;;

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen4-map&quot;,
			title: &quot;GalCop HQ in Sector &quot; + (galaxyNumber + 1),
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 5) { // fine detail
		if (this._selectedItem === 9999) {
			var itm = this._holdingItem;
		} else {
			var itm = this._offences[this._selectedItem];
		}
		var subitems = JSON.parse(itm.offenceList);
		var tl = 0;
		if (itm.galaxy === galaxyNumber) {
			var info = System.infoForSystem(galaxyNumber, itm.system);
			tl = info.techlevel + 1;
		} else {
			var info = null;
		}
		var hq = System.infoForSystem(galaxyNumber, this._galCopHQ[galaxyNumber]);
		text = this.$padTextRight(expandDescription(&quot;[galcop-offence-system]&quot;), 10) + itm.systemName + &quot; (&quot; + govs[itm.government] + spc + (itm.galaxy != galaxyNumber ? &quot;G&quot; + (itm.galaxy + 1) + &quot;)&quot; : &quot;TL&quot; + tl + &quot;)&quot;) + &quot;\n&quot;;
		text += this.$padTextRight(expandDescription(&quot;[galcop-offence-date]&quot;), 10) + this.$setDateSince(itm.date * 86400) + &quot;\n&quot;;
		text += this.$padTextRight(expandDescription(&quot;[galcop-offence-severity]&quot;), 10) + itm.severity + &quot; (&quot; + this._severityMatrix[itm.severity].label + &quot;)\n&quot;;

		var bounty = 0;
		if (itm.galaxy != galaxyNumber) {
			bounty = this.$calculateIntergalacticItemBounty(itm);
		} else {
			bounty = this.$calculateItemBounty(itm, itm.system);
		}
		text += this.$padTextRight(expandDescription(&quot;[galcop-offence-bounty]&quot;), 10) + formatCredits(bounty, false, true) + &quot;\n&quot;;
		var linecount = 0;
		if (this.$itemAlreadyTransferred(itm) === true) {
			text += this.$padTextRight(expandDescription(&quot;[galcop-offence-applied]&quot;), 10) + &quot;Yes\n&quot;;
			linecount += 1;
		}
		if (itm.system != system.ID) linecount += 1;
		for (var i = 0; i &lt; subitems.length; i++) {
			if (this._offenceTypes[subitems[i]]) {
				var textItems = &quot;- &quot; + this._offenceTypes[subitems[i]].description;
			} else {
				var textItems = &quot;- &quot; + this._offenceTypes[&quot;unspecified_undefined&quot;].description;
			}
			var colItems = this.$columnText(textItems, 21);
			for (var j = 0; j &lt; colItems.length; j++) {
				if (i === 0 &amp;&amp; j === 0) {
					text += this.$padTextRight(expandDescription(&quot;[galcop-offence-charges]&quot;), 10);
				} else {
					text += this.$padTextRight(&quot; &quot;, 10);
				}
				text += colItems[j] + &quot;\n&quot;;
				linecount += 1;
				if (linecount &gt;= rows - 1) {
					text += this.$padTextRight(&quot; &quot;, 10) + &quot;&lt;&lt; list overflow &gt;&gt;\n&quot;;
					break;
				}
			}
			if (linecount &gt;= rows - 1) break;
		}

		if (itm.system != system.ID) {
			curChoices[&quot;53_VIEWCHART&quot;] = {
				text: &quot;[galcop-view-course]&quot;,
				color: this._menuColor
			};
		}

		if (this.$itemIsPayable(itm) === false || this._selectedItem === 9999) {
			var days_until = this.$daysUntilPayable(itm);
			if (this._selectedItem === 9999) {
				text += this.$padTextRight(expandDescription(&quot;[galcop-offence-days]&quot;), 10) + days_until + &quot; day&quot; + (days_until === 1 ? &quot;&quot; : &quot;s&quot;) + &quot; after leaving system\n&quot;;
			} else {
				text += this.$padTextRight(expandDescription(&quot;[galcop-offence-days]&quot;), 10) + days_until + &quot; day&quot; + (days_until === 1 ? &quot;&quot; : &quot;s&quot;) + &quot;\n&quot;;
			}
			curChoices[&quot;90_PAYFINE&quot;] = {
				text: expandDescription(&quot;[galcop-payfine]&quot;, {
					fine: &quot;(not available)&quot;
				}),
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			text += this.$padTextRight(expandDescription(&quot;[galcop-offence-fine]&quot;), 10) + formatCredits(this.$calculateFine(itm), false, true);
			if (system.ID === this._galCopHQ[galaxyNumber] || (itm.galaxy === galaxyNumber &amp;&amp; system.ID === itm.system)) {
				curChoices[&quot;90_PAYFINE&quot;] = {
					text: expandDescription(&quot;[galcop-payfine]&quot;, {
						fine: &quot;(&quot; + formatCredits(this.$calculateFine(itm) * (itm.system != system.ID ? (1 + this._galCopHQFineSurcharge) : 1), true, true) + &quot;)&quot;
					}) + (p.dockedStation.isMainStation ? &quot;&quot; : &quot; (only at main station)&quot;),
					unselectable: (p.dockedStation.isMainStation ? false : true),
					color: this._menuColor
				};
			} else {
				var hqJumps = 0;
				// calc distance to HQ
				var rt1 = system.info.routeToSystem(hq, (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
				if (rt1 &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
					var dist1 = rt1.distance;
					hqJumps = rt1.route.length - 1;
				} else {
					var dist1 = system.info.distanceToSystem(hq);
				}
				var offJumps = 0;
				// calc distance to offence planet (if available)
				if (info) {
					var rt2 = system.info.routeToSystem(info, (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
					if (rt2 &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
						var dist2 = rt2.distance;
						offJumps = rt2.route.length - 1;
					} else {
						var dist2 = system.info.distanceToSystem(info);
					}
				}
				if (itm.galaxy === galaxyNumber) {
					if (itm.system != this._galCopHQ[galaxyNumber]) {
						text += expandDescription(&quot;[galcop-offence-payable-at-both]&quot;, {
							destination: info.name
						});
						var warn = expandDescription(&quot;[galcop-offence-hq-warning]&quot;);
						if (defaultFont.measureString(warn) &gt; 21) {
							var warnItems = this.$columnText(warn, 21);
							for (var i = 0; i &lt; warnItems.length; i++) {
								text += &quot;\n&quot; + this.$padTextRight(&quot; &quot;, 10) + warnItems[i];
							}
						} else {
							text += &quot;\n&quot; + this.$padTextRight(&quot; &quot;, 10) + warn;
						}
						if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; this.$systemInCurrentPlot(this._galCopHQ[galaxyNumber]) === false) {
							curChoices[&quot;96_SETCOURSE~&quot; + this._galCopHQ[galaxyNumber]] = {
								text: expandDescription(&quot;[galcop-hq-set-course-dist]&quot;, {
									distance: dist1.toFixed(1),
									jumps: (hqJumps &gt; 0 ? &quot;, &quot; + hqJumps + &quot; jump&quot; + (hqJumps &gt; 1 ? &quot;s&quot; : &quot;&quot;) : &quot;&quot;)
								}),
								color: this._menuColor
							};
						}
					} else {
						text += expandDescription(&quot;[galcop-offence-payable-at-local]&quot;, {
							destination: info.name
						});
					}
					if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; this.$systemInCurrentPlot(itm.system) === false) {
						curChoices[&quot;96_SETCOURSE~&quot; + itm.system] = {
							text: expandDescription(&quot;[galcop-set-course-dist]&quot;, {
								destination: info.name,
								distance: dist2.toFixed(1),
								jumps: (offJumps &gt; 0 ? &quot;, &quot; + offJumps + &quot; jump&quot; + (offJumps &gt; 1 ? &quot;s&quot; : &quot;&quot;) : &quot;&quot;)
							}),
							color: this._menuColor
						};
					}
				} else {
					text += &quot; (payable at GalCop HQ)&quot;;
					if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; this.$systemInCurrentPlot(this._galCopHQ[galaxyNumber]) === false) {
						curChoices[&quot;96_SETCOURSE~&quot; + this._galCopHQ[galaxyNumber]] = {
							text: expandDescription(&quot;[galcop-hq-set-course-dist]&quot;, {
								distance: dist1.toFixed(1),
								jumps: (hqJumps &gt; 0 ? &quot;, &quot; + hqJumps + &quot; jump&quot; + (hqJumps &gt; 1 ? &quot;s&quot; : &quot;&quot;) : &quot;&quot;)
							}),
							color: this._menuColor
						};
					}
				}
			}
			text += &quot;\n&quot;;
		}
		// if we&#39;re at a main station, we can offer an appeal process
		if (player.ship.dockedStation &amp;&amp; player.ship.dockedStation.isMainStation) {
			if (this._selectedItem !== 9999 &amp;&amp;
				(itm.hasOwnProperty(&quot;lastOffenceDate&quot;) === false || (clock.days - itm.date) &lt;= this._severityMatrix[itm.severity].appealTime) &amp;&amp;
				this.$checkAppealStatus(itm) === &quot;none&quot; &amp;&amp;
				this._severityMatrix[itm.severity].appeal === true) {
				curChoices[&quot;97_APPEAL&quot;] = {
					text: &quot;[galcop-submit-appeal]&quot;,
					color: this._menuColor
				};
			}
			if (this.$checkAppealStatus(itm) === &quot;in progress&quot;) {
				curChoices[&quot;97_APPEAL&quot;] = {
					text: &quot;[galcop-appeal-inprogress]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}
		if (itm.galaxy === galaxyNumber) {
			curChoices[&quot;97_CLOSE&quot;] = {
				text: &quot;[galcop-exit]&quot;,
				color: this._exitColor
			};
			def = &quot;97_CLOSE&quot;;
		} else {
			curChoices[&quot;97A_CLOSE&quot;] = {
				text: &quot;[galcop-exit]&quot;,
				color: this._exitColor
			};
			def = &quot;97A_CLOSE&quot;;
		}

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen5-map&quot;,
			title: &quot;Outstanding Fine&quot;,
			overlay: {
				name: &quot;bounty-gavel.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 6) { // outstanding intergalactic fines
		text = this.$padTextRight(expandDescription(&quot;[galcop-fine-hdr-system]&quot;), 6) +
			this.$padTextRight(expandDescription(&quot;[galcop-fine-hdr-date]&quot;), 6) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-incidents]&quot;), 5) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-bounty]&quot;), 4) +
			this.$padTextLeft(expandDescription(&quot;[galcop-fine-hdr-fine]&quot;), 5) + &quot;  &quot; + expandDescription(&quot;[galcop-fine-hdr-payable]&quot;);
		var list = [];
		for (var i = 0; i &lt; this._offences.length; i++) {
			if (this._offences[i].transferred === false &amp;&amp; this._offences[i].galaxy === this._selectedGalaxy) {
				if (this.$calculateIntergalacticItemBounty(this._offences[i]) &gt; 0) {
					var subitems = JSON.parse(this._offences[i].offenceList);
					list.push({
						text: this.$padTextRight(this._offences[i].systemName, 6) +
							this.$padTextRight(this.$setDateSince(this._offences[i].date * 86400), 6) +
							this.$padTextLeft(subitems.length, 5) +
							this.$padTextLeft(formatCredits(this.$calculateIntergalacticItemBounty(this._offences[i]), false, true), 4) +
							(this.$itemIsPayable(this._offences[i]) ? this.$padTextLeft(formatCredits(this.$calculateFine(this._offences[i]), false, true), 5) : this.$padTextLeft(&quot; &quot;, 5)) +
							(this.$itemIsPayable(this._offences[i]) ? &quot;  Yes&quot; : &quot;  &quot; + this.$daysUntilPayable(this._offences[i]) + &quot; days&quot;),
						date: this._offences[i].date,
						index: i
					});
				}
			}
		}

		def = &quot;97B_CLOSE&quot;;

		if (list.length &gt; 0) {
			list.sort(compare);

			var maxpage = Math.ceil(list.length / (rows + 1));
			var end = ((this._page * (rows + 1)) + (rows + 1));
			var itemcount = 0;
			if (end &gt; list.length) end = list.length;
			for (var i = (this._page * (rows + 1)); i &lt; end; i++) {
				curChoices[&quot;01_FINE-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i].index] = {
					text: list[i].text,
					alignment: &quot;LEFT&quot;,
					color: this._itemColor
				};
				itemcount += 1;
			}

			curChoices[&quot;94_SPACER&quot;] = &quot;&quot;;

			if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._page &gt; 0) {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}

			for (var i = 0; i &lt; ((rows) - itemcount); i++) {
				curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
			}

			if (this._lastChoice != &quot;&quot;) def = this._lastChoice;

		} else {
			text = expandDescription(&quot;[galcop-no-warrants]&quot;);
		}

		curChoices[&quot;97B_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen6-map&quot;,
			title: &quot;Outstanding Fines in Sector &quot; + (this._selectedGalaxy + 1),
			overlay: {
				name: &quot;bounty-gavel.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 7) { // most wanted detail
		var mw = worldScripts.BountySystem_MostWanted;
		var dl = mw._displayList;
		var itm = dl[this._selectedIndex];
		text = this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-pilot]&quot;), 10);
		var colText = this.$columnText(&quot;Cmdr. &quot; + itm.pilotName + &quot;, &quot; + itm.pilotDescription, 21);
		for (var i = 0; i &lt; colText.length; i++) {
			if (i != 0) text += this.$padTextRight(&quot;&quot;, 10);
			text += colText[i] + &quot;\n&quot;;
		}
		text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-shiptype]&quot;), 10) + itm.shipType + &quot;\n&quot;;
		text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-shipname]&quot;), 10) + itm.shipName + &quot;\n&quot;;
		text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-bounty]&quot;), 10) + formatCredits(itm.bounty, false, true) + &quot;\n\n&quot;;

		if (itm.lastVisibleSystem &gt;= 0) {
			var jmps = 0;
			var info = System.infoForSystem(galaxyNumber, itm.lastVisibleSystem);
			var rt = system.info.routeToSystem(info, (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
			if (rt &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
				var dist = rt.distance;
				jmps = rt.route.length - 1;
			} else {
				var dist = system.info.distanceToSystem(info);
			}
			var jmps2 = 0;
			var info2 = System.infoForSystem(galaxyNumber, itm.lastVisibleDestination);
			var rt2 = system.info.routeToSystem(info2, (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
			if (rt2 &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
				var dist2 = rt2.distance;
				jmps2 = rt2.route.length - 1;
			} else {
				var dist2 = system.info.distanceToSystem(info2);
			}

			var rt3 = info.routeToSystem(info2, (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));

			text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-lastseen]&quot;), 10) +
				System.systemNameForID(itm.lastVisibleSystem) + &quot; (&quot; + govs[info.government] + spc +
				&quot;TL&quot; + (info.techlevel + 1) + &quot;, &quot; + dist.toFixed(1) + &quot;ly&quot; + (jmps &gt; 0 ? &quot;, &quot; + jmps + &quot; jump&quot; + (jmps &gt; 1 ? &quot;s&quot; : &quot;&quot;) : &quot;&quot;) +
				(rt &amp;&amp; jmps &gt; 0 &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) ? &quot;, &quot; + rt.time.toFixed(1) + &quot; hrs&quot; : &quot;&quot;) +
				&quot;)\n&quot;;
			var upd = this.$getTimeSince(itm.updated, false);
			//log(this.name, &quot;check time &quot; + itm.updated + &quot; -- &quot; + clock.clockStringForTime(itm.updated));
			text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-updated]&quot;), 10) + this.$adjustTime(clock.clockStringForTime(itm.updated)) +
				&quot; (&quot; + (upd !== &quot;&quot; ? upd + &quot; ago&quot; : &quot;just now&quot;) + &quot;)\n&quot;;

			if (player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot; &amp;&amp; itm.departureTime &lt; clock.adjustedSeconds) {
				var arr = itm.departureTime + (rt3.time * 3600);
				text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-lastseendest]&quot;), 10) +
					System.systemNameForID(itm.lastVisibleDestination) + &quot; (&quot; + govs[info2.government] + spc +
					&quot;TL&quot; + (info2.techlevel + 1) + &quot;, &quot; + dist2.toFixed(1) + &quot;ly&quot; + (jmps2 &gt; 0 ? &quot;, &quot; + jmps2 + &quot; jump&quot; + (jmps2 &gt; 1 ? &quot;s&quot; : &quot;&quot;) : &quot;&quot;) +
					(rt2 &amp;&amp; jmps2 &gt; 0 &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) ? &quot;, &quot; + rt2.time.toFixed(1) + &quot; hrs&quot; : &quot;&quot;) +
					&quot;)\n&quot;;
				if (rt3) {
					text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-arrivetime]&quot;), 10) + this.$adjustTime(clock.clockStringForTime(arr));
					var timeIn = &quot;&quot;
					if (arr &lt; clock.adjustedSeconds) {
						timeIn = this.$getTimeSince(arr, false) + &quot; ago&quot;;
					} else {
						timeIn = &quot;In &quot; + this.$getTimeSince(clock.adjustedSeconds - (arr - clock.adjustedSeconds), false);
					}
					text += &quot; (&quot; + timeIn + &quot;)\n&quot;;
				}
			}

			if (player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
				if (mw._missionList.indexOf(itm.index) === -1) {
					curChoices[&quot;60_ADD~&quot; + itm.index] = {
						text: &quot;[galcop-mostwanted-add]&quot;,
						color: this._menuColor
					};
				} else {
					curChoices[&quot;61_REMOVE~&quot; + itm.index] = {
						text: &quot;[galcop-mostwanted-remove]&quot;,
						color: this._menuColor
					};
				}
			}
		} else {
			text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-updated]&quot;), 10) + &quot;N/A\n&quot;;
			text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-lastseen]&quot;), 10) + &quot;--unknown--\n&quot;;
		}
		text += &quot;\n&quot;;

		var hist = &quot;&quot;;
		if (player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
			for (var i = 0; i &lt; itm.lastVisibleHistory.length; i++) {
				if (itm.lastVisibleHistory[i] != null &amp;&amp; itm.lastVisibleHistory[i].hasOwnProperty(&quot;system&quot;) === true) {
					if (hist === &quot;&quot;) {
						hist = this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-history]&quot;), 10);
					} else {
						hist += this.$padTextRight(&quot;&quot;, 10);
					}
					hist += System.systemNameForID(itm.lastVisibleHistory[i].system) + &quot;, &quot; + this.$getTimeSince(itm.lastVisibleHistory[i].updated, false) + &quot; ago\n&quot;;
					hist += this.$padTextRight(&quot;&quot;, 11) + &quot;Destination: &quot; + System.systemNameForID(itm.lastVisibleHistory[i].destination) + &quot;\n&quot;;
				}
			}
			if (hist !== &quot;&quot;) text += hist;
		}
		if (itm.lastVisibleSystem &gt;= 0 &amp;&amp; itm.lastVisibleSystem != system.ID) {
			if (itm.departureTime &lt; clock.adjustedSeconds &amp;&amp; player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
				curChoices[&quot;52_VIEWCHART&quot;] = {
					text: &quot;[galcop-mostwanted-next]&quot;,
					color: this._menuColor
				};
				if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; this.$systemInCurrentPlot(itm.lastVisibleDestination) === false) {
					curChoices[&quot;96_SETCOURSE~&quot; + itm.lastVisibleDestination] = {
						text: expandDescription(&quot;[galcop-set-course]&quot;, {
							destination: System.systemNameForID(itm.lastVisibleDestination)
						}),
						color: this._menuColor
					};
				}
			} else {
				curChoices[&quot;52_VIEWCHART&quot;] = {
					text: &quot;[galcop-mostwanted-last]&quot;,
					color: this._menuColor
				};
				if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; this.$systemInCurrentPlot(itm.lastVisibleSystem) === false) {
					curChoices[&quot;96_SETCOURSE~&quot; + itm.lastVisibleSystem] = {
						text: expandDescription(&quot;[galcop-set-course]&quot;, {
							destination: System.systemNameForID(itm.lastVisibleSystem)
						}),
						color: this._menuColor
					};
				}
			}
		}

		if (player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
			curChoices[&quot;80_WAIT&quot;] = {
				text: &quot;[galcop-wait]&quot;,
				color: this._menuColor
			};
		}

		def = &quot;97C_CLOSE&quot;;
		curChoices[&quot;97C_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen7-map&quot;,
			title: &quot;Most Wanted - Details&quot;,
			overlay: {
				name: &quot;mw_badge.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 8) { // most wanted last seen map
		var mw = worldScripts.BountySystem_MostWanted;
		var dl = mw._displayList;
		var itm = dl[this._selectedIndex];
		// hold the player&#39;s destination
		var rtCurr = system.info.routeToSystem(System.infoForSystem(galaxyNumber, p.targetSystem));
		this._suspendedDestination = p.targetSystem;
		// override it for the display
		if (itm.lastVisibleDestination &gt;= 0 &amp;&amp; itm.lastVisibleDestination &lt;= 255 &amp;&amp;
			itm.departureTime &lt; clock.adjustedSeconds &amp;&amp;
			player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
			p.targetSystem = itm.lastVisibleDestination;
		} else {
			p.targetSystem = itm.lastVisibleSystem;
		}

		// put markers on the map
		mission.markSystem({
			system: itm.lastVisibleSystem,
			name: this.name,
			markerShape: &quot;MARKER_SQUARE&quot;,
			markerColor: &quot;whiteColor&quot;,
			markerScale: 2
		});
		this._markers.push(itm.lastVisibleSystem);

		if (player.ship.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot;) {
			if (itm.departureTime &lt; clock.adjustedSeconds) {
				mission.markSystem({
					system: itm.lastVisibleDestination,
					name: this.name,
					markerShape: &quot;MARKER_SQUARE&quot;,
					markerColor: &quot;whiteColor&quot;,
					markerScale: 3
				});
				this._markers.push(itm.lastVisibleDestination);
			}
			var colrs = [&quot;lightGrayColor&quot;, &quot;grayColor&quot;, &quot;darkGrayColor&quot;];
			for (var i = 0; i &lt; itm.lastVisibleHistory.length; i++) {
				if (itm.lastVisibleHistory[i] &amp;&amp; itm.lastVisibleHistory[i].hasOwnProperty(&quot;system&quot;) &amp;&amp; this._markers.indexOf(itm.lastVisibleHistory[i].system) === -1) {
					mission.markSystem({
						system: itm.lastVisibleHistory[i].system,
						name: this.name,
						markerShape: &quot;MARKER_SQUARE&quot;,
						markerColor: colrs[i],
						markerScale: 2
					});
					this._markers.push(itm.lastVisibleHistory[i].system);
				}
			}
		}

		text = &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;;
		var bg = &quot;LONG_RANGE_CHART&quot;;
		var info = System.infoForSystem(galaxyNumber, p.targetSystem);
		if (system.info.distanceToSystem(info) &lt; 7.4) {
			bg = &quot;SHORT_RANGE_CHART&quot;;
			text += &quot;\n\n&quot;;
		}
		var rt = system.info.routeToSystem(info, (bg === &quot;SHORT_RANGE_CHART&quot; ? p.routeMode : (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;)));
		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			if (p.targetSystem != system.ID) {
				if (rt &amp;&amp; rt.route.length &gt; 1) {
					text += this.$padTextRight(&quot;&quot;, jmpIndent) + expandDescription(&quot;[galcop-jumps]&quot;) + &quot; &quot; + (rt.route.length - 1);
				}
			}
			if (bg === &quot;LONG_RANGE_CHART&quot;) {
				if (this._routeMode === &quot;SHORTEST&quot;) {
					bg = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
					curChoices[&quot;90_SHORTEST&quot;] = {
						text: &quot;[galcop-short-route]&quot;,
						color: this._disabledColor,
						unselectable: true
					};
					curChoices[&quot;91_QUICKEST&quot;] = {
						text: &quot;[galcop-quick-route]&quot;,
						color: this._menuColor
					};
				} else {
					bg = &quot;LONG_RANGE_CHART_QUICKEST&quot;;
					curChoices[&quot;90_SHORTEST&quot;] = {
						text: &quot;[galcop-short-route]&quot;,
						color: this._menuColor
					};
					curChoices[&quot;91_QUICKEST&quot;] = {
						text: &quot;[galcop-quick-route]&quot;,
						color: this._disabledColor,
						unselectable: true
					};
				}
			}
		}
		if (p.targetSystem != system.ID &amp;&amp; (!rtCurr || rtCurr.route.indexOf(p.targetSystem) === -1) &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			curChoices[&quot;96_SETCOURSE~&quot; + p.targetSystem] = {
				text: expandDescription(&quot;[galcop-set-course]&quot;, {
					destination: System.systemNameForID(p.targetSystem)
				}),
				color: this._menuColor
			};
		}

		curChoices[&quot;97D_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};
		def = &quot;97D_CLOSE&quot;;

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen8-map&quot;,
			title: &quot;Course to Last Known Location&quot;,
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 9) { // location of fine system
		var itm = this._offences[this._selectedItem];
		// hold the player&#39;s destination
		var rtCurr = system.info.routeToSystem(System.infoForSystem(galaxyNumber, p.targetSystem));
		this._suspendedDestination = p.targetSystem;
		// override it for the display
		p.targetSystem = itm.system;

		var bg = &quot;LONG_RANGE_CHART&quot;;
		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			if (itm.system != system.ID) {
				var rt = system.info.routeToSystem(System.infoForSystem(galaxyNumber, itm.system), (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));
				if (rt &amp;&amp; rt.route.length &gt; 1) {
					text = &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot; + this.$padTextRight(&quot;&quot;, jmpIndent) + expandDescription(&quot;[galcop-jumps]&quot;) + &quot; &quot; + (rt.route.length - 1);
				}
			}
			if (this._routeMode === &quot;SHORTEST&quot;) {
				bg = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
				curChoices[&quot;90_SHORTEST&quot;] = {
					text: &quot;[galcop-short-route]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
				curChoices[&quot;91_QUICKEST&quot;] = {
					text: &quot;[galcop-quick-route]&quot;,
					color: this._menuColor
				};
			} else {
				bg = &quot;LONG_RANGE_CHART_QUICKEST&quot;;
				curChoices[&quot;90_SHORTEST&quot;] = {
					text: &quot;[galcop-short-route]&quot;,
					color: this._menuColor
				};
				curChoices[&quot;91_QUICKEST&quot;] = {
					text: &quot;[galcop-quick-route]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}
		if (itm.system != system.ID &amp;&amp; (!rtCurr || rtCurr.route.indexOf(itm.system) === -1) &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			curChoices[&quot;96_SETCOURSE~&quot; + itm.system] = {
				text: expandDescription(&quot;[galcop-set-course]&quot;, {
					destination: System.systemNameForID(itm.system)
				}),
				color: this._menuColor
			};
		}

		curChoices[&quot;97E_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};
		def = &quot;97E_CLOSE&quot;;

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen9-map&quot;,
			title: &quot;Course to Offence System&quot;,
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 10) { // collect bounty receipts
		var mw = worldScripts.BountySystem_MostWanted;
		var lines = [];
		var total = 0;
		lines.push(this.$padTextRight(&quot;Name&quot;, 23) + this.$padTextLeft(&quot;Bonus Payment&quot;, 8));
		lines.push(&quot;&quot;);
		// work out the amount of the receipts
		// bonus for difficulty (based on accuracy)
		for (var i = 0; i &lt; mw._completed.length; i++) {
			var itm = mw._completed[i];
			var amt = 0;
			var pct = 0;
			switch (itm.primaryRole) {
				case &quot;trader&quot;:
				case &quot;trader-courier&quot;:
				case &quot;trader-smuggler&quot;:
					pct = 0.05;
					break;
				case &quot;hunter&quot;:
				case &quot;hunter-medium&quot;:
				case &quot;hunter-heavy&quot;:
					pct = 0.1;
					break;
				case &quot;pirate&quot;:
				case &quot;pirate-light-freighter&quot;:
				case &quot;pirate-medium-freighter&quot;:
				case &quot;pirate-heavy-freighter&quot;:
					pct = 0.2;
					break;
				case &quot;assassin-light&quot;:
				case &quot;assassin-medium&quot;:
				case &quot;assassin-heavy&quot;:
					pct = 0.15;
					break;
			}
			pct += itm.accuracy / 50;
			amt = parseInt(itm.realBounty * pct);
			total += amt;
			var colText = this.$columnText(itm.pilotName + &quot;, &quot; + itm.pilotDescription, 21);
			for (var j = 0; j &lt; colText.length; j++) {
				var lineText = this.$padTextRight(colText[j], 21);
				if (j === 0) lineText += this.$padTextLeft(formatCredits(amt, true, true), 10);
				lines.push(lineText);
			}
		}
		if (lines.length &gt; 0) {
			var maxpage = Math.ceil(lines.length / (rows + 1));
			var end = ((this._page * (rows + 1)) + (rows + 1));
			var itemcount = 0;
			if (end &gt; lines.length) end = lines.length;
			for (var i = (this._page * (rows + 1)); i &lt; end; i++) {
				text += lines[i] + &quot;\n&quot;;
				itemcount += 1;
			}

			curChoices[&quot;94_SPACER&quot;] = &quot;&quot;;

			if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._page &gt; 0) {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}

		if (system.ID === this._galCopHQ[galaxyNumber]) {
			curChoices[&quot;97_CLAIM&quot;] = {
				text: expandDescription(&quot;[galcop-bounty-bonus-claim]&quot;, {
					amount: formatCredits(total, true, true)
				}),
				color: this._menuColor
			};
		} else {
			curChoices[&quot;97_CLAIM&quot;] = {
				text: expandDescription(&quot;[galcop-bounty-bonus-claim]&quot;, {
					amount: formatCredits(total, true, true)
				}) + &quot; (Only at GalCop HQ)&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}

		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};
		def = &quot;98_CLOSE&quot;;

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen10-map&quot;,
			title: &quot;Bounty Claim Receipts&quot;,
			overlay: {
				name: &quot;mw_badge.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};

	}

	if (this._displayType === 11) { // confirm appeal submission
		var itm = this._offences[this._selectedItem];
		var subitems = JSON.parse(itm.offenceList);
		var bounty = 0;
		if (itm.galaxy != galaxyNumber) {
			bounty = this.$calculateIntergalacticItemBounty(itm);
		} else {
			bounty = this.$calculateItemBounty(itm, itm.system);
		}
		var cost = (itm.severity * 2) * 400 + (subitems.length * 200);
		var hq = System.infoForSystem(galaxyNumber, this._galCopHQ[galaxyNumber]);
		var dist = system.info.distanceToSystem(hq);
		var time = Math.pow(dist / 2, 2);

		text = expandDescription(&quot;[galcop-appeal-confirm]&quot;, {
			amount: formatCredits(bounty, false, true),
			system: itm.systemName,
			date: this.$setDateSince(itm.date * 86400),
			eta: parseInt(time),
			cost: formatCredits(cost, false, true)
		});

		curChoices[&quot;01_YES&quot;] = {
			text: &quot;[galcop-appeal-yes]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;02_NO&quot;] = {
			text: &quot;[galcop-appeal-no]&quot;,
			color: this._menuColor
		};
		def = &quot;02_NO&quot;;

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen11-map&quot;,
			title: &quot;Confirm Appeal Submission&quot;,
			overlay: {
				name: &quot;galcop_logo.png&quot;,
				height: 546
			},
			allowInterrupt: false,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 12) { // bounty hunters noticeboard
		// bounty name, source name, date
		text = this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-bountyname]&quot;), 10) +
			this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-sourcename]&quot;), 10) +
			this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-date]&quot;), 7.25) + &quot;\n&quot;;
		var mw = worldScripts.BountySystem_MostWanted;
		var list = mw._hunterTips;
		list.sort(compareDateDesc);

		def = &quot;98_CLOSE&quot;;

		if (list.length &gt; 0) {
			var maxpage = Math.ceil(list.length / rows);
			var end = ((this._page * rows) + rows);
			var itemcount = 0;
			if (end &gt; list.length) end = list.length;
			for (var i = (this._page * rows); i &lt; end; i++) {
				curChoices[&quot;70_TIPS-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + i] = {
					text: this.$padTextRight((mw._missionList.indexOf(list[i].index) &gt;= 0 ? &quot;• &quot; : &quot;&quot;) + list[i].bountyName, 10) +
						this.$padTextRight(list[i].source, 10) +
						this.$padTextRight(this.$adjustTime(clock.clockStringForTime(list[i].createdDate)), 7.25),
					alignment: &quot;LEFT&quot;,
					color: this._itemColor
				};
				itemcount += 1;
			}

			curChoices[&quot;94_SPACER&quot;] = &quot;&quot;;
			for (var i = 0; i &lt; (rows - itemcount); i++) {
				curChoices[&quot;94_SPACER_&quot; + i] = &quot;&quot;;
			}

			if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;95_NEXT&quot;] = {
					text: &quot;[galcop-nextpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._page &gt; 0) {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;96_PREV&quot;] = {
					text: &quot;[galcop-prevpage]&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}

		def = &quot;98_CLOSE&quot;;
		curChoices[&quot;98_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen12-map&quot;,
			title: &quot;Bounty Hunter Noticeboard&quot; + (maxpage &gt; 1 ? &quot;: Page &quot; + (this._page + 1) + &quot; of &quot; + maxpage : &quot;&quot;),
			overlay: {
				name: &quot;mw_badge.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	if (this._displayType === 13) { // bounty hunter notice details
		var mw = worldScripts.BountySystem_MostWanted;
		var itm = mw._hunterTips[this._selectedIndex];
		text = this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-bountyname]&quot;) + &quot;:&quot;, 10);
		text += &quot;Cmdr. &quot; + itm.bountyName + &quot;\n&quot;;
		text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-sourcename]&quot;) + &quot;:&quot;, 10) + itm.source + &quot;\n&quot;;
		var upd = this.$getTimeSince(itm.createdDate, false);
		text += this.$padTextRight(expandDescription(&quot;[galcop-mostwanted-tips-date]&quot;) + &quot;:&quot;, 10) + this.$adjustTime(clock.clockStringForTime(itm.createdDate)) + &quot; (&quot; + (upd != &quot;&quot; ? upd + &quot; ago&quot; : &quot;just now&quot;) + &quot;)\n\n&quot;;
		text += this.$padTextRight(&quot;Notice:&quot;, 10);
		var colText = this.$columnText(itm.text, 21);
		for (var i = 0; i &lt; colText.length; i++) {
			if (i != 0) text += this.$padTextRight(&quot;&quot;, 10);
			text += colText[i] + &quot;\n&quot;;
		}

		def = &quot;97F_CLOSE&quot;;
		if (this._selectedIndex &lt; mw._hunterTips.length - 1) {
			curChoices[&quot;71_NEXTTIP&quot;] = {
				text: &quot;Next notice&quot;,
				color: this._itemColor
			};
		} else {
			curChoices[&quot;71_NEXTTIP&quot;] = {
				text: &quot;Next notice&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		if (this._selectedIndex &gt; 0) {
			curChoices[&quot;72_PREVTIP&quot;] = {
				text: &quot;Previous notice&quot;,
				color: this._itemColor
			};
		} else {
			curChoices[&quot;72_PREVTIP&quot;] = {
				text: &quot;Previous notice&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		curChoices[&quot;97F_CLOSE&quot;] = {
			text: &quot;[galcop-exit]&quot;,
			color: this._exitColor
		};

		var opts = {
			screenID: &quot;oolite-galcopsecoffice-screen13-map&quot;,
			title: &quot;Bounty Hunter Noticeboard - Details&quot;,
			overlay: {
				name: &quot;mw_badge.png&quot;,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] &amp;&amp; this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	mission.runScreen(opts, this.$secOfficeHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$secOfficeHandler = function (choice) {

	if (this._suspendedDestination) player.ship.targetSystem = this._suspendedDestination;
	this._suspendedDestination = null;
	this.$removeChartData();

	if (!choice) return;

	switch (mission.screenID) {
		case &quot;oolite-galcopsecoffice-screen0-map&quot;:
			this._lastChoice[0] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen1-map&quot;:
			this._lastChoice[1] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen2-map&quot;:
			this._lastChoice[2] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen3-map&quot;:
			this._lastChoice[3] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen4-map&quot;:
			this._lastChoice[4] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen5-map&quot;:
			this._lastChoice[5] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen6-map&quot;:
			this._lastChoice[6] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen7-map&quot;:
			this._lastChoice[7] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen8-map&quot;:
			this._lastChoice[8] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen9-map&quot;:
			this._lastChoice[9] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen10-map&quot;:
			this._lastChoice[10] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen11-map&quot;:
			this._lastChoice[11] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen12-map&quot;:
			this._lastChoice[12] = choice;
			break;
		case &quot;oolite-galcopsecoffice-screen13-map&quot;:
			this._lastChoice[13] = choice;
			break;
	}

	if (choice === &quot;01_VIEWSTD&quot;) {
		this._displayType = 1;
		this._page = 0;
	}
	if (choice === &quot;02_VIEWINTER&quot;) this._displayType = 2;
	if (choice === &quot;03_WANTED&quot;) {
		this._displayType = 3;
		this._page = 0;
	}
	if (choice === &quot;03_WANTED_BONUS&quot;) {
		this._displayType = 10;
		this._page = 0;
	}
	if (choice === &quot;04_GALCOPHQ&quot;) this._displayType = 4;
	if (choice === &quot;09_BOUNTY_TIPS&quot;) {
		this._displayType = 12;
		this._page = 0;
	}

	if (choice === &quot;02_NO&quot;) this._displayType = 5;
	if (choice === &quot;01_YES&quot;) {
		this._displayType = 5;
		var itm = this._offences[this._selectedItem];
		var subitems = JSON.parse(itm.offenceList);
		var cost = (itm.severity * 2) * 400 + (subitems.length * 200);
		var apl = {};
		var hq = System.infoForSystem(galaxyNumber, this._galCopHQ[galaxyNumber]);
		var dist = system.info.distanceToSystem(hq);
		apl[&quot;status&quot;] = &quot;in progress&quot;;
		apl[&quot;initiatedOn&quot;] = clock.adjustedSeconds;
		apl[&quot;completedBy&quot;] = clock.adjustedSeconds + (Math.pow(dist / 2, 2) * 3600); // a rough calculation of the time based on distance to HQ
		apl[&quot;data&quot;] = JSON.parse(JSON.stringify(itm)); // make a copy of the bounty details for reference
		apl[&quot;roles&quot;] = JSON.parse(JSON.stringify(player.roleWeights)); // grab a current copy of the player&#39;s roles
		this._appeals.push(apl);
		player.credits -= cost;
		player.consoleMessage(&quot;You appeal has been lodged. &quot; + formatCredits(cost, false, true) + &quot; has been deducted from your account.&quot;);
		// send an email confirmation
		var ga = worldScripts.GalCopAdminServices;
		if (ga) {
			//if (this._registrars[galaxyNumber] === &quot;&quot;) this._registrars[galaxyNumber] = expandDescription(&quot;%N [nom]&quot;);
			if (this._secOffClerk === &quot;&quot;) this._secOffClerk = expandDescription(&quot;%N [nom]&quot;);
			var msg = expandDescription(&quot;[galcop-appeal-email]&quot;, {
				system: itm.systemName,
				date: this.$setDateSince(itm.date * 86400),
				hq: System.systemNameForID(this._galCopHQ[galaxyNumber]),
				cost: formatCredits(cost, true, true),
				sender: this._secOffClerk
			});
			var w = worldScripts.EmailSystem;
			w.$createEmail({
				sender: &quot;GalCop Security Office&quot;,
				subject: &quot;Appeal Submission&quot;,
				date: global.clock.adjustedSeconds,
				message: msg,
				expiryDays: ga._defaultExpiryDays
			});
		}

	}

	if (choice.indexOf(&quot;01_FINE&quot;) &gt;= 0) {
		this._selectedItem = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		this._displayType = 5;
	}

	if (choice.indexOf(&quot;05_GAL&quot;) &gt;= 0) {
		this._selectedGalaxy = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		this._displayType = 6;
		this._page = 0;
	}

	if (choice.indexOf(&quot;50_MOSTWANTED&quot;) &gt;= 0) {
		this._selectedIndex = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		this._displayType = 7;
	}

	if (choice === &quot;52_VIEWCHART&quot;) this._displayType = 8;
	if (choice === &quot;53_VIEWCHART&quot;) this._displayType = 9;

	if (choice.indexOf(&quot;60_ADD&quot;) &gt;= 0) {
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		var mw = worldScripts.BountySystem_MostWanted;
		mw._missionList.push(idx);
		player.consoleMessage(&quot;Record has been added to manifest screen&quot;);
	}
	if (choice.indexOf(&quot;61_REMOVE&quot;) &gt;= 0) {
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		var mw = worldScripts.BountySystem_MostWanted;
		var lookup = mw._missionList.indexOf(idx);
		mw._missionList.splice(lookup, 1);
		player.consoleMessage(&quot;Record has been removed from manifest screen&quot;);
	}
	if (choice.indexOf(&quot;70_TIPS&quot;) &gt;= 0) {
		this._selectedIndex = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		this._displayType = 13;
	}
	if (choice === &quot;71_NEXTTIP&quot;) {
		this._selectedIndex += 1;
	}
	if (choice === &quot;72_PREVTIP&quot;) {
		this._selectedIndex -= 1;
	}

	if (choice === &quot;80_WAIT&quot;) {
		var mw = worldScripts.BountySystem_MostWanted;
		mw.$askWaitTime();
		return;
	}
	if (choice === &quot;90_PAYFINE&quot;) {
		var itm = this._offences[this._selectedItem];
		// calculate what the fine is
		var calc_fine = this.$calculateFine(itm);
		if (itm.system != system.ID) calc_fine *= (1 + this._galCopHQFineSurcharge);
		// set which screen will be shown on return
		this._displayType = 1;
		if (itm.galaxy != galaxyNumber) this._displayType = 6;
		if (player.credits &gt;= calc_fine) {
			// send a fine email
			var ga = worldScripts.GalCopAdminServices;
			if (ga) {
				var msg = expandDescription(&quot;[marked-for-fines-intro]&quot;, {
					fine: formatCredits(calc_fine, true, true)
				});
				if (itm.galaxy === galaxyNumber) {
					if (this.$calculateItemBounty(itm) &gt;= 50) {
						msg += expandDescription(&quot;[marked-for-fines-fugitive]&quot;);
					}
				} else {
					if (this.$calculateIntergalacticItemBounty(itm) &gt;= 50) {
						msg += expandDescription(&quot;[marked-for-fines-fugitive]&quot;);
					}
				}
				var w = worldScripts.EmailSystem;
				msg += expandDescription(&quot;[marked-for-fines-end]&quot;);
				w.$createEmail({
					sender: expandDescription(&quot;[marked-for-fines-sender]&quot;),
					subject: &quot;Fine payment&quot;,
					date: global.clock.adjustedSeconds,
					message: msg,
					expiryDays: ga._defaultExpiryDays
				});
			}
			player.credits -= calc_fine;
			// are there any transferred items that match this one? take a copy of the relevant data before we delete it
			var tfr = {
				bounty: itm.bounty,
				severity: itm.severity,
				galaxy: itm.galaxy,
				system: itm.system,
				systemName: itm.systemName,
				government: itm.government,
				date: itm.date
			};
			// delete the record
			this._offences.splice(this._selectedItem, 1);
			// remove any transferred offences
			this.$removeTransferredOffences(tfr);
			// update the players bounty
			this._changing = true;
			player.bounty = this.$calculateBounty(system.ID);
			this._changing = false;

		} else {
			player.consoleMessage(&quot;Insufficient credit to pay fine.&quot;);
		}
	}

	if (choice.indexOf(&quot;96_SETCOURSE&quot;) &gt;= 0) {
		var dest = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		if (dest &gt;= 0 &amp;&amp; dest &lt;= 255) {
			player.ship.targetSystem = dest;
			player.ship.infoSystem = player.ship.targetSystem;
		}
		player.consoleMessage(&quot;Course set for &quot; + System.systemNameForID(dest));
		switch (this._displayType) {
			case 5:
				this._displayType = 1;
				break;
			case 7:
				this._displayType = 3;
				break;
			case 8:
				this._displayType = 7;
				break;
			case 9:
				this._displayType = 5;
				break;
			default:
				this._displayType = 0;
				break;
		}
	}

	if (choice === &quot;97_APPEAL&quot;) this._displayType = 11;
	if (choice === &quot;97_CLAIM&quot;) {
		var mw = worldScripts.BountySystem_MostWanted;
		var total = 0;
		// work out the amount of the receipts
		// bonus for difficulty (based on accuracy)
		var txt = &quot;&quot;;
		for (var i = 0; i &lt; mw._completed.length; i++) {
			var itm = mw._completed[i];
			var amt = 0;
			var pct = 0;
			switch (itm.primaryRole) {
				case &quot;trader&quot;:
				case &quot;trader-courier&quot;:
				case &quot;trader-smuggler&quot;:
					pct = 0.05;
					break;
				case &quot;hunter&quot;:
				case &quot;hunter-medium&quot;:
				case &quot;hunter-heavy&quot;:
					pct = 0.1;
					break;
				case &quot;pirate&quot;:
				case &quot;pirate-light-freighter&quot;:
				case &quot;pirate-medium-freighter&quot;:
				case &quot;pirate-heavy-freighter&quot;:
					pct = 0.2;
					break;
				case &quot;assassin-light&quot;:
				case &quot;assassin-medium&quot;:
				case &quot;assassin-heavy&quot;:
					pct = 0.15;
					break;
			}
			pct += itm.accuracy / 50;
			amt = parseInt(itm.realBounty * pct);
			total += amt;
			txt += &quot; &quot; + formatCredits(amt, true, true) + &quot; for &quot; + itm.pilotName + &quot;, &quot; + itm.pilotDescription + &quot;\n&quot;;
		}
		player.credits += total;
		player.consoleMessage(&quot;You have been awarded &quot; + formatCredits(total, true, true))
		// send a fine email
		var w = worldScripts.EmailSystem;
		if (w) {
			var ga = worldScripts.GalCopAdminServices;
			ga.$setupRepNames(player.ship.dockedStation);
			var msg = expandDescription(&quot;[galcop-bounty-bonus-email]&quot;, {
				amount: formatCredits(total, true, true),
				data: txt,
				sender: ga._galCopBountyOfficer
			});
			w.$createEmail({
				sender: expandDescription(&quot;[galcop-bounty-sender]&quot;),
				subject: &quot;Bounty Bonus Claim&quot;,
				date: global.clock.adjustedSeconds,
				message: msg,
				expiryDays: ga._defaultExpiryDays
			});
		}
		mw._completed.length = 0;
		this._displayType = 0;
	}
	if (choice === &quot;90_SHORTEST&quot;) this._routeMode = &quot;SHORTEST&quot;;
	if (choice === &quot;91_QUICKEST&quot;) this._routeMode = &quot;QUICKEST&quot;;
	if (choice === &quot;95_NEXT&quot;) this._page += 1;
	if (choice === &quot;96_PREV&quot;) this._page -= 1;
	if (choice === &quot;97_CLOSE&quot;) this._displayType = 1;
	if (choice === &quot;97A_CLOSE&quot;) this._displayType = 6;
	if (choice === &quot;97B_CLOSE&quot;) this._displayType = 2;
	if (choice === &quot;97C_CLOSE&quot;) this._displayType = 3;
	if (choice === &quot;97D_CLOSE&quot;) this._displayType = 7;
	if (choice === &quot;97E_CLOSE&quot;) this._displayType = 5;
	if (choice === &quot;97F_CLOSE&quot;) this._displayType = 12;
	if (choice === &quot;98_CLOSE&quot;) this._displayType = 0;

	if (choice != &quot;99_EXIT&quot;) this.$showSecOffice();
}

//-------------------------------------------------------------------------------------------------------------
// adds an offence to the current run sheet
this.$addOffence = function (offenceType) {
	if (this._debug) log(this.name, &quot;adding offence: &quot; + offenceType);
	// have we added this offence already?
	if (this._holdingDate === 0) this._holdingDate = clock.days;
	if (this._holding.indexOf(offenceType) === -1) {
		this._holding.push(offenceType);
		// update the severity of the current set of offences
		var sev = this._offenceTypes[offenceType].severity;
		if (sev &amp;&amp; sev &gt; this._severity) {
			this._severity = sev;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// removes any transferred bounties when the original one is paid off
this.$removeTransferredOffences = function (offenceItem) {
	for (var i = this._offences.length - 1; i &gt;= 0; i--) {
		var itm = this._offences[i];
		if (itm.date === offenceItem.date &amp;&amp;
			itm.severity === offenceItem.severity &amp;&amp;
			itm.bounty === offenceItem.bounty &amp;&amp;
			itm.transferred === true)
			this._offences.splice(i, 1);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$anarchiesBountyCalcOverride = function () {
	// this function intentionally left blank...
}

//-------------------------------------------------------------------------------------------------------------
this.$simulatorRunning = function () {
	var w = worldScripts[&quot;Combat Simulator&quot;];
	var result = false;
	if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) result = true;
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if item can be paid off, otherwise false
this.$itemIsPayable = function (offenceItem) {
	var payableIn = this._severityMatrix[offenceItem.severity].payableIn;
	if ((offenceItem.date + payableIn) &lt;= global.clock.days) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns the number of days left until the item can be paid off
this.$daysUntilPayable = function (offenceItem) {
	var payableIn = this._severityMatrix[offenceItem.severity].payableIn;
	return parseInt((offenceItem.date + payableIn) - global.clock.days);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player has committed a crime in a given system, otherwise false
this.$playerIsCriminal = function (systemID) {
	for (var i = 0; i &lt; this._offences.length; i++) {
		if (this._offences[i].transferred === false &amp;&amp; this._offences[i].galaxy === galaxyNumber &amp;&amp; this._offences[i].system === systemID) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// adds transferable bounties to the current system
this.$uncoverBounties = function (source) {
	for (var i = 0; i &lt; this._offences.length; i++) {
		if (((this._offences[i].severity === 2 &amp;&amp; this._offences[i].galaxy === galaxyNumber) || this._offences[i].severity === 3) &amp;&amp; this._offences[i].transferred === false) {
			// make sure we haven&#39;t already transferred this offence locally
			if (this.$itemAlreadyTransferred(this._offences[i]) === false) {
				var itm = this._offences[i];
				this._offences.push({
					offenceList: itm.offenceList,
					bounty: itm.bounty,
					severity: itm.severity,
					galaxy: galaxyNumber,
					system: system.ID,
					systemName: system.info.name,
					government: system.info.government,
					date: itm.date,
					transferred: true,
					originatingSystem: itm.system,
					originatingGalaxy: itm.galaxy
				});
			}
		}
		// severity 1 crimes can be transferred at certain distances
		if (this._severity1Transfer === true &amp;&amp; this._offences[i].severity === 1 &amp;&amp; this._offences[i].galaxy === galaxyNumber &amp;&amp; this._offences[i].transferred === false) {
			var tfr = false;
			// check if the distance to the original offence is within the acceptable range
			var maxdist = this._severityMatrix[this._offences[i].severity].transferLimit;
			var info = System.infoForSystem(galaxyNumber, this._offences[i].system);
			var dist = System.infoForSystem(galaxyNumber, system.ID).distanceToSystem(info);
			if (dist &lt;= maxdist) tfr = true;

			if (tfr === true) {
				// make sure we haven&#39;t already transferred this offence locally
				if (this.$itemAlreadyTransferred(this._offences[i]) === false) {
					var itm = this._offences[i];
					this._offences.push({
						offenceList: itm.offenceList,
						bounty: itm.bounty,
						severity: itm.severity,
						galaxy: galaxyNumber,
						system: system.ID,
						systemName: system.info.name,
						government: system.info.government,
						date: itm.date,
						transferred: true,
						originatingSystem: itm.system,
						originatingGalaxy: itm.galaxy
					});
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// checks if the item we&#39;re about the transfer has already be transferred to the current system
this.$itemAlreadyTransferred = function (offenceItem) {
	var result = false;

	for (var i = 0; i &lt; this._offences.length; i++) {
		if (this._offences[i].transferred === true &amp;&amp;
			this._offences[i].bounty === offenceItem.bounty &amp;&amp;
			this._offences[i].severity === offenceItem.severity &amp;&amp;
			this._offences[i].system === system.ID &amp;&amp;
			this._offences[i].galaxy === offenceItem.galaxy &amp;&amp;
			this._offences[i].date === offenceItem.date &amp;&amp;
			this._offences[i].offenceList === offenceItem.offenceList) {
			result = true;
			break;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// removes any zero bounty items from the array
this.$cleanUp = function () {
	for (var i = this._offences.length - 1; i &gt;= 0; i--) {
		if (this._offences[i].bounty === 0) this._offences.splice(i, 1);
	}
}

//-------------------------------------------------------------------------------------------------------------
// removes any bogus data that might end up hanging around
this.$resetBogusData = function () {
	// reset bogus data - holding items without any bountyDelta
	if ((this._holding.length &gt; 0 || this._severity &gt; 1) &amp;&amp; this._bountyDelta === 0) {
		this._holding.length = 0;
		this._holdingDate = 0;
		this._severity = 1;
	}
	// reset bogus data - bountyDelta without any holding item offences
	if (this._bountyDelta != 0 &amp;&amp; this._holding.length === 0) {
		this._bountyDelta = 0;
		this._severity = 1;
	}
	for (var i = this._offences.length - 1; i &gt;= 0; i--) {
		/*log(this.name, &quot;bounty &quot; + this._offences[i].bounty + 
			&quot;, tfr = &quot; + this._offences[i].transferred + 
			&quot;, severity = &quot; + this._offences[i].severity + 
			&quot;, orig sys = &quot; + this._offences[i].originatingSystem + 
			&quot;, sys = &quot; + this._offences[i].system +
			&quot;, orig gal = &quot; + this._offences[i].originatingGalaxy +
			&quot;, gal = &quot; + this._offences[i].galaxy);*/

		// make sure we don&#39;t have any dodgy entries in the list
		if (this._offences[i].severity === 0 || this._offences[i].offenceList === &quot;[]&quot;) this._offences.splice(i, 1);
	}
}

//-------------------------------------------------------------------------------------------------------------
// reduces bounty by an amount
this.$reduceBounty = function (amount, severity, systemID) {
	var remain = amount;
	for (var i = 0; i &lt; this._offences.length; i++) {
		var itm = this._offences[i];
		// only update non-transferred bounties
		if (itm.transferred === false) {
			if (severity === 1 &amp;&amp; itm.galaxy === galaxyNumber &amp;&amp; itm.system === systemID) {
				if (itm.severity === severity) {
					if (itm.bounty &lt; remain) {
						remain = remain - itm.bounty;
						itm.bounty = 0;
						this.$updateTransferredBounty(itm);
					} else {
						itm.bounty -= remain;
						this.$updateTransferredBounty(itm);
						remain = 0;
					}
				}
			}
			if (severity === 2 &amp;&amp; itm.galaxy === galaxyNumber) {
				if (itm.severity === severity) {
					if (itm.bounty &lt; remain) {
						remain = remain - itm.bounty;
						itm.bounty = 0;
						this.$updateTransferredBounty(itm);
					} else {
						itm.bounty -= remain;
						remain = 0;
						this.$updateTransferredBounty(itm);
					}
				}
			}
			if (severity === 3) {
				if (itm.severity === severity) {
					if (itm.bounty &lt; remain) {
						remain = remain - itm.bounty;
						itm.bounty = 0;
						this.$updateTransferredBounty(itm);
					} else {
						itm.bounty -= remain;
						this.$updateTransferredBounty(itm);
						remain = 0;
					}
				}
			}
		}
	}
	return remain;
}

//-------------------------------------------------------------------------------------------------------------
// updates any transferred bounties to match the original
this.$updateTransferredBounty = function (offenceItem) {
	for (var i = 0; i &lt; this._offences.length; i++) {
		var itm = this._offences[i];
		if (itm.date === offenceItem.date &amp;&amp;
			itm.severity === offenceItem.severity &amp;&amp;
			itm.bounty != offenceItem.bounty &amp;&amp;
			itm.transferred === true)
			itm.bounty = offenceItem.bounty;
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the calculated bounty value for the player in the current system
this.$calculateBounty = function (systemID) {
	var total = 0;
	for (var i = 0; i &lt; this._offences.length; i++) {
		var itm = this._offences[i];
		total += this.$calculateItemBounty(itm, systemID);
	}
	// check to see if the player has any active bounties in the current system
	if (systemID === this._system &amp;&amp; this._bountyDelta != 0) total += this._bountyDelta;
	return parseInt(total);
}

//-------------------------------------------------------------------------------------------------------------
// returns the calculated bounty value for a particular offence
this.$calculateItemBounty = function (offenceItem, systemID) {
	var bounty = 0;
	var sysID = (systemID ? systemID : system.ID);
	// because we making a copy of warrants when the player is scanned, basically if the galaxy and system ID match, this is visible
	if (offenceItem.system === sysID &amp;&amp; offenceItem.galaxy === galaxyNumber &amp;&amp; (offenceItem.transferred === false ||
			(offenceItem.transferred === true &amp;&amp; (offenceItem.originatingSystem != sysID || offenceItem.originatingGalaxy != galaxyNumber))))
		bounty = offenceItem.bounty;
	return bounty;
}

//-------------------------------------------------------------------------------------------------------------
// calculates the intergalactic bounty on a particular item
this.$calculateIntergalacticItemBounty = function (offenceItem) {
	if (offenceItem.severity === 3) {
		return offenceItem.bounty;
	} else {
		return 0;
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the calculated intergalactic bounty value for the player
this.$calculateIntergalacticBounty = function (galNum) {
	var total = 0;
	for (var i = 0; i &lt; this._offences.length; i++) {
		var itm = this._offences[i];
		if (itm.galaxy === galNum &amp;&amp; itm.transferred === false) {
			total += this.$calculateIntergalacticItemBounty(itm);
		}
	}
	return parseInt(total);
}

//-------------------------------------------------------------------------------------------------------------
// calculates the bounty fine to pay on a particular item
this.$calculateFine = function (offenceItem) {
	var gov = 0;
	var calc_fine = 0;
	if (offenceItem.system === -1) {
		gov = 1;
	} else {
		gov = offenceItem.government;
	}
	calc_fine = 50 + ((gov &lt; 2 || gov &gt; 5) ? 50 : 0);
	calc_fine *= this.$degradeBounty(offenceItem);
	// check for a minimum fine payment
	if (calc_fine &lt; 50) calc_fine = 50;
	return calc_fine;
}

//-------------------------------------------------------------------------------------------------------------
// degrade the bounty for fine calculations
this.$degradeBounty = function (offenceItem) {
	var b = offenceItem.bounty;
	// degrade the bounty by time since offence
	var degrade = this._severityMatrix[offenceItem.severity].degradeRate;
	var timeframe = (global.clock.days - offenceItem.date);
	b -= (timeframe * degrade);
	return (parseInt(b) &gt; 0 ? parseInt(b) : 0);
}

//-------------------------------------------------------------------------------------------------------------
this.$clearTransferredBounties = function () {
	for (var i = this._offences.length - 1; i &gt;= 0; i--) {
		var item = this._offences[i];
		if (item.transferred === true &amp;&amp; item.originatingGalaxy != galaxyNumber) {
			this._offences.splice(i, 1);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$checkAppealStatus = function (item) {
	var result = &quot;none&quot;;
	if (this._appeals.length &gt; 0) {
		for (var i = 0; i &lt; this._appeals.length; i++) {
			if (this._appeals[i].data.system === item.system &amp;&amp; this._appeals[i].data.date === item.date) result = this._appeals[i].status;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// find all police or main stations in range of ship
this.$findLawVessels = function (npc) {
	function _ships(entity) {
		return entity.isShip &amp;&amp; !(entity.isPlayer) &amp;&amp; (entity.isPolice || (entity.isStation &amp;&amp; entity.isMainStation));
	}
	return system.filteredEntities(this, _ships, npc, npc.scannerRange);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function () {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; // until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function (currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;…&quot;;
	var currentLength = defaultFont.measureString(currentText);
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1) {
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp === ellip) break;
		} while (defaultFont.measureString(tmp) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch === false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function (currentText, desiredLength) {
	return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
// arranges text into a array of strings with a particular column width
this.$columnText = function (originalText, columnWidth) {
	var returnText = [];
	if (defaultFont.measureString(originalText) &gt; columnWidth) {
		var hold = originalText;
		do {
			var newline = &quot;&quot;;
			var remain = &quot;&quot;;
			var point = hold.length;
			do {
				point = hold.lastIndexOf(&quot; &quot;, point - 1);
				newline = hold.substring(0, point).trim();
				remain = hold.substring(point + 1).trim();
			} while (defaultFont.measureString(newline) &gt; columnWidth);
			returnText.push(newline);
			if (remain != &quot;&quot;) {
				if (defaultFont.measureString(remain) &lt;= columnWidth) {
					returnText.push(remain);
					hold = &quot;&quot;;
				} else {
					hold = remain;
				}
			} else {
				hold = &quot;&quot;;
			}
		} while (hold != &quot;&quot;);
	} else {
		returnText.push(originalText);
	}
	return returnText;
}

//-------------------------------------------------------------------------------------------------------------
this.$adjustTime = function (itemTime) {
	return itemTime.substring(0, itemTime.length - 3);
}

//-------------------------------------------------------------------------------------------------------------
// returns a string containing the days, hours, minutes (and possibly seconds) since a particular time
this.$getTimeSince = function (lastTime, hoursOnly) {
	var diff = clock.adjustedSeconds - lastTime;
	var result = &quot;&quot;;
	if (diff &gt; 0) {
		var days = (hoursOnly &amp;&amp; hoursOnly === true ? 0 : Math.floor(diff / 86400));
		var hours = Math.floor((diff - (days * 86400)) / 3600);
		var mins = Math.floor((diff - (days * 86400 + hours * 3600)) / 60);
		var secs = Math.floor(diff - (days * 86400) - (hours * 3600) - (mins * 60));
		// special case - reduce 1 hour down to mins
		if (days === 0 &amp;&amp; hours === 1 &amp;&amp; mins &lt; 40) {
			hours = 0;
			mins += 60;
		}
		// special case - reduce 1 min down to secs
		if (days === 0 &amp;&amp; hours === 0 &amp;&amp; mins === 1 &amp;&amp; secs &lt; 40) {
			mins = 0;
			secs += 60;
		}
		if (hoursOnly &amp;&amp; hoursOnly === true &amp;&amp; mins &gt; 30 &amp;&amp; hours &gt; 1) hours += 1;
		if (days &gt; 0) result += days + &quot; days&quot;;
		if (hours &gt; 0) result += (result === &quot;&quot; ? &quot;&quot; : &quot; &quot;) + hours + &quot; hours&quot;;
		if ((hoursOnly == null || hoursOnly === false) || (hours === 0 &amp;&amp; mins &gt; 0)) {
			if (mins &gt; 0) result += (result === &quot;&quot; ? &quot;&quot; : &quot; &quot;) + mins + &quot; mins&quot;;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
this.$removeChartData = function () {
	if (this._markers.length &gt; 0) {
		for (var i = 0; i &lt; this._markers.length; i++) {
			mission.unmarkSystem({
				system: this._markers[i],
				name: this.name
			});
		}
	}
	this._markers.length = 0;
}

//-------------------------------------------------------------------------------------------------------------
this.$setDateSince = function (checkDate) {
	var testDate = new Date();
	testDate.setFullYear(3142, 2, 21);

	var secondsPassedTotal = checkDate - 2084004 * 86400.0;
	var hoursPassed = Math.floor(secondsPassedTotal / 3600);
	var minutesPassed = Math.floor((secondsPassedTotal % 3600) / 60);
	var secondsPassed = Math.floor(secondsPassedTotal % 60);

	testDate.setHours(hoursPassed);
	testDate.setMinutes(minutesPassed);
	testDate.setSeconds(secondsPassed);

	var months = [&#39;Jan&#39;, &#39;Feb&#39;, &#39;Mar&#39;, &#39;Apr&#39;, &#39;May&#39;, &#39;Jun&#39;, &#39;Jul&#39;, &#39;Aug&#39;, &#39;Sep&#39;, &#39;Oct&#39;, &#39;Nov&#39;, &#39;Dec&#39;];
	return testDate.getDay() + &quot; &quot; + months[testDate.getMonth()] + &quot; &quot; + testDate.getFullYear();
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the passes System ID is in the player&#39;s currently plotted course, otherwise false
this.$systemInCurrentPlot = function (sysID) {
	var result = false;
	var target = player.ship.targetSystem;

	if (oolite.compareVersion(&quot;1.81&quot;) &lt; 0) {
		// in 1.81 or greater, the target system could be more than 7 ly away. It becomes, essentially, the final destination.
		// there could be multiple interim stop points between the current system and the target system.
		// the only way to get this info is to recreate a route using the same logic as entered on the ANA, and pick item 1
		// from the list. That should be the next destination in the list.
		var myRoute = System.infoForSystem(galaxyNumber, global.system.ID).routeToSystem(System.infoForSystem(galaxyNumber, target), player.ship.routeMode);
		if (myRoute) {
			if (myRoute.route.indexOf(sysID) &gt;= 0) result = true;
		}
	} else {
		if (target === sysID) result = true;
	}

	return result;
}

//-------------------------------------------------------------------------------------------------------------
this.$changeSettings = function () {
	worldScripts.BountySystem_WarrantScanner._scannerMode = this._warrantScannerMode;
	// switch to passive (ie no hands!)
	var p = player.ship;
	var eqsts = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;);
	if (eqsts &amp;&amp; (eqsts == &quot;EQUIPMENT_OK&quot; || egsts == &quot;EQUIPMENT_DAMAGED&quot;)) {
		if (this._warrantScannerMode &gt;= 1) {
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER&quot;);
			p.awardEquipment(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
			p.setEquipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;, eqsts);
		}
		return;
	}
	eqsts = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
	if (eqsts &amp;&amp; (eqsts == &quot;EQUIPMENT_OK&quot; || egsts == &quot;EQUIPMENT_DAMAGED&quot;)) {
		if (this._warrantScannerMode &lt; 1) {
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
			p.awardEquipment(&quot;EQ_WARRANT_SCANNER&quot;);
			p.setEquipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;, eqsts);
		}
		return;
	}
	eqsts = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
	if (eqsts &amp;&amp; (eqsts == &quot;EQUIPMENT_OK&quot; || egsts == &quot;EQUIPMENT_DAMAGED&quot;)) {
		if (this._warrantScannerMode &gt;= 1) {
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
			p.awardEquipment(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
			p.setEquipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;, eqsts);
		}
		return;
	}
	eqsts = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
	if (eqsts &amp;&amp; (eqsts == &quot;EQUIPMENT_OK&quot; || egsts == &quot;EQUIPMENT_DAMAGED&quot;)) {
		if (this._warrantScannerMode &lt; 1) {
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
			p.awardEquipment(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
			p.setEquipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;, eqsts);
		}
		return;
	}	
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/bountysystem_npcscan.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;BountySystem_NPCScan&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2016 phkb&quot;;
this.description = &quot;Routines for NPC&#39;s using the Warrant scanning&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.$initialiseTimer = function (overrideFreq) {
	this.ship.script._debugNPCScan = false;
	this.ship.script._loggingLevel = 2;
	this.ship.script._rangeCheck = 0;

	// grab the scan time and range from the equipment info record
	// but only do this once - once we have the numbers we don&#39;t need to look them up again.
	if (!this.ship.script._warrantScannerTime) {
		if (this.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot;)
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER&quot;);
		if (this.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;) === &quot;EQUIPMENT_OK&quot;)
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);

		if (eq) {
			this.ship.script._warrantScannerTime = eq.scriptInfo.scan_time;
			this.ship.script._warrantScannerRange = this.ship.scannerRange * eq.scriptInfo.scan_range;
			this.ship.script._warrantScannerFrequency = eq.scriptInfo.npc_scan_frequency;
		}
	}

	if ((overrideFreq != null &amp;&amp; isNaN(overrideFreq) === false) || isNaN(this.ship.script._warrantScannerFrequency) === false) {
		// run a timer so that, at regular intervals, the NPC ship will consider doing a warrant scan
		this.ship.script._checkTimer = new Timer(this, this.ship.script.$checkScannerForTarget, (overrideFreq == null ? this.ship.script._warrantScannerFrequency : overrideFreq), 0);
		if (!this.ship.script._scannedList) this.ship.script._scannedList = [];
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$checkScannerForTarget = function $checkScannerForTarget() {

	// make sure we&#39;re still a valid entity
	if (!this.ship.isValid || !this.ship.isInSpace) return;

	// if we don&#39;t have the scanner or its damaged, we don&#39;t go any further
	if (this.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; this.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;) != &quot;EQUIPMENT_OK&quot;) {
		//log(this.name, &quot;!NOTE: Warrant Scanner equipment failure&quot;);
		return;
	}
	// the ship needs a valid AI to work
	if (this.ship.AIScript.name === &quot;Null AI&quot;) return;

	// free up the ship&#39;s target if it&#39;s still on the last target and we aren&#39;t fighting it
	//if (this.ship.script._lastTarget &amp;&amp; this.ship.script._lastTarget === this.ship.target &amp;&amp; this.ship.hasHostileTarget === false) this.ship.target = null;

	// if the ship already has a target don&#39;t do anything
	/*if (this.ship.target &amp;&amp; this.ship.target != this.ship.script._checkTarget) {
		if (this.ship.script._debugNPCScan &amp;&amp; this.ship.script._loggingLevel &gt; 1) log(this.name, &quot;ship already has target (&quot; + this.ship.target + &quot;) :&quot; + this.ship);
		this.ship.script.$initialiseTimer();
		return;
	}*/

	// don&#39;t do it under red alert condition
	if (this.ship.alertCondition === 3) {
		if (this.ship.script._debugNPCScan &amp;&amp; this.ship.script._loggingLevel &gt; 1) log(this.name, &quot;ship is under attack :&quot; + this.ship);
		this.ship.script.$initialiseTimer();
		return;
	}

	// random chance that the ship won&#39;t initiate a scan: 20% for police, 50% for bounty hunters
	if ((this.ship.isPolice &amp;&amp; Math.random() &gt; 0.8) || Math.random() &gt; 0.5) {
		if (this.ship.script._debugNPCScan &amp;&amp; this.ship.script._loggingLevel &gt; 1) log(this.name, &quot;ship decides not to scan :&quot; + this.ship);
		this.ship.script.$initialiseTimer(15);
		return;
	}

	// get a list of ships
	var ships = this.ship.checkScanner(true);

	// if there&#39;s no ships in range, try again later
	if (!ships || ships.length === 0) {
		this.ship.script.$initialiseTimer();
		return;
	}

	for (var i = 0; i &lt; ships.length; i++) {
		var found = false;
		if (this.ship.isPolice) {
			// police will only scan clean ships, and they won&#39;t scan pirates - they already know to attack them!
			if (ships[i].status === &quot;STATUS_IN_FLIGHT&quot; &amp;&amp; ships[i].bounty === 0 &amp;&amp; (Ship.roleIsInCategory(ships[i].primaryRole, &quot;oolite-assassin&quot;) || Ship.roleIsInCategory(ships[i].primaryRole, &quot;oolite-trader&quot;) || ships[i].isPlayer) &amp;&amp; this.ship.script._scannedList.indexOf(ships[i]) === -1) {
				found = true;
			}
		} else {
			// bounty hunters will scan pirates, looking to maximise their profits
			if (ships[i].status === &quot;STATUS_IN_FLIGHT&quot; &amp;&amp; (Ship.roleIsInCategory(ships[i].primaryRole, &quot;oolite-pirate&quot;) || Ship.roleIsInCategory(ships[i].primaryRole, &quot;oolite-assassin&quot;) || Ship.roleIsInCategory(ships[i].primaryRole, &quot;oolite-trader&quot;) || ships[i].isPlayer) &amp;&amp; this.ship.script._scannedList.indexOf(ships[i]) === -1) {
				found = true;
			}
		}
		if (found === true) {
			// we have a winner!
			if (this.ship.script._debugNPCScan &amp;&amp; this.ship.script._loggingLevel &gt;= 1) log(this.name, &quot;scan target selected :&quot; + this.ship);
			if (this.ship.script._debugNPCScan &amp;&amp; this.ship.script._loggingLevel &gt;= 1) log(this.name, &quot;target selected = &quot; + ships[i]);
			//this.ship.target = ships[i];
			this.ship.script._checkTarget = ships[i];
			this.ship.script._scanPass = 0;
			this.ship.script._warrantScannerTimer = new Timer(this, this.ship.script.$scanTarget, 1, 1);
			return;
		}
	}
	this.ship.script.$initialiseTimer();
}

//-------------------------------------------------------------------------------------------------------------
this.$scanTarget = function $scanTarget() {
	var that = $scanTarget; // pointer to this function
	var core = (that.core = that.core || worldScripts.BountySystem_Core); // cache worldScript reference in local property on this function
	var w = (that.w = that.w || worldScripts.BountySystem_WarrantScanner); // cache worldScript reference in local property on this function
	var npcscan = (that.npcscan = that.npcscan || worldScripts.BountySystem_NPCScan); // cache worldScript reference in local property on this function
	var bcc = (that.bcc = that.bcc || worldScripts.BroadcastCommsMFD); // cache worldScript reference in local property on this function
	var myShip = this.ship,
		myScript = myShip.script,
		myTarget = myScript._checkTarget;
	if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;running scanTarget :&quot; + myShip);
	// make sure ship is valid
	if (!myShip.isValid) {
		myScript._warrantScannerTimer.stop();
		return;
	}
	if (myShip.alertCondition === 3) {
		// ship is in a battle
		if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;ship in red alert - cancelling scan :&quot; + myShip);
		myScript._warrantScannerTimer.stop();
		myTarget = null;
		myScript.$initialiseTimer();
		return;
	}
	/*if (myShip.target != myTarget || !myTarget.isValid) {
		// somethings happened and their target has switched
		if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;target has shifted - cancelling scan :&quot; + myShip);
		myScript._warrantScannerTimer.stop();
		myTarget = null;
		myScript.$initialiseTimer();
		return;
	}*/
	// is target still valid
	var result = w.$targetIsValid(myShip);
	if (result) {
		// are we in range?
		if (w.$targetInRange(myShip)) {
			myScript._rangeCheck = 0;
			if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;scanning ship (&quot; + myTarget + &quot;) :&quot; + myShip);
			// ok, do a pass
			myScript._scanPass += 1;
			if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;pass &quot; + this._scanPass + &quot; :&quot; + myShip);
			if (myScript._scanPass === 1 &amp;&amp; myTarget.isPlayer) player.consoleMessage(expandDescription(&quot;[warrant-scan-detected]&quot;), 5);
			if (myScript._scanPass === 2 &amp;&amp; myTarget.isPlayer === false) w.$npcReaction(myTarget, myShip);
			// are we done?
			if (myScript._scanPass &gt;= myScript._warrantScannerTime) {
				myScript._warrantScannerTimer.stop();
				if (!myTarget.isPlayer || !core._alreadyScannedPlayerInThisSystem) { // only apply out-of-system bounties to the player once per system visit
					if (myTarget.isPlayer) core._alreadyScannedPlayerInThisSystem = true; // remember that we did this
					// ok, get the hidden bounty;
					if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;scan complete :&quot; + myShip);
					myScript._scannedList.push(myTarget);

					var initial = myTarget.bounty;
					var check = w.$checkBounty(myTarget, true, myShip); // returns sum of out-of-system bounties and imports any transferable bounties to the current system (this affects the calculation in shipWillDockWithStation that sets player bounty)
					if (check &gt; 0) { // an out-of-system bounty was found
						if (myTarget.isPlayer &amp;&amp; bcc &amp;&amp; bcc._surrenderBounty &gt; 0) { // player has a hidden bounty after surrendering to police with Broadcast Comms
							bcc._surrenderBounty += check; // add bounty amount to Broadcast Comms&#39; &quot;hidden&quot; value to be restored if the player commits another crime or doesn&#39;t go to the station
							if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt;= 1) log(this.name, &quot;bounty of &quot; + check + &quot; added to Broadcast Comms&#39; hidden bounty value for surrendered &quot; + myTarget);
						} else { // apply the bounty directly
							myTarget.bounty += check;
							if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt;= 1) log(this.name, &quot;bounty change of &quot; + (myTarget.bounty - initial) + &quot; for &quot; + myTarget);
						}
					}
				}

				// add this target to all vessels in range who have the same scan class
				npcscan.$addTargetToScannedList(myShip, myTarget); // call to worldScript function from ship-attached script

				myScript._lastTarget = myTarget;
				myTarget = null;
				myScript.$initialiseTimer();
			}
		} else {
			myScript._rangeCheck += 1;
			// try to move in range of target so we can continue scanning
			if (myShip.position.distanceTo(myTarget) &lt; (myShip.scannerRange * 1.3) &amp;&amp; myScript._rangeCheck &lt; 30) {
				if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;attempting to get in range :&quot; + myShip);
				myShip.destination = myTarget.position;
				myShip.desiredRange = myScript._warrantScannerRange - parseInt(Math.random * 1000) + 200;
				myShip.desiredSpeed = myShip.maxSpeed;
			} else {
				// give up if the distance is too great, or the range check counter times out
				if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;unable to get in range of target (timeout or distance too far) :&quot; + myShip);
				myScript._warrantScannerTimer.stop();
				//myShip.target = null;
				myTarget = null;
				myScript.$initialiseTimer();
			}
		}
	} else {
		if (myScript._debugNPCScan &amp;&amp; myScript._loggingLevel &gt; 1) log(this.name, &quot;target no longer valid :&quot; + myShip);
		myScript._warrantScannerTimer.stop();
		//myShip.target = null;
		myTarget = null;
		myScript.$initialiseTimer();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$addTargetToScannedList = function (source, target) {
	var ships = source.checkScanner(true);
	for (var i = 0; i &lt; ships.length; i++) {
		if (ships[i].scanClass === source.scanClass &amp;&amp; (ships[i].equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot; || ships[i].equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;) === &quot;EQUIPMENT_OK&quot;)) {
			ships[i].script._scannedList.push(target);
		}
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/bountysystem_scanner.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;BountySystem_WarrantScanner&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2016 phkb&quot;;
this.description = &quot;Routines for controlling the use of the Warrant scanner.&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

this._debug = false; // turns on debug messages in the log
this._warrantScannerTimer = null; // timer object used when scanning NPC&#39;s
this._hideMFDTimer = null; // timer used to hide the MFD after a scan completes
//this._scannedShips = [];		// list of ships scanned by the player
this._scanTimeMidPoint = 4; // point of time during a scan (in seconds) at which initial information is displayed. 
this._lastTarget = null; // holding object of player&#39;s target when scanning started (so we can check if the player switches target and stops the scan)
this._mfdID = -1; // ID of the MFD that last held the Warrant Scanner
this._outputMode = 0; // mode = 0 standard MFD view, mode = 1, no MFD
this._scannerMode = 0; // 0 = manual scan, 1 = automatic scan (offenders only), 2 = auto scan everyone
this._overrideMode = false;
this._giveToNPC = true; // flag to control whether NPC&#39;s can get the warrant scanner
this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];
this._ficcInstalled = false;

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	if (worldScripts.BountySystem_Core._disabled) {
		delete this.shipSpawned;
		delete this.playerBoughtEquipment;
		delete this.shipWillLaunchFromStation;
		delete this.startUpComplete;
		return;
	}
	// ensure station dock control has the important script properties noted
	var sdc = worldScripts.StationDockControl;
	if (sdc &amp;&amp; sdc._propertiesToKeep) {
		sdc._propertiesToKeep.push(&quot;_hiddenBounty&quot;);
		sdc._propertiesToKeep.push(&quot;_storedHiddenBounty&quot;);
	}

	if (missionVariables.BountySystem_WarrantScanAuto) {
		this._scannerMode = parseInt(missionVariables.BountySystem_WarrantScanAuto);
		worldScripts.BountySystem_Core._warrantScannerMode = this._scannerMode;
	}
	if (worldScripts.FuelInjectionCruiseControl) this._ficcInstalled = true;

	// add interface to HUD selector
	var h = worldScripts.hudselector;
	if (h) h.$HUDSelectorAddMFD(this.name, this.name);
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	missionVariables.BountySystem_WarrantScanAuto = this._scannerMode;
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillLaunchFromStation = function (station) {
	var equip = &quot;&quot;;
	var p = player.ship;
	if (p.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;) === &quot;EQUIPMENT_OK&quot;) equip = &quot;EQ_WARRANT_SCANNER&quot;;
	if (p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;) === &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;) === &quot;EQUIPMENT_OK&quot;) equip = &quot;EQ_WARRANT_SCANNER_POLICE&quot;;
	if (equip != &quot;&quot;) {
		var eq = EquipmentInfo.infoForKey(equip);
		p.script._warrantScannerTime = eq.scriptInfo.scan_time;
		p.script._warrantScannerRange = p.scannerRange * eq.scriptInfo.scan_range;
	}
	// if the player doesn&#39;t have a way of seeing the target bounty, put the scanner mode into override
	this._overrideMode = false;
	if (this._scannerMode === 1 &amp;&amp; p.equipmentStatus(&quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot;) != &quot;EQUIPMENT_OK&quot;) this._overrideMode = true;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function (equip) {
	var p = player.ship;
	// remove and refund warrant scanner (both versions)
	if (equip === &quot;EQ_WARRANT_SCANNER_REMOVAL&quot;) {
		p.removeEquipment(equip);
		var stn = p.dockedStation;
		var eqSts = &quot;&quot;;
		var eqSts1 = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;);
		if (eqSts1 === &quot;EQUIPMENT_OK&quot; || eqSts1 === &quot;EQUIPMENT_DAMAGED&quot;) {
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER&quot;);
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER&quot;);
			eqSts = eqSts1;
		}
		eqSts1 = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
		if (eqSts1 === &quot;EQUIPMENT_OK&quot; || eqSts1 === &quot;EQUIPMENT_DAMAGED&quot;) {
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;);
			eqSts = eqSts1;
		}
		var eqSts2 = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
		if (eqSts2 === &quot;EQUIPMENT_OK&quot; || eqSts2 === &quot;EQUIPMENT_DAMAGED&quot;) {
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
			eqSts = eqSts2;
		}
		eqSts2 = p.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
		if (eqSts2 === &quot;EQUIPMENT_OK&quot; || eqSts2 === &quot;EQUIPMENT_DAMAGED&quot;) {
			var eq = EquipmentInfo.infoForKey(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
			p.removeEquipment(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;);
			eqSts = eqSts2;
		}
		// refund the cost of the equipment
		if (eq) {
			if (eqSts === &quot;EQUIPMENT_OK&quot;) player.credits += (eq.price / 10) * stn.equipmentPriceFactor;
			if (eqSts === &quot;EQUIPMENT_DAMAGED&quot;) player.credits += ((eq.price / 10) * stn.equipmentPriceFactor) / 2;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipSpawned = function (newship) {
	if (newship.isShip === false) return;
	// ignore these types
	if (newship.isPlayer || newship.isRock || newship.isThargoid || newship.isCargo || newship.isDerelict || newship.isBeacon ||
		newship.isStation || newship.isBoulder || newship.isWeapon || newship.isWormhole || newship.isVisualEffect || !newship.isPiloted) return;
	// for some standard ships that gets spawned we want to create a secondary bounty value that the player can uncover using the warrant scanner
	// some assassins
	// some traders
	// rarely hunters
	// most pirates
	// no miners/scavengers
	// most of these increases will only be marginal (most 10 points, some 20, very few 30 and above)
	// if the ship already has the property, we can exit
	// this is most likely a relaunch at a station via SDC
	if (newship.script.hasOwnProperty(&quot;_hiddenBounty&quot;)) return;
	newship.script._hiddenBounty = 0;
	if (newship.isPolice === false) {
		if (Ship.roleIsInCategory(newship.primaryRole, &quot;oolite-pirate&quot;)) {
			if (Math.random() &gt; 0.2) {
				var b = parseInt(Math.random() * 10) + 10;
				// some larger bounties
				if (Math.random() &gt; 0.8) {
					b = parseInt(Math.random() * 20) + 30
				}
				// and rarely, some even larger ones
				if (Math.random() &gt; 0.95) {
					b = parseInt(Math.random() * 40) + 50
				}
				newship.script._hiddenBounty = b;
				if (this._debug) log(this.name, &quot;adding pirate bounty for &quot; + newship);
			}
		} else if (Ship.roleIsInCategory(newship.primaryRole, &quot;oolite-assassin&quot;)) {
			if (Math.random() &gt; 0.5) {
				var b = parseInt(Math.random() * 10) + 20;
				// rarely some larger bounties
				if (Math.random() &gt; 0.92) {
					b = parseInt(Math.random() * 20) + 40
				}
				// and even rarely, some even larger ones
				if (Math.random() &gt; 0.99) {
					b = parseInt(Math.random() * 40) + 50
				}
				newship.script._hiddenBounty = b;
				if (this._debug) log(this.name, &quot;adding assassin bounty for &quot; + newship);
			}
		} else if (Ship.roleIsInCategory(newship.primaryRole, &quot;oolite-trader&quot;)) {
			if (Math.random() &gt; 0.8 &amp;&amp; newship.name.indexOf(&quot;Medical&quot;) === 0) {
				newship.script._hiddenBounty = parseInt(Math.random() * 10) + 5;
				if (this._debug) log(this.name, &quot;adding trader bounty for &quot; + newship);
			}
		} else if (Ship.roleIsInCategory(newship.primaryRole, &quot;oolite-bounty-hunter&quot;)) {
			if (Math.random() &gt; 0.98) {
				newship.script._hiddenBounty = parseInt(Math.random() * 10) + 5;
				if (this._debug) log(this.name, &quot;adding hunter bounty for &quot; + newship);
			}
			// most hunters (60%) will have the warrant scanner
			if (this._giveToNPC === true) {
				if (Math.random() &gt; 0.4) {
					if (this._debug) log(this.name, &quot;adding equipment to &quot; + newship);
					newship.awardEquipment(&quot;EQ_WARRANT_SCANNER&quot;);
					this.$addScannerRoutines(newship);
				}
			}
		}
	}
	// store what the hidden bounty is in a separate spot so we can reset back to it if the ship jumps to another system
	// allows us to simulate the same rules the player gets
	newship.script._storedHiddenBounty = newship.script._hiddenBounty;

	// add our shipExitedWormhole, shipDied and shipRemoved events to the ship
	// monkey patch if necessary
	if (newship.script.shipExitedWormhole) newship.script.$bounty_ovr_shipExitedWormhole = newship.script.shipExitedWormhole;
	newship.script.shipExitedWormhole = this.$bounty_shipExitedWormhole;
	if (newship.script.shipDied) newship.script.$bounty_ovr_shipDied = newship.script.shipDied;
	newship.script.shipDied = this.$bounty_shipDied;
	if (newship.script.shipRemoved) newship.script.$bounty_ovr_shipRemoved = newship.script.shipRemoved;
	newship.script.shipRemoved = this.$bounty_shipRemoved;
	if (newship.script.shipWillEnterWormhole) newship.script.$bounty_ovr_shipWillEnterWormhole = newship.script.shipWillEnterWormhole;
	newship.script.shipWillEnterWormhole = this.$bounty_shipWillEnterWormhole;

	if (this._giveToNPC === true) {
		// only give it to police ships that are piloted, can actually move (ie not stations), and are not satellites.
		if (newship.isPolice &amp;&amp; newship.isPiloted &amp;&amp; newship.maxSpeed &gt; 0 &amp;&amp; newship.hasRole(&quot;RSsatellite&quot;) === false) {
			// all police vessels have the scanner
			if (this._debug) log(this.name, &quot;adding equipment to &quot; + newship);
			newship.awardEquipment(&quot;EQ_WARRANT_SCANNER_POLICE&quot;);
			this.$addScannerRoutines(newship);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentDamaged = function (equipmentKey) {
	// switch to override mode if the STE is damaged
	if (equipmentKey === &quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot; &amp;&amp; this._scannerMode === 1) this._overrideMode = true;
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentRepaired = function (equipmentKey) {
	// switch off override mode if the STE is repaired
	if (equipmentKey === &quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot; &amp;&amp; this._scannerMode === 1) this._overrideMode = false;
}

//-------------------------------------------------------------------------------------------------------------
this.shipTargetAcquired = function (target) {
	var ts = target.script;
	if (!ts) return;
	if (!player.ship.weaponsOnline &amp;&amp; !target.hasHostileTarget &amp;&amp; target.alertCondition !== 3) return; // don&#39;t auto-scan when weapons are offline, unless target won&#39;t react (has a hostile target or is in red alert)
	// if the scanner mode is set to automatically scan, and we haven&#39;t started scanning this ship, start it now
	if (ts.hasOwnProperty(&quot;_warrantScanPosition&quot;) === false) {
		// if the scanner mode is set to automatically scan, and we haven&#39;t started scanning this ship, start it now
		var doScan = false;
		switch (this._scannerMode) {
			//case 0:
				//if (player.ship.position.distanceTo(target) &lt; player.ship.script._warrantScannerRange) doScan = true;
				//break;
			case 1:
				if (target.bounty &gt; 0 || this._overrideMode === true) doScan = true;
				break;
			case 2:
				doScan = true;
				break;
		}
		if (doScan) {
			this.$startScan();
			return;
		}
	} else {
		// if we&#39;re already partway through scanning the target, automatically continue now
		if (ts._warrantScanPosition &gt;= 0 &amp;&amp; ts._warrantScanPosition &lt; player.ship.script._warrantScannerTime) {
			this.$startScan();
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.activated = function $activated() {
	var that = $activated; // pointer to this function
	var s = (that.s = that.s || worldScripts.BountySystem_WarrantScanner); // cache reference to worldScript in local property on this function
	if (s._warrantScannerTimer &amp;&amp; s._warrantScannerTimer.isRunning) {
		s._warrantScannerTimer.stop();
		if (s._outputMode === 0) s.$turnOffMFD();
		player.consoleMessage(&quot;Warrant scanner disengaged.&quot;);
		return;
	}

	// is the equipment OK?
	// theoretically the player can only have the standard scanner, but just in case the rules change later...
	if (player.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; player.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp;
		player.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER_PASSIVE&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; player.ship.equipmentStatus(&quot;EQ_WARRANT_SCANNER_POLICE_PASSIVE&quot;) != &quot;EQUIPMENT_OK&quot;) return;

	// do we have a station target and is it a main station?
	if (s.$targetIsValid(player.ship) === false) return;

	// automatically switch to Non-MFD mode if there are no available slots
	if (s._outputMode === 0 &amp;&amp; s.$isMFDSlotAvailable() === false) s._outputMode = 1;
	// TWEAK: automatically switch to MFD mode if there is an available slot (thanks to Nite Owl)
	if (s._outputMode === 1 &amp;&amp; s.$isMFDSlotAvailable() === true) s._outputMode = 0;

	var p = player.ship;

	// have we started scanning this ship already?
	var checkScan = s.$existingShipScanPosition(p.target);
	if (checkScan &gt;= p.script._warrantScannerTime) {
		if (s._outputMode === 1) player.consoleMessage(&quot;Ship already scanned.&quot;);
		if (s._outputMode === 0) {
			s.$updateMFD(&quot;Warrant Scanner:\nShip already scanned.&quot;);
			if (s._hideMFDTimer &amp;&amp; s._hideMFDTimer.isRunning) s._hideMFDTimer.stop();
			s._hideMFDTimer = new Timer(s, s.$turnOffMFD, 5, 0);
		}
		return;
	}
	if (s._outputMode === 1) player.consoleMessage(&quot;Scanning started.&quot;);

	s._warrantScannerTimer = new Timer(s, s.$scanProcess, 1, 1);
	s._lastTarget = p.target;
	if (s._hideMFDTimer &amp;&amp; s._hideMFDTimer.isRunning) s._hideMFDTimer.stop();
	if (s._outputMode === 0) s.$updateMFD(&quot;Warrant Scanner:\nInitialising...\n&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.mode = function $mode() {
	var that = $mode; // pointer to this function
	var s = (that.s = that.s || worldScripts.BountySystem_WarrantScanner); // cache reference to worldScript in local property on this function
	if (s._outputMode === 0) {
		s._outputMode = 1;
		player.consoleMessage(&quot;Switched to Non-MFD mode.&quot;);
		return;
	}
	if (s._outputMode === 1) {
		s._outputMode = 0;
		player.consoleMessage(&quot;Switched to MFD mode.&quot;);
		return;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$addScannerRoutines = function $addScannerRoutines(newship) {
	var that = $addScannerRoutines; // pointer to this function
	var w = (that.w = that.w || worldScripts.BountySystem_NPCScan); // cache reference to worldScript in local property on this function
	newship.script.$initialiseTimer = w.$initialiseTimer;
	newship.script.$checkScannerForTarget = w.$checkScannerForTarget;
	newship.script.$scanTarget = w.$scanTarget;
	newship.script.$initialiseTimer();
}

//-------------------------------------------------------------------------------------------------------------
this.$startScan = function () {
	if (this._hideMFDTimer &amp;&amp; this._hideMFDTimer.isRunning) this._hideMFDTimer.stop();
	if (this._warrantScannerTimer &amp;&amp; this._warrantScannerTimer.isRunning) this._warrantScannerTimer.stop();
	this.activated();
}

//-------------------------------------------------------------------------------------------------------------
this.$scanProcess = function $scanProcess() {
	var p = player.ship;

	// player switched target while scanning or target isn&#39;t valid anymore (jumped out/destroyed) - auto-off triggered
	if (p.target != this._lastTarget || this.$targetIsValid(p) === false) {
		player.consoleMessage(&quot;Warrant scanner disengaged.&quot;);
		if (this._outputMode === 0) this.$turnOffMFD();
		this._warrantScannerTimer.stop();
		return;
	}

	// add this ship to the array
	var scanPos = this.$existingShipScanPosition(p.target);
	//if (scanPos === 0) this._scannedShips.push({ship:p.target, scanPosition:0});

	var mfdText = &quot;Warrant Scanner:\n&quot;;
	var outOfRange = false;

	// make sure target is still in range - but put scan on hold until it is
	if (this.$targetInRange(p) === false) {
		mfdText += &quot;Ship out of range.\n&quot;;
		outOfRange = true;
	} else {
		scanPos += 1;
	}

	if (this._outputMode === 1 &amp;&amp; outOfRange === false) player.consoleMessage(((scanPos / p.script._warrantScannerTime) * 100).toFixed(0) + &quot;% complete&quot;);
	if (scanPos === p.script._warrantScannerTime) {
		mfdText += &quot;Scan complete.\n&quot;;
	} else {
		mfdText += &quot;Scanning: &quot; + ((scanPos / p.script._warrantScannerTime) * 100).toFixed(0) + &quot;% complete\n&quot;;
	}

	if (scanPos &gt;= this._scanTimeMidPoint) {
		var viewrole = this.$translateRole(p.target.primaryRole);
		mfdText += &quot;\nPilot: &quot; + this.$extractPilotName(p.target) + &quot;\n&quot; + (viewrole != &quot;Unknown&quot; ? viewrole + &quot;\n&quot; : &quot;&quot;);
		// only display the message once for consoleMessage mode
		if (this._outputMode === 1 &amp;&amp; scanPos === this._scanTimeMidPoint &amp;&amp; outOfRange === false) {
			player.consoleMessage(&quot;Pilot is &quot; + this.$extractPilotName(p.target) + (viewrole != &quot;Unknown&quot; ? &quot; (&quot; + viewrole + &quot;)&quot; : &quot;&quot;));
		}
	}

	p.target.script._warrantScanPosition = scanPos;
	// update the scan position for this ship
	/*for (var i = 0; i &lt; this._scannedShips.length; i++) {
		if (this._scannedShips[i].ship === p.target) this._scannedShips[i].scanPosition = scanPos;
	}*/

	// NPC reaction after 2 seconds
	if (scanPos === 2) {
		// decide if they will flee, attack or ignore
		this.$npcReaction(p.target, p);
	}

	// finish the scan
	if (scanPos &gt;= p.script._warrantScannerTime) {
		if (this._outputMode === 1) player.consoleMessage(&quot;Scan complete.&quot;);
		this._warrantScannerTimer.stop();
		// will this ship get a bounty?
		var check = this.$checkBounty(p.target, true, p);
		if (check &gt; 0) {
			mfdText += &quot;\nAdditional warrants of &quot; + formatCredits(check, false, true) + &quot;\napplied to target.&quot;;
			if (this._outputMode === 1) player.consoleMessage(&quot;Additional warrants of &quot; + formatCredits(check, false, true) + &quot; applied to target.&quot;);
			p.target.bounty += check;
		} else {
			if (this._outputMode === 1) player.consoleMessage(&quot;No additional warrants found for target.&quot;);
			mfdText += &quot;\nNo additional warrants\nfound for target.&quot;;
		}
		if (this._outputMode === 0) {
			if (this._hideMFDTimer &amp;&amp; this._hideMFDTimer.isRunning) this._hideMFDTimer.stop();
			this._hideMFDTimer = new Timer(this, this.$turnOffMFD, 10, 0);
		}
	}

	if (this._outputMode === 0) this.$updateMFD(mfdText);
}

//-------------------------------------------------------------------------------------------------------------
// checks if we have an MFD slot available (a blank spot or a slot currently allocated to this OXP. 
// Returns true if a spot is found, otherwise false
this.$isMFDSlotAvailable = function () {
	var p = player.ship;
	var result = false;
	for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
		if (!p.multiFunctionDisplayList[i] || (p.multiFunctionDisplayList[i] === &quot;&quot; || p.multiFunctionDisplayList[i] === this.name)) {
			result = true;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
this.$updateMFD = function (text) {
	var p = player.ship;

	// set the text in the MFD
	p.setMultiFunctionText(this.name, text, false);

	// if the hud is hidden don&#39;t try an update - it will get confusing as to which mfd slot is open or not.
	if (p.hudHidden === false) {
		// find the slot currently set for this MFD
		this.$findMFDID();

		// if we haven&#39;t got a set slot (this._mfdID === -1) or the set slot we had is now unavailable...
		if (this._mfdID === -1 ||
			(p.multiFunctionDisplayList[this._mfdID] &amp;&amp; p.multiFunctionDisplayList[this._mfdID] != &quot;&quot; &amp;&amp; p.multiFunctionDisplayList[this._mfdID] != this.name)) {
			// find a free slot
			// first, make sure we reset our slot id marker (in the case where the previous one is in use)
			this._mfdID = -1;
			// search for a free slot
			for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
				if (!p.multiFunctionDisplayList[i] || p.multiFunctionDisplayList[i] === &quot;&quot;) {
					this._mfdID = i;
					break;
				}
			}
		}

		// we have a free slot, so force the mfd to display
		if (this._mfdID != -1) p.setMultiFunctionDisplay(this._mfdID, this.name);
	}
}

//-------------------------------------------------------------------------------------------------------------
// records the index of the MFD that currently holds the warrant scanner mfd
this.$findMFDID = function () {
	var p = player.ship;
	if (p.isValid === false || !p.multiFunctionDisplayList) return;
	for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
		if (p.multiFunctionDisplayList[i] === this.name) this._mfdID = i;
	}
}

//-------------------------------------------------------------------------------------------------------------
// hides all instances of the warrant scanner MFD
this.$turnOffMFD = function $turnOffMFD() {
	var p = player.ship;
	if (p.isValid === false || !p.multiFunctionDisplayList) return;
	for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
		if (p.multiFunctionDisplayList[i] === this.name) {
			p.setMultiFunctionDisplay(i, &quot;&quot;);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// gets a readable form of the pilot&#39;s name
this.$extractPilotName = function (ship) {
	var pilotName = &quot;&quot;;
	var pilot = ship.crew[0];
	pilotName = pilot.name + (this._outputMode === 1 ? &quot;, &quot; : &quot;\n&quot;) + pilot.description;
	return pilotName;
}

//-------------------------------------------------------------------------------------------------------------
// returns the scan position (ie. how far through the scan we have gotten) for a particular ship
this.$existingShipScanPosition = function (ship) {
	if (ship.script.hasOwnProperty(&quot;_warrantScanPosition&quot;) === false) ship.script._warrantScanPosition = 0;
	return ship.script._warrantScanPosition;
	/*
	for (var i = 0; i &lt; this._scannedShips.length; i++) {
		if (this._scannedShips[i].ship === ship) return this._scannedShips[i].scanPosition;
	}
	return 0;
	*/
}

//-------------------------------------------------------------------------------------------------------------
// checks the target of the source ship to ensure it is still valid. If so, returns true.
// when false, scanning process will stop
this.$targetIsValid = function (source) {

	var ship = (source.isPlayer ? source.target : source.script._checkTarget);
	var result = true;
	// do we have a station target and is it a main station?
	if (!ship || ship.isValid === false) {
		if (source.isPlayer) player.consoleMessage(&quot;No target selected.&quot;);
		result = false;
	}
	if (result === true &amp;&amp; ship.isStation) {
		if (source.isPlayer &amp;&amp; this._scannerMode == 0) player.consoleMessage(&quot;Scanner will not work on stations.&quot;);
		result = false;
	}
	if (result === true &amp;&amp; (ship.isPiloted === false || ship.isThargoid || ship.hasRole(&quot;escape-capsule&quot;))) {
		if (source.isPlayer &amp;&amp; this._scannerMode == 0) player.consoleMessage(&quot;No valid target selected.&quot;);
		result = false;
	}
	if (result === true &amp;&amp; (source.injectorsEngaged || (source.isPlayer &amp;&amp; this._ficcInstalled &amp;&amp; source.script._ficcEngaged === true) || source.torusEngaged === true)) {
		if (source.isPlayer) player.consoleMessage(&quot;Unable to scan at injector or torus speed.&quot;);
		result = false;
	}
	if (result === true &amp;&amp; source.isCloaked) {
		if (source.isPlayer) player.consoleMessage(&quot;Scanner will not work when cloaked.&quot;);
		result = false;
	}
	if (result === true &amp;&amp; ship.isCloaked) {
		if (source.isPlayer) player.consoleMessage(&quot;Scanner unable to target cloaked ship.&quot;);
		result = false;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// checks range to source&#39;s target. when in range, returns true
// otherwise false. When false, scan will continue but be on hold.
this.$targetInRange = function (source) {
	var ship = (source.isPlayer ? source.target : source.script._checkTarget);
	var dist = source.position.distanceTo(ship);
	if (source.script._debugNPCScan === true) log(this.name, &quot;dist to target = &quot; + dist + &quot; for &quot; + source);
	// are we too far away for a good scan?
	if (dist &gt; source.script._warrantScannerRange) {
		if (source.isPlayer) {
			if (this._outputMode === 1) player.consoleMessage(&quot;Ship out of range.&quot;);
		}
		return false;
	}
	return true;
}

//-------------------------------------------------------------------------------------------------------------
// checks the hidden bounty for a particular ship. doRemove will do an &quot;official&quot; search, in which case the ship will be removed from the list
// basically, once a ship has been scanned with the warrant scanner we don&#39;t want the ship to get scanned again and increase their bounty multiple times.
// so we remove it for an official scan.
this.$checkBounty = function $checkBounty (checkship, doRemove, source) {
	var bounty = 0;
	if (checkship.isPlayer) {
		// uncover the player&#39;s bounties
		var that = $checkBounty; // pointer to this function
		var w = (that.w = that.w || worldScripts.BountySystem_Core); // cache reference to worldScript in local property on this function
		w.$uncoverBounties(source);
		w.shipExitedWitchspace();
	} else {
		var idx = -1;
		bounty = checkship.script._hiddenBounty;
		// if this is an official scan, reset the ships hiddenBounty value so they don&#39;t get multiple bounty increases
		if (doRemove === true &amp;&amp; bounty &gt; 0) checkship.script._hiddenBounty = 0;
	}
	return bounty;
}

//-------------------------------------------------------------------------------------------------------------
// updates the hidden bounty for a particular ship, or adds it if the ship isn&#39;t in the list already
this.$setBounty = function (checkship, newbounty) {
	checkship.script._hiddenBounty = newbounty;
}

//-------------------------------------------------------------------------------------------------------------
this.$npcReaction = function (ship, source) {
	// don&#39;t do anything if the ship is under attack or at condition red - they&#39;re too busy to notice
	if (ship.hasHostileTarget || ship.alertCondition === 3) return;

	// check if they&#39;ve got something to hide
	var check = this.$checkBounty(ship, false, source);
	if (check === 0) return;

	// count up the number of ships in range that might be doing the scan
	var ships = ship.checkScanner(true);
	var inRange = 0;
	if (ships) {
		for (var i = 0; i &lt; ships.length; i++) {
			var groupMbr = false;
			// check if this ship is actually a member of the same group as the target
			if (ships[i].group &amp;&amp; ships[i].group.containsShip(ship)) groupMbr = true;

			if (ships[i].isPiloted === true &amp;&amp; ships[i].isStation === false &amp;&amp; ships[i].isThargoid === false &amp;&amp; groupMbr === false &amp;&amp;
				ship.position.distanceTo(ships[i]) &lt;= source.script._warrantScannerRange) inRange += 1;
		}
	}

	if (ship.equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;) === &quot;EQUIPMENT_OK&quot;) {
		// turn on the cloak to evade detection
		if (this._debug) log(this.name, &quot;cloaking &quot; + ship);
		ship.isCloaked = true;
	}

	// if there&#39;s only one ship in range, then it&#39;s obvious who the scanner is
	if (inRange === 1) {
		ship.target = source;
		if (source.isPolice === false &amp;&amp; ship.threatAssessment(false) &gt; source.threatAssessment(false) &amp;&amp; ship.withinStationAegis === false) {
			if (this._debug) log(this.name, &quot;attack mode(1) engaged for &quot; + ship + &quot; against &quot; + source);
			ship.performAttack();
			return;
		} else {
			if (this._debug) log(this.name, &quot;flee mode(1) engaged for &quot; + ship + &quot; against &quot; + source);
			ship.performFlee();
			return;
		}
	}

	// won&#39;t know who the perpetrator is if more than one ship in range
	if (inRange &gt; 1) return;
	// otherwise, they&#39;ll know exactly who it is

	// they&#39;re clear, but it&#39;s still not friendly
	// police will ignore
	// pirates will most likely attack
	// traders will sometimes attack or sometimes flee
	// assassins will attack
	// hunters will sometimes attack

	// if the one scanning is a police vessel, don&#39;t do anything.
	if (source.isPolice) return;

	if (Ship.roleIsInCategory(ship.primaryRole, &quot;oolite-pirate&quot;) &amp;&amp; Math.random() &gt; 0.8) {
		if (this._debug) log(this.name, &quot;attack mode(2) engaged for &quot; + ship + &quot; against &quot; + source);
		ship.target = source;
		ship.performAttack();
		return;
	}
	if (Ship.roleIsInCategory(ship.primaryRole, &quot;oolite-assassin&quot;) &amp;&amp; ship.withinStationAegis === false &amp;&amp; Math.random() &gt; 0.8) {
		if (this._debug) log(this.name, &quot;attack mode(3) engaged for &quot; + ship + &quot; against &quot; + source);
		ship.target = source;
		ship.performAttack();
		return;
	}
	if (Ship.roleIsInCategory(ship.primaryRole, &quot;oolite-trader&quot;) &amp;&amp; ship.withinStationAegis === false &amp;&amp; Math.random() &gt; 0.9 &amp;&amp; ship.threatAssessment(false) &gt; source.threatAssessment(false)) {
		if (this._debug) log(this.name, &quot;attack mode(4) engaged for &quot; + ship + &quot; against &quot; + source);
		ship.target = source;
		ship.performAttack();
		return;
	}
	if (Ship.roleIsInCategory(ship.primaryRole, &quot;oolite-trader&quot;) &amp;&amp; ship.withinStationAegis === false &amp;&amp; Math.random() &gt; 0.3) {
		if (this._debug) log(this.name, &quot;flee mode(2) engaged for &quot; + ship + &quot; against &quot; + source);
		ship.target = source;
		ship.performFlee();
		return;
	}
	if (Ship.roleIsInCategory(ship.primaryRole, &quot;oolite-bounty-hunter&quot;) &amp;&amp; ship.withinStationAegis === false &amp;&amp; Math.random() &gt; 0.98) {
		if (this._debug) log(this.name, &quot;attack mode(5) engaged for &quot; + ship + &quot; against &quot; + source);
		ship.target = source;
		ship.performAttack();
		return;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$translateRole = function (role) {
	switch (role) {
		case &quot;hunter&quot;:
		case &quot;hunter-medium&quot;:
		case &quot;hunter-heavy&quot;:
			return &quot;Known bounty hunter&quot;;
		case &quot;pirate&quot;:
		case &quot;pirate-light-fighter&quot;:
		case &quot;pirate-medium-fighter&quot;:
		case &quot;pirate-heavy-fighter&quot;:
		case &quot;pirate-light-freighter&quot;:
		case &quot;pirate-medium-freighter&quot;:
		case &quot;pirate-heavy-freighter&quot;:
		case &quot;pirate-aegis-raider&quot;:
		case &quot;pirate-interceptor&quot;:
		case &quot;ftzpirate&quot;:
			return &quot;Known pirate&quot;;
		case &quot;trader&quot;:
		case &quot;trader-courier&quot;:
		case &quot;trader-courier+&quot;:
		case &quot;trader-smuggler&quot;:
			return &quot;Known trader&quot;;
		case &quot;assassin-light&quot;:
		case &quot;assassin-medium&quot;:
		case &quot;assassin-heavy&quot;:
			return &quot;Known assassin&quot;;
		case &quot;police&quot;:
		case &quot;police-station-patrol&quot;:
		case &quot;police-witchpoint-patrol&quot;:
			return &quot;Known police officer&quot;;
	}
	return &quot;Unknown&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$bounty_shipExitedWormhole = function () {
	if (this.ship.script.$bounty_ovr_shipExitedWormhole) this.ship.script.$bounty_ovr_shipExitedWormhole;
	if (this.ship.script.hasOwnProperty(&quot;_hiddenBounty&quot;) === false) return;
	// if this ship got scanned and had its hidden bounty applied, remove and reset when we exit a wormhole
	this.ship.script._warrantScanPosition = 0;
	if (this.ship.script._storedHiddenBounty &gt; 0 &amp;&amp; this.ship.script._hiddenBounty === 0) {
		this.ship.bounty -= this.ship.script._storedHiddenBounty;
		if (this.ship.bounty &gt; 0) {
			// reset back to zero - assume any bounty in that system was local
			this.ship.bounty = 0;
			// then we need to determine if this ship has a local bounty in the new system as well
			if (Math.random() &gt; 0.4) {
				var sys = System.infoForSystem(galaxyNumber, this.ship.destinationSystem);
				switch (this.ship.primaryRole) {
					case &quot;trader&quot;:
						if (Math.random() &gt; 0.6) this.ship.setBounty(Math.ceil(Math.random() * 20), &quot;setup actions&quot;);
						break;
					case &quot;trader-smuggler&quot;:
					case &quot;trader-smuggler+&quot;:
						this.ship.setBounty(Math.ceil(Math.random() * 20), &quot;setup actions&quot;);
						if (this.ship.bounty &gt; this.ship.cargoSpaceCapacity * 2) {
							this.ship.bounty = this.ship.cargoSpaceCapacity * 2;
						}
						break;
					case &quot;pirate&quot;:
						this.ship.setBounty(20 + sys.government + (this.ship.group ? this.ship.group.count : 0) + Math.floor(Math.random() * 8), &quot;setup actions&quot;);
						break;
					case &quot;pirate-interceptor&quot;:
						this.ship.setBounty(50 + sys.government + Math.floor(Math.random() * 36), &quot;setup actions&quot;);
						break;
					case &quot;pirate-light-fighter&quot;:
					case &quot;pirate-medium-fighter&quot;:
					case &quot;pirate-heavy-fighter&quot;:
						this.ship.setBounty(20 + sys.government + Math.floor(Math.random() * 12), &quot;setup actions&quot;);
						break;
					case &quot;pirate-light-freighter&quot;:
					case &quot;pirate-medium-freighter&quot;:
					case &quot;pirate-heavy-freighter&quot;:
						this.ship.setBounty(60 + sys.government + Math.floor(Math.random() * 8), &quot;setup actions&quot;);
						break;
					case &quot;pirate-aegis-raider&quot;:
						this.ship.setBounty(50 + sys.government + Math.floor(Math.random() * 36), &quot;setup actions&quot;);
						break;
				}
			}
		}
		this.ship.script._hiddenBounty = this.ship.script._storedHiddenBounty;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$bounty_shipDied = function (whom, why) {
	if (this.ship.script.$bounty_ovr_shipDied) this.ship.script.$bounty_ovr_shipDied(whom, why);
	// clean up timers
	if (this.ship.script._checkTimer &amp;&amp; this.ship.script._checkTimer.isRunning) {
		this.ship.script._checkTimer.stop();
		delete this.ship.script._checkTimer;
	}
	if (this.ship.script._warrantScannerTimer &amp;&amp; this.ship.script._warrantScannerTimer.isRunning) {
		this.ship.script._warrantScannerTimer.stop();
		delete this.ship.script._warrantScannerTimer;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$bounty_shipRemoved = function (suppressDeathEvent) {
	if (this.ship.script.$bounty_ovr_shipRemoved) this.ship.script.$bounty_ovr_shipRemoved(suppressDeathEvent);
	// clean up timers
	if (this.ship.script._checkTimer &amp;&amp; this.ship.script._checkTimer.isRunning) {
		this.ship.script._checkTimer.stop();
		delete this.ship.script._checkTimer;
	}
	if (this.ship.script._warrantScannerTimer &amp;&amp; this.ship.script._warrantScannerTimer.isRunning) {
		this.ship.script._warrantScannerTimer.stop();
		delete this.ship.script._warrantScannerTimer;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$bounty_shipWillEnterWormhole = function () {
	if (this.ship.script.$bounty_ovr_shipWillEnterWormhole) this.ship.script.$bounty_ovr_shipWillEnterWormhole();
	// clean up timers
	if (this.ship.script._checkTimer &amp;&amp; this.ship.script._checkTimer.isRunning) {
		this.ship.script._checkTimer.stop();
		delete this.ship.script._checkTimer;
	}
	if (this.ship.script._warrantScannerTimer &amp;&amp; this.ship.script._warrantScannerTimer.isRunning) {
		this.ship.script._warrantScannerTimer.stop();
		delete this.ship.script._warrantScannerTimer;
	}
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
