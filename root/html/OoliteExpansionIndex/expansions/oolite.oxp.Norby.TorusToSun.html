<html>
    <head>
        <title>Expansion Torus To Sun Drive</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Torus To Sun Drive</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Reach the Sun faster due to your Torus works better far from planetary masses. Practical when an addon moved the Sun farther. Moreover provide 2x time forwarding anywhere at Torus speeds when your weapons are offline.</td>
                    <td>Reach the Sun faster due to your Torus works better far from planetary masses. Practical when an addon moved the Sun farther. Moreover provide 2x time forwarding anywhere at Torus speeds when your weapons are offline.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.TorusToSun</td>
                    <td>oolite.oxp.Norby.TorusToSun</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Torus To Sun Drive</td>
                    <td>Torus To Sun Drive</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.7</td>
                    <td>1.7</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/TorusToSun">http://wiki.alioth.net/index.php/TorusToSun</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/8/87/TorusToSun_1.7.oxz">https://wiki.alioth.net/img_auth.php/8/87/TorusToSun_1.7.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873353</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Torus%20To%20Sun%20Drive'>http://wiki.alioth.net/index.php/Torus%20To%20Sun%20Drive</a></p>
        <h3>TorusToSun_readme.txt</h3>
        <pre>Torus To Sun OXP

Your Torus Drive get an upgrade to reach the Sun faster if you buy Torus To Sun Drive for 500Cr.
Practical when an addon moved the Sun farther and if you travel to non-main stations also.

Your speed multiplier will be limited by the distance and mass of the nearest planetary object and can reach maximum 8 times of the original Torus Drive.

The built-in proximity detector will slow to 1x Torus speed when anything is arrive into scanner range. This is a help to do not miss Rock Hermits, but you still must press the slow key immediately if you want stop.

Multipliers over 2x need unpowered weapons. If you want to slow down at far objects like Giant Space Pizza then turn back your weapons in time to avoid overrun.

By unpowering your weapons (press the underscore key) a 2x time forwarding is applied in addition so your game clock will adjusting. When you reach the maximal Torus multiplier (8x) then forwarding will be inceased to 4x so your top speed is as if you have a 32x drive. In this way you can use Realistic Stars OXP where the Sun is 8 times farther and still arrive to the Sun in 2 minutes due to the very fast last part of the travel will compensate the slow start from the planet.

Combat MFD can display the multiplier if installed and is not damaged so no console messages printed in this case.


You can not leave the Sun as fast as you arrived due to the high gravity of this huge mass can help to keep up the high speed until the last moment when you fall into but will slow you strongly when you turn back to leave until you are near.

There are side effects what you must accept as feedbacks of the extreme speeds:
-the sky will shaking,
-the engine trails in the aft view will get left far behind you.

You can move the Sun farther in this addon also in Config/planetinfo.plist.


Instructions:

In Oolite v1.79 or later do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.
In Oolite v1.77 make a TorusToSun.oxp subfolder in your AddOns folder and unzip the .oxz file into the newly created subfolder.

License:

This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.


Changelog:
 2018.08.19. v1.7  Performance improvement when no speed bonus, thanks to tokugawa.
 2015.07.27. v1.6  Bugfix of increasing speed bonus after multiple jumps, thanks to avder.
 2015.05.18. v1.5  Slow to 1x Torus speed when anything is arrive into scanner range.
                   Speed multiplier is limited to 2x if weapons are online.
                   A 2x time forward is always available with offline weapons.
                   Maximal time forwarding is reduced to 4x (adjustable in torustosun.js).
                   Fixed timer stop.
 2014.08.03. v1.4  Speed is limited to 4x if weapons are online.
 2014.07.27. v1.3  Use the gravity of Sun to earn faster approach and slower leaving.
                   Use 8x time forwarding to earn 64x top speed (not TAF but adjustment).
 2014.07.26. v1.2  Nonlinear speed calculation.
                   Better handling of Additional planets.
                   Fix the ovelapping gravity if the distance is small between two planets.
 2014.07.24. v1.1  Equipment added.
 2014.07.23. v1.0  First release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TORUSTOSUN.html">Torus To Sun Drive</a></td>
                    <td>yes</td>
                    <td align="right">5000</td>
                    <td align="center">5+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/torustosun.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;torustosun&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2014 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;Reach the Sun faster.&quot;;

//http://aegidian.org/bb/viewtopic.php?f=6&amp;t=16704&amp;p=223460#p223405
//-start at 1x when you leave the masslock of planet,
//-increasing exponentially between the planet and sun up to 8x,
//-multipliers over 2x need unpowered weapons,
//-fall down to the base value before the sun,
//-limited to the max value if far from both the sun and planet.
//-unpowered weapons provide 2x time forwarding at torus speeds.

//customizable properties
this.$MaxWithWeapons = 2; //chop the bonus to be able to catch Space Pizzas
this.$MaxTimeFw = 4; //time forwarding at max. multiplier (adjustment, not TAF)
this.$Messages = true; //show messages about the current speed (but no messages with CombatMFD regardless of this)
this.$MessagesWithCombatMFD = false; //send Torus multiplier messages with combatMFD also
this.$TimeFwWeaponsOff = 2; //default time forwarding with offline weapons
this.$MaxMultiplier = 8; //*32*400m/s (Asp) almost fit into the 5 digit NumericHUD

//internal properties, should not touch
this.$TimeFw = 1; //actual time forwarding, checked in CombatMFD
this.$TorusToSunBonus = 1; //current speed multiplier, checked in CombatMFD
this.$DBonus = &quot;&quot;; //the lastly displayed speed multiplier
this.$DMore = false; //the lastly displayed more need offline weapons message
this.$FCB = null; //framecallback
this.$FwSec = 0; //part of a second during forwarding
this.$NearestPlanet = null; //store the nearest planet between rechecks
this.$PrevEnergy = 0; //previous energy value of player
this.$Timer = null; //Timer for Torus speedup
this.$WED = null; //the worldscript of EscortDeck
this.$WFP = null; //store worldScripts.farplanets

//world script events
this.startUp = function() {
	this.$WED = worldScripts.escortdeck;
	this.$WFP = worldScripts.farplanets;
//	var n = worldScripts.numerichudv3;
//	if( n &amp;&amp; n.version * 1 &gt;= 3.24 ) this.$Messages = false;
	this.$Timer = new Timer(this, this._Timed.bind(this), 1, 0.25);
	this._StopTimer(); //pause timer
}

this.alertConditionChanged = function(newCondition, oldCondition) {
//     log(&quot;alertConditionChanged&quot;, newCondition  + &quot;::&quot; + oldCondition)
       if (newCondition == 1)       {
               this._StartTimer();
       } else  {
               this._StopTimer();
       }
}

this.shipWillDockWithStation = function() {
	this._StopTimer();
}

this.shipWillEnterWitchspace = function() {
	this._StopTimer();
}

this.shipWillExitWitchspace = function() {
	this._StartTimer(); //must start before Telescope FCBs!
}

this.shipWillLaunchFromStation = function() {
	this._StartTimer(); //must start before Telescope FCBs!
}

//TorusToSun functions
this._FCB = function( delta ) { //masslockcheck in this framecallback
	var b = this.$TorusToSunBonus;
	var ps = player.ship;
	if( !ps ) return; //player is died
//	log(&quot;TorusToSun&quot;, &quot;speed: &quot;+Math.round(ps.speed)+&quot; velocity: &quot;+Math.round(ps.velocity.magnitude())); //debug
	if( player.alertCondition &gt; 1 || ps.speed &lt; ps.maxSpeed * 31.9 //not in full torus
		|| this.$WFP &amp;&amp; //FarPlanets OXP active
		( this.$WFP.$FarPlanetsSlowDown || this.$WFP.$FarPlanetsBonus &gt; 1 )
		|| this._Proximity(this) ) //turn off near asteroids
		 this._TorusSlowDown(); //do not apply TorusToSun
	if( !this.$SlowDown &amp;&amp; b &gt; 1 ) { //currently travel at bonus speeds
		var f = ps.vectorForward;
		var s = ps.maxSpeed * 32;
		var t = this.$TimeFw - 1; //torus speed with time forwarding
		ps.position = ps.position.add( f.multiply( delta * s * ( t + b - 1 ) ) ); //apply speed bonus
        } else {
                if( isValidFrameCallback( this.$FCB ) )
                       removeFrameCallback( this.$FCB );
        }
}

this._NearestMass = function(skip) {
	var d = 100000000000000000000.0; //10^20m for sure
	var psp = player.ship.position;
	var nm = null;
	var p = system.planets;
	var len = p.length;
	for( var i = 0; i &lt; len; i++ ) { //find the smallest distance
		var pl = p[i];
		if( pl != skip ) { //the second nearest if requested
			var s = psp.distanceTo( pl.position );
			if( d &gt; s ) {
				d = s;
				nm = pl;
			}
		}
	}
	return( nm );
}

this._Proximity = function(ws) { //there is a similar function in TimeControl oxp, if changed then must change both!
	var s = player.ship.checkScanner(false);
	for( var i = 0; s &amp;&amp; s.length &gt; i; i++ ) {  //exclude escorts and telescopemarker
		if( ws.$WED &amp;&amp; ws.$WED.$EscortDeckShip.indexOf(s[i]) == -1
			&amp;&amp; s[i].dataKey &amp;&amp; s[i].dataKey != &quot;telescopemarker&quot; ) {
			return(true);
		}
	}
	return(false);
}

this._StartTimer = function() {
	this.$PrevEnergy = player.ship.maxEnergy;
	this.$FwSec = 0; //part of a second during forwarding
	if( this.$Timer ) {
		this.$Timer.start();
	}
}

this._StopTimer = function() {
	if( this.$Timer ) {
		this.$Timer.stop();
	}
	if( isValidFrameCallback( this.$FCB ) )
		removeFrameCallback( this.$FCB );
	this._TorusSlowDown(); //set bonus to 1
}

this._Timed = function() {
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //player died
	if( player.alertCondition == 1 &amp;&amp; ps.speed &gt; ps.maxSpeed * 31.9 ) {//Green Alert and Torus maxed
		this._TorusSpeedUp();
		if( !isValidFrameCallback( this.$FCB ) )
		        this.$FCB = addFrameCallback( this._FCB.bind(this) );
	}
}

this._TimeFw = function( bonus ) { //use time forwarding at maximal bonus if weapons off
	if( bonus == this.$MaxMultiplier &amp;&amp; !player.ship.weaponsOnline ) return(true);
	return(false);
}

this._TorusSlowDown = function() { //slowdown from extreme speed to normal or Torus speeds
	if( this.$TorusToSunBonus &lt;= 1 ) return; //need to avoid block Injector speeds
	this.$PrevEnergy = player.ship.energy;
	this.$TorusToSunBonus = 1; //the main thing for slowdown
	this.$DBonus = &quot;&quot;;
	this.$DMore = false;
	this.$SlowDown = true; //flag to FCB
}

this._TorusSpeedUp = function() {
	var ps = player.ship;
	if( !ps || !ps.isValid || this.$WFP &amp;&amp; //FarPlanets OXP active
		( this.$WFP.$FarPlanetsSlowDown || this.$WFP.$FarPlanetsBonus &gt; 1 ))
		return;

	var bonus = 1;
	if( ps.equipmentStatus(&quot;EQ_TORUSTOSUN&quot;) == &quot;EQUIPMENT_OK&quot;
		&amp;&amp; system &amp;&amp; system.planets &amp;&amp; system.planets.length &gt; 0
		&amp;&amp; !system.isInterstellarSpace &amp;&amp; system.sun &amp;&amp; system.sun.isValid
		&amp;&amp; !system.sun.hasGoneNova ) {
		this.$SlowDown = false;
	
		var co = 1000; //coefficient, larger value cause smaller speeds
		var mm = this.$MaxMultiplier;

		var sr = system.sun.radius;
		var pds = ps.position.distanceTo( system.sun.position ) - sr; //playerDistanceFromSun
		//check sun direction and apply gravity pullback, angle=0: aft, angle=PI: front
		var angle = ps.vectorForward.angleTo(ps.position.subtract(system.sun.position));
		sr = Math.min(sr, 200000); //max. 200km in the following formula
		//keep up the high speed much longer when approach the sun
		var min = pds / ( 10000 + ( 1 - angle / Math.PI ) * sr *
			Math.max( 0, 1 - pds / ( 10 * sr ) ) ); //no gravity pullback over 10 sun radius
		bonus = 1 + (mm - 1) * Math.min( 1, min * min / co ); //nonlinear calculation

		var nm = this._NearestMass();
		var nr = Math.max(nm.radius, 50000); //min. 50k to reduce speeds near small moons
		var pdp = ps.position.distanceTo( nm.position ) - 2 * nr; //playerDistanceFromPlanet
		min = pdp / nr;
		var b1 = 1 + (mm - 1) * Math.min( 1, min * min / co ); //nonlinear calculation
		bonus = Math.min(b1, bonus); //use the smaller bonus
		
		var nm2 = this._NearestMass(nm); //the second nearest mass
		if( nm2 ) {
			var nr2 = Math.max(nm2.radius, 50000); //min. 50k to reduce speeds near small moons
			var pdp2 = ps.position.distanceTo( nm2.position ) - 2 * nr2; //playerDistanceFromPlanet2
			min = pdp2 / nr2;
			var b2 = 1 + (mm - 1) * Math.min( 1, min * min / co ); //nonlinear calculation
			bonus = Math.min(b2, bonus); //use the smallest bonus
		}
//		log(&quot;TorusToSun&quot;, &quot; bonus:&quot;+bonus+&quot; pdp:&quot;+pdp+&quot; pds:&quot;+pds+&quot; nm:&quot;+nm); //debug
	}
	
	if( ps.weaponsOnline ) bonus = Math.min(bonus, this.$MaxWithWeapons);

	if( bonus &gt; 1 ) { //show speed bonus, apply will happen in FCB
		var b = Math.round( bonus );
		if( this._TimeFw( bonus ) ) this.$TimeFw = this.$MaxTimeFw;
		else if( !ps.weaponsOnline ) this.$TimeFw = this.$TimeFwWeaponsOff; //2x
		else this.$TimeFw = 1; //no time forward with online weapons
		
		if( this.$TimeFw &gt; 1 ) {
			var delta = 0.25; //0.25sec timer
			//calculate the bonus time plus add the previous remainder
			var sec = delta * ( this.$TimeFw - 1 ) + this.$FwSec;
//			log(&quot;TorusToSun&quot;, &quot; bonus:&quot;+bonus+&quot; mm:&quot;+mm+&quot; sec:&quot;+sec); //debug
			if( sec &gt;= 1 ) {
				var maxsec = 2592000; //not allowed to add more sec in one step
				if( sec &lt; maxsec ) clock.addSeconds( Math.floor( sec ) ); //add the integer part
				else {
					var sec2 = Math.floor( sec / maxsec );
					for(var i=0; i&lt;sec2; i++) clock.addSeconds( maxsec );
					clock.addSeconds( sec - maxsec * sec2 );
				}
//				log(&quot;TorusToSun&quot;, this.$TimeFw+&quot;x added &quot;+sec+&quot;s = &quot;+(sec/86400)+&quot; day&quot;); //debug
				this.$FwSec = sec - Math.floor( sec ); //save the remainder
			} else this.$FwSec = sec;
			if( this.$PrevEnergy &lt; ps.energy &amp;&amp; ps.energy &lt; ps.maxEnergy - 1 ) {
				//recharge speed up scaled with forwarding
				ps.energy +=  ( ps.energy - this.$PrevEnergy ) * sec / delta;
			}
		}

		if( this.$Messages &amp;&amp; !this.$DMore &amp;&amp; ps.weaponsOnline
			&amp;&amp; bonus == this.$MaxWithWeapons ) {
			this.$DMore = &quot; - more need offline weapons&quot;;
			player.consoleMessage( &quot;Torus &quot; + b + &quot;x&quot; + this.$DMore, 5 );
		} else {
			if( this.$Messages &amp;&amp; this.$DBonus != b &amp;&amp; ( this.$MessagesWithCombatMFD
				|| ps.equipmentStatus(&quot;EQ_COMBATMFD&quot;) != &quot;EQUIPMENT_OK&quot; ) ) {
				player.consoleMessage( &quot;Torus &quot; + b + &quot;x&quot;, 5 );
			}
		}
		if( bonus &lt; this.$MaxWithWeapons) this.$DMore = false; //prevent repeated message
		this.$PrevEnergy = ps.energy;
		this.$TorusToSunBonus = bonus;
		this.$DBonus = b; //save last message to avoid repeat
	}  else this._TorusSlowDown(); //slowdown
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
