<html>
    <head>
        <title>Expansion Scanner Alerting Enhancement</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Scanner Alerting Enhancement</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Pre-emptive identification and alerting of new ships on the scanner.</td>
                    <td>Pre-emptive identification and alerting of new ships on the scanner.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.jh145.ScannerAlertingEnhancement</td>
                    <td>oolite.oxp.jh145.ScannerAlertingEnhancement</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Scanner Alerting Enhancement</td>
                    <td>Scanner Alerting Enhancement</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>jh145</td>
                    <td>jh145</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.1</td>
                    <td>1.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Scanner_Alerting_Enhancement">http://wiki.alioth.net/index.php/Scanner_Alerting_Enhancement</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/f/fc/ScannerAlertingEnhancement.oxz">https://wiki.alioth.net/img_auth.php/f/fc/ScannerAlertingEnhancement.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/img_auth.php/f/fc/ScannerAlertingEnhancement.oxz">http://wiki.alioth.net/img_auth.php/f/fc/ScannerAlertingEnhancement.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873521</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Scanner%20Alerting%20Enhancement'>http://wiki.alioth.net/index.php/Scanner%20Alerting%20Enhancement</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SCANNER_ALERTING_ENHANCEMENT.html">Scanner Alerting Enhancement</a></td>
                    <td>yes</td>
                    <td align="right">7500</td>
                    <td align="center">8+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/jh145_04_sae.js</td>
                    <td><pre>
this.name        = &#39;jh145_04_sae&#39;;
this.author      = &#39;jh145&#39;;
this.copyright   = &#39;(C) 2015 jh145&#39;;
this.licence     = &#39;CC-NC-BY-SA 4.0&#39;;
this.description = &#39;Pre-emptive identification and alerting of new ships on the scanner.&#39;;

&#39;use strict&#39;;

this.activated = function() {   // respond to the &#39;n&#39; key
  worldScripts.jh145_04_world._SAE_nextSubmenu();
}

this.mode = function() {   // respond to the &#39;b&#39; key
  worldScripts.jh145_04_world._SAE_nextSubmenuItem();
}

</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/jh145_04_world.js</td>
                    <td><pre>
this.name        = &#39;jh145_04_world&#39;;
this.author      = &#39;jh145&#39;;
this.copyright   = &#39;(C) 2015 jh145&#39;;
this.licence     = &#39;CC-NC-BY-SA 4.0&#39;;
this.description = &#39;Pre-emptive identification and alerting of new ships on the scanner.&#39;;

&#39;use strict&#39;;

/* ========================================================================
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 *
 * Equipment capabilities: which alert types to offer and which
 * scan classes to monitor.
 *
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 * ========================================================================
 */

this._capabilities = [
  [ &#39;alerts&#39;,
    [ &#39;scan+con&#39;,  [&#39;scanner&#39;,&#39;console&#39;] ],
    [ &#39;scanner&#39;,   [&#39;scanner&#39;]           ],
    [ &#39;console&#39;,   [&#39;console&#39;]           ],
    [ &#39;none&#39;,      []                    ]
  ],
  [ &#39;ships&#39;,
    [ &#39;civilian&#39;,     [&#39;CLASS_NEUTRAL&#39;]                                 ],
    [ &#39;military&#39;,     [&#39;CLASS_MILITARY&#39;]                                ],
    [ &#39;police&#39;,       [&#39;CLASS_POLICE&#39;]                                  ],
    [ &#39;civ+mil+pol&#39;,  [&#39;CLASS_NEUTRAL&#39;,&#39;CLASS_MILITARY&#39;,&#39;CLASS_POLICE&#39;] ]
  ],
  [ &#39;extras&#39;,
    [ &#39;escape pods&#39;,      [&#39;escpods&#39;]             ],
    [ &#39;dockable rocks&#39;,   [&#39;rockdocks&#39;]           ],
    [ &#39;pods+docks&#39;,       [&#39;escpods&#39;,&#39;rockdocks&#39;] ],
    [ &#39;none&#39;,             []                      ]
  ]
];

/* ========================================================================
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 *
 * Equipment &quot;API&quot;
 *
 * + worldScript functions:
 *   | _SAE_nextSubmenu()       : &#39;n&#39; key
 *   | _SAE_nextSubmenuItem()   : &#39;b&#39; key
 *   | _SAE_updateDisplay()     : on timer
 *   | _SAE_rememberOne(target) : on targeting
 *   | _SAE_forgetAll()         : on jumping, docking or equipment failure
 *
 * + worldScript data:
 *   | _SAE_config : capability choices
 *
 * + Ship state induced by this equipment:
 *   | _jh145_04_haveTargeted  : boolean
 *   | _jh145_04_originalSDC   : original lollipop colours (set iff flashing)
 *   | _jh145_04_haveConLogged : boolean
 *
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 * ========================================================================
 */

this._SAE_config = {};    // populated by this.startUp()

this._SAE_nextSubmenu = function() {
  this._capabilities = this._capabilities.slice(1).concat([this._capabilities[0]]);
  var cap = this._capabilities[0];
  player.consoleMessage( &#39;[&#39;+cap[0]+&#39;:&#39;+cap[1][0]+&#39;]&#39;, 2 );
}

this._SAE_nextSubmenuItem = function() {
  var cap = this._capabilities[0];
  this._capabilities[0] = [cap[0]].concat(cap.slice(2)).concat([cap[1]]);
  cap = this._capabilities[0];
  player.consoleMessage( &#39;[&#39;+cap[0]+&#39;:&#39;+cap[1][0]+&#39;]&#39;, 2 );
  this._SAE_config[cap[0]] = cap[1][1];
}

this._SAE_updateDisplay = function() {
  if (!this._isWorking() || player.ship.docked) return;

  var alertScanClasses = this._SAE_config.ships;
  var alertMayFlash    = (this._SAE_config.alerts.indexOf(&#39;scanner&#39;) &gt;= 0);
  var alertMayLog      = (this._SAE_config.alerts.indexOf(&#39;console&#39;) &gt;= 0);
  var extras           = this._SAE_config.extras;

  var ships = player.ship.checkScanner(false);
  for (var i=0; i&lt;ships.length; i++) {
    var ship      = ships[i];
    var alertable = (
      ship._jh145_04_haveTargeted!==true &amp;&amp; (
        alertScanClasses.indexOf(ship.scanClass)&gt;=0
        || (extras.indexOf(&#39;escpods&#39;)&gt;=0 &amp;&amp; ship.primaryRole==&#39;escape-capsule&#39;)
        || (extras.indexOf(&#39;rockdocks&#39;)&gt;=0 &amp;&amp; ship.scanClass==&#39;CLASS_ROCK&#39; &amp;&amp; ship instanceof Station)
      )
    );

    // update lollipops
    var isFlashing = (ship._jh145_04_originalSDC!==undefined);
    var shouldFlash = (alertable &amp;&amp; alertMayFlash);
    if (!isFlashing &amp;&amp; shouldFlash) {
      ship._jh145_04_originalSDC = [
        ship.scannerDisplayColor1,        ship.displayColor2,
        ship.scannerHostileDisplayColor1, ship.displayColor2,
      ];
      var effectiveSDC = this._actualDisplayedColours(ship);
      this._writeSDC(ship,[effectiveSDC[0],&#39;brownColor&#39;,effectiveSDC[2],effectiveSDC[3]]);
    } else if (isFlashing &amp;&amp; !shouldFlash) {
      this._writeSDC(ship,ship._jh145_04_originalSDC);
      delete ship._jh145_04_originalSDC;
    }

    // update console log
    var hasLogged = (ship._jh145_04_haveConLogged===true);
    var shouldLog = (alertable &amp;&amp; alertMayLog);
    if (!hasLogged &amp;&amp; shouldLog) {
      player.consoleMessage(&#39;+ &#39;+ship.shipClassName);
      ship._jh145_04_haveConLogged = true;
    }
  }
}

this._SAE_rememberOne = function(target) {
  if (!this._isWorking()) return;
  target._jh145_04_haveTargeted = true;
}

this._SAE_forgetAll = function() {
  for (var i=0; i&lt;system.allShips.length; i++) {
    var target = system.allShips[i];
    if (target._jh145_04_haveTargeted)  delete target._jh145_04_haveTargeted;
    if (target._jh145_04_haveConLogged) delete target._jh145_04_haveConLogged;
    if (target._jh145_04_originalSDC)   delete target._jh145_04_originalSDC;
  }
}

/* ========================================================================
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 *
 * &quot;Internal&quot; functions, most of which are devoted to faffing around with
 * lollipop colour schemes.
 *
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 * ========================================================================
 */

this._wasWorking = false;

this._isWorking = function() {
  var isWorking = (player.ship.equipmentStatus(&#39;EQ_SCANNER_ALERTING_ENHANCEMENT&#39;)==&#39;EQUIPMENT_OK&#39;);
  if (this._wasWorking &amp;&amp; !isWorking) this._SAE_forgetAll();
  this._wasWorking = isWorking;
  return isWorking;
}

this._actualDisplayedColours = function(target) {
  var sdc1  = target.scannerDisplayColor1;
  var sdc2  = target.scannerDisplayColor2;
  var shdc1 = target.scannerHostileDisplayColor1;
  var shdc2 = target.scannerHostileDisplayColor2;
  var cols  = this._defaultDisplayedColours(target.scanClass);
  var userDefinedSDC = true;

  if (!sdc1 &amp;&amp; !sdc2) { sdc1 = cols[0]; sdc2 = cols[1]; userDefinedSDC = false; }
  else if (!sdc1)     { sdc1 = sdc2; }
  else if (!sdc2)     { sdc2 = sdc1; }

  if (!shdc1 &amp;&amp; !shdc2) { shdc1 = userDefinedSDC ? sdc1 : cols[2];
                          shdc2 = userDefinedSDC ? sdc2 : cols[3]; }
  else if (!shdc1) { shdc1 = shdc2; }
  else if (!shdc2) { shdc2 = shdc1; }

  return [ sdc1, sdc2, shdc1, shdc2 ];
}

this._defaultDisplayedColours = function(scanClass) {
  var c_cargo    = [ 0.9, 0.9, 0.9, 1.0 ];  // grey
  var c_hostile  = [ 1.0, .25, 0.0, 1.0 ];  // red/orange
  var c_neutral  = [ 1.0, 1.0, 0.0, 1.0 ];  // yellow
  var c_friendly = [ 0.0, 1.0, 0.0, 1.0 ];  // green
  var c_missile  = [ 0.0, 1.0, 1.0, 1.0 ];  // cyan
  var c_police1  = [ 0.5, 0.0, 1.0, 1.0 ];  // purpley-blue
  var c_police2  = [ 1.0, 0.0, 0.5, 1.0 ];  // purpley-red
  switch (scanClass) {
    case &#39;CLASS_ROCK&#39;:
    case &#39;CLASS_CARGO&#39;:
      return [c_cargo,c_cargo,c_cargo,c_cargo];
    case &#39;CLASS_THARGOID&#39;:
      return [c_friendly,c_hostile,c_friendly,c_hostile];
    case &#39;CLASS_MISSILE&#39;:
      return [c_missile,c_missile,c_missile,c_missile];
    case &#39;CLASS_STATION&#39;:
      return [c_friendly,c_friendly,c_friendly,c_friendly];
    case &#39;CLASS_BUOY&#39;:
      return [c_neutral,c_friendly,c_neutral,c_friendly];
    case &#39;CLASS_POLICE&#39;:
    case &#39;CLASS_MILITARY&#39;:
      return [c_police1,c_police1,c_police1,c_police2];  // yes, 1112
    case &#39;CLASS_MINE&#39;:
      return [c_hostile,c_neutral,c_hostile,c_neutral];
  }
  return [c_neutral,c_neutral,c_hostile,c_hostile];
}

this._writeSDC = function(target,colours) {
  var _v = function(x) { return x===undefined ? null : x; }
  target.scannerDisplayColor1        = _v(colours[0]);
  target.scannerDisplayColor2        = _v(colours[1]);
  target.scannerHostileDisplayColor1 = _v(colours[2]);
  target.scannerHostileDisplayColor2 = _v(colours[3]);
}

/* ========================================================================
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 *
 * Methods called by the core game.  Keep at end of script.
 *
 * ||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
 * ========================================================================
 */

this.startUp = function() {
  this._timer = new Timer(this,this._SAE_updateDisplay,0,1.202056903);
  // 1.202... is just today&#39;s favourite number a little bigger than 1.
  for (var i=0; i&lt;this._capabilities.length; i++) {
    var cap = this._capabilities[i];
    this._SAE_config[cap[0]] = cap[1][1];
  }
}

this.shipTargetAcquired = this._SAE_rememberOne;

this.shipWillEnterWitchspace = this.shipDockedWithStation = this._SAE_forgetAll;

</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
