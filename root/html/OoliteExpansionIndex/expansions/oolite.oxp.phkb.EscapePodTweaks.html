<html>
    <head>
        <title>Expansion Escape Pod Tweaks</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Escape Pod Tweaks</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Adjusts how escape pods are processed at stations, particularly Rock Hermits.</td>
                    <td>Adjusts how escape pods are processed at stations, particularly Rock Hermits.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.EscapePodTweaks</td>
                    <td>oolite.oxp.phkb.EscapePodTweaks</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Escape Pod Tweaks</td>
                    <td>Escape Pod Tweaks</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.8</td>
                    <td>0.8</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/0/02/EscapePodTweaks.oxz">https://wiki.alioth.net/img_auth.php/0/02/EscapePodTweaks.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873210</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Escape%20Pod%20Tweaks'>http://wiki.alioth.net/index.php/Escape%20Pod%20Tweaks</a></p>
        <h3>readme.txt</h3>
        <pre>Escape Pod Tweaks
By Nick Rogers

Overview
========
This OXP aims to make the processing of escape pods a little more logical. In the core game, if the player docks at a Rock Hermit while carrying a scooped escape pod, the bounty for this pod will be given to the player immediately, even though the Rock Hermit has no police to escort the felon away. Neither would there be any way to process an insurance claim for a non-bounty escape pod.

What this OXP does is to check the station at which the player is about to dock for the number of docked police, and the allegiance of the station. If there are no police, or the allegiance of the station is not &quot;galcop&quot;, then escape pods won&#39;t be processed. They will remain as &quot;slaves&quot; on the F8 cargo manifest screen. The player will not be able to sell these slaves, and the player will be notified by a status message if they attempt it.

Also, to maintain some realism, the default number of police docked at all Rock Hermits (standard, &quot;chaotic&quot; and &quot;pirate&quot; Hermitages) has been set to 0. This will also apply to any OXP station that uses &quot;like_ship&quot; to replicate &quot;rock-hermit&quot; (or &quot;oolite_template_rock-hermit&quot;), &quot;rock-hermit-chaotic&quot; (or &quot;oolite_template_rock-hermit-chaotic&quot;), or &quot;rock-hermit-pirate&quot; (or &quot;oolite_template_rock-hermit-pirate&quot;). The number of docked defenders has been increased for each of these station types: 4 for standard hermits, 7 for chaotic, and 10 for pirate.

Some visibility of the occupants of scooped escape pods is now provided on the F5F5 Manifest screen.

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Version History
===============
0.8
- Removed debug message.
- Added code to prevent overriding the pilot if the escape pod shipdata entry includes a pilot definition.

0.7
- After launching, held escape pods were not being added back into the active array correctly.

0.6
- shipdata-overrides.plist was overriding the wrong ship keys, meaning rock hermits could still have police.

0.5
- Corrected error that occurs if rescued escape pod has no crew defined (which can happen with mission OXP&#39;s).

0.4
- Corrections to manifest.plist file.

0.3
- Better integration with Market Observer.

0.2
- Bug fixes.
- Code refactoring.

0.1
- Initial release.</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/escapepodtweaks.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;EscapePodTweaks&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2017 phkb&quot;;
this.description = &quot;Changes the way escape pods are processed to make it more logical&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

/*
    This OXP makes the processing of escape pods a bit more realistic. When docking with escape pods, a check is made on the 
    type of station the player is docking at, and also of the number of docked police there are in the station. If the station
    is not a galcop-aligned station, or there are no police present, then escape pods will not be offloaded at the station.
*/

this._escapePods = []; // array of scooped escape pods
this._heldPods = []; // array of escape pods that will be added back to the player ship after launch
this._addBackTimer = null; // timer to monitor when Smugglers has finished it&#39;s processing
this._doAddBack = false; // flag to indicate that a count of slaves needs to be added after docking has completed
this._mo_timer = null;
this._sale = {};

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
    if (missionVariables.EscapePodsHeld) {
        this._heldPods = JSON.parse(missionVariables.EscapePodsHeld);
        delete missionVariables.EscapePodsHeld;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
    // store the details of any escape pods we are holding
    if (this._heldPods.length &gt; 0) {
        missionVariables.EscapePodsHeld = JSON.stringify(this._heldPods);
    } else {
        delete missionVariables.EscapePodsHeld;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipScoopedOther = function (cargo) {
    // make a note of any escape pods we scoop
    // note: escape pods with no crew are treated as 1t slaves cargo pods, not as escape pods
    if (cargo.crew &amp;&amp; cargo.crew.length &gt; 0) {
        // add a shipWasDumped event monitor to check for the player dumping this pod
        if (cargo.script.shipWasDumped &amp;&amp; !cargo.script.$eptovr_shipWasDumped) {
            cargo.script.$eptovr_shipWasDumped = cargo.script.shipWasDumped;
        }
        cargo.script.shipWasDumped = this.$ept_shipWasDumped;
        this._escapePods.push(cargo);
        this.$updateManifest();
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function (station) {
    if (this._escapePods.length &gt; 0) {
        // look for a non-galcop station with no police
        if (station.dockedPolice === 0 &amp;&amp; station.allegiance !== &quot;galcop&quot;) {
            // go through the list of pods we&#39;ve scooped to check they are still with the player
            for (var i = 0; i &lt; this._escapePods.length; i++) {
                var ep = this._escapePods[i];
                // if the pod is with the player, copy enough info to be able to recreate this pod later
                if (ep.isValid &amp;&amp; ep.status === &quot;STATUS_IN_HOLD&quot;) {
                    this._doAddBack = true;
                    // grab enough info of rescued escape pods to allow us to recreate them later
                    this._heldPods.push({
                        &quot;dataKey&quot;: ep.dataKey,
                        &quot;entityPersonality&quot;: ep.entityPersonality,
                        &quot;AI&quot;: ep.AI,
                        &quot;AIScript&quot;: ep.AIScript.name,
                        &quot;pilotName&quot;: ep.crew[0].name,
                        &quot;pilotHomeSystem&quot;: ep.crew[0].homeSystem,
                        &quot;pilotDescription&quot;: ep.crew[0].description,
                        &quot;pilotInsurance&quot;: ep.crew[0].insuranceCredits,
                        &quot;pilotLegalStatus&quot;: ep.crew[0].legalStatus,
                        &quot;madeOffer&quot;: ep.script._ept_madeOffer
                    });
                }
            }
            // null out the slave count to essentially &quot;dump&quot; the escape pods so they don&#39;t get processed
            var remaining = player.ship.manifest[&quot;slaves&quot;] - this._heldPods.length;
            player.ship.manifest[&quot;slaves&quot;] = 0;
            player.ship.manifest[&quot;slaves&quot;] = remaining;
        }
        // clear out the escapepod array - we don&#39;t need this anymore
        this._escapePods = [];
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$ept_shipWasDumped = function $ept_shipWasDumped(dumper) {
    if (this.ship.script.$eptovr_shipWasDumped) this.ship.script.$eptovr_shipWasDumped(dumper);
    if (dumper.isPlayer) {
        var ept = worldScripts.EscapePodTweaks;
        for (var i = 0; i &lt; ept._escapePods.length; i++) {
            if (ept._escapePods[i] == this.ship) {
                ept._escapePods.splice(i, 1);
                break;
            }
        }
    }
    // detach our custom script
    delete this.ship.script.shipWasDumped;
    if (this.ship.script.$eptovr_shipWasDumped) {
        this.ship.script.shipWasDumped = this.ship.script.$eptovr_shipWasDumped;
        delete this.ship.script.$eptovr_shipWasDumped;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
    if (this._doAddBack === true) {
        // don&#39;t call the addback until after Smugglers finishes
        if (worldScripts.Smugglers_Illegal &amp;&amp; worldScripts.Smugglers_Illegal._doCargoCheck === true) {
            // start a timer to monitor for Smugglers being complete
            this._addBackTimer = new Timer(this, this.$waitForFreeTime, 0.25, 0);
            return;
        }
        // we should only get here if we&#39;re confident smugglers has finished
        this._doAddBack = false;
        if (this._heldPods.length &gt; 0) player.ship.manifest[&quot;slaves&quot;] += this._heldPods.length;
    }
    this.$updateManifest();
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
    // puts escape pods back in the player&#39;s hold as real escape pods
    // do we have any held pods?
    if (this._heldPods.length &gt; 0) {
        for (var i = 0; i &lt; this._heldPods.length; i++) {
            // remove one of the slaves from the player&#39;s cargo hold
            player.ship.manifest[&quot;slaves&quot;] -= 1;
            // add the pod back
            this.$addPodToShip(this._heldPods[i], false);
        }
    }
    // clear out the array - we don&#39;t need this any more
    this._heldPods = [];
}

//-------------------------------------------------------------------------------------------------------------
// stop the player from selling cargo pods
this.playerSoldCargo = function (commodity, units, price) {
    var p = player.ship;
    var stn = p.dockedStation;
    if (commodity === &quot;slaves&quot;) {
        var curamt = p.manifest[commodity];
        if (worldScripts.Smugglers_DockMaster) {
            curamt = p.manifest[commodity] - worldScripts.Smugglers_DockMaster.$getTotalRelabelled(commodity);
        }
        if (curamt &lt; this._heldPods.length) {
            var refund = units;
            if (units &gt; this._heldPods.length) refund = this._heldPods.length;
            if (units &lt; this._heldPods.length) refund = this._heldPods.length - units;
            player.credits -= ((price / 10) * refund);
            p.manifest[commodity] += refund;
            stn.setMarketQuantity(commodity, stn.market[commodity].quantity - refund);
            player.consoleMessage(&quot;You cannot sell the escape pods on the market.&quot;);
            if (worldScripts.market_observer3) {
                this._mo_timer = new Timer(this, this.$reverseMOSale, 0.5, 0);
                this._sale = {
                    commodity: commodity,
                    units: units,
                    price: price
                };
            }
            return;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$reverseMOSale = function $reverseMOSale() {
    var mo = worldScripts.market_observer3;
    mo.playerBoughtCargo(this._sale.commodity, this._sale.units, this._sale.price);
    this._sale = {};
}

//-------------------------------------------------------------------------------------------------------------
this.$addPodToShip = function $addPodToShip(details) {
    // create the pod
    var p = player.ship;
    var ep = system.addShips(&quot;[&quot; + details.dataKey + &quot;]&quot;, 1, p.position.add(p.vectorForward.multiply(1000000)), 1)[0];
    ep.entityPersonality = details.entityPersonality;
    if (details.AI !== &quot;nullAI.plist&quot;) ep.setAI(details.AI);
    if (details.AIScript.name !== &quot;Null AI&quot;) {
        var aiName = &quot;oolite-shuttleAI.js&quot;;
        if (details.AIScript !== &quot;Oolite Shuttle AI&quot;) {
            log(this.name, &quot;!!ERROR: Unrecognised escape pod AI type: &quot; + details.AIScript + &quot; - using default&quot;);
        }
        ep.setAI(aiName);
    }
    // don&#39;t add a pilot if the escape pod is defined with a character - the pod should be recreated with the pilot already defined
    var check = Ship.shipDataForKey(details.dataKey);
    if (!check.pilot || check.pilot === &quot;&quot;) {
        // add the pilot
        // set the seed values so that the pilot&#39;s species can be defined by their home system
        var seed = &quot;0 0 0 0 &quot; + details.pilotHomeSystem.toString() + &quot; 2&quot;;
        ep.setCrew({
            name: details.pilotName,
            origin: details.pilotHomeSystem,
            insurance: details.pilotInsurance,
            bounty: details.pilotLegalStatus,
            short_description: details.pilotDescription,
            random_seed: seed
        });
    }
    // force a scoop event process to add the ship back to the standard array, and to add custom events
    this.shipScoopedOther(ep);
    ep.script._ept_madeOffer = details.madeOffer;
    // add the pod to the player ship
    p.addCargoEntity(ep);
}

//-------------------------------------------------------------------------------------------------------------
this.$waitForFreeTime = function $waitForFreeTime() {
    if (worldScripts.Smugglers_Illegal &amp;&amp; worldScripts.Smugglers_Illegal._doCargoCheck === true) {
        // keep running this timer until Smugglers is cleared
        this._addBackTimer = new Timer(this, this.$waitForFreeTime, 0.25, 0);
    } else {
        this.missionScreenOpportunity();
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$updateManifest = function $updateManifest() {
    var textData = [];
    textData.push(expandDescription(&quot;[escapepods-manifest-header]&quot;));
    if (player.ship.isInSpace) {
        for (var i = 0; i &lt; this._escapePods.length; i++) {
            if (this._escapePods[i].crew) {
                var pilot = this._escapePods[i].crew[0];
                textData.push(&quot; &quot; + this.$cleanPilotName(pilot.name) + &quot;, &quot; + pilot.description + &quot; (&quot; + (pilot.legalStatus &gt;= 50 ? &quot;Fugitive&quot; : pilot.legalStatus &gt; 0 ? &quot;Offender&quot; : &quot;Clean&quot;) + &quot;)&quot;);
            }
        }
    } else {
        for (var i = 0; i &lt; this._heldPods.length; i++) {
            var pilot = this._heldPods[i];
            textData.push(&quot; &quot; + this.$cleanPilotName(pilot.pilotName) + &quot;, &quot; + pilot.pilotDescription + &quot; (&quot; + (pilot.pilotLegalStatus &gt;= 50 ? &quot;Fugitive&quot; : pilot.pilotLegalStatus &gt; 0 ? &quot;Offender&quot; : &quot;Clean&quot;) + &quot;)&quot;);
        }
    }
    if (textData.length === 1) {
        mission.setInstructions(null, this.name);
    } else {
        mission.setInstructions(textData, this.name);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$cleanPilotName = function $cleanPilotName(pilotName) {
    pilotName = pilotName.replace(/[!.,?]/g, &quot;&quot;); // remove any punctuation
    return pilotName.replace(/\b\S/g, function(t) { return t.toUpperCase() });
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
