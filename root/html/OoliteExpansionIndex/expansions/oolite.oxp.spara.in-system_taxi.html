<html>
    <head>
        <title>Expansion In-System Taxi</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion In-System Taxi</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>This oxp adds in-system passenger contracts to the game. Passenger Berth is required along with some extra stations. In-System Taxi Comms equipment allows you to get in-system passenger offers while cruising.</td>
                    <td>This oxp adds in-system passenger contracts to the game. Passenger Berth is required along with some extra stations. In-System Taxi Comms equipment allows you to get in-system passenger offers while cruising.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.spara.in-system_taxi</td>
                    <td>oolite.oxp.spara.in-system_taxi</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>In-System Taxi</td>
                    <td>In-System Taxi</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Activities</td>
                    <td>Activities</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>spara</td>
                    <td>spara</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.2.3</td>
                    <td>1.2.3</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/In-System_Taxi">http://wiki.alioth.net/index.php/In-System_Taxi</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/2/23/In-system_taxi_1.2.3.oxz">https://wiki.alioth.net/img_auth.php/2/23/In-system_taxi_1.2.3.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873249</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/In-System%20Taxi'>http://wiki.alioth.net/index.php/In-System%20Taxi</a></p>
        <h3>In-System_Taxi_readme_&amp;_license.txt</h3>
        <pre>In-System Taxi OXP ver 1.2.3 (7.2.2015)

Author: spara (Mika Spåra)

_Story_

Taxi Galactica has expanded it&#39;s repertoire from interstellar taxi service to in-system taxi service. If you need to get from Kiota Manufacturing Station to RSS Station, Taxi Galactica&#39;s in-system taxi service is here for you. Just call our in-system taxi center, and we&#39;ll send a cab for you.

_Overview_

This oxp adds in-system passenger contracts to the game. These contracts are fast deliveries from one station to another that must be executed in given time (~15 - 30 min). For a succesful delivery you are paid a fee of ~5-40 credits, depending on distance of the starting point and destination as well as your performance.

With In-System Taxi Comms device you can get receive in-system passenger contract offers through your Comms while you are in flight. The device can be bought from Taxi Galactica stations or if that oxp is not present from main stations.

Type of the contracts offered depends on the oxps installed.

_Usage_with_other_oxps_

You must meet at least one of the following conditions for this oxp to do anything.

1. Some odd oxp stations installed, like WildShips oxp.

With some extra stations installed you get in-system station to station passenger contracts. If there is a passenger waiting at the station you currently are, he/she/it can be found from the interfaces screen (f4). Look for In-system taxi deliveries. If you accept a contract, launch and fly to the destination station. If you reach it in time, you will be thanked and payed. If you performed good, you&#39;ll get a premium.

2. Taxi Galactica oxp installed

From Taxi Galactica Station you can buy an In-System Taxi Comms device. The device allows you to receive in-system passenger contract offers through your Comms while you are cruising. To buy such a device, you must have the advanced space compass and at least one passenger berth installed. Device costs you 90 credits. After you have bought the device you have a new primable equipment that is used for accepting in-system taxi offers in-flight. After receiving an offer through comms, you have 60 seconds to accept it. (select equipment with shift-n and activate it with n). After accepting the contract, it is added to your manifest screen. Next pick the passenger from the correct station. You&#39;ll be notified, when he/she/it is on board.

Taxi Comms goes to &quot;Taxi unavailable&quot; mode on condition red and stays that way. Mode can be toggled between &quot;Taxi available&quot; and &quot;Taxi unavailable&quot; by priming (shift-n and b). After launch and hyperspace, mode is resetted to &quot;Taxi available.&quot; This behaviour can be changed through a variable in taxi_worldscript.js.

3. Planetfall oxp and Planetary Compass oxp installed

These two oxps add planetside locations to in-system passenger contracts. You must have Planetary Landing Cababilities to be offered contracts.

4. Liners oxp installed

This oxp adds liners that are currently in system to in-system passenger contracts.

_Some_notes_

* Only one in-system passenger is allowed at a time.
* Accepted contract can be cancelled by activating the primable equipment second time. The passenger must not have boarded yet.
* Systems with more stations are more likely to offer contracts than systems with fewer stations.
* In-system contract, along with a possible passenger, is resetted when loading a saved game.
* Reset to &quot;Taxi available&quot; mode on lauch and hyperspace can be switched off from this.$availableOnLaunch variable in taxi_worldscript.js.
* In-flight offers&#39; pickup points are limited to max 1000 km dist from player. Max distance is toggleable via this.$maxDistance variable.

_Credits_

Taxi Galactica logo used in a background image.

_Requirements_

Oolite version 1.79.

_Installing_

Install the OXP by copying In-System_Taxi.oxp to your AddOns-folder.

------

This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_IN_SYSTEM_TAXI_LICENCE.html">In-System Taxi Comms</a></td>
                    <td>yes</td>
                    <td align="right">600</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_IN_SYSTEM_TAXI_LICENCE_REMOVAL.html">Remove In-System Taxi Comms</a></td>
                    <td>yes</td>
                    <td align="right">100</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/equipment.plist</td>
                    <td><pre>(
	(
		0, 600, &quot;In-System Taxi Comms&quot;,
		&quot;EQ_IN_SYSTEM_TAXI_LICENCE&quot;,
		&quot;Join Taxi Galactica&#39;s in-system taxi drivers division. Deliver customers from one station to another in-system. Buy this device and you&#39;ll receive local delivery offers right to your Comms while cruising. When you get an offer, you have one minute to decide to take it or not. If you want to take it, just prime this small gadget and activate it.&quot;,
		{
			&quot;available_to_all&quot; = yes;
			&quot;requires_equipment&quot; = &quot;EQ_ADVANCED_COMPASS&quot;;
			&quot;portable_between_ships&quot; = yes;
			&quot;script&quot; = &quot;taxi_equipment.js&quot;;
			&quot;damage_probability&quot; = 0.0;
			&quot;condition_script&quot; = &quot;taxi_equipment.js&quot;;
		}
	),
	(
		1, 100, &quot;Remove In-System Taxi Comms&quot;,
		&quot;EQ_WEAPON_IN_SYSTEM_TAXI_LICENCE_REMOVAL&quot;,
		&quot;Stop receiving in-system delivery offers through Comms.&quot;,
		{
			&quot;available_to_all&quot; = yes;
			&quot;requires_equipment&quot; = &quot;EQ_IN_SYSTEM_TAXI_LICENCE&quot;;
			&quot;condition_script&quot; = &quot;taxi_equipment.js&quot;;
		}
	)  
)
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/taxi_equipment.js</td>
                    <td><pre>this.name           =    &quot;in-system_taxi_equipment&quot;;
this.author         =    &quot;spara&quot;;
this.copyright      =    &quot;2013-2014 Mika Spåra&quot;;
this.licence        =    &quot;CC BY-NC-SA 3.0&quot;; 
this.description    =    &quot;Equipment to accept delivery jobs&quot;;
this.version        =    &quot;1.2.2&quot;;
&quot;use strict&quot;;

//accept or cancel offers with n
this.activated = function() {
	if (worldScripts[&quot;in-system_taxi&quot;].$currentOffer[0] == 1) {
		worldScripts[&quot;in-system_taxi&quot;].$acceptOffer();	
	}
	else if (worldScripts[&quot;in-system_taxi&quot;].$currentOffer[0] == 2){
		worldScripts[&quot;in-system_taxi&quot;].$cancelContract();
	}
	else {
		worldScripts[&quot;in-system_taxi&quot;].$commsMessage(&quot;No contract to accept or cancel&quot;);
	}
}

//start or stop receiving offers with b
this.mode = function() {
	if (!worldScripts[&quot;in-system_taxi&quot;].$taxiAvailable) {
		player.consoleMessage(&quot;Taxi available&quot;);
		worldScripts[&quot;in-system_taxi&quot;].$taxiAvailable = true;
		if (!worldScripts[&quot;in-system_taxi&quot;].$startOfferTimer()) {
			worldScripts[&quot;in-system_taxi&quot;].$taxiAvailable = false;
			player.consoleMessage(&quot;Taxi unavailable&quot;);
		}
	}
	else {
		player.consoleMessage(&quot;Taxi unavailable&quot;);
		worldScripts[&quot;in-system_taxi&quot;].$taxiAvailable = false;
		worldScripts[&quot;in-system_taxi&quot;].$stopInFlightTimer();				
	}
}

//equipment restiction. Need passenger berth to buy.
this.allowAwardEquipment = function(eqKey, ship, context) {
	if (eqKey == &quot;EQ_IN_SYSTEM_TAXI_LICENCE&quot; &amp;&amp; player.ship.passengerCapacity == 0)
		return false;
	if (worldScripts.taxi_galactica_main) {
		if (player.ship.dockedStation.hasRole(&quot;taxi_station&quot;)) {
			return true;
		}
	}
	else if (player.ship.dockedStation.isMainStation)
		return true;
	else
		return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/taxi_worldscript.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;in-system_taxi&quot;; 
this.description = &quot;In-system passenger contracts&quot;; 

this.startUp = function() {
	//USER TOGGLEABLE VARIABLES START
	this.$availableOnLaunch = true;
	//true sets taxi to available on launch, false sets taxi to unavailable on launch
	this.$maxDistance = 1000000; //maximum distance of pickup point (in meters)
	
	//USER TOGGLEABLE VARIABLES END
	
	// this.$currentOffer = [offer_status, from_name, to_name, deadline, base_fare, passenger_name, system.ID, whole_time]
	// status = 0 no offer or offer declined
	// status = 1 offer waiting for approval
	// status = 2 offer accepted
	// status = 3 passenger on board
	this.$currentOffer = [0];
	if (missionVariables.inSystemTaxi != null) {//remove possible passenger
		player.ship.removePassenger(missionVariables.inSystemTaxi);
	}
	this.$deleteMissionInstructions() //remove possible mission instructions
	this.$stationOffers = []; //array for station offers
	this.$fireMissionScreen = 0; //flag for selecting different mission screens
	this.$readyToOffer = false; //start offering only after first launch
	this.$refTime = clock.seconds;//time keeping for refreshing station contracts
	this.$addedBeacon = [false, false];//flags for temporary beacons
	this.$premium = 0;//needed in different functions, thus global variable
	this.$offerFrequency = 90;//frequency at which new in-flight offers are generated and possibly offered. min 60
	this.$taxiAvailable = this.$availableOnLaunch; //status of availability
}

//fare, based on distance
this.$fare = function(distance) {
	return Math.floor(5 + 0.000005 * distance); //5 cr + 0.5 cr/100 km
}

this.playerWillSaveGame = function () {
	if (this.$currentOffer[0] == 3)//mark in-system passenger to be removed on load
		missionVariables.inSystemTaxi = this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;;
	else
		missionVariables.inSystemTaxi = null;
}

//Taxi Comms comes through this function
this.$commsMessage = function(message) {
	var notifySound = new SoundSource;
	notifySound.sound = &quot;beep.ogg&quot;;
	notifySound.play();
	player.commsMessage(&quot;Taxi Galactica&#39;s In-System Service:\n&quot;+message, 6);	
}

//find suitable stations
this.$listOfStations = function() {
    function $isAllowed(entity) {
		if (entity.scanClass == &quot;CLASS_STATION&quot;) {
			//excludes that have scanClass CLASS_STATION
			if (entity.hasRole(&quot;gates_jumpGate&quot;)) return false;
			if (entity.hasRole(&quot;fuelStation_satellite&quot;)) return false;
			if (entity.hasRole(&quot;fuelStation_station&quot;)) return false;
			if (entity.hasRole(&quot;jaguar_company_base&quot;)) return false;
			return true;
		}
		if (entity.isStation) {
			//includes that have isStation but not scanClass CLASS_STATION
			if (entity.hasRole(&quot;liners_liner&quot;)) return true;
			if (entity.hasRole(&quot;casinoship&quot;)) return true;
			if (entity.hasRole(&quot;random_hits_any_spacebar&quot;)) return true;
		}
		if (entity.isPlanet &amp;&amp; entity.displayName != null) {
			//planetfall &amp;&amp; planetary compass
			if (!entity.isSun &amp;&amp; !entity.hasOwnProperty(&quot;solarGasGiant&quot;) &amp;&amp; !entity.hasOwnProperty(&quot;isGasGiant&quot;) &amp;&amp; !entity.hasOwnProperty(&quot;PFNoLand&quot;) &amp;&amp; !entity.hasOwnProperty(&quot;PFNoLandQuiet&quot;) &amp;&amp; player.ship.equipmentStatus(&quot;EQ_PLANETFALL&quot;) == &quot;EQUIPMENT_OK&quot;) return true;
		}
		return false;
    }
    return system.filteredEntities(this, $isAllowed);
}

//IN-FLIGHT OFFERING FUNCTIONS START HERE

//set taxi to not available on condition red
this.alertConditionChanged = function(newCondition, oldCondition) {
	if (newCondition == 3) {
		//worldScripts[&quot;in-system_taxi&quot;].$commsMessage(&quot;Taxi Comms switched off&quot;);
		this.$stopInFlightTimer();
	}
}

//start in-flight offer timer
this.$startOfferTimer = this.playerCancelledJumpCountdown = function() {
	//show in-flight contract offers
	if (this.$taxiAvailable &amp;&amp; this.$currentOffer[0] &lt; 2 &amp;&amp; (player.ship.passengerCapacity - player.ship.passengerCount) &gt; 0 &amp;&amp; player.ship.equipmentStatus(&quot;EQ_IN_SYSTEM_TAXI_LICENCE&quot;) == &quot;EQUIPMENT_OK&quot;) {
		this.$startInFlightTimer();
		return true;
	}
	return false;
}

//start in-flight offer timer on launch only if available on launch is set.
this.shipLaunchedFromStation = function(station) {
	if (this.$availableOnLaunch)
		this.$taxiAvailable = true;
	this.$startOfferTimer();
}

//stop in-flight offer timer
this.playerStartedJumpCountdown = function() {
	this.$stopInFlightTimer();
}

//remove in-system contract when exiting system
this.shipWillEnterWitchspace = function() {
	if (this.$currentOffer[0] == 3) {//make in-system passenger regular passenger
		if (player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;))//try to rename passenger
			player.ship.addPassenger(this.$currentOffer[5], system.ID, system.ID, clock.seconds+10, this.$currentOffer[4]);
		var message = &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; is very disappointed having missed the deadline. Return passenger to the main station of &quot;+System.infoForSystem(system.info.galaxyID, this.$currentOffer[6]).name+&quot;.&quot;;
		var delayedMessage = new Timer(this, function(){this.$commsMessage(message)}, 10);
	}
	if (this.$availableOnLaunch)
		this.$taxiAvailable = true;	
	this.$endContract();
}

//create new in-flight offers
this.$taxiOffer = function() {
	if (system.isInterstellarSpace) return;//sanity check;
	var listOfStations = this.$listOfStations();
	var probability = 0.05 * listOfStations.length; //0.05 * number of stations =&gt; 0.10 for 2 stations ... 1 for 20 stations
	if (Math.random() &lt; probability &amp;&amp; listOfStations.length &gt; 1) {
		var to = listOfStations.splice(Math.floor(Math.random() * listOfStations.length), 1)[0];
		var from = to;
		var found = false;
		while (listOfStations.length &gt; 0 &amp;&amp; !found) {//select suitable pickup point
			from = listOfStations.splice(Math.floor(Math.random() * listOfStations.length), 1)[0];
			if (player.ship.position.distanceTo(from) &lt; this.$maxDistance)
				found = true;
		}
		if (!found) return;//no suitable pickup points
		if (to.isPlanet &amp;&amp; from.isPlanet)
			var distance = from.position.distanceTo(to) - to.radius - from.radius;
		else if (to.isPlanet)
			var distance = from.position.distanceTo(to) - to.radius;
		else if (from.isPlanet)
			var distance = from.position.distanceTo(to) - from.radius;
		else
			var distance = from.position.distanceTo(to);
		var baseTime =  0.0002 * distance + 1200; //20 secs per 100 km + 20 mins for reach, launch and incidents.
		var time = clock.seconds + baseTime;
		var fee = this.$fare(distance);
		var name = global.randomName() +&quot; &quot;+ global.randomName();
		this.$commsMessage(&quot;Name: &quot;+name+&quot;\nFrom: &quot;+from.displayName + &quot;\nTo: &quot; + to.displayName + &quot;\nTime: &quot;+  Math.floor((time - clock.seconds)/60) +&quot; minutes\nBase fare: &quot; + formatCredits(fee, true, true) + &quot;\nAccept contract in 60 seconds&quot;);
		this.$removeOfferTimer();
		this.$offerTimer = new Timer(this, function(){this.$currentOffer = [0];}, 60);//offer ends in 60 secs
		//time contract, so it can be removed if deadline is met before picking the passenger up.
		this.$removeContractTimer();
		this.$contractTimer = new Timer(this, this.$endContract, time - clock.seconds);
		this.$currentOffer = [1, from, to, time, fee, name, system.ID, baseTime];
	}
}

//accept offer
this.$acceptOffer = function() {
	this.$stopInFlightTimer();
	this.$removeOfferTimer();
	this.$currentOffer[0] = 2;
	this.$addMissionInstructions();
	this.$commsMessage(&quot;Contract accepted. Pick up passenger at &quot;+this.$currentOffer[1].displayName);
	this.$addBeacon();
}

//cancel contract
this.$cancelContract = function() {
	this.$endContract();
	this.$commsMessage(&quot;Contract cancelled&quot;);
}

//cancel contract before picking passenger up.
this.$endContract = function() {
	if (this.$currentOffer[0] &lt; 3) {//passenger not on board yet.
		this.$removeBeacon();
		this.$deleteMissionInstructions();
		this.$currentOffer = [0];
		this.$removeContractTimer();
		this.$startOfferTimer();
	}
}

//add mission instructions when accepting contract
this.$addMissionInstructions = function() {
	var deadline = new Date(0, 0, 0, 0, 0, this.$currentOffer[3]);
	var instructionText = &quot;Taxi: &quot;+this.$currentOffer[5]+&quot; from &quot; + this.$currentOffer[1].displayName + &quot; to &quot; + this.$currentOffer[2].displayName + &quot; before &quot; + deadline.toLocaleTimeString() +&quot;.&quot;;
	mission.setInstructions(instructionText, this.name);	
}

//delete mission instructions when cancelling contract
this.$deleteMissionInstructions = function() {
	mission.setInstructions(null, this.name);
}

//IN-FLIGHT OFFERING FUNCTIONS END HERE

//STATION OFFERING FUNCTIONS START HERE

//create new station offers
this.$createStationOffers = function() {
	if (system.isInterstellarSpace) return;//sanity check;
	var i;
	var listOfStations = this.$listOfStations();
	for (i = 0; i &lt; listOfStations.length; i++) {
		if (listOfStations[i] != player.ship.dockedStation &amp;&amp; Math.random() &lt; 0.1) {//contract probability of 0.1 per station in system.
			var from = player.ship.dockedStation;
			var to = listOfStations[i];
			if (to.isplanet)
				var distance = from.position.distanceTo(to) - to.radius;
			else
				var distance = from.position.distanceTo(to);
			var baseTime =  0.0002 * distance + 900; //20 secs per 100 km + 15 mins for launch and incidents.			
			var time = clock.seconds + baseTime;
			var fee = this.$fare(distance);
			var name = global.randomName() +&quot; &quot;+ global.randomName();
			this.$stationOffers.push([1, from, to, time, fee, name, system.ID, baseTime]);
			if (this.$stationOffers.length == 8) break; //cap possible offers to 8
		}
	}
}

//create station offers when docking
this.shipDockedWithStation = function(station) {
	this.$stationOffers = [];
	this.$createStationOffers();
	this.$stationOffersInterface();
	this.$refTime = clock.seconds;
}

//handle f4-screen
this.$stationOffersInterface = function() {
	//show interface if no contract accepted, no room or no offers
	if (this.$readyToOffer &amp;&amp; this.$stationOffers.length &gt; 0 &amp;&amp; this.$currentOffer[0] &lt; 2 &amp;&amp; player.ship.passengerCapacity - player.ship.passengerCount  &gt; 0) {
		player.ship.dockedStation.setInterface(&quot;in-system_taxi&quot;,{
			title: &quot;In-system taxi deliveries (&quot; +this.$stationOffers.length+&quot; available)&quot;,
			category: &quot;Deliveries&quot;,
			summary: &quot;Taxi Galactica&#39;s in-system taxi contracts. Pick a passenger from this station and make a fast transport to another station in-system.&quot;,
			callback: this.$showStationOffers.bind(this)
		});
	}
	else {
		player.ship.dockedStation.setInterface(&quot;in-system_taxi&quot;,null);//remove interface if contract accepted, no room or no offers
	}
}

//clean old offers and add new offers time to time
this.guiScreenChanged = function(to, from) {
	if (player.ship.docked &amp;&amp; !system.isInterstellarSpace &amp;&amp; clock.seconds - this.$refTime &gt; 600) {//refresh every 10 mins of game time
		this.$createStationOffers();	
		this.$clearOldOffers();
		this.$refTime = clock.seconds;
	}
}

this.$clearOldOffers = function() {
		var i;
		var validOffers = [];
		for (i = 0; i &lt; this.$stationOffers.length; i++) {
			//leave only ones that have at least 5 mins of fly time left, 10 goes to launching
			if ((Math.floor((this.$stationOffers[i][3] - clock.seconds))) &gt; 900) {
				validOffers.push(this.$stationOffers[i]);
			}
		}
		this.$stationOffers = validOffers;
		this.$stationOffersInterface();	
}

//mission screen for showing offers
this.$showStationOffers = function() {
	var options = {};
	var emptyMessage = &quot;&quot;;
	this.$clearOldOffers();
	if (this.$stationOffers.length == 0) {
		emptyMessage = &quot;\n\nToo late. You just missed the last passenger. Come back later.&quot;
	}
	else {
		var i;
		for (i = 0; i &lt; this.$stationOffers.length; i++) {
			options[i+&quot;_TAXI&quot;] = this.$stationOffers[i][5] +&quot; to &quot;+ this.$stationOffers[i][2].displayName +&quot; in &quot; + Math.floor((this.$stationOffers[i][3] - clock.seconds)/60) +&quot; minutes. Fare: &quot;+ formatCredits(this.$stationOffers[i][4], true, true);
		}
	}
	options[&quot;99_NO_THANKS&quot;] = &quot;Exit in-system contracts&quot;;
	mission.runScreen({
		title: &quot;Taxi Galactica&#39;s In-System Contracts&quot;,
		message: &quot;Welcome to Taxi Galactica&#39;s in-system taxi services of &quot;+system.name+&quot;. We have busy customers waiting for a fast in-system transportation. For a fast delivery, you will get a tip. The faster you go, the bigger tip you&#39;ll get.&quot;+emptyMessage,
		choices: options,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		background: &quot;tg_is_background.png&quot;
	},
	function (choice) {
		if (!choice || choice == &quot;99_NO_THANKS&quot;) return;
		else {
			this.$removeOfferTimer();//in case there is an offerTimer running from in-flight offers.
			this.$currentOffer = this.$stationOffers[choice.charAt(0)];
			this.$currentOffer[0] = 2;
			player.ship.dockedStation.setInterface(&quot;in-system_taxi&quot;,null);//remove station interface after accepting contract.
		}
	});		
}

//STATION OFFERING FUNCTIONS END HERE

//CONTRACT HANDLING

//add temporary beacons
this.$addBeacon =  function() {
	//add temporary from beacon
	if (this.$currentOffer[0] == 2 &amp;&amp; !this.$currentOffer[1].beaconCode) {
		this.$currentOffer[1].beaconCode = &quot;Taxi beacon&quot;;
		this.$addedBeacon[0] = true;
	}	
	//add temporary to beacon
	if (this.$currentOffer[0] == 3 &amp;&amp; !this.$currentOffer[2].beaconCode) {
		this.$currentOffer[2].beaconCode = &quot;Taxi beacon&quot;;
		this.$addedBeacon[1] = true;
	}
}

//remove temporary beacons
this.$removeBeacon = function() {
	//remove temporary from beacon
	if (this.$addedBeacon[0]) {
		this.$currentOffer[1].beaconCode = null;
		this.$addedBeacon[0] = false;
	}
	//remove temporary to beacon
	if (this.$addedBeacon[1]) {
		this.$currentOffer[2].beaconCode = null;
		this.$addedBeacon[1] = false;
	}		
}

this.shipWillLaunchFromStation = function(station) {
	this.$readyToOffer = true;//after frist launch, allow offering
	this.$addBeacon();//add temporary beacons
}

//handle passenger when docking
this.shipWillDockWithStation = function(station) {
	this.$removeBeacon();//remove temporary beacons
	this.$stopInFlightTimer();//stop in-flight offering
	//is there a passenger on board?
	if (this.$currentOffer[0] == 3) {
		//over 15 minutes (15*60 = 900 secs) late, cancel contract if possible.
		if (this.$currentOffer[3] - clock.seconds &lt; -900) {
			if (player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;)) {
				//switch taxi passenger to a game passenger and let the game handle rest
				if (station != this.$currentOffer[2]) {
					player.ship.addPassenger(this.$currentOffer[5], system.ID, system.ID, clock.seconds+10, this.$currentOffer[4]);
					this.$fireMissionScreen = 6;
					this.$currentOffer[0] = 0;
				}
				//if we&#39;re already at home, no switching is required, just fire mission screen
				else {
					this.$fireMissionScreen = 5;
					this.$currentOffer[0] = 0;
				}
			}
			return;
		}
		//destination check
		var rightDestination = false;
		if (this.$currentOffer[2].isPlanet) {
			if (worldScripts.PlanetFall.lastPlanet == this.$currentOffer[2] &amp;&amp; (station.hasRole(&quot;planetFall_surface&quot;)))
				rightDestination = true;
		}
		else if (station == this.$currentOffer[2])
			rightDestination = true;
		//right destination, 0 - 15 mins late, remove passenger, pay fare
		if (this.$currentOffer[3] - clock.seconds &lt; 0 &amp;&amp; rightDestination) {
			player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;);
			player.credits = player.credits + this.$currentOffer[4];
			this.$fireMissionScreen = 4;
			this.$currentOffer[0] = 0;
			return;
		}
		//right destination in time, remove passenger, pay fare and possibly premium
		if (rightDestination) {
			player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;);
			this.$premium = 30 * ((this.$currentOffer[3] - clock.seconds) / this.$currentOffer[7]);//tip 30*proportion
			player.credits = player.credits + this.$currentOffer[4] + this.$premium;
			this.$fireMissionScreen = 2;
			this.$currentOffer[0] = 0;
			return;
		}
		//docking main station
		if (station.isMainStation) {
			//if late, can&#39;t swap passengers at main station. Passenger just leaves.
			if (this.$currentOffer[3] - clock.seconds &lt; 0) {
				player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;);
				this.$fireMissionScreen = 5;
				this.$currentOffer[0] = 0;
			}
			//if time remaining, replace real passenger with bogus passenger
			else if (player.ship.removePassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;))
				player.ship.addPassenger(&quot;Taxi temp stand in&quot;, ((system.ID+2) % 256 - 1), ((system.ID+2) % 256 - 1), clock.seconds+3600, 0);
		}
	}
}


//handle unhiding the passenger and passenger picking. show mission screens, when there&#39;s something to show.
this.missionScreenOpportunity= function() {
	//check berth status when passenger on board and docked at main station.
	if (player.ship.docked &amp;&amp; player.ship.dockedStation.isMainStation &amp;&amp; this.$currentOffer[0] == 3) {
		//unhide passenger, if hidden.
		if (player.ship.removePassenger(&quot;Taxi temp stand in&quot;)) {//remove bogus
			if (!player.ship.addPassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;, system.ID, system.ID, this.$currentOffer[3], 0)) {	//put passenger back
				this.$fireMissionScreen = 5;//very rare case, where passenger has vanished while docking.
			}
		}
		else {//has passenger contract has been removed by game?
			var passengers = player.ship.passengers;
			var i;
			var passengerInBerth = false;
			for (i = 0; i &lt; passengers.length; i++) {
				if (passengers[i].name == this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;) {
					passengerInBerth = true;
					break;
				}
			}
			if (!passengerInBerth)//passenger has vanished, fire mission screen
				this.$fireMissionScreen = 5;
		}
	}
	//If we are at the right starting point, let&#39;s pick the passenger on board.
	else if (player.ship.docked &amp;&amp; this.$currentOffer[0] == 2) {
		var rightStartingPoint = false;
		if (this.$currentOffer[1].isPlanet) {//is it a planetary starting point?
			if (worldScripts.PlanetFall.lastPlanet == this.$currentOffer[1] &amp;&amp; (player.ship.dockedStation.hasRole(&quot;planetFall_surface&quot;)))
				rightStartingPoint = true;
		}
		else if (player.ship.dockedStation == this.$currentOffer[1])
			rightStartingPoint = true;
		if (rightStartingPoint) {//right starting point
			this.$deleteMissionInstructions();
			//is there room for the passenger?
			if (player.ship.passengerCapacity - player.ship.passengerCount == 0) {
				this.$fireMissionScreen = 3;
			}
			//all is probably well, let&#39;s add new contract
			else {
				player.ship.addPassenger(this.$currentOffer[5]+&quot; (going to &quot;+this.$currentOffer[2].displayName+&quot;)&quot;, system.ID, system.ID, this.$currentOffer[3], 0);
				this.$currentOffer[0] = 3;
				this.$currentOffer[7] = this.$currentOffer[3] - clock.seconds;//premium is based on basetime. basetime is defined when pickin up passenger.
				this.$fireMissionScreen = 1;
			}
		}
	}
	switch(this.$fireMissionScreen) {
		case 1:
			mission.runScreen({
				title: &quot;Passenger boarding&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; has boarded and is expecting to arrive &quot;+ this.$currentOffer[2].displayName + &quot; in &quot; + Math.floor((this.$currentOffer[3] - clock.seconds)/60) +&quot; minutes. Will pay you a fare of &quot;+formatCredits(this.$currentOffer[4], true, true)+&quot; for reaching the destination in time and a tip, if you&#39;re fast enough.&quot;,
				background: &quot;tg_is_background.png&quot;
			});
			this.$fireMissionScreen = 0;
			break;
		case 2:
			var tipTalk = &quot;&quot;;
			if (this.$premium &gt; 0.05)
				tipTalk = &quot; For fast delivery, you receive a tip of &quot;+formatCredits(this.$premium, true, true) +&quot;.&quot;;
			mission.runScreen({
				title: &quot;Satisfied customer&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; has arrived the destination in time. Fare of &quot;+formatCredits(this.$currentOffer[4], true, true)+ &quot; has been paid to your account.&quot; + tipTalk,
				background: &quot;tg_is_background.png&quot;
			});
			this.$currentOffer = [0];
			this.$fireMissionScreen = 0;
			break;
		case 3:
			mission.runScreen({
				title: &quot;No room for passenger&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; is very disappointed after finding that there is no room in your ship. The contract is cancelled.&quot;,
				background: &quot;tg_is_background.png&quot;
			});
			this.$currentOffer = [0];
			this.$fireMissionScreen = 0;
			break;
		case 4:
			mission.runScreen({
				title: &quot;Missed deadline&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; is not happy at all as you missed the deadline. You get your fare of &quot;+formatCredits(this.$currentOffer[4], true, true)+ &quot;, but no tip.&quot;,
				background: &quot;tg_is_background.png&quot;
			});
			this.$currentOffer = [0];
			this.$fireMissionScreen = 0;
			break;
		case 5:
			mission.runScreen({
				title: &quot;Unhappy customer&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; was not pleased with your service and promises never to set foot on your ship again.&quot;,
				background: &quot;tg_is_background.png&quot;
			});
			this.$currentOffer = [0];
			this.$fireMissionScreen = 0;
			break;
		case 6:
			mission.runScreen({
				title: &quot;Demanding customer&quot;,
				message: &quot;Taxi passenger &quot;+this.$currentOffer[5]+&quot; is very disappointed having missed the deadline and demands to be taken to the main station of &quot;+System.infoForSystem(system.info.galaxyID, this.$currentOffer[6]).name+&quot;.&quot;,
				background: &quot;tg_is_background.png&quot;
			});
			this.$fireMissionScreen = 0;
			break;			
	}
}

//Timer functions
this.$startInFlightTimer = function() {
	if (this.$showOfferTimer == null)
		this.$showOfferTimer = new Timer(this, this.$taxiOffer, 60, this.$offerFrequency);
	else this.$showOfferTimer.start();
};

this.$stopInFlightTimer = function() {
	if (this.$showOfferTimer != null)
		this.$showOfferTimer.stop();
};

this.$removeInFlightTimer = function() {
	if (this.$showOfferTimer != null) {
		this.$showOfferTimer.stop();
		delete this.$showOfferTimer;
	}
};

this.$removeOfferTimer = function() {
	if (this.$offerTimer != null) {
		this.$offerTimer.stop();
		delete this.$offerTimer;
	}
};

this.$removeContractTimer = function() {
	if (this.$contractTimer != null) {
		this.$contractTimer.stop();
		delete this.$contractTimer;
	}
};

this.playerBoughtEquipment = function(equipment) {
	if (equipment === &quot;EQ_IN_SYSTEM_TAXI_LICENCE_REMOVAL&quot;) {
		player.ship.removeEquipment(&quot;EQ_IN_SYSTEM_TAXI_LICENCE&quot;);
		player.ship.removeEquipment(&quot;EQ_IN_SYSTEM_TAXI_LICENCE_REMOVAL&quot;);
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
