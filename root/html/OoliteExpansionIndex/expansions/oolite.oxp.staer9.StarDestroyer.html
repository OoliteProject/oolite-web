<html>
    <head>
        <title>Expansion Star Destroyer</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Star Destroyer</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">11 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">6 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Optional Expansions mismatch between OXP Manifest and Expansion Manager at character position 0062 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Imperial-class Star Destroyer is probably the largest and most powerful warship which is available in a few Shipyards, for astronomical cost. Longer than a station but can dock using a Shuttle or ILS. Hold 30 turrets and 72 TIE Fighters which counterattack automatically and cheap to replace.</td>
                    <td>Imperial-class Star Destroyer is probably the largest and most powerful warship which is available in a few Shipyards, for astronomical cost. Longer than a station but can dock using a Shuttle or ILS. Hold 30 turrets and 72 TIE Fighters which counterattack automatically and cheap to replace.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.staer9.StarDestroyer</td>
                    <td>oolite.oxp.staer9.StarDestroyer</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Star Destroyer</td>
                    <td>Star Destroyer</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ships</td>
                    <td>Ships</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Staer9, GGShinobi, Norby</td>
                    <td>Staer9, GGShinobi, Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.6</td>
                    <td>1.6</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Thargoid.Bigships:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Thargoid.Bigships:</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Star_Destroyer">http://wiki.alioth.net/index.php/Star_Destroyer</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/2/20/StarDestroyer_1.6.oxz">https://wiki.alioth.net/img_auth.php/2/20/StarDestroyer_1.6.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873245</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Star%20Destroyer'>http://wiki.alioth.net/index.php/Star%20Destroyer</a></p>
        <h3>readme.txt</h3>
        <pre>
This is a modified version of Staer9&#39;s awesome Star Destroyer.

Changes in v1.6 by Norby:
-Fixed for Trophy Collector OXP, thanks to montana05.

Changes in v1.5 by Norby:
-Fighters got hull value instead of zero recharge to fix exhausted fighters.
-Fighters not owned by the player show owner in the name.
-Interstellar Tweaks OXP supported by naval fighters with blue scanner color.
-Ball turrets range increased to 7000m.
-Fixed Shuttle model in Oolite 1.80.

Changes in v1.4 by Norby:
-Player version added, available from TL12 and cost 100 million credits.
-30 turrets oriented around the hull in each 45 degree so no holes in the defensive sphere.
-TIE Fighters and TIE Interceptors added from StarWars OXP as escorts of Star Destroyers.
-There are 72 fighters in internal hangar which intercept attackers.
-Player get replacement fighters at arrival screen in the next station for cheap cost.
-Hexagon escort formation around Star Destroyers, following the Imperial logo.
-Fighter groups and actual targets are listed in MFD.
-Fighters land back in green alert, tractor beam will help to arrive into the hangar.
-Fighters must land before hyperjump, you should cancel countdown if time is not enough.
-TIE Interceptors require advanced Imperial-class Star Destroyer which cost 200MCr.
-Can dock to stations by Shuttle or ILS (cautiously) if put target lock to the station.
-Most ship stats are set between Staer9&#39;s original and GGShinobi&#39;s nightmare version.
-New gray textures made in MaPZone, new normal map and shaders added.
-Contain Heavy Sniper Gun mounts in forward and aft views for Sniper Gun OXP.
-Spawn script removed, new pirate roles added and bigTrader role for BigShips OXP.
-Packaged into OXZ format for in-game expansion manager.


Previous version by GGShinobi:
stardestroyerV1.3_inofficial_nightmare_version_0.0.3_2013_03_03.oxp.zip

========
Changes:
========
- reduced manoeuverability, but higher top speed.
- massively increased energy recharge rate and max energy
- high probabilty that it has advanced equipment like military scanner filters or shield boosters
- massively increased offensive potential: in addition to the already present turrets, it now has
  military lasers (fore/aft) and thargoid lazers (sides), giving it the ability to attack targets
  from far away and also shoot targets at medium range regardless of angle (thargoid lazers).
- many missiles, and it uses them!
- many escape capsules which you might scoop
- there is a chance that the star destroyer doesn&#39;t merely explode, but that the reactor core is
  hit, which will result in a massive explosion similar to the detonation of a Q-Bomb! The crew of
  the Star Destroyer will broadcast a desperate message if that happens, which will give you enough
  time to clear the blast radius (if you are lucky)

========
Credits:
========
stardestroyer: Staer9
modifications by GGShinobi:
  - changes to shipdata.plist
  - additional files:
    stardestroyer.js
    doomedStarDestroyer.js
    stardestroyer_reactorBreachAI.plist
    descriptions.plist

========
License:
========
The work of GGShinobi is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/

</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TIE_F.html">TIE Fighter</a></td>
                    <td>yes</td>
                    <td align="right">10000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TIE_FF.html">TIE Fighter Factory</a></td>
                    <td>yes</td>
                    <td align="right">100000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TIE_I.html">TIE Interceptor</a></td>
                    <td>yes</td>
                    <td align="right">20000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TIE_IF.html">TIE Interceptor Factory</a></td>
                    <td>yes</td>
                    <td align="right">200000</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-stardestroyer.html">Star Destroyer Heavy Sniper Gun</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyer.html">Star Destroyer</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyer-pirate.html">Imperial Star Destroyer</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyer-pirate2.html">Black Star Destroyer</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyer-player.html">stardestroyer-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyer-player2.html">stardestroyer-player2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyershuttle.html">Shuttle</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/stardestroyerturret.html">Star Destroyer Turret</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/tiefighter.html">TIE Fighter</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/tieinterceptor.html">TIE Interceptor</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/wrecked_stardestroyer_reactor_breach_imminent.html">Star Destroyer [reactor breach detected]</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/doomedStarDestroyer.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;doomed_stardestroyer&quot;;
this.author         = &quot;GGShinobi&quot;;
this.copyright      = &quot;© 2013 GGShinobi, Creative Commons: attribution, non-commercial, sharealike.&quot;;
this.description    = &quot;some special actions for the stardestroyer.&quot;;
this.version        = &quot;0.0.0&quot;;

// detonate subentites.
// uses this.$number2BlowUp
this.$detonateSubents = function() {
  for (subent in this.subEntities) {
    if (this.$number2BlowUp === 0 || ! this.subEntities[subent]) return;
    this.subEntities[subent].explode();
    this.$number2BlowUp--;
  }
}

// make the death a little more spectacular by detonating the subentities:
// detonate subentites every 0.5 seconds
// params: doomedStarDestroyer: the ship of which the entities are to be blown up
this.$startSubDetonations = function(doomedStarDestroyer) {
  if (doomedStarDestroyer.subEntities) {
    doomedStarDestroyer.$number2BlowUp = doomedStarDestroyer.subEntities.length/8;
    // 5 seconds countdown till detonation, but Timer starts only after 1 second =&gt; 4 (* 2 -&gt; every 0.5 seconds)
    doomedStarDestroyer.$detonationTimer = new Timer(doomedStarDestroyer, doomedStarDestroyer.$detonateSubents, 1, 0.5);
    log(&quot;doomed stardestroyer&quot;, this + &quot;: number2BlowUp: &quot; + doomedStarDestroyer.$number2BlowUp + &quot; (subentities: &quot; + doomedStarDestroyer.subEntities.length + &quot;)&quot;);
  } else {
    log(&quot;doomed stardestroyer&quot;, ship + &quot;: has no subentities.&quot;);
  }
  doomedStarDestroyer.entityDestroyed = function() {
    log(this, &quot;cleaning up detonation timer: &quot;, this.$detonationTimer);
    if (this.$detonationTimer) {
      if (this.$detonationTimer.isRunning) this.$detonationTimer.stop();
      delete this.$detonationTimer;
    }
  }
}

// cleanup after ship has been destroyed
this.entityDestroyed = function() {
  log(this, &quot;cleaning up detonation timer: &quot;, this.$detonationTimer);
  if (this.$detonationTimer) {
    if (this.$detonationTimer.isRunning) this.$detonationTimer.stop();
    delete this.$detonationTimer;
  }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/spawn.js-</td>
                    <td><pre>// Configuration -- customize here 
this.role = &quot;stardestroyer&quot;; 
this.count = 4; 

// Standard attributes 
this.name           = &quot;Spawn-&quot; + this.role; 
this.author         = &quot;Staer9&quot;; 
this.copyright      = &quot;This script is hereby placed in the public domain.&quot;; 
this.version        = &quot;1&quot;; 
this.description    = &quot;Script to make several ships of a given role appear at the witchpoint after every jump.&quot; 


this.shipWillLaunchFromStation = function() 
{ 
    system.legacy_addSystemShips(this.role, this.count, 1.0); 
    log(&quot;testscript.spawn&quot;, &quot;Generated &quot; + this.count + &quot; &quot; + this.role + &quot; for testing purposes.&quot;); 
} 
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/stardestroyer-eqcond.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;stardestroyer_eqcond&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2016 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.version     = &quot;1.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context) {
    if (eqKey == &quot;EQ_TIE_F&quot; || eqKey == &quot;EQ_TIE_I&quot; ) {
        if( ship == player.ship &amp;&amp; player.ship.docked
            &amp;&amp; player.ship.dockedStation &amp;&amp; player.ship.dockedStation.hasShipyard ) {
            var w = worldScripts.stardestroyer;
            if( w.$FightersOfPlayer &lt; w.$MaxFighters )
                return true;
        }
    } else if (eqKey == &quot;EQ_TIE_FF&quot; ) {
        if( ship.dataKey == &quot;stardestroyer&quot; || ship.dataKey ==  &quot;stardestroyer-player&quot; )
            return true;
    } else if (eqKey == &quot;EQ_TIE_IF&quot; ) {
        if( ship.dataKey == &quot;stardestroyer-pirate&quot; || ship.dataKey == &quot;stardestroyer-pirate2&quot;
            || ship.dataKey ==  &quot;stardestroyer-player2&quot; )
            return true;
    }
    return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/stardestroyer-fighter.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;stardestroyer-fighter&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2016 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;support functions for fighters&quot;;

this.$FighterHull = this.ship.maxEnergy; //must repair in hangar, avoid recharge when no shields
this.$FighterNumber = 0; //order of this fighter in escort formation
this.$FighterOwner = null; //store the mothership
this.$FighterShields = false; //cache of this.ship.scriptInfo.npc_shields
this.$OwnerScoopPos = null; //store the mothership&#39;s scoop position for landing
this.$TimerLandNow = null; //trigger _landNow() after some time for sure landing
this.$ws = worldScripts.stardestroyer;

//ship script events
this.shipAttackedOther = function(other) {
        if( other &amp;&amp; other.isDerelict &amp;&amp; other == this.ship.target )
                this.ship.target = null; //do not destroy derelicts, choose another target instead
}

this.shipBountyChanged = function(delta,reason) {
        //prevent orange scanner flag on player&#39;s fighters with ShipVersion OXP
        if(this.$FighterOwner == player.ship &amp;&amp; this.ship.bounty &gt; 0 ) {
                this.ship.bounty = 0; //Warning: this change trigger this event again!
        }                             //So must check before that bounty is greater than 0
}                                     //else this is an infinite loop which make Crash To Desktop!

this.shipCollided = this.shipWasScooped = function(otherShip) {
        if(otherShip == this.$FighterOwner) {
            this.ship.energy = this.ship.maxEnergy; //sometimes prevent destruction

            if(this.ship.AIState == &quot;LANDING&quot;) //put into the hangar
                this._landNow(this.ship, this.$FighterOwner);
        }
}

this.shipTakingDamage = function(amount, whom, type) {
        this.$FighterHull -= amount; //workaround recharge when no shields
        if( !this.$FighterShields ) {
                if(this.$FighterHull &lt; 0) {
                    delete this.shipTakingDamage;//prevent infinite loop
                    this.ship.explode();
                }
        }
}

this.shipSpawned = function() {
        if( this.ship &amp;&amp; this.ship.scriptInfo &amp;&amp; this.ship.scriptInfo.npc_shields == &quot;no&quot; ) {
                this.$FighterShields = false;
        } else this.$FighterShields = true;
}

this.spawnedAsEscort = function(mother) {  //for NPC mothers
        if(mother &amp;&amp; mother.script) {
            if(!mother.script.$LaunchedFighters) mother.script.$LaunchedFighters = 1;
            else mother.script.$LaunchedFighters++;
            this.$FighterNumber = mother.script.$LaunchedFighters;
            if(!mother.script.$Fighters) mother.script.$Fighters = [];
            mother.script.$Fighters.push(this.ship);
            this.ship.displayName = this.ship.name+&quot; #&quot;+this.$FighterNumber;
        }
        this.$FighterOwner = mother;
}

this.shipTargetDestroyed = function(target) {
        if(this.ship == player.ship || this.$FighterOwner != player.ship )
            return; //exit if worldScript, do in ship script only
        if(target.primaryRole == &quot;constrictor&quot; &amp;&amp; missionVariables.conhunt &amp;&amp; missionVariables.conhunt == &quot;STAGE_1&quot;) {
                // just in case an escort kills the constrictor, let&#39;s not break the mission for the player...
                missionVariables.conhunt = &quot;CONSTRICTOR_DESTROYED&quot;;
        }
        
        if(target.isRock || target.isBoulder || target.isCargo || target.isWeapon)
                return;
        
//      player.score += 1; - score should remain personal
        var b = &quot;&quot;;
        if(target.bounty &gt; 0) {
            b = &quot; : &quot; + target.bounty + &quot;₢ awarded.&quot;;
            player.credits += target.bounty;
        }
        player.consoleMessage(this.ship.displayName+&quot; killed &quot;+target.name+b, 5);
        log(this.name, this.ship.displayName+&quot; killed &quot; + target.name + &quot; : &quot; + target.bounty +&quot;₢&quot;);
}

this.shipDied = function(whom,why) {
        if(this.ship == player.ship) return; //exit if worldScript, do in ship script only
        //var w = worldScripts.escortdeck;

        //increase steering and acceleration in proportion with the smaller mass on deck
        //w.$EscortDeck_SetMaxs( player.ship, w );

        //var pad = w.$EscortDeckShip.indexOf(this.ship);
        //if( pad &gt; -1 ) w.$EscortDeckShipData[pad] = null; //prevent recreation in dock
        
        if( whom &amp;&amp; whom.isValid &amp;&amp; whom != player.ship &amp;&amp; this.$FighterOwner == player.ship ) {
                player.commsMessage(&quot;A &quot;+this.ship.name+&quot; is lost.&quot;, 5);
                this.$ws._MFD(); //update numbers in MFD
        }
        log(this.name, this.ship.displayName+&quot; terminated by &quot;+whom+&quot; &quot;+why);
}


//fighter functions

this._escortPosition = function() {this._escortPosition2(this.ship);} //for stardestroyer-fighterAI.plist

this._escortPosition2 = function(ship) {
        var sc = ship.script;
        if( !sc || !sc.$FighterNumber || !sc.$FighterOwner || !sc.$FighterOwner.isValid
            || ship == player.ship ) return; //for sure
        ship.scanClass = &quot;CLASS_BUOY&quot;;//for scoop deactivation at stopped landing and no masslock

        if( sc.$FighterOwner == player.ship &amp;&amp; player.alertCondition == 1 ) { //green alert
            ship.AIState == &quot;LANDING&quot;;
            this.$ws._MFD(); //update if owner is the player
            return;
        }

        if( ship.target &amp;&amp; ship.target.hasHostileTarget ) {
            ship.setAI(&quot;interceptAI.plist&quot;);
            return;
        }

        var epos = sc.$ws.coordinatesForEscortPosition(sc.$FighterNumber);
        var pos = sc.$FighterOwner.position.add(epos);
        ship.savedCoordinates = pos;
        if( ship.injectorSpeedFactor &gt; 0 )
            ship.desiredSpeed = ship.injectorSpeedFactor * ship.maxSpeed;
        else ship.desiredSpeed = 7 * ship.maxSpeed; //for Oolite 1.80
        ship.desiredRange = 0; //go to the escort position in the formation
        ship.performFlyToRangeFromDestination();
        ship.reactToAIMessage(&quot;OWNER_FAR&quot;);//go back to owner
        //var dist = ship.position.distanceTo(sc.$FighterOwner.position);
        //if(dist &gt; 10000) ship.reactToAIMessage(&quot;OWNER_FAR&quot;);//go back to owner
        //else if(dist &gt; 5000) ship.reactToAIMessage(&quot;OWNER_NEAR&quot;);//go back to owner
        //else ship.reactToAIMessage(&quot;OWNER_NEXT&quot;);//keep formation
}

this._landing = function() {this._landing2(this.ship);}

this._landing2 = function(ship) {
        var sc = ship.script;
        if( !sc || ship == player.ship ) return; //for sure
        ship.scanClass = &quot;CLASS_CARGO&quot;;//for scoop activation

        var owner = sc.$FighterOwner;
        if( !owner || !owner.isValid ) return;

        ship.target = null; //clear target to stop attack

        var landingdist = 50; //m from the scoop position of owner where put into hangar
        //make a waypoint below the owner&#39;s scoop position
        var scooppos = owner.position;
        var sp = this.$OwnerScoopPos;
        if( !sp ) { //first time read scoop pos from shipdata.plist
            var shipdata = Ship.shipDataForKey(owner.dataKey);
            if( shipdata ) {
                sp = shipdata[&quot;scoop_position&quot;];
                if(sp &amp;&amp; sp != &quot;undefined&quot;) {
                    sp = sp.split(&quot; &quot;,3);
                    if( sp &amp;&amp; sp.length == 3 ) {
                        this.$OwnerScoopPos = sp;
                        //log(this.name, owner.name+&quot; scoop_position:&quot;+sp); //debug
                    }
                }
            }
            if( !this.$OwnerScoopPos ) { //no scoop pos in shipdata so make one
                this.$OwnerScoopPos = [];
                this.$OwnerScoopPos[0] = 0;
                this.$OwnerScoopPos[1] = -20;
                this.$OwnerScoopPos[2] = 0;
                sp = this.$OwnerScoopPos;
            }
        }
        scooppos = scooppos.add(owner.vectorRight.multiply(sp[0]))
                            .add(owner.vectorUp.multiply(sp[1]))
                            .add(owner.heading.multiply(sp[2]));
        var down = 1.5*owner.collisionRadius; //AI never enter into collisionRadius
        var downpos = scooppos.add(owner.vectorUp.multiply(-down));
        ship.savedCoordinates = downpos.add(owner.velocity.multiply(6)); //go below the owner
        // also must use setDestinationFromCoordinates in AI.plist

        var d = ship.position.distanceTo(scooppos);
        var d2 = ship.position.distanceTo(downpos);
        //log(this.name, d);
        if( this.$ws.$TractorBeam ) {
                if( d &lt; landingdist ) { //enough near?: add to the hangar
                        this._landNow(ship, owner);
                        return;
                }
                if( d2 &lt; down ) { //arrived below the owner?
                        //if( owner.addCollisionException ) { //need Oolite v1.81
                        //    owner.addCollisionException(ship); //must go near
                            //log(this.name, &quot;coll.ex.len:&quot;+owner.collisionExceptions.length);//debug
                        //}

                        //go up to the owner&#39;s center point from below into the dock
                        ship.savedCoordinates = scooppos.add(owner.velocity.multiply(2));
                        // also must use setDestinationFromCoordinates in AI.plist

                        //apply &quot;tractor beam&quot; to pull this fighter to the scoop
                        var v = scooppos.subtract(ship.position);
                        ship.velocity = v.direction().multiply(200).add(v.multiply(0.4))
                                .add(owner.velocity);

                        //make sure the fighter will land after 10 seconds
                        if( !this.$TimerLandNow )
                                this.$TimerLandNow = new Timer(this, this._TimedLandNow.bind(this), 10);

                        ship.desiredSpeed = 0; //must set before &quot;OWNER_NEXT&quot;
                        ship.reactToAIMessage(&quot;OWNER_NEXT&quot;); //go straight
                        return;
                }
        } else { //land without tractor beam
                if( d &lt; landingdist ) {
                        //must be triggered outside collisionRadius of owner
                        this._landNow(ship, owner); //add to the hangar
                        return;
                } else if( d2 &lt; down ) { //surely land after 10 seconds
                        if( !this.$TimerLandNow )
                                this.$TimerLandNow = new Timer(this, this._TimedLandNow.bind(this), 10);
                        //go up to the owner&#39;s center point from below into the dock
                        ship.savedCoordinates = scooppos.add(owner.velocity);
                        ship.desiredSpeed = ship.maxSpeed; //must set before &quot;OWNER_NEXT&quot;
                        ship.reactToAIMessage(&quot;OWNER_NEXT&quot;); //go straight
                        return;
                }
        }

        if( d &lt; 2000 ) ship.reactToAIMessage(&quot;OWNER_NEAR&quot;); //approach owner at normal speed
        else ship.reactToAIMessage(&quot;OWNER_FAR&quot;); //use injectors in approach if available
}

this._landNow = function(ship, owner) { //put back into the internal hangar
        if(!ship || !owner || !owner.isValid) return; //for sure
        var f = [], f2 = []; //remove from $Fighters array
        if( owner == player.ship ) {
            if( this.$ws.$LaunchedFighters &gt; 0 ) this.$ws.$LaunchedFighters--;
            f = this.$ws.$Fighters;
        } else if( owner.script ) {
            if( owner.script.$LaunchedFighters &gt; 0 ) owner.script.$LaunchedFighters--;
            f = owner.script.$Fighters;
        }
        var out = 0;
        for(var i = 0; i &lt; f.length; i++) {
            var fi = f[i];
            if( fi != ship ) {
                f2.push(fi);
                if( fi &amp;&amp; fi.isValid ) out++;
            }
        }
        if( owner == player.ship ) {
            this.$ws.$Fighters = f2;
            this.$ws._MFD(); //update numbers in MFD
            if( out == 0 ) {
                player.commsMessage(&quot;All fighters landed&quot;, 10);
                player.consoleMessage(&quot; &quot;, 10); //make room to the countdown
            }
        } else if( owner.script ) owner.script.$Fighters = f2;

        //prevent double landing if both shipCollided and shipWasScooped is fired
        var sc = ship.script;  
        if( sc ) sc.$FighterOwner = null;

        //if( owner.removeCollisionException ) { //need Oolite v1.81
        //    owner.removeCollisionException(ship); //must go near
            //log(this.name, &quot;coll.ex.len:&quot;+owner.collisionExceptions.length);//debug
        //}
        ship.remove(true); //landed
}

this._newTarget = function() {this._newTarget2(this.ship);} //AI in plist located new target

this._newTarget2 = function() { //AI in plist located new target
        var sc = ship.script;
        if( !sc || ship == player.ship ) return; //for sure
        var owner = sc.$FighterOwner;
        if( !owner || !owner.isValid || owner != player.ship ) return; //player&#39;s fighters only
        var t = ship.target;
        if( !this.$ws._isValidFighterTarget(t, owner) ) return;

        player.consoleMessage(ship.name+&quot; #&quot;+this.$FighterNumber+&quot; aim &quot;+t.displayName, 4.5);
        this.$ws._MFD(); //update numbers in MFD
}

this._TimedLandNow = function() { 
        if( this.$TimerLandNow ) {
                this.$TimerLandNow.stop();
                delete this.$TimerLandNow;
        }
        this._landNow(this.ship, this.$FighterOwner);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/stardestroyer-shuttle.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;stardestroyershuttle&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2016 Norby&quot;;
this.description= &quot;Ship script for stardestroyershuttle&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;

this.$FighterOwner = null; //store the mothership

//ship script events
this.shipCollided = function(otherShip) {
	//prevent destruction, at least sometimes
	if(otherShip == this.$FighterOwner) this.ship.energy = this.ship.maxEnergy;
}

this.shipDied = function() {
        if( this.$FighterOwner == player.ship ) {
                var w = worldScripts.stardestroyer;
                if(this.ship == w.$stardestroyershuttle)
                        w.$stardestroyershuttle = null;
        } else if(this.$FighterOwner &amp;&amp; this.$FighterOwner.script
                &amp;&amp; this.ship == this.$FighterOwner.script.$stardestroyershuttle) {
                this.$FighterOwner.script.$stardestroyershuttle = null;
        }

}

this.shipWillDockWithStation = function(station) {
        if( this.$FighterOwner == player.ship ) {
                var w = worldScripts.stardestroyer;
	        if(this.ship == w.$stardestroyershuttle) {
		        w.$stardestroyershuttle = null;
                	player.ship.target = null;
                        station.commsMessage(&quot;Your Shuttle arrived to &quot;+station.name, player.ship);
	                station.dockPlayer();
                }
        } else if(this.$FighterOwner &amp;&amp; this.$FighterOwner.script
                &amp;&amp; this.ship == this.$FighterOwner.script.$stardestroyershuttle) {
                this.$FighterOwner.script.$stardestroyershuttle = null;
                this.$FighterOwner.target = station; //NPC SD launch another Shuttle for ambience
        }
        this.ship.remove(true);
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/stardestroyer.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;stardestroyer&quot;;
this.author         = &quot;GGShinobi, Norby&quot;;
this.copyright      = &quot;© 2013 GGShinobi, Creative Commons: attribution, non-commercial, sharealike.&quot;;
this.description    = &quot;some special actions for the stardestroyer.&quot;;

// CHANGELOG:
// changes from 0.0.2 to 0.0.3: - added player ship handler, fighters and ILS support by Norby
// changes from 0.0.1 to 0.0.2: - added &quot;throw_sparks = yes;&quot; to wrecked stardestroyer in shipdata.plist
// changes from 0.0.0 to 0.0.1: - fixed bug that orientation of doomedStarDestroyer didn&#39;t match the orientation
//   of the original stardestroyer. Thanx to cim!

//this script works as NPC ship script and also worldScript for the player

//settings
this.$FighterCost = [1000, 2000]; //cost of TIE Fighter and Interceptor, equipment.plist also!
this.$LaunchDelay = 1; //delay between launch of fighter groups in seconds
this.$MaxFighters = 72; //capacity of the internal fighter hangar
this.$MFDName = &quot;Star Destroyer Fighters&quot;; //name appear in HUD and MFD Selector Interface
this.$TractorBeam = true; //pull fighters to the scoop position of owner at landing

//internal variables, should not touch
this.$EscortPositions = []; //store positions for escort formation
this.$Fighters = []; //Active, launched fighters
this.$FightersOfPlayer = 0; //actually how many figters are in player&#39;s star destroyer
this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar
this.$LaunchInProgress = false; //do not launch fighters too often
this.$LeftBehindFighters = 0; //set in shipWillEnterWitchspace, read in shipExitedWormhole
this.$LeftBehindSystem = &quot;&quot;;  //set in shipWillEnterWitchspace, read in shipExitedWormhole
this.$simulator = false; //detect if combat simulator is running
this.$stardestroyershuttle = null; //player docking support ship
this.$Targets = []; //Ships once targeted by fighters, indexed by entityPersonality
this.$TimerDelay = null; //for fighter launch delay


//event handlers

this.startUp = function() {
    this.$FightersOfPlayer = missionVariables.$StarDestroyerFightersOfPlayerPlusOne;
    if( !this.$FightersOfPlayer ) this.$FightersOfPlayer = this.$MaxFighters;
    else this.$FightersOfPlayer--; //missionVariables store one more to avoid 0

    var h = worldScripts.hudselector;
    if( h &amp;&amp; h.$HUDSelectorAddMFD ) h.$HUDSelectorAddMFD(this.name, this.$MFDName);
    
    var e, p = player.ship;
    e=&quot;EQ_DTADAM&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
    e=&quot;EQ_DTADER&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
    e=&quot;EQ_DTAEMP&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
    e=&quot;EQ_DTAMIN&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
    e=&quot;EQ_DTAUSA&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
    e=&quot;EQ_DTAWEA&quot;; if(p.equipmentStatus(e)===&quot;EQUIPMENT_OK&quot;) p.removeEquipment(e);//fix for towbar
}

this.startUpComplete = function() {
    var t = worldScripts.trophy_col;
    if(t) { //remove bogus trophy entry
        var n = &quot;Star Destroyer [reactor breach detected]&quot;;
        for (var j = t.$trophyArray.length - 1; j &gt;= 0; j--) {
            if (t.$trophyArray[j][0] === n) t.$trophyArray.splice(j,1);
        }
        for (var j = t.$trophyLog.length - 1; j &gt;= 0; j--) {
            if (t.$trophyLog[j][0] === n) t.$trophyLog.splice(j,1);
        }
    }
}

this.alertConditionChanged = function(newCondition, oldCondition) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( !this._playerInStarDestroyer(ship) || player.docked ) return;
    this._MFD();

    if( newCondition == 1 ) { //green alert in space so fighters should go back to hangar
        var out = this._fightersLanding();
        if( out &gt; 0 ) {
            var s = out+&quot; fighters are&quot;;
            if( out == 1 ) s = &quot;A fighter is&quot;;
            player.consoleMessage(s+&quot; landing&quot;, 4.5);
        }
    } else if( newCondition == 2 || newCondition == 3 &amp;&amp; player.alertHostiles ) {
        this._fightersStopLanding(); //cancel landing in yellow or red alert
        this._reconsiderTargets(p, p.target); //update targets of launched fighters
    }
}

this.coordinatesForEscortPosition = function(index) {
    var pos = this.$EscortPositions[index]; //cache of positions
    if( !pos ) pos = this.$EscortPositions[index] = this.coordinatesForEscortPosition2(index);
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( ship &amp;&amp; ship.isValid ) pos = pos.add(ship.velocity.multiply(4)); //adjusted for movement
    return(pos);
}

this.coordinatesForEscortPosition2 = function(index) {
        //6 groups in hexagon form like the Imperial Logo, for 6*4=24 fighters
        //the ring of groups always show the xz plane of system due to zero second coordinates
        var positions = [new Vector3D(0,0,1), new Vector3D(0,0,-1),
                         new Vector3D(-0.8,0,0.5), new Vector3D(0.8,0,0.5),
                         new Vector3D(-0.8,0,-0.5), new Vector3D(0.8,0,-0.5)];
        var space = 100; //m space between escorts in the same group
        var zoom = 3000; //m, radius of group positions around the main ship

        //small adjustment in x position to form horizontal lines within groups
        var layer = 1+Math.floor(index/positions.length);
        var xdir = 1; //spread one left, one right, starting from center to outside
        var i = layer/2;
        var fi = Math.floor(i);
        if( fi == i ) xdir = -1;
        var x = xdir * space * ( 0.5 + (fi % 4) ); //x positions within a group: -50 50 -150 150

        //small adjustment in y position for more than 24 fighters
        var y = space * ( -0.5 + Math.floor(index/(4*positions.length)));

        var group = index % positions.length;
        return positions[group].multiply(zoom).add([x,y,0]);
}

this.distressMessageReceived = function(aggressor, sender) {
    this._launchFighters(aggressor);
}

this.helpRequestReceived = function(ally, enemy) {
    this._launchFighters(enemy);
}

this.playerBoughtEquipment = function(equipmentKey) {
    if(equipmentKey === &quot;EQ_TIE_F&quot; || equipmentKey === &quot;EQ_TIE_I&quot;) {
        player.ship.removeEquipment(equipmentKey);
        if( this.$FightersOfPlayer &lt; this.$MaxFighters )
            this.$FightersOfPlayer++;
        var f = &quot;&quot;;
        if( this.$FightersOfPlayer &lt; this.$MaxFighters )
            f = &quot; of &quot;+this.$MaxFighters+&quot; fighters, buy again for more.&quot;;
        else f = &quot; fighters, hangar is full.&quot;;
        player.consoleMessage(&quot;You have &quot;+this.$FightersOfPlayer+f, 5);
    }
}

this.playerCancelledJumpCountdown = function() {  //stop landing
    if(!this._playerInStarDestroyer(player.ship)) return;
    this._fightersFollow();
}

this.playerJumpFailed = function(reason) {
    if(!this._playerInStarDestroyer(player.ship)) return;
    this._fightersFollow();
}

this.playerStartedJumpCountdown = function(type, seconds) { //landing fighters
    if(!this._playerInStarDestroyer(player.ship)) return;
    var out = this._fightersLanding();
    if( out &gt; 0 ) {
        var s = out+&quot; fighters&quot;;
        if( out == 1 ) s = &quot; a fighter&quot;;
        player.consoleMessage(&quot;Warning: &quot;+s+&quot; need landing!&quot;, 10);
        player.consoleMessage(&quot; &quot;, 10); //make room to the countdown
    }
}

this.playerWillSaveGame = function(message) {
        missionVariables.$StarDestroyerFightersOfPlayerPlusOne = this.$FightersOfPlayer + 1;
}

this.shipAttackedOther = function(whom) {
    this._launchFighters(whom);
}

this.shipAttackedWithMissile = function(missile, whom) {
    this._launchFighters(whom);
}

this.shipBeingAttacked = function(whom) {
    this._launchFighters(whom);
}

this.shipCollided = function(otherShip) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( !this._playerInStarDestroyer(ship) ) return;

    if( this._isStation(otherShip) ) {
        //check if facing to a station - must exclude non-facig to skip collisions at launch
        var angle = ship.heading.angleTo( otherShip.position.subtract(ship.position) );
        otherShip.commsMessage(&quot;Docking sequence initiated&quot;, player.ship); //angle); //debug
        if( angle &lt; 1.5 ) otherShip.dockPlayer(); //this help needed by ILS OXP to dock Star Destroyer
    }
}


// sometimes, the reactor core of the stardestroyer breaches, resulting in a gigantic explosion
// of a destructive force equivalent to that of a q-bomb! Beware!!
this.shipDied = function(whom, why) {
//  if (Math.random() &gt; 0.77) { // chance for reactor breach: 33 %
    // this.ship.spawn(&quot;stardestroyer_reactor_breach&quot;, 1);
    if(!this.ship || !this.ship.position) return;

    if(this.ship.primaryRole == &quot;pirate-aegis-raider&quot; //aegis raider should not blow up the station
        || this.ship.dataKey == &quot;stardestroyer-pirate2&quot;) //no black reactor breach ship in shipdata
        return;

    var doomedStarDestroyer = system.addShips(&quot;stardestroyer_reactor_breach&quot;, 1, this.ship.position, 0)[0];
    doomedStarDestroyer.orientation = this.ship.orientation; // change orientation to that of the original ship
    doomedStarDestroyer.velocity = this.ship.velocity;
    doomedStarDestroyer.script.$startSubDetonations(doomedStarDestroyer);
//  }
}

this.shipWillExitWitchspace = function() {
    var lbf = this.$LeftBehindFighters;
    if( lbf &gt; 0 ) {
        var s = lbf+&quot; fighters&quot;;
        if( lbf == 1 ) s = &quot;a fighter&quot;;
        var msg = &quot;You left behind &quot;+s+&quot; in &quot;+this.$LeftBehindSystem;
        player.commsMessage(msg, 10);
        log(this.name, msg);
        this.$LeftBehindFighters = 0;
    }
}

this.shipFiredMissile = function(missile, target) {
    this._launchFighters(target);
}

// check when the player launches if this is a simulator run
this.shipLaunchedFromStation = function(station) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( !this._playerInStarDestroyer(ship) ) return;

    var w = worldScripts[&quot;Combat Simulator&quot;];
    if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) this.$simulator = true;
    else this.$simulator = false;
}

this.shipTakingDamage = function(amount, whom, type) {
    this._launchFighters(whom);
}

this.shipTargetAcquired = function(t) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( ship == p ) {
        if( !this._playerInStarDestroyer(ship) ) return;
        this._MFD();
        this._reconsiderTargets(ship, t); //update targets of launched fighters
    }

    if( this._isStation2( t, ship ) //launch shuttle if station is targeted
        //player also must have no undamaged ILS equipment on board (NPC SD always send Shuttle)
        &amp;&amp; ( ship != p || p.equipmentStatus(&quot;EQ_ILS&quot;) != &quot;EQUIPMENT_OK&quot; ) ) {
        var s = this.$stardestroyershuttle;
        if( s &amp;&amp; s.isValid &amp;&amp; s.target != t ) s.target = t;
        if( !s &amp;&amp; ( ship != p || !p.missilesOnline ) ) {
            s = ship.spawnOne(&quot;[stardestroyershuttle]&quot;);
            if( s &amp;&amp; s.isValid ) {
                this.$stardestroyershuttle = s;
                s.target = t;
                var msg = &quot;&quot;;
                if( !s.target ) {
                    msg = &quot;Your Shuttle is not launched due to no friendly station nearby&quot;;
                    if(ship == p) player.consoleMessage(msg, 4.5);
                    s.remove(true);
                } else {
                    msg = &quot;Your Shuttle is going to &quot;+s.target.name;
                    if(ship == p) player.consoleMessage(msg, 10);
                    s.position = ship.position.add(ship.vectorUp.multiply(-150));
                    s.orientation = ship.orientation;
                    if( s.injectorSpeedFactor &gt; 0 ) 
                        s.desiredSpeed = s.injectorSpeedFactor * s.maxSpeed;
                    else s.desiredSpeed = 7 * s.maxSpeed; //for Oolite 1.80
                    s.velocity = ship.velocity.add(ship.vectorForward.multiply(700)); //initial push
                    if(!s.script) s.script = &quot;stardestroyer-shuttle.js&quot;; //for sure
                    if(s.script) s.script.$FighterOwner = ship;//store owner for ship script
                    ship.target = s; //lock to the shuttle: player can see it, NPC avoid to dock by ILS
                }
            }
        }
    }
}

this.shipTargetLost = function(t) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( this._playerInStarDestroyer(ship) ) {
        this._MFD();
    }
}

this.shipWillDockWithStation = function(station) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    
    if( this._playerInStarDestroyer(ship) ) {
        this.$stardestroyershuttle = null; //player docking support ship

        // if this was a simulator run, reset the variable and return - no docking fee in this case
        if (this.$simulator == true) {
            this.$simulator = false;
        } else if( ship.equipmentStatus(&quot;EQ_TIE_FF&quot;) != &quot;EQUIPMENT_OK&quot;
                    &amp;&amp; ship.equipmentStatus(&quot;EQ_TIE_IF&quot;) != &quot;EQUIPMENT_OK&quot; ) {
            var s = &quot;&quot;; if( this.$FightersOfPlayer &gt; 1 ) s = &quot;s&quot;; //current fighters in plural
            player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-factorydamaged]&quot;,
                    {fightersofplayer: this.$FightersOfPlayer, plural:s, maxfighters:this.$MaxFighters}));
        } else {
            var itc = 0; //index of TIE Fighter&#39;s cost in this.$FighterCost array
            if( ship.equipmentStatus(&quot;EQ_TIE_IF&quot;) == &quot;EQUIPMENT_OK&quot; )
                itc = 1; //index of TIE Interceptor&#39;s cost when ride Imperial variant of SD
            var fee = this.$FighterCost[itc];
            var f = this.$Fighters;
            for(var i = 0; i &lt; f.length; i++) {
                var fi = f[i];
                if( !fi || !fi.isValid ) this.$FightersOfPlayer--; //reduce total with lost ones
                else fi.remove(true); //do not leave fighters outside of the station
            }
            var bf = 0; //bought fighters
            var lf = 0; //lost fighters
            for(var i = this.$FightersOfPlayer; i &lt; this.$MaxFighters; i++) {
                lf++;
                if (player.credits &gt; fee) { // make sure the player has enough credits
                    player.credits -= fee; //buy a fighter
                    this.$FightersOfPlayer++;
                    bf++;
                }
            }
            var cbf = fee * bf; //cost of bougth fighters
            var s = &quot;&quot;; if( lf &gt; 1 ) s = &quot;s&quot;; //lost fighters in plural
            var s2 = &quot;&quot;; if( this.$FightersOfPlayer &gt; 1 ) s2 = &quot;s&quot;; //current fighters in plural
            if( !(lf &gt; 0) ) {
                //no lost fighters, have a nice trip
                var s = &quot; is&quot;; if( this.$MaxFighters &gt; 1 ) s = &quot;s are&quot;; //fighters in plural
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-allfighters]&quot;,
                    {maxfighters:this.$MaxFighters, plural:s}));
            } else if( !station || !station.isValid || !station.hasShipyard ) {
                //no shipyard, no replace
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-noshipyard]&quot;,
                    {sdlostfighters:lf, plural:s, maxfighters:this.$MaxFighters}));
            } else if( bf == lf ) {
                //bought all missing fighters
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-boughtfighters]&quot;,
                    {sdlostfighters:lf, plural:s, costofbougthfighters:cbf,
                        fightersofplayer: this.$FightersOfPlayer, plural2:s2}));
            } else if( bf &gt; 0 ) {
                //bought some but not all missing fighters
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-notenoughmoney]&quot;,
                    {sdlostfighters:lf, plural:s, costofbougthfighters:cbf, numberofbougthfighters:bf,
                        fightersofplayer: this.$FightersOfPlayer, plural2:s2}));
            } else if( lf &gt;= this.$MaxFighters &amp;&amp; bf == 0 ) {
                //all fighters are missing but none bought
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-emptyhangar]&quot;,
                    {sdlostfighters:lf, plural:s, fightercost: fee}));
            } else if( bf == 0 ) {
                //at least one fighter is missing but none bought
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-nomoneyforone]&quot;,
                    {sdlostfighters:lf, plural:s, fightersofplayer: this.$FightersOfPlayer, plural2:s2}));
            } else {
                //not a real chance to arrive here, just display the current fighter status for sure
                player.addMessageToArrivalReport(expandDescription(&quot;[stardestroyer-noshipyard]&quot;,
                    {sdlostfighters:lf, plural:s, maxfighters:this.$MaxFighters}));
            }
        }
    }

    //free up arrays both in NPC ship scripts and player&#39;s array in worldScript
    delete this.$Fighters;
    delete this.$Targets;
    this.$Fighters = [];
    this.$Targets = [];
    this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar

}

this.shipWillEnterWitchspace = function() {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript

    if( this._playerInStarDestroyer(ship) ) {
        this.$stardestroyershuttle = null; //player docking support ship

        this.$LeftBehindFighters = 0; //will be displayed in shipExitedWormhole event
        this.$LeftBehindSystem = system.name;
        var f = this.$Fighters;
        for(var i = 0; i &lt; f.length; i++) {
            var fi = f[i];
            if( !fi || !fi.isValid ) this.$FightersOfPlayer--; //reduce total with lost ones
            else if( fi.script &amp;&amp; fi.script.$TimerLandNow ) {
                this.$TimerLandNow.stop();
                delete this.$TimerLandNow;
                fi.script._landNow(fi, p); //use the last chance to land before left behind
            } else {
                this.$FightersOfPlayer--; //reduce total with left behind ones
                this.$LeftBehindFighters++; //increase left behind fighters
            }
        }
        //log(this.name,&quot;Left behind &quot;+this.$LeftBehindFighters+&quot; fighters in &quot;+this.$LeftBehindSystem);

        delete this.$Fighters;
        delete this.$Targets;
        this.$Fighters = [];
        this.$Targets = [];
        this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar
    }
}

this.shipWillLaunchFromStation = function(station) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript

    if( this._playerInStarDestroyer(ship) ) {
        p.position = p.position.add(p.vectorForward.multiply(700)); //prevent collisions at launch
        this._MFD(); //show mfd as early as other MFDs
    }
}


//local functions

this._fightersAIState = function(state, stoplanding) { //set AI state of fighters to one defined in plist
    var p = player.ship; //AI is not applicable on player, must check to prevent error in log
    var f = this.$Fighters;
    var out = 0;
    for(var i = 0; i &lt; f.length ; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid &amp;&amp; fi != p ) {
            var fighterai = &quot;stardestroyer-fighterAI.plist&quot;;
            if(fi.AI != fighterai ) fi.switchAI(fighterai);
            fi.target = null; //clear target to stop attack

            if( !stoplanding || fi.AIState == &quot;LANDING&quot; )
                fi.AIState = state; //FOLLOW or LANDING
            out++;
        }
    }
    if( out &gt; 0 ) this._MFD(); //refresh
    return(out); //report how many fighters affected
}

this._fightersFollow = function() { //set AI of all valid fighters to follow
    return(this._fightersAIState(&quot;FOLLOW&quot;));
}

this._fightersLanding = function() { //start landing
    return(this._fightersAIState(&quot;LANDING&quot;));
}

this._fightersStopLanding = function() { //stop landing only, others untouched
    return(this._fightersAIState(&quot;FOLLOW&quot;, true));
}

this._isNewTargetOrNeedMoreFighters_unused = function(ship, target) { 
    //deprecated, unused function
    if( !target || !target.isValid ) return false;
    //count nearby escorting fighters
    var ships = ship.checkScanner(true);
    //max. 32 ships are returned so this way allow to launch more than the limit if really needed
    //due to some escorts will not be in the returned 32 so leave space to launch another
    var escorts = 0;
    for( var i = 0; i &lt; ships.length; i++ ) {
        var nearbyship = ships[i];
        if( nearbyship &amp;&amp; nearbyship.isValid ) {
            if( this.$Fighters.indexOf(nearbyship) &gt; -1 ) {
                escorts++;
                if( escorts &gt; 24 ) return false; //there are enough fighters nearby
            } else {
                if( ship.escortGroup.containsShip(nearbyship) )
                    ship.escortGroup.removeShip(nearbyship); //make room for sure
            }
        }
    }
    return true; //too few fighters escorting so launch more
}

this._isNewTargetOrNeedMoreFighters_old = function(ship, target) {
    //deprecated function, unused due to can not provide proper limit of launched fighters
    minTargeters = 3; //how many active fighters must keep target lock to avoid additional launch
    if( !target || !target.isValid || target.script &amp;&amp; target.script.$FighterOwner == ship ) return false;
    if( this.$Targets[target.entityPersonality] != target ) {
        this.$Targets[target.entityPersonality] = target;
        return true; //new target, launch a fighter group
    }
    var targeters = 0; //how many active fighters has target lock on this attacker
    var f = this.$Fighters;
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid &amp;&amp; fi.target == target ) {
            targeters++;
            if( targeters &gt;= minTargeters ) return false; //there are enough fighters on this target
        }
    }
    return true; //too few fighters follow this target so launch more
}

this._isStation = function(entity) {
    return this._isStation2(entity, player.ship);
}

this._isStation2 = function(entity, ship) {
    return (entity &amp;&amp; entity.isValid &amp;&amp; entity.isStation
        &amp;&amp; entity.target != ship
        &amp;&amp; entity.dataKey.indexOf(&quot;carrier&quot;) == -1 );
}

this._isValidFighterTarget = function(target, owner) {
    if( target &amp;&amp; target.isValid &amp;&amp; !target.isDerelict
        //check hasHostileTarget but this is never set for player
        &amp;&amp; ( target.hasHostileTarget || target == player.ship )
        &amp;&amp; ( !owner || !owner.isValid || //next conditions need valid owner
            target != owner  //do not target its own mothership
            //do not target friendly figters
            &amp;&amp; ( !target.script || target.script.$FighterOwner != owner )
            //distance from owner is not too much
            &amp;&amp; target.position.distanceTo(owner.position) &lt; owner.scannerRange
            ) ) {
        return(target); //valid target for fighters
    } else return(false);
}

this._launchFighters = function(target) {
    var ship = this.ship;
    if( !ship ) ship = player.ship; //called in worldScript
    if( !target || !target.isValid || target.isDerelict || target == ship //for sure
        || ship == player.ship &amp;&amp; !this._playerInStarDestroyer(ship)) return;
    //continue if NPC or player in Star Destroyer

    if( !this._isValidFighterTarget(target, ship) ) return;//skip invalids like own fighters

    if(target.maxSpeed &gt; 0) //exclude stations but include mobile dockables
        ship.addDefenseTarget(target); //turrets and thargoid lasers will fire
    this._reconsiderTargets(ship, target); //update targets of launched fighters

    if( !this.$LaunchInProgress &amp;&amp; this.$LaunchedFighters &lt; this.$MaxFighters
        &amp;&amp; ( ship != player.ship || this.$LaunchedFighters &lt; this.$FightersOfPlayer
             &amp;&amp; ( !ship.withinStationAegis || player.alertCondition == 3 ) ) ) {
        //&amp;&amp; this._isNewTargetOrNeedMoreFighters(ship, target) ) {
        //launch more fighters, must far below to avoid kill by collision at injector speed
        var pos = ship.position.add(ship.vectorUp.multiply( -200 ));
        var tiekey = &quot;tiefighter&quot;;
        if( ship == player.ship &amp;&amp; ship.equipmentStatus(&quot;EQ_TIE_IF&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
            || ship != player.ship &amp;&amp; ship.dataKey.indexOf(&quot;stardestroyer-pirate&quot;) == 0 ) //NPC ISD
            tiekey = &quot;tieinterceptor&quot;; //only in Imperial-class Star Destroyers
        else if( ship.dataKey.indexOf(&quot;IST_destroyer&quot;) == 0 )
            tiekey = &quot;IST_tiefighter&quot;; //naval, asked by UK_Eliter for Interstellar Tweaks OXP
        var ties = Math.min(this.$MaxFighters-this.$LaunchedFighters,4); //launch 4 fighters at once

        var ships = system.addShips(tiekey, ties, pos, 50);
        var oldlf = this.$LaunchedFighters;
        if(ships) for(var i = 0; i &lt; ships.length; i++) {
            var si = ships[i];
            if(si) {
                this.$Fighters.push(si);
                this.$LaunchedFighters++;
                this.$LaunchInProgress = true;
                si.displayName = si.name+&quot; #&quot;+this.$LaunchedFighters;
                if(!si.script) si.script = &quot;stardestroyer-fighter.js&quot;; //for sure
                if(si.script) {
                    si.script.$FighterNumber = this.$LaunchedFighters;
                    si.script.$FighterOwner = ship; //prevent fighters targeting each other
                    si.script.$TrailsDisabled = 1; //reduce load with Trails OXP
                }
                ship.escortGroup.addShip(si);
                //if(si.AI == &quot;escortAI.plist&quot;) si.AIState = &quot;NEXT_TARGET&quot;;
                si.velocity = ship.velocity.add(ship.vectorForward.multiply(500)); //initial push
                //horizontal line formation with 50m space between ships at -75, -25, 25 and 75m
                si.position = pos.add(ship.vectorRight.multiply(50*(i-(ships.length-1)/2)));
                si.orientation = ship.orientation;
                si.target = target;
                si.performAttack();
                if( ship == player.ship ) {
                    si.bounty = 0; //remove bounty from fighter given in shipdata.plist
                    //si.setBounty(0, &quot;player&#39;s stardestroyer launched a fighter&quot;);
                    si.scannerDisplayColor1 = [0, 0.4, 0]; //green, mean frendly
                    //si.scannerDisplayColor2 = [0, 0.4, 0]; //green, mean frendly
                } else {
                    if( ship.bounty == 0 ) si.bounty = 0; //remove bounty from fighter given in shipdata.plist
                    si.displayName += &quot; of &quot;+ship.displayName; //not owned by the player
                    if(ship.dataKey.indexOf(&quot;stardestroyer-pirate2&quot;) == 0 )
                        si.scannerDisplayColor1 = [0, 0, 0.4]; //darkblue
                }
            }
        }
        if( this.$LaunchInProgress &amp;&amp; !this.$TimerDelay ) {//disable future launches until delay
            this.$TimerDelay = new Timer(this, this._TimedDelay.bind(this), this.$LaunchDelay);
        }
        if( ship == player.ship &amp;&amp; this.$LaunchedFighters &gt; oldlf ) {
            var newf = this.$LaunchedFighters - oldlf;
            var remain = this.$FightersOfPlayer - this.$LaunchedFighters;
            player.consoleMessage(newf+&quot; fighters launched to &quot;+target.name+&quot;, &quot;+remain+&quot; remain&quot;, 4.5);
        }
    }
}

this._mass = function(mass) { //format ship mass to display it in MFD
    if(mass &gt; 0) {
        if(mass &gt; 1000000000) return(Math.floor(mass/1000000000)+&quot;Mt&quot;);
        if(mass &gt; 1000000) return(Math.floor(mass/1000000)+&quot;kt&quot;);
        return(Math.ceil(mass/1000)+&quot;t&quot;); //ceil needed by EscortDeck and ships under 1t
    } else return(&quot;&quot;);
}

this._nameWithMass = function(t) {  //format ship name and mass to display it in MFD
    if( !t || !t.isValid ) return(&quot;&quot;);
    return( t.displayName + &quot; (&quot; + this._mass(t.mass)+&quot;)&quot; );
}

this._playerInStarDestroyer = function(ship) {
    if( ship &amp;&amp; ship.isValid &amp;&amp; ship == player.ship ) {
        if( ship.dataKey.indexOf(&quot;stardestroyer-player&quot;) == 0 )
            return true; //detect both stardestroyer-player and stardestroyer-player2 ships
        else this.$FightersOfPlayer = 0; //no TIE fighters on other ship types
    }
    return false;
}

this._reconsiderTargets = function(owner, target) { //all fighters pick targets
    target = this._isValidFighterTarget(target, owner);
    var f = this.$Fighters;
    var invalidfighters = 0;
    var oldtargetistargetofowner = 0; //how many fighters attacked the owner&#39;s target before reconsider
    var ownertarget;
    if( owner ) {
        if( owner == player.ship &amp;&amp; player.alertCondition == 1 ) { //green alert
            this.alertConditionChanged(1, 1); //keep up landing, do not target anything
            this._MFD(); //update if owner is the player
            return;
        }
        ownertarget = this._isValidFighterTarget(owner.target, owner);
    }

    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid ) {
            var oldtarget = fi.target; //call performAttack at the end if change

            if( !owner &amp;&amp; fi.script ) {
                owner = fi.script.$FighterOwner; //for sure
                if( owner ) ownertarget = this._isValidFighterTarget(owner.target, owner);
            }
            if( owner &amp;&amp; owner.isValid ) {
                if( fi.target &amp;&amp; fi.target.isValid &amp;&amp; fi.target == ownertarget ) {
                    oldtargetistargetofowner++;
                }
                //forget current target?
                if( fi.position.distanceTo(owner.position) &gt; 20000 //go back to owner
                    || !this._isValidFighterTarget(fi.target, owner) ) {
                    fi.target = null;
                }
            }

            //if no target then aim owner&#39;s tagret?
            if( !fi.target &amp;&amp; ownertarget &amp;&amp; ownertarget != fi.target
                &amp;&amp; ownertarget != fi //do not target itself
                //only the half of fighters should attack the mother&#39;s target
                //&amp;&amp; ( i - invalidfighters ) * 2 &lt; f.length - invalidfighters
                ) {
                fi.target = ownertarget; //attack the mother&#39;s target (except friends)
            }

            //only the half of fighters attack the mother&#39;s target
            //if( fi.target &amp;&amp; fi.target.isValid &amp;&amp; fi.target == ownertarget ) {
            //    if( oldtargetistargetofowner*2 &gt; f.length - invalidfighters
            //        &amp;&amp; target &amp;&amp; target.isValid ) {
            //        fi.target = null;
            //    }
            //}

            //if still no target then aim the nearest defensive target?
            if( owner &amp;&amp; owner.isValid &amp;&amp; ( !fi.target || !fi.target.isValid ) ) {
                var d = owner.defenseTargets;
                if( d &amp;&amp; d.length &gt; 0 ) {
                    var mindist = fi.scannerRange;
                    var dmin = -1; //index of nearest defensive target
                    for(var j = 0; j &lt; d.length; j++) {
                        var dj = d[j]; //need valid non-stationary target
                        if( this._isValidFighterTarget(dj, owner) &amp;&amp; dj.maxSpeed &gt; 0 ) {
                            var df = dj.position.distanceTo(fi.position);
                            if( df &lt; mindist ) {
                                mindist = df; //nearest to this fighter
                                dmin = j;
                            }
                        }
                    }
                    if( dmin &gt; -1 ) fi.target = d[dmin];
                }
            }

            //aim the new target?
            if( target &amp;&amp; target != fi &amp;&amp; ( !fi.target || !fi.target.isValid
                //replace any target if the given new target is more than 10km nearer
                || fi.target.position.distanceTo(fi.position) - 10000
                        &gt; target.position.distanceTo(fi.position) ) ) {
                fi.target = target; //lock on the newest aggressor
            }

            if(fi.target) { //attack the target
                if(fi.AI == &quot;stardestroyer-fighterAI.plist&quot; ) fi.setAI(&quot;interceptAI.plist&quot;);
                if(fi.target != oldtarget) fi.performAttack();
            } else { //follow the owner at last resort
                if( fi.AI == &quot;interceptAI.plist&quot; ) fi.exitAI(); //step back to fighterAI
                if( fi.AI == &quot;stardestroyer-fighterAI.plist&quot; ) fi.AIState = &quot;FOLLOW&quot;;
            }
        } else invalidfighters++; //count lost fighters to exclude from total when calculate half of group
    }
    if( owner &amp;&amp; owner == player.ship ) { //tell the result of reconsider to the player
        if( owner.target &amp;&amp; owner.target.isValid ) {
            //count how many fighters target the same ship than owner
            var currenttargetistargetofowner = 0;
            for(var i = 0; i &lt; f.length; i++) {
                var fi = f[i];
                if( fi &amp;&amp; fi.isValid &amp;&amp; fi.target == owner.target) {
                    currenttargetistargetofowner++;
                }
            }
            if( currenttargetistargetofowner &gt; 0
                &amp;&amp; currenttargetistargetofowner != oldtargetistargetofowner ) {
                var s = &quot;&quot;;
                if( currenttargetistargetofowner &gt; 1 ) s = &quot;s&quot;;
                player.consoleMessage( currenttargetistargetofowner
                    +&quot; fighter&quot;+s+&quot; aim &quot;+owner.target.name, 3 );
            }
        }
        this._MFD(); //update if owner is the player
    }
}

this._MFD = function() { //update Star Destroyer MFD
    var p = player.ship; if( !p || !p.isValid ) return;

    var f = this.$Fighters;
    var t = []; //targets
    var n = []; //number of fighters on each targets
    var free = 0; //fighters without target
    var lost = 0; //lost fighters since last dock
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid ) {
            if( fi.target &amp;&amp; fi.target.isValid
                //&amp;&amp; fi.target.position.distanceTo(p.position) &lt; 25600 //exclude far targets
                ) {
                var j = t.indexOf(fi.target);
                if( j == -1 ) {
                    j = t.length;
                    t.push(fi.target);
                }
                if( n[j] &gt; 0 ) n[j]++; //one more fighter lock on this target
                else n[j] = 1; //this is the first fighter who lock on this target
            } else free++; //no target
        } else lost++; //launched but destroyed
    }

    var mfd = &quot;Fighters: &quot;;
    if( free &gt; 0 ) mfd += free+&quot; free, &quot;;
    var stay = this.$FightersOfPlayer - this.$LaunchedFighters;
    if( this.$FightersOfPlayer &gt; 0 ) {
        mfd += stay;
        //if(this.$LaunchedFighters == 0) mfd += &quot; stay&quot;;
    } else mfd += &quot;no one&quot;;  // none on Cobra Mark III
    mfd += &quot; in hangar&quot;;//+p.name;
    if( lost &gt; 0 ) mfd += &quot;, &quot;+lost+&quot; lost&quot;;
    mfd += &quot;\n&quot;;

    var pti = -1; //player target&#39;s index in t array
    var pt = p.target;
    if( pt &amp;&amp; pt.isValid &amp;&amp; (!pt.script || pt.script.$FighterOwner != p) ) {
        pti = t.indexOf(pt);
        var ptn = &quot;None&quot;;
        if( pti &gt; -1 ) ptn = n[pti];
        var ne = &quot;&quot;;
        if( pt.isDerelict ) ne = &quot;derelict &quot;;
        else if( !pt.hasHostileTarget ) ne = &quot;neutral &quot;;
        mfd += ptn+&quot; aim your &quot;+ne+&quot;target &quot;+this._nameWithMass(pt)+&quot;\n&quot;;
    }

    var max = 9;  //max. 9 lines left for targets in MFD
    for(var i = 0; i &lt; t.length &amp;&amp; i &lt; max; i++) {
        if( i != pti ) { //exclude player&#39;s target due to already displayed as first target
            mfd += n[i]+&quot; aim &quot;+this._nameWithMass(t[i])+&quot;\n&quot;;
        }
    }
    //while( i++ &lt; max) mfd += &quot;\n&quot;; //scroll down to the last line

    if( p.setMultiFunctionText ) p.setMultiFunctionText(this.$MFDName, mfd, true);
}

this._MFDAlign = function(left, right) { //insert as many spaces between as fill the line
        var width = 14.2;
        var space = &quot; &quot;;
        left += space;
        var t = left + right;
        while( defaultFont.measureString(t) &lt; width ) {
                left += space;
                t = left + right;
        }
        //fine tune with hair spaces - from spara&#39;s marketObserver
        var hairSpace = String.fromCharCode(31);
        while ( defaultFont.measureString(t + hairSpace) &lt; width ) {
                left += hairSpace;
                t = left + right;
        }
        return(t);
}

this._MFDFrom = function(whomposition) { //direction mark
        var ship = player.ship;
        if( !ship || !ship.isValid || !whomposition || !whomposition.dot ) return (&quot;&quot;);
        var v = ship.position.subtract(whomposition);
        var fw = ship.vectorForward.angleTo(v);
        var ri = ship.vectorRight.angleTo(v);
        var up = ship.vectorUp.angleTo(v);
        var s = &quot;&quot;; // refine if out of front 1 degree cone
        if( ri &lt; 1.56 ) s += &quot;&lt;&quot;;
        if( up &gt; 1.58 ) s += &quot;^&quot;;
        else if( up &lt; 1.56 ) s += &quot;v&quot;;
        if( ri &gt; 1.58 ) s += &quot;&gt;&quot;;
        return( s );
}

this._TimedDelay = function() {
        this.$LaunchInProgress = false; //enable fighter launch again
        if( this.$TimerDelay ) {
                this.$TimerDelay.stop();
                delete this.$TimerDelay;
        }
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
