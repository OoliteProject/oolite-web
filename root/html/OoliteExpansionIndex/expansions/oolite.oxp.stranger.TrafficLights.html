<html>
    <head>
        <title>Expansion Traffic Lights</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Traffic Lights</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER D)(&#39;[]&#39; vs &#39;[docking, clearance, queue, station]&#39;)</li>
                <li>Conflict Expansions mismatch between OXP Manifest and Expansion Manager at character position 0068 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>This OXP helps to override annoying problem of frozen docking queue. Emergency docking timer will be started immediately after request to docking clearance and after 15 min of waiting you will receive docking priority.
In addition to text info this OXP provides visual helpers - string of colored flashers on approach lane between main station docking port and beacon.</td>
                    <td>This OXP helps to override annoying problem of frozen docking queue. Emergency docking timer will be started immediately after request to docking clearance and after 15 min of waiting you will receive docking priority.
In addition to text info this OXP provides visual helpers - string of colored flashers on approach lane between main station docking port and beacon.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.stranger.TrafficLights</td>
                    <td>oolite.oxp.stranger.TrafficLights</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Traffic Lights</td>
                    <td>Traffic Lights</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>stranger</td>
                    <td>stranger</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.1.1</td>
                    <td>1.1.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>docking, clearance, queue, station</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                            <li>oolite.oxp.Thargoid.Neo-Docklights:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Thargoid.Neo-Docklights:</li>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://aegidian.org/bb/viewtopic.php?f=4&amp;t=19588">http://aegidian.org/bb/viewtopic.php?f=4&amp;t=19588</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/3c/TrafficLights.oxz">https://wiki.alioth.net/img_auth.php/3/3c/TrafficLights.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873278</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Traffic%20Lights'>http://wiki.alioth.net/index.php/Traffic%20Lights</a></p>
        <h3>ReadMe &amp; License.txt</h3>
        <pre>Traffic Lights OXP by Stranger

This OXP is released under the Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license.
You are free to use and distribute this OXP on non-commercial basis. 
Rebundling of this OXP within another distribution is permitted as long as it is unchanged.
Any mods/derivatives of this OXP must be distributed under another names.
The license information (either as this file or merged into a larger one) must be included in the OXP.

--------------------------------------------------------------

Instructions:

Unzip the file, and then move the folder &quot;Traffic Lights.oxp&quot; to the AddOns directory of your Oolite installation. Then start the game up.

This OXP helps to override annoying problem of frozen docking queue. Emergency docking timer will be started immediately after request to docking clearance (select station as target and press Shift-L) and after 15 min of waiting you will receive docking priority.
You will also receive emergency docking priority in case of aft shield dropped below 0.1 max level (test for fuel depletion if Hard Way OXP is installed).
Emergency docking clearance is performed on main station only and if you have no Fugitive status!
In addition to text info this OXP provides visual helpers - string of colored flashers on approach lane between main station docking port and beacon.

RED - docking is prohibited.
YELLOW - docking is allowed, but there are ships in approach lane OR you have less then 30 seconds to dock.
GREEN - docking is allowed and approach is clear.
BLUE - player is not in docking queue.

Dependencies:

This OXP is incompatible with Neo-Dock Lights OXP by Thargoid.
It is strongly recommended to avoid using other visual docking helper OXPs to prevent graphic clutter.
Installing my Hard Way OXP is highly recommended, but not obligatory.

Credits:

Modified code from Neo-Dock Lights OXP by Thargoid was used for visualisation of docking status.
I thank commander vasig for invaluable help in testing this OXP in state of development.
I thank also commander cyxoway for multiple timer issue report in emergency_docking.js and improved method of timer management in traffic_lights.js.

______________________________________________________________

Version history:

29.01.2019 - Version 1.1.1	Converted to OZX.
15.04.2018 - Version 1.1	Refining code issues.
				manifest.plist added.
08.09.2017 - Version 1.0	Blue flashers added to indicate player not in docking queue.
				Improved method of timer management in traffic_lights.js.
23.08.2017 - Version 0.9	Fixed multiple timer issue.
				Aft shield level to permit emergency docking clearance lowered to 0.1 of max level.
01.07.2017 - Version 0.8	Fixed situation with docking clearance timing out: flashers switches to yellow, not red.
15.06.2017 - Version 0.7.	String of colored flashers is added as visual helpers to indicate docking status.
				Changing name of OXP.
11.06.2017 - Version 0.6.	Emergency docking clearance before timer goes zero is permitted if aft shield dropped below 0.25 of max level, not in Red condition.
08.06.2017 - Version 0.5.	Emergency docking timer freezed if main station in battle regime (condition Red).
				Kills emergency docking timer if player receives docking permission.
08.06.2017 - Version 0.4.	Emergency docking clearance is unavailable on Fugitive legal status.
				Emergency docking clearance before timer goes zero is permitted only in Red condition. 
07.06.2017 - Version 0.3.	Fixed error causing running emergency timer on docking request other than main station.
07.06.2017 - Version 0.2.	Fixed error causing penalty in case of emergency docking.
06.06.2017 - Version 0.1.	Initial release.</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/emergency_docking.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name				= &quot;Emergency Docking Clearance&quot;;
this.author				= &quot;Stranger&quot;;
this.copyright			= &quot;Creative Commons: attribution, non-commercial, sharealike with clauses - see readme.txt&quot;;
this.description		= &quot;Override docking delays&quot;;
this.version			= &quot;1.1&quot;;

this.$waitingLimit = 15; // max 15 min

this.shipWillLaunchFromStation = this.shipEnteredStationAegis = function()
	{
	if(system.isInterstellarSpace || !system.mainStation.isValid)
		{ return; }
	system.mainStation.requiresDockingClearance = true;
	this.$waitingCounter = 0;
    this.$waitingTime = this.$waitingLimit;
	}
    
this.shipWillDockWithStation = this.shipWillEnterWitchspace = this.shipExitedStationAegis = function()
	{
    this.shipDied();
    }

this.$setClearance = function()
	{
	if(!system.mainStation || player.dockingClearanceStatus == &quot;DOCKING_CLEARANCE_STATUS_GRANTED&quot;)
		{
		this.shipDied();
		return; 
		}
    this.$waitingCounter += 1;
    var message;
    if (this.$waitingCounter &gt;= 60)
        {
        if (system.mainStation.alertCondition == 3)
            {
            message = &quot;Emergency docking frozen&quot;;
            }
        else
            {
            this.$waitingTime -= 1;
            if (this.$waitingTime &gt; 0 &amp;&amp; player.ship.aftShield &gt;= 0.1 * player.ship.maxAftShield)
                {
                message = &quot;Emergency docking in &quot; + this.$waitingTime + &quot; min&quot;;
                }
            else
                {
                system.mainStation.requiresDockingClearance = false;
                message = &quot;Emergency docking allowed&quot;;            
                }
            }
        player.consoleMessage(&quot;\n\n\n\n\n\n\n\n\n\n Docking clearance status: &quot; + message,5);
        this.$waitingCounter -= 60;
        }
	}

this.shipDied = function()
	{
	if(this.$dockTimer) 
		{
		this.$dockTimer.stop();
		delete this.$dockTimer;
		}
	}

this.playerRequestedDockingClearance = function(message)
    {
    if (player.ship.target != system.mainStation || player.bounty &gt; 50 || system.mainStation.alertCondition == 3)
        { return; }
    if (player.ship.aftShield &lt; 0.1 * player.ship.maxAftShield) // shields possibly shut down
        {
        system.mainStation.requiresDockingClearance = false;
        }
    else
        {
        if (!this.$dockTimer)
            {
            this.$dockTimer = new Timer(this, this.$setClearance, 0, 1);
            }
        }
    }</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/traffic_lights.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name				= &quot;Traffic Lights&quot;;
this.author				= &quot;Stranger&quot;;
this.copyright			= &quot;Creative Commons: attribution, non-commercial, sharealike with clauses - see readme.txt&quot;;
this.description		= &quot;Indicates docking clearance status&quot;;
this.version			= &quot;1.1&quot;;

// this script is partially based on Neo-Dock Lights OXP by Thargoid

this.startUp   = function ()
    {
	this.$lightsStatus = &quot;BLUE&quot;;
	this.$lightsTimer = new Timer(this, this.$setLights, 0, 1);
	this.$lightsTimer.stop();
    }

this.shipWillLaunchFromStation = this.shipEnteredStationAegis = function()
	{
	if(system.isInterstellarSpace || !system.mainStation || !system.mainStation.isValid)
		{ return; }
	this.$lightsPosition = system.mainStation.position.add(system.mainStation.vectorForward.multiply(10000));
    this.$lights = system.addVisualEffect(&quot;dockLights_blue&quot;, this.$lightsPosition);	
    this.$lights.orientation = system.mainStation.orientation;
    this.$lightsTimer.start();
	}
    
this.shipWillDockWithStation = this.shipWillEnterWitchspace = this.shipExitedStationAegis = function()
	{
    this.shipDied();
    }

this.$setLights = function()
	{
	if(!system.mainStation) 
		{
		this.shipDied();
		return; 
		}

    function dockingShips(entity) {return entity.isShip &amp;&amp; !entity.isPlayer &amp;&amp; !entity.hasRole(&quot;buoy&quot;) &amp;&amp; ((entity.position.distanceTo(system.mainStation.position) + entity.position.distanceTo(this.$lights.position)) &lt; 10100)}
	var incomingArray = system.filteredEntities(this, dockingShips, system.mainStation, 10000);

	this.$lightsPosition = system.mainStation.position.add(system.mainStation.vectorForward.multiply(10000));
	
    if(player.dockingClearanceStatus == &quot;DOCKING_CLEARANCE_STATUS_GRANTED&quot; || !system.mainStation.requiresDockingClearance)
        {
        this.$dockingStatus = &quot;GREEN&quot;;
        }
    else
        {
        if(player.dockingClearanceStatus == &quot;DOCKING_CLEARANCE_STATUS_TIMING_OUT&quot;)
            {
            this.$dockingStatus = &quot;YELLOW&quot;;
            }
        else
            {
            if(player.dockingClearanceStatus == &quot;DOCKING_CLEARANCE_STATUS_REQUESTED&quot;)
                {
                this.$dockingStatus = &quot;RED&quot;;
                }
            else
                {
                this.$dockingStatus = &quot;BLUE&quot;;
                }
            }
        }

    // condition RED
	if(this.$dockingStatus == &quot;RED&quot; &amp;&amp; this.$lightsStatus != &quot;RED&quot;)
		{ 
		this.$removeLights();
		this.$lights = system.addVisualEffect(&quot;dockLights_red&quot;, this.$lightsPosition);	
		this.$lights.orientation = system.mainStation.orientation;
		this.$lightsStatus = &quot;RED&quot;;		
		return;
		}

    // condition YELLOW
	if((this.$dockingStatus == &quot;YELLOW&quot; || (this.$dockingStatus == &quot;GREEN&quot; &amp;&amp; incomingArray.length &gt; 0)) &amp;&amp; this.$lightsStatus != &quot;YELLOW&quot;)
		{ 
		this.$removeLights();
		this.$lights = system.addVisualEffect(&quot;dockLights_yellow&quot;, this.$lightsPosition);	
		this.$lights.orientation = system.mainStation.orientation;
		this.$lightsStatus = &quot;YELLOW&quot;;		
		return;
		}
		
    // condition GREEN
	if(this.$dockingStatus == &quot;GREEN&quot; &amp;&amp; incomingArray.length == 0 &amp;&amp; this.$lightsStatus != &quot;GREEN&quot;)
		{ 
		this.$removeLights();
		this.$lights = system.addVisualEffect(&quot;dockLights_green&quot;, this.$lightsPosition);
		this.$lights.orientation = system.mainStation.orientation;
		this.$lightsStatus = &quot;GREEN&quot;;
		return;
		}

    // condition BLUE
	if(this.$dockingStatus == &quot;BLUE&quot; &amp;&amp; this.$lightsStatus != &quot;BLUE&quot;)
		{ 
		this.$removeLights();
		this.$lights = system.addVisualEffect(&quot;dockLights_blue&quot;, this.$lightsPosition);	
		this.$lights.orientation = system.mainStation.orientation;
		this.$lightsStatus = &quot;BLUE&quot;;		
		return;
		}

	}

this.shipDied = this.shipWillEnterWitchspace = this.shipExitedStationAegis = function()
	{
		this.$lightsTimer.stop();		
		this.$removeLights();
		this.$lightsStatus = &quot;BLUE&quot;;
	}	
	
this.$removeLights = function()
	{
	var count = system.allVisualEffects.length;
	if(count === 0) { return; }
	for (var i=count-1; i&gt;=0; i--)
		{
		if(system.allVisualEffects[i].dataKey === &quot;dockLights_green&quot; || system.allVisualEffects[i].dataKey === &quot;dockLights_yellow&quot; || system.allVisualEffects[i].dataKey === &quot;dockLights_red&quot; || system.allVisualEffects[i].dataKey === &quot;dockLights_blue&quot;)
			{ system.allVisualEffects[i].remove(); }
		}
	}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
