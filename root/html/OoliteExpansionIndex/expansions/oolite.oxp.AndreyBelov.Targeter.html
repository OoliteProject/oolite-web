<html>
    <head>
        <title>Expansion Target System Upgrade</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Target System Upgrade</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Upgrade to the ships Target System that allows to cycle targeting between outlaw or neutral ships and cargoes on your scanner.</td>
                    <td>Upgrade to the ships Target System that allows to cycle targeting between outlaw or neutral ships and cargoes on your scanner.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.AndreyBelov.Targeter</td>
                    <td>oolite.oxp.AndreyBelov.Targeter</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Target System Upgrade</td>
                    <td>Target System Upgrade</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Andrey Belov</td>
                    <td>Andrey Belov</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.72</td>
                    <td>0.72</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Targeter_OXP">http://wiki.alioth.net/index.php/Targeter_OXP</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/da/Targeter.oxz">https://wiki.alioth.net/img_auth.php/d/da/Targeter.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873481</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Target%20System%20Upgrade'>http://wiki.alioth.net/index.php/Target%20System%20Upgrade</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ENEMY_TARGETER_UPGRADE.html">Target System Upgrade</a></td>
                    <td>yes</td>
                    <td align="right">31000</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ENEMY_TARGETER_UPGRADE_REMOVAL.html">Sell Target System Upgrade</a></td>
                    <td>yes</td>
                    <td align="right">420</td>
                    <td align="center">12+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/target-system-upgrade-equipment.js</td>
                    <td><pre>&#39;use strict&#39;;

this.author  = &#39;Andrey Belov&#39;;
this.licence = &#39;CC-BY-NC-SA 3.0&#39;;


this._mode = 0;

// Handle event &quot;mode&quot; for prime equipment
this.mode = function() {
    if ( player.ship.equipmentStatus(&#39;EQ_ENEMY_TARGETER_UPGRADE&#39;) !== &#39;EQUIPMENT_OK&#39; ) {
        return;
    }
    if ( ++this._mode &gt; 2 ) {
        this._mode = 0;
    }
    this._showMsg( &#39;timer.tsu@mode&#39;, &#39;TSU mode: &#39; + [&#39;hostile/outlaw&#39;,&#39;neutral&#39;,&#39;cargo&#39;][this._mode] );
};

this._showMsg = function(key, msg) {
    var
    c = player.ship.multiFunctionDisplays,
    r = false;

    if ( c &gt; 0 ) {
        player.ship.setMultiFunctionText(key, msg);
        for ( var n = 0; n &lt; c; n++ ) {
            r = player.ship.setMultiFunctionDisplay(n, key);
            if (r) break;
        }
    }

    if ( c&lt;1 || !r ) player.consoleMessage(msg, 1);
};

//Handle event &quot;activated&quot; for prime equipment
this.activated = function() {
    if ( player.ship.equipmentStatus(&#39;EQ_ENEMY_TARGETER_UPGRADE&#39;) === &#39;EQUIPMENT_OK&#39; ) {
        this._setNextTarget();
    }
};

this._setNextTarget = function() {
    var targets = [];

    if ( 0 === this._mode ) {
        targets = this._getHostileShips();

        if ( targets.length &lt; 1 ) {
            targets = this._getOutlawShips();
        }
    }
    else if ( 1 === this._mode ) {
        targets = this._getNeutralShips();
    }
    else if ( 2 === this._mode ) {
        targets = this._getCargoPods();
    }

    var len = targets.length - 1;

    if ( len &lt; 0 ) {
        return;
    }

    this._sortByDistance(targets);

    var ptn = 0;
    if ( player.ship.target ) {
        var TSU = worldScripts[&#39;Target System Upgrade&#39;];
        ptn = TSU._getPreviousTargetNum();
        ptn = ptn &gt;= len ? 0 : ptn + 1;
        TSU._setPreviousTargetNum(ptn);
    }
    var nextTarget = targets[ptn];

    if ( player.ship.target &amp;&amp; player.ship.target === nextTarget ) {
        return;
    }

    player.ship.target = nextTarget;
};

this._getHostileShips = function() {
    if ( ! player.alertHostiles ) {
        return [];
    }
    return this._filterEntities(
        function(e) { return ( e.isShip &amp;&amp; e.hasHostileTarget &amp;&amp; e.target === player.ship ); }
    );
};

this._getOutlawShips = function() {
    if ( 1 &gt; player.alertCondition ) {
        return [];
    }
    return this._filterEntities(
        function(e) { return ( e.scanClass === &#39;CLASS_NEUTRAL&#39; &amp;&amp; e.bounty !== 0 ); }
    );
};

this._getNeutralShips = function() {
    if ( 1 &gt; player.alertCondition ) {
        return [];
    }
    return this._filterEntities(
//        function(e) { return ( e.scanClass === &#39;CLASS_NEUTRAL&#39; &amp;&amp; e.bounty === 0 &amp;&amp; e.target !== player.ship ); }
        function(e) { return ( e.scanClass === &#39;CLASS_NEUTRAL&#39; &amp;&amp; e.bounty === 0 ); }
    );
};

this._getCargoPods = function() {
    return this._filterEntities(
        function(e) { return ( e.scanClass === &#39;CLASS_CARGO&#39; ); }
    );
};

this._filterEntities = function(filterFunc) {
    return system.filteredEntities(
        this,
        filterFunc,
        player.ship,
        player.ship.scannerRange
    );
};

this._sortByDistance = function(targets) {
    var cache = {};
    // sort
    targets.sort( function sortByDist(a,b) {
        // cache distance
        //var ai=a.ID,bi=b.ID; // work only with my patch with universalID getter :(
        var
        ai = a.entityPersonality,
        bi = b.entityPersonality; // use some &quot;uniq&quot; ident
        cache[ai] = cache[ai] || a.position.distanceTo(player.ship.position);
        cache[bi] = cache[bi] || b.position.distanceTo(player.ship.position);
        return ((cache[ai]&lt;cache[bi])?-1:((cache[ai]&gt;cache[bi])?1:0));
    } );
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/target-system-upgrade.js</td>
                    <td><pre>&#39;use strict&#39;;

this.author  = &#39;Andrey Belov&#39;;
this.licence = &#39;CC-BY-NC-SA 3.0&#39;;

this.name    = &#39;Target System Upgrade&#39;;


this.startUp = function() {
    this._setPreviousTargetNum(0);
};

this._setPreviousTargetNum = function(num) {
    this._previousTargetNum = num;
};

this._getPreviousTargetNum = function() {
	return this._previousTargetNum;
};

// sell &#39;Target System Upgrade&#39;
this.playerBoughtEquipment = function(equipmentKey) {
	if ( equipmentKey === &#39;EQ_ENEMY_TARGETER_UPGRADE_REMOVAL&#39;) {
		player.ship.removeEquipment(&#39;EQ_ENEMY_TARGETER_UPGRADE&#39;);
		player.ship.removeEquipment(&#39;EQ_ENEMY_TARGETER_UPGRADE_REMOVAL&#39;);
		player.credits += ( EquipmentInfo.infoForKey(&#39;EQ_ENEMY_TARGETER_UPGRADE&#39;).price * 0.09 );
	}
};

this.equipmentDamaged = function(equipment) {
	if ( equipment === &#39;EQ_ENEMY_TARGETER_UPGRADE&#39; ) {
		player.consoleMessage(&#39;Target System Upgrade is damaged!&#39;);
	}
};
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
