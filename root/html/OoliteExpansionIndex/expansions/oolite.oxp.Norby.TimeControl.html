<html>
    <head>
        <title>Expansion Time Control</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Time Control</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Set Time Acceleration with Injectors and Torus, clear in Red alert, Dock and near a Wormhole. Need a developer release of Oolite which is available at oolite.org right below the main release and identical in gameplay but contain TAF and other debug functions.</td>
                    <td>Set Time Acceleration with Injectors and Torus, clear in Red alert, Dock and near a Wormhole. Need a developer release of Oolite which is available at oolite.org right below the main release and identical in gameplay but contain TAF and other debug functions.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.TimeControl</td>
                    <td>oolite.oxp.Norby.TimeControl</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Time Control</td>
                    <td>Time Control</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Miscellaneous</td>
                    <td>Miscellaneous</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.1</td>
                    <td>1.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/TimeControl">http://wiki.alioth.net/index.php/TimeControl</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/b/b9/TimeControl_1.1.oxz">https://wiki.alioth.net/img_auth.php/b/b9/TimeControl_1.1.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873452</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Time%20Control'>http://wiki.alioth.net/index.php/Time%20Control</a></p>
        <h3>TimeControl_readme.txt</h3>
        <pre>Time Control

Set Time Acceleration with Injectors and Torus, clear in Red alert, Dock and near a Wormhole.

Need a developer release of Oolite which is available at oolite.org right below the main release and identical in gameplay but contain time acceleration (TAF) and other debug functions.


Default settings (adjustable in timecontrol.js):
 2x TAF with Injectors, except in red alert
 4x TAF with Torus, except if there is something on your scanner, like asteroids.

No Torus speedup if TorusToSun is installed to avoid addition.

If your FPS fall below 20 due to the increasing CPU load then the multiplier will be set to a smaller level which can produce at least 20 FPS.

The automatic turning off feature near wormholes is a help in waiting for a fuel free travel: you can set 16x TAF by hand after you undock and time acceleration will fall back to 1x when a wormhole is created by another ship, then you can turn to the blue lollipop on your scanner.

Setting TAF by hand:
Press shift+F during flight to see &quot;TAF: x1.00&quot; under the FPS display. Press &quot;p&quot; for pause, then horizontal arrow keys to change TAF and &quot;p&quot; again to continue the game.


There is another setting in timecontrol.js where you can assign a TAF to the Green alert, but this is 1x (off) by default.


Instructions:
Do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.

License:
This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.

Changelog:
 2015.05.18. v1.1  Default Torus multiplier reduced to 4x.
                   No Torus speedup if TorusToSun is installed also.
 2015.03.31. v1.0  First release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/timecontrol.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;timecontrol&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2015 Norby&quot;;
this.description= &quot;Set and clear Time Acceleration in Green and Red alert, etc. Need developer release of Oolite.&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;

//customizable properties
this.$GreenTAF = 1; //Time Acceleration Factor in green alert (max. 16, 1=turn off)
this.$InjectorsTAF = 2; //maximal Time Acceleration Factor with Injectors
this.$TorusTAF = 4; //maximal Time Acceleration Factor with Torus Jump Drive
this.$TorusTAFWithTorusToSun = 1; //prevent addition with time forwarding in TTS
this.$MinFPS = 20; //maintain at least this FPS

//internal properties, should not touch
this.$ED = null; //the worldscript of EscortDeck
this.$FCB = null; //FrameCallBack pointer
this.$ON = false; //TAF set over 1, needed to set back to 1 after releasing Injectors
this.$PrevFPS = this.$MinFPS;
this.$Timer = null;
this.$Wormholes = []; //store the last wormholes to stop time once only at a new wormhole

//worldscript events
this.startUp = function() {
	timeAccelerationFactor = 1;
	if( worldScripts.torustosun ) this.$TorusTAF = this.$TorusTAFWithTorusToSun;
	this.$ON = false;
	this.$ED = worldScripts.escortdeck;
}

/* old solution without FCB
this.alertConditionChanged = function(newCondition, oldCondition) {
   if( newCondition == 3 || player.alertHostiles ) { //red alert
        timeAccelerationFactor = 1;
   } else if( newCondition == 1 ) { //green alert
      timeAccelerationFactor = this.$GreenTAF;
   }
}
*/

this.shipDockedWithStation = function() {
        timeAccelerationFactor = 1; //as in TAF Reset OXP
	this.$ON = false;
        if( isValidFrameCallback( this.$FCB ) )
		removeFrameCallback( this.$FCB );
	if( this.Timer ) {
		this.$Timer.stop();
		delete this.$Timer;
	}
}

this.shipLaunchedFromStation = function() {
	this.$PrevFPS = this.$MinFPS;
	if( !isValidFrameCallback( this.$FCB ) )
		this.$FCB = addFrameCallback( this.$TimeControl_FCB );
	if( !this.$Timer ) this.$Timer = new Timer(this, this.$Timed.bind(this), 4, 4);
}

//TimeControl methods
this.$TimeControl_FCB = function( delta ) { //FrameCallBack to adjust TAF based on FPS
	var ws = worldScripts.timecontrol;
	var minfps = ws.$MinFPS; //maintain at least this FPS
	var ps = player.ship;
	if( !ps || player.alertCondition &gt; 2 ) { //Red Alert
		timeAccelerationFactor = 1;
		ws.$ON = false;
//		log(ws.name, &quot;Off by red alert&quot;);
	} else {
		//max. TAF adjusted to keep FPS over minfps
		var taf = timeAccelerationFactor;
		var fps = 100;
		if( delta &gt; 0 ) fps = taf / delta;
		fps = ( ws.$PrevFPS + fps ) / 2; //average needed to skip accidentally zero delta
		ws.$PrevFPS = fps;
		if( fps &lt; minfps ) {
			if( taf &gt; 1 &amp;&amp; ws.$ON ) {
				timeAccelerationFactor--;
//				log(ws.name, &quot;Reduced by minfps, fps:&quot;+fps);
			}
		} else {
			if ( ps.speed &gt; ps.maxSpeed * 7 + 10 ) { //Torus
				if( ws.$TimeControl_Proximity(ws) ) { //turn off near asteroids
					timeAccelerationFactor = 1;
					ws.$ON = false;
//					log(ws.name, &quot;Off by proximity&quot;);
				} else if( ws.$TorusTAF &gt; 1 ) {
					if( taf &lt; ws.$TorusTAF ) timeAccelerationFactor++;
					else if( taf &gt; ws.$TorusTAF &amp;&amp; ws.$ON )
						timeAccelerationFactor = ws.$TorusTAF;
					ws.$ON = true;
				}
			} else if ( ps.speed &gt; ps.maxSpeed + 10 ) { //Injector
				if( taf &lt; ws.$InjectorsTAF ) timeAccelerationFactor++;
				else if( taf &gt; ws.$InjectorsTAF &amp;&amp; ws.$ON )
					timeAccelerationFactor = ws.$InjectorsTAF;
				ws.$ON = true;
			} else if ( player.alertCondition == 1 ) { //Green alert
				if( taf &lt; ws.$GreenTAF ) timeAccelerationFactor++;
				else if( taf &gt; ws.$GreenTAF &amp;&amp; ws.$ON )
					timeAccelerationFactor = ws.$GreenTAF;
				ws.$ON = true;
			} else if( ws.$ON ) { //turn off TAF only if turned on by this script
				timeAccelerationFactor = 1;
				ws.$ON = false;
//				log(ws.name, &quot;Off by condition&quot;);
			}
		}
	}
//	log(ws.name, &quot;ON:&quot;+ws.$ON+&quot; &quot;+timeAccelerationFactor+&quot;x TAF &quot;+Math.round(timeAccelerationFactor/delta)+&quot;FPS &quot;+Math.round(ws.$PrevFPS)+&quot;FPSavg &quot;+Math.round(ps.speed)+&quot; speed&quot;);
}

this.$TimeControl_Proximity = function(ws) {
	var s = player.ship.checkScanner(false);
	for( var i = 0; s &amp;&amp; s.length &gt; i; i++ ) {  //exclude escorts and telescopemarker
		if( ws.$ED &amp;&amp; ws.$ED.$EscortDeckShip.indexOf(s[i]) == -1
			&amp;&amp; s[i].dataKey &amp;&amp; s[i].dataKey != &quot;telescopemarker&quot; ) {
			return(true);
		}
	}
	return(false);
}

this.$Timed = function() {
	function $isWormhole(entity) {
		return(entity.isWormhole);
	}
	
	if( timeAccelerationFactor &gt; 1 ) { //stop if a new Wormhole is opened near
//		var s = ps.checkScanner(false); - does not work, no wormhole in the list
		var s = system.filteredEntities(this, $isWormhole, player.ship, player.ship.scannerRange);
		for( var i = 0; s &amp;&amp; s.length &gt; i; i++ ) {
//			log(s[i].name+&quot; &quot;+s[i].isWormhole);//debug
			if( s[i] &amp;&amp; s[i].isValid &amp;&amp; s[i].isWormhole
				&amp;&amp; this.$Wormholes.indexOf(s[i]) == -1 ) {
				this.$Wormholes.push(s[i]);
				timeAccelerationFactor = 1;
				this.$ON = false;
				log(this.name, &quot;Off by wormhole&quot;);
			}
		}
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
