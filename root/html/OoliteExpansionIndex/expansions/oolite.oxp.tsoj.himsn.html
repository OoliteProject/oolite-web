<html>
    <head>
        <title>Expansion Her Imperial Majesty&#39;s Space Navy</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Her Imperial Majesty&#39;s Space Navy</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">32 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">9 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Unknown key &#39;upload_date&#39; at https://wiki.alioth.net/img_auth.php/d/de/Himsn_0.9-alpha.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>A more &#39;believable&#39; Navy presence that sits more comfortably in the Ooniverse as many of us see it. The Navy is there if you go looking. If you do your normal trading, mining and bounty hunting you will never see them. They do not, under any circumstances, meddle in internal system politics. So, you will not be attacked by the Navy if you are an offender or even a fugitive for that matter. That is a police matter.</td>
                    <td>A more &#39;believable&#39; Navy presence that sits more comfortably in the Ooniverse as many of us see it. The Navy is there if you go looking. If you do your normal trading, mining and bounty hunting you will never see them. They do not, under any circumstances, meddle in internal system politics. So, you will not be attacked by the Navy if you are an offender or even a fugitive for that matter. That is a police matter.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.tsoj.himsn</td>
                    <td>oolite.oxp.tsoj.himsn</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Her Imperial Majesty&#39;s Space Navy</td>
                    <td>Her Imperial Majesty&#39;s Space Navy</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Miscellaneous</td>
                    <td>Miscellaneous</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Gimi, Pleb, Keeper, Smivs, Cody, Disembodied, Cholmondely, cbr, Tsoj</td>
                    <td>Gimi, Pleb, Keeper, Smivs, Cody, Disembodied, Cholmondely, cbr, Tsoj</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.9</td>
                    <td>0.9</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Her_Imperial_Majesty%27s_Space_Navy">http://wiki.alioth.net/index.php/Her_Imperial_Majesty%27s_Space_Navy</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/de/Himsn_0.9-alpha.oxz">https://wiki.alioth.net/img_auth.php/d/de/Himsn_0.9-alpha.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/File:Himsn_0.9-alpha.oxz">http://wiki.alioth.net/index.php/File:Himsn_0.9-alpha.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>GPL v2+ / CC-BY-NC-SA 4.0</td>
                    <td>GPL v2+ / CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1642376758</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Her%20Imperial%20Majesty&#39;s%20Space%20Navy'>http://wiki.alioth.net/index.php/Her%20Imperial%20Majesty&#39;s%20Space%20Navy</a></p>
        <h3>README.md</h3>
        <pre># Her Imperial Majesty&#39;s Space Navy

## An expansion pack for [Oolite](http://www.oolite.org/).

&quot;A more &#39;believable&#39; Navy presence that sits more comfortably in the Ooniverse as many of us see it. The problem with GN is that it&#39;s too big. Based on canon and lore, the war against the Thargoids is played out mostly in InterGalactic space, and therefore you wouldn&#39;t expect to find a big naval presence in &#39;normal&#39; space. There would not be navy ships all over the place (clogging up the spacelanes!) and the idea of numerous naval bases (SecComs) in each Galaxy also seems a bit silly. These stations also skew the game quite badly due to their market economics. Also, GN often focuses on pirates, and there is no justification for this within the game - that&#39;s what the GalCop Police are for.

We are talking about an OXP which adds a much more discrete (and believable) naval presence, with a more appropriate range of ships. It may in time also offer missions similar to the two in-built missions involving HIMSN: small, covert special-ops type missions rather than the somewhat repetitive mass shoot-em-ups that GN offers.

The Navy is there if you go looking. If you do your normal trading, mining and bounty hunting you will never see them. They do not, under any circumstances, meddle in internal system politics. So, you will not be attacked by the Navy if you are an offender or even a fugitive for that matter. That is a police matter.&quot;

[Wiki](http://wiki.alioth.net/index.php/Her_Imperial_Majesty%27s_Space_Navy)


## License
GPL v2+  
CC-BY-NC-SA 4.0

**Authors**:  
*Gimi  
Pleb  
Keeper  
Smivs  
Cody  
Disembodied  
Cholmondely  
Tsoj  
cbr*

## Development plan

**Stage 1 - Eye Candy only:**
- [x] Navy units from the core ship-set.
- [x] Navy stations. (HQ and Outpost)
- [x] Basic scripting and and AI behaviour.

**Stage 2 - Thargoid Interaction:**
- [ ] War zones with the Thargoids
- [x] Capital ships
- [ ] Yearly Parade
- [ ] Additional stations (Navy Shipyard and maybe some mission related type of station)
- [ ] Intelligence/Special Operations type ships (e.g. production model of the Constrictor)
    - [ ] AI behaviour

**Stage 3 - Missions:**
- [ ] Player Missions
  
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_adv_patrol_asp.html">himsn_adv_patrol_asp</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_adv_patrol_boa_mk2.html">himsn_adv_patrol_boa_mk2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_adv_patrol_constrictor.html">himsn_adv_patrol_constrictor</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_anaconda.html">Imperial Navy Anaconda</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_asp.html">Imperial Navy Asp Mark II</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_boa_mk2.html">Imperial Navy Boa Class Cruiser</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_constrictor.html">Imperial Navy Constrictor</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_defender.html">himsn_defender</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_escort.html">himsn_escort</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_escort_anaconda.html">himsn_escort_anaconda</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_escort_asp.html">himsn_escort_asp</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_headquarters.html">Imperial Navy Headquarters</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_heavy_patrol_leader.html">himsn_heavy_patrol_leader</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_interstellar_outpost.html">Imperial Navy Outpost</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaComms.html">Kiota Comms Array</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaDisc.html">Kiota Disc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaDock.html">Kiota Dock Ring (Hidden)</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaLift.html">Kiota Lift</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaSRing.html">Kiota Small Ring</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaSpur.html">Kiota Spur</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaStrut.html">Kiota Strut</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_kiotaTurret.html">Kiota Turret</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_komodo_carrier.html">Imperial Navy Carrier (Komodo Class)</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_komodo_dock.html">Docking Slit (horizontal)</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_light_patrol_leader.html">himsn_light_patrol_leader</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_logistics_transport.html">himsn_logistics_transport</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_misjumper.html">himsn_misjumper</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_missile_corvette.html">himsn_missile_corvette</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_sidewinder.html">Imperial Navy Sidewinder</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_specops_asp.html">Navy Special Ops Asp Mark II</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_specops_recon.html">Navy Intelligence Constrictor</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/himsn_system_base.html">Imperial Navy Base</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_adv_patrol.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_adv_patrol&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this._generateDestination = function ()
{
	var thisSystem = system.info;
	var targetSystems = SystemInfo.systemsInRange(7);
	if (!targetSystems) return system.ID;
	var count = targetSystems.length;
	var targetSystem = targetSystems[Math.floor(Math.random()*count)];
	var realDistance = System.infoForSystem(galaxyNumber, targetSystem.systemID).routeToSystem(thisSystem).distance;
	var i = 0;
	while ((!realDistance || realDistance &gt; 7) &amp;&amp; i&lt;count)
	{
		targetSystem = targetSystems[i++];
		realDistance = System.infoForSystem(galaxyNumber, targetSystem.systemID).routeToSystem(thisSystem).distance;
	}
	return targetSystem.systemID;
}

this.shipSpawned = function ()
{
	if (!missionVariables.himsn_adv_patrol_mission)
	{
		this.ship.destinationSystem = this._generateDestination();
		missionVariables.himsn_adv_patrol_dest = this.ship.destinationSystem;
		missionVariables.himsn_adv_patrol_home = this.ship.homeSystem;
		if (Math.random() &lt; 0.5)
		{
			missionVariables.himsn_adv_patrol_mission = 0;
		}
		else
		{
			missionVariables.himsn_adv_patrol_mission = 1;
		}
		this.ship.awardEquipment(&quot;EQ_FUEL_SCOOPS&quot;);
		this.ship.awardEquipment(&quot;EQ_HEAT_SHIELD&quot;);
	}
	else
	{
		this.ship.destinationSystem = missionVariables.himsn_adv_patrol_dest;
		this.ship.homeSystem = missionVariables.himsn_adv_patrol_home;
	}
	
	// Use Escort Formations OXP if installed for random flight formations:
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
	{
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
	}
}

this.helpRequestReceived = function(ally, enemy)
{
	this.ship.destination = ally.position;
	this.ship.target = enemy;
	this.ship.performAttack();
}

this.shipBeingAttacked = function(whom)
{
	if (whom.scanClass != &quot;CLASS_MILITARY&quot;)
	{
		this.ship.target = whom;
		this.ship.requestHelpFromGroup();
		system.filteredEntities(this, function (entity)
		{
			if (entity.scanClass == &quot;CLASS_MILITARY&quot;)
			{
				entity.target = whom;
				entity.performAttack();
			}
			if (entity.isStation &amp;&amp; entity.hasRole(&quot;himsn_station&quot;))
			{
				entity.alertCondition = 3;
				entity.launchDefenseShip();
			}
		});
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_carrier.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_carrier&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this.shipSpawned = function ()
{
	this.ship.awardEquipment(&quot;EQ_FUEL_SCOOPS&quot;);
	this.ship.awardEquipment(&quot;EQ_HEAT_SHIELD&quot;);
	
	this.ship.shipUniqueName = &quot;HIMSS &quot;+expandDescription(&quot;[himsn_carrier_names]&quot;);
	missionVariables.himsn_carrier_name = this.ship.shipUniqueName;
	
	// Use Escort Formations OXP if installed for random flight formations:
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
	{
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
	}
}

this.helpRequestReceived = function(ally, enemy)
{
	this.ship.destination = ally.position;
	this.ship.target = enemy;
	this.ship.performAttack();
}

this.shipBeingAttacked = function(whom)
{
	if (whom.scanClass != &quot;CLASS_MILITARY&quot;)
	{
		this.ship.target = whom;
		this.ship.requestHelpFromGroup();
		system.filteredEntities(this, function (entity)
		{
			if (entity.scanClass == &quot;CLASS_MILITARY&quot;)
			{
				entity.target = whom;
				entity.performAttack();
			}
			if (entity.isStation &amp;&amp; entity.hasRole(&quot;himsn_station&quot;))
			{
				entity.alertCondition = 3;
				entity.launchDefenseShip();
			}
		});
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_carrier_dock.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_carrier_dock&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this.shipSpawned = function ()
{
	this.ship.allowsDocking = true;
}

this.acceptDockingRequestFrom = function(ship)
{
	if (ship.isPlayer)
	{
		return false;
	}
	else
	{
		return true;
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_constrictor_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;himsn_constrictor_conditions&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.description    = &quot;This is the conditions script for the HIMSN Constrictor.&quot;;
this.version        = &quot;0.9-alpha&quot;;

this.allowSpawnShip = function(shipKey)
{
	if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
	{
		return true;
	}
	else
	{
		return false;
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_main.js</td>
                    <td><pre>this.name           = &quot;himsn_main&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.description    = &quot;This is the main worldscript for the HIMSN OXZ.&quot;;
this.version        = &quot;0.9-alpha&quot;;

&quot;use strict&quot;;

// TODO add logging

/**** Functions ****/

this._addAdvPatrol = function()
{
	this._addAdvPatrolSwitch = true;
}

this._addAdvPatrolShips = function(pos)
{
	var advPatrol = system.addShips(&quot;himsn_adv_patrol&quot;,1,pos,0);
	if (system.ID == missionVariables.himsn_adv_patrol_home) 
	{
		advPatrol.maxEscorts = Math.floor(Math.random() * (4 - 0 + 1) + 0);
	}
}

//TODO why is this never used?
this._addAdvEscort = function()
{
	var pos = system.locationFromCode(&quot;WITCHPOINT&quot;);
	system.addGroup(&quot;himsn_logistics_transport&quot;, 1, pos, 0);
}

this._launchAdvPatrol = function()
{
	if (system.ID == -1) return;
	var navyStat = null;
	system.filteredEntities(this, function (entity)
	{
		if (entity.isStation)
		{
			if (entity.hasRole(&quot;himsn_station&quot;))
			{
				navyStat = entity;
			}
		}
	});
	if (navyStat)
	{
		navyStat.launchShipWithRole(&quot;himsn_adv_patrol&quot;, [true]);
		this._advPatrolTimer_3.stop();
		this._advPatrolTimer_3 = new Timer(this,this._launchAdvPatrol,900);
	}
}

//TODO why is this never used?
this._addNavyBattleFleet = function(pos)
{
	// Add Navy Carrier and defending fleet:
	var navyCarrier = system.addShips(&quot;himsn_komodo_carrier&quot;,1,pos,0)[0];
	var targetVector = system.mainPlanet.position.subtract(navyCarrier.position).direction();
	navyCarrier.orientation = targetVector.rotationTo([0,0,1]);
	navyCarrier.maxEscorts = 16;
	var navyCarrierSidewinders = system.addShips(&quot;himsn_escort&quot;,8,pos,500);
	var navyCarrierAsps = system.addShips(&quot;himsn_escort_asp&quot;,5,pos,500);
	var navyCarrierAnacondas = system.addShips(&quot;himsn_escort_anaconda&quot;,3,pos,500);
	navyCarrierSidewinders[0].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[0].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[0]);
	navyCarrierSidewinders[0].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[1].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[1].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[1]);
	navyCarrierSidewinders[1].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[2].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[2].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[2]);
	navyCarrierSidewinders[2].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[3].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[3].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[3]);
	navyCarrierSidewinders[3].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[4].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[4].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[4]);
	navyCarrierSidewinders[4].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[5].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[5].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[5]);
	navyCarrierSidewinders[5].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[6].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[6].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[6]);
	navyCarrierSidewinders[6].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierSidewinders[7].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierSidewinders[7].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierSidewinders[7]);
	navyCarrierSidewinders[7].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAsps[0].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAsps[0].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAsps[0]);
	navyCarrierAsps[0].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAsps[1].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAsps[1].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAsps[1]);
	navyCarrierAsps[1].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAsps[2].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAsps[2].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAsps[2]);
	navyCarrierAsps[2].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAsps[3].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAsps[3].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAsps[3]);
	navyCarrierAsps[3].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAsps[4].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAsps[4].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAsps[4]);
	navyCarrierAsps[4].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAnacondas[0].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAnacondas[0].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAnacondas[0]);
	navyCarrierAnacondas[0].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAnacondas[1].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAnacondas[1].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAnacondas[1]);
	navyCarrierAnacondas[1].switchAI(&quot;himsn_escort_ai.js&quot;);
	navyCarrierAnacondas[2].orientation = targetVector.rotationTo([0,0,1]);
	navyCarrierAnacondas[2].primaryRole = &quot;escort&quot;;
	navyCarrier.escortGroup.addShip(navyCarrierAnacondas[2]);
	navyCarrierAnacondas[2].switchAI(&quot;himsn_escort_ai.js&quot;);
}

this._addNavyHeadquarters = function(pos)
{
	// Add Navy Headquaters and defending fleet:
	navyStation = system.addShips(&quot;himsn_headquarters&quot;,1,pos,0)[0];
	var navyStationGroup = system.addGroup(&quot;himsn_defender&quot;,5,pos,8000);
	navyStationGroup.leader = navyStation;
	navyStationGroup.addShip(navyStation);
}

this._addNavySystemBase = function(pos)
{
	// Add Navy Sysytem Base and defending fleet:
	navyStation = system.addShips(&quot;himsn_system_base&quot;,1,pos,0)[0];
	var targetVector = system.mainPlanet.position.subtract(navyStation.position).direction();
	navyStation.orientation = targetVector.rotationTo([0,0,1]);
	var navyStationGroup = system.addGroup(&quot;himsn_defender&quot;,3,pos,8000);
	navyStationGroup.leader = navyStation;
	navyStationGroup.addShip(navyStation);
}

this._addNavyInterstellarOutpost = function(pos)
{
	// Add Navy Interstellar Outpost and defending fleet:
	navyStation = system.addShips(&quot;himsn_interstellar_outpost&quot;,1,pos,0)[0];
	var navyStationGroup = system.addGroup(&quot;himsn_defender&quot;,3,pos,8000);
	navyStationGroup.leader = navyStation;
	navyStationGroup.addShip(navyStation);
}

this._addNavyPatrol = function (pos)
{
	// 50% chance patrol is heavy or light:
	var patrol;
	if (Math.random() &lt; 0.5)
	{
		if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
		{
			if (Math.random() &lt; 0.5)
			{
				patrol = &quot;himsn_heavy_patrol_leader&quot;;
			}
			else
			{
				patrol = &quot;himsn_missile_corvette&quot;;
			}
		}
		else
		{
			patrol = &quot;himsn_light_patrol_leader&quot;;
		}
	}
	else
	{
        patrol = &quot;himsn_light_patrol_leader&quot;;
	}
	// Add a Navy Patrol:
	system.addGroup(patrol, 1, pos, 0);
}

//TODO why is this never used?
this._addNavyLogisticsTransport = function (pos)
{
	// Add a Navy Logistics Transport:
	system.addGroup(&quot;himsn_logistics_transport&quot;, 1, pos, 0);
}

//TODO why is this never used?
this._addNavyMissileCorvette = function (pos)
{
	// Add a Navy Missile Corvette:
	system.addGroup(&quot;himsn_missile_corvette&quot;, 1, pos, 0);
}

this._addNavySpecOpsRecon = function (pos)
{
	// Only add recon (constrictor) if &#39;Constrictor Hunt&#39; and &#39;Thargoid Plans&#39; missions are complete:
	if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
	{
		// Add a Navy Recon:
		system.addGroup(&quot;himsn_specops_recon&quot;, 1, pos, 0);
	}
}

this._addNavySpecOpsFighter = function (pos)
{
	// Add 3x Navy Spec Ops Fighter:
	system.addGroup(&quot;himsn_specops_asp&quot;, 3, pos, 0);
}

this._checkIfHostilePeriodIsOver = function ()
{
	// Check if player is considered an enemy of HIMSN and 60 days have passed since being declared an enemy:
	if (missionVariables.himsn_status == &quot;HOSTILE&quot; &amp;&amp; clock.adjustedSeconds &gt;= missionVariables.himsn_status_timer)
	{
		missionVariables.himsn_status = &quot;NEUTRAL&quot;;
	}
}

this._checkPlayerAngle = function() 
{
	// Check angle for galactic misjump:
	this._oldPlayerAngle = player.ship.vectorForward.direction();
}

this._checkPlayerPitch = function() 
{
	// Check pitch for galactic misjump:
	if (player.ship.pitch) 
	{
		if (player.ship.pitch &gt;= 0.95 || player.ship.pitch &lt;= -0.95) 
		{
			return true;
		} 
		else 
		{
			return false;
		}
	} 
	else 
	{
		var angle = this._oldPlayerAngle.dot(player.ship.vectorForward.direction());
		if (angle &lt; 0.95) 
		{
			return true;
		} 
		else 
		{
			return false;
		}
	}
}

this._checkPlayerMisjump = function() 
{
	// Check pitch for galactic misjump:
	if (this._checkPlayerPitch()) 
	{
		// If pitch okay for misjump then prepare to send player to intergalactic space:
		var jumper = system.addShips(&quot;himsn_misjumper&quot;,1,[15E5,15E5,15E5],1)[0];
		jumper.scriptedMisjump = true;
		if (jumper.exitSystem()) {
				player.ship.position = [15E5,15E5,15E5];
				this._galacticMisjump = true;
				player.ship.setEquipmentStatus(&quot;EQ_GAL_DRIVE&quot;,&quot;EQUIPMENT_DAMAGED&quot;);
		}
	} 
	else 
	{
		// If pitch normal then perform normal galactic jump:
		this._galacticMisjump = false;
		player.ship.scriptedMisjump = false;
	}
}

this._resetGalacticMisjump = this.shipWillEnterWitchspace = function() 
{
	// Reset galactic misjump:
	if (!this._galacticMisjump &amp;&amp; System.infoForSystem(galaxyNumber,player.ship.targetSystem).name == &quot;Intergalactic space&quot;) 
	{
		System.infoForSystem(galaxyNumber,player.ship.targetSystem).name = null;
	} 
	else if (this._galacticMisjump) 
	{
		player.ship.scriptedMisjump = true;
	}
}

this._repairGalacticHyperDrive = function() 
{
	// Repair galactic hyperdrive when 5 minutes are up:
	player.ship.setEquipmentStatus(&quot;EQ_GAL_DRIVE&quot;,&quot;EQUIPMENT_OK&quot;);
	player.consoleMessage(&quot;Galactic Hyperdrive recalibration complete. Remaining charge sufficient to complete jump.&quot;,10);
}

/**** Event handlers ****/

this.startUp = function ()
{
	//Reset Galactic Misjump variable:
	this._galacticMisjump = false;
	// Check if HIMSN OXZ has run before:
	if (missionVariables.himsn_status == null)
	{
		// Set up internal OXZ variables:
		missionVariables.himsn_status = &quot;NEUTRAL&quot;;
		missionVariables.himsn_status_timer = clock.adjustedSeconds;
	}
}

this.playerStartedJumpCountdown = function (type,delay)
{
	if (type == &quot;galactic&quot;)
	{
		// Setup timers for Galactic Misjump:
		this._galacticMisjumpTimer2 = new Timer(this,this._checkPlayerAngle,delay-0.5);
		this._galacticMisjumpTimer = new Timer(this,this._checkPlayerMisjump,delay-0.1);
	}
	else if (this._galacticMisjump)
	{
		// Force player to misjump:
		player.ship.scriptedMisjump = true;
	}
	else
	{
		// Reset Galactic Misjump variable:
		this._galacticMisjump = false;
	}
}

this.playerCancelledJumpCountdown = function() 
{
	// Stop and remove Galactic Misjump timers if jump is cancelled:
	if (this._galacticMisjumpTimer) 
	{
		this._galacticMisjumpTimer.stop();
		delete this._galacticMisjumpTimer;
	}
	if (this._galacticMisjumpTimer2) 
	{
		this._galacticMisjumpTimer2.stop();
		delete this._galacticMisjumpTimer2;
	}
}

this.shipWillEnterWitchspace = function (cause)
{
	this._interstellarBaseLocation = false;
	this._headquartersLocation = false;
	// Check if about to jump into interstellar space in between Tetiri and Orlaed in G5:
	if(galaxyNumber == 4 &amp;&amp; ((system.ID == 70 &amp;&amp; player.ship.targetSystem == 161) || (system.ID == 161 &amp;&amp; player.ship.targetSystem == 70)  || (system.ID == 70 &amp;&amp; player.ship.targetSystem == 70) || (system.ID == 161 &amp;&amp; player.ship.targetSystem == 161)))
	{
		this._headquartersLocation = true;
	}
	// Check if about to jump into interstellar space in between Legees and Laeden in G1:
	if(galaxyNumber == 0 &amp;&amp; ((system.ID == 26 &amp;&amp; player.ship.targetSystem == 224) || (system.ID == 224 &amp;&amp; player.ship.targetSystem == 26)  || (system.ID == 26 &amp;&amp; player.ship.targetSystem == 26) || (system.ID == 224 &amp;&amp; player.ship.targetSystem == 224)))
	{
		this._interstellarBaseLocation = true;
	}
	// Check if about to jump into interstellar space in between Raried and Maracece in G3:
	if(galaxyNumber == 2 &amp;&amp; ((system.ID == 4 &amp;&amp; player.ship.targetSystem == 123) || (system.ID == 123 &amp;&amp; player.ship.targetSystem == 4)  || (system.ID == 4 &amp;&amp; player.ship.targetSystem == 4) || (system.ID == 123 &amp;&amp; player.ship.targetSystem == 123)))
	{
		this._interstellarBaseLocation = true;
	}
	// Check if about to jump into interstellar space in between Riusbequ and Quzaarar in G4:
	if(galaxyNumber == 3 &amp;&amp; ((system.ID == 217 &amp;&amp; player.ship.targetSystem == 221) || (system.ID == 221 &amp;&amp; player.ship.targetSystem == 217)  || (system.ID == 217 &amp;&amp; player.ship.targetSystem == 217) || (system.ID == 221 &amp;&amp; player.ship.targetSystem == 221)))
	{
		this._interstellarBaseLocation = true;
	}
	// Check if about to jump into interstellar space in between Gexequon and Edtizabe in G8:
	if(galaxyNumber == 7 &amp;&amp; ((system.ID == 144 &amp;&amp; player.ship.targetSystem == 247) || (system.ID == 247 &amp;&amp; player.ship.targetSystem == 144)  || (system.ID == 144 &amp;&amp; player.ship.targetSystem == 144) || (system.ID == 247 &amp;&amp; player.ship.targetSystem == 247)))
	{
		this._interstellarBaseLocation = true;
	}
	if (this._advPatrolTimer_3)
	{
		this._advPatrolTimer_3.stop();
		delete this._advPatrolTimer_3;
	}
}

this.shipWillExitWitchspace = function ()
{
	// Check if player is considered an enemy of HIMSN and 60 days have passed since being declared an enemy:
	this._checkIfHostilePeriodIsOver();
	
	// If player is not jumping into interstellar space make sure galactic misjump variable is reset:
	if (!system.isInterstellarSpace) 
	{
		this._galacticMisjump = false;
	}
	
	// Check if a Galactic Misjump is about to occur:
	if (this._galacticMisjump) 
	{
		// Delete oolite populator scripts:
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillPopulate;
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillRepopulate;
		// Set a timer for 2 minutes to recharge galactic hyperdrive:
		this._galacticMisjumpTimer.stop();
		this._galacticMisjumpTimer = new Timer(this,this._repairGalacticHyperDrive,120);
		// Set name for area:
		System.infoForSystem(galaxyNumber,player.ship.targetSystem).name = &quot;Intergalactic space&quot;;
		// Adjust player&#39;s position to new area of interstellar space:
		player.ship.position = [0,0,1E6];
		// 80% chance of 2x light patrols vs 4-6 thargoids:
		if (Math.random() &lt; 0.8)
		{
			system.addShips(&quot;himsn_light_patrol_leader&quot;,2,[0,0,1E6],5000);
			system.addShips(&quot;thargoid&quot;,4+Math.floor(Math.random() * (2 - 0 + 1) + 10),[0,0,1E6],5000);
		}
		// Else 70% chance of 2x heavy patrols vs 6-8 thargoids:
		else if (Math.random() &lt; 0.7)
		{
			if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
			{
				if (Math.random() &lt; 0.5)
				{
					system.addShips(&quot;himsn_heavy_patrol_leader&quot;,2,[0,0,1E6],5000);
				}
				else
				{
					system.addShips(&quot;himsn_missile_corvette&quot;,2,[0,0,1E6],5000);
				}
			}
			else
			{
				system.addShips(&quot;himsn_light_patrol_leader&quot;,2,[0,0,1E6],5000);
			}
			system.addShips(&quot;thargoid&quot;,6+Math.floor(Math.random() * (2 - 0 + 1) + 10),[0,0,1E6],5000);
		}
		// If none of the above then just player vs 2-4 thargoids:
		else
		{
			system.addShips(&quot;thargoid&quot;,2+Math.floor(Math.random() * (2 - 0 + 1) + 10),[0,0,1E6],5000);
		}
		// 30% chance a rogue planet will be spawned:
		if (Math.random() &lt; 0.3)
		{
			// Choose one of eight planets to spawn: 
			var planetchance = Math.random();
			var igPlanet;
			if ((planetchance &lt;= 1) &amp;&amp; (planetchance &gt; 0.875)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_1&quot;);
			if ((planetchance &lt;= 0.875) &amp;&amp; (planetchance &gt; 0.75)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_2&quot;);
			if ((planetchance &lt;= 0.75) &amp;&amp; (planetchance &gt; 0.625)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_3&quot;);
			if ((planetchance &lt;= 0.625) &amp;&amp; (planetchance &gt; 0.5)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_4&quot;);
			if ((planetchance &lt;= 0.5) &amp;&amp; (planetchance &gt; 0.375)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_5&quot;);
			if ((planetchance &lt;= 0.375) &amp;&amp; (planetchance &gt; 0.25)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_6&quot;);
			if ((planetchance &lt;= 0.25) &amp;&amp; (planetchance &gt; 0.125)) igPlanet = system.addMoon(&quot;himsn_rogue_planet_7&quot;);
			if (planetchance &lt;= 0.125) igPlanet = system.addMoon(&quot;himsn_rogue_planet_8&quot;);
			// 10% chance a navy outpost will be spawned in orbit around planet:
			if (Math.random() &lt; 0.1)
			{
				var planetToStation = Vector3D.randomDirection(2 * igPlanet.radius);
				var igNavyStat = system.addShips(&quot;himsn_interstellar_outpost&quot;, 1, igPlanet.position.add(planetToStation))[0];
				targetVector = igPlanet.position.subtract(igNavyStat.position).direction();
				angle = igNavyStat.heading.angleTo(targetVector);
				cross = igNavyStat.heading.cross(targetVector).direction();
				igNavyStat.orientation = igNavyStat.orientation.rotate(cross, -angle);
			}
		}
	}
}

this.shipExitedWitchspace = function() 
{
	if (missionVariables.himsn_adv_patrol_dest &amp;&amp; system.ID == missionVariables.himsn_adv_patrol_dest &amp;&amp; system.countShipsWithRole(&quot;himsn_adv_patrol&quot;) == 0)
	{
		this._advPatrolTimer_1 = new Timer(this,this._addAdvPatrol,30);
	}
	
	if (this._galacticMisjump) 
	{
		if (!system.isInterstellarSpace) 
		{
			// If player has managed to escape Intergalactic Space the reset galactic misjump variables:
			this._galacticMisjump = false;
			this._resetGalacticMisjump();
		} 
		else 
		{
			// Warn player that Galactic Hyperdrive has malfunctioned:
			if (player.ship.equipmentStatus(&quot;EQ_GAL_DRIVE&quot;) == &quot;EQUIPMENT_DAMAGED&quot;)
			{
				player.consoleMessage(&quot;WARNING! Galactic Hyperdrive Malfunction!&quot;,10);
				player.consoleMessage(&quot;Attempting recalibration with remaining charge...&quot;,5);
			}
			player.ship.scriptedMisjump = true;
		}
	}
}

this.guiScreenChanged = function(from,to) 
{
	// Disable short &amp; long range charts and planet info screens:
	if (this._galacticMisjump) 
	{
		if (guiScreen == &quot;GUI_SCREEN_SYSTEM_DATA&quot; || guiScreen == &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot; || guiScreen == &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;) 
		{
			mission.runScreen({
				title: &quot;Critical Error&quot;,
				message: &quot;Unable to determine location - Cannot load Galactic Chart data.&quot;
			});
		}
	}
}

this.shipWillLaunchFromStation = function (station)
{
	// Check if player is considered an enemy of HIMSN and 60 days have passed since being declared an enemy:
	this._checkIfHostilePeriodIsOver();
}

this.interstellarSpaceWillPopulate = function () 
{
	// 15% chance of light patrol encounter:
	var lightpatrolchance = 0.15;
	// 10% chance of heavy patrol encounter:
	var heavypatrolchance = 0.1;
	
	// Add Navy Outpost at designated zero distance locations:
	if (system.ID == -1 &amp;&amp; this._interstellarBaseLocation)
	{
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillPopulate;
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillRepopulate;
		system.setPopulator(&quot;himsn-interstellar-base&quot;,
		{
			priority: 200,
			location: &quot;WITCHPOINT&quot;,
			groupCount: 1,
			callback: this._addNavyInterstellarOutpost,
			deterministic: true
		});
	}
	else if (system.ID == -1 &amp;&amp; this._headquartersLocation)
	{
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillPopulate;
		delete worldScripts[&quot;oolite-populator&quot;].interstellarSpaceWillRepopulate;
		system.setPopulator(&quot;himsn-headquarters&quot;,
		{
			priority: 200,
			location: &quot;WITCHPOINT&quot;,
			groupCount: 1,
			callback: this._addNavyHeadquarters,
			deterministic: true
		});
	}
	// If in interstellar space with no outpost:
	else 
	{
		// 2x heavy patrols vs 6x thargoids:
		if(Math.random() &lt; heavypatrolchance)
		{
			var heavy_patrol;
			if (Math.random() &lt; 0.5)
			{
				heavy_patrol = &quot;himsn_light_patrol_leader&quot;;
			}
			else
			{
				heavy_patrol = &quot;himsn_missile_corvette&quot;;
				if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
				{
					if (Math.random() &lt; 0.5)
					{
						heavy_patrol = &quot;himsn_heavy_patrol_leader&quot;;
					}
				}
			}
			system.setPopulator(&quot;himsn-interstellar-heavy-escort&quot;,
			{
				priority: 210,
				location: &quot;WITCHPOINT&quot;,
				groupCount: 2,
				callback: function(pos) {
					system.addShips(heavy_patrol,2,pos,0);
				}
			});
			system.setPopulator(&quot;himsn-interstellar-heavy-escort-thargoids&quot;,
			{
				priority: 210,
				location: &quot;WITCHPOINT&quot;,
				groupCount: 6,
				callback: function(pos) {
					system.addShips(&quot;thargoid&quot;,1,pos,0);
				}
			});
		}
		// 2x light patrols vs 4x thargoids:
		else if(Math.random() &lt; lightpatrolchance)
		{
			system.setPopulator(&quot;himsn-interstellar-light-escort&quot;,
			{
				priority: 210,
				location: &quot;WITCHPOINT&quot;,
				groupCount: 2,
				callback: function(pos) {
					system.addShips(&quot;himsn_light_patrol_leader&quot;,1,pos,0);
				}
			});
			system.setPopulator(&quot;himsn-interstellar-light-escort-thargoids&quot;,
			{
				priority: 210,
				location: &quot;WITCHPOINT&quot;,
				groupCount: 4,
				callback: function(pos) {
					system.addShips(&quot;thargoid&quot;,1,pos,0);
				}
			});
		}
	}
}

this.systemWillPopulate = function () 
{
	// 3% chance of patrol appearing:
	var patrolchance = 0.03;
	// 0.2% chance of recon appearing:
	var reconchance = 0.002;
	
	// Check if player is hostile to navy:
	if (missionVariables.himsn_status == &quot;HOSTILE&quot;)
	{
		// 30% chance special ops fighters waiting for player at witchpoint &amp; station aegis:
		if (Math.random() &lt; 0.3)
		{
			system.setPopulator(&quot;himsn-specops-fighter-witchpoint&quot;,
			{
				priority: 200,
				location: &quot;WITCHPOINT&quot;,
				groupCount: 1,
				callback: this._addNavySpecOpsFighter,
				deterministic: true
			});
			system.setPopulator(&quot;himsn-specops-fighter-station&quot;,
			{
				priority: 200,
				location: &quot;STATION_AEGIS&quot;,
				groupCount: 1,
				callback: this._addNavySpecOpsFighter,
				deterministic: true
			});
		}
	}
	
	// Add Navy Base to Birera (G3) and Xeer (G1):
	if ((galaxyNumber == 0 &amp;&amp; system.ID == 150) || (galaxyNumber == 2 &amp;&amp; system.ID == 36))
	{
		system.setPopulator(&quot;himsn-system-base&quot;,
		{
			priority: 200,
			location: &quot;STAR_ORBIT&quot;,
			locationSeed: 67812,
			groupCount: 1,
			callback: this._addNavySystemBase,
			deterministic: true
		});
		// 5% chance of patrol appearing:
		patrolchance = 0.05;
		// 0.5% chance of recon appearing:
		reconchance = 0.005;
		// 3% chance of another patrol appearing on any lane:
		if (Math.random() &lt; 0.03)
		{
			system.setPopulator(&quot;himsn-extra-patrol-2&quot;,
			{
				priority: 210,
				location: &quot;LANE_WPS&quot;,
				groupCount: 1,
				callback: this._addNavyPatrol
			});
		}
	}
	
	// Add patrol on witchpoint-sun lane:
	if (Math.random() &lt; patrolchance)
	{
		system.setPopulator(&quot;himsn-patrol&quot;,
		{
			priority: 210,
			location: &quot;LANE_WS&quot;,
			groupCount: 1,
			callback: this._addNavyPatrol
		});
	}
	
	// Add recon on any lane:
	if (Math.random() &lt; reconchance)
	{
		system.setPopulator(&quot;himsn-specops-recon&quot;,
		{
			priority: 210,
			location: &quot;LANE_WPS&quot;,
			groupCount: 1,
			callback: this._addNavySpecOpsRecon
		});
	}
}

this.systemWillRepopulate = function()
{
	if (missionVariables.himsn_adv_patrol_dest &amp;&amp; missionVariables.himsn_adv_patrol_dest == system.ID &amp;&amp; this._addAdvPatrolSwitch == true)
	{
		delete this._addAdvPatrolSwitch;
		missionVariables.himsn_adv_patrol_dest = null;
		this._advPatrolTimer_1.stop();
		delete this._advPatrolTimer_1;
		this._addAdvPatrolShips(system.locationFromCode(&quot;WITCHPOINT&quot;));
	}
	if (missionVariables.himsn_adv_patrol_home &amp;&amp; missionVariables.himsn_adv_patrol_home == system.ID &amp;&amp; this._addAdvPatrolSwitch == true)
	{
		delete this._addAdvPatrolSwitch;
		missionVariables.himsn_adv_patrol_home = null;
		missionVariables.himsn_adv_patrol_mission = null;
		this._advPatrolTimer_2.stop();
		delete this._advPatrolTimer_2;
		this._addAdvPatrolShips(system.locationFromCode(&quot;WITCHPOINT&quot;));
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_ship.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_ship&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this.shipSpawned = function ()
{
	this.ship.awardEquipment(&quot;EQ_FUEL_SCOOPS&quot;);
	this.ship.awardEquipment(&quot;EQ_HEAT_SHIELD&quot;);
	
	// Use Escort Formations OXP if installed for random flight formations:
	if (worldScripts[&quot;Escort Formations Randomiser&quot;])
	{
		worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(this.ship);
	}
}

this.helpRequestReceived = function(ally, enemy)
{
	this.ship.destination = ally.position;
	this.ship.target = enemy;
	this.ship.performAttack();
}

this.shipBeingAttacked = function(whom)
{
	if (whom.scanClass != &quot;CLASS_MILITARY&quot;)
	{
		this.ship.target = whom;
		this.ship.requestHelpFromGroup();
		system.filteredEntities(this, function (entity)
		{
			if (entity.scanClass == &quot;CLASS_MILITARY&quot;)
			{
				entity.target = whom;
				entity.performAttack();
			}
			if (entity.isStation &amp;&amp; entity.hasRole(&quot;himsn_station&quot;))
			{
				entity.alertCondition = 3;
				entity.launchDefenseShip();
			}
		});
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_station.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_station&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this.shipSpawned = function ()
{
	if (system.ID == -1) return;
	this.ship.launchShipWithRole(&quot;himsn_adv_patrol&quot;, [true]);
	worldScripts[&quot;himsn_main&quot;]._advPatrolTimer_2 = new Timer(this,worldScripts[&quot;himsn_main&quot;]._addAdvPatrol,1800);
	worldScripts[&quot;himsn_main&quot;]._advPatrolTimer_3 = new Timer(this,worldScripts[&quot;himsn_main&quot;]._launchAdvPatrol,900);
	
	this.liftArray = [];
	this.liftHomeArray = [];
	this.liftStatusArray = [];
	this.subArray = this.ship.subEntities;
	if (this.subArray.length &gt; 0)
	{
		var listCounter = 0 ; // reset the counter
		for(listCounter = 0;listCounter&lt;this.subArray.length;listCounter++)
		{
			if (this.subArray[listCounter].hasRole(&quot;himsn_kiotaLift&quot;))
			{
				this.liftArray.push(this.subArray[listCounter]);
				this.liftHomeArray.push(this.subArray[listCounter].position);
				this.liftStatusArray.push(&quot;down&quot;);				
			}
		}

		this.distanceTimer = new Timer(this, this.distanceCheck, 0, 10);
	}
}

this.shipBeingAttacked = function(whom)
{
	if (whom.scanClass != &quot;CLASS_MILITARY&quot;)
	{
		this.ship.target = whom;
		this.ship.requestHelpFromGroup();
		system.filteredEntities(this, function (entity)
		{
			if (entity.scanClass == &quot;CLASS_MILITARY&quot;)
			{
				entity.target = whom;
				entity.performAttack();
			}
		});
	}
}

this.stationReceivedDockingRequest = function(whom)
{
	system.filteredEntities(this, function (entity)
	{
		if (entity.scanClass == &quot;CLASS_MILITARY&quot;)
		{
			entity.target = whom;
			entity.destination = entity.target.position;
			entity.desiredRange = 2500;
			entity.performFlyToRangeFromDestination();
		}
	});
}

this.distanceCheck = function()
{
	if(this.checkDistance())
	{
		if(!this.callbackID) { this.callbackID = addFrameCallback(this.moveLifts.bind(this)); }
		if(!this.liftTimer) { this.liftTimer = new Timer(this, this.triggerLifts, 0, 10); }
		if(!this.missileTimer) { this.missileTimer = new Timer(this, this.awardMissile, 0, 30); }
		return;
	}
	else
	{ 
		this.stopTimers(); 
	}	
}

this.checkDistance = function () 
{
	if(!this.ship || ! player.ship || !this.ship.isValid || !player.ship.isValid)
	{ 
		return false; 
	}
	return (this.ship.position.distanceTo(player.ship) &lt; 256E3);
}	
	
this.rotateStation = function (targetVector)
{
	var angle = this.ship.heading.angleTo(targetVector);
	var cross = this.ship.heading.cross(targetVector).direction();
	this.ship.orientation = this.ship.orientation.rotate(cross,-angle);
}

this.awardMissile = function()
{
	if(this.ship.missiles.length &lt; this.ship.missileCapacity)
	{ 
		this.ship.awardEquipment(this.ship.selectNewMissile()); 
	}
}
	
this.triggerLifts = function()
{
	var listCounter = 0 ; // reset the counter
	for(listCounter = 0;listCounter&lt;this.liftArray.length;listCounter++)
	{
		if(this.liftStatusArray[listCounter] === &quot;down&quot; &amp;&amp; Math.random() &lt; (0.1 * Math.random()))
		{ 
			this.liftStatusArray[listCounter] = &quot;rising&quot;; 
		}
		if (this.liftStatusArray[listCounter] === &quot;up&quot; &amp;&amp; Math.random() &lt; (0.1 * Math.random()))
		{ 
			this.liftStatusArray[listCounter] = &quot;falling&quot;; 
		}	
	}
}

this.moveLifts = function(delta)
{
	if(!this.ship.isValid || !this.ship.status)
	{
		this.shipDied();
		return;
	}
   
	var listCounter = 0 ; // reset the counter
	var distance = delta * 60; // 60 meter per second
	for(listCounter = 0;listCounter&lt;this.liftArray.length;listCounter++)
	{
		if(this.liftStatusArray[listCounter] === &quot;rising&quot;)
		{
			this.liftArray[listCounter].position = this.liftArray[listCounter].position.add(this.liftArray[listCounter].vectorUp.multiply(distance));
			if(this.liftArray[listCounter].position.distanceTo(this.liftHomeArray[listCounter]) &gt;= 1145)
			{
				this.liftArray[listCounter].position = this.liftHomeArray[listCounter].add(this.liftArray[listCounter].vectorUp.multiply(1150));
				this.liftStatusArray[listCounter] = &quot;up&quot;;
			}
		}
         
		if(this.liftStatusArray[listCounter] === &quot;falling&quot;)
		{
			this.liftArray[listCounter].position = this.liftArray[listCounter].position.subtract(this.liftArray[listCounter].vectorUp.multiply(distance));
			if((this.liftArray[listCounter].position.distanceTo(this.liftHomeArray[listCounter]) &lt;= 5) || (this.liftArray[listCounter].position.subtract(this.liftHomeArray[listCounter]).direction().angleTo(this.liftArray[listCounter].vectorUp) &lt; 0.1))
			{
				this.liftArray[listCounter].position = this.liftHomeArray[listCounter];
				this.liftStatusArray[listCounter] = &quot;down&quot;;
			}
		}	
	}
}
	
this.playerWillEnterWitchspace = this.entityDestroyed = this.stopTimers = function()
{
	if(this.callbackID)
	{
		removeFrameCallback(this.callbackID); 
		delete this.callbackID;
	}
		
	if(this.missileTimer &amp;&amp; this.missileTimer.isRunning)
	{
		this.missileTimer.stop();
		delete this.missileTimer;
	}
		
	if(this.liftTimer &amp;&amp; this.liftTimer.isRunning)
	{
		this.liftTimer.stop();
		delete this.liftTimer;
	}
}

this.shipFiredMissile = function(missile, target)
{
	if(missile &amp;&amp; target &amp;&amp; this.ship.heading.angleTo(target.position.subtract(this.ship.position).direction()) &gt; (Math.PI / 2))
	{
		missile.orientation = missile.orientation.rotate(missile.vectorUp, Math.PI); 
		missile.position = this.ship.position.subtract(this.ship.vectorForward.multiply(this.ship.position.distanceTo(missile.position)));
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_station_dock.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name 			= &quot;himsn_station_dock&quot;;
this.author         = &quot;Pleb&quot;;
this.copyright      = &quot;(C) 2014 Pleb.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.version 		= &quot;0.9-alpha&quot;;

this.acceptDockingRequestFrom = function(ship)
{
	if (ship.isPlayer)
	{
		if (missionVariables.conhunt == &quot;MISSION_COMPLETE&quot; &amp;&amp; missionVariables.thargplans == &quot;MISSION_COMPLETE&quot;)
		{
			return true;
		}
		else
		{
			return false;
		}
	}
	else
	{
		return true;
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/himsn_station_interface.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name           = &quot;himsn_station_interface&quot;;
this.author         = &quot;Tsoj&quot;;
this.copyright      = &quot;(C) 2021 Tsoj.&quot;;
this.licence        = &quot;CC-NC-by-SA 4.0&quot;;
this.description    = &quot;This is the script for station interfaces for the HIMSN OXZ.&quot;;
this.version        = &quot;0.9-alpha&quot;;

this._timeToFirstWarning = 120; // seconds
this._timeToForcedLaunch = 180; // seconds

this._leaveTimer = null;

this._assert = function(condition, message) {
	if(!condition)
    	log(&quot;HIMSN&quot;, &quot;ERROR, condition failed: &quot; + message);
}

this._stopLeaveTimer = function(){
	if(this._leaveTimer){
		this._leaveTimer.stop();
		delete this._leaveTimer;
	}
}

this._startLeaveTimer = function(f, t){
	this._stopLeaveTimer();
	this._leaveTimer = new Timer(this, f, t);
}

this._isAtHIMSNStation = function(){
    return player.ship.docked &amp;&amp; (
        player.ship.dockedStation.hasRole(&quot;himsn_komodo_carrier&quot;) ||
        player.ship.dockedStation.hasRole(&quot;himsn_station&quot;)
    );
}

this._forcedStationLaunch = function() {
	player.bounty += 40;
	mission.runScreen({
		titleKey: &quot;HIMSN_forced_launch_title&quot;,
		messageKey: &quot;HIMSN_forced_launch_message&quot;,
	}, function(){
		player.ship.launch();
	});
}

this._warningLeaveStation = function(){
	mission.runScreen({
		titleKey: &quot;HIMSN_warning_title&quot;,
		messageKey: &quot;HIMSN_warning_message&quot;,
		choicesKey: &quot;HIMSN_stay_or_leave&quot;
	}, function (choice){
		if(choice === &quot;HIMSN_stay&quot;){
			this._startLeaveTimer(this._forcedStationLaunch.bind(this), this._timeToForcedLaunch);
		}
		if(choice === &quot;HIMSN_leave&quot;){
			player.ship.launch();
		}
	});
}

this._generateAlienItemPrice = function() {
	let result = {
		price: 100.0,
		isSpecial: false
	};

	if(Math.random() &lt;= 0.05) {
		result.price += (500 + Math.round(4500 * Math.random()))/10;
		result.isSpecial = true;
	}

	return result;
}

this._runMarketScreen = function() {

	const numAlienItems = player.ship.manifest.alien_items;

	const optionPrefix = &quot;HIMSN_option_&quot;;

	let options = {};
	for(let i = 1; i &lt; Math.min(10000, numAlienItems); i*=10) {
		options[optionPrefix + i] = &quot;Sell &quot; + i + &quot; alien items&quot;;
	}
	if(numAlienItems &gt; 0 &amp;&amp; !options[optionPrefix + numAlienItems])
		options[optionPrefix + numAlienItems] = &quot;Sell &quot; + numAlienItems + &quot; alien items&quot;;

	mission.runScreen({
		titleKey: &quot;HIMSN_market_title&quot;,
		message: expandMissionText(&quot;HIMSN_market_message&quot;, {num_alien_items: numAlienItems}),
		choices: options,
		allowInterrupt: true
	}, function (text){
		this._assert(text.indexOf(optionPrefix) !== -1, &quot;Options keys all should begin with the option prefix.&quot;)
		let x = text.replace(optionPrefix, &quot;&quot;);
		
		this._assert(!isNaN(x), &quot;Should be a number: &quot; + x);
		this._assert(x &gt; 0, &quot;Should be only possible to sell positive amounts of alien items.&quot;);

		this._startLeaveTimer(this._warningLeaveStation.bind(this), this._timeToFirstWarning);

		const soldAlienItems = Math.min(Math.floor(x), numAlienItems);

		let earnedCredits = 0;
		let numSoldSpecialItems = 0;
		for(let i = 0; i&lt;soldAlienItems; i++){
			const p = this._generateAlienItemPrice();
			earnedCredits += p.price;
			if(p.isSpecial)
				numSoldSpecialItems += 1;
		}
		this._assert(earnedCredits &gt;= 0, &quot;Player shouldn&#39;t lose credits by selling alien items.&quot;);

		player.ship.manifest.alien_items -= soldAlienItems;
		player.credits += earnedCredits;
		
		mission.runScreen({
			titleKey: &quot;HIMSN_market_title&quot;,
			message: expandMissionText(&quot;HIMSN_sold_alien_items_message&quot;, {
				sold_alien_items: soldAlienItems,
				num_sold_special_items: numSoldSpecialItems,
				earned_credits: earnedCredits
			}),
			allowInterrupt: true
		}, function(){
			this._runMarketScreen();
		});
	});
}

this._runShipyardScreen = function(){
	mission.runScreen({
		titleKey: &quot;HIMSN_shipyard_title&quot;,
		messageKey: &quot;HIMSN_shipyard_restricted_message&quot;,
		allowInterrupt: true
	});
}

this._runSystemScreen = function(){
	mission.runScreen({
		titleKey: &quot;HIMSN_interfaces_title&quot;,
		messageKey: &quot;HIMSN_interfaces_restricted_message&quot;,
		allowInterrupt: true
	});
}

this.guiScreenChanged = function () {
    if(this._isAtHIMSNStation()) {
        if (guiScreen === &quot;GUI_SCREEN_MARKET&quot; || guiScreen == &quot;GUI_SCREEN_MARKETINFO&quot;)
            this._runMarketScreen();
        if (guiScreen === &quot;GUI_SCREEN_SHIPYARD&quot; || guiScreen === &quot;GUI_SCREEN_EQUIP_SHIP&quot;)
            this._runShipyardScreen();
        if (guiScreen === &quot;GUI_SCREEN_INTERFACES&quot;)
            this._runSystemScreen();
    }
}

this.shipWillLaunchFromStation = function() {
    if(this._isAtHIMSNStation()) {
        this._startLeaveTimer();
    }
}

this.shipDockedWithStation = function () {
    if(this._isAtHIMSNStation()) {
        mission.runScreen({
            titleKey: &quot;HIMSN_welcome_title&quot;,
            messageKey: &quot;HIMSN_welcome_message&quot;,
            choicesKey: &quot;HIMSN_stay_or_leave&quot;,
        }, function (choice){
            if(choice === &quot;HIMSN_stay&quot;){
                this._startLeaveTimer(this._warningLeaveStation.bind(this), this._timeToFirstWarning);
            }
            if(choice === &quot;HIMSN_leave&quot;){
                player.ship.launch();
            }
        });
    }
}

this.startUpComplete = function() {
    if(this._isAtHIMSNStation()) {
	    this._startLeaveTimer(this._warningLeaveStation.bind(this), this._timeToFirstWarning);
    }
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
