<html>
    <head>
        <title>Expansion Smugglers - The Galactic Underworld</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Smugglers - The Galactic Underworld</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">48 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">14 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Conflict Expansions mismatch between OXP Manifest and Expansion Manager at character position 0060 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Makes any commodity potentially illegal to import in various systems, and adds equipment and contracts for those interested in smuggling goods outside normal legal channels.</td>
                    <td>Makes any commodity potentially illegal to import in various systems, and adds equipment and contracts for those interested in smuggling goods outside normal legal channels.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.Smugglers_TGU</td>
                    <td>oolite.oxp.phkb.Smugglers_TGU</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Smugglers - The Galactic Underworld</td>
                    <td>Smugglers - The Galactic Underworld</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.5.8</td>
                    <td>1.5.8</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                            <li>oolite.oxp.cim.new-cargoes:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.cim.new-cargoes:</li>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/dd/Smugglers.oxz">https://wiki.alioth.net/img_auth.php/d/dd/Smugglers.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1625104997</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Smugglers%20-%20The%20Galactic%20Underworld'>http://wiki.alioth.net/index.php/Smugglers%20-%20The%20Galactic%20Underworld</a></p>
        <h3>readme.txt</h3>
        <pre>Smugglers - The Galactic Underworld
By Nick Rogers

With the help of:
Layne, Stormrider, Norby, cim, Diziet Sma, Cody, Venator Dha, Harootune, and all the people on the BB who offered suggestions and ideas to make this OXP as good as it could be. If the OXP fails in any way, is it because of my limitations as a programmer, not because of the paucity of your ideas and contributions!

Introduction
============
Historically, in both the original Elite and therefore in Oolite, there were three illegal goods: slaves, narcotics and firearms. These were illegal to export from all GalCop stations, and there was no variation or flexibility in those items. This OXP aims to expand what goods are illegal, making it far more variable. There are new interface screens to show what items are illegal and where, a new Black Market available from Rock Hermits and other stations, and new equipment items to aid in smuggling cargo. 

Background
==========
It started with a single system.

Ceedra, an insignificant confederacy in an unfrequented arm of galactic sector 1. They had been receiving some contaminated imported food from the nearby Anarchy system Isdibi, possibly random or possibly intentional as a way to destabilise the government, it was difficult to tell. But a request was made to GalCop to put an import ban on food and force any traders that bring food to the station to hand it over for destruction.

The impact was almost immediate. Traders were outraged that their harmless cargo of wheat and grains were being taken away, which had never before happened in GalCop history, plus they received a bounty for doing so, doubling the pain. Messages were sent, trade delegations made an outward show of force, but GalCop&#39;s hands were tied. This was the decision of the planet in question, and under GalCop law they were perfectly entitled to impose import restrictions, beyond the export restrictions that had long been in place for slaves or narcotics. 

Suddenly the floodgates were opened. System after system found reason to ban goods, from basic staples like food or textiles, up to the traders standard fare of computers, furs and liquor. Even precious metals were banned in some systems, often for rather obscure reasons. And always, once a ban was in place, the price would hit the roof.

Some commentators have suggested there is evidence that certain systems were requesting a good to be made illegal purely for the jump in price that naturally follows and the bump in traffic that accompanies extra profits. While GalCop have been sought for comment, none has been forthcoming, and nothing appears to be able to bring a halt to the practice. If systems are indeed creating spurious trade legalities, GalCop is not preventing them.

Somewhat inevitably, at almost the same time, an entirely new market emerged, beneath the radar of GalCop&#39;s far-seeing eyes. As soon as a good was declared illegal to import the price of that good sky-rocketed, and the temptation to circumvent the restrictions GalCop was forced to impose was too great. Dock masters became a particular target, being offered high sums to fiddle manifest registries. Shadier stations began to offer customised smuggling compartments that provided a way to hide cargo from the customs scanning equipment. Contracts to move illicit cargo were also available from these locations.

While it was always present in some form or another, now the Galactic Underworld became almost mainstream. The galaxy had changed.

Overview
========
This OXP aims to broaden the scope and appeal of illegal goods in a number of ways.

1. Illegal goods
----------------
Illegal goods can now be any of the 17 different commodity types. So food might be declared illegal on one planet, computers on another. These things might change as well, so computers might be illegal for a few months, and then conditions are lifted and they are back to normal again. 

Also, illegal trade goods will now be illegal to import(*). If you arrive at a GalCop station with visible illegal goods in your hold, you will be fined and your cargo will be confiscated. See also the section below on Bribing Officials.

Even if you plan to stay on the right side to the law, this OXP can add variety to the way illegal goods are handled by the game, and make the process of shipping cargo across the galaxy more interesting.

Illegal goods notifications can be viewed on the F7 System Data screen, as well as via the F4 interface screen (see below). The F6 Galactic Chart will highlight systems within 7 LY that have illegal goods. Systems with just firearms as illegal will be shown with an orange diamond. Systems with other commodities, or with multiple commodities, will be shown with a yellow diamond.

(*) Slaves remain illegal to export, and they are the only commodity that is illegal to export. The reason for this is that some escape capsules end up being transported as slaves, and it&#39;s unfair to penalise the player for potentially rescuing downed pilots. It is recommended the &quot;Illegal Goods Tweak&quot; OXP be installed so that captured slaves can be released.

2. Smuggling Compartment
------------------------
To help traders to work around these import restrictions a new piece of equipment, the smuggling compartment, can be purchased at non-GalCop stations (Rock Hermits in particular, but also other docking ports) in TL4 or greater systems. 

Cargo can be moved into and out of the smuggling compartment via an F4 Interface screen &quot;Smuggling Compartment Configuration&quot;. During flight, the &quot;Smuggling Compartment Storage&quot; primable equipment item allows for the transfer of cargo from the standard hold to the smuggling compartment. Cargo cannot be transferred out of the smuggling compartment during flight.

The smuggling compartment has, in most circumstances, around a 25-40% change of being detected, based on tech level. GalCop is always improving their detection equipment, which means that the scanner resistant technology of the smuggling compartment needs to be updated regularly to cope. About every 30 days a &quot;Version Upgrade&quot; should be purchased (at TL5 or greater systems) for your smuggling compartment, which will install the latest scanner resistant technology and keep the chance of detection as good as possibly can be.

This chance improves slightly once the &quot;Phase Adjustment&quot; equipment (available at TL7 or greater systems) is installed. With the phase adjustment equipment installed the phase setting of the hold to be adjusted, which can improve the chance of being undetected considerably. Phase settings can be picked up at Black Market noticeboard (which might be unreliable), or they can be purchased for a considerable cost. See also the Phase Scanner (below).

If your compartment is damaged during a battle, cargo may be lost, the same as with normal cargo. You will need to find a non-GalCop station to repair the damage, otherwise the entire compartment will be discovered and removed, and you will receive a bounty. If you have a ship overhaul performed at a GalCop station with the smuggling compartment, it will be discovered and removed, and you will receive a bounty. See also the section below on Bribing Officials.

3. New equipment
----------------
Apart from the smuggling compartment and phase adjustment tool, this OXP also introduces the following equipment items.

** Phase Scanner **
TL8 or greater Anarchy systems will sometimes have a Phase Scanner available for purchase. The scanner can, when aimed at GalCop main stations, detect what phase setting the manifest scanners will be susceptible to. Once you know what the phase setting is for a particular government and tech level they can set the phase of their smuggling compartment and it will be almost undetectable to GalCop manifest scanners.

The Phase scanner is used by targeting the main station, priming the equipment and then activating it. It will take a few seconds to perform its job, and will consume a large amount of energy in the process - a naval energy unit is required. If you are too close to the station, or you are moving too slowly, the station will detect the scan and a bounty will be placed on you. If you then dock at the station the scanner will be removed. If you are too far away from the main station the scanner will not operate. If a police vessel catches you performing a scan you will receive a bounty and may find yourself under fire.

If your scanner is damaged you must get it repaired at a non-GalCop station, otherwise the equipment will be confiscated and you will receive a bounty. If you have a ship overhaul performed at a GalCop station while the equipment is on board, it will be removed as part of the overhaul and you will receive a bounty. But see also &quot;Bribing Officials&quot; below.

** Tech version upgrades **
Technology improves every day, and the scanner resistant technology used in the smuggling compartment needs to be updated to keep in step with the times. So, the tech version upgrade will keep your smuggling compartment up-to-date. Available at TL5 or greater systems.

** Import Permits **
While some goods might be declared illegal, you can still purchase a permit to import that good from the planet in question. Usually these permits are quite expensive. 

Permits can only be used once, and will automatically be removed after use.

4. Bribing Officials
--------------------
If your smuggling compartment is discovered during a renovation or when damaged, or you dock with illegal cargo in your hold, you can attempt to bribe the station officials. You will be asked to enter the amount of the bribe. If you pay attention to what the official says you can get an idea on whether a smaller amount will be required, but larger amounts will have a greater chance of being successful. If you are successful you will be able to keep all your cargo and equipment. If you are unsuccessful you will lose all smuggling-related equipment and may end up increasing the bounty on your head.

The Black Market noticeboard (see below) can be useful in finding systems where the dock master and other customs officials can be bribed for a reasonable amount.

5. New Interfaces screens
-------------------------
** Black market **
When docked at most non-GalCop stations, and even GalCop stations in some systems, you will find a new interface screen called &quot;Black Market&quot;. This interface provides access to a number of options:
a. Noticeboard: View some of the messages from the black market news boards. Some are good, some aren&#39;t.
b. Smuggling contracts: These contracts will be smaller cargo quantities (less than 20t), and they will all be illegal at the destination system, so there will be a high degree of risk with each one. However, the rewards will be substantial, more than double what the cargo would be worth at the destination. 
c. Purchase fake import permits: You can purchase fake import permits that may or may not work at the destination system. The chance is only a slightly better than 50%.
d. Purchase Rock Hermit waypoints: Finding Rock Hermits is important, as they are the primary location to access the Black Market. Waypoints can help you find a Rock Hermit in a given system.
e. Purchase phase scan settings: Not always available but occasionally a trader will offer their settings for a price.
f. Sell phase scan settings: If you have discovered a phase scan setting, you can sell it for some real coin! This will only be available once you have purchased a phase scanner.

Please be aware that GalCop have been known to run sting operations at some Black Markets. If you are caught buying illegal information or goods through a Black Market while a sting operation is in place, you will be penalised.

** Dock master **
When docked at a main station, and when the dock master is available (he doesn&#39;t work 24/7!) from this interface you can ask him about any good milk runs he/she is aware of, or you can try to bribe them into changing your cargo manifest for you.

** Illegal goods information **
Illegal goods are changing all the time. To try to keep track of the potential chaos, this interface screen will initially show you the latest changes to illegal goods in the sector, plus it offers the following options:
a. List of all illegal goods in the galaxy. Here you can see it all. 
b. List of all illegal goods within 7LY of your current system.
c. List of illegal goods on your current course. If you have a long, cross-chart trip planned, this option will tell you what&#39;s illegal on the way, and flagging which ones you have a permit for (if any).
d. List of all import permits. This is what you are authorised (legally or not) to import. 
e. List of all Rock Hermit waypoints purchased.

3rd Party Access To Black Market
================================
It&#39;s possible for other OXP&#39;s to add items to be sold on the Black Market. You can add your item using the following method:

    var sbm = worldScripts.Smugglers_BlackMarket;
    if (sbm) {
        sbm.$addSaleItem({
            key:&quot;my_key_value&quot;,		            // reference to be passed back to your worldscript when the item is sold, so you can know which item it was
            text:&quot;A very exclusive item&quot;,       // text to display on the sale screen
            cost:1000,				            // the base cost of the item. a system factor will be applied to this value, either increasing or decreasing it
            worldScript:&quot;my_worldscript_name&quot;,  // the name of your worldscript
            sellCallback:&quot;$my_functionname&quot;,    // the name of the function to be called in the item is sold
        });
    }
	
    this.$my_functionname = function(key, price) {
        // this is the function that will be called. the key name and the price are two parameters of the function
        // you can now do any additional functions that need to be done (eg removing special equipment or cargo)
    }

Items added to the Black Market will stay there until the next witchspace jump. If you want to remove the item manually, you can use this function:

    var sbm = worldScripts.Smugglers_BlackMarket;
    if (sbm) {
        sbm.$removeSaleItem(key);
    }

You can also remove all sale items for your worldScript with this function:

    var sbm = worldScripts.Smugglers_BlackMarket;
    if (sbm) {
        sbm.$removeWorldScriptItems(ws);
    }

Adding additional commodities
=============================
Additional commodities can be added to the system by doing the following:

1. Adding the commodity permit cost, and price factors.

    var sbi = worldScripts.Smugglers_Illegal;
    sbi._commodityInfo[&quot;my_commodity_key&quot;] = [permitCost, factorIncIllegal, factorIncBM];
    // permitCost        = How much a import permit will cost for this commodity (eg 2000)
    // factorIncIllegal  = The percentage to increase this commodity by when it is flagged as illegal (eg 2.5 = 2.5 times original price)
    // factorIncBM       = The percentage to increase this commodity by at a black market when it is flagged illegal at the main station (eg 1.4 = 1.4 times standard price)

2. Adding illegal possibilities for this commodity to the pool

    var sbi = worldScripts.Smugglers_Illegal;
    sbi._possibilities.push({govTypes:&quot;0,3&quot;, commodity:&quot;my_commodity_key&quot;, properties:&quot;&quot;, permit:1, scale:1, period:30, chance:0.5, description:&quot;A brief description of the in-game reason for making this commodity illegal.&quot;})
    /* 
        govTypes:		Comma-separated list of government types (0-7) this definition can apply to eg (&quot;0,1,2&quot;)
        commodity:		Comma-separated list of commodity names this definition will apply to (eg &quot;food,my_commodity_key&quot;).
        properties:		Comma-separated list of text search strings to use against the planetary description.
                        For instance, &quot;civil war&quot; would only select planets that have &quot;civil war&quot; in their description.
                        &quot;drink|brew&quot; would only select planets that have &quot;drink&quot; or &quot;brew&quot; in their description.
        permit:			Boolean value (0 or 1) indicating whether a permit can be purchased for this commodity
        scale:			The legality scale to apply to this commodity. 
                        The scale will apply when calculating the bounty to apply to a player caught smuggling illegal goods as a multiplier.
                        Most illegal goods have a scale of 1. Slaves have 2.
        period:			The period (in days) this definition will be active for.
        chance:			A chance factor, between 0 (never) and 1 (very often), to apply when selecting this definition
        description:	The description to display for this definition.
    */

3. Add the Smugglers market script to your commodity.
    This enables the legal/illegal flags to be set for each commodity.

    In the commodity definition in your &quot;trade-goods.plist&quot; file, add the following line:
		&quot;market_script&quot; = &quot;smugglers_illegalmarket.js&quot;;

    Note: If your commodity definition already has a &quot;market_script&quot; defined, you will need to copy the code from the updateGeneralCommodityDefinition function into yours, to perform the same function as the Smugglers version.

Notes
=====
- This OXP updates the &quot;oolite-contracts-cargo.js&quot; file with a new version of the &quot;_initialiseCargoContractsForSystem&quot; function that excludes illegal goods from being selected for standard cargo contracts. 
- This OXP also changes the logic of the &quot;Legal&quot; column on the F8 Market screen. Previously, goods that were illegal to export were marked with &quot;Im&quot;, and goods illegal to import were marked with &quot;Ex&quot;. This logic has been reversed, and the column relabelled as &quot;Ban&quot; to indicate what type of ban is in place. 

Special Note
============
This OXP is what is called a &quot;work-in-progress&quot;. What that means is, what you have in your hands may not be the final version of the OXP. In fact there might be parts that are broken and could potentially unbalance the game. This isn&#39;t by-design, and hopefully there aren&#39;t any issues like that, but be aware that in many ways this is an experimental OXP. I&#39;m changing a lot of core functionality which opens the door for all sorts of unforeseen consequences, particularly when it comes to other OXP&#39;s. If you decide to help me in the process of polishing this package, please report any bugs or unexpected outcomes. Don&#39;t assume someone else has noticed it - if two people report a bug it makes tracking the bug down so much easier!

And it goes without saying that I&#39;d like to hear from you if you have any suggestions on how the OXP could be improved. 

Incompatible OXP&#39;s
==================
At present, this OXP is incompatible with the following OXPs:
- New Cargoes: The system of permits, how it stores cargo, and how it controls illegal goods are all potentially conflicting.

This conflict has been recorded in the manifest file, so if you have it installed the &quot;Smugglers&quot; OXP will not load.

License
=======
This OXP is released under the Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/

Skull and crossbones image from http://simpleicon.com/dangerous_sign.html.
Warning image from http://simpleicon.com/warning-3.html.
Chat image from http://simpleicon.com/chat-2.html.
ID image from http://simpleicon.com/id_card.html.
Lock image from http://simpleicon.com/lock-2.html.
Cupboard image from http://simpleicon.com/cupboard_4.html.
Candle image from http://simpleicon.com/candle-2.html.
Form image from http://simpleicon.com/admite_form_1.html.
Map marker image from http://simpleicon.com/map_marker.html.

Discussion
==========
This OXP is discussed at this forum link: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=17723

Version History
===============
1.5.8
- Fixed some potential referencing errors with mission screens.

1.5.7
- Added extra facility for removing the Black Market on stations.

1.5.6
- Better use of new functions available in later versions of Oolite.
- Removed code that was deleting TL1 phase scan settings.
- Bug fixes.

1.5.5
- List of illegal goods displayed on F7 system data screen will now be shown inflight, but without reasons (ie just a list of illegal goods).
- Additional checking types added to ship condition checking routine.
- Bug fixes.

1.5.4
- Moving kg or g type commodities will now force the Manifest MFD to update.
- Better integration with Escape Pod Tweaks. Scooped escape pods can no longer be transferred to the smuggling compartment.
- Equipment.plist corrections. 
- Updates to readme.txt file.

1.5.3
- Removed 1t cargo space requirement for in-flight storage equipment, to ensure it is always available when a smuggling compartment is installed.
- Removed incorrect Naval Energy Unit requirement for in-flight storage equipment.
- Code refactoring.

1.5.2
- Fixed issue with the in-flight storage function not handling all conditions when checking scooped cargo.

1.5.1
- Fixed broken integration with &quot;Escape Pod Tweaks&quot;.

1.5.0
- Added new options for when player is caught in a sting operation: pay a fine amount, accept a legal penalty, or attempt to bribe their way out of trouble.
- System productivity now has an influence on the amount you need to offer when bribing officials.
- Calculation of the maximum smuggling compartment size now factors in current smuggling compartment size so all downgrade options are available (not just the ones that would fix in the current available space).
- Fixed damage/repair process.
- Fixed issue with smuggling compartment damage resetting the tech level of the compartment.
- Fixed incorrect description lookup key.
- Improved integration with the &quot;Escape Pod Tweaks&quot; OXP.
- Code cleanup.

1.4.2
- Systems with illegal goods marked on the map will now have their marks removed after loading the game if the setting switch is turned off via Library Config.

1.4.1
- Primable equipment now given to player who already had a smuggling compartment installed.

1.4.0
- Added primable equipment which allows cagro to be moved to the smuggling compartment during flight.
- Fixed issue on &quot;Move cargo out&quot; screen, showing &quot;[avail]&quot; instead of available compartment space.
- Removed decimal point values from showing for available compartment space.
- Better handling of kg and g commodities.
- Fixed issue with outrageous amounts being offered for narcotics and slaves on the Black Market.

1.3.2
- Better handling of interstellar space conditions.

1.3.1
- Added options to Library Config to control whether systems with illegal goods are marked on the galaxy map.

1.3.0
- It is now possible to add new commodities to the list of illegal goods possibilities.
- The dock master can now relabel cargo as new (ie. non-core) commodities.
- System map will now be shown when the dock master informs player of a milk run, highlighting the two systems.
- Illegal goods on route will now handle not having the Advanced Navigation Array correctly.
- Cleaned up overlay images.

1.2.2
- Added &quot;display_color&quot; property to some equipment items (Oolite v1.85/86 only).
- Added integration options for &quot;Bounty System - Most Wanted&quot; OXP.
- Better handling of interstellar space.
- Code refactoring.

1.2.1 
- Fix for crazy prices being applied after a saved game is reloaded.

1.2.0
- Changed method of adjusting prices to work better with other OXP&#39;s that adjust prices.
- Fixed Javascript error when attempting to sell illegal cargo through the Black Market.
- Added console message confirming sale of illegal cargo through the Black Market.
- Code cleanup.

1.1.4
- Arranged data on illegal goods lists to be in columns.
- Removed hard-coded scanner range values.

1.1.3
- Fixed error where function to remove sting ship monkey patches wasn&#39;t being passed the correct parameter.

1.1.2
- Added code for putting smuggling contracts on the Bulletin board system if the Contracts On BB OXP is also installed.
- Code refactoring.

1.1.1
- Fixed some spelling mistakes.
- Added &quot;machinery&quot; to list of commodities the &quot;Visible As&quot; property of a smuggling compartment can be set to.
- Fixed issue with not being able to move machinery into or out of the smuggling compartment.
- Fixed issue with not being able to purchase or sell machinery directly from the smuggling compartment.

1.1.0
- Additional info on F7 screen is now only available when docked to stop the information from overrunning the HUD.
- Corrected use of &quot;techLevel&quot;/&quot;techlevel&quot; on systemInfo objects.
- Re-fixed issue with amount of gold, platinum and gemstones taking up the same amount of smuggling cargo space as normal cargo space.

1.0.0
- Bug fixes.

0.9.0
- Added new Black Market option, enabling the sale of rare or expensive equipment items (eg naval-sourced equipment)
- Added ability for 3rd party OXP&#39;s to add items for sale to the Black Market.
- Fixed incorrect label in descriptions.plist.
- Fixed issue where a smuggling compartment repair item was being displayed when the unit wasn&#39;t damaged.
- Add ability for sting ship to respond to cloaked attacks.
- Better handling of interstellar space conditions.
- Some values were not being reset correctly after a galactic jump.
- Police ship model used on all police-related screens displayed at that station will now be the same model.
- Sound effects added for mode/activate functions of phase scanner.

0.8.1
- Fixed issue where opening the &quot;Purchase Smuggling Compartment&quot; screen was turning off the HUD and not turning it back on again.

0.8.0
- Fixed Javascript error when opening the market info details screen for a commodity in interstellar space.
- Added $isGoodIllegal function to Smugglers_Illegal.

0.7.9
- Fixed issue where docking will illegal goods and rescued escape pods was not allowing the player to bribe the station officials.

0.7.8
- Fixed issue where illegal good definitions were not being applied correctly in every situation.

0.7.7
- Fixed issue with smuggling compartments of various sizes appearing on the equipment screen.

0.7.6
- Better handling of situation where another OXP removes the smuggling compartment.
- Fixed issue with contracts where a Javascript error could occur in rare circumstances.
- Fixed Javascript error with script attached to police sting ship.
- Improved sting ship compatibility with other worldScripts.
- Really (hopefully, maybe) fixed vector error in Blackmarket script.
- Changed &quot;==&quot; comparisons to &quot;===&quot; for performance improvements.

0.7.5
- Fixed Javascript vector error in Blackmarket script.
- Added code to make use of enhanced F7 screen features in Oolite 1.83/4.

0.7.4
- Reconfigured the cargo contracts fixes to work with the default contract code and with Switech&#39;s cargo contract mod OXP.
- Removed unnecessary &quot;requires.plist&quot; file.
- Extra checking for the presence of the sting ship to prevent null errors.
- Fixed issue where smuggling equipment was not being offered for sale anywhere.
- Fixed issue where the phase scanner was not being offered for sale at any time.
- Fixed issue where going into the smuggling compartment purchase page multiple times without actually purchasing something was deducting money anyway.
- Adjusted the price of the phase scanner.
- Tidying up of some equipment installation rules.
- F7 screen was turning off HUD when in flight in some circumstances.

0.7.3
- Fixed issue with incorrect text showing on F8F8 commodity info screen.
- Included current system in list of planets shown on &quot;Illegal imports on current course&quot; option.
- Fixed issue with the Black Market welcome text, which was not being correctly reset upon docking.

0.7.2
- Fixed loop variable pointer error in Black Market script.

0.7.1
- Fixed timer setup bug in Black Market script.

0.7.0
- Updated all bounty changes to use &quot;setBounty&quot;, rather than just updating the bounty directly, so a description can be passed to other OXP&#39;s.
- Expanded the use of the &quot;properties&quot; element of illegal definitions, so that multiple options can be entered (eg &quot;cuisine,meat,steak&quot;).
- Added a couple of extra illegal goods definitions.
- Added the ability to sell illegal cargo on the Black Market, for a reduced price. Plus some extra things...
- Added Seedy Space Bars to list of stations that have a Black Market.
- Moved a lot of static text into descriptions.plist and missiontext.plist.
- Fixed issue with only 500kg of gold or platinum taking up 1t of smuggling cargo space, and 500000g of gemstones.
- Removed redundant items from equipment.plist.
- Fixed bug when using a HUD that doesn&#39;t implement the &quot;Big GUI&quot; option, where the HUD was being turned off when displaying some mission screens, but wasn&#39;t being turned back on again.
- In Oolite 1.83 the bugfix relating to damaged equipment items that take up cargo space is resolved, so code has been added to switch to using the in-built repair methods, rather than keeping a long list of &quot;Repair&quot; equipment items. For backwards compatibility with 1.82, however, those items are still present.
- Adjusted the costs of repair items to be more in-line with how the core system handles repair costs.
- Improved integration with Illegal Goods Tweak. When docking with slaves, IGT will always run first, and Smugglers will be called afterwards.
- Updated screenID&#39;s to enable BGS background sounds.
- Renamed background overlay images to prevent possibility of future duplication.
- Added checks for null value in station allegiance.
- Updated the check for &quot;Allow Big GUI&quot;.
- Cleaned up sound function to avoid the need to check for BGS.
- Toned down overlay images.
- Code refactoring.

0.6.2
- Fixed bug with checking for and removing used permits.
- Fixed issue where Constrictor hunt mission hints were being pushed off the System Data screen by all the illegal goods notifications.
- Added extra overlay image for purchasing Permits.
- Added extra overlay image for Rock Hermit waypoint list.

0.6.1
- Using escape pod will now empty smuggler&#39;s compartment.
- Pared down &quot;trade-goods.plist&quot; to only contain required information, hopefully making it compatible with &quot;Risk based economy&quot; v2 OXP and BlOomberg Markets OXP.
- Removing the smuggling compartment or phase scanner at a Rock Hermit (or other non-GalCop station) will now refund the full cost, rather than just 70%.
- Changing the size of the smuggling compartment will refund the full price of the old size first, before purchasing the new size.
- Fixed bug when starting new game.
- Fixed issue where the message about delivering illegal goods via a cargo contract was appearing incorrectly.

0.6.0
- Fixed issue where illegal flags were not appearing on secondary stations, removed need to have planetinfo.plist.
- Removed log file debug code.

0.5.0
- Fixed bug with selling relabelled cargo.
- Fixed issue with delivering a standard cargo contract to a system where the cargo has become illegal after accepting the contract. The player was not being given the opportunity to bribe a docking official to clear their bounty.
- Fixed issue where, after using the phase scanner and being discovered using it, and then docking, the player was not being given the opportunity to bribe their way out of trouble.
- Added emails for various actions, when the Email System OXP is in use.
- Changed skull and crossbones background image for Black Market.
- Improved integration with Illegal Goods Tweak OXP (v2.2.0). The inital screen IGT displays will now look like an Amnesty Intergalactic screen, rather than a GalCop one, and the player has only two choices: hand over the slaves, or work with GalCop. If they choose the latter, Smugglers will include slaves as part of its import restrictions and the player can bribe as normal if they choose to.

0.4.0
- Fixed issue where you could purchase any smuggling compartment, regardless of how much credit you have.
- Added player credit balance to smuggling compartment purchase screen.
- Added player credit balance to Black Market purchasing screens.
- Tightened up which stations will have a Black Market.
- Added government icon and TL to all purchase screens in Black Market.
- Tweaks to the calculation of phase scan noticeboard items.
- Improvements to the page handling for illegal goods.

0.3.1
- Fixed mangled manifest.plist file.

0.3.0
- Tweaks to the minimum tech level for purchasing smuggling equipment items.
- Further adjustments to precious metals and gem stones illegal notifications for better economic balance.
- Added overlay background images to various interface screens.
- Smuggling compartment repair costs now linked to size of compartment.
- Arriving in a system where you have a permit but no cargo for that permit will no longer remove the permit.
- Routine to create new illegal goods will now exclude the current system, to prevent the issue where the engine understands a good is illegal, but the game interface doesn&#39;t.
- Added extra checks to the docking process to ensure a good that the engine understands is illegal is also marked as illegal on the market screen before penalising the player.
- Added police ship models to all the after-dock screens.

0.2.0 
- Made the price of RH waypoints, fake permits and phase scans related to the station price factor.
- Bribing the same station multiple times will increase the required amount of the bribe (by 10 or 20 percent each time).
- Added the last successful bribe amount to the screen where you enter a bribe amount.
- Reduced the police vessel detection range for the phase scanner, as their ships wouldn&#39;t have the same range as the main station.
- Main station market quantity of illegal goods under contract now set to zero (so, when arriving short, the player can&#39;t just buy the difference, launch and redock to complete the contract).
- Fixed issue where you could purchase anything from the Black Market, regardless of how much credit you have.
- Limited smuggling compartment options to standard commodities only.
- Fixed issue where wrong illegal goods were being picked up if the player followed another ship through a wormhole.
- Rebalanced prices for precious metals and gem stones.
- Damaged smuggling compartments and phase scanners can now be repaired, and better handling of damaged equipment in general.
- Fixed issue where phase scanner would not show up for purchase anywhere.
- Fixed issue where having 0t available space would not allow transfer of precious metals from smuggling compartment to standard hold.
- Added a new item to the Illegal Goods interface screen that lists all purchased Rock Hermit waypoints.
- Fixed issue with tech upgrades, where the option to purchase new ones was always available, no matter how many times you purchased it.
- Adjusted the price of the tech upgrade.
- Bug fixes.

0.1.2
- Added missing semi-colon to planetinfo.plist.
- Found additional spot where techlevel was showing 1 lower than actual.
- Fixed issue where phase scans for TL 1 systems would not show up in the list of discovered phase scans.

0.1.1
- Tech levels on all displays were showing 1 lower than actual.
- Attempting to bribe a dock master to relabel cargo when you don&#39;t have any cargo that can be relabeled would put the game into a locked state.
- Spelling corrections.

0.1.0
- Fixed issue with purchasing import permits from main stations, where a timeout was occurring when attempting to open the purchase page.
- Fixed issue where buying or selling directly into or out of the smuggling compartment was not adding or removing market quantities.
- Fixed issue where docking with illegals in the compartment, and they go undetected. The right success message is now displayed.
- Fixed issue where scooping non-commodity-type OXP containers was causing a Javascript error.
- Fixed Javascript bug when selling cargo directly from smuggling compartment.
- Fixed issue where, when delivering multiple contracts to a single destination, only one contract would be completed.
- Added some extra contract completed messages.
- Cleaned up manifest display for smuggling contracts, making it consistent with other contracts.
- Fixed issue with attempting to sell cargo from the smuggling compartment over the market capacity.
- Removed current system from the illegal goods on current course display.
- When only 1 unit can be transferred, bought or sold, the player now won&#39;t be asked to enter a number between 1 and 1.
- Changed manifest list of smuggling cargo to use two columns.
- When aborting a data entry page, the previous screen will now be displayed, rather than going all the way out to the Interface list.
- Added markers to the galactic chart to help identify systems with illegal goods to watch out for.
- Added the number of available smuggling contracts to the Black Market menu.
- Smuggling compartment is now really no longer available at RRS stations.
- Adjustments to the smuggling reputation calculation.
- Rebalancing of all costs (contracts, equipment and bribing).
- Bug fixes.

0.0.5
- New arrival screen for when you have illegal goods and they go undetected by the authorities.
- Adjustments to the illegal goods arrival reports to better match IGT.
- Fixed issue where entering 0 or blank for a bribe when docking would allow the player to keep their cargo/equipment.
- Added buy/sell sound effects when buying/selling cargo directly from the smuggling compartment.
- Added warning to compartment config page about the age of the tech version of the compartment.
- Fixed issue with smuggling contracts not being set up with enough time to complete.
- Added some text to the bribe description to help players determine how much they should be offering.
- Fixed issue on the various illegal goods lists where some illegal goods were not being separated with a comma.
- Tweaked the logic for adding new illegal goods.
- Added ability to have the Black Market appear in selected main stations, based on government and techlevel.
- Added some additional illegal good definitions.
- Added government and techlevel descriptions to recent illegal goods notifications page.
- Smuggling compartment no longer available at RRS stations.

0.0.4
- Permits will now expire after use.
- Fixed debug code issue.

0.0.3 
- Turned off some debug flags that made the Black Market and Smuggling Compartment available everywhere.
- Updated the comment text for Narcotics.
- Removed debug code that was automatically adding a 5t smuggling compartment to the player ship.
- Fixed issue where attempting to purchase a sub-10t sized smuggling compartment would fail.
- Updated Black Market noticeboard text to be more underworldish (thanks Layne!).
- Bug fixes.

0.0.2
- Added ability to remove the phase scanner.
- Adjusted the price of the phase scanner.
- Adjusted the prices of the smuggling compartments.
- Added the content of the smuggling compartment to the F5 Manifest screen.
- Adjusted the methodology for working out the random chance of there being a phase scanner available in a given Anarchy TL10 system.
- Fixed bug where visible property of smuggling compartment was not being restored correctly.
- Fixed bug with calculation of bribe amount, so that the system works as designed, rather than allowing pretty much any bribe to work.
- Adjusted the calculation of the bribe amount.
- Adjusted the probabilities for fake permits, giving them a maximum of a 40% chance of success (ie. so it&#39;s better to get a smuggling compartment). 
- Fewer fake permits will now be offered for sale.
- Added ability to bribe officials when performing a renovation with a smuggling compartment or phase scanner
- Added ability to bribe officials when docking with illegal cargo.
- Added ability to bribe officials after they have detected the phase scanner.
- Added ability to buy and sell commodities directly from the smuggling compartment (ie. without needing to do transfers from the main hold).
- Phase scan settings will occasionally change for a given government/techlevel.
- Added a new noticeboard item: phase scan setting changes, to indicate when settings at a particular planet (and therefore, all gov/techlevels of the same type) have changed.
- Made the phase scan suggestions on the Black Market noticeboard less accurate.
- Added the &quot;Smuggling Compartment Phase Adjustment&quot; equipment item. Gives a small boost to your chances just by having it installed. You also can&#39;t change the phase setting unless this is installed.
- Updated descriptions of the noticeboard to make them a bit rougher.
- Redesigned the internal structure of the smuggling compartment, making it simpler to work with.
- Added some additional illegal good definitions.
- Added destination marker to galactic map when contract is accepted.
- Fixed bug with smuggling contracts, where the merchandise was not being given to the player when a contract was accepted.
- Fixed issues with accepting contracts, where the manifest page was not being updated, and Javascript errors were occurring.
- Fixed issue where accepted contracts were not being saved to mission variables correctly, meaning they would be lost on reload.
- Fixed issue where contracts could not be completed successfully, and the wrong text was being displayed, and... well, contracts were broken, and now they&#39;re fixed.
- Changed category from &quot;Missions&quot; to &quot;Mechanics&quot;.
- Bug fixes.

0.0.1 Limited beta release
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_IMPORT_PERMIT.html">Import Permit</a></td>
                    <td>no</td>
                    <td align="right">30000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_PHASE_SCANNER.html">Customs Phase Scanner</a></td>
                    <td>yes</td>
                    <td align="right">420000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_PHASE_SCANNER_REMOVAL.html">Remove Customs Phase Scanner</a></td>
                    <td>no</td>
                    <td align="right">5000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT.html">Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">5000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_1.html">Smuggling Compartment (1t)</a></td>
                    <td>yes</td>
                    <td align="right">5000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_10.html">Smuggling Compartment (10t)</a></td>
                    <td>yes</td>
                    <td align="right">17380</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_11.html">Smuggling Compartment (11t)</a></td>
                    <td>yes</td>
                    <td align="right">20130</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_12.html">Smuggling Compartment (12t)</a></td>
                    <td>yes</td>
                    <td align="right">23150</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_13.html">Smuggling Compartment (13t)</a></td>
                    <td>yes</td>
                    <td align="right">26450</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_14.html">Smuggling Compartment (14t)</a></td>
                    <td>yes</td>
                    <td align="right">30030</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_15.html">Smuggling Compartment (15t)</a></td>
                    <td>yes</td>
                    <td align="right">33880</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_16.html">Smuggling Compartment (16t)</a></td>
                    <td>yes</td>
                    <td align="right">38000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_17.html">Smuggling Compartment (17t)</a></td>
                    <td>yes</td>
                    <td align="right">42400</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_18.html">Smuggling Compartment (18t)</a></td>
                    <td>yes</td>
                    <td align="right">47080</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_19.html">Smuggling Compartment (19t)</a></td>
                    <td>yes</td>
                    <td align="right">52030</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_2.html">Smuggling Compartment (2t)</a></td>
                    <td>yes</td>
                    <td align="right">5270</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_20.html">Smuggling Compartment (20t)</a></td>
                    <td>yes</td>
                    <td align="right">58340</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_3.html">Smuggling Compartment (3t)</a></td>
                    <td>yes</td>
                    <td align="right">5820</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_4.html">Smuggling Compartment (4t)</a></td>
                    <td>yes</td>
                    <td align="right">6650</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_5.html">Smuggling Compartment (5t)</a></td>
                    <td>yes</td>
                    <td align="right">7750</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_6.html">Smuggling Compartment (6t)</a></td>
                    <td>yes</td>
                    <td align="right">9120</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_7.html">Smuggling Compartment (7t)</a></td>
                    <td>yes</td>
                    <td align="right">10780</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_8.html">Smuggling Compartment (8t)</a></td>
                    <td>yes</td>
                    <td align="right">12700</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_9.html">Smuggling Compartment (9t)</a></td>
                    <td>yes</td>
                    <td align="right">14900</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REMOVAL.html">Remove Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">2000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_1.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">2500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_10.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">8690</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_11.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">10065</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_12.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">11575</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_13.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">13225</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_14.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">15015</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_15.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">16940</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_16.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">19000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_17.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">21200</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_18.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">23540</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_19.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">26015</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_2.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">2635</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_20.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">29170</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_3.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">2910</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_4.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">3325</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_5.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">3875</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_6.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">4560</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_7.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">5390</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_8.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">6350</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_COMPARTMENT_REPAIR_9.html">Repair: Smuggling Compartment</a></td>
                    <td>no</td>
                    <td align="right">7450</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_INFLIGHT_STORAGE.html">Smuggling Compartment Storage</a></td>
                    <td>no</td>
                    <td align="right">0</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_PHASE_ADJUSTMENT.html">Smuggling Compartment Phase Adjustment</a></td>
                    <td>yes</td>
                    <td align="right">7500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SMUGGLING_VERSION_UPGRADE.html">Smuggling Compartment Version Upgrade</a></td>
                    <td>no</td>
                    <td align="right">4500</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/oolite-contracts-cargo_hide.js</td>
                    <td><pre>/*

oolite-contracts-cargo.js

Script for managing cargo contracts


Oolite
Copyright  2004-2013 Giles C Williams and contributors

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
MA 02110-1301, USA.

=========================================================================================================
Note: Additions/changes by Nick Rogers
1. Adjusted columns widths for wide fonts
2. Added check for illegal good types when creating possible contracts, so only legal goods at destination are selected
3. Added check for BigGUIHUD&#39;s when determining if the HUD needs to be hidden or not.
=========================================================================================================

*/


/*jslint white: true, undef: true, eqeqeq: true, bitwise: true, regexp: true, newcap: true, immed: true */
/*global galaxyNumber, missionVariables, system*/


&quot;use strict&quot;;


this.name			= &quot;oolite-contracts-cargo&quot;;
this.author			= &quot;cim&quot;;
this.copyright		= &quot; 2012-2013 the Oolite team.&quot;;
this.description	= &quot;Cargo delivery contracts.&quot;;


/**** Configuration options and API ****/

/* OXPs which wish to add a background to the summary pages should
   set this value */
this.$cargoSummaryPageBackground = &quot;&quot;;
/* OXPs which wish to add an overlay to the cargo mission screens
   should set this value */
this.$cargoPageOverlay = &quot;&quot;;


/* this._addCargoContractToSystem(cargo)
 * This function adds the defined cargo contract to the local main station&#39;s
 * interface list. A contract definition is an object with the following
 * parameters, all required:
 *
 * destination: system ID of destination system
 * commodity:   the cargo type
 * size:        the number of units of cargo
 * deadline:    the deadline for delivery, in clock seconds
 * payment:     the payment for delivery on time, in credits
 *
 * and optionally, the following parameters:
 *
 * deposit:     the deposit payment required by the player (default 0)
 * route:       a route object generated with system.info.routeToSystem
 *              describing the route between the source and destination
 *              systems.
 *
 * If this is not specified, it will be generated automatically.
 *
 * The function will return true if the contract can be added, false
 * otherwise.
 */
this._addCargoContractToSystem = function(cargo)
{
		if (!system.mainStation)
		{
				log(this.name,&quot;Contracts require a main station&quot;);
				return false;
		}
		if (cargo.destination &lt; 0 || cargo.destination &gt; 255)
		{
				log(this.name,&quot;Rejected contract: destination missing or invalid&quot;);
				return false;
		}
		if (cargo.deadline &lt;= clock.adjustedSeconds)
		{
				log(this.name,&quot;Rejected contract: deadline invalid&quot;);
				return false;
		}
		if (cargo.payment &lt; 0)
		{
				log(this.name,&quot;Rejected contract: payment invalid&quot;);
				return false;
		}
		if (!cargo.size || cargo.size &lt; 1)
		{
				log(this.name,&quot;Rejected contract: size invalid&quot;);
				return false;
		}
		if (!cargo.commodity)
		{
				log(this.name,&quot;Rejected contract: commodity unspecified&quot;);
				return false;
		}
		if (!system.mainStation.market[cargo.commodity])
		{
				log(this.name,&quot;Rejected contract: commodity invalid&quot;);
				return false;
		}

		if (!cargo.route)
		{
				var destinationInfo = System.infoForSystem(galaxyNumber,cargo.destination);
				cargo.route = system.info.routeToSystem(destinationInfo);
				if (!cargo.route)
				{
						log(this.name,&quot;Rejected contract: route invalid&quot;);
						return false;
				}
		}
		if (!cargo.deposit)
		{
				cargo.deposit = 0;
		}
		else if (cargo.deposit &gt;= cargo.payment)
		{
				log(this.name,&quot;Rejected contract: deposit higher than total payment&quot;);
				return false;
		}

		this.$contracts.push(cargo);
		this._updateMainStationInterfacesList();
		return true;
}



/**** Internal methods. Do not call these from OXPs as they may change
 **** without warning. ****/

/* Event handlers */

this.startUp = function()
{
		this.$helper = worldScripts[&quot;oolite-contracts-helpers&quot;];

		this.$suspendedDestination = null;
		this.$suspendedHUD = false;

		// stored contents of local main station&#39;s parcel contract list
		if (missionVariables.oolite_contracts_cargo)
		{
				this.$contracts = JSON.parse(missionVariables.oolite_contracts_cargo);
		}
		else
		{
				this._initialiseCargoContractsForSystem();
		}

		this._updateMainStationInterfacesList();
}


this.shipWillExitWitchspace = function()
{
		if (!system.isInterstellarSpace &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.mainStation)
		{
				// must be a regular system with a main station
				this._initialiseCargoContractsForSystem();
				this._updateMainStationInterfacesList();
		}
}


this.playerWillSaveGame = function()
{
		// encode the contract list to a string for storage in the savegame
		missionVariables.oolite_contracts_cargo = JSON.stringify(this.$contracts);
}


// when the player exits the mission screens, reset their destination
// system and HUD settings, which the mission screens may have
// affected.
this.shipWillLaunchFromStation = function()
{
		this._resetViews();
}


this.guiScreenWillChange = function(to, from)
{
		this._resetViews();
}


this.guiScreenChanged = function(to, from)
{
		if (to != &quot;GUI_SCREEN_MISSION&quot;)
		{
				this._resetViews();
		}
}


/* Interface functions */

// resets HUD and jump destination
this._resetViews = function()
{
		if (this.$suspendedHUD !== false)
		{
				player.ship.hudHidden = false;
				this.$suspendedHUD = false;
		}
		if (this.$suspendedDestination !== null)
		{
				player.ship.targetSystem = this.$suspendedDestination;
				this.$suspendedDestination = null;
		}
}

// initialise a new cargo contract list for the current system
this._initialiseCargoContractsForSystem = function()
{
		// clear list
		this.$contracts = [];

		// this is not the same algorithm as in 1.76, but should give
		// similar results with comparable efficiency.

		// no point in generating too many, as route-finding is slow
		var numContracts = Math.floor(5*Math.random()+5*Math.random()+5*Math.random()+(player.contractReputationPrecise*Math.random()));
		if (player.contractReputationPrecise &gt;= 0 &amp;&amp; numContracts &lt; 5)
		{
				numContracts += 5;
		}
		if (numContracts &gt; 16)
		{
				numContracts = 16;
		}
		else if (numContracts &lt; 0)
		{
				numContracts = 0;
		}
		// some of these possible contracts may be discarded later on

		for (var i = 0; i &lt; numContracts; i++)
		{
				var cargo = new Object;

				// pick a random system to take the goods to
				var destination = Math.floor(Math.random()*256);

				// discard if chose the current system
				if (destination === system.ID)
				{
						continue;
				}

				// get the SystemInfo object for the destination
				var destinationInfo = System.infoForSystem(galaxyNumber,destination);
			if (destinationInfo.sun_gone_nova)
			{
				continue;
			}
				var daysUntilDeparture = 1+(Math.random()*(7+player.contractReputationPrecise-destinationInfo.government));
				if (daysUntilDeparture &lt;= 0)
				{
						// loses some more contracts if reputation negative
						continue;
				}

				var si = worldScripts.Smugglers_Illegal;
				var illegal = null;
				if (si) {
					illegal = si.$illegalGoodsListCommodityOnly(destination, true);
					// add slaves to the list
					illegal.push(&quot;slaves&quot;);
				}

				var commodities = Object.keys(system.mainStation.market);
				var attempts = 0;
				do {
						var remotePrice = 0;
						attempts++;
						var commodity = commodities[Math.floor(Math.random()*commodities.length)];
						// sub-tc contracts only available for top rep
						if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] != 0 &amp;&amp; player.contractReputationPrecise &lt; 6.5)
						{
						}
						// ignore commodities with 0 availability here
						else if (system.mainStation.market[commodity].quantity == 0)
						{
						}
						// ignore any illegal goods
						else if (illegal &amp;&amp; illegal.indexOf(commodity) &gt;= 0)
						{
						}
						else
						{
								remotePrice = this._priceForCommodity(commodity,destinationInfo);
						}
				} while (remotePrice &lt; system.mainStation.market[commodity].price/20 &amp;&amp; attempts &lt; 10);
				if (attempts == 10)
				{
						// failed to find a good one.
						continue;
				}
				cargo.commodity = commodity;

				var amount = 0;
				while (amount &lt; 30)
				{
						var unitsize = 1;
						// larger unit sizes for kg/g commodities
						if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] == 1)
						{
								unitsize += Math.floor(Math.random()*6)+Math.floor(Math.random()*6)+Math.floor(Math.random()*6);
						}
						else if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] == 2)
						{
								unitsize += Math.floor(Math.random()*16)+Math.floor(Math.random()*11)+Math.floor(Math.random()*6);
						}
						amount += (1+Math.floor(Math.random()*32))*(1+Math.floor(Math.random()*16))*unitsize;
				}

				if (amount &gt; 125 &amp;&amp; system.mainStation.market[commodity][&quot;quantity_unit&quot;] == 0)
				{
						// reduce the number of contracts only suitable for Anacondas
						amount = Math.floor(amount/Math.floor(1+(Math.random()*4)));
				}
				cargo.size = amount;

				// adjustment to prices based on quantity (larger = more profitable)
				var discount = Math.min(10+Math.floor(amount/10),35);

				var unitPrice = system.mainStation.market[commodity].price * (100-discount) / 1000;
				var localValue = Math.floor(unitPrice * amount);
				remotePrice = remotePrice * (200+discount) / 200;
				var remoteValue = Math.floor(remotePrice * amount);
				var profit = remoteValue-localValue;

				// skip if unprofitable
				if (profit &lt;= 100)
				{
						continue;
				}

				// check that a route to the destination exists
				// route calculation is expensive so leave this check to last
				var routeToDestination = system.info.routeToSystem(destinationInfo);

				// if the system cannot be reached, ignore this contract
				if (!routeToDestination)
				{
						continue;
				}

				// we now have a valid destination, so generate the rest of
				// the parcel details

				cargo.destination = destination;
				// we&#39;ll need this again later, and route calculation is slow
				cargo.route = routeToDestination;

				// higher share for transporter for longer routes, less safe systems
				var share = 100 + destinationInfo.government - (10*routeToDestination.route.length);
				if (share &lt; 10)
				{
						share = 10;
				}
				share = 100-share;

				// safety: now multiply the fee by 2 compared with 1.76 contracts
				// prevents exploit discovered by Mad Hollander at
				// http://aegidian.org/bb/viewtopic.php?p=188127
				localValue *= 2;
				// this may need to be raised further

				// absolute value of profit remains the same
				var fee = localValue + Math.floor(profit * (share/100));
				fee -= fee % 20; // round to nearest 20 credits;

				cargo.payment = fee;
				cargo.deposit = localValue - (localValue % 20);
				if (cargo.deposit &gt;= cargo.payment)
				{
						// rare but not impossible; last safety check
						return;
				}

				// time allowed for delivery is time taken by &quot;fewest jumps&quot;
				// route, plus timer above. Higher reputation makes longer
				// times available.
				cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture*86400)+(cargo.route.time*3600);

				// add parcel to contract list
				this._addCargoContractToSystem(cargo);
		}

}


// this should be called every time the contents of this.$parcels
// changes, as it updates the summary of the interface entry.
this._updateMainStationInterfacesList = function()
{
		if (this.$contracts.length === 0)
		{
				// no contracts, remove interface if it exists
				system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;,null);
		}
		else
		{
				var title = expandMissionText(&quot;oolite-contracts-cargo-interface-title&quot;,{
						&quot;oolite-contracts-cargo-interface-title-count&quot;: this.$contracts.length
				});

				system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;,{
						title: title,
						category: expandMissionText(&quot;oolite-contracts-cargo-interface-category&quot;),
						summary: expandMissionText(&quot;oolite-contracts-cargo-interface-summary&quot;),
						callback: this._cargoContractsScreens.bind(this)
						// could alternatively use &quot;cbThis: this&quot; parameter instead of bind()
				});
		}
}


// if the interface is activated, this function is run.
this._cargoContractsScreens = function(interfaceKey)
{
		// the interfaceKey parameter is not used here, but would be useful if
		// this callback managed more than one interface entry

		this._validateContracts();

		// set up variables used to remember state on the mission screens
		this.$suspendedDestination = null;
		this.$suspendedHUD = false;
		this.$contractIndex = 0;
		this.$routeMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
		this.$lastOptionChosen = &quot;06_EXIT&quot;;

		// start on the summary page if more than one contract is available
		var summary = (this.$contracts.length &gt; 1);

		this._cargoContractsDisplay(summary);
}


// this function is called after the player makes a choice which keeps
// them in the system, and also on initial entry to the system
// to select the appropriate mission screen and display it
this._cargoContractsDisplay = function(summary) {

		// Again. Has to be done on every call to this function, but also
		// has to be done at the start.
		this._validateContracts();

		// if there are no contracts (usually because the player has taken
		// the last one) display a message and quit.
		if (this.$contracts.length === 0)
		{
				var missionConfig = {titleKey: &quot;oolite-contracts-cargo-none-available-title&quot;,
													 messageKey: &quot;oolite-contracts-cargo-none-available-message&quot;,
													 allowInterrupt: true,
													 screenID: &quot;oolite-contracts-cargo-none&quot;,
													 exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;};
				if (this.$cargoSummaryPageBackground != &quot;&quot;) {
						missionConfig.background = this.$cargoSummaryPageBackground;
				}
				if (this.$cargoPageOverlay != &quot;&quot;) {
						missionConfig.overlay = this.$cargoPageOverlay;
				}
				mission.runScreen(missionConfig);
				// no callback, just exits contracts system
				return;
		}

		// make sure that the &#39;currently selected contract&#39; pointer
		// is in bounds
		if (this.$contractIndex &gt;= this.$contracts.length)
		{
				this.$contractIndex = 0;
		}
		else if (this.$contractIndex &lt; 0)
		{
				this.$contractIndex = this.$contracts.length - 1;
		}
		// sub functions display either summary or detail screens
		if (summary)
		{
				this._cargoContractSummaryPage();
		}
		else
		{
				this._cargoContractSinglePage();
		}

}


// display the mission screen for the summary page
this._cargoContractSummaryPage = function()
{
		// column &#39;tab stops&#39;
		var columns = [9,15,21,26];

		// column header line
		var headline = expandMissionText(&quot;oolite-contracts-cargo-column-goods&quot;);
		// pad to correct length to give a table-like layout
		headline += this.$helper._paddingText(headline,columns[0]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-destination&quot;);
		headline += this.$helper._paddingText(headline,columns[1]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-within&quot;);
		headline += this.$helper._paddingText(headline,columns[2]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-deposit&quot;);
		headline += this.$helper._paddingText(headline,columns[3]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-fee&quot;);
		// required because of way choices are displayed.
		headline = &quot; &quot;+headline;

		// setting options dynamically; one contract per line
		var options = new Object;
		var i;
		var anyWithSpace = false;
		for (i=0; i&lt;this.$contracts.length; i++)
		{
				// temp variable to simplify following code
				var cargo = this.$contracts[i];
				// write the description, padded to line up with the headers
				var optionText = this._descriptionForGoods(cargo);
				optionText += this.$helper._paddingText(optionText, columns[0]);
				optionText += System.infoForSystem(galaxyNumber, cargo.destination).name;
				optionText += this.$helper._paddingText(optionText, columns[1]);
				optionText += this.$helper._timeRemaining(cargo);
				optionText += this.$helper._paddingText(optionText, columns[2]);
				// right-align the fee so that the credits signs line up
				var priceText = formatCredits(cargo.deposit,false,true);
				priceText = this.$helper._paddingText(priceText, 3.5)+priceText;
				optionText += priceText
				optionText += this.$helper._paddingText(optionText, columns[3]);
				// right-align the fee so that the credits signs line up
				priceText = formatCredits(cargo.payment-cargo.deposit,false,true);
				priceText = this.$helper._paddingText(priceText, 3.5)+priceText;
				optionText += priceText

				// need to pad the number in the key to maintain alphabetical order
				var istr = i;
				if (i &lt; 10)
				{
						istr = &quot;0&quot;+i;
				}
				// needs to be aligned left to line up with the heading
				options[&quot;01_CONTRACT_&quot;+istr] = { text: optionText, alignment: &quot;LEFT&quot; };

				// check if there&#39;s space for this contract
				if (!this._hasSpaceFor(cargo))
				{
						options[&quot;01_CONTRACT_&quot;+istr].color = &quot;darkGrayColor&quot;;
				}
				else
				{
						anyWithSpace = true;
						// if there doesn&#39;t appear to be sufficient time remaining
						if (this.$helper._timeRemainingSeconds(cargo) &lt; this.$helper._timeEstimateSeconds(cargo))
						{
								options[&quot;01_CONTRACT_&quot;+istr].color = &quot;orangeColor&quot;;
						}
				}
		}
		// if we&#39;ve come from the detail screen, make sure the last
		// contract shown there is selected here
		var icstr = this.$contractIndex;
		if (icstr &lt; 10)
		{
				icstr = &quot;0&quot;+this.$contractIndex;
		}
		var initialChoice = &quot;01_CONTRACT_&quot;+icstr;
		// if none of them have any space...
		if (!anyWithSpace)
		{
				initialChoice = &quot;06_EXIT&quot;;
		}

		// next, an empty string gives an unselectable row
		options[&quot;02_SPACER&quot;] = &quot;&quot;;

		// numbered 06 to match the option of the same function in the other branch
		options[&quot;06_EXIT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-quit&quot;);

		// now need to add further spacing to fill the remaining rows, or
		// the options will end up at the bottom of the screen.
		var rowsToFill = 21;
		if (player.ship.hudHidden || this.$isBigGuiActive() == true)
		{
				rowsToFill = 27;
		}

		for (i = 4 + this.$contracts.length; i &lt; rowsToFill ; i++)
		{
				// each key needs to be unique at this stage.
				options[&quot;07_SPACER_&quot;+i] = &quot;&quot;;
		}

		var missionConfig = {titleKey: &quot;oolite-contracts-cargo-title-summary&quot;,
												 message: headline,
												 allowInterrupt: true,
												 screenID: &quot;oolite-contracts-cargo-summary&quot;,
												 exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
												 choices: options,
												 initialChoicesKey: initialChoice};
		if (this.$cargoSummaryPageBackground != &quot;&quot;) {
				missionConfig.background = this.$cargoSummaryPageBackground;
		}
		if (this.$cargoPageOverlay != &quot;&quot;) {
				missionConfig.overlay = this.$cargoPageOverlay;
		}

		// now run the mission screen
		mission.runScreen(missionConfig, this._processCargoChoice, this);

}


// display the mission screen for the contract detail page
this._cargoContractSinglePage = function()
{
		// temp variable to simplify code
		var cargo = this.$contracts[this.$contractIndex];

		// This mission screen uses the long range chart as a backdrop.
		// This means that the first 18 lines are taken up by the chart,
		// and we can&#39;t put text there without overwriting the chart.
		// We therefore need to hide the player&#39;s HUD, to get the full 27
		// lines.

		if (!player.ship.hudHidden &amp;&amp; this.$isBigGuiActive() == false)
		{
				this.$suspendedHUD = true; // note that we hid it, for later
				player.ship.hudHidden = true;
		}

		// We also set the player&#39;s witchspace destination temporarily
		// so we need to store the old one in a variable to reset it later
		this.$suspendedDestination = player.ship.targetSystem;

		// That done, we can set the player&#39;s destination so the map looks
		// right.
		player.ship.targetSystem = cargo.destination;

		// start with 18 blank lines, since we don&#39;t want to overlap the chart
		var message = new Array(18).join(&quot;\n&quot;);

		message += expandMissionText(&quot;oolite-contracts-cargo-long-description&quot;,{
				&quot;oolite-contracts-cargo-longdesc-goods&quot;: this._descriptionForGoods(cargo),
				&quot;oolite-contracts-cargo-longdesc-destination&quot;: this.$helper._systemName(cargo.destination),
				&quot;oolite-contracts-cargo-longdesc-deadline&quot;: this.$helper._timeRemaining(cargo),
				&quot;oolite-contracts-cargo-longdesc-time&quot;: this.$helper._timeEstimate(cargo),
				&quot;oolite-contracts-cargo-longdesc-payment&quot;: formatCredits(cargo.payment,false,true),
				&quot;oolite-contracts-cargo-longdesc-deposit&quot;: formatCredits(cargo.deposit,false,true)
		});

		// use a special background
		var backgroundSpecial = &quot;LONG_RANGE_CHART&quot;;

		// the available options will vary quite a bit, so this rather
		// than a choicesKey in missiontext.plist
		var options = new Object;
		// this is the only option which is always available
		options[&quot;06_EXIT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-quit&quot;);

		// if the player has sufficient space
		if (this._hasSpaceFor(cargo))
		{
				options[&quot;05_ACCEPT&quot;] = {
						text: expandMissionText(&quot;oolite-contracts-cargo-command-accept&quot;)
				};

				// if there&#39;s not much time left, change the option colour as a warning!
				if (this.$helper._timeRemainingSeconds(cargo) &lt; this.$helper._timeEstimateSeconds(cargo))
				{
						options[&quot;05_ACCEPT&quot;].color = &quot;orangeColor&quot;;
				}
		}
		else
		{
				options[&quot;05_UNAVAILABLE&quot;] = {
						text: expandMissionText(&quot;oolite-contracts-cargo-command-unavailable&quot;),
						color: &quot;darkGrayColor&quot;,
						unselectable: true
				};
		}

		// if the ship has a working advanced nav array, can switch
		// between &#39;quickest&#39; and &#39;shortest&#39; routes
		// (and also upgrade the special background)
		if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) === &quot;EQUIPMENT_OK&quot;)
		{
				backgroundSpecial = this.$routeMode;
				if (this.$routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;)
				{
						options[&quot;01_MODE&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-ana-quickest&quot;);
				}
				else
				{
						options[&quot;01_MODE&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-ana-shortest&quot;);
				}
		}
		// if there&#39;s more than one, need options for forward, back, and listing
		if (this.$contracts.length &gt; 1)
		{
				options[&quot;02_BACK&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-back&quot;);
				options[&quot;03_NEXT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-next&quot;);
				options[&quot;04_LIST&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-list&quot;);
		}
		else
		{
				// if not, we may need to set a different choice
				// we never want 05_ACCEPT to end up selected initially
				if (this.$lastChoice === &quot;02_BACK&quot; || this.$lastChoice === &quot;03_NEXT&quot; || this.$lastChoice === &quot;04_LIST&quot;)
				{
						this.$lastChoice = &quot;06_EXIT&quot;;
				}
		}

		var title = expandMissionText(&quot;oolite-contracts-cargo-title-detail&quot;,{
				&quot;oolite-contracts-cargo-title-detail-number&quot;: this.$contractIndex+1,
				&quot;oolite-contracts-cargo-title-detail-total&quot;: this.$contracts.length
		});

		// finally, after all that setup, actually create the mission screen

		var missionConfig = {
				title: title,
				message: message,
				allowInterrupt: true,
				screenID: &quot;oolite-contracts-cargo-details&quot;,
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
				backgroundSpecial: backgroundSpecial,
				choices: options,
				initialChoicesKey: this.$lastChoice
		};

		if (this.$cargoPageOverlay != &quot;&quot;) {
				missionConfig.overlay = this.$cargoPageOverlay;
		}

		mission.runScreen(missionConfig,this._processCargoChoice, this);

}


this._processCargoChoice = function(choice)
{
		this._resetViews();
		if (choice === null)
		{
				// can occur if ship launches mid mission screen
				return;
		}

		// now process the various choices
		if (choice.match(/^01_CONTRACT_/))
		{
				// contract selected from summary page
				// set the index to that contract, and show details
				var index = parseInt(choice.slice(12),10);
				this.$contractIndex = index;
				this.$lastChoice = &quot;04_LIST&quot;;
				this._cargoContractsDisplay(false);
		}
		else if (choice === &quot;01_MODE&quot;)
		{
				// advanced navigation array mode flip
				this.$routeMode = (this.$routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;)?&quot;LONG_RANGE_CHART_QUICKEST&quot;:&quot;LONG_RANGE_CHART_SHORTEST&quot;;
				this.$lastChoice = &quot;01_MODE&quot;;
				this._cargoContractsDisplay(false);
		}
		else if (choice === &quot;02_BACK&quot;)
		{
				// reduce contract index (cargoContractsDisplay manages wraparound)
				this.$contractIndex--;
				this.$lastChoice = &quot;02_BACK&quot;;
				this._cargoContractsDisplay(false);
		}
		else if (choice === &quot;03_NEXT&quot;)
		{
				// increase contract index (cargoContractsDisplay manages wraparound)
				this.$contractIndex++;
				this.$lastChoice = &quot;03_NEXT&quot;;
				this._cargoContractsDisplay(false);
		}
		else if (choice === &quot;04_LIST&quot;)
		{
				// display the summary page
				this._cargoContractsDisplay(true);
		}
		else if (choice === &quot;05_ACCEPT&quot;)
		{
				this._acceptContract();
				// do not leave the setting as accept for the next contract!
				this.$lastChoice = &quot;03_NEXT&quot;;
				this._cargoContractsDisplay(false);
		}
		// if we get this far without having called cargoContractsDisplay
		// that means either &#39;exit&#39; or an unrecognised option was chosen
}


// move goods from the contracts list to the player&#39;s ship (if possible)
this._acceptContract = function()
{
		var cargo = this.$contracts[this.$contractIndex];

		if (cargo.deposit &gt; player.credits)
		{
				this.$helper._soundFailure();
				return;
		}

		// give the cargo to the player
		var result = player.ship.awardContract(cargo.size,cargo.commodity,system.ID,cargo.destination,cargo.deadline,cargo.payment,cargo.deposit);

		if (result)
		{
				// pay the deposit
				player.credits -= cargo.deposit;

				// remove the contract from the station list
				this.$contracts.splice(this.$contractIndex,1);

				// update the interface description
				this._updateMainStationInterfacesList();

				this.$helper._soundSuccess();
		}
		else
		{
				// else must have had manifest change recently
				// (unlikely, but another OXP could have done it)
				this.$helper._soundFailure();
		}
}


// removes any expired contracts
this._validateContracts = function()
{
		var c = this.$contracts.length-1;
		var removed = false;
		// iterate downwards so we can safely remove as we go
		for (var i=c;i&gt;=0;i--)
		{
				// if the time remaining is less than 1/3 of the estimated
				// delivery time, even in the best case it&#39;s probably not
				// going to get there.

				if (this.$helper._timeRemainingSeconds(this.$contracts[i]) &lt; this.$helper._timeEstimateSeconds(this.$contracts[i]) / 3)
				{
						// remove it
						this.$contracts.splice(i,1);
						removed = true;
				}
		}
		if (removed)
		{
				// update the interface description if we removed any
				this._updateMainStationInterfacesList();
		}
}


/* Utility functions */

// calculates a sample price for a commodity in a distant system
this._priceForCommodity = function(commodity,systeminfo)
{
	//sample price returns decicredits, need credits
	return systeminfo.samplePrice(commodity)/10;
}

// description of the cargo
this._descriptionForGoods = function(cargo)
{
		var unit = &quot;tons&quot;;
		if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] == &quot;1&quot;)
		{
				unit = &quot;kilograms&quot;;
		}
		else if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] == &quot;2&quot;)
		{
				unit = &quot;grams&quot;;
		}

		return cargo.size+expandDescription(&quot;[cargo-&quot;+unit+&quot;-symbol]&quot;)+&quot; &quot;+displayNameForCommodity(cargo.commodity);
}

// check if player&#39;s ship has space for the cargo and can afford the deposit
this._hasSpaceFor = function(cargo)
{
		if (cargo.deposit &gt; player.credits)
		{
				return false;
		}
		var amountInTC = cargo.size;
		if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] == &quot;1&quot;)
		{
				var spareSafe = 499-(player.ship.manifest[cargo.commodity] % 1000);
				amountInTC -= spareSafe;
				amountInTC = Math.ceil(amountInTC/1000);
				if (amountInTC &lt; 0)
				{
						amountInTC = 0;
				}
		}
		else if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] == &quot;2&quot;)
		{
				var spareSafe = 499999-(player.ship.manifest[cargo.commodity] % 1000000);
				amountInTC -= spareSafe;
				amountInTC = Math.ceil(amountInTC/1000000);
				if (amountInTC &lt; 0)
				{
						amountInTC = 0;
				}
		}

		return (amountInTC &lt;= player.ship.cargoSpaceAvailable);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt; 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;]; 	// until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/permit_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Permit_Conditions&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2015 phkb&quot;;
this.description = &quot;Condition script for determining whether to include the &#39;Import permit&#39; item on the F3 screen&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function (equipment, ship, context) {

	if (player.ship.dockedStation.allegiance != &quot;galcop&quot;) return false;
	var result = true;

	switch (equipment) {
		case &quot;EQ_IMPORT_PERMIT&quot;:
			var si = worldScripts.Smugglers_Illegal;
			var goods = si.$illegalGoodsList(system.ID);

			// are there any illegal goods in this system
			if (goods.length === 0) {
				return false;
			}
			// does the player already have permits for all the goods?
			var count = 0;
			var permitavail = 0;
			for (var i = 0; i &lt; goods.length; i++) {
				if (goods[i].permit === 1) {
					permitavail += 1;
					if (si.$playerHasPermit(system.ID, goods[i].commodity) === true) {
						count += 1;
						permitavail -= 1;
					}
				}
			}
			if (count === goods.length) result = false;
			if (permitavail &lt;= 0) result = false;
			break;
	}

	// otherwise allowed
	return result;

}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_blackmarket.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_BlackMarket&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the Black Market interface screen.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

/*
Ideas: 
- Add an equipment selling facility, so players can try to sell equipment for a profit
	- add interface into SDC to &quot;board ship&quot; then &quot;steal equipment&quot; from NPC ships
	- need ships created by SDC to include default equipment from SC
- Add notes to bulletin board about where you might be able to find the phase scanner, then increase chance at that destination
*/

this._disabled = false;
this._debug = false;

this._smugglingAllegiance = [&quot;pirate&quot;, &quot;chaotic&quot;];
this._includeRoles = [&quot;rockhermit&quot;, &quot;rockhermit-chaotic&quot;, &quot;rockhermit-pirate&quot;, &quot;random_hits_any_spacebar&quot;]; // make sure these stations have a Black Market
this._excludeRoles = [&quot;slaver_base&quot;, &quot;rrs_slaverbase&quot;]; // stations with these roles won&#39;t have a Black Market

this._fakePermits = []; // list of systems where fake permits can be bought, plus the rating of each
// value of 0 means no fake permits can be bought in that system
// value of 0.5 to 0.99 reliability of permits bought (0.99 means almost perfect)
this._display = 0;
this._noticeboard = [];
this._selectedIndex = 0;
this._waypoints = [];
this._fakePermitCost = 120;
this._waypointCost = 20;
this._phaseScanCost = 450;
this._blackMarketSalesPerson = &quot;&quot;;
this._sellCommodity = &quot;&quot;;
this._sellQuantity = 0;
this._sellType = &quot;&quot;;
this._offerQuantity = 0;
this._offerPrice = 0.0;
this._menuColor = &quot;orangeColor&quot;;
this._itemColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._blackMarketSales = [];
this._blackMarketContacts = [];
this._blackMarketShutdown = [];
this._blackMarketWelcome = &quot;&quot;;
this._sting = false;
this._stingShip = null;
this._stingStation = null;
this._stingShipChance = 0.3;
this._noBribe = false;
this._lastChoice = [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;];
this._additionalSaleItems = [];
this._systemFactor = -1;
this._stationIncludeScriptKey = [];
this._stationExcludeScriptKey = [];

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {

	if (this._disabled) {
		delete this.playerWillSaveGame;
		delete this.playerEnteredNewGalaxy;
		delete this.shipExitedWitchspace;
		delete this.shipDockedWithStation;
		delete this.shipLauncedFromStation;
		delete this.startUpComplete;
		return;
	}

	var core = worldScripts.Smugglers_CoreFunctions;
	this.$padTextRight = core.$padTextRight;
	this.$padTextLeft = core.$padTextLeft;
	this.$isBigGuiActive = core.$isBigGuiActive;
	this.$rand = core.$rand;

	if (missionVariables.Smuggling_Noticeboard) {
		this._noticeboard = JSON.parse(missionVariables.Smuggling_Noticeboard);
	} else {
		this._rebuildTimer = new Timer(this, this.$buildNoticeboard, 2, 0);
	}
	if (missionVariables.Smuggling_FakePermits) {
		this._fakePermits = JSON.parse(missionVariables.Smuggling_FakePermits);
	} else {
		this.$buildFakePermitArray();
	}
	if (missionVariables.Smuggling_Waypoints) this._waypoints = JSON.parse(missionVariables.Smuggling_Waypoints);
	if (missionVariables.Smuggling_BlackMarketSales) {
		this._blackMarketSales = JSON.parse(missionVariables.Smuggling_BlackMarketSales);
		delete missionVariables.Smuggling_BlackMarketSales;
	}
	if (missionVariables.Smuggling_BlackMarketContacts) this._blackMarketContacts = JSON.parse(missionVariables.Smuggling_BlackMarketContacts);
	if (missionVariables.Smuggling_BlackMarketShutdown) this._blackMarketShutdown = JSON.parse(missionVariables.Smuggling_BlackMarketShutdown);
	if (missionVariables.Smuggling_BlackMarketSting) this._sting = missionVariables.Smuggling_BlackMarketSting;
	if (missionVariables.Smuggling_BlackMarketStingShipChance) this._stingShipChance = missionVariables.Smuggling_BlackMarketStingShipChance;
	if (missionVariables.Smuggling_BlackMarketAdditional) this._additionalSaleItems = JSON.parse(missionVariables.Smuggling_BlackMarketAdditional);
	if (missionVariables.Smuggling_BlackMarketSystemFactor) this._systemFactor = missionVariables.Smuggling_BlackMarketSystemFactor;
	if (this._systemFactor === -1) this.$setupSystemFactor();

	// because stations display name may not be populated at this point, create a timer to set up the sting
	if (this._sting) this._delayStingSetup = new Timer(this, this.$setupStingAfterLoad, 2, 0);
	// set up the interface screen, if required
	this.$initMainInterface(player.ship.dockedStation);
	this.$addCoreEquipmentToBlackMarket();
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	missionVariables.Smuggling_Noticeboard = JSON.stringify(this._noticeboard);
	missionVariables.Smuggling_FakePermits = JSON.stringify(this._fakePermits);
	missionVariables.Smuggling_Waypoints = JSON.stringify(this._waypoints);
	missionVariables.Smuggling_BlackMarketStingShipChance = this._stingShipChance;
	if (this._blackMarketSales.length &gt; 0) missionVariables.Smuggling_BlackMarketSales = JSON.stringify(this._blackMarketSales);
	if (this._blackMarketContacts.length &gt; 0) missionVariables.Smuggling_BlackMarketContacts = JSON.stringify(this._blackMarketContacts);
	if (this._blackMarketShutdown.length &gt; 0) missionVariables.Smuggling_BlackMarketShutdown = JSON.stringify(this._blackMarketShutdown);
	if (this._additionalSaleItems.length &gt; 0) missionVariables.Smuggling_BlackMarketAdditional = JSON.stringify(this._additionalSaleItems);
	missionVariables.Smuggling_BlackMarketSystemFactor = this._systemFactor;

	if (this._sting) {
		missionVariables.Smuggling_BlackMarketSting = this._sting;
		missionVariables.Smuggling_BlackMarketStingStation = this._stingStation.displayName;
		if (this._stingShip) missionVariables.Smuggling_BlackMarketStingShip = true;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredNewGalaxy = function (galaxyNumber) {
	this.$buildFakePermitArray();
	this._waypoints = [];
	this._blackMarketShutdown = [];
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	this._additionalSaleItems = [];
	this.$setupSystemFactor();

	// rebuild the notice board a few seconds after entering a new system
	// that should give the other systems a chance to finish
	this._rebuildTimer = new Timer(this, this.$buildNoticeboard, 5, 0);
	this.$addRHWaypoint();
	this._blackMarketSales = [];
	// reset any sting info
	this._sting = false;
	this._stingStation = null;
	this._stingShip = null;
	// find a station with a black market
	var stns = system.stations;
	for (var i = 0; i &lt; stns.length; i++) {
		if (this.$doesStationHaveBlackMarket(stns[i]) === true) {
			var hasVisited = this.$playerHasBeenToBlackMarket(stns[i]);
			// there&#39;s a small chance of a black market sting if the player has visited the station, and an even smaller chance if they haven&#39;t
			if ((hasVisited === true &amp;&amp; Math.random() &gt; 0.9) || (hasVisited === false &amp;&amp; Math.random() &gt; 0.98)) {
				// set up the sting
				this.$setupSting(stns[i]);
				// don&#39;t set up more than one sting operation, so break here when we&#39;re done.
				break;
			}
		}
	}
	// clean up any shutdowns that have expired
	if (this._blackMarketShutdown.length &gt; 0) {
		for (var i = this._blackMarketShutdown.length - 1; i &gt;= 0; i--) {
			if (clock.adjustedSeconds - this._blackMarketShutdown[i].date &gt; 2592000) this._blackMarketShutdown.splice(i, 1);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	this.$addCoreEquipmentToBlackMarket();
	this.$initMainInterface(station);
	this._blackMarketSalesPerson = &quot;&quot;;
	this._blackMarketWelcome = &quot;&quot;;
	// remove the sting ship after we dock, if it&#39;s still there
	if (this._sting === true &amp;&amp; this._stingStation === station &amp;&amp; this._stingShip &amp;&amp; this._stingShip.isValid) {
		this._stingShip.remove(true);
		this._stingShip = null;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
	this.$addRHWaypoint();
	// remove the sale items when we launch
	this.$removeSaleItem(&quot;EQ_CLOAKING_DEVICE&quot;);
	var eq = player.ship.equipment;
	for (var i = 0; i &lt; eq.length; i++) {
		if (eq[i].equipmentKey.indexOf(&quot;NAVAL&quot;) &gt;= 0 || eq[i].equipmentKey.indexOf(&quot;MILITARY&quot;) &gt;= 0) {
			var item = EquipmentInfo.infoForKey(eq[i].equipmentKey);
			this.$removeSaleItem(eq[i].equipmentKey);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
/* adds an item to the Black Market additional sale items
 passed object must have:
	key:				(required) text to be sent back to the calling OXP to identify the sale item
	text:				(required) text to be displayed on the sale screen
	cost:				(required) cost of the item to be sold. must be greater than 0
	worldScript:		(required) name of the calling worldScript
	sellCallback:		(required) name of the function to call if the item is sold
*/
this.$addSaleItem = function $addSaleItem(obj) {
	if (obj.hasOwnProperty(&quot;key&quot;) === false || obj.key == &quot;&quot;) {
		throw &quot;Invalid sale item properties: &#39;key&#39; must be supplied&quot;;
	}
	if (obj.hasOwnProperty(&quot;text&quot;) === false || obj.text == &quot;&quot;) {
		throw &quot;Invalid sale item properties: &#39;text&#39; must be supplied&quot;;
	}
	if (obj.hasOwnProperty(&quot;cost&quot;) === false) {
		throw &quot;Invalid sale item properties: &#39;cost&#39; must be supplied&quot;;
	}
	if (parseInt(obj.cost) === 0) {
		throw &quot;Invalid sale item properties: &#39;cost&#39; must be greater than 0&quot;;
	}
	if (obj.hasOwnProperty(&quot;worldScript&quot;) === false || obj.worldScript == &quot;&quot;) {
		throw &quot;Invalid sale item properties: &#39;worldScript&#39; must be supplied&quot;;
	}
	if (obj.hasOwnProperty(&quot;sellCallback&quot;) === false || obj.sellCallback == &quot;&quot;) {
		throw &quot;Invalid sale item properties: &#39;sellCallback&#39; must be supplied&quot;;
	}
	for (var i = 0; i &lt; this._additionalSaleItems.length; i++) {
		if (this._additionalSaleItems[i].key === obj.key) {
			throw &quot;Invalid sale item properties: &#39;key&#39; of &quot; + obj.key + &quot; is already in use.&quot;;
		}
	}
	this._additionalSaleItems.push(obj);
}

//-------------------------------------------------------------------------------------------------------------
// removes all items from the sale list linked to a particular worldScript
this.$removeWorldScriptItems = function $removeWorldScriptItems(ws) {
	for (var i = this._additionalSaleItems.length - 1; i &gt;= 0; i--) {
		if (this._additionalSaleItems[i].worldScript === ws) {
			this._additionalSaleItems.splice(i, 1);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// removes an item from the sale list with the specific key value
this.$removeSaleItem = function $removeSaleItem(key) {
	for (var i = 0; i &lt; this._additionalSaleItems.length; i++) {
		if (this._additionalSaleItems[i].key === key) {
			this._additionalSaleItems.splice(i, 1);
			break;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// initialise the illegal goods F4 screen entries
this.$initMainInterface = function $initMainInterface(station) {
	// only at pirate or chaotic stations, all rock hermits, and selected main stations
	if (this._debug === true || (this.$doesStationHaveBlackMarket(station) === true)) {
		station.setInterface(this.name, {
			title: &quot;Black market&quot;,
			category: &quot;Station Interfaces&quot;,
			summary: &quot;Access to the Black Market of the Galactic Underworld.&quot;,
			callback: this.$initialBlackMarket.bind(this)
		});
	} else {
		station.setInterface(this.name, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$isStationIncluded = function $isStationIncluded(station) {
	for (var i = 0; i &lt; this._includeRoles.length; i++) {
		if (station.hasRole(this._includeRoles[i]) === true) return true;
	}
	if (this._stationIncludeScriptKey.length &gt; 0) {
		for (var i = 0; i &lt; this._stationIncludeScriptKey.length; i++) {
			var item = this._stationIncludeScriptKey[i].key;
			var value = this._stationIncludeScriptKey[i].value;
			if (station.script.hasOwnProperty(item) === true &amp;&amp; station.script[item] == value) return true;
		}
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$isStationExcluded = function $isStationExcluded(station) {
	for (var i = 0; i &lt; this._excludeRoles.length; i++) {
		if (station.hasRole(this._excludeRoles[i]) === true) return true;
	}
	if (this._stationExcludeScriptKey.length &gt; 0) {
		for (var i = 0; i &lt; this._stationExcludeScriptKey.length; i++) {
			var item = this._stationExcludeScriptKey[i].key;
			var value = this._stationExcludeScriptKey[i].value;
			if (station.script.hasOwnProperty(item) === true &amp;&amp; station.script[item] == value) return true;
		}
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$initialBlackMarket = function $initialBlackMarket() {
	this._display = 0;
	this._selectedIndex = 0;
	this.$blackMarketOptions();
}

//-------------------------------------------------------------------------------------------------------------
this.$blackMarketOptions = function $blackMarketOptions() {

	var curChoices = {};
	var text = &quot;&quot;;
	var p = player.ship;
	var stn = p.dockedStation;
	var def = &quot;&quot;;
	var si = worldScripts.Smugglers_Illegal;
	var se = worldScripts.Smugglers_Equipment;
	var sc = worldScripts.Smugglers_Contracts;
	var pagesize = 20;
	var image = &quot;stgu-skull.png&quot;;

	if (this.$isBigGuiActive() === true) {
		pagesize = 26;
	}

	sc._smugglingPageOverlay = image;
	sc._smugglingPageOverlayHeight = 546;

	var govs = new Array();
	for (var i = 0; i &lt; 8; i++)
		govs.push(String.fromCharCode(i));
	var spc = String.fromCharCode(31);

	// main menu
	if (this._display === 0) {
		// if we haven&#39;t shown the initial welcome, get one now
		if (this._blackMarketWelcome === &quot;&quot;) {
			// use one of the standard welcomes, but if it&#39;s a sting use the alternate ones. Also, there&#39;s a chance of the alternate ones anyway, so it&#39;s not a complete give-away
			this._blackMarketWelcome = expandDescription(&quot;[blackmarket-welcome&quot; + (this._sting === true || Math.random() &gt; 0.8 ? &quot;-sting&quot; : &quot;&quot;) + &quot;]&quot;, {
				contactname: this.$getBlackMarketContact(p.dockedStation)
			});
		}
		// add this to the text
		text = this._blackMarketWelcome

		// reset the welcome text for the next time we show the main menu, so that the welcome text is only displayed once.
		this._blackMarketWelcome = &quot;Black Market services available:&quot;;

		var itemcount = 2;
		curChoices[&quot;01_NOTICEBOARD&quot;] = {
			text: &quot;[blackmarket-noticeboard]&quot;,
			color: this._menuColor
		};
		if (!worldScripts.ContractsOnBB) {
			// contracts only available at rock hermits
			if ((this._debug === true ||
					(Ship.roleIsInCategory(p.dockedStation.primaryRole, &quot;oolite-rockhermits&quot;) &amp;&amp; p.dockedStation.hasRole(&quot;slaver_base&quot;) === false &amp;&amp; p.dockedStation.hasRole(&quot;rrs_slaverbase&quot;) === false)) &amp;&amp;
				sc._contracts.length &gt; 0) {
				//if ((this._debug === true || this._smugglingAllegiance.indexOf(p.dockedStation.allegiance) &gt;= 0) &amp;&amp; sc._contracts.length &gt; 0) { // alternate logic for non-galcop stations
				curChoices[&quot;02_CONTRACTS&quot;] = {
					text: &quot;View any smuggling contracts on offer (&quot; + sc._contracts.length + &quot; available)&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}
		curChoices[&quot;03_PURCHASE&quot;] = {
			text: &quot;[blackmarket-purchasing]&quot;,
			color: this._menuColor
		};

		if (se.$playerHasIllegalCargo(system.mainStation) === true || se.$playerHasHiddenIllegalCargo(system.mainStation) === true) {
			var saleitems = 0;
			var viscargo = p.manifest.list;
			for (var i = 0; i &lt; viscargo.length; i++) {
				if (system.mainStation.market[viscargo[i].commodity].legality_import &gt; 0 &amp;&amp; this._blackMarketSales.indexOf(viscargo[i].commodity) === -1) saleitems += 1;
			}
			var smuggle = se.$getSmugglingCargo();
			for (var i = 0; i &lt; smuggle.length; i++) {
				if (system.mainStation.market[smuggle[i].commodity].legality_import &gt; 0 &amp;&amp; this._blackMarketSales.indexOf(smuggle[i].commodity) === -1) saleitems += 1;
			}
			if (saleitems &gt; 0) {
				curChoices[&quot;04_SELL_ILLEGAL&quot;] = {
					text: &quot;[blackmarket-sellcargo-menu]&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}

		if (se.$sellablePhaseScans() &gt; 0) {
			curChoices[&quot;07_SELLSCAN&quot;] = {
				text: &quot;[blackmarket-sellphasescan-menu]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
		}
		if (this._additionalSaleItems.length &gt; 0) {
			curChoices[&quot;08_SELLADDITIONAL&quot;] = {
				text: &quot;Sell additional items&quot;,
				color: this._menuColor
			}
			itemcount += 1;
		}

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;99_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Black Market Main Menu&quot;,
			overlay: {
				name: image,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// display noticeboard item
	if (this._display === 2) {

		if (this._selectedIndex &lt; this._noticeboard.length - 1) {
			curChoices[&quot;20_NEXTITEM&quot;] = {
				text: &quot;[blackmarket-nextitem]&quot;,
				color: this._menuColor
			};
			curChoices[&quot;30_LASTITEM&quot;] = {
				text: &quot;[blackmarket-lastitem]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;20_NEXTITEM&quot;] = {
				text: &quot;[blackmarket-nextitem]&quot;,
				unselectable: true,
				color: this._disabledColor
			};
			curChoices[&quot;30_LASTITEM&quot;] = {
				text: &quot;[blackmarket-lastitem]&quot;,
				unselectable: true,
				color: this._disabledColor
			};
		}
		if (this._selectedIndex &gt; 0) {
			curChoices[&quot;21_PREVITEM&quot;] = {
				text: &quot;[blackmarket-previtem]&quot;,
				color: this._menuColor
			};
			curChoices[&quot;31_FIRSTITEM&quot;] = {
				text: &quot;[blackmarket-firstitem]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;21_PREVITEM&quot;] = {
				text: &quot;[blackmarket-previtem]&quot;,
				unselectable: true,
				color: this._disabledColor
			};
			curChoices[&quot;31_FIRSTITEM&quot;] = {
				text: &quot;[blackmarket-firstitem]&quot;,
				unselectable: true,
				color: this._disabledColor
			};
		}

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; (pagesize - 10); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Noticeboard Item (&quot; + (this._selectedIndex + 1) + &quot; of &quot; + (this._noticeboard.length) + &quot;)&quot;,
			overlay: {
				name: image,
				height: 546
			},
			allowInterrupt: true,
			choices: curChoices,
			initialChoicesKey: def,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			message: this._noticeboard[this._selectedIndex].message
		};
	}

	// purchase items
	if (this._display === 3) {
		text = expandDescription(&quot;[blackmarket-purchaseheader]&quot;);
		var itemcount = 0;

		if (this._fakePermits[system.ID] &gt; 0) {
			curChoices[&quot;04_FAKEPERMITS&quot;] = {
				text: &quot;[blackmarket-buypermits-menu]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
		}
		curChoices[&quot;05_WAYPOINTS&quot;] = {
			text: &quot;[blackmarket-buywaypoints-menu]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;06_PHASESCAN&quot;] = {
			text: &quot;[blackmarket-buyphasescan-menu]&quot;,
			color: this._menuColor
		};

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Black Market Shop&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// purchase fake permits
	if (this._display === 4) {
		text = expandDescription(&quot;[blackmarket-buypermits]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

		// get list of local planets
		var sys = system.info.systemsInRange(15);
		var itemcount = 0;
		// loop through list
		for (var i = 0; i &lt; sys.length; i++) {
			// for any that have illegal goods that can have permits, add the planet name + permit type to the list
			var goods = si.$illegalGoodsList(sys[i].systemID);
			if (goods.length &gt; 0) {
				for (var j = 0; j &lt; goods.length; j++) {
					if (goods[j].permit === 1 &amp;&amp; system.scrambledPseudoRandomNumber(j) &gt; 0.6 &amp;&amp; si.$playerHasPermit(sys[i].systemID, goods[j].commodity, false) === false) {
						curChoices[&quot;60_PERMIT~&quot; + sys[i].systemID + &quot;|&quot; + goods[j].commodity] = {
							text: this.$padTextRight(sys[i].name + &quot; (&quot; + govs[sys[i].government] + spc + &quot;TL&quot; + (sys[i].techlevel + 1) + &quot;) -- &quot; + si.$translateCommodityList(goods[j].commodity), 20) +
								this.$padTextLeft(formatCredits(this._fakePermitCost * stn.equipmentPriceFactor, true, true), 10),
							alignment: &quot;LEFT&quot;,
							color: this._menuColor
						};
						itemcount += 1;
					}
				}
			}
		}

		if (itemcount === 0) text += expandDescription(&quot;[blackmarket-none-available]&quot;);

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;
		itemcount += 1;

		// display the list of options
		curChoices[&quot;97_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;97_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Black Market Shop&quot;,
			overlay: {
				name: image,
				height: 546
			},
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// purchase rock hermit waypoints
	if (this._display === 5) {
		text = expandDescription(&quot;[blackmarket-buywaypoints]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

		var sys = system.info.systemsInRange(7);
		var itemcount = 0;
		for (var i = 0; i &lt; sys.length; i++) {
			if (this._waypoints.indexOf(sys[i].systemID) === -1 &amp;&amp; system.scrambledPseudoRandomNumber(sys[i].systemID) &gt; 0.7) {
				curChoices[&quot;61_WAYPOINT_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + sys[i].systemID] = {
					text: this.$padTextRight(sys[i].name + &quot; (&quot; + govs[sys[i].government] + spc + &quot;TL&quot; + (sys[i].techlevel + 1) + &quot;)&quot;, 20) +
						this.$padTextLeft(formatCredits(this._waypointCost * stn.equipmentPriceFactor, true, true), 10),
					alignment: &quot;LEFT&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}
		if (itemcount === 0) text += expandDescription(&quot;[blackmarket-none-available]&quot;);

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;
		itemcount += 1;

		// display the list of options
		curChoices[&quot;97_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;97_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Black Market Shop&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// purchase phase scan settings
	if (this._display === 6) {
		text = expandDescription(&quot;[blackmarket-buyphasescan]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

		// there won&#39;t be many of these
		// get a list of all planets with illegal goods
		var sys = system.info.systemsInRange(7);
		var itemcount = 0;

		for (var i = 0; i &lt; sys.length; i++) {
			var goods = si.$illegalGoodsList(sys[i].systemID);
			if (se.$playerHasPhaseScan(sys[i].systemID) === false &amp;&amp; system.scrambledPseudoRandomNumber(sys[i].systemID) &gt; 0.5) {
				curChoices[&quot;62_PHASESCAN~&quot; + sys[i].systemID] = {
					text: this.$padTextRight(sys[i].name + &quot; (&quot; + govs[sys[i].government] + spc + &quot;TL&quot; + (sys[i].techlevel + 1) + &quot;)&quot;, 20) +
						this.$padTextLeft(formatCredits(this._phaseScanCost * stn.equipmentPriceFactor, true, true), 10),
					alignment: &quot;LEFT&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}

		if (itemcount === 0) text += expandDescription(&quot;[blackmarket-none-available]&quot;);

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;
		itemcount += 1;

		// display the list of options
		curChoices[&quot;97_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;97_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Black Market Shop&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// sell phase scan
	if (this._display === 7) {
		text = expandDescription(&quot;[blackmarket-sellphasescan]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

		var list = se.$getSellablePhaseScans();

		for (var i = 0; i &lt; list.length; i++) {
			curChoices[&quot;63_PHASESCAN~&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = {
				text: this.$padTextRight(list[i].text, 20) +
					this.$padTextLeft(formatCredits(((this._phaseScanCost * stn.equipmentPriceFactor) * 0.8), true, true), 10),
				alignment: &quot;LEFT&quot;,
				color: this._menuColor
			};
		}

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;

		// display the list of options
		curChoices[&quot;97_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - list.length); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;97_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Sell Discovered Phase Scan&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// sell illegal cargo on black market
	if (this._display === 8) {
		text = expandDescription(&quot;[blackmarket-sellcargo]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		var sdm = worldScripts.Smugglers_DockMaster;
		var heading = false;
		var itemcount = 0;

		var viscargo = p.manifest.list;
		for (var i = 0; i &lt; viscargo.length; i++) {
			if (system.mainStation.market[viscargo[i].commodity].legality_import &gt; 0 &amp;&amp; this._blackMarketSales.indexOf(viscargo[i].commodity) === -1) {
				if (heading === false) {
					curChoices[&quot;73_HEADING&quot;] = {
						text: &quot;[blackmarket-standard-hold]&quot;,
						alignment: &quot;LEFT&quot;,
						color: this._itemColor,
						unselectable: true
					};
					heading = true;
					itemcount += 1;
				}
				var q = viscargo[i].quantity;
				// remove any relabelled cargo from sale
				if (sdm.$getTotalRelabelled(viscargo[i].commodity) &gt; 0) q = q - sdm.$getTotalRelabelled(viscargo[i].commodity);
				if (q &gt; 0) {
					curChoices[&quot;73_SELL~&quot; + viscargo[i].commodity] = {
						text: viscargo[i].displayName + &quot; (&quot; + q + viscargo[i].unit + &quot;)&quot;,
						alignment: &quot;LEFT&quot;,
						color: this._menuColor
					};
					itemcount += 1;
				}
			}
		}

		heading = false;
		var smuggle = se.$getSmugglingCargo();
		for (var i = 0; i &lt; smuggle.length; i++) {
			if (system.mainStation.market[smuggle[i].commodity].legality_import &gt; 0 &amp;&amp; this._blackMarketSales.indexOf(smuggle[i].commodity) === -1) {
				if (heading === false) {
					curChoices[&quot;74_HEADING&quot;] = {
						text: &quot;[blackmarket-smuggling-compartment]&quot;,
						alignment: &quot;LEFT&quot;,
						color: this._itemColor,
						unselectable: true
					};
					heading = true;
					itemcount += 1;
				}
				curChoices[&quot;74_SELL~&quot; + smuggle[i].commodity] = {
					text: smuggle[i].quantity + &quot; &quot; + smuggle[i].unit + &quot;  &quot; + smuggle[i].displayName,
					alignment: &quot;LEFT&quot;,
					color: this._menuColor
				};
				itemcount += 1;
			}
		}

		if (itemcount === 0) {
			text += expandDescription(&quot;[blackmarket-sellcargo-none]&quot;);
			itemcount += 1;
		}

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;

		// display the list of options
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Sell Illegal Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// accept/reject black market sell offer
	if (this._display === 9) {
		// work out if there is a buyer for this commodity
		var itemcount = 1;
		var ci = si._commodityInfo[this._sellCommodity];
		var main_markup = ci[1];
		if (main_markup === 0) main_markup = 1; // default to 1 for commodities we have no data for
		var bm_markup = ci[2];
		if (bm_markup === 0) bm_markup = 1.1; // default to 75% of main for commodities we have no data for.

		if (system.scrambledPseudoRandomNumber(bm_markup) &lt; ((28 - system.info.economy) / 7)) {
			// work out how much of this cargo the market is willing to buy
			this._offerQuantity = parseInt(this._sellQuantity * ((7 - system.info.economy) + 1) / 8);
			// there is still a chance there will be a buyer for all the amount
			if (this._offerQuantity &lt; this._sellQuantity &amp;&amp; system.scrambledPseudoRandomNumber(this._sellQuantity) &gt; 0.8) {
				this._offerQuantity = this._sellQuantity;
			}
			// better prices if player&#39;s smuggling reputation is higher
			this._offerPrice = (system.info.samplePrice(this._sellCommodity) * (bm_markup +
				((system.scrambledPseudoRandomNumber(main_markup) * (sc.$getSmugglingReputationPrecise() / 7))) -
				(0.5 * (1 - sc.$getSmugglingReputationPrecise() / 7))) / 10);

			text = expandDescription(&quot;[blackmarket-buyer]&quot;, {
				quantity: this._offerQuantity + &quot; &quot; + se.$getCommodityType(this._sellCommodity),
				commodity: displayNameForCommodity(this._sellCommodity),
				price: formatCredits(this._offerPrice, false, true),
				total: formatCredits(this._offerQuantity * this._offerPrice, false, true)
			});

			curChoices[&quot;80_ACCEPTOFFER&quot;] = {
				text: &quot;[blackmarket-accept]&quot;,
				color: this._menuColor
			};
			curChoices[&quot;81_REJECTOFFER&quot;] = {
				text: &quot;[blackmarket-reject]&quot;,
				color: this._menuColor
			};
			def = &quot;80_ACCEPTOFFER&quot;;
			itemcount += 2;
		} else {
			// no buyer found
			text = expandDescription(&quot;[blackmarket-nobuyer]&quot;, {
				commodity: this._sellCommodity
			});
			def = &quot;98_EXIT&quot;;
			curChoices[&quot;98_EXIT&quot;] = {
				text: &quot;[illegal-return]&quot;,
				color: this._itemColor
			};
		}

		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		for (var i = 0; i &lt; ((pagesize - 6) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Sell Illegal Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	if (this._display === 10) {
		text = expandDescription(&quot;[blackmarket-sellotheritems]&quot;, {
			cash: formatCredits(player.credits, true, true)
		});
		text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

		var list = this._additionalSaleItems;

		for (var i = 0; i &lt; list.length; i++) {
			curChoices[&quot;50_OTHERITEM~&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = {
				text: this.$padTextRight(list[i].text, 20) +
					this.$padTextLeft(formatCredits(list[i].cost * this._systemFactor, true, true), 10),
				alignment: &quot;LEFT&quot;,
				color: this._menuColor
			};
		}

		curChoices[&quot;96_SPACER&quot;] = &quot;&quot;;
		// display the list of options
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 4) - list.length); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-smuggling-blackmarket-map&quot;,
			title: &quot;Sell Other Items&quot;,
			allowInterrupt: true,
			overlay: {
				name: image,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	mission.runScreen(opts, this.$screenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$screenHandler = function $screenHandler(choice) {

	if (choice == null) {
		this.$blackMarketOptions();
		return;
	}

	this._lastChoice[this._display] = choice;

	var p = player.ship;
	var stn = p.dockedStation;
	var se = worldScripts.Smugglers_Equipment;

	switch (choice) {
		case &quot;01_NOTICEBOARD&quot;:
			this._display = 2;
			this._selectedIndex = 0;
			break;
		case &quot;02_CONTRACTS&quot;:
			var sc = worldScripts.Smugglers_Contracts;
			sc.$smugglingContractsScreens();
			break;
		case &quot;03_PURCHASE&quot;:
			this._display = 3;
			break;
		case &quot;04_SELL_ILLEGAL&quot;:
			this._display = 8;
			break;
		case &quot;04_FAKEPERMITS&quot;:
			this._display = 4;
			break;
		case &quot;05_WAYPOINTS&quot;:
			this._display = 5;
			break;
		case &quot;06_PHASESCAN&quot;:
			this._display = 6;
			break;
		case &quot;07_SELLSCAN&quot;:
			this._display = 7;
			break;
		case &quot;97_EXIT&quot;:
			this._display = 3;
			break;
		case &quot;08_SELLADDITIONAL&quot;:
			this._display = 10;
			break;
		case &quot;20_NEXTITEM&quot;:
			this._selectedIndex += 1;
			break;
		case &quot;21_PREVITEM&quot;:
			this._selectedIndex -= 1;
			break;
		case &quot;30_LASTITEM&quot;:
			this._selectedIndex = this._noticeboard.length - 1;
			break;
		case &quot;31_FIRSTITEM&quot;:
			this._selectedIndex = 0;
			break;
		case &quot;80_ACCEPTOFFER&quot;:
			if (this._sting &amp;&amp; p.dockedStation === this._stingStation) {
				this.$stingOperation();
				return;
			}
			// pay the player
			player.credits += this._offerQuantity * this._offerPrice;
			// remove the cargo, but because this is a black market sale, it doesn&#39;t appear on the stations market. just remove it.
			switch (this._sellType) {
				case 1: // standard hold
					p.manifest[this._sellCommodity] -= this._offerQuantity;
					break;
				case 2: // smuggling compartment
					se.$removeCargo(this._offerCommodity, this._offerQuantity);
					break;
			}
			this._blackMarketSales.push(this._sellCommodity);
			se.$playSound(&quot;sell&quot;);
			player.consoleMessage(&quot;You have been credited &quot; + formatCredits(this._offerQuantity * this._offerPrice, true, true) + &quot;.&quot;);
			this._sellCommodity = &quot;&quot;;
			this._sellQuantity = 0;
			this._sellType = 0;
			this._offerQuantity = 0;
			this._offerPrice = 0;
			this._display = 8;
			break;
		case &quot;81_REJECTOFFER&quot;:
			this._sellCommodity = &quot;&quot;;
			this._sellQuantity = 0;
			this._sellType = 0;
			this._offerQuantity = 0;
			this._offerPrice = 0;
			this._display = 8;
			break;
		case &quot;98_EXIT&quot;:
			this._display = 0;
			break;
	}

	if (choice.indexOf(&quot;60_&quot;) &gt;= 0) {
		if (this._sting &amp;&amp; p.dockedStation === this._stingStation) {
			this.$stingOperation();
			return;
		}
		if (player.credits &gt;= (this._fakePermitCost * stn.equipmentPriceFactor)) {
			var data = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
			var subdata = data.split(&quot;|&quot;);
			var sysID = parseInt(subdata[0]);
			var si = worldScripts.Smugglers_Illegal;
			si._permits.push({
				systemID: sysID,
				commodity: subdata[1],
				fake: this._fakePermits[system.ID]
			});
			player.credits -= this._fakePermitCost * stn.equipmentPriceFactor;
			this.$sendPurchasingEmail(&quot;Fake import permit for &quot; + si.$translateCommodityList(subdata[1]) + &quot; to &quot; + System.infoForSystem(galaxyNumber, sysID).name,
				this._fakePermitCost * stn.equipmentPriceFactor);
		} else {
			player.consoleMessage(&quot;Insufficient funds to purchase item.&quot;);
		}
	}

	if (choice.indexOf(&quot;61_&quot;) &gt;= 0) {
		if (player.credits &gt;= (this._waypointCost * stn.equipmentPriceFactor)) {
			var sysID = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
			this._waypoints.push(sysID);
			player.credits -= this._waypointCost * stn.equipmentPriceFactor;
			this.$sendPurchasingEmail(&quot;Rock Hermit waypoint for &quot; + System.infoForSystem(galaxyNumber, sysID).name,
				this._waypointCost * stn.equipmentPriceFactor);
		} else {
			player.consoleMessage(&quot;Insufficient funds to purchase item.&quot;);
		}
	}

	if (choice.indexOf(&quot;62_&quot;) &gt;= 0) {
		if (this._sting &amp;&amp; p.dockedStation === this._stingStation) {
			this.$stingOperation();
			return;
		}
		if (player.credits &gt;= this._phaseScanCost * stn.equipmentPriceFactor) {
			var sysID = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
			var phase = se.$getSystemPhase(sysID);
			se.$addPhaseScan(phase, sysID, 2);
			player.credits -= this._phaseScanCost * stn.equipmentPriceFactor;
			this.$sendPurchasingEmail(&quot;Phase scan setting for &quot; + System.infoForSystem(galaxyNumber, sysID).name,
				this._phaseScanCost * stn.equipmentPriceFactor);
		} else {
			player.consoleMessage(&quot;Insufficient funds to purchase item.&quot;);
		}
	}

	if (choice.indexOf(&quot;63_&quot;) &gt;= 0) {
		if (this._sting &amp;&amp; p.dockedStation === this._stingStation) {
			this.$stingOperation();
			return;
		}
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		var list = se.$getSellablePhaseScans();
		se.$sellPhaseScan(list[idx].gov, list[idx].tl);
		player.credits += (this._phaseScanCost * stn.equipmentPriceFactor) * 0.8;
		this.$sendSaleEmail(&quot;Phase scan setting for &quot; + this.$governmentDescription(list[idx].gov) + &quot; systems of tech level &quot; + (list[idx].tl + 1), (this._phaseScanCost * stn.equipmentPriceFactor) * 0.8);
	}

	if (choice.indexOf(&quot;74_SELL&quot;) &gt;= 0) { // sell cargo from smuggling compartment
		this._sellCommodity = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._sellQuantity = se.$getCargoQuantity(this._sellCommodity);
		this._sellType = 2; // smuggling compartment
		this._display = 9;
	}

	if (choice.indexOf(&quot;73_SELL&quot;) &gt;= 0) { // sell cargo from standard hold
		var sdm = worldScripts.Smugglers_DockMaster;
		this._sellCommodity = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._sellQuantity = p.manifest[this._sellCommodity];
		// remove any relabelled cargo
		if (sdm.$getTotalRelabelled(this._sellCommodity) &gt; 0) this._sellQuantity = this._sellQuantity - sdm.$getTotalRelabelled(viscargo[i].commodity);
		this._sellType = 1; // standard hold
		this._display = 9;
	}

	if (choice.indexOf(&quot;50_OTHERITEM&quot;) &gt;= 0) {
		// todo: make it possible for the player to not find a buyer
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		// tell the calling script the item was sold, passing back the item key and the sell price
		worldScripts[this._additionalSaleItems[idx].worldScript][this._additionalSaleItems[idx].sellCallback](this._additionalSaleItems[idx].key, parseInt((this._additionalSaleItems[idx].cost * this._systemFactor) * 10) / 10);
		// remove the item from the list
		player.credits += parseInt((this._additionalSaleItems[idx].cost * this._systemFactor) * 10) / 10;
		this._additionalSaleItems.splice(idx, 1);
	}

	if (choice != &quot;99_EXIT&quot; &amp;&amp; choice != &quot;02_CONTRACTS&quot;) {
		this.$blackMarketOptions();
	}
}

//-------------------------------------------------------------------------------------------------------------
// sends an email confirming black market purchase
this.$sendPurchasingEmail = function $sendPurchasingEmail(itemText, cost) {
	var email = worldScripts.EmailSystem;
	if (email) {
		var ga = worldScripts.GalCopAdminServices;
		if (this._blackMarketSalesPerson === &quot;&quot;) {
			this._blackMarketSalesPerson = expandDescription(&quot;%N [nom]&quot;);
		}
		email.$createEmail({
			sender: &quot;Black Market&quot;,
			subject: &quot;Purchasing&quot;,
			date: clock.seconds,
			message: expandDescription(&quot;[blackmarket-purchasing]&quot;, {
				item: itemText,
				itemcost: cost.toFixed(2),
				sender: this._blackMarketSalesPerson
			}),
			expiryDays: ga._defaultExpiryDays
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// sends an email confirming black market sale
this.$sendSaleEmail = function $sendSaleEmail(itemText, cost) {
	var email = worldScripts.EmailSystem;
	if (email) {
		var ga = worldScripts.GalCopAdminServices;
		if (this._blackMarketSalesPerson === &quot;&quot;) {
			this._blackMarketSalesPerson = expandDescription(&quot;%N [nom]&quot;);
		}
		email.$createEmail({
			sender: &quot;Black Market&quot;,
			subject: &quot;Sale&quot;,
			date: clock.seconds,
			message: expandDescription(&quot;[blackmarket-sale]&quot;, {
				item: itemText,
				itemcost: cost.toFixed(2),
				sender: this._blackMarketSalesPerson
			}),
			expiryDays: ga._defaultExpiryDays
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$buildNoticeboard = function $buildNoticeboard() {
	function compare(a, b) {
		if (a.idx &lt; b.idx) return -1;
		if (a.idx &gt; b.idx) return 1;
		return 0;
	}

	this._noticeboard = [];

	// type 1: dock master bribe mesages
	// type 2: suggested phase settings
	// type 3: where to get good fake permits
	// type 4: random chatter

	var sdm = worldScripts.Smugglers_DockMaster;
	var si = worldScripts.Smugglers_Illegal;
	var se = worldScripts.Smugglers_Equipment;
	var finalcount = 0;

	// type 1: bribe messages
	// get all systems within 15ly
	var sys = system.info.systemsInRange(15);
	var list = [];
	// look for any with a low bribe chance (&lt; 500cr)
	for (var i = 0; i &lt; sys.length; i++) {
		if (sys[i].sun_gone_nova === false) {
			var chance = sdm._bribeChance[sys[i].systemID];
			if (chance &lt;= 0.22) {
				// decide whether or not to show it (max 2)
				if (list.length &lt; 2 &amp;&amp; Math.random() &gt; 0.6) {
					var amount = parseInt(parseInt(((chance + 0.1) * 32) ^ 2) * 100) / 100;
					list.push({
						system: sys[i].name,
						amount: amount
					});
				}
			}
		}
	}
	for (var i = 0; i &lt; list.length; i++) {
		var msg = expandDescription(&quot;[noticeboard-dmbribe]&quot;, {
			planet: list[i].system,
			amount: list[i].amount
		});
		this._noticeboard.push({
			idx: this.$rand(100),
			message: msg
		});
	}

	// type 3: fake permits
	finalcount = 0 + (Math.random() &gt; 0.5 ? 1 : 0);
	for (var i = 0; i &lt; sys.length; i++) {
		if (this._fakePermits[sys[i].systemID] &gt;= 0.8) {
			if (Math.random() &gt; 0.7) {
				var msg = expandDescription(&quot;[noticeboard-fakepermit]&quot;, {
					planet: sys[i].name
				});
				this._noticeboard.push({
					idx: this.$rand(100),
					message: msg
				});
				finalcount += 1;
			}
			// break out if we hit the limit
			if (finalcount &gt;= 2) break;
		}
	}


	// type 2: phase settings
	// will never be super accurate, but will be better than nothing.
	// get all systems with 25ly with illegal goods
	sys = system.info.systemsInRange(25);
	list = [];
	var count = 0;
	for (var i = sys.length - 1; i &gt;= 0; i--) {
		var goods = si.$illegalGoodsList(sys[i].systemID);
		var suggest_phase = se.$getSystemPhase(sys[i].systemID) + (this.$rand(50) * (Math.random() &gt; 0.5 ? 1 : -1));
		// make sure we have a positive number
		if (suggest_phase &lt; 0) suggest_phase = se.$getSystemPhase(sys[i].systemID) + (this.$rand(20) + 20);
		// make sure we don&#39;t go over the limit
		if (suggest_phase &gt;= 1000) suggest_phase = se.$getSystemPhase(sys[i].systemID) + ((this.$rand(20) + 20) * -1);

		if (goods.length &gt;= 0) {
			list.push({
				system: sys[i].name,
				phase: suggest_phase,
				hasIllegal: true
			});
			count += 1;
		} else {
			list.push({
				system: sys[i].name,
				phase: suggest_phase,
				hasIllegal: false
			});
		}
	}

	// pick 1 or (at most) 2
	finalcount = 0 + (Math.random() &gt; 0.5 ? 1 : 0);
	if (count &gt; 0) {
		// pick the ones with illegal goods
		for (var i = 0; i &lt; list.length; i++) {
			if (list[i].hasIllegal === true &amp;&amp; Math.random() &gt; 0.7) {
				var msg = expandDescription(&quot;[noticeboard-phasescan]&quot;, {
					planet: list[i].system,
					phase: list[i].phase
				});
				this._noticeboard.push({
					idx: this.$rand(100),
					message: msg
				});
				finalcount += 1;
			}
			// break out if we hit the limit
			if (finalcount &gt;= 2) break;
		}
	} else {
		// pick the ones with illegal goods
		for (var i = 0; i &lt; list.length; i++) {
			if (Math.random() &gt; 0.7) {
				var msg = expandDescription(&quot;[noticeboard-phasescan]&quot;, {
					planet: list[i].system,
					phase: list[i].phase
				});
				this._noticeboard.push({
					idx: this.$rand(100),
					message: msg
				});
				finalcount += 1;
			}
			// break out if we hit the limit
			if (finalcount &gt;= 2) break;
		}
	}

	// type 5: phase updates
	finalcount = 0;
	if (se._phaseUpdates.length &gt; 0) {
		// get a list of planets in 25 LY that have had a setting change.
		for (var i = 0; i &lt; sys.length; i++) {
			for (var j = 0; j &lt; se._phaseUpdates.length; j++) {
				if (sys[i].government === se._phaseUpdates[j].gov &amp;&amp; sys[i].techlevel === se._phaseUpdates[j].tl) {
					finalcount += 1;
					var msg = expandDescription(&quot;[noticeboard-phaseupdate]&quot;, {
						planetname: sys[i].name
					});
					this._noticeboard.push({
						idx: this.$rand(100),
						message: msg
					});
				}
			}
		}
	}

	// type 4: random chatter
	finalcount = 0;
	var randomchatter = this.$rand(3);
	var checking = [];
	missionVariables.randomphone = (this.$rand(899999) + 100000) + &quot;-&quot; + (this.$rand(899) + 100) + &quot;-&quot; + (this.$rand(89999) + 10000);
	for (var i = 1; i &lt;= randomchatter; i++) {
		var msg = expandDescription(&quot;[noticeboard-randomchatter]&quot;);
		if (checking.indexOf(msg) === -1) {
			this._noticeboard.push({
				idx: this.$rand(100),
				message: msg
			});
			checking.push(msg);
		}
	}
	delete missionVariables.randomphone;

	// sort the list, based on the random index, so the items are mixed up.
	this._noticeboard.sort(compare);
}

//-------------------------------------------------------------------------------------------------------------
// builds the fake permit array
this.$buildFakePermitArray = function $buildFakePermitArray() {
	this._fakePermits = [];

	for (var i = 0; i &lt;= 255; i++) {
		// fake permits can have, at best, a 40% chance of success
		var chance = (Math.random() * 40) / 100;
		if (chance &gt; 0.5) {
			this._fakePermits.push(chance);
		} else {
			this._fakePermits.push(0);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// adds a waypoint to the first rock hermit if the player has purchased a waypoint for this system
this.$addRHWaypoint = function $addRHWaypoint() {
	// add a waypoint to the rock hermit, if the player has one
	if (this._waypoints.indexOf(system.ID) &gt;= 0) {
		if (this._debug) log(this.name, &quot;A Rock Hermit waypoint has been found for the current system&quot;);
		var stns = system.stations;
		for (var i = 0; i &lt; stns.length; i++) {
			// is this a rockhermit?
			//log(this.name, &quot;station &quot; + stns[i].name);
			if (Ship.roleIsInCategory(stns[i].primaryRole, &quot;oolite-rockhermits&quot;) &amp;&amp; stns[i].hasRole(&quot;slaver_base&quot;) === false &amp;&amp; stns[i].hasRole(&quot;rrs_slaverbase&quot;) === false) {
				if (this._debug) log(this.name, &quot;A Rock Hermit has been found in the current system -- adding waypoint&quot;);
				// is the waypoint already set?
				if (!system.waypoints[this.name]) {
					system.setWaypoint(
						this.name, stns[i].position, stns[i].orientation, {
							size: 100,
							beaconCode: &quot;H&quot;,
							beaconLabel: &quot;Rock Hermit&quot;
						}
					);
					break;
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$doesStationHaveBlackMarket = function $doesStationHaveBlackMarket(station) {
	if (this.$isBlackMarketShutdown(station) === true) return false;
	var alleg = station.allegiance;
	if (alleg == null) alleg = &quot;neutral&quot;;
	if (((this._smugglingAllegiance.indexOf(alleg) &gt;= 0 || this.$isStationIncluded(station) === true) &amp;&amp; this.$isStationExcluded(station) === false) ||
		(station.isMainStation &amp;&amp; this.$mainStationHasBlackMarket() === true)) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// determines whether the black market will be visible in certain systems at the main station
this.$mainStationHasBlackMarket = function $mainStationHasBlackMarket() {
	// for tl 4 and below, at Anarchies, Feudals, Multi-Gov, Communists, Dictatorships, there&#39;s a 70% chance
	if (system.info.techlevel &lt;= 3 &amp;&amp; system.government &lt;= 4 &amp;&amp; system.pseudoRandomNumber &gt; 0.3) return true;
	// for tl 5/6, at Anarchies, Feudals, Multi-Gov, there&#39;s a 50% chance
	if (system.info.techlevel &gt;= 4 &amp;&amp; system.info.techlevel &lt;= 6 &amp;&amp; system.government &lt;= 2 &amp;&amp; system.pseudoRandomNumber &gt; 0.5) return true;
	// for tl 7+, at Anarchies only, have a reducing chance
	if (system.info.techlevel &gt; 6 &amp;&amp; system.government === 0 &amp;&amp; system.pseudoRandomNumber &gt; (system.info.techlevel / 10)) return true
	// otherwise false
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$governmentDescription = function $governmentDescription(gov) {
	switch (gov) {
		case 0:
			return &quot;Anarchy&quot;;
		case 1:
			return &quot;Feudal&quot;;
		case 2:
			return &quot;Multi-Government&quot;;
		case 3:
			return &quot;Dictatorship&quot;;
		case 4:
			return &quot;Communist&quot;;
		case 5:
			return &quot;Confederacy&quot;;
		case 6:
			return &quot;Democracy&quot;;
		case 7:
			return &quot;Corporate State&quot;;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$setupSting = function $setupSting(station) {

	this._stingStation = station;
	this._sting = true;

	// there&#39;s a chance that there&#39;ll be a police ship at the edge of scanner range at station where sting operation is in progress
	// if the player has never been to the black market, though, we need a clue other than the name of the agent. So we must include the ship in that case
	if (Math.random() &gt; this._stingShipChance || this.$playerHasBeenToBlackMarket(station) === false) {
		this.$addStingShip(station);
	}

	if (this._debug) {
		//log(this.name, &quot;Sting Operation In Progress at &quot; + this._stingStation.displayName);
		//if (this._stingShip) log(this.name, &quot;Added police ship clue&quot;);
		// flag the station so we can easily find it for testing
		if (!this._stingStation.beaconCode || this._stingStation.beaconCode === &quot;&quot;) {
			this._stingStation.beaconCode = &quot;S&quot;;
			this._stingStation.beaconLabel = &quot;Sting operation in progress&quot;;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// adds the sting ship to the station
this.$addStingShip = function $addStingShip(station) {
	if (!station || station.isValid === false) return;

	// reduce the chance we&#39;ll get another sting ship each time we get one.
	if (this._stingShipChance &lt; 0.9) this._stingShipChance += 0.1;

	// work out the position of the rh dock
	var dock = null;
	var dockpos = null;
	// find the dock object of the station so we can position launched ships
	for (var i = 0; i &lt; station.subEntities.length; i++) {
		if (station.subEntities[i].isDock) {
			dock = station.subEntities[i];
			dockpos = station.position.add( //better formula for non-centered docks
				Vector3D(
					station.heading.direction().multiply(dock.position.z),
					station.vectorUp.direction().multiply(dock.position.y),
					station.vectorRight.direction().multiply(dock.position.x)
				)
			);
			break;
		}
	}
	// move away from dock in straight line, but backwards, towards the edge of scanner range...
	var pos = dockpos.add(station.vectorForward.multiply(-(player.ship.scannerRange * 0.92)));

	// add a police ship at that position, but switch it to null AI so it will just sit there
	this._stingShip = system.addShips(&quot;police&quot;, 1, pos, 1000)[0];
	if (this._stingShip) {
		this._stingShip.switchAI(&quot;nullAI.plist&quot;);
		// set up the ship so if it&#39;s attacked it doesn&#39;t just sit there.
		// monkeypatch if necessary
		if (this._stingShip.script.shipBeingAttacked) this._stingShip.script.$sbm_ovr_shipBeingAttacked = this._stingShip.script.shipBeingAttacked;
		this._stingShip.script.shipBeingAttacked = this.$policeSting_shipBeingAttacked;
		if (this._stingShip.script.shipBeingAttackedByCloaked) this._stingShip.script.$sbm_ovr_shipBeingAttackedByCloaked = this._stingShip.script.shipBeingAttackedByCloaked;
		this._stingShip.script.shipBeingAttackedByCloaked = this.$policeSting_shipBeingAttackedByCloaked;

		this._stingShipTimer = new Timer(this, this.$checkForPlayerProximity, 5, 5);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$policeSting_shipBeingAttacked = function $policeSting_shipBeingAttacked(whom) {
	// run monkey patch, if required
	if (this.ship.script.$sbm_ovr_shipBeingAttacked) this.ship.script.$sbm_ovr_shipBeingAttacked(whom);
	// under attack, so revert to police AI
	var sbm = worldScripts.Smugglers_BlackMarket;
	sbm._stingShipTimer.stop();
	this.ship.switchAI(&quot;oolite-policeAI.js&quot;);
	this.ship.target = whom;
	// if the attacker is anyone but the player, then the sting is a bust
	if (whom.isPlayer === false) {
		sbm._stingStation = null;
		sbm._sting = false;
	}
	sbm._stingShip = null;
	sbm.$policeSting_removeMonkeyPatches(this.ship);
}

//-------------------------------------------------------------------------------------------------------------
this.$policeSting_shipBeingAttackedByCloaked = function $policeSting_shipBeingAttackedByCloaked() {
	// run monkey patch, if required
	if (this.ship.script.$sbm_ovr_shipBeingAttackedByCloaked) this.ship.script.$sbm_ovr_shipBeingAttackedByCloaked();
	// under attack, so revert to police AI
	var sbm = worldScripts.Smugglers_BlackMarket;
	sbm._stingShipTimer.stop();
	this.ship.switchAI(&quot;oolite-policeAI.js&quot;);
	sbm._stingStation = null;
	sbm._sting = false;
	sbm._stingShip = null;
	sbm.$policeSting_removeMonkeyPatches(this.ship);
}

//-------------------------------------------------------------------------------------------------------------
this.$policeSting_removeMonkeyPatches = function $policeSting_removeMonkeyPatches(ship) {
	// remove monkey patches
	if (!ship) return;
	delete ship.script.shipBeingAttacked;
	if (ship.script.$sbm_ovr_shipBeingAttacked) {
		ship.script.shipBeingAttacked = ship.script.$sbm_ovr_shipBeingAttacked;
		delete ship.script.$sbm_ovr_shipBeingAttacked;
	}
	delete ship.script.shipBeingAttackedByCloaked;
	if (ship.script.$sbm_ovr_shipBeingAttackedByCloaked) {
		ship.script.shipBeingAttackedByCloaked = ship.script.$sbm_ovr_shipBeingAttackedByCloaked;
		delete ship.script.$sbm_ovr_shipBeingAttackedByCloaked;
	}
}

//-------------------------------------------------------------------------------------------------------------
// timer deatination to check if the player has moved within 10km of sting ship
this.$checkForPlayerProximity = function $checkForPlayerProximity() {
	if (this._stingShip == null || this._stingShip.isValid === false || this._stingShip.isInSpace === false) {
		this._stingShipTimer.stop();
		return;
	}
	// if the player comes in range, switch back to police mode
	if (player.ship &amp;&amp; player.ship.isValid &amp;&amp; player.ship.isInSpace &amp;&amp; this._stingShip.position.distanceTo(player.ship) &lt; 10000) {
		this._stingShipTimer.stop();
		delete this._stingShip.script.shipBeingAttacked;
		this._stingShip.switchAI(&quot;oolite-policeAI.js&quot;);
		this._stingShip = null;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$playerHasBeenToBlackMarket = function $playerHasBeenToBlackMarket(station) {
	for (var i = 0; i &lt; this._blackMarketContacts.length; i++) {
		var contact = this._blackMarketContacts[i];
		if (contact.galaxy === galaxyNumber &amp;&amp; contact.systemID === system.ID &amp;&amp; contact.stationName === station.displayName) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$getBlackMarketContact = function $getBlackMarketContact(station) {
	// check if a sting is in progress at this station
	if (this._sting &amp;&amp; station === this._stingStation) return expandDescription(&quot;%N [nom]&quot;);
	// see if we already have a contact for this station
	var contactName = &quot;&quot;;
	for (var i = 0; i &lt; this._blackMarketContacts.length; i++) {
		var contact = this._blackMarketContacts[i];
		if (contact.galaxy === galaxyNumber &amp;&amp; contact.systemID === system.ID &amp;&amp; contact.stationName === station.displayName) {
			contactName = contact.name;
			break;
		}
	}
	if (contactName === &quot;&quot;) {
		contactName = expandDescription(&quot;%N [nom]&quot;);
		this._blackMarketContacts.push({
			galaxy: galaxyNumber,
			systemID: system.ID,
			stationName: station.displayName,
			name: contactName
		});
	}
	return contactName;
}

//-------------------------------------------------------------------------------------------------------------
this.$stingOperation = function $stingOperation() {
	var p = player.ship;
	this._newBounty = player.bounty + (parseInt(Math.random() * 10) + 20);
	this._blackMarketShutdown.push({
		galaxy: galaxyNumber,
		system: system.ID,
		stationName: p.dockedStation.displayName,
		date: clock.seconds
	});
	p.dockedStation.setInterface(this.name, null);
	this._noBribe = false;
	this.$runStingScreen();
	this._caughtDate = clock.seconds;
}

//-------------------------------------------------------------------------------------------------------------
this.$runStingScreen = function $runStingScreen() {
	var se = worldScripts.Smugglers_Equipment;

	if (player.credits &gt; 2000) {

		var pct = 0.1;
		for (var i = 0; i &lt; 4; i++) {
			if (player.credits * pct &lt; 100000) pct += 0.1;
		}
		this._newPenalty = Math.floor(player.credits * pct);
		if (this._newPenalty &gt; 100000) this._newPenalty = 100000;

		var curChoices = {};
		if (player.credits &gt; 0) {
			if (this._noBribe === false) {
				curChoices[&quot;03_BRIBE&quot;] = {
					text: &quot;[illegal-attempt-bribe]&quot;,
					color: se._menuColor
				};
			}
			curChoices[&quot;01_CREDIT_ACCEPT&quot;] = {
				text: &quot;[illegal-credits-accept-penalty]&quot;,
				color: se._menuColor
			};
		}
		curChoices[&quot;02_LEGAL_ACCEPT&quot;] = {
			text: &quot;[illegal-legal-accept-penalty]&quot;,
			color: se._menuColor
		};

		mission.runScreen({
			screenID: &quot;blackmarket-sting&quot;,
			title: &quot;GalCop Security&quot;,
			model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
			message: expandDescription(&quot;[blackmarket-sting]&quot;, {
				penalty: formatCredits(this._newPenalty, false, true)
			}),
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
			allowInterrupt: false,
			choices: curChoices,
			initialChoicesKey: &quot;01_CREDIT_ACCEPT&quot;
		}, this.$stingScreenHandler, this);

	} else {
		mission.runScreen({
			screenID: &quot;blackmarket-sting&quot;,
			title: &quot;GalCop Security&quot;,
			model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
			message: expandDescription(&quot;[blackmarket-sting-no-credits]&quot;),
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		}, this.$stingScreenHandler, this);

		player.ship.setBounty(this._newBounty, &quot;underworld activity&quot;);
		this.$sendStingNotificationEmail(&quot;legal&quot;);
		this._newBounty = 0;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$stingScreenHandler = function $stingScreenHandler(choice) {

	if (choice === &quot;03_BRIBE&quot;) {
		this.$getBribeAmount();
		return;
	}
	if (choice === &quot;01_CREDIT_ACCEPT&quot;) {
		player.credits -= this._newPenalty;
		this.$sendStingNotificationEmail(&quot;credits&quot;);
		this._newPenalty = 0;
		return;
	}
	if (choice === &quot;02_LEGAL_ACCEPT&quot;) {
		player.ship.setBounty(this._newBounty, &quot;underworld activity&quot;);
		this.$sendStingNotificationEmail(&quot;legal&quot;);
		this._newBounty = 0;
		return;
	}
	if (choice === &quot;01_RETURN&quot;) {
		this.$runStingScreen();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$isBlackMarketShutdown = function $isBlackMarketShutdown(station) {
	for (var i = 0; i &lt; this._blackMarketShutdown.length; i++) {
		var item = this._blackMarketShutdown[i];
		// 2592000 = 30 days in seconds
		if (item.galaxy === galaxyNumber &amp;&amp; item.systemID === system.ID &amp;&amp; item.stationName === station.displayName &amp;&amp; (clock.seconds - item.date) &lt; 2592000) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$setupStingAfterLoad = function $setupStingAfterLoad() {
	// configure the sting op from saved data
	var stnName = missionVariables.Smuggling_BlackMarketStingStation;
	var stns = system.stations;
	var found = false;
	for (var i = 0; i &lt; stns.length; i++) {
		if (stns[i].displayName === stnName) {
			this._stingStation = stns[i];
			found = true;
			break;
		}
	}
	if (found) {
		if (missionVariables.BlackMarketStingShip) this.$addStingShip(this._stingStation);
	} else {
		// couldn&#39;t find the same station, so turn off the sting
		this._sting = false;
	}

	delete missionVariables.Smuggling_BlackMarketSting;
	delete missionVariables.Smuggling_BlackMarketStingStation;
	delete missionVariables.Smuggling_BlackMarketStingShip;
}

//-------------------------------------------------------------------------------------------------------------
// calculates a number between 0.2 and 1.7 (approx) 
this.$setupSystemFactor = function $setupSystemFactor() {
	// low tech, anarchic, low economy worlds will pay a premium, hitech worlds not so much
	var eco = system.economy; // 0 to 7 (7 = poor ag)
	var tl = 15 - system.techLevel; // 0 to 14; we&#39;re inverting this so that low tech worlds are rated higher
	var gov = (8 - system.government) * 2; // 0 - 7 (0 = anarchic) we&#39;re inverting this so that anarchic worlds are rated higher. we&#39;re also giving more weight to this number

	// convert this numbers into a factor with a random element as well
	var factor = ((eco + tl + gov) / 21) * (system.scrambledPseudoRandomNumber(clock.days) * 0.4) + 0.5;;
	if (factor &lt; 0.2) factor = 0.2

	this._systemFactor = factor;
}

//-------------------------------------------------------------------------------------------------------------
this.$sellItemCallback = function $sellItemCallback(key) {
	if (player.ship.equipmentStatus(key) === &quot;EQUIPMENT_OK&quot;) player.ship.removeEquipment(key);
}

//-------------------------------------------------------------------------------------------------------------
this.$addCoreEquipmentToBlackMarket = function $addCoreEquipmentToBlackMarket() {
	// make sure the list is clear for this worldscript
	this.$removeWorldScriptItems(&quot;Smugglers_BlackMarket&quot;);
	// add some rare equipment to the sale item list, if they&#39;re still functioning anyway - can&#39;t sell damaged equipment!
	if (player.ship.equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;) === &quot;EQUIPMENT_OK&quot;) {
		var item = EquipmentInfo.infoForKey(&quot;EQ_CLOAKING_DEVICE&quot;);
		this.$addSaleItem({
			key: &quot;EQ_CLOAKING_DEVICE&quot;,
			text: item.name,
			cost: parseInt(item.price / 10),
			worldScript: &quot;Smugglers_BlackMarket&quot;,
			sellCallback: &quot;$sellItemCallback&quot;
		});
	}
	var eq = player.ship.equipment;
	for (var i = 0; i &lt; eq.length; i++) {
		if (eq[i].equipmentKey.indexOf(&quot;NAVAL&quot;) &gt;= 0 || eq[i].equipmentKey.indexOf(&quot;MILITARY&quot;) &gt;= 0) {
			var item = EquipmentInfo.infoForKey(eq[i].equipmentKey);
			this.$addSaleItem({
				key: eq[i].equipmentKey,
				text: item.name,
				cost: parseInt(item.price / 10),
				worldScript: &quot;Smugglers_BlackMarket&quot;,
				sellCallback: &quot;$sellItemCallback&quot;
			});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for a new phase
this.$getBribeAmount = function $getBribeAmount() {
	var text = &quot;&quot;;
	var sdm = worldScripts.Smugglers_DockMaster;
	var inttype = Math.floor((sdm._bribeChance[system.ID] * 4) + 1);
	var inttypedesc = expandDescription(&quot;[interest-type&quot; + inttype + &quot;]&quot;);
	text = expandDescription(&quot;[dockmaster-question]&quot;, {
			interesttype: inttypedesc
		}) + &quot;\n\n&quot; +
		&quot;(&quot; + expandDescription(&quot;[dockmaster-cost]&quot;, {
			credits: formatCredits(player.credits, false, true)
		}) + &quot;)&quot;;

	var opts = {
		screenID: &quot;smuggling_sting_bribe&quot;,
		title: &quot;Bribing Official&quot;,
		allowInterrupt: false,
		model: &quot;[&quot; + worldScripts.Smugglers_Equipment._policeModel + &quot;]&quot;,
		exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
		message: text,
		textEntry: true
	};
	mission.runScreen(opts, this.$getBribeAmountInput, this);
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getBribeAmount screen
this.$getBribeAmountInput = function $getBribeAmountInput(param) {

	var sdm = worldScripts.Smugglers_DockMaster;
	var se = worldScripts.Smugglers_Equipment;
	var p = player.ship;

	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= player.credits) {
		var amount = parseInt(param);
		// will this work
		var chance = sdm._bribeChance[system.ID];
		// higher amounts are more likely to be accepted
		if (this._debug) log(this.name, &quot;min bribe amount = &quot; + (Math.pow(parseInt(chance * 50), 2.5) * (1 + system.productivity / 56300)));
		if ((Math.pow(parseInt(chance * 50), 2.5) * (1 + system.productivity / 56300)) &lt;= amount) {
			player.credits -= amount;
			mission.runScreen({
				screenID: &quot;sting_bribe&quot;,
				title: &quot;Bribing Official&quot;,
				model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
				message: expandDescription(&quot;[dockmaster-complete]&quot;),
				exitScreen: &quot;GUI_SCREEN_STATUS&quot;
			});
		} else {
			// a failed bribe will result in the legal penalty being applied
			p.setBounty(this._newBounty, &quot;underworld activity&quot;);
			this.$sendStingNotificationEmail(&quot;legal&quot;);
			this._newBounty = 0;

			if (Math.random() &gt; chance) {
				mission.runScreen({
					screenID: &quot;sting_bribe&quot;,
					title: &quot;Bribing Official&quot;,
					model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
					message: expandDescription(&quot;[dockmaster-angry-nopenalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_STATUS&quot;
				});
			} else {
				var penalty = (worldScripts.Smugglers_CoreFunctions.$rand(10) + 3);
				p.setBounty(player.bounty + penalty, &quot;attempted bribe&quot;);
				mission.runScreen({
					screenID: &quot;sting_bribe&quot;,
					title: &quot;Bribing Official&quot;,
					model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
					message: expandDescription(&quot;[dockmaster-angry-penalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_STATUS&quot;
				});

				// send email (if installed)
				var email = worldScripts.EmailSystem;
				if (email) {
					var ga = worldScripts.GalCopAdminServices;
					email.$createEmail({
						sender: &quot;GalCop Customs&quot;,
						subject: &quot;Attempt to bribe official&quot;,
						date: clock.seconds,
						message: expandDescription(&quot;[smugglers-failed-bribe-email]&quot;, {
							legal_penalty: penalty,
							stationname: player.ship.dockedStation.displayName,
							systemname: System.systemNameForID(system.ID)
						}),
						expiryDays: ga._defaultExpiryDays
					});
				}
			}
		}
	} else {
		this._noBribe = true;
		mission.runScreen({
			screenID: &quot;smuggling_bribe&quot;,
			title: &quot;Bribing Official&quot;,
			model: &quot;[&quot; + se._policeModel + &quot;]&quot;,
			message: expandDescription(&quot;[blackmarket-sting-skipbribe]&quot;),
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
			choices: {
				&quot;01_RETURN&quot;: {
					text: &quot;Press Enter to Continue&quot;
				}
			},
		}, this.$stingScreenHandler, this);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$sendStingNotificationEmail = function $sendStingNotificationEmail(type) {
	// send email (if installed)
	var email = worldScripts.EmailSystem;
	if (email) {
		var ga = worldScripts.GalCopAdminServices;
		email.$createEmail({
			sender: &quot;GalCop Customs&quot;,
			subject: &quot;Illegal Activities&quot;,
			date: clock.seconds,
			message: expandDescription(&quot;[blackmarket-sting-email-&quot; + type + &quot;]&quot;, {
				legal_penalty: this.newBounty,
				credit_penalty: formatCredits(this._newPenalty, false, true),
				date: clock.clockStringForTime(this._caughtDate),
				stationname: player.ship.dockedStation.displayName,
				systemname: System.systemNameForID(system.ID)
			}),
			expiryDays: ga._defaultExpiryDays
		});
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_Conditions&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2015 phkb&quot;;
this.description = &quot;Condition script for determining when to include smuggling equipment (compartment, scanner, tech version upgrade)&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this._debug = false;

// station roles to be excludes
this._excludeRoles = [&quot;rescue_station&quot;];

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function (equipment, ship, context) {
	if (context === &quot;scripted&quot;) return true;
	if (context === &quot;npc&quot;) return false;

	if (equipment === &quot;EQ_SMUGGLING_COMP_STORAGE&quot;) return false;

	var result = true;

	var se = worldScripts.Smugglers_Equipment;
	var existing = se.$getSmugglingCompartmentEquipment();

	var alleg = ship.dockedStation.allegiance;
	if (alleg == null) alleg = &quot;neutral&quot;;

	// is this station likely to have the equipment?
	if (context === &quot;purchase&quot; &amp;&amp; ship &amp;&amp; ship.dockedStation &amp;&amp; this._debug === false) {
		if (se._equipmentList.indexOf(equipment) &gt;= 0 &amp;&amp; (existing === &quot;&quot; || player.ship.equipmentStatus(existing) === &quot;EQUIPMENT_OK&quot;)) result = false;
		if (se._smugglingAllegiance.indexOf(alleg) === -1 || this._excludeRoles.indexOf(ship.dockedStation.primaryRole) != -1) result = false;
		if (result === false) {
			return result;
		}
	}

	// version 1.83 and above fix the issue with repair to items that take cargo space
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		if (player.ship.equipmentStatus(equipment) === &quot;EQUIPMENT_DAMAGED&quot; &amp;&amp; system.info.techlevel &gt;= 2) {
			return true;
		}
	}

	if (equipment.indexOf(&quot;COMPARTMENT_REPAIR&quot;) &gt;= 0 &amp;&amp; oolite.compareVersion(&quot;1.83&quot;) &gt; 0) {
		if (system.info.techlevel &lt; 2) result = false;
		if (se.$isCompartmentDamaged() === false) result = false;
	}

	switch (equipment) {
		case &quot;EQ_SMUGGLING_COMPARTMENT&quot;:
			// not available if there&#39;s no cargo space at all
			if (ship.cargoSpaceCapacity === 0) result = false;
			if (system.info.techlevel &lt; 3) result = false;
			if (se.$hasSmugglingCompartment() === true &amp;&amp; se.$isCompartmentDamaged() === true &amp;&amp; oolite.compareVersion(&quot;1.83&quot;) &gt; 0) result = false;
			// we should always be able to adjust the tonnage, even if the only way is down.
			break;
		case &quot;EQ_PHASE_SCANNER&quot;:
			var tl = 7;
			if (ship.equipmentStatus(equipment) === &quot;EQUIPMENT_DAMAGED&quot;) tl = 6;
			if (system.government != 0) result = false;
			if (system.info.techlevel &lt; tl) result = false;
			if (se._phaseScannerAvailable === false) result = false;
			break;
		case &quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;:
			if (system.info.techlevel &lt; 6) result = false;
			break;
		case &quot;EQ_SMUGGLING_VERSION_UPGRADE&quot;:
			// higher techlevel systems will get the upgrade sooner
			if (system.info.techlevel &lt; 4) result = false;
			if (se._sc_Days &lt; (30 * ((30 - system.info.techlevel) / 30))) result = false;
			break;
		default:
			// is this item damaged?
			if (ship.equipmentStatus(equipment) === &quot;EQUIPMENT_DAMAGED&quot;) {
				// return true so that the &quot;Repair&quot; items are displayed.
				result = true;
			} else {
				result = false;
			}
	}
	return result;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_contracts.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_Contracts&quot;;
this.author = &quot;phkb and cim&quot;;
this.description = &quot;Adds smuggling contracts via an interface screen, with code borrowed heavily from the cargo contracts system, authored by cim.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this._disabled = false;

/*
Note: The smuggling contract system is independant of the standard cargo contract system. The reason for this is that
smuggled cargo might exist in a number of different places (smuggling compartment, or hidden under a manifest relabel)
This means the normal cargo contract system cannot pick up the presence of hidden cargo.

The end result is that a lot of the standard cargo contract core code has been reproduced here as JS.

TODO: add &quot;Negotiate&quot; option to haggle for the fee
*/

//=============================================================================================================
/**** Configuration options and API ****/

/* OXPs which wish to add a background to the summary pages should
   set this value */
this._smugglingSummaryPageBackground = &quot;&quot;;
/* OXPs which wish to add an overlay to the parcel mission screens
   should set this value */
this._smugglingPageOverlay = &quot;&quot;;
this._smugglingPageOverlayHeight = 0;

this._suspendedDestination = null;
this._suspendedHUD = false;
this._smugglingContracts = [];
this._smugglingRepGood = 0;
this._smugglingRepBad = 0;
this._smugglingRepUnknown = 0;
this._maxRep = 70;
this._checkForCargo = false;
this._marketrnd = 0;

//=============================================================================================================
/* this.$addSmugglingContractToSystem(cargo)
 * This function adds the defined smuggling contract to the black market contract list.
 * A contract definition is an object with the following parameters, all required:
 *
 * destination: system ID of destination system
 * commodity:   the cargo type
 * size:        the number of units of cargo
 * deadline:    the deadline for delivery, in clock seconds
 * payment:     the payment for delivery on time, in credits
 *
 * and optionally, the following parameters:
 *
 * deposit:     the deposit payment required by the player (default 0)
 * route:       a route object generated with system.info.routeToSystem
 *              describing the route between the source and destination
 *              systems.
 *
 * If this is not specified, it will be generated automatically.
 *
 * The function will return true if the contract can be added, false
 * otherwise.
 */
this.$addSmugglingContractToSystem = function $addSmugglingContractToSystem(cargo) {
	if (cargo.destination &lt; 0 || cargo.destination &gt; 255) {
		log(this.name, &quot;Rejected contract: destination missing or invalid&quot;);
		return false;
	}
	if (cargo.deadline &lt;= clock.adjustedSeconds) {
		log(this.name, &quot;Rejected contract: deadline invalid&quot;);
		return false;
	}
	if (cargo.payment &lt; 0) {
		log(this.name, &quot;Rejected contract: payment invalid&quot;);
		return false;
	}
	if (!cargo.size || cargo.size &lt; 1) {
		log(this.name, &quot;Rejected contract: size invalid&quot;);
		return false;
	}
	if (!cargo.commodity) {
		log(this.name, &quot;Rejected contract: commodity unspecified&quot;);
		return false;
	}
	if (!system.mainStation.market[cargo.commodity]) {
		log(this.name, &quot;Rejected contract: commodity invalid&quot;);
		return false;
	}
	if (!cargo.route) {
		var destinationInfo = System.infoForSystem(galaxyNumber, cargo.destination);
		cargo.route = system.info.routeToSystem(destinationInfo);
		if (!cargo.route) {
			log(this.name, &quot;Rejected contract: route invalid&quot;);
			return false;
		}
	}
	if (!cargo.deposit) {
		cargo.deposit = 0;
	} else if (cargo.deposit &gt;= cargo.payment) {
		log(this.name, &quot;Rejected contract: deposit higher than total payment&quot;);
		return false;
	}

	this._contracts.push(cargo);
	return true;
}

//=============================================================================================================
/* Event handlers */

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	if (this._disabled === true) {
		delete this.shipExitedWitchspace;
		delete this.playerWillSaveGame;
		delete this.shipWillLaunchFromStation;
		delete this.guiScreenWillChange;
		delete this.guiScreenChanged;
		delete this.startUp;
		return;
	}

	this._helper = worldScripts[&quot;oolite-contracts-helpers&quot;];
	var core = worldScripts.Smugglers_CoreFunctions;
	this.$padTextRight = core.$padTextRight;
	this.$padTextLeft = core.$padTextLeft;
	this.$isBigGuiActive = core.$isBigGuiActive;
	this.$rand = core.$rand;

	if (missionVariables.Smuggling_MarketRnd) this._marketrnd = missionVariables.Smuggling_MarketRnd;
	if (missionVariables.Smuggling_RepGood) {
		this._smugglingRepGood = missionVariables.Smuggling_RepGood;
		this._smugglingRepBad = missionVariables.Smuggling_RepBad;
		this._smugglingRepUnknown = missionVariables.Smuggling_RepUnknown;
	}
	this.$normaliseSmugglingReputation();

	if (missionVariables.Smuggling_ActiveContracts) {
		this._smugglingContracts = JSON.parse(missionVariables.Smuggling_ActiveContracts);
	}
	// stored contents of systems&#39;s cargo contract list
	if (missionVariables.Smuggling_Contracts) {
		this._contracts = JSON.parse(missionVariables.Smuggling_Contracts);
	} else {
		this.$initialiseSmugglingContractsForSystem();
	}

	// its unclear whether this or ContractsOnBB will get to it&#39;s startUpComplete first, so we&#39;ll force the issue here
	if (worldScripts.ContractsOnBB) {
		worldScripts.ContractsOnBB.$convertSmugglingContracts();
	}

	var xui = worldScripts.XenonUI;
	if (xui) xui.$addMissionScreenException(&quot;oolite-smuggling-contracts-details&quot;); // smuggling-contracts-details
	var xrui = worldScripts.XenonReduxUI;
	if (xrui) xrui.$addMissionScreenException(&quot;oolite-smuggling-contracts-details&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	if (!system.isInterstellarSpace &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.stations.length &gt; 1) {
		// must be a regular system with at least one station other than the main one
		this._marketrnd = this.$rand(256) - 1;
		this.$erodeSmugglingReputation();
		this.$initialiseSmugglingContractsForSystem();
		this.$adjustMarket();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	// encode the contract list to a string for storage in the savegame
	missionVariables.Smuggling_Contracts = JSON.stringify(this._contracts);
	missionVariables.Smuggling_RepGood = this._smugglingRepGood;
	missionVariables.Smuggling_RepBad = this._smugglingRepBad;
	missionVariables.Smuggling_RepUnknown = this._smugglingRepUnknown;
	missionVariables.Smuggling_ActiveContracts = JSON.stringify(this._smugglingContracts);
	missionVariables.Smuggling_MarketRnd = this._marketrnd;
}

//-------------------------------------------------------------------------------------------------------------
// when the player exits the mission screens, reset their destination
// system and HUD settings, which the mission screens may have
// affected.
this.shipWillLaunchFromStation = function () {
	this.$resetViews();
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	if (player.ship.dockedStation.allegiance === &quot;galcop&quot;) this._checkForCargo = true;
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
	if (this._checkForCargo === true) {
		this._checkForCargo = false;
		this.$checkForCompletedContracts();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenWillChange = function (to, from) {
	this.$resetViews();
	if (to === &quot;GUI_SCREEN_MANIFEST&quot;) this.$updateManifest();
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function (to, from) {
	if (to != &quot;GUI_SCREEN_MISSION&quot;) this.$resetViews();
}

//=============================================================================================================
/* Interface functions */

//-------------------------------------------------------------------------------------------------------------
// runs through all smuggling contracts looking for any completed ones
this.$checkForCompletedContracts = function $checkForCompletedContracts() {

	if (this._smugglingContracts.length === 0) return;

	var sc = worldScripts.Smugglers_Equipment;
	var sdm = worldScripts.Smugglers_DockMaster;
	var p = player.ship;

	var list = [];

	for (var i = this._smugglingContracts.length - 1; i &gt;= 0; i--) {
		var m = this._smugglingContracts[i];
		var errorCode = &quot;&quot;;
		var new_payment = 0;
		var percent_delivered = 0;

		// are we in the right system
		if (m.destination === system.ID &amp;&amp; m.destinationName === system.name) {
			if (clock.adjustedSeconds &lt;= m.deadline) {
				var onhand = 0;

				onhand += sdm.$getTotalUnlabelled(m.commodity); // add any cargo currently hiding under a relabel
				onhand += p.manifest[m.commodity]; // add any visible cargo in the hold
				onhand -= sdm.$getTotalRelabelled(m.commodity); // take away any cargo that might be masked by a label (ie. cargo that looks like the commodity but really isn&#39;t)
				onhand += sc.$getCargoQuantity(m.commodity); // add any cargo in the smuggling compartment
				onhand += sc.$checkHyperCargo(m.commodity); // add any cargo in hyper cargo

				if (onhand &gt;= m.size) {
					errorCode = &quot;success&quot;;
					player.credits += m.fee;
					this.$removeCargo(m.commodity, m.size);
					player.setPlayerRole(&quot;trader-smuggler&quot;);
				} else {
					percent_delivered = 100.0 * (onhand / m.size);
					var acceptable_ratio = 100.0 - 10.0 * system.ID / 256; // down to 90%
					if (percent_delivered &gt;= acceptable_ratio) {
						var shortfall = 100 - percent_delivered;
						new_payment = percent_delivered * (m.fee) / 100.0;
						player.credits += new_payment;
						errorCode = &quot;short&quot;;
						this.$removeCargo(m.commodity, m.size);
						player.setPlayerRole(&quot;trader-smuggler&quot;);
					} else {
						errorCode = &quot;refused_short&quot;;
					}
				}
			} else {
				errorCode = &quot;late&quot;;
			}
		} else {
			if (clock.adjustedSeconds &gt; m.deadline) {
				errorCode = &quot;failed&quot;;
			}
		}

		var desc = &quot;&quot;;
		// adjust the fee and reputation based on the result
		switch (errorCode) {
			case &quot;success&quot;:
				// build a contact
				var contactHome = this.$rand(256) - 1;
				var contact = &quot;a &quot; + System.infoForSystem(galaxyNumber, contactHome).inhabitant.toLowerCase() + &quot; from &quot; + System.systemNameForID(contactHome);
				desc = expandDescription(&quot;[smuggled-cargo-delivered-okay]&quot;, {
					cargo: this.$descriptionForGoods(m),
					fee: formatCredits(m.fee, true, true),
					contactdesc: contact
				});
				this.$increaseSmugglingReputation(10);
				this.$contractCompletedEmail(errorCode, m.fee, m);
				if (this.$anyContractsLeftForSystem(i, m.destination) === false)
					mission.unmarkSystem({
						system: m.destination,
						name: &quot;smuggling_contract_&quot; + m.destination
					});
				break;
			case &quot;late&quot;:
				desc = expandDescription(&quot;[smuggled-cargo-delivered-late]&quot;, {
					cargo: this.$descriptionForGoods(m)
				});
				this.$decreaseSmugglingReputation(10);
				this.$contractCompletedEmail(errorCode, 0, m);
				if (this.$anyContractsLeftForSystem(i, m.destination) === false)
					mission.unmarkSystem({
						system: m.destination,
						name: &quot;smuggling_contract_&quot; + m.destination
					});
				break;
			case &quot;failed&quot;:
				desc = expandDescription(&quot;[smuggled-cargo-failed]&quot;, {
					cargo: this.$descriptionForGoods(m)
				});
				this.$decreaseSmugglingReputation(10);
				this.$contractCompletedEmail(errorCode, 0, m);
				if (this.$anyContractsLeftForSystem(i, m.destination) === false)
					mission.unmarkSystem({
						system: m.destination,
						name: &quot;smuggling_contract_&quot; + m.destination
					});
				break;
			case &quot;short&quot;:
				desc = expandDescription(&quot;[smuggled-cargo-short]&quot;, {
					cargo: this.$descriptionForGoods(m),
					fee: formatCredits(new_payment, true, true),
					percent: percent_delivered
				});
				this.$contractCompletedEmail(errorCode, new_payment, m);
				if (this.$anyContractsLeftForSystem(i, m.destination) === false)
					mission.unmarkSystem({
						system: m.destination,
						name: &quot;smuggling_contract_&quot; + m.destination
					});
				break;
			case &quot;refused_short&quot;:
				desc = expandDescription(&quot;[smuggled-cargo-refused-short]&quot;, {
					cargo: this.$descriptionForGoods(m)
				});
				// reset the error so we can skip this one - the player still has time to complete the contract
				errorCode = &quot;&quot;;
				break;
		}
		if (desc != &quot;&quot;) list.push(desc);

		// if we got to this point with a result of some kind, remove the contract
		if (errorCode != &quot;&quot;) {
			if (worldScripts.ContractsOnBB) {
				worldScripts.ContractsOnBB.$removeSmugglingContract(i);
			}
			this._smugglingContracts.splice(i, 1);
		}
	}

	if (list.length &gt; 0) {
		// add all contract summary items to the arrival report
		var text = &quot;&quot;;
		for (var i = 0; i &lt; list.length; i++) {
			text += list[i] + &quot;\n\n&quot;;
		}
		mission.runScreen({
			title: &quot;Smuggling Contracts&quot;,
			message: text,
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// removes a specific amount of the commodity, from various locations in this order:
// 1. relabelled commodities, 2. standard hold, 3. smuggling compartmnt, 4. hypercargo
// returns quantity not found (should be zero in most circumstances)
this.$removeCargo = function $removeCargo(commodity, amount) {

	var se = worldScripts.Smugglers_Equipment;
	var sdm = worldScripts.Smugglers_DockMaster;
	var p = player.ship;
	var sum = amount;

	// is there any relabelled cargo?
	if (sdm.$getTotalRelabelled(commodity) &gt; 0) {
		// unlabel the cargo so the next bit will pick it up
		var relbl_remain = sdm.$removeRealCargoQuantity(commodity, sum);
	}

	// do we have the cargo anywhere? check normal hold
	if (p.manifest[commodity] &gt;= sum) {
		p.manifest[commodity] -= sum;
		sum = 0;
	} else if (p.manifest[commodity] &gt; 0) {
		sum -= p.manifest[commodity];
		p.manifest[commodity] = 0;
	}
	// smuggling compartment
	if (sum &gt; 0 &amp;&amp; se.$getCargoQuantity(commodity) &gt; 0) {
		var remain = se.$removeCargo(commodity, sum);
		sum = remain;
	}
	// and hypercargo
	if (sum &gt; 0 &amp;&amp; se.$checkHyperCargo(commodity) &gt; 0) {
		var remain = se.$removeHyperCargo(commodity, sum);
		sum = remain;
	}

	return sum;
}

//-------------------------------------------------------------------------------------------------------------
// resets HUD and jump destination
this.$resetViews = function $resetViews() {
	if (this._suspendedHUD !== false) {
		player.ship.hudHidden = false;
		this._suspendedHUD = false;
	}
	if (this._suspendedDestination !== null) {
		player.ship.targetSystem = this._suspendedDestination;
		this._suspendedDestination = null;
	}
}

//-------------------------------------------------------------------------------------------------------------
// initialise a new smuggling contract list for the current system
this.$initialiseSmugglingContractsForSystem = function $initialiseSmugglingContractsForSystem() {
	// clear list
	this._contracts = [];

	var checklist = [];

	var si = worldScripts.Smugglers_Illegal;
	var destlist = [];

	if (si._illegalGoods.length &gt; 0) {
		for (var i = 0; i &lt; si._illegalGoods.length; i++) {
			if (destlist.indexOf(si._illegalGoods[i].systemID) === -1)
				destlist.push(si._illegalGoods[i].systemID);
		}
	} else {
		// no illegal goods defined - shouldn&#39;t happen, but just in case
		return;
	}

	var numContracts = Math.floor(5 * Math.random() + 5 * Math.random() + 5 * Math.random() + (this.$getSmugglingReputationPrecise() * Math.random()));
	if (this.$getSmugglingReputationPrecise() &gt;= 0 &amp;&amp; numContracts &lt; 5) {
		numContracts += 5;
	}
	if (numContracts &gt; 16) {
		numContracts = 16;
	} else if (numContracts &lt; 0) {
		numContracts = 0;
	}

	var sourceInfo = System.infoForSystem(galaxyNumber, system.ID);
	var defaultCount = 0;

	for (var i = 0; i &lt; numContracts; i++) {
		var cargo = new Object;

		// pick a random system to take the goods to
		var destination = destlist[this.$rand(destlist.length) - 1];

		// discard if chose the current system
		if (destination === system.ID) continue;
		if (typeof destination === &quot;undefined&quot;) continue;

		// get the SystemInfo object for the destination
		var destinationInfo = System.infoForSystem(galaxyNumber, destination);

		if (destinationInfo.sun_gone_nova) continue;

		var daysUntilDeparture = 1 + (Math.random() * (7 + this.$getSmugglingReputationPrecise() - destinationInfo.government));
		if (daysUntilDeparture &lt;= 0) {
			// loses some more contracts if reputation negative
			continue;
		}

		var commodities = si.$illegalGoodsListCommodityOnly(destination, true);

		var attempts = 0;
		do {
			var remotePrice = 0;
			attempts++;
			var commodity = commodities[Math.floor(Math.random() * commodities.length)];

			// sub-tc contracts only available for top rep
			if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] != 0 &amp;&amp; this.$getSmugglingReputationPrecise() &lt; 6.5) {

			} else {
				remotePrice = this.$priceForCommodity(commodity, destinationInfo);
			}
			//log(this.name, &quot;contract &quot; + i + &quot;--attempt &quot; + attempts + &quot;: &quot; + commodity + &quot; remoteprice = &quot; + remotePrice + &quot;, sourcepriceadj = &quot; + system.mainStation.market[commodity].price / 20);
		} while (remotePrice &lt; system.mainStation.market[commodity].price / 20 &amp;&amp; attempts &lt; 10);
		// failed to find a good one.
		if (attempts === 10) continue;

		// don&#39;t overload the player with all the same type of contracts
		var checkcount = 0;
		for (var j = 0; j &lt; checklist.length; j++) {
			if (checklist[j] === commodity) checkcount += 1;
		}
		if (checkcount &gt;= 3) continue;

		cargo.commodity = commodity;

		var amount = 0;
		// larger unit sizes for kg/g commodities
		switch (parseInt(system.mainStation.market[commodity][&quot;quantity_unit&quot;])) {
			case 1:
				amount = this.$rand(20) + 10;
				break;
			case 2:
				amount = this.$rand(40) + 20;
				break;
			case 0:
				amount = this.$rand(10);
				if (amount &gt; 5 &amp;&amp; Math.random() &gt; 0.5) amount += (this.$rand(5) - 3);
				break;
		}
		cargo.size = amount;

		// adjustment to prices based on quantity (larger = more profitable)
		var discount = Math.min(10 + Math.floor(amount / 10), 35);
		var unitPrice = system.mainStation.market[commodity].price * (100 - discount) / 1000;
		var localValue = Math.floor(unitPrice * amount);
		remotePrice = remotePrice * (200 + discount) / 200;
		var remoteValue = Math.floor(remotePrice * amount);
		var profit = remoteValue - localValue;

		// skip if unprofitable
		if (profit &lt;= 100) continue;

		// check that a route to the destination exists
		// route calculation is expensive so leave this check to last
		var routeToDestination = system.info.routeToSystem(destinationInfo);

		// if the system cannot be reached, ignore this contract
		if (!routeToDestination) continue;

		// we now have a valid destination, so generate the rest of
		// the parcel details
		cargo.destination = destination;
		// we&#39;ll need this again later, and route calculation is slow
		cargo.route = routeToDestination;

		// higher share for transporter for longer routes, less safe systems
		var share = 100 + destinationInfo.government - (10 * routeToDestination.route.length);
		if (share &lt; 10) share = 10;
		share = 100 - share;

		// safety: now multiply the fee by 2 compared with 1.76 contracts
		// prevents exploit discovered by Mad Hollander at
		// http://aegidian.org/bb/viewtopic.php?p=188127
		localValue *= 2;
		// this may need to be raised further

		// absolute value of profit remains the same
		var fee = (localValue + Math.floor(profit * (share / 100))) * 2;

		fee -= fee % 20; // round to nearest 20 credits;

		cargo.payment = fee;
		cargo.deposit = localValue - (localValue % 20);
		// rare but not impossible; last safety check
		if (cargo.deposit &gt;= cargo.payment) continue;

		// time allowed for delivery is time taken by &quot;fewest jumps&quot;
		// route, plus timer above. Higher reputation makes longer
		// times available.
		cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture * 86400) + (cargo.route.time * 3600);

		// make sure the illegal good will be illegal when the player arrives, based on the route time
		var def = si.$illegalGoodsDefinition(destination, commodity);
		if (def &amp;&amp; def.end &lt; cargo.deadline) continue;

		// add it to the check list so we can make sure we don&#39;t offer too many of the same type of contract
		checklist.push(commodity);

		// add parcel to contract list
		this.$addSmugglingContractToSystem(cargo);
	}
}

//-------------------------------------------------------------------------------------------------------------
// if the interface is activated, this function is run.
this.$smugglingContractsScreens = function $smugglingContractsScreens(interfaceKey) {
	// the interfaceKey parameter is not used here, but would be useful if
	// this callback managed more than one interface entry

	this.$validateSmugglingContracts();

	// set up variables used to remember state on the mission screens
	this._suspendedDestination = null;
	this._suspendedHUD = false;
	this._contractIndex = 0;
	this._routeMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
	this._lastOptionChosen = &quot;06_EXIT&quot;;

	// start on the summary page if more than one contract is available
	var summary = (this._contracts.length &gt; 1);

	this.$smugglingContractsDisplay(summary);
}


//-------------------------------------------------------------------------------------------------------------
// this function is called after the player makes a choice which keeps
// them in the system, and also on initial entry to the system
// to select the appropriate mission screen and display it
this.$smugglingContractsDisplay = function $smugglingContractsDisplay(summary) {

	// Again. Has to be done on every call to this function, but also
	// has to be done at the start.
	this.$validateSmugglingContracts();

	// if there are no contracts (usually because the player has taken
	// the last one) display a message and quit.
	if (this._contracts.length === 0) {
		var missionConfig = {
			titleKey: &quot;smuggling-contracts-none-available-title&quot;,
			messageKey: &quot;smuggling-contracts-none-available-message&quot;,
			allowInterrupt: true,
			screenID: &quot;oolite-smuggling-contracts-none&quot;,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
		};
		if (this._smugglingSummaryPageBackground != &quot;&quot;) {
			missionConfig.background = this._smugglingSummaryPageBackground;
		}
		if (this._smugglingPageOverlay != &quot;&quot;) {
			if (this._smugglingPageOverlayHeight != 0) {
				missionConfig.overlay = {
					name: this._smugglingPageOverlay,
					height: this._smugglingPageOverlayHeight
				};
			} else {
				missionConfig.overlay = this._smugglingPageOverlay;
			}
		}
		mission.runScreen(missionConfig);
		// no callback, just exits contracts system
		return;
	}

	// make sure that the &#39;currently selected contract&#39; pointer
	// is in bounds
	if (this._contractIndex &gt;= this._contracts.length) {
		this._contractIndex = 0;
	} else if (this._contractIndex &lt; 0) {
		this._contractIndex = this._contracts.length - 1;
	}
	// sub functions display either summary or detail screens
	if (summary) {
		this.$smugglingContractSummaryPage();
	} else {
		this.$smugglingContractSinglePage();
	}

}

//-------------------------------------------------------------------------------------------------------------
// display the mission screen for the summary page
this.$smugglingContractSummaryPage = function $smugglingContractSummaryPage() {
	var playerrep = this._helper._playerSkill(this.$getSmugglingReputationPrecise());
	// column &#39;tab stops&#39;
	var columns = [9, 15, 21, 26];
	var anyWithSpace = false;

	// column header line
	var headline = expandMissionText(&quot;smuggling-contracts-column-goods&quot;);
	// pad to correct length to give a table-like layout
	headline += this._helper._paddingText(headline, columns[0]);
	headline += expandMissionText(&quot;smuggling-contracts-column-destination&quot;);
	headline += this._helper._paddingText(headline, columns[1]);
	headline += expandMissionText(&quot;smuggling-contracts-column-within&quot;);
	headline += this._helper._paddingText(headline, columns[2]);
	headline += expandMissionText(&quot;smuggling-contracts-column-deposit&quot;);
	headline += this._helper._paddingText(headline, columns[3]);
	headline += expandMissionText(&quot;smuggling-contracts-column-fee&quot;);
	// required because of way choices are displayed.
	headline = &quot; &quot; + headline;

	// setting options dynamically; one contract per line
	var options = new Object;
	var i;
	for (i = 0; i &lt; this._contracts.length; i++) {
		// temp variable to simplify following code
		var cargo = this._contracts[i];
		// write the description, padded to line up with the headers
		var optionText = this.$descriptionForGoods(cargo);
		optionText += this._helper._paddingText(optionText, columns[0]);
		optionText += System.infoForSystem(galaxyNumber, cargo.destination).name;
		optionText += this._helper._paddingText(optionText, columns[1]);
		optionText += this._helper._timeRemaining(cargo);
		optionText += this._helper._paddingText(optionText, columns[2]);
		// right-align the fee so that the credits signs line up
		var priceText = formatCredits(cargo.deposit, false, true);
		priceText = this._helper._paddingText(priceText, 3.5) + priceText;
		optionText += priceText
		optionText += this._helper._paddingText(optionText, columns[3]);
		// right-align the fee so that the credits signs line up
		priceText = formatCredits(cargo.payment - cargo.deposit, false, true);
		priceText = this._helper._paddingText(priceText, 3.5) + priceText;
		optionText += priceText

		// need to pad the number in the key to maintain alphabetical order
		var istr = i;
		if (i &lt; 10) {
			istr = &quot;0&quot; + i;
		}
		// needs to be aligned left to line up with the heading
		options[&quot;01_CONTRACT_&quot; + istr] = {
			text: optionText,
			alignment: &quot;LEFT&quot;
		};

		// check if there&#39;s space for this contract
		if (!this.$hasSpaceFor(cargo)) {
			options[&quot;01_CONTRACT_&quot; + istr].color = &quot;darkGrayColor&quot;;
		} else {
			anyWithSpace = true;
			// if there doesn&#39;t appear to be sufficient time remaining
			if (this._helper._timeRemainingSeconds(cargo) &lt; this._helper._timeEstimateSeconds(cargo)) {
				options[&quot;01_CONTRACT_&quot; + istr].color = &quot;orangeColor&quot;;
			}
		}
	}
	// if we&#39;ve come from the detail screen, make sure the last
	// contract shown there is selected here
	var icstr = this._contractIndex;
	if (icstr &lt; 10) icstr = &quot;0&quot; + this._contractIndex;

	var initialChoice = &quot;01_CONTRACT_&quot; + icstr;
	// if none of them have any space...
	if (!anyWithSpace) initialChoice = &quot;06_EXIT&quot;;

	// next, an empty string gives an unselectable row
	options[&quot;02_SPACER&quot;] = &quot;&quot;;

	// now need to add further spacing to fill the remaining rows, or
	// the options will end up at the bottom of the screen.
	var rowsToFill = 21;
	if (player.ship.hudHidden || this.$isBigGuiActive() === true) rowsToFill = 27;

	for (i = 4 + this._contracts.length; i &lt; rowsToFill; i++) {
		// each key needs to be unique at this stage.
		options[&quot;07_SPACER_&quot; + i] = &quot;&quot;;
	}

	// numbered 06 to match the option of the same function in the other branch
	options[&quot;06_EXIT&quot;] = expandMissionText(&quot;smuggling-contracts-command-quit&quot;);

	var missionConfig = {
		titleKey: &quot;smuggling-contracts-title-summary&quot;,
		message: headline,
		allowInterrupt: true,
		screenID: &quot;oolite-smuggling-contracts-summary&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		choices: options,
		initialChoicesKey: initialChoice
	};

	if (this._smugglingSummaryPageBackground != &quot;&quot;) {
		missionConfig.background = this._smugglingSummaryPageBackground;
	}
	if (this._smugglingPageOverlay != &quot;&quot;) {
		if (this._smugglingPageOverlayHeight != 0) {
			missionConfig.overlay = {
				name: this._smugglingPageOverlay,
				height: this._smugglingPageOverlayHeight
			};
		} else {
			missionConfig.overlay = this._smugglingPageOverlay;
		}
	}

	// now run the mission screen
	mission.runScreen(missionConfig, this.$processSmugglingChoice, this);
}

//-------------------------------------------------------------------------------------------------------------
// display the mission screen for the contract detail page
this.$smugglingContractSinglePage = function $smugglingContractSinglePage() {

	var playerrep = this._helper._playerSkill(this.$getSmugglingReputationPrecise());

	// temp variable to simplify code
	var cargo = this._contracts[this._contractIndex];

	// This mission screen uses the long range chart as a backdrop.
	// This means that the first 18 lines are taken up by the chart,
	// and we can&#39;t put text there without overwriting the chart.
	// We therefore need to hide the player&#39;s HUD, to get the full 27
	// lines.

	if (!player.ship.hudHidden &amp;&amp; this.$isBigGuiActive() === false) {
		this._suspendedHUD = true; // note that we hid it, for later
		player.ship.hudHidden = true;
	}

	// We also set the player&#39;s witchspace destination temporarily
	// so we need to store the old one in a variable to reset it later
	this._suspendedDestination = player.ship.targetSystem;

	// That done, we can set the player&#39;s destination so the map looks
	// right.
	player.ship.targetSystem = cargo.destination;

	// start with 18 blank lines, since we don&#39;t want to overlap the chart
	var message = new Array(18).join(&quot;\n&quot;);

	message += expandMissionText(&quot;smuggling-contracts-long-description&quot;, {
		&quot;smuggling-contracts-longdesc-goods&quot;: this.$descriptionForGoods(cargo),
		&quot;smuggling-contracts-longdesc-destination&quot;: this._helper._systemName(cargo.destination),
		&quot;smuggling-contracts-longdesc-deadline&quot;: this._helper._timeRemaining(cargo),
		&quot;smuggling-contracts-longdesc-time&quot;: this._helper._timeEstimate(cargo),
		&quot;smuggling-contracts-longdesc-payment&quot;: formatCredits(cargo.payment, false, true),
		&quot;smuggling-contracts-longdesc-deposit&quot;: formatCredits(cargo.deposit, false, true)
	});

	// use a special background
	var backgroundSpecial = &quot;LONG_RANGE_CHART&quot;;

	// the available options will vary quite a bit, so this rather
	// than a choicesKey in missiontext.plist
	var options = new Object;
	// this is the only option which is always available
	options[&quot;06_EXIT&quot;] = expandMissionText(&quot;smuggling-contracts-command-quit&quot;);

	// if the player has sufficient space
	if (this.$hasSpaceFor(cargo)) {
		options[&quot;05_ACCEPT&quot;] = {
			text: expandMissionText(&quot;smuggling-contracts-command-accept&quot;)
		};

		// if there&#39;s not much time left, change the option colour as a warning!
		if (this._helper._timeRemainingSeconds(cargo) &lt; this._helper._timeEstimateSeconds(cargo)) {
			options[&quot;05_ACCEPT&quot;].color = &quot;orangeColor&quot;;
		}
	} else {
		options[&quot;05_UNAVAILABLE&quot;] = {
			text: expandMissionText(&quot;smuggling-contracts-command-unavailable&quot;),
			color: &quot;darkGrayColor&quot;,
			unselectable: true
		};
	}

	// if the ship has a working advanced nav array, can switch
	// between &#39;quickest&#39; and &#39;shortest&#39; routes
	// (and also upgrade the special background)
	if (player.ship.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
		backgroundSpecial = this._routeMode;
		if (this._routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) {
			options[&quot;01_MODE&quot;] = expandMissionText(&quot;smuggling-contracts-command-ana-quickest&quot;);
		} else {
			options[&quot;01_MODE&quot;] = expandMissionText(&quot;smuggling-contracts-command-ana-shortest&quot;);
		}
	}
	// if there&#39;s more than one, need options for forward, back, and listing
	if (this._contracts.length &gt; 1) {
		options[&quot;02_BACK&quot;] = expandMissionText(&quot;smuggling-contracts-command-back&quot;);
		options[&quot;03_NEXT&quot;] = expandMissionText(&quot;smuggling-contracts-command-next&quot;);
		options[&quot;04_LIST&quot;] = expandMissionText(&quot;smuggling-contracts-command-list&quot;);
	} else {
		// if not, we may need to set a different choice
		// we never want 05_ACCEPT to end up selected initially
		if (this._lastChoice === &quot;02_BACK&quot; || this._lastChoice === &quot;03_NEXT&quot; || this._lastChoice === &quot;04_LIST&quot;) {
			this._lastChoice = &quot;06_EXIT&quot;;
		}
	}

	var title = expandMissionText(&quot;smuggling-contracts-title-detail&quot;, {
		&quot;smuggling-contracts-title-detail-number&quot;: this._contractIndex + 1,
		&quot;smuggling-contracts-title-detail-total&quot;: this._contracts.length
	});

	// finally, after all that setup, actually create the mission screen

	var missionConfig = {
		title: title,
		message: message,
		allowInterrupt: true,
		screenID: &quot;oolite-smuggling-contracts-details&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		backgroundSpecial: backgroundSpecial,
		choices: options,
		initialChoicesKey: this._lastChoice
	};

	if (this._smugglingPageOverlay != &quot;&quot;) {
		if (this._smugglingPageOverlayHeight != 0) {
			missionConfig.overlay = {
				name: this._smugglingPageOverlay,
				height: this._smugglingPageOverlayHeight
			};
		} else {
			missionConfig.overlay = this._smugglingPageOverlay;
		}
	}

	mission.runScreen(missionConfig, this.$processSmugglingChoice, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$processSmugglingChoice = function $processSmugglingChoice(choice) {
	this.$resetViews();
	// can occur if ship launches mid mission screen
	if (choice == null) return;

	// now process the various choices
	if (choice.match(/^01_CONTRACT_/)) {
		// contract selected from summary page
		// set the index to that contract, and show details
		var index = parseInt(choice.slice(12), 10);
		this._contractIndex = index;
		this._lastChoice = &quot;04_LIST&quot;;
		this.$smugglingContractsDisplay(false);

	} else if (choice === &quot;01_MODE&quot;) {
		// advanced navigation array mode flip
		this._routeMode = (this._routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;) ? &quot;LONG_RANGE_CHART_QUICKEST&quot; : &quot;LONG_RANGE_CHART_SHORTEST&quot;;
		this._lastChoice = &quot;01_MODE&quot;;
		this.$smugglingContractsDisplay(false);

	} else if (choice === &quot;02_BACK&quot;) {
		// reduce contract index (parcelContractsDisplay manages wraparound)
		this._contractIndex--;
		this._lastChoice = &quot;02_BACK&quot;;
		this.$smugglingContractsDisplay(false);

	} else if (choice === &quot;03_NEXT&quot;) {
		// increase contract index (parcelContractsDisplay manages wraparound)
		this._contractIndex++;
		this._lastChoice = &quot;03_NEXT&quot;;
		this.$smugglingContractsDisplay(false);

	} else if (choice === &quot;04_LIST&quot;) {
		// display the summary page
		this.$smugglingContractsDisplay(true);

	} else if (choice === &quot;05_ACCEPT&quot;) {
		this.$acceptContract();
		// do not leave the setting as accept for the next contract!
		this._lastChoice = &quot;03_NEXT&quot;;
		this.$smugglingContractsDisplay(false);
	}
	// if we get this far without having called smugglingContractsDisplay
	// that means either &#39;exit&#39; or an unrecognised option was chosen
	if (choice === &quot;06_EXIT&quot;) {
		var sbm = worldScripts.Smugglers_BlackMarket;
		sbm.$initialBlackMarket();
	}
}

//-------------------------------------------------------------------------------------------------------------
// move goods from the contracts list to the player&#39;s ship (if possible)
this.$acceptContract = function $acceptContract() {
	var cargo = this._contracts[this._contractIndex];

	if (cargo.deposit &gt; player.credits) {
		this._helper._soundFailure();
		return;
	}

	// give the cargo to the player
	var result = this.$awardContract(cargo.size, cargo.commodity, system.ID, cargo.destination, cargo.deadline, cargo.payment, cargo.deposit, cargo.route);

	if (result) {
		// pay the deposit
		player.credits -= cargo.deposit;
		// give the player the merchandise
		player.ship.manifest[cargo.commodity] += cargo.size;
		mission.markSystem({
			system: cargo.destination,
			name: &quot;smuggling_contract_&quot; + cargo.destination,
			markerShape: &quot;MARKER_PLUS&quot;
		});

		// remove the contract from the station list
		this._contracts.splice(this._contractIndex, 1);

		this._helper._soundSuccess();

	} else {
		// else must have had manifest change recently
		// (unlikely, but another OXP could have done it)
		this._helper._soundFailure();
	}
}

//-------------------------------------------------------------------------------------------------------------
// store the contract
this.$awardContract = function $awardContract(quantity, commodity, source, destination, deadline, payment, deposit, route) {
	var cargo = {};
	cargo.size = quantity;
	cargo.commodity = commodity;
	cargo.start = source;
	cargo.startName = System.systemNameForID(source);
	cargo.destination = destination;
	cargo.destinationName = System.systemNameForID(destination);
	cargo.deadline = deadline;
	cargo.fee = payment;
	cargo.premium = deposit;
	cargo.route = route;

	this._smugglingContracts.push(cargo);
	this.$contractStartedEmail(cargo);

	return true;
}

//-------------------------------------------------------------------------------------------------------------
// removes any expired parcels
this.$validateSmugglingContracts = function $validateSmugglingContracts() {
	var c = this._contracts.length - 1;
	var removed = false;
	// iterate downwards so we can safely remove as we go
	for (var i = c; i &gt;= 0; i--) {
		// if the time remaining is less than 1/3 of the estimated
		// delivery time, even in the best case it&#39;s probably not
		// going to get there.
		if (this._helper._timeRemainingSeconds(this._contracts[i]) &lt; this._helper._timeEstimateSeconds(this._contracts[i]) / 3) {
			if (worldScripts.ContractsOnBB) {
				worldScripts.ContractsOnBB.$reindexContracts(34000, i);
			}
			// remove it
			this._contracts.splice(i, 1);
			removed = true;
		}
	}
}


//=============================================================================================================
/* Utility functions */

//-------------------------------------------------------------------------------------------------------------
// lower-cases the initial letter of the package contents
this.$formatPackageName = function $formatPackageName(name) {
	return name.charAt(0).toLowerCase() + name.slice(1);
}

//-------------------------------------------------------------------------------------------------------------
// calculates a sample price for a commodity in a distant system
this.$priceForCommodity = function $priceForCommodity(commodity, systeminfo) {
	//sample price returns decicredits, need credits
	var si = worldScripts.Smugglers_Illegal;
	var goods = si.$illegalGoodsListCommodityOnly(systeminfo.systemID);
	if (goods.indexOf(commodity) &gt;= 0) {
		//return Math.round((si._commodityInfo[commodity][1] - (Math.random() * 15)), 2)
		return (systeminfo.samplePrice(commodity) * si._commodityInfo[commodity][1]) / 10;
	} else {
		return systeminfo.samplePrice(commodity) / 10;
	}
}

//-------------------------------------------------------------------------------------------------------------
// description of the cargo
this.$descriptionForGoods = function $descriptionForGoods(cargo) {
	var unit = &quot;tons&quot;;
	var stn = system.mainStation;
	if (!stn &amp;&amp; system.stations.length &gt; 0) stn = system.stations[0];
	if (!stn) return &quot;&quot;;
	if (stn.market[cargo.commodity][&quot;quantity_unit&quot;] === &quot;1&quot;) {
		unit = &quot;kilograms&quot;;
	} else if (stn.market[cargo.commodity][&quot;quantity_unit&quot;] === &quot;2&quot;) {
		unit = &quot;grams&quot;;
	}
	return cargo.size + expandDescription(&quot;[cargo-&quot; + unit + &quot;-symbol]&quot;) + &quot; &quot; + displayNameForCommodity(cargo.commodity);
}

//-------------------------------------------------------------------------------------------------------------
// check if player&#39;s ship has space for the cargo and can afford the deposit
this.$hasSpaceFor = function $hasSpaceFor(cargo) {
	if (cargo.deposit &gt; player.credits) {
		return false;
	}
	var amountInTC = cargo.size;
	if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] === &quot;1&quot;) {
		var spareSafe = 499 - (player.ship.manifest[cargo.commodity] % 1000);
		amountInTC -= spareSafe;
		amountInTC = Math.ceil(amountInTC / 1000);
		if (amountInTC &lt; 0) {
			amountInTC = 0;
		}
	} else if (system.mainStation.market[cargo.commodity][&quot;quantity_unit&quot;] === &quot;2&quot;) {
		var spareSafe = 499999 - (player.ship.manifest[cargo.commodity] % 1000000);
		amountInTC -= spareSafe;
		amountInTC = Math.ceil(amountInTC / 1000000);
		if (amountInTC &lt; 0) {
			amountInTC = 0;
		}
	}

	return (amountInTC &lt;= player.ship.cargoSpaceAvailable);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if another contracts exists for the given system ID, otherwise false
this.$anyContractsLeftForSystem = function $anyContractsLeftForSystem(idx_ignore, sysID) {
	for (var i = 0; i &lt; this._smugglingContracts.length; i++) {
		if (i != idx_ignore &amp;&amp; this._smugglingContracts[i].destination === sysID) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// update the manifest screen with any contracts
this.$updateManifest = function $updateManifest() {

	// don&#39;t try an update in interstellar space
	if (system.isInterstellarSpace) return;

	if (this._smugglingContracts.length &gt; 0) {
		var list = [];
		list.push(&quot;Smuggling Contracts:&quot;);

		for (var i = 0; i &lt; this._smugglingContracts.length; i++) {
			var cargo = this._smugglingContracts[i];
			var message = expandMissionText(&quot;smuggling-contracts-long-descr-manifest&quot;, {
				&quot;smuggling-contracts-longdesc-goods&quot;: this.$descriptionForGoods(cargo),
				&quot;smuggling-contracts-longdesc-destination&quot;: cargo.destinationName,
				&quot;smuggling-contracts-longdesc-deadline&quot;: this.$formatTravelTime(this._helper._timeRemainingSeconds(cargo)),
				&quot;smuggling-contracts-longdesc-time&quot;: this._helper._timeEstimate(cargo),
				&quot;smuggling-contracts-longdesc-payment&quot;: formatCredits(cargo.fee, false, true),
				&quot;smuggling-contracts-longdesc-deposit&quot;: formatCredits(cargo.deposit, false, true)
			});
			list.push(message);
		}
		mission.setInstructions(list, this.name);
	} else {
		mission.setInstructions(null, this.name);
	}
}

//=============================================================================================================
// Smuggling reputation functions
// essentially a JS recreation of the same rep functions in core code to give the player a separate reputation for smuggling

//-------------------------------------------------------------------------------------------------------------
this.$getSmugglingReputation = function $getSmugglingReputation() {
	return parseInt(this.$smugglingReputation() / 10);
}

//-------------------------------------------------------------------------------------------------------------
this.$getSmugglingReputationPrecise = function $getSmugglingReputationPrecise() {
	return this.$smugglingReputation() / 10;
}

//-------------------------------------------------------------------------------------------------------------
this.$smugglingReputation = function $smugglingReputation() {
	var good = this._smugglingRepGood;
	var bad = this._smugglingRepBad;
	var unknown = this._smugglingRepUnknown;

	if (unknown &gt; 0) {
		unknown = this._maxRep - (((2 * unknown) + (this._marketrnd % unknown)) / 3);
	} else {
		unknown = this._maxRep;
	}

	return (good + unknown - 3 * bad) / 2;
}

//-------------------------------------------------------------------------------------------------------------
this.$decreaseSmugglingReputation = function $decreaseSmugglingReputation(amount) {

	var good = this._smugglingRepGood;
	var bad = this._smugglingRepBad;
	var unknown = this._smugglingRepUnknown;

	for (var i = 0; i &lt; amount; i++) {
		if (good &gt; 0) {
			// shift a bean from good to bad
			good--;
			if (bad &lt; this._maxRep) bad++;
		} else {
			// shift a bean from unknown to bad
			if (unknown &gt; 0) unknown--;
			if (bad &lt; this._maxRep) bad++;
		}
	}
	this._smugglingRepGood = good;
	this._smugglingRepBad = bad;
	this._smugglingRepUnknown = unknown;
}

//-------------------------------------------------------------------------------------------------------------
this.$increaseSmugglingReputation = function $increaseSmugglingReputation(amount) {
	var good = this._smugglingRepGood;
	var bad = this._smugglignRepBad;
	var unknown = this._smugglingRepUnknown;

	for (var i = 0; i &lt; amount; i++) {
		if (bad &gt; 0) {
			// shift a bean from bad to unknown
			bad--;
			if (unknown &lt; this._maxRep) unknown++;
		} else {
			// shift a bean from unknown to good
			if (unknown &gt; 0) unknown--;
			if (good &lt; this._maxRep) good++;
		}
	}
	this._smugglingRepGood = good;
	this._smugglingRepBad = bad;
	this._smugglingRepUnknown = unknown;
}

//-------------------------------------------------------------------------------------------------------------
this.$erodeSmugglingReputation = function $erodeSmugglingReputation() {
	var good = this._smugglingRepGood;
	var bad = this._smugglingRepBad;
	var unknown = this._smugglingRepUnknown;
	if (unknown &lt; this._maxRep) {
		if (bad &gt; 0) {
			bad--;
		} else {
			if (good &gt; 0) good--;
		}
		unknown++;
	}
	this._smugglingRepGood = good;
	this._smugglingRepBad = bad;
	this._smugglingRepUnknown = unknown;
}

//-------------------------------------------------------------------------------------------------------------
this.$normaliseSmugglingReputation = function $normaliseSmugglingReputation() {
	var good = this._smugglingRepGood;
	var bad = this._smugglingRepBad;
	var unknown = this._smugglingRepUnknown;

	var c = good + bad + unknown;
	if (c === 0) {
		unknown = this._maxRep;
	} else if (c != this._maxRep) {
		good = good * this._maxRep / c;
		bad = bad * this._maxRep / c;
		unknown = this._maxRep - good - bad;
	}
	this._smugglingRepGood = good;
	this._smugglingRepBad = bad;
	this._smugglingRepUnknown = unknown;
}

//-------------------------------------------------------------------------------------------------------------
// format the travel time
this.$formatTravelTime = function $formatTravelTime(seconds) {
	// this function uses an hours-only format
	// but provides enough information to use a days&amp;hours format if
	// oolite-contracts-time-format in missiontext.plist is overridden

	// extra minutes are discarded
	var hours = Math.floor(seconds / 3600);

	var days = Math.floor(hours / 24);
	var spareHours = hours % 24;

	return expandMissionText(&quot;smuggling-time-format&quot;, {
		&quot;smuggling-time-format-hours&quot;: hours,
		&quot;smuggling-time-format-days&quot;: days,
		&quot;smuggling-time-format-spare-hours&quot;: spareHours
	});
}

//-------------------------------------------------------------------------------------------------------------
// routine to zero out quantities of any illegal goods under contract
// so if the player arrives short, he can&#39;t just buy one, launch, redock and complete the contract
this.$adjustMarket = function $adjustMarket() {
	var stn = system.mainStation;
	if (stn) {
		for (var i = this._smugglingContracts.length - 1; i &gt;= 0; i--) {
			var m = this._smugglingContracts[i];
			// are we in the right system
			if (m.destination === system.ID &amp;&amp; m.destinationName === system.name) {
				// set the market quantity to zero
				stn.setMarketQuantity(m.commodity, 0);
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// send email to player when a contract is started. (1.81 only)
this.$contractStartedEmail = function $contractStartedEmail(contract) {

	var w = worldScripts.EmailSystem;
	if (!w) return;

	var ga = worldScripts.GalCopAdminServices;
	if (ga._disableContracts === true) return;

	var msg = &quot;&quot;;
	var subj = &quot;&quot;;
	var sndr = &quot;&quot;;

	sndr = expandDescription(&quot;[smuggling-contract-sender]&quot;);
	subj = &quot;Accepted contract: &quot; + this.$descriptionForGoods(contract);
	msg = expandDescription(&quot;[smuggling-contract-start]&quot;, {
		description: this.$descriptionForGoods(contract),
		systemname: System.systemNameForID(contract.destination),
		time: global.clock.clockStringForTime(contract.deadline),
		fee: contract.fee.toFixed(2)
	});

	w.$createEmail({
		sender: sndr,
		subject: subj,
		date: global.clock.seconds,
		message: msg
	});
}

//-------------------------------------------------------------------------------------------------------------
this.$contractCompletedEmail = function $contractCompletedEmail(result, fee, contract) {

	var w = worldScripts.EmailSystem;
	if (!w) return;

	var ga = worldScripts.GalCopAdminServices;
	if (ga._disableContracts === true) return;

	var msg = &quot;&quot;;
	var subj = &quot;&quot;;
	var sndr = &quot;&quot;;

	sndr = expandDescription(&quot;[smuggling-contract-sender]&quot;);
	msg = expandDescription(&quot;[smuggling-contract-&quot; + result + &quot;]&quot;, {
		description: this.$descriptionForGoods(contract),
		systemname: System.systemNameForID(contract.destination),
		time: global.clock.clockStringForTime(contract.deadline),
		fee: (fee / 10).toFixed(2)
	});
	subj = expandDescription(&quot;[smuggling-contract-&quot; + result + &quot;-subject]&quot;);

	w.$createEmail({
		sender: sndr,
		subject: subj,
		date: global.clock.seconds,
		message: msg,
		expiryDays: ga._defaultExpiryDays
	});
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_corefunctions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_CoreFunctions&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Holds common functions used across all routines&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function $isBigGuiActive() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; // until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function $padTextRight(currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;&quot;;
	var currentLength = defaultFont.measureString(currentText);
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1) {
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp === ellip) break;
		} while (defaultFont.measureString(tmp) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch === false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function $padTextLeft(currentText, desiredLength) {
	return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
// return a random number between 1 and max
this.$rand = function $rand(max) {
	return Math.floor((Math.random() * max) + 1)
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_dockmaster.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_DockMaster&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the Dock Master interface screen.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this._disabled = false;
this._debug = true;

this._bribeChance = []; // holds the chance a each dock master can be bribed
this._cargoLabelled = []; // array of original commodity and quantities, and new labels
// {oldCommodity: name, newCommodity: name, quantity: number of tons relabelled
this._bribeAttempted = false;
this._dockMasterStartTime = 0;
this._dockMasterEndTime = 0;

this._noSwitch = []; // these commodities can&#39;t be relabelled - populated through the smugglers_equipment.startUpComplete function
this._display = 0;
this._milkRuns = [];
this._successfulBribes = [];
this._cargoAtLaunch = [];
this._bribeCount = [];
this._menuColor = &quot;orangeColor&quot;;
this._itemColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._galJump = false;
this._destReleaseCount = 0;
this._flagged = [];
this._curPage = 0;
this._marker = {};

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {

	if (this._disabled) {
		delete this.shipDockedWithStation;
		delete this.shipLaunchedFromStation;
		delete this.playerWillSaveGame;
		delete this.shipExitedWitchspace;
		delete this.playerEnteredNewGalaxy;
		delete this.shipSpawned;
		delete this.shipTakingDamage;
		delete this.playerSoldCargo;
		delete this.startUpComplete;
		delete this.guiScreenChanged;
		return;
	}

	// add a mission screen exception to Xenon UI
	if (worldScripts.XenonUI) {
		var wx = worldScripts.XenonUI;
		wx.$addMissionScreenException(&quot;oolite-smuggling-dockmaster-milkrun&quot;);
	}
	// add a mission screen exception to Xenon Redux UI
	if (worldScripts.XenonReduxUI) {
		var wxr = worldScripts.XenonReduxUI;
		wxr.$addMissionScreenException(&quot;oolite-smuggling-dockmaster-milkrun&quot;);
	}

	var core = worldScripts.Smugglers_CoreFunctions;
	this.$padTextRight = core.$padTextRight;
	this.$padTextLeft = core.$padTextLeft;
	this.$isBigGuiActive = core.$isBigGuiActive;
	this.$rand = core.$rand;

	this.$getMilkRuns();
	if (missionVariables.Smuggling_BribeChance) {
		this._bribeChance = JSON.parse(missionVariables.Smuggling_BribeChance);
		delete missionVariables.Smuggling_BribeChance;
	} else {
		this.$setupChance();
	}
	if (missionVariables.Smuggling_Relabels) {
		this._cargoLabelled = JSON.parse(missionVariables.Smuggling_Relabels);
		delete missionVariables.Smuggling_Relabels;
	}
	if (missionVariables.Smuggling_SuccessfulBribes) {
		this._successfulBribes = JSON.parse(missionVariables.Smuggling_SuccessfulBribes);
		delete missionVariables.Smuggling_SuccessfulBribes;
	}
	if (missionVariables.Smuggling_BribeAttempted) this._bribeAttemped = (missionVariables.Smuggling_BribeAttemped === 1 ? true : false);

	if (missionVariables.Smuggling_DockMasterStartTime) {
		this._dockMasterStartTime = missionVariables.Smuggling_DockMasterStartTime;
		this._dockMasterEndTime = missionVariables.Smuggling_DockMasterEndTime;
	} else {
		this.$setDockMasterHours();
	}

	if (missionVariables.Smuggling_BribeCount) {
		this._bribeCount = JSON.parse(missionVariables.Smuggling_BribeCount);
		delete missionVariables.Smuggling_BribeCount;
	} else {
		this.$resetBribeCount();
	}

	if (missionVariables.Smuggling_DockMasterFlagged) {
		this._flagged = JSON.parse(missionVariables.Smuggling_DockMasterFlagged);
		delete missionVariables.Smuggling_DockMasterFlagged;
	}
	if (missionVariables.Smuggling_DockMasterUnlockCount) {
		this._destReleaseCount = missionVariables.Smuggling_DockMasterUnlockCount;
		delete missionVariables.Smuggling_DockMasterUnlockCount;
	}

	// set up the interface screen, if required
	this.$initMainInterface(player.ship.dockedStation);
	if (this._cargoLabelled.length &gt; 0) {
		this.$initUnlabelInterface(player.ship.dockedStation);
	}

	// upgraded features in v1.84
	if (0 &lt; oolite.compareVersion(&quot;1.84&quot;)) {
		delete this.shipDumpedCargo;
	} else {
		delete this.shipSpawned;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	// set up dock master interface screen
	this.$initMainInterface(station);
	if (this._cargoLabelled.length &gt; 0) {
		this.$initUnlabelInterface(station);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function (station) {
	if (missionVariables.Smuggling_BribeChance) delete missionVariables.Smuggling_BribeChance;
	if (missionVariables.Smuggling_Relabels) delete missionVariables.Smuggling_Relabels;
	if (missionVariables.Smuggling_SuccessfulBribes) delete missionVariables.Smuggling_SuccessfulBribes;
	if (missionVariables.Smuggling_BribeCount) delete missionVariables.Smuggling_BribeCount;

	var p = player.ship;
	var m = p.manifest.list;
	this._cargoAtLaunch = [];
	// grab a snapshot of the cargo for comparison later
	for (var i = 0; i &lt; m.length; i++) {
		if (m[i].quantity &gt; 0) this._cargoAtLaunch.push({
			commodity: m[i].commodity,
			quantity: m[i].quantity
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	missionVariables.Smuggling_BribeChance = JSON.stringify(this._bribeChance);
	missionVariables.Smuggling_Relabels = JSON.stringify(this._cargoLabelled);
	missionVariables.Smuggling_SuccessfulBribes = JSON.stringify(this._successfulBribes);
	missionVariables.Smuggling_BribeCount = JSON.stringify(this._bribeCount);
	missionVariables.Smuggling_BribeAttempted = (this._bribeAttemped ? 1 : 0);
	if (this._flagged.length &gt; 0) {
		missionVariables.Smuggling_DockMasterFlagged = JSON.stringify(this._flagged)
	}
	missionVariables.Smuggling_DockMasterUnlockCount = this._destReleaseCount;
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	this._bribeAttempted = false;
	this._destReleaseCount = 0;
	this._flagged = [];
	this.$setDockMasterHours();
	if (this._galJump === true) {
		this._galJump = false;
		this.$setupChance();
		this.$getMilkRuns();
		this.$resetBribeCount();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredNewGalaxy = function (galaxyNumber) {
	this._successfulBribes = [];
	this._galJump = true;
}

//-------------------------------------------------------------------------------------------------------------
this.shipSpawned = function (ship) {
	// did the player just dump relabelled cargo?
	// if so, reduce the count in the array
	// and unlabel the dumped cargo
	var p = player.ship;
	if (p &amp;&amp; ship &amp;&amp; ship.isCargo &amp;&amp; ship.position &amp;&amp; p.position &amp;&amp; p.position.distanceTo(ship) &lt; 300) {
		//gotcha
		var total = this.$getTotalRelabelled(ship.commodity);
		if (p.manifest[ship.commodity] &lt; total) {
			for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
				// find the first matching relabelled commodity and adjust it
				if (this._cargoLabelled[i].newCommodity === ship.commodity &amp;&amp; this._cargoLabelled[i].quantity &gt; 0) {
					this._cargoLabelled[i].quantity -= ship.commodityAmount;
					var check = ship.setCargo(this._cargoLabelled[i].oldCommodity);
					break;
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDumpedCargo = function(cargo) {
	var p = player.ship;
	var total = this.$getTotalRelabelled(cargo.commodity);
	if (p.manifest[cargo.commodity] &lt; total) {
		for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
			// find the first matching relabelled commodity and adjust it
			if (this._cargoLabelled[i].newCommodity === cargo.commodity &amp;&amp; this._cargoLabelled[i].quantity &gt; 0) {
				this._cargoLabelled[i].quantity -= cargo.commodityAmount;
				var check = ship.setCargo(this._cargoLabelled[i].oldCommodity);
				break;
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipTakingDamage = function (dmg_amount, whom, type) {
	// work out if the any of the relabelled cargo was destroyed
	// if so, reduce the count in the array
	// basically, relabelled cargo should be destroyed first
	var p = player.ship;
	var se = worldScripts.Smugglers_Equipment;
	for (var i = 0; i &lt; se._commodityIDList.length; i++) {
		var holdamt = p.manifest[se._commodityIDList[i]];
		var origamt = this.$launchAmount(se._commodityIDList[i]);
		var amount = this.$getTotalRelabelled(se._commodityIDList[i]);
		if (holdamt &lt; origamt &amp;&amp; amount &gt; 0) {
			// how many units do we have to remove?
			var to_remove = (origamt - holdamt);

			// find the first instance of a relabelled cargo
			for (var j = 0; j &lt; this._cargoLabelled.length; j++) {
				if (this._cargoLabelled[j].quantity &gt; 0 &amp;&amp; to_remove &gt; 0) {
					// reduce the cargo by the removed amount
					this._cargoLabelled[j].quantity -= to_remove;
					// if we&#39;ve just gone negative, we&#39;ve wiped out all of that cargo batch
					if (this._cargoLabelled[j].quantity &lt; 0) {
						// pick up the remainder
						to_remove = this._cargoLabelled[j].quantity * -1;
						// reset this one back to zero
						this._cargoLabelled[j].quantity = 0;
					}
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// if we scoop cargo make sure it gets added to the at_launch list
this.shipScoopedOther = function (whom) {
	var si = worldScripts.Smugglers_Illegal;
	var check = 0;
	if (si._commodityInfo[whom.commodity]) {
		check = si._commodityInfo[whom.commodity][0];
		if (check &gt; 0) {
			var origamt = this.$launchAmount(whom.commodity);
			if (origamt &gt; 0) {
				for (var i = 0; i &lt; this._cargoAtLaunch.length; i++) {
					if (this._cargoAtLaunch[i].commodity === whom.commodity) this._cargoAtLaunch[i].quantity += whom.commodityAmount;
				}
			} else {
				this._cargoAtLaunch.push({
					commodity: whom.commodity,
					quantity: whom.commodityAmount
				});
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerSoldCargo = function (commodity, units, price) {
	// did the player just sell cargo that has been relabelled?
	// if so, reverse the sale: add the relabelled units back, give the player their money back, and send a console message
	var p = player.ship;
	var relabelled_amount = this.$getTotalRelabelled(commodity);
	if (relabelled_amount &gt; 0 &amp;&amp; p.manifest[commodity] &lt; relabelled_amount) {
		var goodunits = units - relabelled_amount;
		if (units === 1) goodunits = 0;
		var reclaimunits = units - goodunits;

		p.manifest[commodity] = relabelled_amount;
		p.dockedStation.setMarketQuantity(commodity, p.dockedStation.market[commodity].quantity - reclaimunits);

		player.credits -= ((reclaimunits * price) / 10);
		player.consoleMessage(&quot;Sale of relabelled cargo reversed&quot;);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged_hide = function (to, from) {
	if (guiScreen === &quot;GUI_SCREEN_INTERFACES&quot;) {
		mission.unmarkSystem({
			system: this._marker.id1,
			name: this.name + &quot;_mark1&quot;
		});
		mission.unmarkSystem({
			system: this._marker.id2,
			name: this.name + &quot;_mark2&quot;
		});
		if (this._marker.id1 &lt; this._marker.id2) {
			SystemInfo.setInterstellarProperty(galaxyNumber, this._marker.id1, this._marker.id2, 2, &quot;link_color&quot;, null);
		} else {
			SystemInfo.setInterstellarProperty(galaxyNumber, this._marker.id2, this._marker.id1, 2, &quot;link_color&quot;, null);
		}
		this._marker = {};
		delete this.guiScreenChanged;
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the total number of units that have been relabelled to the passed commodity type
this.$getTotalRelabelled = function $getTotalRelabelled(commodity) {
	var amount = 0;
	for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
		if (this._cargoLabelled[i].newCommodity === commodity) amount += this._cargoLabelled[i].quantity;
	}
	return amount;
}

//-------------------------------------------------------------------------------------------------------------
// returns the total number of units of the original commodity
this.$getTotalUnlabelled = function $getTotalUnlabelled(commodity) {
	var amount = 0;
	for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
		if (this._cargoLabelled[i].oldCommodity === commodity) amount += this._cargoLabelled[i].quantity;
	}
	return amount;
}

//-------------------------------------------------------------------------------------------------------------
// returns the amount of a particular oommodity we had at launch
this.$launchAmount = function $launchAmount(commodity) {
	for (var i = 0; i &lt; this._cargoAtLaunch.length; i++) {
		if (this._cargoAtLaunch[i].commodity === commodity) return this._cargoAtLaunch[i].quanitty;
	}
	return 0;
}

//-------------------------------------------------------------------------------------------------------------
// initialise the dock master F4 screen entries
this.$initMainInterface = function $initMainInterface(station) {
	// no station? no interface
	if (!station) return;

	// not galcop aligned? no interface
	if (station.allegiance != &quot;galcop&quot;) return;

	// did we get to the station when the dock master is on duty?
	if (clock.hoursComponent &lt; this._dockMasterStartTime || clock.hoursComponent &gt; this._dockMasterEndTime) return;

	if (this._bribeAttempted === false) {
		station.setInterface(this.name + &quot;dockmaster&quot;, {
			title: &quot;Dock master&quot;,
			category: &quot;Station Interfaces&quot;,
			summary: &quot;Talk to the dock master of the station&quot;,
			callback: this.$initialDockMasterOptions.bind(this)
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// initialises the remove labelling interface screen
this.$initUnlabelInterface = function $initUnlabelInterface(station) {
	station.setInterface(this.name + &quot;unlabel&quot;, {
		title: &quot;Remove cargo relabelling&quot;,
		category: &quot;Ship Systems&quot;,
		summary: &quot;Removes fake manifest labelling applied to your cargo.&quot;,
		callback: this.$removeLabellingList.bind(this)
	});
}

//-------------------------------------------------------------------------------------------------------------
this.$initialDockMasterOptions = function $initialDockMasterOptions() {
	this._display = 0;
	this.$showDockMasterOptions();
}

//-------------------------------------------------------------------------------------------------------------
this.$showDockMasterOptions = function $showDockMasterOptions() {

	var curChoices = {};
	var text = &quot;&quot;;
	var p = player.ship;
	var def = &quot;&quot;;

	var pagesize = 20;
	if (this.$isBigGuiActive() === true) pagesize = 26;

	if (this._display === 0) {
		if (clock.hoursComponent &lt; 12) text += &quot;Good morning&quot;;
		if (clock.hoursComponent &gt;= 12 &amp;&amp; clock.hoursComponent &lt; 18) text += &quot;Good afternoon&quot;;
		if (clock.hoursComponent &gt;= 18) text += &quot;Good evening&quot;;

		text += &quot; &quot; + expandDescription(&quot;[dockmaster-welcome]&quot;);

		var itemcount = 1;
		curChoices[&quot;01_MILKRUN&quot;] = {
			text: &quot;[dockmaster-milkruns]&quot;,
			color: this._menuColor
		};
		if (this._bribeAttempted === false &amp;&amp; player.credits &gt; 0 &amp;&amp; this.$playerHasBribableCargo() === true) {
			curChoices[&quot;02_BRIBE&quot;] = {
				text: &quot;[dockmaster-bribe-cargo]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
		}
		if (worldScripts.BountySystem_MostWanted &amp;&amp; worldScripts.StationDockControl &amp;&amp; p.equipmentStatus(&quot;EQ_HUNTER_LICENCE&quot;) === &quot;EQUIPMENT_OK&quot; &amp;&amp; this._destReleaseCount &lt; 3 &amp;&amp; this._flagged.length &gt; 0) {
			curChoices[&quot;05_HUNTER_REQ&quot;] = {
				text: &quot;[dockmaster-release-dest]&quot;,
				color: this._menuColor
			};
			itemcount += 1;
		}
		curChoices[&quot;98_SPACER&quot;] = &quot;&quot;;
		itemcount += 1;

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;Return&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 2) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;99_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// milk runs
	if (this._display === 1) {
		text = expandDescription(&quot;[milkrun-apology]&quot;);
		var found = false;

		for (var i = this._milkRuns.length - 1; i &gt;= 0; i--) {
			var dist1 = System.infoForSystem(galaxyNumber, system.ID).distanceToSystem(System.infoForSystem(galaxyNumber, this._milkRuns[i].id1));
			var dist2 = System.infoForSystem(galaxyNumber, system.ID).distanceToSystem(System.infoForSystem(galaxyNumber, this._milkRuns[i].id2));
			if (dist1 &lt; 15 || dist2 &lt; 15) {
				// found one
				text = &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot; + expandDescription(&quot;[milkrun]&quot;, {
					system1: System.infoForSystem(galaxyNumber, this._milkRuns[i].id1).name,
					system2: System.infoForSystem(galaxyNumber, this._milkRuns[i].id2).name
				});
				this._marker = this._milkRuns[i];
				this.guiScreenChanged = this.guiScreenChanged_hide;
				mission.markSystem({
					system: this._milkRuns[i].id1,
					name: this.name + &quot;_mark1&quot;,
					markerShape: &quot;MARKER_SQUARE&quot;,
					markerColor: &quot;whiteColor&quot;,
					markerScale: 1.5
				});
				mission.markSystem({
					system: this._milkRuns[i].id2,
					name: this.name + &quot;_mark2&quot;,
					markerShape: &quot;MARKER_SQUARE&quot;,
					markerColor: &quot;whiteColor&quot;,
					markerScale: 1.5
				});
				if (this._milkRuns[i].id1 &lt; this._milkRuns[i].id2) {
					SystemInfo.setInterstellarProperty(galaxyNumber, this._milkRuns[i].id1, this._milkRuns[i].id2, 2, &quot;link_color&quot;, &quot;whiteColor&quot;);
				} else {
					SystemInfo.setInterstellarProperty(galaxyNumber, this._milkRuns[i].id2, this._milkRuns[i].id1, 2, &quot;link_color&quot;, &quot;whiteColor&quot;);
				}
				found = true;
				break;
			}
		}
		if (found === false) {
			var opts = {
				screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
				title: &quot;Dock Master&quot;,
				allowInterrupt: true,
				overlay: {
					name: &quot;stgu-chat.png&quot;,
					height: 546
				},
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
				message: text
			};
		} else {
			var opts = {
				screenID: &quot;oolite-smuggling-dockmaster-milkrun&quot;,
				title: &quot;Dock Master&quot;,
				allowInterrupt: true,
				backgroundSpecial: &quot;LONG_RANGE_CHART&quot;,
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
				message: text
			};
		}
	}

	// display cargo to alter
	if (this._display === 2) {
		var cargo = p.manifest.list;
		var itemcount = 0;
		var list = [];

		for (var i = 0; i &lt; cargo.length; i++) {
			// make sure we don&#39;t relabel relabelled cargo
			var q = cargo[i].quantity;
			if (this._cargoLabelled.length &gt; 0) {
				for (var j = 0; j &lt; this._cargoLabelled.length; j++) {
					if (this._cargoLabelled[j].newCommodity === cargo[i].commodity) q -= this._cargoLabelled[j].quantity;
				}
			}
			if (q &gt; 0) {
				if (this._noSwitch.indexOf(cargo[i].commodity) === -1) {
					list.push({
						menu: &quot;50_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;_CARGO~&quot; + cargo[i].commodity,
						text: cargo[i].displayName + &quot; (&quot; + q + cargo[i].unit + &quot;)&quot;,
						color: this._menuColor
					})
				}
			}
		}

		if (list.length &gt;= pagesize) {
			pagesize -= 4;
		} else {
			pagesize -= 2;
		}

		for (var i = 0; i &lt; pagesize; i++) {
			var ref = i + (this._curPage * pagesize);
			if (ref &lt; list.length) {
				curChoices[list[ref].menu] = {
					text: list[ref].text,
					color: list[ref].color
				};
				itemcount += 1;
			}
		}

		if (list.length &gt; pagesize) {
			if (this._curPage &lt; Math.floor(list.length / pagesize)) {
				curChoices[&quot;Z_NEXT&quot;] = {
					text: &quot;Next page&quot;,
					color: this._itemColor
				};
			} else {
				curChoices[&quot;Z_NEXT&quot;] = {
					text: &quot;Next page&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._curPage &gt; 0) {
				curChoices[&quot;Z_PREV&quot;] = {
					text: &quot;Previous page&quot;,
					color: this._itemColor
				};
			} else {
				curChoices[&quot;Z_PREV&quot;] = {
					text: &quot;Previous page&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}

		for (var i = 0; i &lt; ((pagesize + 1) - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
		}

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			allowInterrupt: false,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			messageKey: &quot;cargo-relabel-accept&quot;
		};
	}

	// display options to switch to
	if (this._display === 3) {

		var se = worldScripts.Smugglers_Equipment;

		text = expandMissionText(&quot;cargo-relabel-question&quot;, {
			cargo: displayNameForCommodity(this._tfrCargo)
		});

		var itemcount = 0;
		var list = [];

		for (var i = 0; i &lt; se._commodityIDList.length; i++) {
			if (this._noSwitch.indexOf(se._commodityIDList[i]) === -1 &amp;&amp; se._commodityIDList != this._tfrCargo) {
				list.push({
					menu: &quot;40_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + se._commodityIDList[i],
					text: displayNameForCommodity(se._commodityIDList[i]),
					color: this._menuColor
				})
			}
		}
		if (list.length &gt;= pagesize) {
			pagesize -= 4;
		} else {
			pagesize -= 2;
		}
		for (var i = 0; i &lt; pagesize; i++) {
			var ref = i + (this._curPage * pagesize);
			if (ref &lt; list.length) {
				curChoices[list[ref].menu] = {
					text: list[ref].text,
					color: list[ref].color
				};
				itemcount += 1;
			}
		}

		if (list.length &gt; pagesize) {
			if (this._curPage &lt; Math.floor(list.length / pagesize)) {
				curChoices[&quot;99_NEXT&quot;] = {
					text: &quot;Next page&quot;,
					color: this._itemColor
				};
			} else {
				curChoices[&quot;99_NEXT&quot;] = {
					text: &quot;Next page&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
			if (this._curPage &gt; 0) {
				curChoices[&quot;99_PREV&quot;] = {
					text: &quot;Previous page&quot;,
					color: this._itemColor
				};
			} else {
				curChoices[&quot;99_PREV&quot;] = {
					text: &quot;Previous page&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}
		for (var i = 0; i &lt; ((pagesize + 1) - itemcount); i++) {
			curChoices[&quot;60_SPACER_&quot; + i] = &quot;&quot;;
		}

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			allowInterrupt: false,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			message: text
		};

	}

	// linking bounty most wanted and SDC
	if (this._display === 4) {
		// display list of flagged ships 
		text = &quot;Which ship are you interested in seeing the destination for?&quot;;
		var itemcount = 0;

		for (var i = 0; i &lt; this._flagged.length; i++) {
			// if you don&#39;t have the dough, it won&#39;t let you go
			// saves having to have another response screen saying &quot;You don&#39;t have enough cash&quot;
			if (player.credits &gt; parseInt(this._flagged[i].cost)) {
				curChoices[&quot;01_FLAGGED~&quot; + i] = {
					text: this._flagged[i].text,
					color: this._menuColor,
					alignment: &quot;LEFT&quot;
				};
			} else {
				curChoices[&quot;01_FLAGGED~&quot; + i] = {
					text: this._flagged[i].text,
					color: this._disabledColor,
					alignment: &quot;LEFT&quot;,
					unselectable: true
				};
			}
			itemcount += 1;
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		itemcount += 1;

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;Return&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 2) - itemcount); i++) {
			curChoices[&quot;97_SPACER_&quot; + i] = &quot;&quot;;
		}

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// ship dest unlock successful
	if (this._display === 5) {
		text = &quot;The destination of the ship has been unlocked. Good hunting, commander!&quot;;

		curChoices[&quot;98A_EXIT&quot;] = {
			text: &quot;Return&quot;,
			color: this._itemColor
		};
		def = &quot;98A_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// ship dest unlock unsuccessful
	if (this._display === 6) {
		text = &quot;I&#39;m not sure what&#39;s happened, but I can&#39;t find that ship in the dock list. It may have already launched.&quot;;

		curChoices[&quot;98A_EXIT&quot;] = {
			text: &quot;Return&quot;,
			color: this._itemColor
		};
		def = &quot;98A_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	mission.runScreen(opts, this.$screenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$screenHandler = function $screenHandler(choice) {

	if (choice == null) return;

	switch (choice) {
		case &quot;01_MILKRUN&quot;:
			this._display = 1;
			break;
		case &quot;02_BRIBE&quot;:
			this.$getBribeAmount(&quot;manifest&quot;);
			return;
		case &quot;05_HUNTER_REQ&quot;:
			this._display = 4;
			break;
		case &quot;98_EXIT&quot;:
			this._display = 1;
			break;
		case &quot;98A_EXIT&quot;:
			this._display = 0;
			break;
		case &quot;99_NEXT&quot;:
			this._curPage += 1;
			break;
		case &quot;99_PREV&quot;:
			this._curPage -= 1;
			break;
	}

	if (choice.indexOf(&quot;01_FLAGGED&quot;) &gt;= 0) {
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		var ref = parseInt(this._flagged[idx].index);
		var shpRef = parseInt(this._flagged[idx].shipIndex);
		var cost = parseInt(this._flagged[idx].cost);
		var mw = worldScripts.BountySystem_MostWanted;
		var found = false;
		for (var i = 0; i &lt; mw._wanted.length; i++) {
			if (mw._wanted[i].index === ref) {
				var sdci = worldScripts.StationDockControl_Interface;
				var item = sdci._viewing[shpRef];
				if (item.pilotName === mw._wanted[i].pilotName) {
					player.credits -= cost;
					player.consoleMessage(&quot;You have been charged &quot; + formatCredits(cost, false, true));
					item.destinationHidden = false;
					this._destReleaseCount += 1;
					this._flagged.splice(idx, 1);
					found = true;
					this._display = 5;
				}
			}
		}
		if (found === false) {
			this._display = 6;
		}
	}

	if (choice.indexOf(&quot;50_&quot;) &gt;= 0) {
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._display = 3;
		this._curPage = 0;
	}

	if (choice.indexOf(&quot;40_&quot;) &gt;= 0) {
		var newCmdty = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var p = player.ship;
		var amount = p.manifest[this._tfrCargo];

		// if we already have relabelled the selected cargo, get the un-relabelled portion of it
		for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
			if (this._cargoLabelled[i].newCommodity === this._tfrCargo) amount -= this._cargoLabelled[i].quantity;
		}

		// do we already have some relabelled cargo of the same type (matching old and new
		var found = false;
		for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
			if (this._cargoLabelled[i].newCommodity === newCmdty &amp;&amp; this._cargoLabelled[i].oldCommodity === this._tfrCargo) {
				this._cargoLabelled[i].quantity += amount
				found = true;
			}
		}
		if (found === false) this._cargoLabelled.push({
			oldCommodity: this._tfrCargo,
			newCommodity: newCmdty,
			quantity: amount
		});

		p.manifest[this._tfrCargo] -= amount;
		p.manifest[newCmdty] += amount;

		this.$initUnlabelInterface(p.dockedStation);

		var extramsg = &quot;&quot;;
		var se = worldScripts.Smugglers_Equipment;
		if (se.$hasSmugglingCompartment() === true) extramsg = expandMissionText(&quot;cargo-relabel-reminder&quot;);

		mission.runScreen({
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Dock Master&quot;,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			message: expandDescription(&quot;[dockmaster-complete]&quot;) + extramsg,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
		});
		p.dockedStation.setInterface(this.name + &quot;dockmaster&quot;, null);
	}


	if (choice != &quot;99_EXIT&quot; &amp;&amp; choice.indexOf(&quot;40_&quot;) === -1) {
		this.$showDockMasterOptions();
	}

}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for a new phase
this.$getBribeAmount = function $getBribeAmount(type) {

	var text = &quot;&quot;;

	this._bribeAttempted = true;

	var inttype = Math.floor((this._bribeChance[system.ID] * 4) + 1);
	var inttypedesc = expandDescription(&quot;[interest-type&quot; + inttype + &quot;]&quot;);
	var lastBribe = this.$previousBribeAmount();
	if (type === &quot;manifest&quot;) {
		text = expandDescription(&quot;[dockmaster-question]&quot;, {
				interesttype: inttypedesc
			}) + &quot;\n\n&quot; +
			&quot;(&quot; + expandDescription(&quot;[dockmaster-cost]&quot;, {
				credits: formatCredits(player.credits, false, true)
			}) +
			(lastBribe &gt; 0 ? expandDescription(&quot;[dockmaster-lastbribe]&quot;, {
				bribeamount: formatCredits(lastBribe, false, true)
			}) : &quot;&quot;) + &quot;)&quot;;
	} else {
		text = &quot;So you want the keys to my kingdom, eh? That&#39;s a pretty serious offence. &quot; + expandDescription(&quot;[dockmaster-question]&quot;, {
				interesttype: inttypedesc
			}) + &quot;\n\n&quot; +
			&quot;(&quot; + expandDescription(&quot;[dockmaster-cost]&quot;, {
				credits: formatCredits(player.credits, false, true)
			})
	}

	var opts = {
		screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
		title: &quot;Dock Master&quot;,
		allowInterrupt: false,
		overlay: {
			name: &quot;stgu-chat.png&quot;,
			height: 546
		},
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		message: text,
		textEntry: true
	};

	mission.runScreen(opts, this.$getBribeAmountInputManifest, this);
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getBribeAmount screen
this.$getBribeAmountInputManifest = function $getBribeAmountInputManifest(param) {
	var p = player.ship;
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= player.credits) {
		var amount = parseInt(param);
		// will this work
		var chance = this._bribeChance[system.ID];
		// higher amounts are more likely to be accepted
		// chance of 0.5 would mean you would need to offer them 1690 credits
		//if (this._debug) log(this.name, &quot;min bribe amount = &quot; + (Math.pow(parseInt(chance * 32), 1.8) * (1 + system.productivity / 56300) * this._bribeCount[system.ID]));
		if ((Math.pow(parseInt(chance * 32), 1.8) * (1 + system.productivity / 56300) * this._bribeCount[system.ID]) &lt;= amount) {
			player.credits -= amount;
			this._display = 2;
			this._curPage = 0;
			this.$addBribe(system.ID);
			this._successfulBribes.push({
				system: system.ID,
				bribeAmount: amount
			});
			this.$showDockMasterOptions();
		} else {
			this._display = 0;
			if (Math.random() &gt; chance) {
				mission.runScreen({
					screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
					title: &quot;Dock Master&quot;,
					overlay: {
						name: &quot;stgu-chat.png&quot;,
						height: 546
					},
					message: expandDescription(&quot;[dockmaster-angry-nopenalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
				});
			} else {
				var penalty = (this.$rand(10) + 3);
				p.setBounty(player.bounty + penalty, &quot;attempted bribe&quot;);
				mission.runScreen({
					screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
					title: &quot;Dock Master&quot;,
					overlay: {
						name: &quot;stgu-chat.png&quot;,
						height: 546
					},
					message: expandDescription(&quot;[dockmaster-angry-penalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
				});
				// send email (if installed)
				var email = worldScripts.EmailSystem;
				if (email) {
					var ga = worldScripts.GalCopAdminServices;
					email.$createEmail({
						sender: &quot;GalCop Customs&quot;,
						subject: &quot;Attempt to bribe official&quot;,
						date: clock.seconds,
						message: expandDescription(&quot;[smugglers-failed-bribe-email]&quot;, {
							legal_penalty: penalty,
							stationname: player.ship.dockedStation.displayName,
							systemname: System.systemNameForID(system.ID)
						}),
						expiryDays: ga._defaultExpiryDays
					});
				}
			}
			p.dockedStation.setInterface(this.name + &quot;dockmaster&quot;, null);
		}
	} else {
		this._display = 0;
		mission.runScreen({
			screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
			title: &quot;Bribing Official&quot;,
			overlay: {
				name: &quot;stgu-chat.png&quot;,
				height: 546
			},
			message: expandDescription(&quot;[dockmaster-skipbribe]&quot;),
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;
		});
		p.dockedStation.setInterface(this.name + &quot;dockmaster&quot;, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$removeLabellingList = function $removeLabellingList() {

	var curChoices = {};
	var se = worldScripts.Smugglers_Equipment;

	var pagesize = 20;

	if (this.$isBigGuiActive() === true) pagesize = 26;

	for (var i = 0; i &lt; this._cargoLabelled.length; i++) {
		curChoices[&quot;01_CARGO~&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = {
			text: this._cargoLabelled[i].quantity + se.$getCommodityType(this._cargoLabelled[i].newCommodity) + &quot; &quot; + displayNameForCommodity(this._cargoLabelled[i].newCommodity) +
				&quot;, back to &quot; + displayNameForCommodity(this._cargoLabelled[i].oldCommodity),
			color: this._menuColor
		};
	}

	curChoices[&quot;98_SPACER_&quot; + i] = &quot;&quot;;
	curChoices[&quot;99_EXIT&quot;] = {
		text: &quot;Return&quot;,
		color: this._itemColor
	};

	for (var i = 0; i &lt; ((pagesize - 3) - this._cargoLabelled.length); i++) {
		curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
	}

	var def = &quot;99_EXIT&quot;;

	var opts = {
		screenID: &quot;oolite-smuggling-dockmaster-map&quot;,
		title: &quot;Remove Cargo Relabelling&quot;,
		allowInterrupt: true,
		overlay: {
			name: &quot;stgu-id.png&quot;,
			height: 546
		},
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		choices: curChoices,
		initialChoicesKey: def,
		messageKey: &quot;cargo-relabel-heading&quot;
	};

	mission.runScreen(opts, this.$removeLabellingHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$removeLabellingHandler = function $removeLabellingHandler(choice) {
	if (choice == null) return;

	if (choice.indexOf(&quot;01_&quot;) &gt;= 0) {
		var idx = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		this.$removeLabelling(idx);
		if (this._cargoLabelled.length &gt; 0) this.$removeLabellingList();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$removeLabelling = function $removeLabelling(idx) {

	var p = player.ship;

	// revert cargo back to original
	// make sure we still have the right amount
	if (p.manifest[this._cargoLabelled[idx].newCommodity] &lt; this._cargoLabelled[idx].quantity)
		this._cargoLabelled[idx].quantity = p.manifest[this._cargoLabelled[idx].newCommodity];
	// deduct from the new commodity name
	p.manifest[this._cargoLabelled[idx].newCommodity] -= this._cargoLabelled[idx].quantity;
	// add to the old commodity name
	p.manifest[this._cargoLabelled[idx].oldCommodity] += this._cargoLabelled[idx].quantity;

	this._cargoLabelled.splice(idx, 1);

	if (this._cargoLabelled.length === 0) {
		p.dockedStation.setInterface(this.name + &quot;unlabel&quot;, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
// sets up the chance a dock master can be bribed, for each of the main stations
this.$setupChance = function $setupChance() {
	this._bribeChance = [];
	for (var i = 0; i &lt;= 255; i++) {
		this._bribeChance.push(Math.random());
	}
}

//-------------------------------------------------------------------------------------------------------------
// sets the time frame where the dock master can be called on - he doesn&#39;t work 24 hours a day!
this.$setDockMasterHours = function $setDockMasterHours() {
	// set a start time between 7 and 10
	this._dockMasterStartTime = 6 + this.$rand(4);
	// set an end time between 7 and 10 hours later
	this._dockMasterEndTime = this.$dockMasterStartTime + (this.$rand(4) + 6)
}

//-------------------------------------------------------------------------------------------------------------
// removes labelling on a specific amount of cargo
this.$removeRealCargoQuantity = function $removeRealCargoQuantity(commodity, amount) {
	var p = player.ship;
	var remainder = amount;
	for (var i = this._cargoLabelled.length - 1; i &gt;= 0; i--) {
		if (remainder &gt; 0 &amp;&amp; this._cargoLabelled[i].oldCommodity === commodity) {
			if (this._cargoLabelled[i].quantity &gt;= remainder) {
				if (p.manifest[this._cargoLabelled[i].newCommodity] &gt;= remainder) {
					p.manifest[this._cargoLabelled[i].newCommodity] -= remainder;
					p.manifest[this._cargoLabelled[i].oldCommodity] += remainder;
					this._cargoLabelled[i].quantity -= remainder;
					remainder = 0;
				} else {
					var subamt = p.manifest[this._cargoLabelled[i].newCommodity];
					p.manifest[this._cargoLabelled[i].newCommodity] = 0;
					p.manifest[this._cargoLabelled[i].oldCommodity] += subamt;
					this._cargoLabelled[i].quantity -= subamt;
					remainder -= subamt;
				}
			} else {
				var correction = remainder - this._cargoLabelled[i].quantity;
				if (p.manifest[this._cargoLabelled[i].newCommodity] &gt;= correction) {
					p.manifest[this._cargoLabelled[i].newCommodity] -= correction;
					p.manifest[this._cargoLabelled[i].oldCommodity] += correction;
					this._cargoLabelled[i].quantity -= correction;
					remainder -= correction;
				} else {
					var subamt = p.manifest[this._cargoLabelled[i].oldCommodity];
					p.manifest[this._cargoLabelled[i].newCommodity] = 0;
					p.manifest[this._cargoLabelled[i].oldCommodity] += subamt;
					this._cargoLabelled[i].quantity = 0;
					remainder -= subamt;
				}
			}
		}
	}
	return remainder;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player cargo that the dock master can relabel, otherwise false
this.$playerHasBribableCargo = function $playerHasBribableCargo() {
	var p = player.ship;
	var cargo = p.manifest.list;
	var result = false;
	for (var i = 0; i &lt; cargo.length; i++) {
		if (this._noSwitch.indexOf(cargo[i].commodity) === -1) result = true;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// increment the number of times the dm has been bribed
this.$addBribe = function $addBribe(sysID) {
	this._bribeCount[sysID] += 0.1 + (system.pseudoRandomNumber &gt; 0.5 ? 0.1 : 0);
}

//-------------------------------------------------------------------------------------------------------------
// reset the bribecount array
this.$resetBribeCount = function $resetBribeCount() {
	this._bribeCount = [];
	for (var i = 0; i &lt;= 255; i++) {
		this._bribeCount.push(1);
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the last successful bribe amount for the current system
this.$previousBribeAmount = function $previousBribeAmount() {
	var bribeAmt = 0;
	for (var i = 0; i &lt; this._successfulBribes.length; i++) {
		if (this._successfulBribes[i].system === system.ID &amp;&amp; this._successfulBribes[i].bribeAmount &gt; bribeAmt) {
			bribeAmt = this._successfulBribes[i].bribeAmount;
		}
	}
	return bribeAmt;
}

//-------------------------------------------------------------------------------------------------------------
// loads the mulk run array with data for the current galaxy
this.$getMilkRuns = function $getMilkRuns() {
	this._milkRuns = [];
	switch (galaxyNumber) {
		case 0:
			this._milkRuns.push({
				id1: 99,
				id2: 84,
				rating: 70
			});
			this._milkRuns.push({
				id1: 99,
				id2: 191,
				rating: 72
			});
			this._milkRuns.push({
				id1: 12,
				id2: 116,
				rating: 73
			});
			this._milkRuns.push({
				id1: 163,
				id2: 192,
				rating: 73
			});
			this._milkRuns.push({
				id1: 131,
				id2: 42,
				rating: 73
			});
			this._milkRuns.push({
				id1: 254,
				id2: 187,
				rating: 74
			});
			this._milkRuns.push({
				id1: 158,
				id2: 116,
				rating: 75
			});
			this._milkRuns.push({
				id1: 98,
				id2: 84,
				rating: 75
			});
			this._milkRuns.push({
				id1: 98,
				id2: 191,
				rating: 75
			});
			this._milkRuns.push({
				id1: 195,
				id2: 63,
				rating: 76
			});
			this._milkRuns.push({
				id1: 254,
				id2: 251,
				rating: 76
			});
			this._milkRuns.push({
				id1: 79,
				id2: 174,
				rating: 76
			});
			this._milkRuns.push({
				id1: 49,
				id2: 116,
				rating: 76
			});
			this._milkRuns.push({
				id1: 254,
				id2: 74,
				rating: 77
			});
			this._milkRuns.push({
				id1: 100,
				id2: 42,
				rating: 77
			});
			this._milkRuns.push({
				id1: 207,
				id2: 116,
				rating: 77
			});
			this._milkRuns.push({
				id1: 131,
				id2: 167,
				rating: 78
			});
			this._milkRuns.push({
				id1: 240,
				id2: 187,
				rating: 78
			});
			this._milkRuns.push({
				id1: 79,
				id2: 191,
				rating: 79
			});
			this._milkRuns.push({
				id1: 33,
				id2: 123,
				rating: 81
			});
			this._milkRuns.push({
				id1: 99,
				id2: 185,
				rating: 81
			});
			this._milkRuns.push({
				id1: 82,
				id2: 244,
				rating: 83
			});
			this._milkRuns.push({
				id1: 227,
				id2: 154,
				rating: 83
			});
			this._milkRuns.push({
				id1: 35,
				id2: 186,
				rating: 84
			});
			this._milkRuns.push({
				id1: 221,
				id2: 185,
				rating: 84
			});
			this._milkRuns.push({
				id1: 163,
				id2: 252,
				rating: 86
			});
			this._milkRuns.push({
				id1: 141,
				id2: 101,
				rating: 89
			});
			this._milkRuns.push({
				id1: 250,
				id2: 101,
				rating: 89
			});
			this._milkRuns.push({
				id1: 218,
				id2: 18,
				rating: 90
			});
			this._milkRuns.push({
				id1: 82,
				id2: 154,
				rating: 90
			});
			this._milkRuns.push({
				id1: 246,
				id2: 18,
				rating: 93
			});
			break;
		case 1:
			this._milkRuns.push({
				id1: 255,
				id2: 37,
				rating: 72
			});
			this._milkRuns.push({
				id1: 191,
				id2: 37,
				rating: 74
			});
			this._milkRuns.push({
				id1: 128,
				id2: 165,
				rating: 74
			});
			this._milkRuns.push({
				id1: 57,
				id2: 94,
				rating: 76
			});
			this._milkRuns.push({
				id1: 24,
				id2: 20,
				rating: 78
			});
			this._milkRuns.push({
				id1: 237,
				id2: 174,
				rating: 79
			});
			this._milkRuns.push({
				id1: 16,
				id2: 157,
				rating: 80
			});
			this._milkRuns.push({
				id1: 81,
				id2: 20,
				rating: 80
			});
			this._milkRuns.push({
				id1: 167,
				id2: 94,
				rating: 81
			});
			this._milkRuns.push({
				id1: 82,
				id2: 174,
				rating: 82
			});
			this._milkRuns.push({
				id1: 40,
				id2: 68,
				rating: 82
			});
			this._milkRuns.push({
				id1: 106,
				id2: 211,
				rating: 83
			});
			this._milkRuns.push({
				id1: 57,
				id2: 19,
				rating: 83
			});
			this._milkRuns.push({
				id1: 57,
				id2: 115,
				rating: 84
			});
			this._milkRuns.push({
				id1: 185,
				id2: 38,
				rating: 84
			});
			this._milkRuns.push({
				id1: 92,
				id2: 211,
				rating: 85
			});
			this._milkRuns.push({
				id1: 191,
				id2: 83,
				rating: 85
			});
			this._milkRuns.push({
				id1: 16,
				id2: 34,
				rating: 87
			});
			this._milkRuns.push({
				id1: 40,
				id2: 179,
				rating: 88
			});
			this._milkRuns.push({
				id1: 209,
				id2: 115,
				rating: 88
			});
			this._milkRuns.push({
				id1: 81,
				id2: 97,
				rating: 90
			});
			this._milkRuns.push({
				id1: 82,
				id2: 86,
				rating: 92
			});
			this._milkRuns.push({
				id1: 167,
				id2: 115,
				rating: 92
			});
			this._milkRuns.push({
				id1: 231,
				id2: 147,
				rating: 94
			});
			break;
		case 2:
			this._milkRuns.push({
				id1: 205,
				id2: 168,
				rating: 71
			});
			this._milkRuns.push({
				id1: 144,
				id2: 147,
				rating: 73
			});
			this._milkRuns.push({
				id1: 34,
				id2: 57,
				rating: 73
			});
			this._milkRuns.push({
				id1: 64,
				id2: 168,
				rating: 73
			});
			this._milkRuns.push({
				id1: 76,
				id2: 152,
				rating: 76
			});
			this._milkRuns.push({
				id1: 76,
				id2: 66,
				rating: 76
			});
			this._milkRuns.push({
				id1: 205,
				id2: 82,
				rating: 77
			});
			this._milkRuns.push({
				id1: 155,
				id2: 57,
				rating: 77
			});
			this._milkRuns.push({
				id1: 116,
				id2: 152,
				rating: 77
			});
			this._milkRuns.push({
				id1: 17,
				id2: 24,
				rating: 77
			});
			this._milkRuns.push({
				id1: 205,
				id2: 114,
				rating: 79
			});
			this._milkRuns.push({
				id1: 17,
				id2: 41,
				rating: 79
			});
			this._milkRuns.push({
				id1: 17,
				id2: 147,
				rating: 79
			});
			this._milkRuns.push({
				id1: 22,
				id2: 140,
				rating: 79
			});
			this._milkRuns.push({
				id1: 64,
				id2: 215,
				rating: 79
			});
			this._milkRuns.push({
				id1: 58,
				id2: 152,
				rating: 80
			});
			this._milkRuns.push({
				id1: 50,
				id2: 65,
				rating: 82
			});
			this._milkRuns.push({
				id1: 42,
				id2: 163,
				rating: 83
			});
			this._milkRuns.push({
				id1: 58,
				id2: 140,
				rating: 84
			});
			this._milkRuns.push({
				id1: 205,
				id2: 241,
				rating: 84
			});
			this._milkRuns.push({
				id1: 43,
				id2: 98,
				rating: 84
			});
			this._milkRuns.push({
				id1: 22,
				id2: 91,
				rating: 84
			});
			this._milkRuns.push({
				id1: 42,
				id2: 135,
				rating: 85
			});
			this._milkRuns.push({
				id1: 54,
				id2: 118,
				rating: 86
			});
			this._milkRuns.push({
				id1: 18,
				id2: 100,
				rating: 87
			});
			this._milkRuns.push({
				id1: 5,
				id2: 66,
				rating: 87
			});
			this._milkRuns.push({
				id1: 79,
				id2: 65,
				rating: 89
			});
			this._milkRuns.push({
				id1: 10,
				id2: 141,
				rating: 89
			});
			this._milkRuns.push({
				id1: 6,
				id2: 180,
				rating: 89
			});
			this._milkRuns.push({
				id1: 58,
				id2: 66,
				rating: 89
			});
			this._milkRuns.push({
				id1: 10,
				id2: 70,
				rating: 90
			});
			this._milkRuns.push({
				id1: 5,
				id2: 140,
				rating: 90
			});
			this._milkRuns.push({
				id1: 116,
				id2: 122,
				rating: 92
			});
			this._milkRuns.push({
				id1: 10,
				id2: 85,
				rating: 94
			});
			break;
		case 3:
			this._milkRuns.push({
				id1: 38,
				id2: 160,
				rating: 70
			});
			this._milkRuns.push({
				id1: 25,
				id2: 24,
				rating: 72
			});
			this._milkRuns.push({
				id1: 25,
				id2: 62,
				rating: 74
			});
			this._milkRuns.push({
				id1: 220,
				id2: 171,
				rating: 75
			});
			this._milkRuns.push({
				id1: 137,
				id2: 105,
				rating: 76
			});
			this._milkRuns.push({
				id1: 209,
				id2: 33,
				rating: 77
			});
			this._milkRuns.push({
				id1: 29,
				id2: 168,
				rating: 78
			});
			this._milkRuns.push({
				id1: 58,
				id2: 24,
				rating: 78
			});
			this._milkRuns.push({
				id1: 103,
				id2: 107,
				rating: 78
			});
			this._milkRuns.push({
				id1: 65,
				id2: 239,
				rating: 78
			});
			this._milkRuns.push({
				id1: 103,
				id2: 105,
				rating: 79
			});
			this._milkRuns.push({
				id1: 103,
				id2: 177,
				rating: 79
			});
			this._milkRuns.push({
				id1: 38,
				id2: 53,
				rating: 82
			});
			this._milkRuns.push({
				id1: 42,
				id2: 16,
				rating: 83
			});
			this._milkRuns.push({
				id1: 38,
				id2: 74,
				rating: 84
			});
			this._milkRuns.push({
				id1: 103,
				id2: 108,
				rating: 84
			});
			this._milkRuns.push({
				id1: 103,
				id2: 239,
				rating: 84
			});
			this._milkRuns.push({
				id1: 220,
				id2: 68,
				rating: 84
			});
			this._milkRuns.push({
				id1: 58,
				id2: 109,
				rating: 89
			});
			this._milkRuns.push({
				id1: 220,
				id2: 90,
				rating: 90
			});
			break;
		case 4:
			this._milkRuns.push({
				id1: 34,
				id2: 186,
				rating: 70
			});
			this._milkRuns.push({
				id1: 34,
				id2: 250,
				rating: 70
			});
			this._milkRuns.push({
				id1: 66,
				id2: 58,
				rating: 70
			});
			this._milkRuns.push({
				id1: 2,
				id2: 63,
				rating: 71
			});
			this._milkRuns.push({
				id1: 226,
				id2: 31,
				rating: 71
			});
			this._milkRuns.push({
				id1: 130,
				id2: 250,
				rating: 72
			});
			this._milkRuns.push({
				id1: 162,
				id2: 250,
				rating: 73
			});
			this._milkRuns.push({
				id1: 34,
				id2: 183,
				rating: 74
			});
			this._milkRuns.push({
				id1: 162,
				id2: 183,
				rating: 74
			});
			this._milkRuns.push({
				id1: 137,
				id2: 191,
				rating: 75
			});
			this._milkRuns.push({
				id1: 98,
				id2: 123,
				rating: 75
			});
			this._milkRuns.push({
				id1: 130,
				id2: 108,
				rating: 76
			});
			this._milkRuns.push({
				id1: 12,
				id2: 81,
				rating: 76
			});
			this._milkRuns.push({
				id1: 213,
				id2: 81,
				rating: 77
			});
			this._milkRuns.push({
				id1: 115,
				id2: 150,
				rating: 78
			});
			this._milkRuns.push({
				id1: 162,
				id2: 149,
				rating: 78
			});
			this._milkRuns.push({
				id1: 254,
				id2: 183,
				rating: 79
			});
			this._milkRuns.push({
				id1: 212,
				id2: 46,
				rating: 80
			});
			this._milkRuns.push({
				id1: 198,
				id2: 31,
				rating: 80
			});
			this._milkRuns.push({
				id1: 254,
				id2: 250,
				rating: 82
			});
			this._milkRuns.push({
				id1: 130,
				id2: 149,
				rating: 82
			});
			this._milkRuns.push({
				id1: 194,
				id2: 88,
				rating: 83
			});
			this._milkRuns.push({
				id1: 198,
				id2: 63,
				rating: 84
			});
			this._milkRuns.push({
				id1: 99,
				id2: 91,
				rating: 84
			});
			this._milkRuns.push({
				id1: 254,
				id2: 149,
				rating: 85
			});
			this._milkRuns.push({
				id1: 99,
				id2: 200,
				rating: 85
			});
			this._milkRuns.push({
				id1: 184,
				id2: 150,
				rating: 86
			});
			this._milkRuns.push({
				id1: 89,
				id2: 87,
				rating: 88
			});
			this._milkRuns.push({
				id1: 249,
				id2: 16,
				rating: 90
			});
			break;
		case 5:
			this._milkRuns.push({
				id1: 243,
				id2: 57,
				rating: 70
			});
			this._milkRuns.push({
				id1: 243,
				id2: 228,
				rating: 71
			});
			this._milkRuns.push({
				id1: 182,
				id2: 160,
				rating: 71
			});
			this._milkRuns.push({
				id1: 14,
				id2: 249,
				rating: 73
			});
			this._milkRuns.push({
				id1: 240,
				id2: 30,
				rating: 75
			});
			this._milkRuns.push({
				id1: 20,
				id2: 57,
				rating: 75
			});
			this._milkRuns.push({
				id1: 243,
				id2: 231,
				rating: 75
			});
			this._milkRuns.push({
				id1: 243,
				id2: 101,
				rating: 75
			});
			this._milkRuns.push({
				id1: 243,
				id2: 98,
				rating: 76
			});
			this._milkRuns.push({
				id1: 109,
				id2: 57,
				rating: 76
			});
			this._milkRuns.push({
				id1: 243,
				id2: 103,
				rating: 77
			});
			this._milkRuns.push({
				id1: 34,
				id2: 24,
				rating: 78
			});
			this._milkRuns.push({
				id1: 69,
				id2: 167,
				rating: 78
			});
			this._milkRuns.push({
				id1: 144,
				id2: 61,
				rating: 79
			});
			this._milkRuns.push({
				id1: 109,
				id2: 228,
				rating: 79
			});
			this._milkRuns.push({
				id1: 182,
				id2: 167,
				rating: 79
			});
			this._milkRuns.push({
				id1: 240,
				id2: 234,
				rating: 80
			});
			this._milkRuns.push({
				id1: 144,
				id2: 253,
				rating: 81
			});
			this._milkRuns.push({
				id1: 144,
				id2: 97,
				rating: 81
			});
			this._milkRuns.push({
				id1: 109,
				id2: 98,
				rating: 81
			});
			this._milkRuns.push({
				id1: 20,
				id2: 244,
				rating: 81
			});
			this._milkRuns.push({
				id1: 86,
				id2: 131,
				rating: 81
			});
			this._milkRuns.push({
				id1: 109,
				id2: 101,
				rating: 82
			});
			this._milkRuns.push({
				id1: 28,
				id2: 108,
				rating: 82
			});
			this._milkRuns.push({
				id1: 1,
				id2: 108,
				rating: 82
			});
			this._milkRuns.push({
				id1: 115,
				id2: 215,
				rating: 83
			});
			this._milkRuns.push({
				id1: 109,
				id2: 231,
				rating: 83
			});
			this._milkRuns.push({
				id1: 20,
				id2: 103,
				rating: 84
			});
			this._milkRuns.push({
				id1: 1,
				id2: 181,
				rating: 86
			});
			this._milkRuns.push({
				id1: 240,
				id2: 140,
				rating: 88
			});
			this._milkRuns.push({
				id1: 14,
				id2: 113,
				rating: 88
			});
			this._milkRuns.push({
				id1: 144,
				id2: 13,
				rating: 88
			});
			this._milkRuns.push({
				id1: 102,
				id2: 98,
				rating: 88
			});
			this._milkRuns.push({
				id1: 17,
				id2: 108,
				rating: 91
			});
			this._milkRuns.push({
				id1: 6,
				id2: 181,
				rating: 92
			});
			this._milkRuns.push({
				id1: 40,
				id2: 215,
				rating: 94
			});
			this._milkRuns.push({
				id1: 17,
				id2: 181,
				rating: 96
			});
			this._milkRuns.push({
				id1: 50,
				id2: 232,
				rating: 98
			});
			break;
		case 6:
			this._milkRuns.push({
				id1: 170,
				id2: 105,
				rating: 75
			});
			this._milkRuns.push({
				id1: 170,
				id2: 190,
				rating: 75
			});
			this._milkRuns.push({
				id1: 64,
				id2: 160,
				rating: 75
			});
			this._milkRuns.push({
				id1: 13,
				id2: 160,
				rating: 76
			});
			this._milkRuns.push({
				id1: 6,
				id2: 174,
				rating: 77
			});
			this._milkRuns.push({
				id1: 183,
				id2: 164,
				rating: 79
			});
			this._milkRuns.push({
				id1: 28,
				id2: 223,
				rating: 79
			});
			this._milkRuns.push({
				id1: 119,
				id2: 190,
				rating: 79
			});
			this._milkRuns.push({
				id1: 151,
				id2: 180,
				rating: 80
			});
			this._milkRuns.push({
				id1: 64,
				id2: 81,
				rating: 80
			});
			this._milkRuns.push({
				id1: 55,
				id2: 105,
				rating: 80
			});
			this._milkRuns.push({
				id1: 195,
				id2: 159,
				rating: 80
			});
			this._milkRuns.push({
				id1: 55,
				id2: 190,
				rating: 80
			});
			this._milkRuns.push({
				id1: 86,
				id2: 127,
				rating: 80
			});
			this._milkRuns.push({
				id1: 172,
				id2: 160,
				rating: 81
			});
			this._milkRuns.push({
				id1: 199,
				id2: 233,
				rating: 82
			});
			this._milkRuns.push({
				id1: 151,
				id2: 73,
				rating: 82
			});
			this._milkRuns.push({
				id1: 181,
				id2: 95,
				rating: 83
			});
			this._milkRuns.push({
				id1: 103,
				id2: 58,
				rating: 83
			});
			this._milkRuns.push({
				id1: 71,
				id2: 160,
				rating: 83
			});
			this._milkRuns.push({
				id1: 66,
				id2: 190,
				rating: 84
			});
			this._milkRuns.push({
				id1: 135,
				id2: 80,
				rating: 84
			});
			this._milkRuns.push({
				id1: 23,
				id2: 233,
				rating: 84
			});
			this._milkRuns.push({
				id1: 66,
				id2: 105,
				rating: 84
			});
			this._milkRuns.push({
				id1: 215,
				id2: 95,
				rating: 86
			});
			this._milkRuns.push({
				id1: 247,
				id2: 202,
				rating: 86
			});
			this._milkRuns.push({
				id1: 82,
				id2: 105,
				rating: 87
			});
			this._milkRuns.push({
				id1: 82,
				id2: 190,
				rating: 87
			});
			this._milkRuns.push({
				id1: 172,
				id2: 81,
				rating: 88
			});
			this._milkRuns.push({
				id1: 71,
				id2: 81,
				rating: 88
			});
			this._milkRuns.push({
				id1: 67,
				id2: 209,
				rating: 88
			});
			this._milkRuns.push({
				id1: 23,
				id2: 246,
				rating: 89
			});
			this._milkRuns.push({
				id1: 7,
				id2: 209,
				rating: 89
			});
			this._milkRuns.push({
				id1: 215,
				id2: 133,
				rating: 91
			});
			this._milkRuns.push({
				id1: 183,
				id2: 133,
				rating: 92
			});
			this._milkRuns.push({
				id1: 247,
				id2: 133,
				rating: 93
			});
			this._milkRuns.push({
				id1: 151,
				id2: 5,
				rating: 95
			});
			break;
		case 7:
			this._milkRuns.push({
				id1: 56,
				id2: 240,
				rating: 70
			});
			this._milkRuns.push({
				id1: 56,
				id2: 170,
				rating: 72
			});
			this._milkRuns.push({
				id1: 82,
				id2: 100,
				rating: 75
			});
			this._milkRuns.push({
				id1: 31,
				id2: 25,
				rating: 77
			});
			this._milkRuns.push({
				id1: 147,
				id2: 121,
				rating: 77
			});
			this._milkRuns.push({
				id1: 41,
				id2: 35,
				rating: 78
			});
			this._milkRuns.push({
				id1: 244,
				id2: 138,
				rating: 78
			});
			this._milkRuns.push({
				id1: 192,
				id2: 133,
				rating: 78
			});
			this._milkRuns.push({
				id1: 151,
				id2: 230,
				rating: 78
			});
			this._milkRuns.push({
				id1: 137,
				id2: 121,
				rating: 80
			});
			this._milkRuns.push({
				id1: 206,
				id2: 25,
				rating: 80
			});
			this._milkRuns.push({
				id1: 232,
				id2: 86,
				rating: 81
			});
			this._milkRuns.push({
				id1: 93,
				id2: 185,
				rating: 81
			});
			this._milkRuns.push({
				id1: 93,
				id2: 196,
				rating: 81
			});
			this._milkRuns.push({
				id1: 192,
				id2: 35,
				rating: 81
			});
			this._milkRuns.push({
				id1: 161,
				id2: 255,
				rating: 82
			});
			this._milkRuns.push({
				id1: 14,
				id2: 25,
				rating: 83
			});
			this._milkRuns.push({
				id1: 110,
				id2: 172,
				rating: 84
			});
			this._milkRuns.push({
				id1: 82,
				id2: 179,
				rating: 84
			});
			this._milkRuns.push({
				id1: 41,
				id2: 233,
				rating: 85
			});
			this._milkRuns.push({
				id1: 251,
				id2: 30,
				rating: 85
			});
			this._milkRuns.push({
				id1: 218,
				id2: 71,
				rating: 89
			});
			this._milkRuns.push({
				id1: 93,
				id2: 186,
				rating: 90
			});
			this._milkRuns.push({
				id1: 206,
				id2: 71,
				rating: 90
			});
			this._milkRuns.push({
				id1: 251,
				id2: 233,
				rating: 90
			});
			this._milkRuns.push({
				id1: 93,
				id2: 92,
				rating: 92
			});
			this._milkRuns.push({
				id1: 232,
				id2: 81,
				rating: 92
			});
			this._milkRuns.push({
				id1: 110,
				id2: 177,
				rating: 93
			});
			this._milkRuns.push({
				id1: 232,
				id2: 252,
				rating: 93
			});
			break
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_equipment.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_Equipment&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the smuggling compartment functions.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

/* TODO:
- Add very occasional messages from traders entering system (&quot;Let hope that setting of 234 is worth the money we paid.&quot;)
- When docking with a standard contract that will be completed, but the cargo is now illegal, still give the player the opportunity to bribe
- allow non-core commodities to be put in the compartment

ISSUE:
- bribe opportunity not appearing in scenario where player docks at non-main station galcop station, with a scooped escape pod and illegal cargo (not slaves)

*/

this._disabled = false;
this._debug = false;

// array of all possible installed compartment equipment keys
this._equipmentList = [&quot;EQ_SMUGGLING_COMPARTMENT_1&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_2&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_3&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_4&quot;,
	&quot;EQ_SMUGGLING_COMPARTMENT_5&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_6&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_7&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_8&quot;,
	&quot;EQ_SMUGGLING_COMPARTMENT_9&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_10&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_11&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_12&quot;,
	&quot;EQ_SMUGGLING_COMPARTMENT_13&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_14&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_15&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_16&quot;,
	&quot;EQ_SMUGGLING_COMPARTMENT_17&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_18&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_19&quot;, &quot;EQ_SMUGGLING_COMPARTMENT_20&quot;
];

this._commodityIDList = [];

// station types where the smuggling compartment can be purchased.
this._smugglingAllegiance = [&quot;pirate&quot;, &quot;chaotic&quot;, &quot;neutral&quot;];
this._maxTonnage = 20; // maximum possible size of the hold
this._doCompartmentCheck = false; // flag to indicate that a compartment check will be performed after docking
this._backdoor = false;

this._sc_Phase = 1; // the current phase setting (value between 1 and 999)
this._sc_TechVersion = 1; // the current tech level of the compartment
this._sc_VisibleAs = &quot;food&quot;; // string (commodity name) that the hold will display as for scanners
this._sc_Cargo = []; // array of commodities in hold (commodity:string, quantity:number, unit:t/kg/g);
this._sc_Days = 0; // number of days since the last tech upgrade
this._phaseUpdateDays = 0;
this._phaseScanDiscovery = []; // array of objects of discovered phase scan settings (from purchase or from phase scanner)

this._smugglingScreen = false; // flag to indicate that a mission screen is open
this._originalCredits = 0; // value to hold the players credits (used to refund the cost of the initial item)
this._display = 0;
this._oldday = 0;

this._phaseScannerAvailable = false; // indicates that this system has the phase scanner available
this._phaseScannerDetected = false; // indicates that the player was caught using the phase scanner
this._systemPhase = []; // array of objects (gov, tl, phase)
this._phaseUpdates = []; // stores list of governments/techLevels that have been updated
this._toRemove = []; // list of source and commodities to be removed
this._removeCompartment = false; // flag to indicate that the smuggling compartment should be removed after docking
this._playerFine = 0; // amount to fine the player
this._menuColor = &quot;orangeColor&quot;;
this._itemColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._galJump = false;
this._policeModel = &quot;&quot;;

this._IGTInstalled = false;
this._doCargoCheck = false;
this._dockingWithSlaves = false;
this._dockingWithSlavesCount = 0;

//-------------------------------------------------------------------------------------------------------------
this.startUp = function () {
	if (this._disabled) {
		delete this.playerWillSaveGame;
		delete this.playerBoughtEquipment;
		delete this.shipWillDockWithStation;
		delete this.shipDockedWithStation;
		delete this.missionScreenOpportunity;
		delete this.shipExitedWitchspace;
		delete this.shipLaunchedEscapePod;
		delete this.guiScreenChanged;
		delete this.guiScreenWillChange;
		delete this.playerEnteredNewGalaxy;
		delete this.playerRescuedEscapePod;
		delete this.dayChanged;
		delete this.equipmentDamaged;
		delete this.equipmentRemoved;
		delete this.startUpComplete;
		delete this.startUp;
		return;
	}
	this.$createSystemDataArray();
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	function compare(a, b) {
		if (a.order &lt; b.order) return -1;
		if (a.order &gt; b.order) return 1;
		return 0;
	}

	// check for illegal goods tweak
	if (worldScripts[&quot;illegal_goods_tweak&quot;]) this._IGTInstalled = true;

	// build a list of available commodities
	var m = null;
	// find a station to get market data from
	if (system.mainStation) {
		m = system.mainStation.market;
	} else if (player.ship.dockedStation) {
		m = playership.dockedStation.market;
	} else if (system.stations.length &gt; 0) {
		m = system.stations[0].market;
	}
	if (m) {
		var sbd = worldScripts.Smugglers_DockMaster;
		var c = Object.keys(m);
		var list = [];
		for (var i = 0; i &lt; c.length; i++) {
			list.push({
				commodity: c[i],
				order: (m[c[i]].sort_order ? m[c[i]].sort_order : 0)
			});
			// add any non-t commodities (kg or g, ie gold, platinum, gemstones) to the dockmaster noswitch list
			if (m[c[i]].quantity_unit != 0) sbd._noSwitch.push(c[i]);
		}
		list.sort(compare);
		for (var i = 0; i &lt; list.length; i++) {
			this._commodityIDList.push(list[i].commodity);
		}
	}

	var core = worldScripts.Smugglers_CoreFunctions;
	this.$padTextRight = core.$padTextRight;
	this.$padTextLeft = core.$padTextLeft;
	this.$isBigGuiActive = core.$isBigGuiActive;
	this.$rand = core.$rand;

	if (missionVariables.SmugglingCompartment_Phase) this._sc_Phase = missionVariables.SmugglingCompartment_Phase;
	if (missionVariables.SmugglingCompartment_TechVersion) this._sc_TechVersion = missionVariables.SmugglingCompartment_TechVersion;
	if (missionVariables.SmugglingCompartment_VisibleAs) this._sc_VisibleAs = missionVariables.SmugglingCompartment_VisibleAs;
	if (missionVariables.SmugglingCompartment_Cargo) this._sc_Cargo = JSON.parse(missionVariables.SmugglingCompartment_Cargo);
	if (missionVariables.SmugglingCompartment_Days) this._sc_Days = missionVariables.SmugglingCompartment_Days;
	if (missionVariables.Smuggling_SystemPhase) this._systemPhase = JSON.parse(missionVariables.Smuggling_SystemPhase);
	if (missionVariables.Smuggling_PhaseScannerAvailable) this._phaseScannerAvailable = (missionVariables.Smuggling_PhaseScannerAvailable === 1 ? true : false);
	if (missionVariables.Smuggling_PhaseDiscovery) this._phaseScanDiscovery = JSON.parse(missionVariables.Smuggling_PhaseDiscovery);
	if (missionVariables.Smuggling_PhaseUpdates) this._phaseUpdates = JSON.parse(missionVariables.Smuggling_PhaseUpdates);
	if (missionVariables.Smuggling_PhaseUpdateDays) this._phaseUpdateDays = missionVariables.Smuggling_PhaseUpdateDays;

	delete missionVariables.SmugglingCompartment_Phase;
	delete missionVariables.SmugglingCompartment_TechVersion;
	delete missionVariables.SmugglingCompartment_VisibleAs;
	delete missionVariables.SmugglingCompartment_Cargo;

	if (this._systemPhase.length === 0) this.$createSystemPhase();

	this._policeModel = this.$getPoliceModel();

	// set up the interface screen, if required
	this.$initInterface(player.ship.dockedStation);

	// check that the inflight eq is given to the player if they have a smuggling compartment
	if (this.$hasSmugglingCompartment() === true) {
		player.ship.awardEquipment(&quot;EQ_SMUGGLING_INFLIGHT_STORAGE&quot;);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	if (this.$hasSmugglingCompartment() === true) {
		missionVariables.SmugglingCompartment_Phase = this._sc_Phase;
		missionVariables.SmugglingCompartment_TechVersion = this._sc_TechVersion;
		missionVariables.SmugglingCompartment_VisibleAs = this._sc_VisibleAs;
		missionVariables.SmugglingCompartment_Cargo = JSON.stringify(this._sc_Cargo);
		missionVariables.SmugglingCompartment_Days = this._sc_Days;
	} else {
		delete missionVariables.SmugglingCompartment_Phase;
		delete missionVariables.SmugglingCompartment_TechVersion;
		delete missionVariables.SmugglingCompartment_VisibleAs;
		delete missionVariables.SmugglingCompartment_Cargo;
		delete missionVariables.SmugglingCompartment_Days;
	}
	missionVariables.Smuggling_SystemPhase = JSON.stringify(this._systemPhase);
	missionVariables.Smuggling_PhaseScannerAvailable = (this._phaseScannerAvailable ? 1 : 0);
	missionVariables.Smuggling_PhaseDiscovery = JSON.stringify(this._phaseScanDiscovery);
	if (this._phaseUpdates.length &gt; 0) missionVariables.Smuggling_PhaseUpdates = JSON.stringify(this._phaseUpdates);
	missionVariables.Smuggling_PhaseUpdateDays = this._phaseUpdateDays;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function (equipmentKey) {
	var p = player.ship;

	// repairing the phase scanner
	if (equipmentKey === &quot;EQ_PHASE_SCANNER_REPAIR&quot;) {
		p.removeEquipment(equipmentKey);
		p.setEquipmentStatus(&quot;EQ_PHASE_SCANNER&quot;, &quot;EQUIPMENT_OK&quot;);
		return;
	}

	// repairing the smuggling compartment
	if (equipmentKey.indexOf(&quot;EQ_SMUGGLING_COMPARTMENT_REPAIR&quot;) &gt;= 0) {
		p.removeEquipment(equipmentKey);
		var eq = this.$getSmugglingCompartmentEquipment();
		p.setEquipmentStatus(eq, &quot;EQUIPMENT_OK&quot;);
		return;
	}

	var stn = p.dockedStation;

	// removing the phase scanner
	if (equipmentKey === &quot;EQ_PHASE_SCANNER_REMOVAL&quot;) {
		p.removeEquipment(equipmentKey);
		if (stn.allegiance != &quot;galcop&quot;) {
			// give the player a refund if we&#39;re not at a galcop station
			var tradeinfactor = 1.0;
			// less refund for damaged scanner
			if (p.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;) != &quot;EQUIPMENT_OK&quot;) tradinfactor = 0.3;

			var oldEqInfo = EquipmentInfo.infoForKey(&quot;EQ_PHASE_SCANNER&quot;);
			player.credits += ((oldEqInfo.price / 10) * stn.equipmentPriceFactor) * tradeinfactor;
		}
		p.removeEquipment(&quot;EQ_PHASE_SCANNER&quot;);
	}

	// removing the smuggling compartment
	if (equipmentKey === &quot;EQ_SMUGGLING_COMPARTMENT_REMOVAL&quot;) {
		p.removeEquipment(equipmentKey);
		var eqKey = this.$getSmugglingCompartmentEquipment();
		// do a refund, but only if we&#39;re not at a galcop station, and only if the existing equipment is undamaged
		if (stn.allegiance != &quot;galcop&quot; &amp;&amp; eqKey != &quot;&quot;) {
			var tradeinfactor = 1.0;
			// less refund for damaged compartment
			if (p.equipmentStatus(eqKey) != &quot;EQUIPMENT_OK&quot;) tradinfactor = 0.3;

			var oldEqInfo = EquipmentInfo.infoForKey(eqKey);
			player.credits += ((oldEqInfo.price / 10) * stn.equipmentPriceFactor) * tradeinfactor;
		}
		if (p.equipmentStatus(&quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;) === &quot;EQUIPMENT_OK&quot;) {
			p.removeEquipment(&quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;);
		}
		player.ship.removeEquipment(&quot;EQ_SMUGGLING_INFLIGHT_STORAGE&quot;);
		this._backdoor = true;
		if (eqKey != &quot;&quot;) p.removeEquipment(eqKey);
		this._backdoor = false;

		this.$resetCompartmentInfo(stn);
	}

	// buying a new (or expanding/contracting an existing) smuggling compartment
	if (equipmentKey === &quot;EQ_SMUGGLING_COMPARTMENT&quot;) {
		p.removeEquipment(equipmentKey);
		// give the player back the original amount, in case they decide not to purchase
		if (this._originalCredits != 0) {
			player.credits = this._originalCredits;
			this._originalCredits = player.credits;
		}
		// mission screen to ask how many TC to allocate
		this._hudHidden = player.ship.hudHidden;
		this.$showPurchasePage();
	}

	if (equipmentKey === &quot;EQ_SMUGGLING_VERSION_UPGRADE&quot;) {
		p.removeEquipment(equipmentKey);
		this._sc_TechVersion += 1;
		this._sc_Days = 0;
	}

	if (stn.allegiance === &quot;galcop&quot; &amp;&amp; equipmentKey === &quot;EQ_RENOVATION&quot;) {
		// is the phase scanner on board
		var msgtype = 0;
		if (p.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;) === &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) {
			// oh dear - caught!
			p.setBounty(player.bounty + (this.$rand(10) + 10), &quot;illegal equipment&quot;);
			msgtype += 1;
		}
		// is the smuggling compartment installed?
		if (this.$hasSmugglingCompartment() === true) {
			msgtype += 2;
			// increase bounty
			p.setBounty(player.bounty + (this.$rand(10) + 10), &quot;illegal equipment&quot;);
		}
		var msgBody = &quot;&quot;;
		switch (msgtype) {
			case 0:
				break;
			case 1:
				msgBody = expandDescription(&quot;[illegal-equipment-1]&quot;);
				break;
			case 2:
				msgBody = expandDescription(&quot;[illegal-equipment-2]&quot;, {
					size: this.$smugglingCompartmentSize()
				});
				break;
			case 3:
				msgBody = expandDescription(&quot;[illegal-equipment-3]&quot;, {
					size: this.$smugglingCompartmentSize()
				});
				break;
		}

		if (msgBody != &quot;&quot;) {
			var curChoices = {};
			if (player.credits &gt; 0) {
				curChoices[&quot;01_BRIBE&quot;] = {
					text: &quot;[illegal-attempt-bribe]&quot;,
					color: this._menuColor
				};
			}
			curChoices[&quot;98_ACCEPT&quot;] = {
				text: &quot;[illegal-accept-penalty]&quot;,
				color: this._menuColor
			};

			this._bribeType = 2;
			var opts = {
				title: &quot;Illegal Equipment Discovered&quot;,
				message: msgBody,
				model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
				allowInterrupt: false,
				exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
				choices: curChoices,
				initialChoicesKey: &quot;98_ACCEPT&quot;
			};

			mission.runScreen(opts, this.$bribeScreenHandler, this);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
/*this.equipmentRemoved = function(equipmentKey) {
	if (this._backdoor === true) return;
	if (this._equipmentList.indexOf(equipmentKey) &gt;= 0) {
		this.$resetCompartmentInfo(player.ship.dockedStation);
		return;
	}
}*/

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function (station) {
	this._policeModel = this.$getPoliceModel();

	this._savedBounty = player.bounty;

	// grab a snapshot of the players illegal cargo
	this._dockIllegal = [];
	this._dockingWithSlaves = false;
	// if the player has slaves on board, and IGT is installed, then turn on the flag to indicate we&#39;re docking with slaves
	var escapePods = 0;
	if (worldScripts.EscapePodTweaks) {
		// if the _escapePods array have data, what means the escape pod tweaks &quot;shipWillDOckWithStation&quot; function hasn&#39;t been executed yet
		// in that case we need to know how many slaves to ignore
		escapePods = worldScripts.EscapePodTweaks._escapePods.length;
		// if its been run already, the value will be 0 anyway
	}
	if (player.ship.manifest[&quot;slaves&quot;] &amp;&amp; (player.ship.manifest[&quot;slaves&quot;] - escapePods) &gt; 0 &amp;&amp; this._IGTInstalled === true) {
		this._dockingWithSlaves = true;
		// make a note of the slaves count, because if we dock with rescued escape pods, the number will have to be reduced during &quot;playerRescuedEscapePod&quot;;
		this._dockingWithSlavesCount = (player.ship.manifest[&quot;slaves&quot;] - escapePods);
	}

	this._playerHadIllegals = false;
	if (this.$playerHasIllegalCargo(station) === true) {
		var p = player.ship;
		var m = p.manifest;
		this._dockIllegal = [];
		for (var i = 0; i &lt; m.list.length; i++) {
			if (m.list[i].quantity &gt; 0 &amp;&amp; station.market[m.list[i].commodity].legality_import &gt; 0) this._dockIllegal.push({
				commodity: m.list[i].commodity,
				quantity: m.list[i].quantity
			});
		}
		this._playerHadIllegals = true;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	if (station.allegiance === &quot;galcop&quot;) {
		if (this._dockingWithSlaves === false) this._doCargoCheck = true;
	}
	// set up smuggling interface screen
	this.$initInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedEscapePod = function (escapepod) {
	// clear out smugglers compartment when escape pod is used
	this._sc_Cargo = [];
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function () {
	// if IGT is installed, let it run first. it will call the performCargoCheck when it&#39;s finished.
	if (this._doCargoCheck === true) {
		this.$performCargoCheck();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerRescuedEscapePod = function (fee, reason, occupant) {
	if (this._dockingWithSlavesCount &gt; 0) {
		this._dockingWithSlavesCount -= 1;
		if (this._dockingWithSlavesCount === 0) this._dockingWithSlaves = false;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	if (this._galJump === true) {
		this._galJump = false;
		this.$createSystemPhase();
		this.$createSystemDataArray();
	}
	this._phaseScannerAvailable = false;
	this._phaseScannerDetected = false;
	if (system.government === 0 &amp;&amp; system.info.techlevel &gt;= 8) {
		// will this system provide a phase scanner?
		if (system.scrambledPseudoRandomNumber(system.ID) &gt; 0.6) this._phaseScannerAvailable = true;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenWillChange = function (to, from) {
	if (to === &quot;GUI_SCREEN_MANIFEST&quot;) this.$updateManifest();
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function (to, from) {
	if (guiScreen === &quot;GUI_SCREEN_EQUIP_SHIP&quot;) {
		this._originalCredits = player.credits;
		this._savedBounty = player.bounty;
	}
	if (from === &quot;GUI_SCREEN_MISSION&quot; &amp;&amp; this._smugglingScreen) {
		this._smugglingScreen = false;
		if (this._hudHidden === false &amp;&amp; player.ship.hudHidden === true) player.ship.hudHidden = this._hudHidden;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredNewGalaxy = function (galaxyNumber) {
	this._systemPhase = [];
	this._phaseUpdates = [];
	this._phaseScanDiscovery = [];
	this._galJump = true;
}

//-------------------------------------------------------------------------------------------------------------
this.dayChanged = function (newday) {
	if (newday != this._oldday) {
		this._sc_Days += 1;
		this._oldday = newday;
		this._phaseUpdateDays += 1;
		if (this._phaseUpdateDays &gt;= 10) {
			this._phaseUpdateDays = 0;
			var item = this._systemData[this.$rand(this._systemData.length - 1)];
			var gov = parseInt(item / 100);
			var tl = item - gov;
			var newPhase = this.$rand(999);
			// remove from the update list
			for (var i = this._phaseUpdates.length - 1; i &gt;= 0; i--) {
				if (this._phaseUpdates[i].gov === gov &amp;&amp; this._phaseUpdates[i].tl === tl) {
					this._phaseUpdates.splice(i, 1);
				}
			}
			this.$updatePhase(gov, tl, newPhase);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentDamaged = function (equipment) {
	if (this._equipmentList.indexOf(equipment) &gt;= 0) {
		// work out how many items will be damaged
		var remove = this.$rand(3);
		var report = [];
		var count = 0;
		do {
			for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
				if (count &lt; remove &amp;&amp; this._sc_Cargo[i].quantity &gt; 0) {
					this._sc_Cargo[i].quantity -= 1;
					report.push(this._sc_Cargo[i].displayName + &quot; destroyed!&quot;);
					count += 1;
				}
			}
		} while (count &lt; remove &amp;&amp; this._sc_Cargo.length &gt; 0);
		this.$cargoCleanUp();
		// give the player the bad news
		if (report.length &gt; 0) {
			for (var i = 0; i &lt; report.length; i++) {
				player.consoleMessage(report[i]);
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$performCargoCheck = function $performCargoCheck() {
	var msgtype = 0;
	var p = player.ship;

	this._toRemove = [];
	this._removeCompartment = false;
	this._playerFine = 0;

	if (this._doCargoCheck === true) {
		this._doCargoCheck = false;

		if (this._phaseScannerDetected === true) {
			if (player.credits &gt; 1000) {
				this._playerFine += 1000;
			} else {
				this._playerFine = player.credits;
			}
			// player has already had a legal penalty when the scan was detected, so we don&#39;t need to do it again here
		}

		// is our compartment damaged (and therefore visible?
		if (this.$hasSmugglingCompartment() === true &amp;&amp; this.$isCompartmentDamaged() === true) {
			msgtype = 1;
			this._removeCompartment = true;
			// increase bounty
			p.setBounty(player.bounty + (this.$rand(10) + 10), &quot;illegal equipment&quot;);
			if (player.credits &gt; 1000) {
				this._playerFine += 1000;
			} else {
				this._playerFine = player.credits;
			}
		}

		// get the list of illegal goods for this system
		var si = worldScripts.Smugglers_Illegal;
		var goods = si.$illegalGoodsList(system.ID, true);
		// if IGT is installed, add slaves onto the list of illegal goods
		if (this._IGTInstalled) {
			goods.push({
				systemID: system.ID,
				commodity: &quot;slaves&quot;,
				started: 0,
				end: 0,
				description: &quot;&quot;,
				permit: 0,
				scale: 1
			});
		}

		if (msgtype === 0) {
			for (var i = 0; i &lt; goods.length; i++) {
				// if the visibleAs property equal to an illegal good on this planet? oh dear...it&#39;s not going to matter what the chance is...
				if (this.$hasSmugglingCompartment() === true &amp;&amp; goods[i].commodity.indexOf(this._sc_VisibleAs) &gt;= 0 &amp;&amp; si.$playerHasPermit(system.ID, goods[i].commodity, true) === false) {
					msgtype = 2;
					this._removeCompartment = true;
					// increase bounty
					p.setBounty(player.bounty + (this.$rand(10) + 10), &quot;illegal equipment&quot;);
					// fine player
					if (player.credits &gt; 1000) {
						this._playerFine += 1000;
					} else {
						this._playerFine = player.credits;
					}
				}
			}
		}

		// now, goods in the hold that are illegal to import should now automatically fine the player with a bounty increase.
		// so we shouldn&#39;t have to worry about bounty from this point on.
		// what we will do here is remove cargo and possibly fine the player a monetary amount

		// base chance is 26% (for tech level 1), but increasing with a systems tech level, to a max of 40% for a tl 15 system
		var base = 25 + system.info.techlevel;
		var phase_diff = base;
		// work out the chance of detection
		// check for phase adjuster
		if (p.equipmentStatus(&quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;) === &quot;EQUIPMENT_OK&quot;) {
			// if we&#39;ve got the phase adjuster, there&#39;s a small boost the the base value, from 22% to 37%
			base = 22 + system.info.techlevel;
			phase_diff = Math.abs(this.$getSystemPhase(system.ID) - this._sc_Phase) - 3;
			// if we&#39;re within +/- 3 then it&#39;s good enough
			if (phase_diff &lt; 0) phase_diff = 0;
			// anything over base is considered inconsequential
			if (phase_diff &gt; base) phase_diff = base;
		}
		var chance = phase_diff / 100;

		if (this._debug) log(this.name, &quot;Smuggling compartment init chance: &quot; + chance);

		// now apply tech level offset. could be 0 through to an extra 12.5% (30/240 = 0.125)
		chance += (this._sc_Days &gt; 30 ? 30 : this._sc_Days) / 240;

		if (this._debug) log(this.name, &quot;Smuggling compartment final chance: &quot; + chance);

		var s_cargo = this.$getSmugglingCargo();
		var msg = &quot;&quot;;
		var permit_failed = false;
		var permit_list = &quot;&quot;;
		var permit_multi = 0;
		var permit_ok = &quot;&quot;;
		var permit_okcount = 0;
		var displaycheck = false;
		var removecount = 0;
		var successcount = 0;
		var successmsg = &quot;&quot;;

		var smuggling_found = false;
		// do this here so we only do it once
		if (Math.random() &lt; chance) smuggling_found = true;

		for (var i = 0; i &lt; goods.length; i++) {
			// are there any illegal goods in our standard hold

			// get a list of commodities (handles case where there are multiple commdoties in the illegal goods entry
			var cmdtylist = goods[i].commodity.split(&quot;,&quot;);
			var quantity_to_check = 0;

			for (var j = 0; j &lt; cmdtylist.length; j++) {
				// only check if the good is actually marked as illegal
				if (this.$commodityIllegalScale(cmdtylist[j]) &gt; 0) {
					if (p.manifest[cmdtylist[j]] &gt; 0) {
						quantity_to_check += p.manifest[cmdtylist[j]];
					}
					var hyper = this.$getHyperCargoQuantity(cmdtylist[j]);
					if (hyper &gt; 0) {
						quantity_to_check += hyper;
					}
					for (var k = 0; k &lt; s_cargo.length; k++) {
						if (cmdtylist[j] === s_cargo[k].commodity &amp;&amp; smuggling_found === true) {
							quantity_to_check += s_cargo[k].quantity;
						}
					}
				}
			}

			if (quantity_to_check &gt; 0) {
				if (si.$playerHasPermit(system.ID, goods[i].commodity, true) === false) {
					// will get here if the player had a permit but it didn&#39;t work, or if they didn&#39;t have a permit at all.

					// check if a permit permit failed to work
					if (si.$playerHasPermit(system.ID, goods[i].commodity, false) === true) {
						permit_failed = true;
						permit_list += (permit_list === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + si.$translateCommodityList(goods[i].commodity);
						permit_multi += 1;

						if (goods[i].commodity.indexOf(&quot;,&quot;) &gt;= 0) permit_multi += 1;

						// remove any permit whether it worked or not
						si.$removePermit(system.ID, goods[i].commodity);
					}

					for (var j = 0; j &lt; cmdtylist.length; j++) {
						// check the visible carge
						if (p.manifest[cmdtylist[j]] &gt; 0) {
							// found!
							msg += &quot; - &quot; + p.manifest[cmdtylist[j]] + &quot; &quot; + this.$getCommodityType(cmdtylist[j]) + &quot;  &quot; + displayNameForCommodity(cmdtylist[j]) + &quot;\n&quot;;
							this._toRemove.push({
								source: &quot;hold&quot;,
								commodity: cmdtylist[j]
							});
							removecount += 1;
							// stanndard slave bounty gets added here, because it&#39;s not set to be flagged as illegal to import by default
							if (this._IGTInstalled === true &amp;&amp; cmdtylist[j] === &quot;slaves&quot;) {
								p.setBounty(player.bounty + (p.manifest[cmdtylist[j]] * goods[i].scale), &quot;illegal imports&quot;);
							}
						}
						// check hypercargo
						var hyper = this.$checkHyperCargo(cmdtylist[j]);
						if (hyper != &quot;&quot;) {
							msg += hyper + &quot;\n&quot;;
							p.setBounty(player.bounty + (this.$getHyperCargoQuantity(cmdtylist[j]) * goods[i].scale), &quot;illegal imports&quot;);
							this._toRemove.push({
								source: &quot;hyper&quot;,
								commodity: cmdtylist[j]
							});
							removecount += 1;
						}
						// try to check the smuggling compartment (but only if it hasn&#39;t already been discovered)
						if (this._removeCompartment === false) {
							for (var k = 0; k &lt; s_cargo.length; k++) {
								if (cmdtylist[j] === s_cargo[k].commodity) {
									if (smuggling_found === true) {
										// found!
										msg += &quot; - &quot; + s_cargo[k].quantity + this.$getCommodityType(s_cargo[k].commodity) + &quot;  &quot; + displayNameForCommodity(s_cargo[k].commodity) + &quot;\n&quot;;
										// apply the bounty here, otherwise it won&#39;t get applied
										p.setBounty(player.bounty + (s_cargo[k].quantity * goods[i].scale), &quot;illegal imports&quot;);
										//s_cargo[k].quantity = 0;
										this._removeCompartment = true;
										removecount += 1;
									} else {
										successcount += 1;
										successmsg += (successmsg === &quot;&quot; ? &quot;&quot; : &quot; and &quot;) + displayNameForCommodity(s_cargo[k].commodity);
									}
								}
							}
						}
					}
				} else {
					var found = false;
					// for any visible cargo (ie not in the cargo hold) for which the player has a permit, we need to refund the bounty
					for (var j = 0; j &lt; cmdtylist.length; j++) {
						// do we have any of this commodity in our hold?
						if (p.manifest[cmdtylist[j]] &gt; 0) {
							p.setBounty(player.bounty - (p.manifest[cmdtylist[j]] * goods[i].scale), &quot;import permit&quot;);
							found = true;
						} else {
							// check that this cargo wasn&#39;t removed by the contracts system
							for (var k = 0; k &lt; this._dockIllegal.length; k++) {
								if (this._dockIllegal[k].commodity === cmdtylist[j]) found = true;
							}
						}
						// check hypercargo
						var hyper = this.$checkHyperCargo(cmdtylist[j]);
						if (hyper != &quot;&quot;) {
							found = true;
						}

						if (this._removeCompartment === false) {
							for (var k = 0; k &lt; s_cargo.length; k++) {
								if (cmdtylist[j] === s_cargo[k].commodity &amp;&amp; smuggling_found === true) {
									// found
									found = true;
								}
							}
						}
					}

					// if we had permitted cargo,
					if (found === true) {
						permit_ok += (permit_ok === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + si.$translateCommodityList(goods[i].commodity);
						permit_okcount += 1;
						if (goods[i].commodity.indexOf(&quot;,&quot;) &gt; 0) permit_okcount += 1;
						// turn on flat to make sure a mission screen appears if we&#39;ve adjusted the player&#39;s bounty
						// otherwise the status screen will show an incorrect value in &quot;Legal Status&quot;
						if (msgtype === 0) msgtype = 4;
						// remove any permit whether it worked or not
						si.$removePermit(system.ID, goods[i].commodity);
					}
				}
			}
		}

		// special case: where we have illegal cargo just before docking, but don&#39;t now, and no permit.
		// this would mean the contract system removed the cargo after docking
		// we still need to give the player an opportunity to bribe their way to a clean slate.
		if (msgtype === 0 &amp;&amp; this._playerHadIllegals === true &amp;&amp; this.$playerHasIllegalCargo(p.dockedStation) === false) {
			msgtype = 6;
		}

		// found illegal cargo
		if (msg != &quot;&quot;) msgtype = 3;

		// switch to the phase scanner message if that was detected but without any cargo
		if (this._phaseScannerDetected === true) {
			if (msgtype === 0 || msgtype === 4) msgtype = 5;
		}

		if (permit_list != &quot;&quot;) permit_list = permit_list.replace(&quot;, &quot;, &quot; and &quot;);

		var msgTitle = &quot;&quot;;
		var msgBody = &quot;&quot;;
		var bigScreen = false;

		switch (msgtype) {
			case 0:
				if (successcount &gt; 0) {
					msgTitle = &quot;Smuggling Contraband&quot;;
					msgBody = expandDescription(&quot;[smuggling-success]&quot;, {
						cargo: successmsg
					});
				}
				break;
			case 1: //
				msgTitle = &quot;GalCop Customs Alert&quot;;
				msgBody = expandDescription(&quot;[smuggling-fail-1]&quot;, {
						size: this.$smugglingCompartmentSize()
					}) +
					(this._phaseScannerDetected === false ? &quot;&quot; : expandDescription(&quot;[phase-scanner-removal]&quot;)) +
					expandDescription(&quot;[end-warning]&quot;);
				break;
			case 2:
				msgTitle = &quot;GalCop Customs Alert&quot;;
				msgBody = expandDescription(&quot;[smuggling-fail-2]&quot;, {
						size: this.$smugglingCompartmentSize(),
						commodity: displayNameForCommodity(this._sc_VisibleAs)
					}) +
					(this._phaseScannerDetected === false ? &quot;&quot; : expandDescription(&quot;[phase-scanner-removal]&quot;)) +
					expandDescription(&quot;[end-warning]&quot;);
				break;

			case 3:
				var sections = 0;
				if (permit_failed) sections += 1;
				if (this._removeCompartment) sections += 1;
				if (this._phaseScannerDetected) sections += 1;
				if (sections === 3 || (sections === 2 &amp;&amp; removecount &gt; 4)) bigScreen = true;

				msgTitle = &quot;GalCop Customs Alert&quot;;
				msgBody = expandDescription(&quot;[smuggling-fail-3]&quot;, {
						insert: msg
					}) +
					(permit_failed === false ? &quot;&quot; :
						&quot;\n\nIt should be noted that the permit&quot; + (permit_multi &gt; 1 ? &quot;s&quot; : &quot;&quot;) + &quot; you had for &quot; + permit_list + (permit_multi === 1 ? &quot; was&quot; : &quot; were&quot;) +
						&quot; found to be &quot; + (permit_multi &gt; 1 ? &quot;fabrications.&quot; : &quot;a fabrication.&quot;)) +
					(this._removeCompartment === false ? &quot;&quot; : expandDescription(&quot;[smuggling-compartment-removal]&quot;, {
						size: this.$smugglingCompartmentSize()
					})) +
					(this._phaseScannerDetected === false ? &quot;&quot; : expandDescription(&quot;[phase-scanner-removal]&quot;)) +
					expandDescription(&quot;[end-warning]&quot;);
				break;
			case 4:
				msgTitle = &quot;GalCop Customs&quot;;
				msgBody = expandDescription(&quot;[smuggling_permit]&quot;, {
					cargo: permit_ok,
					permits: (permit_okcount === 1 ? &quot;permit&quot; : &quot;permits&quot;)
				});
				break;
			case 5:
				msgTitle = &quot;GalCop Customs Alert&quot;;
				msgBody = expandDescription(&quot;[phase-scanner-removal-main]&quot;);
				break;
			case 6:
				msgTitle = &quot;GalCop Customs Alert&quot;;
				msgBody = expandDescription(&quot;[smuggling-fail-4]&quot;);
				break;
		}

		if (msgtype &gt;= 1 &amp;&amp; msgtype &lt;= 6 &amp;&amp; msgtype != 4) {
			this._hudHidden = p.hudHidden;
			if (bigScreen === true &amp;&amp; this.$isBigGuiActive() === false) {
				p.hudHidden = true;
				this._smugglingScreen = true;
			}

			var curChoices = {};
			curChoices[&quot;01_BRIBE&quot;] = {
				text: &quot;[illegal-attempt-bribe]&quot;,
				color: this._menuColor
			};
			curChoices[&quot;99_ACCEPT&quot;] = {
				text: &quot;[illegal-accept-penalty]&quot;,
				color: this._menuColor
			};

			this._bribeType = 1;
			if (msgtype === 6) this._bribeType = 3;

			var opts = {
				screenID: &quot;docking_with_illegals&quot;,
				title: msgTitle,
				message: msgBody,
				allowInterrupt: false,
				model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
				exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
				choices: curChoices,
				initialChoicesKey: &quot;99_ACCEPT&quot;
			};

			mission.runScreen(opts, this.$bribeScreenHandler, this);
		}

		if (msgtype === 4 || (msgtype === 0 &amp;&amp; successcount &gt; 0)) {
			mission.runScreen({
				screenID: &quot;dock_successful&quot;,
				title: msgTitle,
				message: msgBody,
				model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
				exitScreen: &quot;GUI_SCREEN_STATUS&quot;
			});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$bribeScreenHandler = function $bribeScreenHandler(choice) {
	if (!choice) return;
	if (choice === &quot;99_ACCEPT&quot;) {
		this.$processRemovals();
	}
	if (choice === &quot;98_ACCEPT&quot;) {
		this.$processEquipmentRemovals();
	}
	if (choice === &quot;01_BRIBE&quot;) {
		this.$getBribeAmount()
	}
}

//-------------------------------------------------------------------------------------------------------------
// initialise the F4 screen entries
this.$initInterface = function $initInterface(station) {
	if (this.$hasSmugglingCompartment() === true) {
		station.setInterface(this.name, {
			title: &quot;Smuggling compartment configuration&quot;,
			category: &quot;Ship Systems&quot;,
			summary: &quot;Move cargo into or out of the smuggling compartment, and change the settings of the compartment&quot;,
			callback: this.$showInitialSmugglingConfig.bind(this)
		});
	} else {
		station.setInterface(this.name, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the smuggling compartment is damaged
this.$isCompartmentDamaged = function $isCompartmentDamaged() {
	var eq = this.$getSmugglingCompartmentEquipment();
	if (player.ship.equipmentStatus(eq) === &quot;EQUIPMENT_DAMAGED&quot;) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the smuggling compartment is installed
this.$hasSmugglingCompartment = function $hasSmugglingCompartment() {
	for (var i = 1; i &lt;= this._maxTonnage; i++) {
		var check = player.ship.equipmentStatus(&quot;EQ_SMUGGLING_COMPARTMENT_&quot; + i.toString());
		if (check === &quot;EQUIPMENT_OK&quot; || check === &quot;EQUIPMENT_DAMAGED&quot;) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns the equipment key of the installed compartment
this.$getSmugglingCompartmentEquipment = function $getSmugglingCompartmentEquipment() {
	for (var i = 1; i &lt;= this._maxTonnage; i++) {
		var check = player.ship.equipmentStatus(&quot;EQ_SMUGGLING_COMPARTMENT_&quot; + i.toString());
		if (check === &quot;EQUIPMENT_OK&quot; || check === &quot;EQUIPMENT_DAMAGED&quot;) return &quot;EQ_SMUGGLING_COMPARTMENT_&quot; + i.toString();
	}
	return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// returns the max size of the current compartment
this.$smugglingCompartmentSize = function $smugglingCompartmentSize() {
	for (var i = 1; i &lt;= this._maxTonnage; i++) {
		var check = player.ship.equipmentStatus(&quot;EQ_SMUGGLING_COMPARTMENT_&quot; + i.toString());
		if (check === &quot;EQUIPMENT_OK&quot; || check === &quot;EQUIPMENT_DAMAGED&quot;) return i;
	}
	return 0;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the phase scanner is damaged, otherwise false
this.$isPhaseScannerDamaged = function $isPhaseScannerDamaged() {
	if (player.ship.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the phase scanner is installed (even if damaged), otherwise false
this.$isPhaseScannerInstalled = function $isPhaseScannerInstalled() {
	var check = player.ship.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;);
	if (check === &quot;EQUIPMENT_OK&quot; || check === &quot;EQUIPMENT_DAMAGED&quot;) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// resets smuggling compartment internal data after a compartment is removed
this.$resetCompartmentInfo = function $resetCompartmentInfo(station) {
	var p = player.ship;
	// move any cargo into the main hold
	if (this._sc_Cargo.length &gt; 0) {
		for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
			p.manifest[this._sc_Cargo[i].commodity] += this._sc_Cargo[i].quantity;
		}
		this._sc_Cargo = [];
	}
	this._sc_VisibleAs = &quot;Food&quot;;
	this._sc_Phase = 1;
	this._sc_TechVersion = 1;
	this.$initInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
// returns the amount of used space in the compartment
this.$usedSpace = function $usedSpace() {
	var t = 0.0;
	for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
		switch (this._sc_Cargo[i].unit) {
			case &quot;t&quot;:
				t += this._sc_Cargo[i].quantity;
				break;
			case &quot;kg&quot;:
				t += (this._sc_Cargo[i].quantity / 1000);
				break;
			case &quot;g&quot;:
				t += (this._sc_Cargo[i].quantity / 1000000);
				break;
		}
	}
	return t;
}

//-------------------------------------------------------------------------------------------------------------
// returns the amount of available space in the compartment
this.$availableSpace = function $availableSpace() {
	var total = this.$smugglingCompartmentSize();
	return (total - this.$usedSpace());
}

//-------------------------------------------------------------------------------------------------------------
// clean up any zero amounts
this.$cargoCleanUp = function $cargoCleanUp() {
	for (var i = this._sc_Cargo.length - 1; i &gt;= 0; i--) {
		if (this._sc_Cargo[i].quantity === 0) {
			this._sc_Cargo.splice(i, 1);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// shows the installation page to select a compartment size
this.$showPurchasePage = function $showPurchasePage() {

	var curChoices = {};
	var p = player.ship;
	var stn = p.dockedStation;
	var rowAdjust = 0;
	var pagesize = 0;

	//this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() === false) {
		p.hudHidden = true;
	}
	this._smugglingScreen = true;

	var text = expandDescription(&quot;[purchase-page-header]&quot;, {
		cash: formatCredits(player.credits, true, true)
	});
	var curr_size = this.$smugglingCompartmentSize();

	// what is the maximum allowed for this vessel (35% of available space, maxing out at 20t)
	var shipmax = parseInt((p.cargoSpaceCapacity + curr_size) * 0.35);
	// make sure we can get at least 1tc
	if ((p.cargoSpaceCapacity + curr_size) &gt; 0 &amp;&amp; shipmax === 0) shipmax = 1;
	// make sure we don&#39;t go over the 20 tc limit
	if (shipmax &gt; this._maxTonnage) shipmax = this._maxTonnage;

	var max;
	var check = (p.cargoSpaceAvailable + curr_size);
	if (check &lt; 0) {
		max += check;
	} else {
		max = check;
	}
	if (max &gt; this._maxTonnage) max = this._maxTonnage;

	if (curr_size &gt; 0) {
		text += expandDescription(&quot;[downgrade-warning]&quot;);
		rowAdjust += 2;
	}

	pagesize = 23 - rowAdjust;

	var count = 0;

	for (var i = 1; i &lt;= this._maxTonnage; i++) {
		var eq = EquipmentInfo.infoForKey(&quot;EQ_SMUGGLING_COMPARTMENT_&quot; + i.toString());
		var inst_time = ((600 + (eq.price * stn.equipmentPriceFactor)) / 60) / 60;
		var price = (eq.price / 10) * stn.equipmentPriceFactor;
		var menuitem = this.$padTextLeft(i + &quot; t capacity&quot;, 6) + this.$padTextLeft(formatCredits(price, true, true), 7) + this.$padTextLeft(inst_time.toFixed(2) + &quot; hours installation time&quot;, 15);
		if (i &lt;= shipmax) {
			count += 1;
			if (i != curr_size &amp;&amp; i &lt;= max &amp;&amp; player.credits &gt;= price) {
				curChoices[&quot;01_HOLD_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + i] = {
					text: menuitem,
					alignment: &quot;LEFT&quot;,
					color: this._menuColor
				};
			} else {
				curChoices[&quot;01_HOLD_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + i] = {
					text: menuitem,
					alignment: &quot;LEFT&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			}
		}
	}

	curChoices[&quot;98_SPACER&quot;] = &quot;&quot;;
	curChoices[&quot;99_EXIT&quot;] = {
		text: &quot;[exit-no-change]&quot;,
		color: this._itemColor
	};
	var def = &quot;99_EXIT&quot;;

	if ((count + 1) &lt; pagesize) {
		for (var i = (pagesize - (count + 1)); i &gt; 0; i--) {
			curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
		}
	}

	var opts = {
		screenID: &quot;oolite-smuggling-purchase-map&quot;,
		title: &quot;Smuggling Compartment Installation&quot;,
		allowInterrupt: true,
		overlay: {
			name: &quot;stgu-cupboard.png&quot;,
			height: 546
		},
		exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
		choices: curChoices,
		initialChoicesKey: def,
		message: text
	};

	mission.runScreen(opts, this.$purchaseScreenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$purchaseScreenHandler = function $purchaseScreenHandler(choice) {

	if (!choice) return;

	if (choice.indexOf(&quot;01_HOLD&quot;) &gt;= 0) {
		var p = player.ship;
		var stn = p.dockedStation;

		var newsize = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));

		var newEq = this._equipmentList[newsize - 1];
		var oldEq = this.$getSmugglingCompartmentEquipment();

		// truncate any existing cargo
		if (newsize &lt; this.$usedSpace()) {
			var diff = this.$usedSpace - newsize;
			do {
				for (var i = this._sc_Cargo.length; i &gt;= 0; i--) {
					if (diff &gt; 0) {
						switch (this._sc_Cargo[i].unit) {
							case &quot;t&quot;:
								this._sc_Cargo[i].quantity -= 1;
								diff -= 1;
								break;
							case &quot;kg&quot;:
								if (this._sc_Cargo[i].quantity &gt; 1000) {
									this._sc_Cargo[i].quantity -= 1000;
									diff -= 1;
								}
								break;
							case &quot;g&quot;:
								if (this._sc_Cargo[i].quantity &gt; 1000000) {
									this._sc_Cargo[i].quantity -= 1000000;
									diff -= 1;
								}
						}
					}
				}
			} while (diff &gt; 0);

			this.$cargoCleanUp();
		}

		// remove the old one (if present)
		if (oldEq != &quot;&quot;) {
			this._backdoor = true;
			p.removeEquipment(oldEq);
			this._backdoor = false;
			// refund the price of the old version
			var oldEqInfo = EquipmentInfo.infoForKey(oldEq);
			player.credits += ((oldEqInfo.price / 10) * stn.equipmentPriceFactor);
		}
		// install the new one
		p.awardEquipment(newEq);
		p.awardEquipment(&quot;EQ_SMUGGLING_INFLIGHT_STORAGE&quot;);

		var eq = EquipmentInfo.infoForKey(newEq);
		var inst_time = 600 + (eq.price * stn.equipmentPriceFactor);
		var price = (eq.price / 10) * stn.equipmentPriceFactor;

		// charge the player
		player.credits -= price;
		// add the smuggler role to the player
		player.setPlayerRole(&quot;trader-smuggler&quot;);
		// apply the install time
		clock.addSeconds(inst_time);

		// if StationDockControl is installed, tell it to check for launched ships and repopulate
		var sdc = worldScripts.StationDockControl;
		if (sdc &amp;&amp; sdc._disable === false) sdc.$checkForLaunchedShips();

		this.$initInterface(stn);
		this._sc_Days = 0;

		// make sure the right email is sent to the player
		var email = worldScripts.GalCopAdminServices;
		if (email) {
			email._boughtKey = newEq;
			email.$playerBoughtEquip();
		}
	}

}

//-------------------------------------------------------------------------------------------------------------
// initial entry point for the smuggling compartment config screen
this.$showInitialSmugglingConfig = function $showInitialSmugglingConfig() {
	this._display = 0;
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// main config screen display
this.$showSmugglingConfig = function $showSmugglingConfig() {
	function compare(a, b) {
		if ((a.gov * 100) + a.tl &lt; (b.gov * 100) + b.tl) return -1;
		if ((a.gov * 100) + a.tl &gt; (b.gov * 100) + b.tl) return 1;
		return 0;
	}

	var text = &quot;&quot;;
	var curChoices = {};
	var p = player.ship;

	var pagesize = 26;
	var phaseSetting = false;
	if (p.equipmentStatus(&quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;) === &quot;EQUIPMENT_OK&quot;) phaseSetting = true;

	this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() === false) p.hudHidden = true;
	this._smugglingScreen = true;

	if (this.$isCompartmentDamaged() === true) this._display = 10;

	// main display
	if (this._display === 0) {
		var lines = 5;
		text = expandDescription(&quot;[total-capacity-header]&quot;) + this.$smugglingCompartmentSize() + &quot; t    &quot; + Math.floor(this.$usedSpace()) + &quot; t used.\n&quot;;
		text += expandDescription(&quot;[visible-as-header]&quot;) + displayNameForCommodity(this._sc_VisibleAs) + &quot;     &quot;;
		if (phaseSetting) text += &quot;Phase: &quot; + this._sc_Phase + &quot; mHz     &quot;;
		text += expandDescription(&quot;[tech-version-header]&quot;) + this._sc_TechVersion + &quot;.0\n&quot;;
		if (this._sc_Days &gt;= 20) {
			text += expandDescription(&quot;[tech-version-warning]&quot;);
			lines += 1;
		}
		text += &quot;\n&quot;;
		lines += 6;
		if (phaseSetting === false) lines -= 1;

		var cargo = this.$getSmugglingCargo();
		if (cargo.length &gt; 0) {
			text += expandDescription(&quot;[smuggling-current-contents]&quot;);
			lines += 1;
			var additem = &quot;&quot;;
			for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
				if (additem === &quot;&quot;) {
					additem += &quot;  &quot; + this.$padTextRight(this._sc_Cargo[i].quantity + &quot; &quot; + this._sc_Cargo[i].unit + &quot;  &quot; + displayNameForCommodity(this._sc_Cargo[i].commodity), 17);
				} else {
					additem += this._sc_Cargo[i].quantity + &quot; &quot; + this._sc_Cargo[i].unit + &quot;  &quot; + displayNameForCommodity(this._sc_Cargo[i].commodity);
					text += additem + &quot;\n&quot;;
					lines += 1;
					additem = &quot;&quot;;
				}
			}
			if (additem != &quot;&quot;) {
				text += additem + &quot;\n&quot;;
				lines += 1;
			}
		} else {
			text += expandDescription(&quot;[smuggling-no-contents]&quot;);
			lines += 2;
		}

		if (phaseSetting) {
			curChoices[&quot;01_SET_PHASE&quot;] = {
				text: &quot;[smuggling-set-phase]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;02_VIEW_DISCOVERED&quot;] = {
			text: &quot;[smuggling-view-phase]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;03_SET_VISIBLE&quot;] = {
			text: &quot;[smuggling-set-visible-as]&quot;,
			color: this._menuColor
		};

		var avail = this.$availableSpace();
		var used = this.$usedSpace();

		if (this.$playerHasCargo() === true &amp;&amp; avail &gt; 0) {
			curChoices[&quot;04_MOVE_CARGO_IN&quot;] = {
				text: &quot;[smuggling-move-in]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;04_MOVE_CARGO_IN&quot;] = {
				text: &quot;[smuggling-move-in]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		if (used &gt; 0) {
			curChoices[&quot;05_MOVE_CARGO_OUT&quot;] = {
				text: &quot;[smuggling-move-out]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;05_MOVE_CARGO_OUT&quot;] = {
				text: &quot;[smuggling-move-out]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		if (used &gt; 0) {
			curChoices[&quot;06_SELL_CARGO&quot;] = {
				text: &quot;[smuggling-sell-from]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;06_SELL_CARGO&quot;] = {
				text: &quot;[smuggling-sell-from]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		if (avail &gt; 0) {
			curChoices[&quot;07_BUY_CARGO&quot;] = {
				text: &quot;[smuggling-buy-in]&quot;,
				color: this._menuColor
			};
		} else {
			curChoices[&quot;07_BUY_CARGO&quot;] = {
				text: &quot;[smuggling-buy-in]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}

		//curChoices[&quot;70_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[smuggling-exit-config]&quot;,
			color: this._itemColor
		};

		pagesize = 26;
		if (lines &lt; pagesize) {
			for (var i = (pagesize - lines); i &gt; 0; i--) {
				curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
			}
		}

		var def = &quot;99_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-config-summary&quot;,
			title: &quot;Smuggling Compartment Configuration&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// set visible property
	if (this._display === 1) {
		text = expandDescription(&quot;[visible-as-property]&quot;, {
			commodity: displayNameForCommodity(this._sc_VisibleAs)
		});

		for (var i = 0; i &lt; this._commodityIDList.length; i++) {
			if (this._sc_VisibleAs === this._commodityIDList[i]) {
				curChoices[&quot;40_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + this._commodityIDList[i]] = {
					text: displayNameForCommodity(this._commodityIDList[i]),
					color: this._disabledColor,
					unselectable: true
				};
			} else {
				curChoices[&quot;40_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + this._commodityIDList[i]] = {
					text: displayNameForCommodity(this._commodityIDList[i]),
					color: this._menuColor
				};
			}
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[exit-no-change]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-config-map&quot;,
			title: &quot;Smuggling Compartment Configuration&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	if (this._display === 2) { // move cargo in

		var avail = this.$availableSpace();
		text = expandDescription(&quot;[move-cargo-in]&quot;, {
			smuggling: Math.floor(avail),
			standard: p.cargoSpaceAvailable
		});

		pagesize = 20;

		var cargo = p.manifest.list;
		var sdm = worldScripts.Smugglers_DockMaster;
		var itemcount = 0;

		for (var i = 0; i &lt; cargo.length; i++) {
			// only show standard (non-OXP) commodity items
			if (this._commodityIDList.indexOf(cargo[i].commodity) &gt;= 0) {
				var q = cargo[i].quantity;
				// make sure we don&#39;t move relabelled cargo
				if (sdm._cargoLabelled.length &gt; 0) {
					for (var j = 0; j &lt; sdm._cargoLabelled.length; j++) {
						if (sdm._cargoLabelled[j].newCommodity === cargo[i].commodity) q -= sdm._cargoLabelled[j].quantity;
					}
				}
				// don&#39;t allow scooped escape pods to be moved
				if (cargo[i].commodity === &quot;slaves&quot; &amp;&amp; cargo[i].quantity &gt; 0 &amp;&amp; worldScripts.EscapePodTweaks &amp;&amp; worldScripts.EscapePodTweaks._heldPods.length &gt; 0) {
					q -= worldScripts.EscapePodTweaks._heldPods;
				}

				if (q &gt; 0) {
					curChoices[&quot;50_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;_CARGO~&quot; + cargo[i].commodity] = {
						text: cargo[i].displayName + &quot; (&quot; + q + cargo[i].unit + &quot;)&quot;,
						color: this._menuColor
					};
					itemcount += 1;
				}
			}
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 1; i &lt;= (pagesize - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
		}

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-movecargoin-map&quot;,
			title: &quot;Smuggling Compartment Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	if (this._display === 3) { // move cargo out

		var avail = this.$availableSpace();
		text = expandDescription(&quot;[move-cargo-out]&quot;, {
			smuggling: Math.floor(avail),
			standard: p.cargoSpaceAvailable
		});

		pagesize = 20;

		var cargo = this.$getSmugglingCargo();

		for (var i = 0; i &lt; cargo.length; i++) {
			if ((p.cargoSpaceAvailable === 0 &amp;&amp; cargo[i].unit != &quot;t&quot;) || p.cargoSpaceAvailable &gt; 0) {
				curChoices[&quot;51_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;_CARGO~&quot; + cargo[i].commodity] = {
					text: cargo[i].quantity + &quot; &quot; + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
					color: this._menuColor
				};
			}
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 1; i &lt;= (pagesize - cargo.length); i++) {
			curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
		}
		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-movecargoout-map&quot;,
			title: &quot;Smuggling Compartment Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	if (this._display === 4) { // view discovered phase settings

		// look for and remove any TL0 items in the list
		// why are we doing this???
		//for (var i = this._phaseScanDiscovery.length - 1; i &gt;= 0; i--) {
		//	if (this._phaseScanDiscovery[i].tl === 0) {
		//		this._phaseScanDiscovery.splice(i, 1);
		//	}
		//}
		// sort the list by government/techlevel
		this._phaseScanDiscovery.sort(compare);

		var govs = new Array();
		for (var i = 0; i &lt; 8; i++)
			govs.push(String.fromCharCode(i));
		var spc = String.fromCharCode(31);

		text = expandDescription(&quot;[discovered-phase-scans]&quot;);

		if (this._phaseScanDiscovery.length === 0) {
			text += &quot;  None&quot;;
		} else {
			for (var i = 0; i &lt; 24; i++) {
				if (this._phaseScanDiscovery.length - 1 &gt;= i &amp;&amp; this._phaseScanDiscovery[i].phase != 0) {
					text += this.$padTextRight(govs[this._phaseScanDiscovery[i].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i].tl + 1) + &quot;:&quot;, 3.7) + this.$padTextRight(this._phaseScanDiscovery[i].phase, 3);
				}
				if (this._phaseScanDiscovery.length - 1 &gt;= (i + 24) &amp;&amp; this._phaseScanDiscovery[i + 24].phase != 0) {
					text += this.$padTextRight(govs[this._phaseScanDiscovery[i + 24].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i + 24].tl + 1) + &quot;:&quot;, 3.7) + this.$padTextRight(this._phaseScanDiscovery[i + 24].phase, 3);
				}
				if (this._phaseScanDiscovery.length - 1 &gt;= (i + 48) &amp;&amp; this._phaseScanDiscovery[i + 48].phase != 0) {
					text += this.$padTextRight(govs[this._phaseScanDiscovery[i + 48].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i + 48].tl + 1) + &quot;:&quot;, 3.7) + this.$padTextRight(this._phaseScanDiscovery[i + 48].phase, 3);
				}
				if (this._phaseScanDiscovery.length - 1 &gt;= (i + 72) &amp;&amp; this._phaseScanDiscovery[i + 72].phase != 0) {
					text += this.$padTextRight(govs[this._phaseScanDiscovery[i + 72].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i + 72].tl + 1) + &quot;:&quot;, 3.7) + this.$padTextRight(this._phaseScanDiscovery[i + 72].phase, 3);
				}
				if (this._phaseScanDiscovery.length - 1 &gt;= (i + 96) &amp;&amp; this._phaseScanDiscovery[i + 96].phase != 0) {
					text += this.$padTextRight(govs[this._phaseScanDiscovery[i + 96].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i + 96].tl + 1) + &quot;:&quot;, 3.7) + this._phaseScanDiscovery[i + 96].phase;
				}
				text += &quot;\n&quot;;
			}
		}

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-discovered-map&quot;,
			title: &quot;Smuggling Compartment Configuration&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// sell cargo from compartment
	if (this._display === 5) {
		text = expandDescription(&quot;[sell-smuggling-cargo]&quot;);

		pagesize = 23;

		if (this._extraMessage) {
			text += &quot;\n(Note: &quot; + this._extraMessage + &quot;)&quot;;
			pagesize -= 1;
			delete this._extraMessage;
		}

		var cargo = this.$getSmugglingCargo();
		var mkt = p.dockedStation.market;

		for (var i = 0; i &lt; cargo.length; i++) {
			curChoices[&quot;52_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;_CARGO~&quot; + cargo[i].commodity] = {
				text: this.$padTextRight(cargo[i].quantity + &quot; &quot; + cargo[i].unit + &quot;  &quot; + cargo[i].displayName, 12) +
					this.$padTextLeft(formatCredits((mkt[cargo[i].commodity].price / 10), true, true), 5),
				color: this._menuColor
			};
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 1; i &lt;= (pagesize - cargo.length); i++) {
			curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
		}
		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-sellcargo-map&quot;,
			title: &quot;Smuggling Compartment Sell Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// buy cargo directly to compartment
	if (this._display === 6) {
		text = expandDescription(&quot;[buy-smuggling-cargo]&quot;);

		pagesize = 23;

		if (this._insufficientFunds &amp;&amp; this._insufficientFunds === true) {
			text += &quot;\n(Note: Insufficient funds to purchase &quot; + displayNameForCommodity(this._tfrCargo) + &quot;.)&quot;;
			pagesize = 22;
		}

		var mkt = p.dockedStation.market;

		var itemorder = 0;
		var itemcount = 0;

		for (var i in mkt) {
			if (this._commodityIDList.indexOf(i) &gt;= 0) {
				if (mkt[i].quantity &gt; 0) {
					itemorder = parseInt(mkt[i].sort_order / 100);
					curChoices[&quot;53_&quot; + (itemorder &lt; 10 ? &quot;0&quot; : &quot;&quot;) + itemorder + &quot;_CARGO~&quot; + i] = {
						text: this.$padTextRight(displayNameForCommodity(i), 8) +
							this.$padTextLeft(formatCredits((mkt[i].price / 10), true, true), 4) +
							this.$padTextLeft(mkt[i].quantity, 4) + &quot; &quot; +
							this.$padTextRight(this.$getCommodityType(i), 2),
						color: this._menuColor
					};
					itemcount += 1;
				}
			}
		}

		curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 1; i &lt;= (pagesize - itemcount); i++) {
			curChoices[&quot;99_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
		}
		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-buycargo-map&quot;,
			title: &quot;Smuggling Compartment Buy Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-cupboard.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	if (this._display === 10) {
		text = expandDescription(&quot;[smuggling-compartment-damaged]&quot;);

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[smuggling-exit-config]&quot;,
			color: this._itemColor
		};

		var opts = {
			screenID: &quot;smuggling_compartment_damaged&quot;,
			title: &quot;Smuggling Compartment Configuration&quot;,
			message: text,
			choices: curChoices,
			overlay: {
				name: &quot;stgu-lock.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
		};

	}
	mission.runScreen(opts, this.$configScreenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$configScreenHandler = function $configScreenHandler(choice) {

	if (!choice) return;

	switch (choice) {
		case &quot;01_SET_PHASE&quot;:
			this.$setPhase();
			break;
		case &quot;02_VIEW_DISCOVERED&quot;:
			this._display = 4;
			break;
		case &quot;03_SET_VISIBLE&quot;:
			this._display = 1;
			break;
		case &quot;04_MOVE_CARGO_IN&quot;:
			this._display = 2;
			break;
		case &quot;05_MOVE_CARGO_OUT&quot;:
			this._display = 3;
			break;
		case &quot;06_SELL_CARGO&quot;:
			this._display = 5;
			break;
		case &quot;07_BUY_CARGO&quot;:
			this._display = 6;
			break;
		case &quot;98_EXIT&quot;:
			this._display = 0;
			break;
	}

	if (choice.indexOf(&quot;40_&quot;) &gt;= 0) {
		this._sc_VisibleAs = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._display = 0;
	}

	var showMain = true;

	if (choice.indexOf(&quot;50_&quot;) &gt;= 0) {
		showMain = false;
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var cargo = player.ship.manifest.list;
		var sdm = worldScripts.Smugglers_DockMaster;

		for (var i = 0; i &lt; cargo.length; i++) {
			if (cargo[i].commodity === this._tfrCargo) {
				var q = cargo[i].quantity;

				// make sure we don&#39;t move relabelled cargo
				if (sdm._cargoLabelled.length &gt; 0) {
					for (var j = 0; j &lt; sdm._cargoLabelled.length; j++) {
						if (sdm._cargoLabelled[j].newCommodity === cargo[i].commodity) q -= sdm._cargoLabelled[j].quantity;
					}
				}

				// don&#39;t allow scooped escape pods to be moved
				if (cargo[i].commodity === &quot;slaves&quot; &amp;&amp; cargo[i].quantity &gt; 0 &amp;&amp; worldScripts.EscapePodTweaks &amp;&amp; worldScripts.EscapePodTweaks._heldPods.length &gt; 0) {
					q -= worldScripts.EscapePodTweaks._heldPods;
				}

				this._tfrCargoName = cargo[i].displayName;
				this._tfrMaxAmount = q;
				this._tfrUnit = cargo[i].unit;
				var avail = this.$smugglingCompartmentSize();
				var used = this.$usedSpace();
				// make sure our max amount set isn&#39;t greater than the cargo space limit
				switch (this._tfrUnit) {
					case &quot;t&quot;:
						if (this._tfrMaxAmount &gt; (avail - used)) {
							this._tfrMaxAmount = avail - used;
						}
						break;
					case &quot;kg&quot;:
						var sub_avail = avail * 1000;
						var sub_used = used * 1000;
						if (this._tfrMaxAmount &gt; (sub_avail - sub_used)) this._tfrMaxAmount = sub_avail - sub_used;
						break;
					case &quot;g&quot;:
						var sub_avail = avail * 1000000;
						var sub_used = used * 1000000;
						if (this._tfrMaxAmount &gt; (sub_avail - sub_used)) this._tfrMaxAmount = sub_avail - sub_used;
						break;
				}
				this.$getTransferAmount(1);
			}
		}
	}

	if (choice.indexOf(&quot;51_&quot;) &gt;= 0) {
		showMain = false;
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var cargo = this.$getSmugglingCargo();
		for (var i = 0; i &lt; cargo.length; i++) {
			if (cargo[i].commodity === this._tfrCargo) {
				this._tfrCargoName = cargo[i].displayName;
				this._tfrMaxAmount = cargo[i].quantity;
				this._tfrUnit = cargo[i].unit;
				var avail = player.ship.cargoSpaceAvailable;
				// make sure our max amount set isn&#39;t greater than the cargo space limit
				switch (this._tfrUnit) {
					case &quot;t&quot;:
						if (this._tfrMaxAmount &gt; avail) this._tfrMaxAmount = avail;
						break;
					case &quot;kg&quot;:
						var sub_avail = avail * 1000;
						if (this._tfrMaxAmount &gt; sub_avail) this._tfrMaxAmount = sub_avail;
						break;
					case &quot;g&quot;:
						var sub_avail = avail * 1000000;
						if (this._tfrMaxAmount &gt; sub_avail) this._tfrMaxAmount = sub_avail;
						break;

				}
				this.$getTransferAmount(2);
			}
		}
	}

	if (choice.indexOf(&quot;52_&quot;) &gt;= 0) {
		showMain = false;
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var cargo = this.$getSmugglingCargo();
		for (var i = 0; i &lt; cargo.length; i++) {
			if (cargo[i].commodity === this._tfrCargo) {
				this._tfrCargoName = cargo[i].displayName;
				this._tfrMaxAmount = cargo[i].quantity;
				var stn = player.ship.dockedStation;
				// limit the max amount by the market capacity
				var check = stn.market[this._tfrCargo].capacity - stn.market[this._tfrCargo].quantity;
				if (this._tfrMaxAmount &gt; check) this._tfrMaxAmount = check;
				// if the max amount we can transfer is zero, return to the previous menu.
				if (this._tfrMaxAmount === 0) {
					this._extraMessage = &quot;Market capacity reached - no more &quot; + cargo[i].displayName + &quot; can be sold.&quot;;
					this.$showSmugglingConfig();
					return;
				}
				this._tfrUnit = cargo[i].unit;
				this.$getTransferAmount(3);
			}
		}
	}

	if (choice.indexOf(&quot;53_&quot;) &gt;= 0) {
		showMain = false;
		this._insufficientFunds = false;
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var cargoItem = player.ship.dockedStation.market[this._tfrCargo];
		this._tfrCargoName = displayNameForCommodity(this._tfrCargo);
		this._tfrUnit = this.$getCommodityType(this._tfrCargo);
		this._tfrMaxAmount = cargoItem.quantity;

		var avail = this.$availableSpace();
		switch (this._tfrUnit) {
			case &quot;t&quot;:
				if (avail &lt; this._tfrMaxAmount) this._tfrMaxAmount = avail;
				break;
			case &quot;kg&quot;:
				var sub_avail = avail * 1000;
				if (sub_avail &lt; this._tfrMaxAmount) this._tfrMaxAmount = sub_avail;
				break;
			case &quot;g&quot;:
				var sub_avail = avail * 1000000;
				if (sub_avail &lt; this._tfrMaxAmount) this._tfrMaxAmount = sub_avail;
				break;
		}
		if ((this._tfrMaxAmount * (cargoItem.price / 10)) &gt; player.credits) {
			do {
				this._tfrMaxAmount -= 1;
			} while ((this._tfrMaxAmount * (cargoItem.price / 10)) &gt; player.credits)
		}
		if (this._tfrMaxAmount &gt; 0) {
			this.$getTransferAmount(4);
		} else {
			showMain = true;
			this._insufficientFunds = true;
		}
	}

	if (choice != &quot;99_EXIT&quot; &amp;&amp; choice != &quot;01_SET_PHASE&quot; &amp;&amp; showMain === true) {
		this.$showSmugglingConfig();
	}

}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player has any cargo at all
this.$playerHasCargo = function $playerHasCargo() {
	var m = player.ship.manifest;
	for (var i = 0; i &lt; m.list.length; i++) {
		if (m.list[i].quantity &gt; 0) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player has any illegal cargo in the visible cargo hold
this.$playerHasIllegalCargo = function $playerHasIllegalCargo(station) {
	var m = player.ship.manifest;
	for (var i = 0; i &lt; m.list.length; i++) {
		if (m.list[i].quantity &gt; 0 &amp;&amp; station.market[m.list[i].commodity].legality_import &gt; 0) {
			return true;
		}
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player has any illegal cargo in their smuggling compartment
this.$playerHasHiddenIllegalCargo = function $playerHasHiddenIllegalCargo(station) {
	var c = this.$getSmugglingCargo();
	var found = false;
	for (var i = 0; i &lt; c.length; i++) {
		if (station.market[c[i].commodity].legality_import &gt; 0) found = true;
	}
	return found;
}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for a new phase
this.$setPhase = function $setPhase() {

	var text = &quot;&quot;;

	text = expandDescription(&quot;[set-phase]&quot;, {
		current: this._sc_Phase
	});

	var opts = {
		screenID: &quot;oolite-smuggling-setphase-map&quot;,
		title: &quot;Smuggling Compartment Configuration&quot;,
		allowInterrupt: false,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		message: text,
		textEntry: true
	};
	mission.runScreen(opts, this.$getNewPhase, this);
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the setPhase screen
this.$getNewPhase = function $getNewPhase(param) {
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= 999) {
		this._sc_Phase = parseInt(param);
	}
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for the transfer amount
this.$getTransferAmount = function $getTransferAmount(type) {

	var text = &quot;&quot;;

	// don&#39;t show a screen when only 1 unit is possible
	if (this._tfrMaxAmount === 1) {
		switch (type) {
			case 1:
				this.$getCargoTransferIn(1);
				return;
			case 2:
				this.$getCargoTransferOut(1);
				return;
			case 3:
				this.$getCargoSell(1);
				return;
			case 4:
				this.$getCargoBuy(1);
				return;
		}
	}

	switch (type) {
		case 1:
			text = expandDescription(&quot;[enter-quantity-smuggling]&quot;, {
				commodity: this._tfrCargoName,
				quantity: parseInt(this._tfrMaxAmount)
			});
			break;
		case 2:
			text = expandDescription(&quot;[enter-quantity-standard]&quot;, {
				commodity: this._tfrCargoName,
				quantity: parseInt(this._tfrMaxAmount)
			});
			break;
		case 3:
			text = expandDescription(&quot;[enter-quantity-sell]&quot;, {
				commodity: this._tfrCargoName,
				quantity: parseInt(this._tfrMaxAmount)
			});
			break;
		case 4:
			text = expandDescription(&quot;[enter-quantity-buy]&quot;, {
				commodity: this._tfrCargoName,
				quantity: parseInt(this._tfrMaxAmount)
			});
			break;
	}

	var opts = {
		screenID: &quot;oolite-smuggling-transfer-map&quot;,
		title: &quot;Smuggling Compartment Cargo&quot;,
		allowInterrupt: false,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		message: text,
		textEntry: true
	};

	switch (type) {
		case 1:
			mission.runScreen(opts, this.$getCargoTransferIn, this);
			break;
		case 2:
			mission.runScreen(opts, this.$getCargoTransferOut, this);
			break;
		case 3:
			mission.runScreen(opts, this.$getCargoSell, this);
			break;
		case 4:
			mission.runScreen(opts, this.$getCargoBuy, this);
			break;
	}
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen
this.$getCargoTransferIn = function $getCargoTransferIn(param) {
	if (!param) {
		this.$showSmugglingConfig();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._tfrMaxAmount) {
		var amount = parseInt(param);
		this.$addCargoToCompartment(this._tfrCargo, this._tfrCargoName, amount, this._tfrUnit);
		// take the cargo out of the hold
		var p = player.ship;
		p.manifest[this._tfrCargo] -= amount;
	}
	this._display = 2;
	if (this.$availableSpace() === 0) this._display = 0;
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen
this.$getCargoTransferOut = function $getCargoTransferOut(param) {
	if (!param) {
		this.$showSmugglingConfig();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._tfrMaxAmount) {
		var p = player.ship;
		var amount = parseInt(param);
		var starting = p.manifest[this._tfrCargo];
		// put the cargo into the main hold
		p.manifest[this._tfrCargo] += amount;
		// check that the hold actually took all the amount
		if (p.manifest[this._tfrCargo] != (starting + amount)) {
			// if not, adjust the amount of transfer
			amount = p.manifest[this._tfrCargo] - starting;
		}
		var count = 0;
		for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
			if (this._sc_Cargo[i].commodity === this._tfrCargo) {
				this._sc_Cargo[i].quantity -= amount;
				break;
			}
		}
		this.$cargoCleanUp();
	}
	this._display = 3;
	if (this.$usedSpace() === 0) this._display = 0;
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen
this.$getCargoSell = function $getCargoSell(param) {
	if (!param) {
		this.$showSmugglingConfig();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._tfrMaxAmount) {
		var amount = parseInt(param);
		var count = 0;
		var check = 0;
		var p = player.ship;
		var stn = p.dockedStation;
		var mkt = stn.market;
		for (var i = this._sc_Cargo.length - 1; i &gt;= 0; i--) {
			if (this._sc_Cargo[i].commodity === this._tfrCargo) {
				check = mkt[this._tfrCargo].quantity;
				var newamount = check + amount;
				var actual = amount;
				// check that we aren&#39;t going over the market capacity
				if (newamount &gt; mkt[this._tfrCargo].capacity) {
					newamount = mkt[this._tfrCargo].capacity;
					actual = newamount - check;
				}
				// only do an sell if the actual amount that can be sold is greater than zero
				if (actual &gt; 0) {
					stn.setMarketQuantity(this._tfrCargo, newamount);
					this._sc_Cargo[i].quantity -= actual;
					count += actual;
					player.credits += (mkt[this._tfrCargo].price / 10) * actual;
					this.$playSound(&quot;sell&quot;);
				}
				break;
			}
		}
		this.$cargoCleanUp();
	}
	this._display = 5;
	if (this.$usedSpace() === 0) this._display = 0;
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen
this.$getCargoBuy = function $getCargoBuy(param) {
	if (!param) {
		this.$showSmugglingConfig();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._tfrMaxAmount) {
		var amount = parseInt(param);
		this.$addCargoToCompartment(this._tfrCargo, this._tfrCargoName, amount, this._tfrUnit);
		// take the cargo out of the market
		var stn = player.ship.dockedStation;
		var mkt = stn.market;
		var newamount = mkt[this._tfrCargo].quantity - amount;
		stn.setMarketQuantity(this._tfrCargo, newamount);
		player.credits -= (mkt[this._tfrCargo].price / 10) * amount;
		this.$playSound(&quot;buy&quot;);
	}
	this._display = 6;
	if (this.$availableSpace() === 0) this._display = 0;
	this.$showSmugglingConfig();
}

//-------------------------------------------------------------------------------------------------------------
// adds cargo to smuggling compartment
this.$addCargoToCompartment = function $addCargoToCompartment(cmdty, name, amount, unit) {
	var found = false;
	for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
		if (this._sc_Cargo[i].commodity === cmdty) {
			// found it
			found = true;
			this._sc_Cargo[i].quantity += amount;
		}
	}
	if (found === false) {
		this._sc_Cargo.push({
			commodity: cmdty,
			displayName: name,
			quantity: amount,
			unit: unit
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// create system phases
this.$createSystemPhase = function $createSystemPhase() {
	for (var i = 0; i &lt;= 7; i++) {
		for (var j = 1; j &lt;= 15; j++) {
			this._systemPhase.push({
				gov: i,
				tl: j,
				phase: this.$rand(999)
			});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// updates the phase setting for a particular government/techlevel
this.$updatePhase = function $updatePhase(govType, techlevel, phase) {
	for (var i = 0; i &lt; this._systemPhase.length; i++) {
		if (this._systemPhase[i].gov === govType &amp;&amp; this._systemPhase[i].tl === techlevel) {
			this._systemPhase[i].phase = phase;
			this._phaseUpdates.push({
				gov: govType,
				tl: techlevel
			});
			break;
		}
	}
	for (var i = 0; i &lt; this._phaseScanDiscovery.length; i++) {
		if (this._phaseScanDiscovery[i].gov === govType &amp;&amp; this._phaseScanDiscovery[i].tl === techlevel &amp;&amp; this._phaseScanDiscovery[i].source &lt; 3) this._phaseScanDiscovery[i].source = 4;
	}

}

//-------------------------------------------------------------------------------------------------------------
// returns the phase for a given system ID
this.$getSystemPhase = function $getSystemPhase(systemID) {
	var sysinfo = System.infoForSystem(galaxyNumber, systemID);
	var result = 0;
	for (var i = 0; i &lt; this._systemPhase.length; i++) {
		if (this._systemPhase[i].gov === sysinfo.government &amp;&amp; this._systemPhase[i].tl === sysinfo.techlevel) result = this._systemPhase[i].phase;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// removes the current smuggling compartment and empties the cargo stored in  it
this.$removeCompartment = function $removeCompartment() {
	player.ship.removeEquipment(&quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;);
	player.ship.removeEquipment(&quot;EQ_SMUGGLING_INFLIGHT_STORAGE&quot;);
	var eq = this.$getSmugglingCompartmentEquipment();
	if (eq === &quot;&quot;) return;
	this._backdoor = true;
	player.ship.removeEquipment(eq);
	this._backdoor = false;
	this._sc_Cargo = [];
	this._sc_VisibleAs = &quot;Food&quot;;
	this._sc_Phase = 1;
	this._sc_TechVersion = 1;
}

//-------------------------------------------------------------------------------------------------------------
// returns a summarised version of the smuggling compartment cargo
this.$getSmugglingCargo = function $getSmugglingCargo() {
	var cargo = [];
	for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
		var found = false;
		for (var j = 0; j &lt; cargo.length; j++) {
			if (cargo[j].commodity === this._sc_Cargo[i].commodity) {
				cargo[j].quantity += this._sc_Cargo[i].quantity;
				found = true;
			}
		}
		if (found === false) {
			cargo.push({
				commodity: this._sc_Cargo[i].commodity,
				displayName: this._sc_Cargo[i].displayName,
				quantity: this._sc_Cargo[i].quantity,
				unit: this._sc_Cargo[i].unit
			});
		}
	}
	return cargo;
}

//-------------------------------------------------------------------------------------------------------------
// returns how much of a particular commodity is in the smuggling compartment
this.$getCargoQuantity = function $getCargoQuantity(commodity) {
	var cargo = this.$getSmugglingCargo();
	var result = 0;
	for (var i = 0; i &lt; cargo.length; i++) {
		if (cargo[i].commodity === commodity) result = cargo[i].quantity;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// removes an given amount of a particular commodity
this.$removeCargo = function $removeCargo(commodity, quantity) {
	var sum = quantity;
	for (var i = this._sc_Cargo.length - 1; i &gt;= 0; i--) {
		if (this._sc_Cargo[i].commodity === commodity &amp;&amp; sum &gt; 0) {
			if (this._sc_Cargo[i].quantity &gt;= sum) {
				this._sc_Cargo[i].quantity -= sum;
				sum = 0;
			} else {
				sum -= this._sc_Cargo[i].quantity;
				this._sc_Cargo[i].quantity = 0;
			}
		}
	}
	this.$cargoCleanUp();
	// return any remainder
	return sum;
}

//-------------------------------------------------------------------------------------------------------------
// adds a phase scan setting to our discovered list
// source 1 = from phase scanner, 2 = purchased from black market, 3 = overheard in rumours, 4 = updated after scan
this.$addPhaseScan = function $addPhaseScan(phase, systemID, source) {
	//log(this.name, &quot;checking &quot; + system.ID);
	//log(this.name, &quot;data: &quot; + systemID + &quot;, &quot; + source);
	var sysinfo = System.infoForSystem(galaxyNumber, systemID);
	var found = false;
	for (var i = 0; i &lt; this._phaseScanDiscovery.length; i++) {
		if (this._phaseScanDiscovery[i].gov === sysinfo.government &amp;&amp; this._phaseScanDiscovery[i].tl === sysinfo.techlevel) {
			found = true;
			this._phaseScanDiscovery[i].phase = phase;
			// if the previous value was just a remour, or changed, update it now
			if (this._phaseScanDiscovery[i].source &gt;= 3 &amp;&amp; source &lt; 3) this._phaseScanDiscovery[i].source = source;
		}
	}
	if (found === false) {
		this._phaseScanDiscovery.push({
			gov: sysinfo.government,
			tl: sysinfo.techlevel,
			phase: phase,
			source: source
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the player has a reliable phase scan for a given system
this.$playerHasPhaseScan = function $playerHasPhaseScan(sysID) {
	var sysinfo = System.infoForSystem(galaxyNumber, sysID);
	var result = false;
	for (var i = 0; i &lt; this._phaseScanDiscovery.length; i++) {
		if (this._phaseScanDiscovery[i].gov === sysinfo.government &amp;&amp; this._phaseScanDiscovery[i].tl === sysinfo.techlevel &amp;&amp; this._phaseScanDiscovery[i].source &lt; 3) result = true;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// returns the number of sellable phase scans the player has
this.$sellablePhaseScans = function $sellablePhaseScans() {
	var list = this.$getSellablePhaseScans();
	return list.length;
}

//-------------------------------------------------------------------------------------------------------------
// get a list of sellable phase scan settings for the black market
// note: will only return scans within 7ly of current system
this.$getSellablePhaseScans = function $getSellablePhaseScans() {
	function compare(a, b) {
		if ((a.gov * 100) + a.tl &lt; (b.gov * 100) + b.tl) return -1;
		if ((a.gov * 100) + a.tl &gt; (b.gov * 100) + b.tl) return 1;
		return 0;
	}

	this._phaseScanDiscovery.sort(compare);

	var govs = new Array();
	for (var i = 0; i &lt; 8; i++)
		govs.push(String.fromCharCode(i));
	var spc = String.fromCharCode(31);
	var list = [];
	var added = [];
	// you can only sell phase scans for the local area
	var sys = System.infoForSystem(galaxyNumber, system.ID).systemsInRange(7);

	for (var i = 0; i &lt; this._phaseScanDiscovery.length; i++) {
		if (this._phaseScanDiscovery[i].source === 1) {
			for (var j = 0; j &lt; sys.length; j++) {
				// does this scan match a local system, and have we already added this variation?
				if (sys[j].government === this._phaseScanDiscovery[i].gov &amp;&amp; sys[j].techlevel === this._phaseScanDiscovery[i].tl &amp;&amp; added.indexOf((sys[j].government * 100) + sys[j].techlevel) === -1) {
					list.push({
						text: this.$padTextRight(govs[this._phaseScanDiscovery[i].gov] + spc + &quot;TL&quot; + (this._phaseScanDiscovery[i].tl + 1) + &quot;:&quot;, 3.7) + this.$padTextRight(this._phaseScanDiscovery[i].phase, 3),
						gov: this._phaseScanDiscovery[i].gov,
						tl: this._phaseScanDiscovery[i].tl
					});
					// add the signature to the added list so we can easily check if it&#39;s there already
					added.push((sys[j].government * 100) + sys[j].techlevel);
				}
			}
		}
	}
	return list;
}

//-------------------------------------------------------------------------------------------------------------
// switches a source = 1 to source = 0 for a particular phase scan
this.$sellPhaseScan = function $sellPhaseScan(govrn, techlvl) {
	for (var i = 0; i &lt; this._phaseScanDiscovery.length; i++) {
		if (this._phaseScanDiscovery[i].gov === govrn &amp;&amp; this._phaseScanDiscovery[i].tl === techlvl &amp;&amp; this._phaseScanDiscovery[i].source === 1) {
			this._phaseScanDiscovery[i].source = 0;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// gets the commodity type for a particular commodity (t , kg or g)
this.$getCommodityType = function $getCommodityType(good) {
	switch (good) {
		case &quot;gold&quot;:
		case &quot;platinum&quot;:
			return &quot;kg&quot;;
		case &quot;gem_stones&quot;:
			return &quot;g&quot;;
		default:
			return &quot;t&quot;;
	}
}

//=============================================================================================================
// hypercargo integration routines

//-------------------------------------------------------------------------------------------------------------
// returns a list of commodity items that are illegal, based on a commodity list
this.$checkHyperCargo = function $checkHyperCargo(commodity) {
	var returnData = &quot;&quot;;
	if (missionVariables.hyperCargoMemory === &quot;EMPTY&quot;) return &quot;&quot;;
	if (!worldScripts[&quot;HyperCargo&quot;]) return &quot;&quot;; // just in case hypercargo OXP was removed after being installed for a while
	var hc = worldScripts[&quot;HyperCargo&quot;];
	for (var i = 0; i &lt; 14; i++) {
		var cargoItem = hc.cargoNameArray[i];
		if (commodity === cargoItem &amp;&amp; hc.storedArray[i] &gt; 0) {
			var cargoCount = hc.storedArray[i];
			returnData = &quot; - &quot; + cargoCount + &quot; &quot; + this.$getCommodityType(cargoItem) + &quot;  &quot; + displayNameForCommodity(cargoItem) + &quot; (stored in HyperCargo)&quot;;
		}
	}
	return returnData;
}

//-------------------------------------------------------------------------------------------------------------
// returns the quantity of a particular commodity
this.$getHyperCargoQuantity = function $getHyperCargoQuantity(commodity) {
	var returnData = &quot;&quot;;
	if (missionVariables.hyperCargoMemory === &quot;EMPTY&quot;) return 0;
	if (!worldScripts[&quot;HyperCargo&quot;]) return 0; // just in case hypercargo OXP was removed after being installed for a while
	var hc = worldScripts[&quot;HyperCargo&quot;];
	for (var i = 0; i &lt; 14; i++) {
		var cargoItem = hc.cargoNameArray[i];
		if (commodity === cargoItem &amp;&amp; hc.storedArray[i] &gt; 0) {
			return hc.storedArray[i];
		}
	}
	return -1;
}

//-------------------------------------------------------------------------------------------------------------
// removes illegal cargo from hypercargo and applies a bounty
this.$updateHyperCargo = function $updateHyperCargo(commodity, def) {
	if (missionVariables.hyperCargoMemory === &quot;EMPTY&quot;) return;
	if (!worldScripts[&quot;HyperCargo&quot;]) return; // just in case hypercargo OXP was removed after being installed for a while
	var hc = worldScripts[&quot;HyperCargo&quot;];
	var p = player.ship;
	for (var i = 0; i &lt; 14; i++) {
		var cargoItem = hc.cargoNameArray[i];
		if (commodity === cargoItem &amp;&amp; hc.storedArray[i]) {
			p.setBounty(player.bounty + (hc.storedArray[i] * def.scale), &quot;illegal imports&quot;);
			hc.storedArray[i] = 0;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// removes an amount of cargo from hypercargo
this.$removeHyperCargo = function $removeHyperCargo(commodity, amount) {
	if (missionVariables.hyperCargoMemory === &quot;EMPTY&quot;) return 0;
	if (!worldScripts[&quot;HyperCargo&quot;]) return 0; // just in case hypercargo OXP was removed after being installed for a while
	var hc = worldScripts[&quot;HyperCargo&quot;];
	for (var i = 0; i &lt; 14; i++) {
		var cargoItem = hc.cargoNameArray[i];
		if (commodity === cargoItem &amp;&amp; hc.storedArray[i] &gt; 0) {
			if (hc.storedArray[i] &gt;= amount) {
				hc.storedArray[i] -= amount;
				return 0;
			} else {
				var remain = amount - hc.storedArray[i];
				hc.storedArray[i] = 0;
				return remain;
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for a new phase
this.$getBribeAmount = function $getBribeAmount() {

	var text = &quot;&quot;;
	var sdm = worldScripts.Smugglers_DockMaster;
	var inttype = Math.floor((sdm._bribeChance[system.ID] * 4) + 1);
	var inttypedesc = expandDescription(&quot;[interest-type&quot; + inttype + &quot;]&quot;);
	var lastBribe = sdm.$previousBribeAmount();
	text = expandDescription(&quot;[dockmaster-question]&quot;, {
			interesttype: inttypedesc
		}) + &quot;\n\n&quot; +
		&quot;(&quot; + expandDescription(&quot;[dockmaster-cost]&quot;, {
			credits: formatCredits(player.credits, false, true)
		}) +
		(lastBribe &gt; 0 ? expandDescription(&quot;[dockmaster-lastbribe]&quot;, {
			bribeamount: formatCredits(lastBribe, false, true)
		}) : &quot;&quot;) + &quot;)&quot;;

	var opts = {
		screenID: &quot;smuggling_bribe&quot;,
		title: &quot;Bribing Official&quot;,
		allowInterrupt: false,
		model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
		exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
		message: text,
		textEntry: true
	};

	mission.runScreen(opts, this.$getBribeAmountInput, this);
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getBribeAmount screen
this.$getBribeAmountInput = function $getBribeAmountInput(param) {

	var sdm = worldScripts.Smugglers_DockMaster;
	var p = player.ship;
	sdm._bribeAttempted = true;

	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= player.credits) {
		var amount = parseInt(param);
		// will this work
		var chance = sdm._bribeChance[system.ID];
		// higher amounts are more likely to be accepted
		// chance of 0.5 would mean you would need to offer them 256 credits
		//if (this._debug) log(this.name, &quot;min bribe amount = &quot; + (Math.pow(parseInt(chance * 32), 1.8) * (1 + system.productivity / 56300) * sdm._bribeCount[system.ID]));
		if ((Math.pow(parseInt(chance * 32), 1.8) * (1 + system.productivity / 56300) * sdm._bribeCount[system.ID]) &lt;= amount) {
			player.credits -= amount;
			sdm.$addBribe(system.ID);
			sdm._successfulBribes.push({
				system: system.ID,
				bribeAmount: amount
			});
			p.setBounty(this._savedBounty, &quot;bribe&quot;);
			mission.runScreen({
				screenID: &quot;smuggling_bribe&quot;,
				title: &quot;Bribing Official&quot;,
				model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
				message: expandDescription(&quot;[dockmaster-complete]&quot;),
				exitScreen: &quot;GUI_SCREEN_STATUS&quot;
			});
		} else {
			if (this._bribeType === 1) this.$processRemovals();
			if (this._bribeType === 2) this.$processEquipmentRemovals();
			if (Math.random() &gt; chance) {
				mission.runScreen({
					screenID: &quot;smuggling_bribe&quot;,
					title: &quot;Bribing Official&quot;,
					model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
					message: expandDescription(&quot;[dockmaster-angry-nopenalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_STATUS&quot;
				});

			} else {
				var penalty = (worldScripts.Smugglers_CoreFunctions.$rand(10) + 3);
				p.setBounty(player.bounty + penalty, &quot;attempted bribe&quot;);
				mission.runScreen({
					screenID: &quot;smuggling_bribe&quot;,
					title: &quot;Bribing Official&quot;,
					model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
					message: expandDescription(&quot;[dockmaster-angry-penalty]&quot;),
					exitScreen: &quot;GUI_SCREEN_STATUS&quot;
				});

				// send email (if installed)
				var email = worldScripts.EmailSystem;
				if (email) {
					var ga = worldScripts.GalCopAdminServices;
					email.$createEmail({
						sender: &quot;GalCop Customs&quot;,
						subject: &quot;Attempt to bribe official&quot;,
						date: clock.seconds,
						message: expandDescription(&quot;[smugglers-failed-bribe-email]&quot;, {
							legal_penalty: penalty,
							stationname: player.ship.dockedStation.displayName,
							systemname: System.systemNameForID(system.ID)
						}),
						expiryDays: ga._defaultExpiryDays
					});
				}
			}
		}
	} else {
		if (this._bribeType === 1) this.$processRemovals();
		if (this._bribeType === 2) this.$processEquipmentRemovals();
		mission.runScreen({
			screenID: &quot;smuggling_bribe&quot;,
			title: &quot;Bribing Official&quot;,
			model: &quot;[&quot; + this._policeModel + &quot;]&quot;,
			message: expandDescription(&quot;[dockmaster-skipbribe]&quot;),
			exitScreen: &quot;GUI_SCREEN_STATUS&quot;
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// processes any cargo and/or smuggling compartment removals after docking
this.$processRemovals = function $processRemovals() {
	var emailText = &quot;&quot;;
	var p = player.ship;
	if (this._removeCompartment === true) {
		// remove smuggling compartment and contents
		emailText += &quot;- removal of scanner-resistant cargo compartment.\n&quot;;
		this.$removeCompartment();
	}
	if (this._phaseScannerDetected === true) {
		emailText += &quot;- removal of illegal phase scanner.\n&quot;;
		p.removeEquipment(&quot;EQ_PHASE_SCANNER&quot;);
	}
	for (var i = 0; i &lt; this._toRemove.length; i++) {
		if (this._toRemove[i].source === &quot;hold&quot;) {
			emailText += &quot;- confiscation of &quot; + p.manifest[this._toRemove[i].commodity] + this.$getCommodityType(this._toRemove[i].commodity) + &quot;  &quot; + displayNameForCommodity(this._toRemove[i].commodity) + &quot; from your cargo hold.\n&quot;;
			p.manifest[this._toRemove[i].commodity] = 0;
		}
		if (this._toRemove[i].source === &quot;hyper&quot;) {
			emailText += &quot;- confiscation of &quot; + p.manifest[this._toRemove[i].commodity] + this.$getCommodityType(this._toRemove[i].commodity) + &quot;  &quot; + displayNameForCommodity(this._toRemove[i].commodity) + &quot; from your hypercargo hold.\n&quot;;
			this.$removeHyperCargo(this._toRemove[i].commodity, this.$getHyperCargoQuantity(this._toRemove[i].commodity));
		}
	}
	if (this._playerFine &gt; 0) {
		if (player.credits &gt; this._playerFine) {
			emailText += &quot;- applied a fine of &quot; + formatCredits(this._playerFine, true, true) + &quot;\n&quot;;
			player.credits -= this._playerFine;
		} else {
			emailText += &quot;- applied a fine of &quot; + formatCredits(player.credits, true, true) + &quot;\n&quot;;
			player.credits = 0;
		}
	}
	this._removeCompartment = false;
	this._phaseScannerDetected = false;

	// send email (if installed)
	if (emailText != &quot;&quot;) {
		var email = worldScripts.EmailSystem;
		if (email) {
			var ga = worldScripts.GalCopAdminServices;
			email.$createEmail({
				sender: &quot;GalCop Customs&quot;,
				subject: &quot;Contraband removal&quot;,
				date: clock.seconds,
				message: expandDescription(&quot;[smugglers-removal-email]&quot;, {
					contraband: emailText,
					stationname: player.ship.dockedStation.displayName,
					systemname: System.systemNameForID(system.ID)
				}),
				expiryDays: ga._defaultExpiryDays
			});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// processes any equipment removals after a renovation
this.$processEquipmentRemovals = function $processEquipmentRemovals() {
	var p = player.ship;
	var emailText = &quot;&quot;;

	if (this.$isPhaseScannerInstalled() === true) {
		emailText = &quot;- removal of illegal phase scanner.\n&quot;;
		p.removeEquipment(&quot;EQ_PHASE_SCANNER&quot;);
	}

	if (this.$hasSmugglingCompartment() === true) {
		// remove compartment and contents
		emailText += &quot;- removal of scanner-resistant cargo compartment.\n&quot;;
		this.$removeCompartment();
	}

	// send email (if installed)
	if (emailText != &quot;&quot;) {
		var email = worldScripts.EmailSystem;
		if (email) {
			var ga = worldScripts.GalCopAdminServices;
			email.$createEmail({
				sender: &quot;GalCop Customs&quot;,
				subject: &quot;Contraband removal&quot;,
				date: clock.seconds,
				message: expandDescription(&quot;[smugglers-removal-email]&quot;, {
					contraband: emailText,
					stationname: player.ship.dockedStation.displayName,
					systemname: System.systemNameForID(system.ID)
				}),
				expiryDays: ga._defaultExpiryDays
			});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// build up an array of values that can be used to determine how many government/techlevel types exist in the system
this.$createSystemDataArray = function $createSystemDataArray() {
	this._systemData = [];
	for (var i = 0; i &lt;= 255; i++) {
		var sys = System.infoForSystem(galaxyNumber, i);
		var item = sys.government * 100 + sys.techlevel;
		if (this._systemData.indexOf(item) === -1) this._systemData.push(item);
	}
}

//-------------------------------------------------------------------------------------------------------------
// updates the manifest screen entry for the smuggling hold contents
this.$updateManifest = function $updateManifest() {
	var list = [];
	var cargo_size = this.$smugglingCompartmentSize();
	if (cargo_size &gt; 0) {
		var damaged = this.$isCompartmentDamaged();
		list.push(&quot;Smuggling Compartment Cargo &quot; + this.$usedSpace().toFixed(0) + &quot; t (&quot; + cargo_size + &quot; t)&quot; + (damaged === true ? &quot; *DAMAGED*&quot; : &quot;&quot;) + &quot;:&quot;);
		var additem = &quot;&quot;;
		for (var i = 0; i &lt; this._sc_Cargo.length; i++) {
			if (additem === &quot;&quot;) {
				additem += this.$padTextRight(this._sc_Cargo[i].quantity + &quot; &quot; + this._sc_Cargo[i].unit + &quot;  &quot; + displayNameForCommodity(this._sc_Cargo[i].commodity), 17);
			} else {
				additem += this._sc_Cargo[i].quantity + &quot; &quot; + this._sc_Cargo[i].unit + &quot;  &quot; + displayNameForCommodity(this._sc_Cargo[i].commodity);
				list.push(additem);
				additem = &quot;&quot;;
			}
		}
		if (additem != &quot;&quot;) list.push(additem);

		if (this._sc_Cargo.length &gt; 0) {
			mission.setInstructions(list, this.name);
		} else {
			list.push(&quot;No cargo carried.&quot;);
			mission.setInstructions(list, this.name);
		}
	} else {
		mission.setInstructions(null, this.name);
	}
}

//-------------------------------------------------------------------------------------------------------------
// play the buy/sell sound effects
this.$playSound = function $playSound(soundtype) {
	var mySound = new SoundSource;

	switch (soundtype) {
		case &quot;buy&quot;:
			mySound.sound = &quot;[buy-commodity]&quot;;
			break;
		case &quot;sell&quot;:
			mySound.sound = &quot;[sell-commodity]&quot;;
			break;
		case &quot;mode&quot;:
			mySound.sound = &quot;[@click]&quot;;
			break;
		case &quot;activate&quot;:
			mySound.sound = &quot;[@beep]&quot;;
			break;
		case &quot;stop&quot;:
			mySound.sound = &quot;[@boop]&quot;;
			break;
	}
	mySound.loop = false;
	mySound.play();
}

//-------------------------------------------------------------------------------------------------------------
// returns the illegal scale factor for a particular commodity at the current docked station
this.$commodityIllegalScale = function $commodityIllegalScale(commodity) {
	var p = player.ship;
	var stn = p.dockedStation;
	var scale = parseInt(stn.market[commodity].legality_import);
	if (scale === 0) scale = parseInt(stn.market[commodity].legality_export);
	return scale;
}

//-------------------------------------------------------------------------------------------------------------
// gets a list of all police ship models so we can use them consistently on smuggling screens
this.$getPoliceModel = function $getPoliceModel() {
	var shipkeys = Ship.keysForRole(&quot;police&quot;);

	if (shipkeys.length === 0) return &quot;viper&quot;;
	var key = &quot;&quot;;
	var tries = 0;
	do {
		key = shipkeys[Math.floor(Math.random() * shipkeys.length)];
		if (this.$modelIsAllowed(key) === false) key = &quot;&quot;;
		tries += 1;
	} while (key === &quot;&quot; &amp;&amp; tries &lt; 5)
	if (key === &quot;&quot;) key = &quot;viper&quot;;
	return key;
}

//-------------------------------------------------------------------------------------------------------------
this.$modelIsAllowed = function $modelIsAllowed(shipkey) {
	var shipdata = Ship.shipDataForKey(shipkey);
	// are we allowed to include this data key in this system? check the conditions if there are some
	var include = true;
	if (shipdata.conditions) {
		var cond = shipdata.conditions.toString().split(&quot;,&quot;);
		//1,systemGovernment_number equal 4,systemGovernment_number,0,0,4,
		//1,systemEconomy_number notequal 4,systemEconomy_number,1,0,4
		//1,systemEconomy_number lessthan 4,systemEconomy_number,2,0,4
		//1,systemEconomy_number greaterthan 4,systemEconomy_number,3,0,4
		var offset = 0;
		var finish = false;
		var checking = -1;
		do {
			// get the value we&#39;re checking
			checking = -1;
			if (cond[offset + 2].substring(0, 6) === &quot;mission&quot;) {
				if (missionVariables[cond[offset + 2].replace(&quot;mission_&quot;, &quot;&quot;)]) {
					checking = missionVariables[cond[offset + 2].replace(&quot;mission_&quot;, &quot;&quot;)];
					//log(this.name, &quot;field = &quot; + cond[offset + 2] + &quot;, value = &quot; + checking);
				} else {
					log(this.name, &quot;!!NOTE: Condition value mission variable not set: &quot; + cond[offset + 2]);
				}
			} else {
				switch (cond[offset + 2]) {
					case &quot;systemGovernment_number&quot;:
						checking = system.government;
						break;
					case &quot;systemEconomy_number&quot;:
						checking = system.economy;
						break;
					case &quot;systemTechLevel_number&quot;:
						checking = system.techLevel;
						break;
					case &quot;score_number&quot;:
						checking = player.score;
						break;
					case &quot;galaxy_number&quot;:
						checking = galaxyNumber;
						break;
					case &quot;planet_number&quot;:
						checking = system.ID;
						break;
					default:
						log(this.name, &quot;!!NOTE: Condition value not catered for: &quot; + cond[offset + 2]);
						break;
				}
			}
			// in case a mission variable is a text value of some sort
			if (isNaN(parseInt(checking)) &amp;&amp; isNaN(parseFloat(checking))) {
				switch (cond[offset + 3]) {
					case &quot;0&quot;: // equals
						if (checking != cond[offset + 5]) include = false;
						break;
					case &quot;1&quot;: // not equals
						if (checking == cond[offset + 5]) include = false;
						break;
					default:
						log(this.name, &quot;!!NOTE: Condition comparison not catered for: &quot; + cond[offset + 3]);
						break;
				}
			} else {
				if (checking &gt;= 0) {
					// work out the type of check, but in negative (or opposite)
					switch (cond[offset + 3]) {
						case &quot;0&quot;: // equals
							if (checking !== parseInt(cond[offset + 5])) include = false;
							break;
						case &quot;1&quot;: // not equals
							if (checking === parseInt(cond[offset + 5])) include = false;
							break;
						case &quot;2&quot;: // lessthan
							if (checking &gt;= parseInt(cond[offset + 5])) include = false;
							break;
						case &quot;3&quot;: // greaterthan
							if (checking &lt;= parseInt(cond[offset + 5])) include = false;
							break;
						default:
							log(this.name, &quot;!!NOTE: Condition comparison not catered for: &quot; + cond[offset + 3]);
							break;
							// others?
					}
				}
			}
			offset += 6;
			if (offset &gt;= cond.length - 1) finish = true;
		} while (finish === false);
	} else if (shipdata.condition_script) {
		// or the condition script
		// create a dummy object to attach the script to so it can be executed
		if (system.sun &amp;&amp; system.mainPlanet) {
			var temppos = system.sun.position.cross(system.mainPlanet.position).direction().multiply(4E9).subtract(system.mainPlanet.position);
			var tempalloy = system.addShips(&quot;alloy&quot;, 1, temppos, 0);
			tempalloy[0].setScript(shipdata.condition_script);
			include = tempalloy[0].script.allowSpawnShip(shipkey);
			tempalloy[0].remove(true);
		} else {
			include = true;
		}
	} else {
		// otherwise we&#39;re free to play
		include = true;
	}
	return include;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_illegal.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_Illegal&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the new illegal goods.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

/* TODO:
- add more illegal trade items to the possibilities list
*/

this._disabled = false;
this._debug = false;
this._enableMarkedSystems = true;
this._markedSystemRange = 7;
this._IGTInstalled = false;

/* template: {govTypes:&quot;&quot;, commodity:&quot;&quot;, properties:&quot;&quot;, permit:1, scale:1, period:n, chance:1, description:&quot;&quot;},
	govTypes:		Comma-separated list of goverment types (0-7) this definition can apply to
	commodity:		Comma-separated list of commodity names this definition will apply to.
	properties:		Comma-separated list of text search strings to use against the planetary description.
					For instance, &quot;civil war&quot; would only select planets that have &quot;civil war&quot; in their description.
					&quot;drink|brew&quot; would only select planets that have &quot;drink&quot; or &quot;brew&quot; in their description.
	permit:			Boolean value (0 or 1) indicating whether a permit can be purchased for this commodity
	scale:			The legality scale to apply to this commodity. The scale will apply when calculating the bounty to apply to a player caught smuggling illegal goods as a multiplier.
					Most illegal goods have a scale of 1. Slaves have 2.
	period:			The period (in days) this definition will be active for.
	chance:			A chance factor, between 0 (never) and 1 (very often), to apply when selecting this definition
	description:	The description to display for this definition.
*/
this._possibilities = [{
		govTypes: &quot;0,1,2&quot;,
		commodity: &quot;firearms&quot;,
		properties: &quot;&quot;,
		permit: 0,
		scale: 2,
		period: -1,
		chance: 0,
		description: &quot;Firearms have been declared illegal to reduce the proliferation of arms in dangerous systems.&quot;
	},
	{
		govTypes: &quot;3,4,5,6,7&quot;,
		commodity: &quot;firearms&quot;,
		properties: &quot;civil war&quot;,
		permit: 0,
		scale: 1,
		period: -1,
		chance: 0,
		description: &quot;Firearms have been declared illegal to reduce the impact of the civil war on this system.&quot;
	},
	{
		govTypes: &quot;0&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Computer technology has been restricted to limit illegal hacking.&quot;
	},
	{
		govTypes: &quot;0,1&quot;,
		commodity: &quot;radioactives&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 200,
		chance: 1,
		description: &quot;Recent upswing in dirty bombs and highly destructive weapons has led to strict controls on radioactives.&quot;
	},
	{
		govTypes: &quot;0,1&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;GalCop has restricted the importation of machinery to apply pressure to the government.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;Food imported from outside is feared to be coming from lower classes and is inappropriate for distribution and consumption.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;textiles&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;The under classes have been purchasing cheap clothes that mimic upper class styles and fabrics via imported sources. To keep the classes distinct, all imported textiles have been banned.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;liquor_wines&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;A number of alcohol-fuelled riots in lower class cities has led to a ban on all imported liquor.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;The priest class has declared use of the latest computers is taboo.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Machinery was seen as providing a way for lower classes to rise up against their superiors, so all foreign machinery has been declared illegal.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;furs&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported furs were cutting into a market monopoly held by certain members of the upper class, and so an import ban has been put in place.&quot;
	},
	{
		govTypes: &quot;1&quot;,
		commodity: &quot;gold,platinum&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;Prominent Barons have decried the devaluation of their investments due to foreign influence, and have brought about a temporary ban on precious metals.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Computers have been declared illegal in order to, it is suspected, undermine the efficiency of an opposing factions military forces.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;alien_items&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Reports of fake alien items has led to a ban pending authentication measures.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;Reports of contaminants in food supplies in nearby systems has prompted an embargo.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;alloys&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;A temporary embargo on imported alloys has been put in place as a way of bolstering local development.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;liquor_wines&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;All imported alcoholic beverages have been banned as a political favour to a local distributor.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Imported machinery was seen to be giving a production boost to an opposing faction and have been declared illegal.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;gold,platinum&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;An embargo has been placed on all precious metal imports, to cripple the markets of an opposing faction.&quot;
	},
	{
		govTypes: &quot;2&quot;,
		commodity: &quot;firearms&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;In an attempt to undermine the military strength of opposing factions, all firearm have been declared illegal.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;luxuries&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported luxuries have been declared illegal as they are, according to local government representatives, &#39;weak and unnecessary&#39;.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;radioactives&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;A hazardous waste scare has prompted a review of radioactives used in power stations.&quot;
	},
	{
		govTypes: &quot;0,3&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;GalCop has put pressure on the government by restricting food imports.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Imported machinery was seen to be altering the balance of power, and have been banned.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Technology imports have been declared illegal as they were causing the general population to become dissatisfied with their lot.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;minerals&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;The discovery of a rich mineral deposit has prompted an embargo on imported minerals.&quot;
	},
	{
		govTypes: &quot;3&quot;,
		commodity: &quot;alien_items&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;A inter-racial dispute in political circles has led to a ban on imported alien items.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;minerals&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Political dissidents do all internal system mining as punishment-- so foreign imports have been banned.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Automation is contrary to the communist work ethic, so all foreign machinery has been declared illegal.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Foreign computers cannot be trusted to give good communists the right answers, and have been banned.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;luxuries&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;The system has stated that strong communists don&#39;t need the decadent luxuries from weaker systems.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;liquor_wines&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;Consumption of spirits other than locally brewed beverages have been declared to be treasonous.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;furs&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Furs are seen to be a decadent fashion item of the enemies of the people, and have been banned.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;The system has declared that local growers will supply everything they need-- or else.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;textiles&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Locally produced clothing is superior to imported goods, and provides political prisoners with a livelihood. All textile imports are banned.&quot;
	},
	{
		govTypes: &quot;4&quot;,
		commodity: &quot;gold,platinum,gem_stones&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;The influence of foreign money has been decreed to be against the Communist ethic, leading to a ban on all precious metals and gem stones.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;Agricultural imports are barred to limit the risk of an invasive pest species that has been spreading in nearby systems.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;gold,platinum&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;A drop in the money market has led to temporary ban on imported precious metals.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;A nationalist movement proclaiming the importance of local products have orchestrated a ban on imported computer technology.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;furs&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported furs were competing against local tanners and furriers and have been declared illegal.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;alien_items&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Rumours of possible negotiations with the Thargoids have led to alien items being restricted.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;machinery&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;An industrial accident blamed on imported machinery has led to a total ban on any imports, pending further investigations.&quot;
	},
	{
		govTypes: &quot;5&quot;,
		commodity: &quot;gem_stones&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;A diamond cartel has bought political favours and arranged for an embargo on imported gem-stones.&quot;
	},
	{
		govTypes: &quot;5,6,7&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;To encourage and bolster local growers, imported food has been banned.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;alien_items&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;A pro-Thargoid political movement has gained power and banned sales of war-trophies.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;furs&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Animal rights activists have gained power and put a halt to the import of furs.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;alloys&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Environmental extremists have demanded more use of recycled metals and supplies in system to reduce waste.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;liquor_wines&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;A temperance movement has gained political influence and issued a ban on all alcoholic beverages.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;radioactives&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;An environmentalist movement has opposed the risks of radiation for industrial uses.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;textiles&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;An embarrassing media incident has rendered imported textiles a social taboo.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Unhealthy foreign foods have been banned by locals.&quot;
	},
	{
		govTypes: &quot;6&quot;,
		commodity: &quot;gold,platinum&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;Gold and platinum imports were seen as a destabilising influence on the local money market, so they have been banned.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;alien_items&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Collectors of rare alien items have forced the government to block the flood of &#39;cheap counterfeits&#39; to the market.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;gold,platinum&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;In an effort to reduce inflation, the system is restricting precious metal imports.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;alloys&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;The system has negotiated an exclusive contract for a specific manufactured alloy only, others are barred.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;computers&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;New computer models from the corporation are superior to foreign imports and have been given a local monopoly.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;radioactives&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Due to a recent radioactive accident by the corporation, imports of materials are restricted pending safety investigations.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 60,
		chance: 1,
		description: &quot;&#39;Naturally grown&#39; foods have been replaced with synthetic foods produced by the corporation.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		commodity: &quot;furs&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported furs have been banned, pending an investigation into a strain of disease-bearing mites found in some imports.&quot;
	},
	{
		govTypes: &quot;6,7&quot;,
		commodity: &quot;gem_stones&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 30,
		chance: 0.5,
		description: &quot;A series of fake gem-stones making their way onto the market has prompted an embargo.&quot;
	},
	{
		govTypes: &quot;0,1,2,3,4,5,6,7&quot;,
		commodity: &quot;textiles&quot;,
		properties: &quot;solar&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported clothing provides inadequate protection from local solar activity, and has been banned.&quot;
	},
	{
		govTypes: &quot;0,1,2,3,4,5,6,7&quot;,
		commodity: &quot;liquor_wines&quot;,
		properties: &quot;brandy,brew,gargle blasters&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 1,
		description: &quot;Imported liquor and wines were seen to be negatively impacting producers of local specialities and have been declared illegal.&quot;
	},
	{
		govTypes: &quot;0,1,2,3,4,5,6,7&quot;,
		commodity: &quot;food&quot;,
		properties: &quot;cuisine,soup,burgers,meat,cutlet,steak&quot;,
		permit: 1,
		scale: 1,
		period: 90,
		chance: 1,
		description: &quot;Imported food was influencing tastes away from local specialities, prompting a temporary trade embargo.&quot;
	},
	{
		govTypes: &quot;3,4,5,6,7&quot;,
		commodity: &quot;firearms&quot;,
		properties: &quot;&quot;,
		permit: 1,
		scale: 1,
		period: 120,
		chance: 0.5,
		description: &quot;Due to an increased number of firearm-related crimes, firearms have been declared illegal.&quot;
	}
];

// these commodities will be included when checking for illegal imports on docking, but as they are global defaults we won&#39;t add them via the normal mechanisms
// slaves are not included here, as they are being kept as illegal to export only. This is (a) because some escape pods get stored as slaves,
// and (b) to keep the Illegal Goods Tweak in the loop
this._defaultAdditions = [&quot;narcotics&quot;];

// extra commodityInfo
//		element 0 is permit costs
//		element 1 is % over base price when item is illegal
//		element 2 is % over base price for the black market price
this._commodityInfo = {
	&quot;food&quot;: [2500, 6.5, 2.2],
	&quot;textiles&quot;: [3000, 4.0, 2.0],
	&quot;radioactives&quot;: [5000, 2.5, 1.3],
	&quot;slaves&quot;: [4000, 0, 0],
	&quot;liquor_wines&quot;: [5000, 2.2, 1.1],
	&quot;luxuries&quot;: [6000, 2.1, 1.1],
	&quot;narcotics&quot;: [8000, 0, 0],
	&quot;computers&quot;: [6000, 2.1, 1.1],
	&quot;machinery&quot;: [5000, 2.2, 1.1],
	&quot;alloys&quot;: [3000, 2.2, 1.1],
	&quot;firearms&quot;: [5000, 2.2, 1.1],
	&quot;furs&quot;: [7000, 2.5, 1.4],
	&quot;minerals&quot;: [3000, 6.0, 2.1],
	&quot;gold&quot;: [8000, 2.5, 1.3],
	&quot;platinum&quot;: [9000, 2.2, 1.2],
	&quot;gem_stones&quot;: [8000, 3.5, 1.6],
	&quot;alien_items&quot;: [6000, 2.8, 1.3]
};

// holds all illegal good definitions for this sector
this._illegalGoods = []; // illegal goods currently in play in sector
this._permits = []; // permits currently held by player
this._originalCredits = 0; // value to hold the players credits (used to refund the cost of the initial item)
this._display = 0;
this._curpage = 0;
this._dataLoaded = false; // flag to indicate when data has been loaded
this._initialRun = true; // flag to indicate when the initial data set has been created
this._originating = -1;
this._startUpRunning = true;
this._markedSystems = [];
this._witchspaceDestination = -1;
this._done = false;
this._menuColor = &quot;orangeColor&quot;;
this._itemColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];

// configuration settings for use in Lib_Config
this._siConfig = {
	Name: this.name,
	Alias: &quot;Smugglers&quot;,
	Display: &quot;Config&quot;,
	Alive: &quot;_siConfig&quot;,
	Notify: &quot;$markSystems&quot;,
	Bool: {
		B0: {
			Name: &quot;_enableMarkedSystems&quot;,
			Def: true,
			Desc: &quot;Mark nearby systems&quot;
		},
		Info: &quot;Turns on option of marking nearby systems with illegal goods on the galaxy map.&quot;
	},
	SInt: {
		S0: {
			Name: &quot;_markedSystemRange&quot;,
			Def: 7,
			Min: 0,
			Max: 15,
			Desc: &quot;Marked sys range&quot;
		},
		Info: &quot;Defines range in LY for marking systems with illegal goods.&quot;
	},
};

//-------------------------------------------------------------------------------------------------------------
this.startUp = function () {
	if (this._disabled) {
		delete this.shipDockedWithStation;
		delete this.playerBoughtEquipment;
		delete this.shipWillEnterWitchspace;
		delete this.shipExitedWitchspace;
		delete this.playerEnteredNewGalaxy;
		delete this.playerWillSaveGame;
		delete this.guiScreenWillChange;
		delete this.guiScreenChanged;
		delete this.updateLocalCommodityDefinition;
		delete this.dayChanged;
		delete this.startUpComplete;
		delete this.startUp;
		return;
	}

	var core = worldScripts.Smugglers_CoreFunctions;
	this.$padTextRight = core.$padTextRight;
	this.$padTextLeft = core.$padTextLeft;
	this.$isBigGuiActive = core.$isBigGuiActive;
	this.$rand = core.$rand;

	if (missionVariables.Smuggling_Permits) {
		this._permits = JSON.parse(missionVariables.Smuggling_Permits);
		delete missionVariables.Smuggling_Permits;
	}
	this._originating = system.ID;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	// register our settings, if Lib_Config is present
	if (worldScripts.Lib_Config) worldScripts.Lib_Config._registerSet(this._siConfig);

	// check for illegal goods tweak
	if (worldScripts[&quot;illegal_goods_tweak&quot;]) this._IGTInstalled = true;

	// set up the interface screen, if required
	this.$initMainInterface(player.ship.dockedStation);
	this.$correctStartEndDates();
	this._startUpRunning = false;

	this._sMarket = system.mainStation.market;

	if (missionVariables.Smuggling_InitialRun) {
		this._initialRun = missionVariables.Smuggling_InitialRun;
	}

	if (missionVariables.Smuggling_MarkedSystems) {
		this._markedSystems = JSON.parse(missionVariables.Smuggling_MarkedSystems);
		delete missionVariables.Smuggling_MarkedSystems;
	}

	if (this._initialRun === true) {
		// make sure anything illegal in our current system gets adjusted
		this.$updateSystemPrices();
	}

	// add our repair items to the email systems list of repair equipment
	var w = worldScripts.EmailSystem;
	if (w) {
		var ga = worldScripts.GalCopAdminServices;
		for (var i = 1; i &lt;= 20; i++) {
			ga._maint_repair_equip.push(&quot;EQ_SMUGGLING_COMPARTMENT_REPAIR_&quot; + i);
		}
	}
	// only load these settings if Library is installed
	if (worldScripts.Lib_Config) {
		if (missionVariables.Smugglers_MarkSystems) this._enableMarkedSystems = (this._trueValues.indexOf(missionVariables.Smugglers_MarkSystems) &gt;= 0 ? true : false);
		if (missionVariables.Smugglers_MarkSystemsRange) this._markedSystemRange = parseInt(missionVariables.Smugglers_MarkSystemsRange);
	}
	this.$markSystems();
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	missionVariables.Smuggling_IllegalGoods = JSON.stringify(this._illegalGoods);
	missionVariables.Smuggling_Permits = JSON.stringify(this._permits);
	missionVariables.Smuggling_MarkedSystems = JSON.stringify(this._markedSystems);
	missionVariables.Smuggling_InitialRun = this._initialRun;
	// only save these settings if Library is installed
	if (worldScripts.Lib_Config) {
		missionVariables.Smugglers_MarkSystems = this._enableMarkedSystems;
		missionVariables.Smugglers_MarkSystemsRange = this._markedSystemRange;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function (station) {
	this.$initMainInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillLaunchFromStation = function (station) {
	if (missionVariables.Smuggling_IllegalGoods) delete missionVariables.Smuggling_IllegalGoods;
	if (missionVariables.Smuggling_Permits) delete missionVariables.Smuggling_Permits;
	if (missionVariables.Smuggling_MarkedSystems) delete missionVariables.Smuggling_MarkedSystems;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function (equipmentKey) {
	var p = player.ship;

	if (equipmentKey === &quot;EQ_IMPORT_PERMIT&quot;) {
		p.removeEquipment(equipmentKey);
		// give the player back the original amount, in case they decide not to purchase
		if (this._originalCredits != 0) {
			player.credits = this._originalCredits;
			this._originalCredits = 0;
		}
		// mission screen to ask how many TC to allocate
		this.$showPurchasePage();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillEnterWitchspace = function (cause, destination) {
	this._witchspaceDestination = destination;
	this._initialRun = true;
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	this._originating = system.ID;
	this._done = false;
	if (system.mainStation) {
		this._sMarket = system.mainStation.market;
		this.$updateSystemPrices();
	}
	this.$markSystems();
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredNewGalaxy = function (galNumber) {
	// hopefully this is early enough in the sequence to establish illegal goods for the &quot;smugglers_illegalmarket&quot;
	this._illegalGoods = [];
	this._dataLoaded = false;
}

//-------------------------------------------------------------------------------------------------------------
this.dayChanged = function (newday) {
	this.$cleanup();
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenWillChange = function (to, from) {
	if (to === &quot;GUI_SCREEN_MARKET&quot;) this.$updateDescriptions();
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function (to, from) {
	if (guiScreen === &quot;GUI_SCREEN_EQUIP_SHIP&quot;) this._originalCredits = player.credits;

	// This code puts all the illegal goods on the F7 screen. However, with the description in the F8F8 screen this code is possibly unnecessary.
	// However, if there is feedback that says it would be useful I&#39;ll but it back in.
	if (from === &quot;GUI_SCREEN_SYSTEM_DATA&quot; &amp;&amp; guiScreen != &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		// unhide the hud, if required
		if (player.ship.hudHidden != this._hudHidden) {
			player.ship.hudHidden = this._hudHidden;
		}
	}
	if (guiScreen === &quot;GUI_SCREEN_SYSTEM_DATA&quot; &amp;&amp; from != &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		if (player.ship.isInSpace === false) {
			// hide the hud to give us more room for text
			this._hudHidden = player.ship.hudHidden;
			if (this.$isBigGuiActive() === false) {
				player.ship.hudHidden = true;
				// force an update in XenonUI (if installed)
				var xui = worldScripts.XenonUI;
				if (xui) xui.guiScreenChanged(&quot;&quot;, &quot;&quot;);
				var xrui = worldScripts.XenonReduxUI;
				if (xrui) xrui.guiScreenChanged(&quot;&quot;, &quot;&quot;);
			}
		}
	}
	if (guiScreen === &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		// load data onto screen at the end
		if (!this._dataLoadDelay) this._dataLoadDelay = new Timer(this, this.$dataLoadDelay, 0.2, 0);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.infoSystemChanged = function (to, from) {
	if (guiScreen === &quot;GUI_SCREEN_SYSTEM_DATA&quot;) {
		// load data onto screen at the end
		if (!this._dataLoadDelay) this._dataLoadDelay = new Timer(this, this.$dataLoadDelay, 0.2, 0);
	}
}

//-------------------------------------------------------------------------------------------------------------
// we&#39;re doing a manual price adjustment, outside of the illegalmarket script
// this is because there are a number of market script adjustment OXP&#39;s out there, each of them making changes to price info.
// there is no way of knowing what scripts are in play, and in what order they are loaded
// so this is the easy way out - wait until the system is populated and then do a percentage change to illegal goods,
// rather than a fixed price amount, so other scripts can apply their changes, and we can just apply a final boost via a percentage
this.$updateSystemPrices = function $updateSystemPrices() {
	this._initialRun = false;
	var goods = this.$illegalGoodsList(system.ID);
	var stns = system.stations;
	for (var i = 0; i &lt; goods.length; i++) {
		// each item in goods can have multiple commodities listed, so see if a particular commodity is contained in the list of goods
		for (var j in this._commodityInfo) {
			if (goods[i].commodity.indexOf(j) &gt;= 0) {
				for (var k = 0; k &lt; stns.length; k++) {
					var stn = stns[k];
					if (this._debug) log(this.name, &quot;checking &quot; + stn);
					// calculate the new price, based on the price limits in _commodityInfo
					var newprice = 0;
					if (stn.allegiance === &quot;galcop&quot;) {
						var newprice = Math.round(stn.market[j].price * (this._commodityInfo[j][1] + ((system.scrambledPseudoRandomNumber(goods.length) * 0.6) - 0.3)), 2);
						// adjust the price property
						if (this._debug) log(this.name, &quot;changing price on &quot; + j + &quot; from &quot; + stn.market[j].price + &quot; to &quot; + newprice);
						if (newprice !== 0) stn.setMarketPrice(j, newprice);
					}
				}
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$dataLoadDelay = function $dataLoadDelay() {
	delete this._dataLoadDelay;
	// append any system-specific illegal goods to the display
	if (guiScreen != &quot;GUI_SCREEN_SYSTEM_DATA&quot;) return;

	var sysID = player.ship.targetSystem;
	if (player.ship.hasOwnProperty(&quot;infoSystem&quot;)) sysID = player.ship.infoSystem;

	var goods = this.$illegalGoodsList(sysID);
	var dis_list = &quot;&quot;;
	if (this._IGTInstalled === true) {
		dis_list = expandDescription(&quot;[illegal-goods-f7-igt&quot; + (player.ship.isInSpace === false ? &quot;&quot; : &quot;-inflight&quot;) + &quot;]&quot;);
	} else {
		dis_list = expandDescription(&quot;[illegal-goods-f7-std&quot; + (player.ship.isInSpace === false ? &quot;&quot; : &quot;-inflight&quot;) + &quot;]&quot;);
	}
	if (player.ship.isInSpace === false) {
		for (var i = 0; i &lt; goods.length; i++) {
			dis_list += &quot;\nIllegal import -- &quot; + this.$translateCommodityList(goods[i].commodity) + &quot;: &quot; + goods[i].description;
		}
	} else {
		for (var i = 0; i &lt; goods.length; i++) {
			dis_list += &quot;, &quot; + this.$translateCommodityList(goods[i].commodity);
		}
	}
	mission.addMessageText(dis_list);
}

//-------------------------------------------------------------------------------------------------------------
this.$initialiseData = function $initialiseData() {
	this._dataLoaded = true;

	// if the initial run flag isn&#39;t yet stored in the data, but there are other definitions, reset the flag to false
	// that should prevent any extreme prices.
	if (!missionVariables.Smuggling_InitialRun &amp;&amp; missionVariables.Smuggling_IllegalGoods) {
		this._initialRun = false;
	}

	if (missionVariables.Smuggling_IllegalGoods) {
		this._illegalGoods = JSON.parse(missionVariables.Smuggling_IllegalGoods);
		delete missionVariables.Smuggling_IllegalGoods;
	} else {
		this.$initialSetup();
	}
}

//-------------------------------------------------------------------------------------------------------------
// shows the installation page to select a compartment size
this.$showPurchasePage = function $showPurchasePage() {

	var curChoices = {};
	var p = player.ship;
	var stn = p.dockedStation;
	var rowAdjust = 0;

	var pagesize = 18;
	if (this.$isBigGuiActive() === true) pagesize = 24;

	var text = expandDescription(&quot;[permit-purchase-header]&quot;, {
		cash: formatCredits(player.credits, true, true)
	});
	text += this.$padTextRight(&quot;Item&quot;, 20) + this.$padTextLeft(&quot;Cost&quot;, 10);

	var goods = this.$illegalGoodsList(system.ID);
	// remove any goods for which the player either already has a permit, or that no permit is allowed
	for (var i = goods.length - 1; i &gt;= 0; i--) {
		if (goods[i].permit === 1) {
			// if the player already has a permit for this item, remove it.
			if (this.$playerHasPermit(system.ID, goods[i].commodity, false) === true) {
				goods.splice(i, 1);
			}
		} else {
			// if the item doesn&#39;t allow permits, remove it
			goods.splice(i, 1);
		}
	}

	for (var i = 0; i &lt; goods.length; i++) {
		var list = goods[i].commodity.split(&quot;,&quot;);
		var cost = 0;
		for (var j = 0; j &lt; list.length; j++) {
			cost += this._commodityInfo[list[j]][0] * (1 + (system.government + 1) / 8);
		}
		var menuitem = this.$padTextRight(this.$translateCommodityList(goods[i].commodity), 20) + this.$padTextLeft(formatCredits(cost, true, true), 10);
		curChoices[&quot;01_PERMIT~&quot; + goods[i].commodity] = {
			text: menuitem,
			alignment: &quot;LEFT&quot;,
			color: this._menuColor
		};
	}

	curChoices[&quot;97_SPACER&quot;] = &quot;&quot;;

	curChoices[&quot;99_EXIT&quot;] = {
		text: &quot;[exit-no-change]&quot;,
		color: this._itemColor
	};
	var def = &quot;99_EXIT&quot;;

	for (var i = 0; i &lt; ((pagesize - 4) - goods.length); i++) {
		curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
	}

	var opts = {
		screenID: &quot;oolite-smugglers-permit-map&quot;,
		title: &quot;Import Permit Purchasing&quot;,
		allowInterrupt: true,
		exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
		overlay: {
			name: &quot;stgu-form.png&quot;,
			height: 546
		},
		choices: curChoices,
		initialChoicesKey: def,
		message: text
	};

	mission.runScreen(opts, this.$purchaseScreenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$purchaseScreenHandler = function $purchaseScreenHandler(choice) {

	if (!choice) return;

	if (choice.indexOf(&quot;01_PERMIT&quot;) &gt;= 0) {
		var cmdty = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var list = cmdty.split(&quot;,&quot;);
		var cost = 0;
		for (var j = 0; j &lt; list.length; j++) {
			cost += this._commodityInfo[list[j]][0] * (1 + (system.government + 1) / 8);
		}

		this._permits.push({
			systemID: system.ID,
			commodity: cmdty,
			fake: 0
		});

		// charge the player
		player.credits -= cost;

		// make sure the right email is sent to the player
		var email = worldScripts.EmailSystem;
		if (email) {
			// send a notification email
			var msg = expandDescription(&quot;[permit-purchase-email]&quot;, {
				commodity: this.$translateCommodityList(cmdty).replace(&quot;, &quot;, &quot; and &quot;),
				amount: formatCredits(cost, true, true)
			});

			email.$createEmail({
				sender: &quot;GalCop Permit Authority&quot;,
				subject: &quot;Purchase of import permit&quot;,
				date: clock.seconds,
				message: msg
			});
		}

		// apply the install time (15 minutes)
		clock.addSeconds(900);

	}

}

//-------------------------------------------------------------------------------------------------------------
// initialise the illegal goods F4 screen entries
this.$initMainInterface = function $initMainInterface(station) {
	station.setInterface(this.name, {
		title: &quot;Illegal goods information&quot;,
		category: &quot;Station Interfaces&quot;,
		summary: &quot;Information relating to illegal goods in this sector.&quot;,
		callback: this.$initialIllegalGoodsOptions.bind(this)
	});
}

//-------------------------------------------------------------------------------------------------------------
this.$initialIllegalGoodsOptions = function $initialIllegalGoodsOptions() {
	this._display = 0;
	this._curpage = 0;
	this.$illegalGoodsOptions();
}

//-------------------------------------------------------------------------------------------------------------
this.$illegalGoodsOptions = function $illegalGoodsOptions() {
	function compareDate(a, b) {
		if (a.started &lt; b.started) return -1;
		if (a.started &gt; b.started) return 1;
		return 0;
	}

	function compareSystem(a, b) {
		if (a.systemID &lt; b.systemID) return -1;
		if (a.systemID &gt; b.systemID) return 1;
		return 0;
	}

	function compareSystemName(a, b) {
		if (a.name &lt; b.name) return -1;
		if (a.name &gt; b.name) return 1;
		return 0;
	}

	var curChoices = {};
	var text = &quot;&quot;;
	var p = player.ship;
	var def = &quot;&quot;;
	var sbm = worldScripts.Smugglers_BlackMarket;
	var col1 = 6;
	var col2 = 10;
	var pagesize = 20;

	if (this.$isBigGuiActive() === true) {
		pagesize = 26;
	}

	var govs = new Array();
	for (var i = 0; i &lt; 8; i++)
		govs.push(String.fromCharCode(i));
	var spc = String.fromCharCode(31);

	// main menu
	if (this._display === 0) {
		text = &quot;&quot;;
		var recent = [];

		for (var i = 0; i &lt; this._illegalGoods.length; i++) {
			// list all new items (less that 5 days since start
			if (this._illegalGoods[i].started != 0 &amp;&amp; ((clock.adjustedSeconds - this._illegalGoods[i].started) / 86400) &lt; 7) {
				recent.push({
					name: System.systemNameForID(this._illegalGoods[i].systemID),
					systemID: this._illegalGoods[i].systemID,
					commodity: this.$translateCommodityList(this._illegalGoods[i].commodity),
					description: this._illegalGoods[i].description,
					started: this._illegalGoods[i].started
				});
			}
		}

		text = expandDescription(&quot;[recent-declarations]&quot;);
		var lines = 3;
		if (recent.length &gt; 0) {
			recent.sort(compareDate);

			for (var i = 0; i &lt; recent.length; i++) {
				var info = System.infoForSystem(galaxyNumber, recent[i].systemID);
				var rt = system.info.routeToSystem(info);
				if (rt) {
					var dist = rt.distance;
				} else {
					var dist = system.info.distanceToSystem(info);
				}
				var textitem = recent[i].name + &quot; (&quot; + govs[info.government] + spc + &quot;TL&quot; + (info.techlevel + 1) + &quot;, dist: &quot; + dist.toFixed(1) + &quot;ly) -- &quot; + recent[i].commodity + &quot;: &quot; + recent[i].description;
				text += textitem + &quot;\n&quot;;
				var w = defaultFont.measureString(textitem);
				lines += Math.ceil(w / 32);
				if (lines &gt;= (pagesize - 6)) break;
			}

		} else {
			text += expandDescription(&quot;recent-declarations-none&quot;);
			lines += 1;
		}

		text += expandDescription(&quot;[offer-selections]&quot;);

		curChoices[&quot;01_INFO&quot;] = {
			text: &quot;[illegal-sector]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;02_INRANGE&quot;] = {
			text: &quot;[illegal-7ly]&quot;,
			color: this._menuColor
		};
		curChoices[&quot;03_PLOT&quot;] = {
			text: &quot;[illegal-course]&quot;,
			color: this._menuColor
		};
		if (this._permits.length &gt; 0) {
			curChoices[&quot;04_PERMITS&quot;] = {
				text: &quot;[list-permits]&quot;,
				color: this._menuColor
			};
			lines += 1;
		}
		if (sbm._waypoints.length &gt; 0) {
			curChoices[&quot;05_WAYPOINTS&quot;] = {
				text: &quot;[list-waypoints]&quot;,
				color: this._menuColor
			};
			lines += 1;
		}

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		for (var i = 0; i &lt; ((pagesize - 5) - lines); i++) {
			curChoices[&quot;99_SPACER_&quot; + i] = &quot;&quot;;
			//	text += &quot;\n&quot;;
		}


		this._curpage = 0;

		def = &quot;99_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-illegal-map&quot;,
			title: &quot;Illegal Goods Information&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-warning.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// illegal goods in sector
	if (this._display === 1) {

		var list = [];
		var checking = [];

		for (var i = 0; i &lt; this._illegalGoods.length; i++) {
			if (checking.indexOf(this._illegalGoods[i].systemID) === -1) {
				list.push({
					systemID: this._illegalGoods[i].systemID,
					name: System.systemNameForID(this._illegalGoods[i].systemID)
				});
				checking.push(this._illegalGoods[i].systemID);
			}
		}

		list.sort(compareSystemName);

		var redux = 6;
		var maxpages = Math.ceil(list.length / (pagesize - redux));
		var pagestart = this._curpage * (pagesize - redux);
		var pageend = this._curpage * (pagesize - redux) + (pagesize - redux);
		if (pageend &gt; list.length) pageend = list.length;

		text = &quot;Illegal import notifications - Page &quot; + (this._curpage + 1) + &quot; of &quot; + maxpages + &quot;\n&quot;;
		if (this._IGTInstalled === true) {
			text += expandDescription(&quot;[notifications-extra-igt]&quot;);
		} else {
			text += expandDescription(&quot;[notifications-extra-std]&quot;);
		}

		for (var i = pagestart; i &lt; pageend; i++) {
			var info = System.infoForSystem(galaxyNumber, list[i].systemID);
			var rt = system.info.routeToSystem(info);
			if (rt) {
				var dist = rt.distance;
			} else {
				var dist = system.info.distanceToSystem(info);
			}
			text += this.$padTextRight(info.name, col1) + this.$padTextRight(&quot;(&quot; + govs[info.government] + spc + &quot;TL&quot; + (info.techlevel + 1) + &quot;, dist: &quot; + dist.toFixed(1) + &quot;ly)&quot;, col2);

			var iglist = &quot;&quot;;
			var goods = this.$illegalGoodsList(list[i].systemID);
			for (var j = 0; j &lt; goods.length; j++) {
				var cmdty = goods[j].commodity;
				var subitems = cmdty.split(&quot;,&quot;);
				for (var k = 0; k &lt; subitems.length; k++) {
					iglist += (iglist === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + displayNameForCommodity(subitems[k]);
					if (this.$playerHasPermit(list[i].systemID, subitems[k], false) === true) iglist += &quot; (P)&quot;;
				}
			}
			text += iglist + &quot;\n&quot;;
		}

		if (this._curpage === maxpages - 1) {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._menuColor
			};
		}
		if (this._curpage === 0) {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-illegal-map&quot;,
			title: &quot;Illegal Goods Information&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-warning.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastChoice ? this._lastChoice : def,
			message: text
		};
	}

	// illegal goods on course
	if (this._display === 2) {
		var target = p.targetSystem;
		var source = system.ID;
		var myRoute = null;
		if (source &gt;= 0) {
			if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
				myRoute = System.infoForSystem(galaxyNumber, source).routeToSystem(System.infoForSystem(galaxyNumber, target), p.routeMode);
			} else {
				myRoute = {};
				myRoute.route = [];
				if (source !== target) myRoute.route.push(source);
				myRoute.route.push(target);
			}
		}
		if (myRoute != null) {
			var list = myRoute.route;

			var redux = 6;
			var maxpages = Math.ceil(list.length / (pagesize - redux));
			var pagestart = this._curpage * (pagesize - redux);
			var pageend = this._curpage * (pagesize - redux) + (pagesize - redux);
			if (pageend &gt; list.length) pageend = list.length;

			text = &quot;Illegal imports on current route&quot; + (list.length &gt; 0 ? &quot; - Page &quot; + (this._curpage + 1) + &quot; of &quot; + maxpages : &quot;&quot;) + &quot;\n&quot;;
			if (this._IGTInstalled === true) {
				text += expandDescription(&quot;[notifications-extra-igt]&quot;);
			} else {
				text += expandDescription(&quot;[notifications-extra-std]&quot;);
			}

			for (var i = pagestart; i &lt; pageend; i++) {
				var info = System.infoForSystem(galaxyNumber, list[i]);
				var rt = system.info.routeToSystem(info);
				if (rt &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
					var dist = rt.distance;
				} else {
					var dist = system.info.distanceToSystem(info);
				}
				text += this.$padTextRight(info.name, col1) + this.$padTextRight(&quot;(&quot; + govs[info.government] + spc + &quot;TL&quot; + (info.techlevel + 1) + &quot;, dist: &quot; + dist.toFixed(1) + &quot;ly)&quot;, col2);

				var iglist = &quot;&quot;;
				var goods = this.$illegalGoodsList(list[i]);
				if (goods.length &gt; 0) {
					for (var j = 0; j &lt; goods.length; j++) {
						var cmdty = goods[j].commodity;
						var subitems = cmdty.split(&quot;,&quot;);
						for (var k = 0; k &lt; subitems.length; k++) {
							iglist += (iglist === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + displayNameForCommodity(subitems[k]);
							if (this.$playerHasPermit(list[i], subitems[k], false) === true) iglist += &quot; (P)&quot;;
						}
					}
					text += iglist;
				} else {
					text += &quot;None&quot;;
				}
				text += &quot;\n&quot;;
			}
		} else {
			var maxpages = 0;
			var list = [];
			if (system.ID === -1) {
				text = &quot;Illegal imports on current route\n\nError: Route information unable to be calculated in interstellar space.\n&quot;;
			} else {
				text = &quot;Illegal imports on current route\n\nError: Route information unable to be calculated.\n&quot;;
			}
		}

		if (this._curpage === maxpages - 1 || list.length === 0) {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._menuColor
			};
		}
		if (this._curpage === 0 || list.length === 0) {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-illegal-map&quot;,
			title: &quot;Illegal Goods Information&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-warning.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastChoice ? this._lastChoice : def,
			message: text
		};
	}

	// purchased (legal or otherwise) permits
	if (this._display === 3) {

		var redux = 6;
		var maxpages = Math.ceil(this._permits.length / (pagesize - redux));
		if (maxpages === 0) maxpages = 1;

		text = &quot;Import permits acquried&quot; + (this._permits.length &gt; 0 ? &quot; - Page &quot; + (this._curpage + 1) + &quot; of &quot; + maxpages : &quot;&quot;) + &quot;\n\n&quot;;

		if (this._permits.length &gt; 0) {
			var pagestart = this._curpage * (pagesize - redux);
			var pageend = this._curpage * (pagesize - redux) + (pagesize - redux);
			if (pageend &gt; this._permits.length) pageend = this._permits.length;

			for (var i = pagestart; i &lt; pageend; i++) {
				var info = System.infoForSystem(galaxyNumber, this._permits[i].systemID);
				text += &quot;  Import &quot; + this.$translateCommodityList(this._permits[i].commodity) + &quot; on &quot; + info.name + &quot;\n&quot;;
			}
		} else {
			text += &quot;  None&quot;;
		}

		if (this._curpage === maxpages - 1 || this._permits.length === 0) {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._menuColor
			};
		}
		if (this._curpage === 0 || this._permits.length === 0) {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-illegal-map&quot;,
			title: &quot;Illegal Goods Information&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-form.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastChoice ? this._lastChoice : def,
			message: text
		};

	}

	// illegal goods in range
	if (this._display === 4) {
		var list = system.info.systemsInRange(7);

		var redux = 6;
		var maxpages = Math.ceil(list.length / (pagesize - redux));
		var pagestart = this._curpage * (pagesize - redux);
		var pageend = this._curpage * (pagesize - redux) + (pagesize - redux);
		if (pageend &gt; list.length) pageend = list.length;

		text = &quot;Illegal imports in 7LY range&quot; + (list.length &gt; 0 ? &quot; - Page &quot; + (this._curpage + 1) + &quot; of &quot; + maxpages : &quot;&quot;) + &quot;\n&quot;;
		if (this._IGTInstalled === true) {
			text += expandDescription(&quot;[notifications-extra-igt]&quot;);
		} else {
			text += expandDescription(&quot;[notifications-extra-std]&quot;);
		}

		for (var i = pagestart; i &lt; pageend; i++) {
			var rt = system.info.routeToSystem(list[i]);
			if (rt) {
				var dist = rt.distance;
			} else {
				var dist = system.info.distanceToSystem(list[i]);
			}
			text += this.$padTextRight(list[i].name, col1) + this.$padTextRight(&quot;(&quot; + govs[list[i].government] + spc + &quot;TL&quot; + (list[i].techlevel + 1) + &quot;, dist: &quot; + dist.toFixed(1) + &quot;ly)&quot;, col2);

			var iglist = &quot;&quot;;
			var goods = this.$illegalGoodsList(list[i].systemID);
			if (goods.length &gt; 0) {
				for (var j = 0; j &lt; goods.length; j++) {
					var cmdty = goods[j].commodity;
					var subitems = cmdty.split(&quot;,&quot;);
					for (var k = 0; k &lt; subitems.length; k++) {
						iglist += (iglist === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + displayNameForCommodity(subitems[k]);
						if (this.$playerHasPermit(list[i].systemID, subitems[k], false) === true) iglist += &quot; (P)&quot;;
					}
				}
				text += iglist;
			} else {
				text += &quot;None&quot;;
			}
			text += &quot;\n&quot;;
		}

		if (this._curpage === maxpages - 1 || list.length === 0) {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._menuColor
			};
		}
		if (this._curpage === 0 || list.length === 0) {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-illegal-map&quot;,
			title: &quot;Illegal Goods Information&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-warning.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastChoice ? this._lastChoice : def,
			message: text
		};
	}

	// rock hermit waypoints purchased
	if (this._display === 5) {
		var redux = 6;
		var maxpages = Math.ceil(sbm._waypoints.length / (pagesize - redux));
		if (maxpages === 0) maxpages = 1;

		text = &quot;Rock Hermit waypoints acquried&quot; + (sbm._waypoints.length &gt; 0 ? &quot; - Page &quot; + (this._curpage + 1) + &quot; of &quot; + maxpages : &quot;&quot;) + &quot;\n\n&quot;;

		if (sbm._waypoints.length &gt; 0) {
			var pagestart = this._curpage * (pagesize - redux);
			var pageend = this._curpage * (pagesize - redux) + (pagesize - redux);
			if (pageend &gt; sbm._waypoints.length) pageend = sbm._waypoints.length;

			for (var i = pagestart; i &lt; pageend; i++) {
				var info = System.infoForSystem(galaxyNumber, sbm._waypoints[i]);
				var rt = system.info.routeToSystem(info);
				if (rt) {
					var dist = rt.distance;
				} else {
					var dist = system.info.distanceToSystem(info);
				}
				text += info.name + &quot; (&quot; + govs[info.government] + spc + &quot;TL&quot; + (info.techlevel + 1) + &quot;, dist: &quot; + dist.toFixed(1) + &quot;ly)\n&quot;;
			}
		} else {
			text += &quot;  None&quot;;
		}

		if (this._curpage === maxpages - 1 || sbm._waypoints.length === 0) {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;10_NEXTPAGE&quot;] = {
				text: &quot;[illegal-nextpage]&quot;,
				color: this._menuColor
			};
		}
		if (this._curpage === 0 || sbm._waypoints.length === 0) {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		} else {
			curChoices[&quot;11_PREVPAGE&quot;] = {
				text: &quot;[illegal-prevpage]&quot;,
				color: this._menuColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[illegal-return]&quot;,
			color: this._itemColor
		};

		def = &quot;98_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-smuggling-waypoints-map&quot;,
			title: &quot;Rock Hermit Waypoints&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;stgu-map_marker.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastChoice ? this._lastChoice : def,
			message: text
		};

	}

	mission.runScreen(opts, this.$screenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$screenHandler = function $screenHandler(choice) {

	delete this._lastChoice;

	switch (choice) {
		case &quot;01_INFO&quot;:
			this._display = 1;
			break;
		case &quot;02_INRANGE&quot;:
			this._display = 4;
			break;
		case &quot;03_PLOT&quot;:
			this._display = 2;
			this._curpage = 0;
			break;
		case &quot;04_PERMITS&quot;:
			this._display = 3;
			this._curpage = 0;
			break;
		case &quot;05_WAYPOINTS&quot;:
			this._display = 5;
			this._curpage = 0;
			break;
		case &quot;10_NEXTPAGE&quot;:
			this._curpage += 1;
			break;
		case &quot;11_PREVPAGE&quot;:
			this._curpage -= 1;
			break;
		case &quot;98_EXIT&quot;:
			this._display = 0;
			break;
	}

	this._lastChoice = choice;

	if (choice != &quot;99_EXIT&quot;) {
		this.$illegalGoodsOptions();
	}

}

//-------------------------------------------------------------------------------------------------------------
// returns list of illegal goods for system id
this.$illegalGoodsList = function $illegalGoodsList(sysID, include) {

	var list = [];
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].systemID === sysID) list.push(this._illegalGoods[i]);
	}
	// include default definitions when running a check on docking
	if (include &amp;&amp; include === true) {
		for (var i = 0; i &lt; this._defaultAdditions.length; i++) {
			list.push({
				systemID: sysID,
				commodity: this._defaultAdditions[i],
				started: 0,
				end: 0,
				description: &quot;&quot;,
				permit: 0,
				scale: 2
			});
		}
	}
	return list;
}

//-------------------------------------------------------------------------------------------------------------
// returns list of illegal goods for system id, but just the commodity names (split out if necessary)
this.$illegalGoodsListCommodityOnly = function $illegalGoodsListCommodityOnly(sysID, include) {
	var list = [];
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].systemID === sysID) {
			var splitlist = this._illegalGoods[i].commodity.split(&quot;,&quot;);
			for (var j = 0; j &lt; splitlist.length; j++) {
				list.push(splitlist[j]);
			}
		}
	}
	// include default definitions when running a check on docking
	if (include &amp;&amp; include === true) {
		for (var i = 0; i &lt; this._defaultAdditions.length; i++) {
			list.push(this._defaultAdditions[i]);
		}
	}
	return list;
}

//-------------------------------------------------------------------------------------------------------------
// returns a particular illegal goods definition
this.$illegalGoodsDefinition = function $illegalGoodsDefinition(sysID, commodity) {
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].systemID === sysID &amp;&amp; this._illegalGoods[i].commodity.indexOf(commodity) &gt;= 0) return this._illegalGoods[i];
	}
	return null;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a particular good is illegal in a particular system, otherwise false;
this.$isGoodIllegal = function $isGoodIllegal(sysID, commodity) {
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].systemID === sysID &amp;&amp; this._illegalGoods[i].commodity.indexOf(commodity) &gt;= 0) return true;
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// initial setup of illegal goods in sector
this.$initialSetup = function $initialSetup() {
	// first, add all default/permanent items
	for (var i = 0; i &lt; this._possibilities.length; i++) {
		var item = this._possibilities[i];
		if (item.period === -1) {
			var govs = item.govTypes.split(&quot;,&quot;);
			for (var j = 0; j &lt; govs.length; j++) {
				if (govs[j] != &quot;&quot;) {
					var planetlist = this.$getSystemsByGovernment(parseInt(govs[j]), item.properties);
					for (var k = 0; k &lt; planetlist.length; k++) {
						if (planetlist[k].sun_gone_nova) continue;
						this.$applyDefinition(planetlist[k].systemID, item, 0);
					}
				}
			}
		}
	}

	// next pick a random number of planets and apply an illegal good for them
	// add the definitions, between 30 and 60 ** TODO: work out if this is too much or too little
	if (!this.$rand) this.$rand = worldScripts.Smugglers_CoreFunctions.$rand; // make sure our rand function is available
	for (var i = 1; i &lt;= (this.$rand(30) + 30); i++) {
		this.$addNewItem(this.$rand(20));
	}
}

//-------------------------------------------------------------------------------------------------------------
// add a new random item to the list
this.$addNewItem = function $addNewItem(startDays, excludeSystem) {

	var planetid = -1;
	var sys;
	var tries = 0;
	do {
		// pick a random planet
		planetid = this.$rand(256) - 1;
		sys = System.infoForSystem(galaxyNumber, planetid);
		// don&#39;t create items in nova systems
		if (sys.sun_gone_nova) planetid = -1;
		// don&#39;t create items in the excluded system
		if (planetid === excludeSystem) planetid = -1;

		if (planetid &gt;= 0) {
			// check if this planet has any existing declarations
			var existing = this.$illegalGoodsList(planetid);
			var count = 0;
			for (var i = 0; i &lt; existing.length; i++) {
				// count all the non-default items
				if (existing[i].end != 0) count += 1;
			}
			// if this planet already has an item, skip it.
			if (count &gt; 0) planetid = -1;
		}
		tries += 1;
	} while (planetid === -1 &amp;&amp; tries &lt; 5);
	if (planetid === -1 &amp;&amp; this._debug) log(this.name, &quot;attempt to add illegal good failed&quot;);
	// if we didn&#39;t end up finding a planet, exit now
	if (planetid === -1) return;

	// get a list of possibilities
	var poss = this.$getPossibilitiesByGovernment(sys.government, sys.description);
	// pick one from the list
	var pick = this.$rand(poss.length) - 1;
	// add the definition
	this.$applyDefinition(planetid, poss[pick], startDays);
}

//-------------------------------------------------------------------------------------------------------------
// get a list of possible illegal goods for a particular government type (0-7)
this.$getPossibilitiesByGovernment = function $getPossibilitiesByGovernment(govType, planetDescription) {
	var list = [];
	for (var i = 0; i &lt; this._possibilities.length; i++) {
		if (this._possibilities[i].period != -1 &amp;&amp; this._possibilities[i].govTypes.indexOf(govType.toString()) != -1 &amp;&amp;
			(this._possibilities[i].properties === &quot;&quot; || this.$checkPlanetDescription(planetDescription, this._possibilities[i].properties) === true) &amp;&amp;
			Math.random() &lt; this._possibilities[i].chance) {
			list.push(this._possibilities[i]);
		}
	}
	return list;
}

//-------------------------------------------------------------------------------------------------------------
// checks the planet description to see if the property text is somewhere in it.
// properties can be a single piece of text (eg &quot;something&quot;), or split with a &quot;,&quot; character (eg &quot;something,somethingelse&quot;)
this.$checkPlanetDescription = function $checkPlanetDescription(descr, properties) {
	if (properties.indexOf(&quot;,&quot;) === -1) {
		if (descr.indexOf(properties) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	} else {
		var proplist = properties.split(&quot;,&quot;);
		var result = false;
		for (var i = 0; i &lt; proplist.length; i++) {
			if (descr.indexOf(proplist[i]) &gt;= 0) result = true;
		}
		return result;
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns a list of planets of a particular government type (0-7) and (optionally) with a description that contains the &quot;option&quot; parameter (eg &quot;civil war&quot;)
this.$getSystemsByGovernment = function $getSystemsByGovernment(govType, options) {
	var planets = SystemInfo.filteredSystems(this, function (other) {
		return (other.government === govType &amp;&amp; ((options == null || options === &quot;&quot;) || other.description.indexOf(options) &gt;= 0));
	});
	return planets;
}

//-------------------------------------------------------------------------------------------------------------
// adds a definition to the active list
// sysID = planet ID
// def   = illegal goods definition
// startDays = number of days to take off the current date, to start this item in the past. This is to simulate an active galaxy, so everything doesn&#39;t start from now.
this.$applyDefinition = function $applyDefinition(sysID, def, startDays) {

	//log(this.name, &quot;adding illegal good definition for system &quot; + sysID + &quot; for commodity &quot; + def.commodity);

	// does this definition already exist for this planet?
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].systemID === sysID &amp;&amp; this._illegalGoods[i].commodity === def.commodity) return;
	}

	var stime = 0;
	var etime = 0;

	// if we haven&#39;t been passed a start time, just do it for sometime in the last day
	if (def.period != -1) {
		if (this._startUpRunning === false) {
			if (startDays == null || startDays === 0) {
				stime = clock.seconds - this.$rand(86400);
			} else {
				// otherwise, the starttime is subtracted from the current clock (as days), converted to seconds
				stime = clock.seconds - (startDays * 86400);
			}
			// set up the end point
			etime = stime + ((def.period + (this.$rand(10) - 5)) * 86400);
		} else {
			// if this is running during the startup routine, we need to reapply start and end times after it&#39;s completed
			if (startDays != 0) stime = (startDays * 86400) * -1;
			// set up the end point
			etime = ((def.period + (this.$rand(10) - 5)) * 86400);
		}
	} else {
		stime = 0;
		etime = 0;
	}
	if (def.period != -1 &amp;&amp; this._debug) log(this.name, &quot;adding illegal good definition for system &quot; + sysID + &quot; for commodity &quot; + def.commodity + &quot;, starting &quot; + clock.clockStringForTime(stime) + &quot;, ending &quot; + clock.clockStringForTime(etime));

	this._illegalGoods.push({
		systemID: sysID,
		commodity: def.commodity,
		started: stime,
		end: etime,
		description: def.description,
		permit: def.permit,
		scale: def.scale
	});

}

//-------------------------------------------------------------------------------------------------------------
// update start/end times created during the startup process
this.$correctStartEndDates = function $correctStartEndDates() {
	for (var i = 0; i &lt; this._illegalGoods.length; i++) {
		if (this._illegalGoods[i].started &lt; 0) {
			var stime = clock.adjustedSeconds + this._illegalGoods[i].started;
			var etime = stime + this._illegalGoods[i].end;
			this._illegalGoods[i].started = stime;
			this._illegalGoods[i].end = etime;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// look for any expired items and remove them from the array, and possibly add a new one
this.$cleanup = function $cleanup() {
	// remove expired items
	for (var i = this._illegalGoods.length - 1; i &gt;= 0; i--) {
		if (this._illegalGoods[i].end != 0 &amp;&amp; clock.adjustedSeconds &gt; this._illegalGoods[i].end) {
			if (this._debug) log(this.name, &quot;removing item: &quot; + this._illegalGoods[i].systemID + &quot;, &quot; + this._illegalGoods[i].commodity + &quot; ended: &quot; + clock.clockStringForTime(this._illegalGoods[i].end))
			// do we have a permit for this one? If so, delete it
			for (var j = this._permits.length - 1; j &gt;= 0; j--) {
				if (this._permits[j].systemID === this._illegalGoods[i].systemID &amp;&amp; this._illegalGoods[i].commodity.indexOf(this._permits[j].commodity) &gt;= 0) {
					this._permits.splice(j, 1);
				}
			}
			this._illegalGoods.splice(i, 1);
		}
	}

	// add new items
	var total = this.$rand(5) - this.$rand(3);
	if (total &gt; 0) {
		if (this._debug) log(this.name, &quot;going to try adding &quot; + total + &quot; new items&quot;);
		for (var i = 1; i &lt;= total; i++) {
			// add new items, but not in the current system, because the illegal market script won&#39;t pick them up until the game is reloaded
			this.$addNewItem(1, system.ID);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// checks if the player has a permit for the system
// todo: add newcargos permit check
this.$playerHasPermit = function $playerHasPermit(sysID, cmdty, check) {
	for (var i = 0; i &lt; this._permits.length; i++) {
		if (this._permits[i].systemID === sysID &amp;&amp; this._permits[i].commodity === cmdty) {
			// are we doing a validity check
			if (check === true &amp;&amp; this._permits[i].fake != 0) {
				// did it pass?
				if (Math.random() &gt; this._permits[i].fake) {
					// oh dear, looks like it was discovered as fake
					return false;
				} else {
					// phew! passed!
					return true;
				}
			} else {
				// it&#39;s a bought one (or we&#39;re not bothering with how fake it is), so it&#39;s ok
				return true;
			}
		}
	}
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// removes a permits from the list
this.$removePermit = function $removePermit(sysID, cmdty) {
	for (var i = this._permits.length - 1; i &gt;= 0; i--) {
		if (this._permits[i].systemID === sysID &amp;&amp; this._permits[i].commodity === cmdty) {
			this._permits.splice(i, 1);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns display version of commodity list
this.$translateCommodityList = function $translateCommodityList(cmdty_list) {
	var list = cmdty_list.split(&quot;,&quot;);
	var ret = &quot;&quot;;
	for (var i = 0; i &lt; list.length; i++) {
		ret += (ret === &quot;&quot; ? &quot;&quot; : &quot;, &quot;) + displayNameForCommodity(list[i]);
	}
	return ret;
}

//-------------------------------------------------------------------------------------------------------------
// adds the F8F8 comment for illegal goods
this.$updateDescriptions = function $updateDescriptions() {
	// note: for some reason descriptions added via the illegal market script are not being displayed. So we&#39;re forcing the issue here.
	var nocomment = expandDescription(&quot;[oolite-commodity-no-comment]&quot;);
	if (player.ship.docked) {
		var sMarket = player.ship.dockedStation.market;
	} else {
		if (player.ship.target &amp;&amp; player.ship.target.isStation) {
			var bcMarket = Ship.shipDataForKey(player.ship.target.dataKey)[&quot;market_broadcast&quot;];
			if (!bcMarket) bcMarket = true;
			else {
				var trues = [&quot;1&quot;, &quot;true&quot;, &quot;yes&quot;];
				bcMarket = bcMarket.toLowerCase();
				if (trues.indexOf(bcMarket) !== -1) bcMarket = true;
				else bcMarket = false;
			}
			if (bcMarket) {
				var sMarket = player.ship.target.market;
			} else {
				var sMarket = this._sMarket;
			}
		} else {
			var sMarket = this._sMarket;
		}
	}
	var goods = [];
	if (system.ID != -1) goods = this.$illegalGoodsList(system.ID, true);
	if (system.ID === -1) return;

	for (var cmdty in sMarket) {
		// work out what the comment should be for this commodity
		var cmt = nocomment;
		// special cases
		if (cmdty === &quot;slaves&quot;) cmt = expandDescription(&quot;[oolite-commodity-illegal]&quot;);
		if (this._defaultAdditions.indexOf(cmdty) &gt;= 0) cmt = expandDescription(&quot;[&quot; + cmdty + &quot;-legality-description]&quot;);
		// if this is an illegal commodity at this station go and grab the description for it from our data
		if (sMarket[cmdty].legality_import != 0 || sMarket[cmdty].legality_export != 0) {
			for (var i = 0; i &lt; goods.length; i++) {
				if (goods[i].commodity.indexOf(cmdty) &gt;= 0 &amp;&amp; goods[i].description != &quot;&quot;) cmt = goods[i].description;
			}
		} else {
			// if it&#39;s legal here, but not legal at the main station, put up a warning message
			if (system.mainStation.market[cmdty].legality_import != 0 || system.mainStation.market[cmdty].legality_export != 0) {
				cmt = expandDescription(&quot;[main-station-illegal]&quot;);
			} else {
				// otherwise, just use the &quot;no comment&quot; comment.
				cmt = nocomment;
			}
		}
		// get the current comment
		var orig = manifest.comment(cmdty);
		// in most cases that&#39;s all we&#39;ll need
		var curr_cmt = orig;
		// but if another OXP has added their own comments, we&#39;ll need to get the first line
		// if the OXP adds comments without first adding a linebreak this won&#39;t work, but it should be good for most circumstances
		if (orig.indexOf(&quot;\n&quot;) &gt;= 0) curr_cmt = orig.substring(0, orig.indexOf(&quot;\n&quot;));
		// replace the current comment with our new one
		orig = orig.replace(curr_cmt, cmt);
		// plonk it back into the comment field for this commodity
		manifest.setComment(cmdty, orig);
	}
}

//-------------------------------------------------------------------------------------------------------------
// mark local systems on the galactic chart that have illegal goods
this.$markSystems = function $markSystems() {
	// clear out existing marks
	for (var i = 0; i &lt; this._markedSystems.length; i++) {
		mission.unmarkSystem({
			system: this._markedSystems[i],
			name: &quot;illegalgoods&quot;
		});
	}
	// reset the array
	this._markedSystems.length = 0;

	if (this._enableMarkedSystems === false) return;
	// get all systems in 10 ly
	var list = system.info.systemsInRange(this._markedSystemRange);
	// mark systems that have illegal goods (other than narcs or slaves)
	// system: firearms only = orange, everything else yellow
	for (var i = 0; i &lt; list.length; i++) {
		var goods = this.$illegalGoodsList(list[i].systemID);
		if (goods.length &gt; 0) {
			this._markedSystems.push(list[i].systemID);
			if (goods.length &gt; 1) {
				// if there&#39;s more than one illegal, mark it with yellow
				mission.markSystem({
					system: list[i].systemID,
					name: &quot;illegalgoods&quot;,
					markerColor: &quot;yellowColor&quot;,
					markerShape: &quot;MARKER_DIAMOND&quot;
				});
			} else {
				// if the only illegal is firearms, mark it with orange
				if (goods[0].commodity === &quot;firearms&quot;) {
					mission.markSystem({
						system: list[i].systemID,
						name: &quot;illegalgoods&quot;,
						markerColor: &quot;orangeColor&quot;,
						markerShape: &quot;MARKER_DIAMOND&quot;
					});
				} else {
					// otherwise mark it with yellow
					mission.markSystem({
						system: list[i].systemID,
						name: &quot;illegalgoods&quot;,
						markerColor: &quot;yellowColor&quot;,
						markerShape: &quot;MARKER_DIAMOND&quot;
					});
				}
			}
		}
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_illegalmarket.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_IllegalMarket&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Applies illegal goods data to GalCop stations.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

/*
Special Notes:
In order for the market script to work out when is the right time to populate data, I&#39;m monitoring the clock.
As soon as a fractional component appears we can be pretty sure enough of the system has been loaded (either via a saved game or after initialising a new game)
for the &quot;smugglers_illegal.js&quot; script to do it&#39;s work successfully.
I&#39;ve tested this methodology against the standard start options and with the &quot;start choices&quot; OXP and it appears to work OK.
*/

//-------------------------------------------------------------------------------------------------------------
this.updateGeneralCommodityDefinition = function (goodDefinition, station, systemID) {

	var si = worldScripts.Smugglers_Illegal;

	if (si &amp;&amp; (station === 0 || station == null || (station &amp;&amp; station.allegiance === &quot;galcop&quot;))) {
		// if there are factional seconds we can assume enough of the game have been loaded in order to populate the illegal goods definitions
		if (si._dataLoaded === false &amp;&amp; parseInt((clock.seconds % 1) * 10000) != 0) {
			si.$initialiseData();
		}

		if (si._dataLoaded === true) {
			// does this system have any commodities that need adjusting?
			var sysID = systemID;
			if (sysID === -1) {
				// get the players witchspace destination
				if (si._witchspaceDestination != -1) {
					sysID = si._witchspaceDestination;
				} else {
					// work out the next system from the players route
					var p = player.ship;
					var target = p.targetSystem;
					var myRoute = System.infoForSystem(galaxyNumber, si._originating).routeToSystem(System.infoForSystem(galaxyNumber, target), p.routeMode);
					sysID = myRoute.route[1];
				}
			}

			var goods = si.$illegalGoodsList(sysID);
			for (var i = 0; i &lt; goods.length; i++) {
				// each item in goods can have multiple commodities listed, so see if goodDefinition.key is contained in the commodity list of goods
				if (goods[i].commodity.indexOf(goodDefinition.key) &gt;= 0) {
					// we have a winner, so adjust the legality property
					goodDefinition.legality_import = goods[i].scale;
					// prices will be changed via the Smugglers_Illegal.$updateSystemPrices routine 
				}
			}
		}
	}

	return goodDefinition;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_movecargo.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_MoveCargo&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the process of moving cargo into the smuggling compartment during flight.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this._scoopedCargo = [];
this._commodityUnits = {};
this._cycleIndex = -1;
this._selected = null;

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
    var m = system.mainStation.market;
    if (m) {
        var list = Object.keys(m);
        for (var i = 0; i &lt; list.length; i++) {
            var c = m[list[i]];
            this._commodityUnits[c.key] = (c.quantity_unit === &quot;0&quot; ? &quot;t&quot; : (c.quantity_unit === &quot;1&quot; ? &quot;kg&quot; : &quot;g&quot;));
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedAtStation = function (station) {
    this._scoopedCargo.length = 0;
}

//-------------------------------------------------------------------------------------------------------------
this.mode = function () {
    // cycle through available, non-labelled cargo, including scooped items (but not escape pods)
    // group precious items: existing cargo at launch as amounts (eg 15g gemstones), scooped cargo amounts (eg 9kg gold)
    var p = player.ship;
    var list = [];
    var cargo = p.manifest.list;
    var sdm = worldScripts.Smugglers_DockMaster;
    var sde = worldScripts.Smugglers_Equipment;
    var sdmc = worldScripts.Smugglers_MoveCargo;
    var itemcount = 0;

    // add the scooped items first
    for (var i = 0; i &lt; sdmc._scoopedCargo.length; i++) {
        var item = sdmc._scoopedCargo[i];
        if (item.isValid &amp;&amp; item.status === &quot;STATUS_IN_HOLD&quot;) {
            list.push({
                text: &quot;Move &quot; + item.commodityAmount + sdmc._commodityUnits[item.commodity] + &quot;  &quot; + displayNameForCommodity(item.commodity) + &quot; (scooped)&quot;,
                scoopedItem: item,
                commodity: item.commodity,
                quantity: item.commodityAmount,
                unit: sdmc._commodityUnits[item.commodity]
            });
        }
    }

    // then the items in the hold.
    var existing = [];
    for (var i = 0; i &lt; cargo.length; i++) {
        // only show standard (non-OXP) commodity items
        if (sde._commodityIDList.indexOf(cargo[i].commodity) &gt;= 0) {
            var q = cargo[i].quantity - sdmc.$scoopedCargoAmount(cargo[i].commodity);
            // don&#39;t allow scooped escape pods to be moved
            if (cargo[i].commodity === &quot;slaves&quot; &amp;&amp; q &gt; 0 &amp;&amp; worldScripts.EscapePodTweaks &amp;&amp; worldScripts.EscapePodTweaks._escapePods.length &gt; 0) {
                q -= worldScripts.EscapePodTweaks._escapePods;
            }
            // todo: how to handle scooped escape pods when escape pod tweaks isn&#39;t installed
            
            // make sure we don&#39;t move relabelled cargo
            if (sdm._cargoLabelled.length &gt; 0) {
                for (var j = 0; j &lt; sdm._cargoLabelled.length; j++) {
                    if (sdm._cargoLabelled[j].newCommodity === cargo[i].commodity) q -= sdm._cargoLabelled[j].quantity;
                }
            }
            if (q &gt; 0) {
                switch (cargo[i].unit) {
                    case &quot;t&quot;:
                        if (existing.indexOf(cargo[i].commodity) === -1) {
                            list.push({
                                text: &quot;Move 1&quot; + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
                                scoopedItem: null,
                                commodity: cargo[i].commodity,
                                quantity: 1,
                                unit: cargo[i].unit
                            });
                            existing.push(cargo[i].commodity);
                        }
                        break;
                    case &quot;kg&quot;:
                        var step = 1000;
                        if (step &gt; q) step = q;
                        var checktot = q;
                        for (var k = 1; k &lt;= q; k += step) {
                            checktot -= step;
                            if (checktot &lt; 0) {
                                list.push({
                                    text: &quot;Move &quot; + (step + checktot).toString() + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
                                    scoopedItem: null,
                                    commodity: cargo[i].commodity,
                                    quantity: (step + checktot),
                                    unit: cargo[i].unit
                                });
                            } else {
                                if (existing.indexOf(cargo[i].commodity) === -1) {
                                    list.push({
                                        text: &quot;Move &quot; + step.toString() + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
                                        scoopedItem: null,
                                        commodity: cargo[i].commodity,
                                        quantity: step,
                                        unit: cargo[i].unit
                                    });
                                    existing.push(cargo[i].commodity);
                                }
                            }
                        }
                        break;
                    case &quot;g&quot;:
                        var step = 1000000;
                        if (step &gt; q) step = q;
                        var checktot = q;
                        for (var k = 1; k &lt;= q; k += step) {
                            checktot -= step;
                            if (checktot &lt; 0) {
                                list.push({
                                    text: &quot;Move &quot; + (step + checktot).toString() + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
                                    scoopedItem: null,
                                    commodity: cargo[i].commodity,
                                    quantity: (step + checktot),
                                    unit: cargo[i].unit
                                });
                            } else {
                                if (existing.indexOf(cargo[i].commodity) === -1) {
                                    list.push({
                                        text: &quot;Move &quot; + step.toString() + cargo[i].unit + &quot;  &quot; + cargo[i].displayName,
                                        scoopedItem: null,
                                        commodity: cargo[i].commodity,
                                        quantity: step,
                                        unit: cargo[i].unit
                                    });
                                    existing.push(cargo[i].commodity);
                                }
                            }
                        }
                        break;
                }
            }
        }
    }

    if (list.length === 0) return;

    sdmc._cycleIndex += 1;
    if (sdmc._cycleIndex &gt;= list.length) sdmc._cycleIndex = 0;
    sdmc._selected = list[sdmc._cycleIndex];
    player.consoleMessage(list[sdmc._cycleIndex].text);
}

//-------------------------------------------------------------------------------------------------------------
this.activated = function () {
    // move the selected item 
    var sde = worldScripts.Smugglers_Equipment;
    var sdmc = worldScripts.Smugglers_MoveCargo;
    if (sdmc._selected != null) {
        var item = sdmc._selected;
        // any space left for transfer?
        var checkAmount = item.quantity;
        if (item.unit === &quot;kg&quot;) checkAmount /= 1000;
        if (item.unit === &quot;g&quot;) checkAmount /= 1000000;
        if (sde.$availableSpace() &lt; checkAmount) {
            player.consoleMessage(&quot;Insufficient space in smuggling compartment&quot;);
            return;
        }
        sde.$addCargoToCompartment(item.commodity, displayNameForCommodity(item.commodity), item.quantity, item.unit);
        if (item.scoopedItem != null) {
            for (var i = 0; i &lt; sdmc._scoopedCargo.length; i++) {
                if (sdmc._scoopedCargo[i] == item.scoopedItem) {
                    sdmc._scoopedCargo.splice(i, 1);
                    break;
                }
            }
            item.scoopedItem.remove(true);
        }
        var p = player.ship;
        // the manifest of any &quot;kg&quot; or &quot;g&quot; type commodities can&#39;t be reduced (in-flight only)
        // so add 1 to the value so Oolite with consider the commodity as being out of the hold
        var bugfix = false;
        if (item.unit === &quot;kg&quot; || item.unit === &quot;g&quot;) {
            p.manifest[item.commodity] += 1;
            bugfix = true;
        }
        // if we added one, make sure we add it so we can take it away again.
        p.manifest[item.commodity] -= (item.quantity + (bugfix === true ? 1 : 0));
        player.consoleMessage(item.quantity + item.unit + &quot;  &quot; + displayNameForCommodity(item.commodity) + &quot; transferred&quot;);
        sdmc._selected = null;
        sdmc._cycleIndex = -1;
        // force an update of the manifest MFD, as it won&#39;t detect changes in kg or g type commodities
        if (item.unit != &quot;t&quot; &amp;&amp; worldScripts[&quot;manifest_mfd&quot;] &amp;&amp; p.equipmentStatus(&quot;EQ_MANIFEST_MFD&quot;) === &quot;EQUIPMENT_OK&quot;) {
            worldScripts[&quot;manifest_mfd&quot;].$updateManifestMFD();
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipScoopedOther = function (cargo) {
    // we don&#39;t move escape pods (which will have a crew)
    if (cargo.isValid === false) return;
    if (cargo.commodity != &quot;slaves&quot; || (!cargo.crew || cargo.crew.length === 0)) {
        if (cargo.script.shipWasDumped) cargo.script.$sdmovr_shipWasDumped = cargo.script.shipWasDumped;
        cargo.script.shipWasDumped = this.$sdm_shipWasDumped;
        this._scoopedCargo.push(cargo);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$sdm_shipWasDumped = function $sdm_shipWasDumped(dumper) {
    if (this.ship.script.$sdmovr_shipWasDumped) this.ship.script.$sdmovr_shipWasDumped(dumper);
    if (dumper.isPlayer) {
        var sdmc = worldScripts.Smugglers_MoveCargo;
        for (var i = 0; i &lt; sdmc._scoopedCargo.length; i++) {
            if (sdmc._scoopedCargo[i] == this.ship) {
                sdmc._scoopedCargo.splice(i, 1);
                break;
            }
        }
    }
    // detach our custom script
    delete this.ship.script.shipWasDumped;
    if (this.ship.script.$sdmovr_shipWasDumped) {
        this.ship.script.shipWasDumped = this.ship.script.$sdmovr_shipWasDumped;
        delete this.ship.script.$sdmovr_shipWasDumped;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$scoopedCargoAmount = function $scoopedCargoAmount(cmdty) {
    var sdmc = worldScripts.Smugglers_MoveCargo;
    if (sdmc._scoopedCargo.length === 0) return 0;
    var amt = 0;
    var sc = sdmc._scoopedCargo;
    for (var i = 0; i &lt; sc.length; i++) {
        if (sc[i].commodity === cmdty) amt += sc[i].commodityAmount;
    }
    return amt;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_oolite_contracts_fix.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_Oolite_Contracts_Fix&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Fixes the Oolite Cargo contracts system so it doesn&#39;t pick illegal commodities.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this.startUp = function () {
	var w = worldScripts[&quot;oolite-contracts-cargo&quot;];
	w.$hide = w._initialiseCargoContractsForSystem;
	if (w.author.indexOf(&quot;Switeck&quot;) &gt;= 0) {
		w._initialiseCargoContractsForSystem = this.$switech_initialiseCargoContractsForSystem;
	} else {
		w._initialiseCargoContractsForSystem = this.$core_initialiseCargoContractsForSystem;
	}
}

// initialise a new cargo contract list for the current system
this.$core_initialiseCargoContractsForSystem = function $core_initialiseCargoContractsForSystem() {
	// clear list
	this.$contracts = [];

	// this is not the same algorithm as in 1.76, but should give
	// similar results with comparable efficiency.

	// no point in generating too many, as route-finding is slow
	var numContracts = Math.floor(5 * Math.random() + 5 * Math.random() + 5 * Math.random() + (player.contractReputationPrecise * Math.random()));
	if (player.contractReputationPrecise &gt;= 0 &amp;&amp; numContracts &lt; 5) {
		numContracts += 5;
	}
	if (numContracts &gt; 16) {
		numContracts = 16;
	} else if (numContracts &lt; 0) {
		numContracts = 0;
	}
	// some of these possible contracts may be discarded later on

	for (var i = 0; i &lt; numContracts; i++) {
		var cargo = new Object;

		// pick a random system to take the goods to
		var destination = Math.floor(Math.random() * 256);

		// discard if chose the current system
		if (destination === system.ID) {
			continue;
		}

		// get the SystemInfo object for the destination
		var destinationInfo = System.infoForSystem(galaxyNumber, destination);
		if (destinationInfo.sun_gone_nova) {
			continue;
		}
		var daysUntilDeparture = 1 + (Math.random() * (7 + player.contractReputationPrecise - destinationInfo.government));
		if (daysUntilDeparture &lt;= 0) {
			// loses some more contracts if reputation negative
			continue;
		}

		var si = worldScripts.Smugglers_Illegal;
		var illegal = null;
		if (si) {
			illegal = si.$illegalGoodsListCommodityOnly(destination, true);
			// add slaves to the list
			illegal.push(&quot;slaves&quot;);
		}

		var commodities = Object.keys(system.mainStation.market);
		var attempts = 0;
		do {
			var remotePrice = 0;
			attempts++;
			var commodity = commodities[Math.floor(Math.random() * commodities.length)];
			// sub-tc contracts only available for top rep
			if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] != 0 &amp;&amp; player.contractReputationPrecise &lt; 6.5) {}
			// ignore commodities with 0 availability here
			else if (system.mainStation.market[commodity].quantity === 0) {}
			// ignore any illegal goods
			else if (illegal &amp;&amp; illegal.indexOf(commodity) &gt;= 0) {} else {
				remotePrice = this._priceForCommodity(commodity, destinationInfo);
			}
		} while (remotePrice &lt; system.mainStation.market[commodity].price / 20 &amp;&amp; attempts &lt; 10);
		if (attempts === 10) {
			// failed to find a good one.
			continue;
		}
		cargo.commodity = commodity;

		var amount = 0;
		while (amount &lt; 30) {
			var unitsize = 1;
			// larger unit sizes for kg/g commodities
			if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] === 1) {
				unitsize += Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6) + Math.floor(Math.random() * 6);
			} else if (system.mainStation.market[commodity][&quot;quantity_unit&quot;] === 2) {
				unitsize += Math.floor(Math.random() * 16) + Math.floor(Math.random() * 11) + Math.floor(Math.random() * 6);
			}
			amount += (1 + Math.floor(Math.random() * 32)) * (1 + Math.floor(Math.random() * 16)) * unitsize;
		}

		if (amount &gt; 125 &amp;&amp; system.mainStation.market[commodity][&quot;quantity_unit&quot;] === 0) {
			// reduce the number of contracts only suitable for Anacondas
			amount = Math.floor(amount / Math.floor(1 + (Math.random() * 4)));
		}
		cargo.size = amount;

		// adjustment to prices based on quantity (larger = more profitable)
		var discount = Math.min(10 + Math.floor(amount / 10), 35);

		var unitPrice = system.mainStation.market[commodity].price * (100 - discount) / 1000;
		var localValue = Math.floor(unitPrice * amount);
		remotePrice = remotePrice * (200 + discount) / 200;
		var remoteValue = Math.floor(remotePrice * amount);
		var profit = remoteValue - localValue;

		// skip if unprofitable
		if (profit &lt;= 100) {
			continue;
		}

		// check that a route to the destination exists
		// route calculation is expensive so leave this check to last
		var routeToDestination = system.info.routeToSystem(destinationInfo);

		// if the system cannot be reached, ignore this contract
		if (!routeToDestination) {
			continue;
		}

		// we now have a valid destination, so generate the rest of
		// the parcel details

		cargo.destination = destination;
		// we&#39;ll need this again later, and route calculation is slow
		cargo.route = routeToDestination;

		// higher share for transporter for longer routes, less safe systems
		var share = 100 + destinationInfo.government - (10 * routeToDestination.route.length);
		if (share &lt; 10) {
			share = 10;
		}
		share = 100 - share;

		// safety: now multiply the fee by 2 compared with 1.76 contracts
		// prevents exploit discovered by Mad Hollander at
		// http://aegidian.org/bb/viewtopic.php?p=188127
		localValue *= 2;
		// this may need to be raised further

		// absolute value of profit remains the same
		var fee = localValue + Math.floor(profit * (share / 100));
		fee -= fee % 20; // round to nearest 20 credits;

		cargo.payment = fee;
		cargo.deposit = localValue - (localValue % 20);
		if (cargo.deposit &gt;= cargo.payment) {
			// rare but not impossible; last safety check
			return;
		}

		// time allowed for delivery is time taken by &quot;fewest jumps&quot;
		// route, plus timer above. Higher reputation makes longer
		// times available.
		cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture * 86400) + (cargo.route.time * 3600);

		// add parcel to contract list
		this._addCargoContractToSystem(cargo);
	}

}

// initialise a new cargo contract list for the current system
this.$switech_initialiseCargoContractsForSystem = function $switech_initialiseCargoContractsForSystem() {
	// clear list
	this.$contracts = [];

	// this is not the same algorithm as in 1.76, but should give similar results with comparable efficiency.

	// no point in generating too many, as route-finding is slow
	var numContracts = Math.floor(5 * (Math.random() + Math.random()) + (system.government + player.contractReputationPrecise - player.bounty * 0.02) * Math.random());
	// I added that bounty can reduce the number of contracts. Corporate state systems can add extra contracts.
	if (numContracts &lt; 0) numContracts = 0;
	if (player.contractReputationPrecise &gt;= 0 &amp;&amp; numContracts &lt; 5) numContracts += 5;
	if (numContracts &gt; 18) numContracts = 18;

	// some of these possible contracts may be discarded later on
	var nearbysystems = system.info.systemsInRange(80 - player.contractReputationPrecise * 7); // 31-80-129 LY range...done here to save recalculations time.

	log(this.name, &quot; player.contractReputation= &quot; + player.contractReputationPrecise + &quot; numContracts= &quot; + numContracts + &quot; nearbysystems.length= &quot; + nearbysystems.length);
	//	log(this.name,&quot; player.contractReputation= &quot;+player.contractReputation+&quot; numContracts= &quot;+numContracts+&quot; nearbysystems.length= &quot;+nearbysystems.length+&quot; nearbysystems= &quot;+nearbysystems);

	for (var i = 0; i &lt; numContracts; i++) {
		var scratchval = 1;
		var attempts = 0;
		do {
			var scratchval = 1;
			attempts++;
			// pick a random system to take the goods to
			//			var destination = Math.floor(Math.random()*256);	// ORIGINAL -- FOR TESTING ONLY!
			var destination = nearbysystems[Math.floor(Math.random() * nearbysystems.length)].systemID;
			//		log(this.name,&quot; destination = &quot;+destination);

			// discard if chose the current system
			if (destination === system.ID) {
				var scratchval = 0;
			} else {
				// get the SystemInfo object for the destination
				var destinationInfo = System.infoForSystem(galaxyNumber, destination);

				// Decides firsthand to drop a bad system and choose another one?
				if (Math.abs(system.economy - destinationInfo.economy) &lt; (1 + player.contractReputationPrecise * 0.28) &amp;&amp; player.contractReputationPrecise &lt; 6.5 &amp;&amp; system.economy &lt; 7) {
					var scratchval = 0; // Discarded, since identical or &quot;worse&quot; economies leave little opportunity for profitable trading.

				} else {
					// check that a route to the destination exists
					// route calculation is expensive so leave this check to last
					var routeToDestination = system.info.routeToSystem(destinationInfo);
					//log(this.name,&quot; routeToDestination = &quot;+routeToDestination);
					// if the system cannot be reached, ignore this contract
					if (!routeToDestination) {
						var scratchval = 0; // No route, no point trying!
					} else {
						var daysUntilDeparture = 1 + (Math.random() * (7 + player.contractReputationPrecise - destinationInfo.government)); // NEEDS a better estimate based on time needed to reach target!
						if (daysUntilDeparture &lt; 0) var scratchval = 0; // negative reputation can make a contract out-of-time failed before starting.
					}
				}
			}
		} while (scratchval === 0 &amp;&amp; attempts &lt; 10);
		if (attempts &gt; 9) continue; // failed to find a good destination.

		// we now have a valid destination, so generate the rest of the cargo contract details

		//log(this.name,&quot; daysUntilDeparture = &quot;+daysUntilDeparture);
		//		var commodities = Object.keys(system.mainStation.market);
		var attempts = 0;
		do {
			var unitPrice = 0;
			var unitMinPrice = 0;
			var unitMaxPrice = 0;
			var remotePrice = 0;
			var remoteMinPrice = 0;
			attempts++;

			// if destinationInfo.economy &lt; system.economy	means destination is more industrial than start locaction.
			// if system.economy &lt;4 then it&#39;s &quot;industrial&quot; so choose comp,lux,mach,alloys (+firearms?)
			// else it&#39;s &quot;agricultural&quot; so choose food,textiles,radioactives,liquor_wines,furs,minerals (+slaves, narcotics?)
			// Odds get lowered if offender/fugitive, raised if high reputation...forcing more controlled items if &quot;bad&quot; and more gold/plat/gems if &quot;good&quot;.

			//			var commodities = [&quot;food&quot;,&quot;textiles&quot;,&quot;radioactives&quot;,&quot;slaves&quot;,&quot;liquor_wines&quot;,&quot;luxuries&quot;,&quot;narcotics&quot;,&quot;computers&quot;,&quot;machinery&quot;,&quot;alloys&quot;,&quot;firearms&quot;,&quot;furs&quot;,&quot;minerals&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;];
			//			var commodity = commodities[Math.floor(Math.random()*commodities.length)];	// Chooses random commondity
			if (system.economy &gt; destinationInfo.economy || system.economy &gt; 5) {
				if (system.economy &lt; destinationInfo.economy + 1 + player.contractReputationPrecise * 0.4) { // Eliminates marginal profit commodities from similar agri economies
					var commodities = [&quot;slaves&quot;, &quot;narcotics&quot;, &quot;liquor_wines&quot;, &quot;alloys&quot;, &quot;furs&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;]; // 7 entries, removed Gold!
					var preccutoff = 5;
					var scratchval = Math.floor(Math.random() * (commodities.length - 3) + 3); // Drops the controlled items and low profit stuff.
				} else {
					var commodities = [&quot;slaves&quot;, &quot;narcotics&quot;, &quot;food&quot;, &quot;minerals&quot;, &quot;textiles&quot;, &quot;radioactives&quot;, &quot;liquor_wines&quot;, &quot;furs&quot;, &quot;gold&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;]; // 11 entries, sorted from worst to best
					var preccutoff = 8;
					var scratchval = Math.floor(Math.random() * (commodities.length - 5) + 5); // Drops the controlled items and low profit stuff.
				}
			} else if (system.economy &gt; destinationInfo.economy - Math.max(0, player.contractReputationPrecise * 0.3)) { // Eliminates low-profit commodities when start economy === destination (identical ind economies)
				var commodities = [&quot;alloys&quot;, &quot;furs&quot;, &quot;gold&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;]; // 5 entries
				var preccutoff = 2;
				var scratchval = Math.floor(Math.random() * commodities.length);
			} else if (system.economy &gt; destinationInfo.economy - 1 - player.contractReputationPrecise * 0.2) { // Eliminates low-profit commodities when start economy is only slightly more industrial than destination.
				var commodities = [&quot;narcotics&quot;, &quot;firearms&quot;, &quot;computers&quot;, &quot;alloys&quot;, &quot;furs&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;]; // 7 entries, removed Gold!
				var preccutoff = 5;
				var scratchval = Math.floor(Math.random() * (commodities.length - 2) + 2); // Drops the controlled items and low profit stuff.
			} else {
				var commodities = [&quot;narcotics&quot;, &quot;firearms&quot;, &quot;alloys&quot;, &quot;machinery&quot;, &quot;luxuries&quot;, &quot;computers&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;]; // 8 entries, sorted from worst to best, removed Gold!
				var preccutoff = 6;
				var scratchval = Math.floor(Math.random() * (commodities.length - 2) + 2); // Drops the controlled items and low profit stuff.
			}

			if (player.contractReputationPrecise &lt; 6.5 - Math.random() * 5) { // At rep&gt;2, there&#39;s a chance of getting ONLY good contracts. The odds of this are much better by rep&gt;5.
				var scratchval = Math.floor(Math.random() * (preccutoff + player.contractReputationPrecise * 0.1 - player.bounty * 0.01));
			}

			if (scratchval &lt; 0) var scratchval = 0; // If bad rep plus bad bounty pushes off leftside of the chart, give player &quot;worst&quot; contract.
			if (scratchval &gt;= preccutoff &amp;&amp; player.contractReputationPrecise &lt; 6.5) var scratchval = preccutoff - 1; // Prevents Gold contracts before player.contractReputation === 7
			if (scratchval &gt; commodities.length - 1) var scratchval = commodities.length - 1; // If high rep pushes off rightside of the chart, give player &quot;best&quot; contract.

			//			var commodities = [&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;];	// 3 entries, tests only Gold/Plat/Gems!
			//			var scratchval = Math.floor(Math.random()*commodities.length);
			var commodity = commodities[scratchval];

			var si = worldScripts.Smugglers_Illegal;
			var illegal = null;
			if (si) {
				illegal = si.$illegalGoodsListCommodityOnly(destination, true);
				// add slaves to the list
				illegal.push(&quot;slaves&quot;);
			}

			if (illegal &amp;&amp; illegal.indexOf(commodity) &gt;= 0) { // don&#39;t pick commodities illegal at the destination
				if (system.mainStation.market[commodity].quantity &gt; 0) { // ignore commodities with 0 availability here
					var unitPrice = Number((system.mainStation.market[commodity].price * 0.1).toFixed(1));
					var unitMinPrice = Number((this._priceForCommodity(system.mainStation.market[commodity], System.infoForSystem(galaxyNumber, system.ID).economy, 0)).toFixed(1));
					var unitMaxPrice = Number((this._priceForCommodity(system.mainStation.market[commodity], System.infoForSystem(galaxyNumber, system.ID).economy, 255)).toFixed(1));
					var remoteMinPrice = Number((this._priceForCommodity(system.mainStation.market[commodity], destinationInfo.economy, 0)).toFixed(1)); // ,0 means return smallest value
					var remotePrice = Number((this._priceForCommodity(system.mainStation.market[commodity], destinationInfo.economy, 255)).toFixed(1)); // ,255 means return largest value
					//				var remotePrice = Number((this._priceForCommodity(system.mainStation.market[commodity],destinationInfo.economy,Math.floor(Math.random()*256))).toFixed(1)); // random prices!

					//		log(this.name,&quot; # &quot;+attempts+&quot;, &quot;+commodities+&quot;, &quot;+preccutoff+&quot;, &quot;+commodity+&quot; val1=&quot;+scratchval+&quot; Price=&quot;+unitPrice+&quot; MinPrice=&quot;+unitMinPrice+&quot; MaxPrice=&quot;+unitMaxPrice+&quot; remMin=&quot;+remoteMinPrice+&quot; remP= &quot;+remotePrice+&quot;, &quot;+system.economy+&quot;, &quot;+destinationInfo.economy);

					// This can happen with narcotics!
					if (remotePrice &lt; remoteMinPrice) {
						var scratchval = remoteMinPrice;
						var remoteMinPrice = remotePrice;
						var remotePrice = scratchval;
					}
					if (unitMaxPrice &lt; unitMinPrice) {
						var scratchval = unitMaxPrice;
						var unitMaxPrice = unitMinPrice;
						var unitMinPrice = scratchval;
					}
					if (unitPrice &lt; unitMinPrice) unitMinPrice = unitPrice;
					if (unitPrice &gt; unitMaxPrice) unitMaxPrice = unitPrice;
				}
			}
		} while ((remotePrice - unitMinPrice) &lt; Math.max(1, player.contractReputationPrecise * 0.5 - system.mainStation.market[commodity].quantityUnit * 3) &amp;&amp; attempts &lt; 10); // Allows Gold more often!
		if (attempts &gt; 9) continue; // failed to find a good commodity.

		var cargo = new Object;
		cargo.commodity = commodity;

		var amount = 0;
		var unitsize = 1;
		// larger unit sizes for kg/g commodities
		if (system.mainStation.market[commodity].quantityUnit === 1) {
			unitsize += Math.ceil((Math.random() + Math.random() + Math.random()) * routeToDestination.route.length); // Adds more if routeToDestination.route.length &gt; 5
		} else if (system.mainStation.market[commodity].quantityUnit === 2) {
			unitsize += Math.ceil((Math.random() + Math.random() + Math.random()) * routeToDestination.route.length * 2);
		}
		amount += Math.max(Math.ceil((1 + Math.random() * 32) * (1 + Math.random() * 16)), Math.floor(30 + Math.random() * 6)) * unitsize; // forced minimum amount to always be at least 30-35. Eliminates while-looping here!

		if (amount &gt; 125 &amp;&amp; amount &gt; player.ship.cargoSpaceCapacity &amp;&amp; player.contractReputationPrecise &gt;= 0 &amp;&amp; system.mainStation.market[commodity].quantityUnit === 0) { // reduce the number of contracts only suitable for Anacondas
			amount = Math.floor(amount / Math.floor(1 + (Math.random() * 4)));
		}

		cargo.size = amount;

		var localValue = Math.floor(unitPrice * amount); // Total cost at Current/Original Price
		var remoteValue = Math.floor(remotePrice * amount); // Remote max value
		var profitMax = remoteValue - Math.floor(unitMinPrice * amount);

		// discount adjustment to prices. Higher reputation and bulk quantities should make this more profitable
		var discount = Number((Math.ceil(Math.max(50, Math.min(100, 20 + player.contractReputationPrecise * 10 + routeToDestination.route.length * 10 + amount * 0.1 + 50000 / profitMax - player.bounty * 0.1 - destinationInfo.government - system.government))) * 0.01).toFixed(2));
		var profit = Math.ceil(profitMax * discount); // Uses discount directly on max profit to determine profit.
		//		if (profit &lt; 100 + player.contractReputationPrecise*100 || profit &gt; profitMax) profit = profitMax;	// Ensures higher profits if payout would otherwise be too low.

		// Formulas to generate ORIGINAL PROFIT AMOUNTS!
		/*
				var discount = Math.min(10+Math.floor(amount/10),35);
				var unitPrice = system.mainStation.market[commodity].price * (100-discount) / 1000;
				var localValue = Math.floor(unitPrice * amount);
				remotePrice = remotePrice * (200+discount) / 200;
				var remoteValue = Math.floor(remotePrice * amount);
				var profit = remoteValue-localValue;
		*/
		var scratchval = this._priceForCommodity(system.mainStation.market[commodity], destinationInfo.economy, Math.floor(Math.random() * 256)); // random prices!
		//		var scratchval = remotePrice; // max selling price!
		var discount2 = Number(Math.min(0.1 + Math.floor(amount * 0.1) * 0.01, 0.35).toFixed(2));
		var profitORG = Math.floor(scratchval * (1 + 0.5 * discount2) * amount) - Math.floor(unitPrice * (1 - discount2) * amount); // Original results for profit!
		var profitORGmax = Math.floor(remotePrice * (1 + 0.5 * discount2) * amount) - Math.floor(unitMinPrice * (1 - discount2) * amount); // Theoretical MAX Original results for profit!

		// higher share for transporter for longer routes, less safe systems, and Higher reputation. lower share for high bounty! 100 bounty = 10% share loss!
		var share = 100 + destinationInfo.government - (10 * routeToDestination.route.length);
		if (share &lt; 10) share = 10;
		if (share &gt; 100) share = 100;
		share = 100 - share;
		var profitORGmax = Math.floor(profitORGmax * share * 0.01);

		// safety: now multiply the fee by 2 compared with 1.76 contracts
		// prevents exploit discovered by Mad Hollander at
		// http://aegidian.org/bb/viewtopic.php?p=188127
		//	localValue *= 2;	// This amount is so high in the event of a failed contract that it&#39;s practically PUNATIVE PUNISHMENT for those doing contracts.
		// this may need to be raised further

		// fee is total selling price.
		// This IF-ELSE makes the cargo deposit equal or greater than the current selling value for the commodity.
		if (localValue &gt; remoteValue - profit) {
			var fee = Math.ceil((localValue + profit) * 0.1) * 10; // round to nearest 10 credits
		} else {
			var fee = Math.ceil(remoteValue * 0.1) * 10; // round to nearest 10 credits
		}
		cargo.payment = fee;
		cargo.deposit = Math.ceil((fee - profit) * 0.1) * 10; // round to nearest 10 credits

		// logs nearly everything
		log(this.name,
			&quot;Rep=&quot; + player.contractReputationPrecise +
			&quot;, &quot; + commodity +
			&quot; size=&quot; + cargo.size +
			&quot; econ=&quot; + system.economy +
			&quot; DestEcon=&quot; + destinationInfo.economy +
			&quot; jumps=&quot; + routeToDestination.route.length +
			&quot; unitPrice=&quot; + unitPrice +
			&quot; MinP=&quot; + unitMinPrice +
			&quot; MaxP=&quot; + unitMaxPrice +
			&quot; remMinP=&quot; + remoteMinPrice +
			&quot; remP=&quot; + remotePrice +
			&quot; locVal=&quot; + localValue +
			&quot; deposit=&quot; + cargo.deposit +
			&quot; profit=&quot; + profit +
			&quot; pMax=&quot; + profitMax +
			&quot; *&quot; + discount +
			&quot; pORG=&quot; + profitORG +
			&quot; pORGmax=&quot; + profitORGmax +
			&quot; share=&quot; + share +
			&quot; discount=&quot; + discount2 +
			&quot; DestVal=&quot; + remoteValue +
			&quot; Total=&quot; + fee
		);

		cargo.destination = destination;
		// we&#39;ll need this again later, and route calculation is slow
		cargo.route = routeToDestination;

		// time allowed for delivery is time taken by &quot;fewest jumps&quot;
		// route, plus timer above. Higher reputation makes longer
		// times available.
		cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture * 86400) + (cargo.route.time * 3600);

		// add parcel to contract list
		if (cargo.deposit &lt; cargo.payment) this._addCargoContractToSystem(cargo);
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_phasescanner.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_PhaseScanner&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the new phase scanning equipment activation.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this._scanCount = 0; // percentage of scan completed
this._speedCount = 0; // counter for when player ship speed drops below 100 m/s.
this._scanTimer = null; // timer to perform scan
this._energy = null; // timer to deduct energy
this._energyReduction = 4; // amount of energy to deduct each quarter second

//-------------------------------------------------------------------------------------------------------------
this.activated = function () {

	var core = worldScripts.Smugglers_CoreFunctions;
	this.$rand = core.$rand;

	var se = worldScripts.Smugglers_Equipment;

	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) {
		this._scanTimer.stop();
		this._energy.stop();
		player.consoleMessage(&quot;Scanning stopped.&quot;);
		se.$playSound(&quot;stop&quot;);
		return;
	}

	var p = player.ship;

	// is the equipment OK?
	if (p.equipmentStatus(&quot;EQ_PHASE_SCANNER&quot;) != &quot;EQUIPMENT_OK&quot;) {
		se.$playSound(&quot;stop&quot;);
		return;
	}

	// do we have a station target and is it a main station?
	if (p.target != system.mainStation) {
		player.consoleMessage(&quot;Scanner will only work when targeting main stations.&quot;);
		se.$playSound(&quot;stop&quot;);
		return;
	}
	if (p.isCloaked) {
		player.consoleMessage(&quot;Scanner will not work when cloaked.&quot;);
		se.$playSound(&quot;stop&quot;);
		return;
	}

	player.consoleMessage(&quot;Scanning started.&quot;);

	this._scanCount = 0;
	this._speedCount = 0;
	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) this._scanTimer.stop();
	this._scanTimer = new Timer(this, this.$scanProcess, 3, 3);
	if (this._energy &amp;&amp; this._energy.isRunning) this._energy.stop();
	this._energy = new Timer(this, this.$depleteEnergy, 0.25, 0.25);

	se.$playSound(&quot;activate&quot;);

}

//-------------------------------------------------------------------------------------------------------------
// find all police or main stations within 15500km of of ship
this.$findLawVessels = function $findLawVessels(npc) {
	function _ships(entity) {
		return entity.isShip &amp;&amp; entity.isPolice &amp;&amp; !entity.isPlayer &amp;&amp; !entity.isStation &amp;&amp; !entity.isMainStation;
	}
	return system.filteredEntities(this, _ships, npc, npc.scannerRange * 0.6);
}

//-------------------------------------------------------------------------------------------------------------
this.$scanProcess = function $scanProcess() {

	var p = player.ship;

	// do we have a station target and is it a main station?
	if (p.target != system.mainStation) {
		player.consoleMessage(&quot;Scanner will only work when targeting main stations.&quot;);
		this._scanTimer.stop();
		this._energy.stop();
		return;
	}

	if (p.isCloaked) {
		player.consoleMessage(&quot;Scanner will not work when cloaked.&quot;);
		this._scanTimer.stop();
		this._energy.stop();
		return;
	}

	var se = worldScripts.Smugglers_Equipment;

	// how far away are we?
	var penalty = 0;
	var msg = &quot;&quot;;
	var dist = p.position.distanceTo(p.target);
	if (dist &lt; (p.scannerRange * 0.78625) &amp;&amp; se._phaseScannerDetected === false) {
		// too close
		msg = expandDescription(&quot;[illegal-scan-detected-station]&quot;);
		p.target.commsMessage(msg, p);
		penalty = this.$rand(20) + 10;
		p.setBounty(player.bounty + penalty, &quot;seen by police&quot;);
		this.$sendEmail(penalty);
		se._phaseScannerDetected = true;
	}
	// is there any police vessel in range?
	var police = this.$findLawVessels(p);
	if (police.length &gt; 0 &amp;&amp; se._phaseScannerDetected === false) {
		msg = expandDescription(&quot;[illegal-scan-detected-police]&quot;);
		penalty = this.$rand(20) + 10;
		p.setBounty(player.bounty + penalty, &quot;seen by police&quot;);
		this.$sendEmail(penalty);
		police[0].commsMessage(msg, p);
		se._phaseScannerDetected = true;
	}
	// are we too far away for a good scan?
	if (dist &gt; (p.scannerRange * 0.90242)) {
		return;
	}

	if (p.speed &lt; 100 &amp;&amp; this._speedCount &gt; 20) {
		// too slow for too long
		msg = expandDescription(&quot;[illegal-scan-detected-station]&quot;);
		p.target.commsMessage(msg, p);
		penalty = this.$rand(20) + 10;
		p.setBounty(player.bounty + penalty, &quot;seen by police&quot;);
		this.$sendEmail(penalty);
		se._phaseScannerDetected = true;
	}

	// ok, we&#39;re close enough, so increase the percentage
	this._scanCount += 1;
	player.consoleMessage(&quot;Scanning &quot; + (this._scanCount * 10) + &quot;% complete&quot;, 3);
	if (this._scanCount &gt;= 10) {
		var phase = se.$getSystemPhase(system.ID);
		player.consoleMessage(&quot;Scan complete. Best phase for station is &quot; + phase + &quot; mHz&quot;, 6);
		// add it to our discovered list
		se.$addPhaseScan(phase, system.ID, 1);
		// stop the timer and reset the count
		this._scanTimer.stop();
		this._energy.stop();
		this._scanCount = 0;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$depleteEnergy = function $depleteEnergy() {
	var p = player.ship;
	p.energy -= this._energyReduction;
	if (p.energy &lt; 64) {
		this._scanTimer.stop();
		this._energy.stop();
		player.consoleMessage(&quot;Insufficient energy to continue scanning.&quot;);
	}
	if (p.speed &lt; 100) {
		this._speedCount += 1;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$sendEmail = function $sendEmail(penalty) {
	var email = worldScripts.EmailSystem;
	if (email) {
		var ga = worldScripts.GalCopAdminServices;
		if (ga._galCopBountyOfficer === &quot;&quot;) ga._galCopBountyOfficer = expandDescription(&quot;%N [nom]&quot;);

		email.$createEmail({
			sender: expandDescription(&quot;[galcop-bounty-sender]&quot;),
			subject: &quot;Bounty applied&quot;,
			date: clock.seconds,
			message: expandMissionText(&quot;galcop-bounty-applied&quot;, {
				amount: penalty,
				systemname: system.info.name,
				sender: ga._galCopBountyOfficer
			}),
			expiryDays: ga._defaultExpiryDays
		});
	}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/smugglers_tradeembargo.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Smugglers_TradeEmbargo&quot;;
this.author = &quot;phkb&quot;;
this.description = &quot;Looks after the process of applying trade embargoes to systems.&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

/* TODO:
- work out how to actually implement a trade embargo
	- idea: work out how to remove a planet from the galactic map
	- then get special device that will override embargo witchspace blockage 
	- witchpoint will be filled with police, arriving will instantly give player a bounty
- Create routine to add trade embargos
- Create more reasons to the list.
*/

this._embargoReasons = [{
		govTypes: &quot;0&quot;,
		name: &quot;&quot;,
		period: 60,
		description: &quot;GalCop is trying to get the system to crack down on pirates, but they have been unwilling. A trade embargo has been put in place to try to make them reconsider.&quot;
	},
	{
		govTypes: &quot;7&quot;,
		name: &quot;&quot;,
		period: 60,
		description: &quot;The system has been attempting to subvert GalCop policies by working outside and around GalCop law. GalCop has imposed a trade embargo to bring them back into line.&quot;
	}
];

this._core = null; // link to core functions script

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	this._core = worldScripts.Smugglers_CoreFunctions;
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
