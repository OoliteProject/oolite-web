<html>
    <head>
        <title>Expansion Your Ad Here Gem Casino</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Your Ad Here Gem Casino</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">78 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">4 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Unknown key &#39;requires_oxp&#39; at https://wiki.alioth.net/img_auth.php/5/5c/Yah_gem_casino_1.0.1.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Adds casino games using gems as credits to the constores.</td>
                    <td>Adds casino games using gems as credits to the constores.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.spara.yah_gem_casino</td>
                    <td>oolite.oxp.spara.yah_gem_casino</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Your Ad Here Gem Casino</td>
                    <td>Your Ad Here Gem Casino</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Activities</td>
                    <td>Activities</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>spara, CaptSolo</td>
                    <td>spara, CaptSolo</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.0.1</td>
                    <td>1.0.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Your_Ad_Here!">http://wiki.alioth.net/index.php/Your_Ad_Here!</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/5/5c/Yah_gem_casino_1.0.1.oxz">https://wiki.alioth.net/img_auth.php/5/5c/Yah_gem_casino_1.0.1.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>Creative Commons Attribution - Non-Commercial - Share Alike 4.0 license</td>
                    <td>Creative Commons Attribution - Non-Commercial - Share Alike 4.0 license</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873306</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Your%20Ad%20Here%20Gem%20Casino'>http://wiki.alioth.net/index.php/Your%20Ad%20Here%20Gem%20Casino</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_back.html">yah_gem_blackjack_card_back</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos1.html">Video Poker Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos10.html">yah_gem_blackjack_card_pos10</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos11.html">yah_gem_blackjack_card_pos11</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos12.html">yah_gem_blackjack_card_pos12</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos13.html">yah_gem_blackjack_card_pos13</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos14.html">yah_gem_blackjack_card_pos14</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos15.html">yah_gem_blackjack_card_pos15</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos16.html">yah_gem_blackjack_card_pos16</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos17.html">yah_gem_blackjack_card_pos17</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos18.html">yah_gem_blackjack_card_pos18</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos19.html">yah_gem_blackjack_card_pos19</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos2.html">yah_gem_blackjack_card_pos2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos20.html">yah_gem_blackjack_card_pos20</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos21.html">yah_gem_blackjack_card_pos21</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos22.html">yah_gem_blackjack_card_pos22</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos23.html">yah_gem_blackjack_card_pos23</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos24.html">yah_gem_blackjack_card_pos24</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos25.html">yah_gem_blackjack_card_pos25</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos26.html">yah_gem_blackjack_card_pos26</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos27.html">yah_gem_blackjack_card_pos27</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos28.html">yah_gem_blackjack_card_pos28</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos29.html">yah_gem_blackjack_card_pos29</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos3.html">yah_gem_blackjack_card_pos3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos30.html">yah_gem_blackjack_card_pos30</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos31.html">yah_gem_blackjack_card_pos31</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos32.html">yah_gem_blackjack_card_pos32</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos33.html">yah_gem_blackjack_card_pos33</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos34.html">yah_gem_blackjack_card_pos34</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos35.html">yah_gem_blackjack_card_pos35</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos36.html">yah_gem_blackjack_card_pos36</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos37.html">yah_gem_blackjack_card_pos37</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos38.html">yah_gem_blackjack_card_pos38</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos39.html">yah_gem_blackjack_card_pos39</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos4.html">yah_gem_blackjack_card_pos4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos40.html">yah_gem_blackjack_card_pos40</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos41.html">yah_gem_blackjack_card_pos41</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos42.html">yah_gem_blackjack_card_pos42</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos43.html">yah_gem_blackjack_card_pos43</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos44.html">yah_gem_blackjack_card_pos44</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos45.html">yah_gem_blackjack_card_pos45</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos46.html">yah_gem_blackjack_card_pos46</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos47.html">yah_gem_blackjack_card_pos47</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos48.html">yah_gem_blackjack_card_pos48</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos49.html">yah_gem_blackjack_card_pos49</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos5.html">yah_gem_blackjack_card_pos5</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos50.html">yah_gem_blackjack_card_pos50</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos51.html">yah_gem_blackjack_card_pos51</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos52.html">yah_gem_blackjack_card_pos52</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos53.html">yah_gem_blackjack_card_pos53</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos54.html">yah_gem_blackjack_card_pos54</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos55.html">yah_gem_blackjack_card_pos55</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos6.html">yah_gem_blackjack_card_pos6</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos7.html">yah_gem_blackjack_card_pos7</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos8.html">yah_gem_blackjack_card_pos8</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_blackjack_card_pos9.html">yah_gem_blackjack_card_pos9</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_blackjack_card.html">Video Blackjack Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_blackjack_intro.html">yah_gem_casino_blackjack_intro</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_holdem_card.html">Video Poker Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_holdem_intro.html">yah_gem_casino_holdem_intro</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_poker_card.html">Video Poker Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_casino_poker_card_spin.html">yah_gem_casino_poker_card_spin</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_back.html">yah_gem_holdem_card_back</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos1.html">Video Hold&#39;em Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos2.html">yah_gem_holdem_card_pos2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos3.html">yah_gem_holdem_card_pos3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos4.html">yah_gem_holdem_card_pos4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos5.html">yah_gem_holdem_card_pos5</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos6.html">yah_gem_holdem_card_pos6</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos7.html">yah_gem_holdem_card_pos7</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos8.html">yah_gem_holdem_card_pos8</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_holdem_card_pos9.html">yah_gem_holdem_card_pos9</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_back.html">yah_gem_poker_card_back</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_pos1.html">Video Poker Card</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_pos2.html">yah_gem_poker_card_pos2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_pos3.html">yah_gem_poker_card_pos3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_pos4.html">yah_gem_poker_card_pos4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/yah_gem_poker_card_pos5.html">yah_gem_poker_card_pos5</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/yah_gem_blackjack.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name = &quot;yah_gem_blackjack&quot;;
this.author = &quot;spara&quot;;

//add interface, if the player has started the game anywhere elsewhere than constore
this.startUpComplete = function() {
	if (!player.ship.dockedStation.hasRole(&quot;constore&quot;)) {
		this.shipExitedWitchspace();
	}
}

this.shipExitedWitchspace = function() {
	var constores = system.shipsWithRole(&quot;constore&quot;);
	if (constores.length &gt; 0) {
		for (var i = 0; i &lt; constores.length; i++) {
			constores[i].setInterface(&quot;yah_gem-blackjack&quot;,{
				title: &quot;Video blackjack&quot;,
				category: expandMissionText(&quot;yah_gem-gambling-category&quot;),
				summary: expandMissionText(&quot;yah_gem-blackjack-summary&quot;),
				callback: this.$intro.bind(this)
			});
		}
	}
}

//init a new deck
this.$virginDeck = function() {
	var deck = new Array();
	var suits = [&quot;triangle&quot;, &quot;crescent&quot;, &quot;square&quot;, &quot;star&quot;];
	for (var i = 0; i &lt; 4; i++) {
		for (var j = 1; j &lt; 14; j++) {
			var card = new Object();
			card.suit = suits[i];
			card.rank = j;
			card.double = 0; 
			card.hide = 0;
			if (j &gt; 10) card.value = 10;
			else if (j === 1) card.value = 11;
			else card.value = card.rank;
			deck.push(card);
		}
	}
	return deck;
}

//calculate the value of a hand
this.$calculateHandValue = function(cards) {
	var finished = false;
	while (!finished) {
		var sum = 0;
		for (var i = 0; i &lt; cards.length; i++) {
			sum += cards[i].value;
		}
		if (sum &gt; 21) {
			//change aces&#39; value from 11 to 1
			for (var i = 0; i &lt; cards.length; i++) {
				if (cards[i].value === 11) {
					cards[i].value = 1;
					break;
				}
			}
			//all aces have been changed, sum stands.
			if (i === cards.length)
				finished = true;
		}
		else finished = true;
	}
	return sum;
}

//intro screen
this.$intro = function() {

	var credits = &quot;\n\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;

	//gambling choices
	var options = {
		&quot;1_EXIT&quot; : &quot;Exit&quot;
	};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 2)
		options[&quot;2_10&quot;] = &quot;Bet 1&quot;;
	else credits += expandMissionText(&quot;yah_gem-no-credit&quot;);
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 4)
		options[&quot;3_50&quot;] = &quot;Bet 5&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 8)
		options[&quot;4_100&quot;] = &quot;Bet 10&quot;;	
	
	mission.runScreen({
		titleKey: &quot;yah_gem-blackjack-title&quot;,
		message: expandMissionText(&quot;yah_gem-blackjack-intro-story&quot;) + credits,
		model: &quot;yah_gem_casino_blackjack_card_intro&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		choices: options,
		allowInterrupt: true,
		screenID: &quot;yah_gem_blackjack&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function (choice) {
		if (choice === &quot;2_10&quot;) this.$playGame(2);
		else if (choice === &quot;3_50&quot;) this.$playGame(4);
		else if (choice === &quot;4_100&quot;) this.$playGame(8);
	});
}

//first pay, then deal
this.$playGame = function(bet) {
	
	//pay up first
	player.ship.manifest[&quot;gem_stones&quot;] -= bet;
	this.$bet = bet;//initial bet
	this.$totalBet = bet;//sum of all bets in round
	
	//init a new deck
	this.$playDeck = this.$virginDeck();
	
	//dealer initial hand
	var dealerHand = new Object();
	dealerHand.cards = [this.$drawCard(), this.$drawCard()];
	dealerHand.cards[1].hide = 1;
	this.$dealerHands = [dealerHand];
	
	//player initial hand
	var playerHand = new Object();
	playerHand.cards = [this.$drawCard(), this.$drawCard()];
	playerHand.bet = bet;
	this.$playerHands = [playerHand];

	//lets play some blackjack
	this.$deal(0);
}

this.$updateHandProps = function(hand, hands) {
	hand.value = this.$calculateHandValue(hand.cards);
	if (hand.value === 21) {
		if (hands.length === 1 &amp;&amp; hand.cards.length === 2) {
			hand.status = &quot;blackjack&quot;;
		}
		else hand.status = &quot;21&quot;;
	}
	else if (hand.value &gt; 21) hand.status = &quot;busted&quot;;
	else if (hand.status !== &quot;stand&quot;) hand.status = &quot;hit&quot;;
}

//Deal
this.$deal = function() {
	
	//rotate till playable hand
	for (var hand = 0; hand &lt; this.$playerHands.length; hand++) {
		var playerHand = this.$playerHands[hand];
		this.$updateHandProps(playerHand, this.$playerHands);
		if (playerHand.value &lt; 21 &amp;&amp; playerHand.status !== &quot;stand&quot;)
			break;
	}
	
	//dealer&#39;s turn?
	if (hand === this.$playerHands.length) {
		this.$resolve();
		return;
	}
	
	//choices
	var options = {};
	if (playerHand.status === &quot;hit&quot;) {
		options[&quot;1_HIT&quot;] = &quot;Hit&quot;;
		options[&quot;2_STAND&quot;] = &quot;Stand&quot;;
	}
	if (playerHand.cards.length === 2 &amp;&amp; playerHand.status === &quot;hit&quot; &amp;&amp; player.ship.manifest[&quot;gem_stones&quot;] &gt;= this.$bet) {
		options[&quot;3_DOUBLE&quot;] = &quot;Double Down (&quot; + this.$bet + &quot; g)&quot;;
	}
	if (playerHand.cards.length === 2 &amp;&amp; (playerHand.cards[0].value === playerHand.cards[1].value || playerHand.cards[0].rank === playerHand.cards[1].rank) &amp;&amp; this.$playerHands.length &lt; 4) {
		options[&quot;4_SPLIT&quot;] = &quot;Split (&quot; + this.$bet + &quot; g)&quot;;
	}
	if (playerHand.cards.length === 2 &amp;&amp; this.$playerHands.length === 1) {
		options[&quot;5_SURRENDER&quot;] = &quot;Surrender&quot;;
	}

	//status message
	var message = &quot;Player hand: &quot; + playerHand.value + &quot;\n\n&quot;;
	message += &quot;Total bet: &quot; + this.$totalBet;
	message += &quot;\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;

	mission.runScreen({
		titleKey: &quot;yah_gem-blackjack-title&quot;,
		model: &quot;yah_gem_casino_blackjack_card_base&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		message: message,
		spinModel: false,
		screenID: &quot;yah_gem_blackjack&quot;,
		choices: options
	},
	function (choice) {
		if (choice === &quot;1_HIT&quot;) {
			playerHand.cards.push(this.$drawCard());
			this.$deal();
			return;
		}
		else if (choice === &quot;2_STAND&quot;) {
			playerHand.status = &quot;stand&quot;;
			this.$deal();
			return;
		}
		else if (choice === &quot;3_DOUBLE&quot;) {
			playerHand.cards.push(this.$drawCard());
			this.$updateHandProps(playerHand, this.$playerHands);
			if (playerHand.value &lt; 21) playerHand.status = &quot;stand&quot;;
			player.ship.manifest[&quot;gem_stones&quot;] -= this.$bet;
			this.$totalBet += this.$bet;
			playerHand.bet = 2 * playerHand.bet;
			this.$deal();
			return;
		}
		else if (choice === &quot;4_SPLIT&quot;) {
			
			//limit to one card after splitting aces!!!!!!!
			if (playerHand.cards[0].rank === 1) {
				playerHand.cards[0].value = 11;
				playerHand.cards[1].value = 11;
			}
			player.ship.manifest[&quot;gem_stones&quot;] -= this.$bet;
			this.$totalBet += this.$bet;
			var newHand = new Object();
			newHand.cards = [playerHand.cards.pop(), this.$drawCard()];
			newHand.bet = this.$bet;
			this.$playerHands.push(newHand);
			playerHand.cards.push(this.$drawCard());
			this.$deal();
			return;
		}
		else if (choice === &quot;5_SURRENDER&quot;) {
			playerHand.status = &quot;surrender&quot;;
			this.$resolve();
			return;
		}
		else {
			this.$intro();
			return;
		}
	}
	);
	
	this.$updateScreen();
	
	//update flasher markers
	//while playing: yellow - current hand, red - busted hand
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		var status = this.$playerHands[i].status;
		if (i === hand)
			mission.displayModel.flashers[i].color = &quot;yellowColor&quot;;
		else if (status === &quot;busted&quot;)
			mission.displayModel.flashers[i].color = &quot;redColor&quot;;
		else {
			mission.displayModel.flashers[i].position = [0, 0, 50];
		}
	}
	for (var j = i; j &lt; 4; j++)
		mission.displayModel.flashers[j].position = [0, 0, 50];
}

this.$resolve = function() {

	var dealerHand = this.$dealerHands[0];
	this.$updateHandProps(dealerHand, this.$dealerHands);
	dealerHand.cards[1].hide = false;

	//check player for non-busted hands
	var busted = true;
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		if (this.$playerHands[i].status !== &quot;busted&quot;) {
			busted = false;
			break;
		}
	}

	//if all player cards are busted, dealer automatically wins
	if (busted || this.$playerHands[i].status === &quot;surrender&quot;) {
		for (var i = 0; i &lt; this.$playerHands.length; i++) {
			this.$playerHands[i].result = &quot;loss&quot;;
		}
	}
	else {
		//start drawing cards until we go over 16.
		while (dealerHand.value &lt; 17) {
			dealerHand.cards.push(this.$drawCard());
			this.$updateHandProps(dealerHand, this.$dealerHands);
		}
		//compare player hands to the dealer hand
		for (var i = 0; i &lt; this.$playerHands.length; i++) {
			var playerHand = this.$playerHands[i];
			//if the player has not busted, we&#39;ll compare
			if (playerHand.status !== &quot;busted&quot;) {
				//blackjack
				if (playerHand.status === &quot;blackjack&quot;) {
					if (dealerHand.status === &quot;blackjack&quot;)
						playerHand.result = &quot;push&quot;;
					else playerHand.result = &quot;win&quot;;
				}
				//push
				else if (dealerHand.value === playerHand.value)
					playerHand.result = &quot;push&quot;;
				//win
				else if (dealerHand.value &gt; 21 || (21 - playerHand.value &lt; 21 - dealerHand.value))
					playerHand.result = &quot;win&quot;;
				//loss
				else playerHand.result = &quot;loss&quot;;
			}
			//if the player has busted, it&#39;s a loss
			else playerHand.result = &quot;loss&quot;;
		}
	}

	//calculate the winnings
	var win = 0;
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		var playerHand = this.$playerHands[i];
		if (playerHand.result === &quot;win&quot;) {
			if (playerHand.status === &quot;blackjack&quot;)
				win += 2.5 * playerHand.bet;
			else win += 2 * playerHand.bet;
		}
		else if (playerHand.result === &quot;push&quot;)
			win += playerHand.bet;
		else if (playerHand.status === &quot;surrender&quot; &amp;&amp; dealerHand.status !== &quot;blackjack&quot;)
			win += playerHand.bet / 2;
	}
	player.ship.manifest[&quot;gem_stones&quot;] += win;
	
	//status message
	var resultMessage = &quot;&quot;;
	
	//player
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		var playerHand = this.$playerHands[i]
		resultMessage += &quot;Player hand: &quot;;
		if (playerHand.status === &quot;blackjack&quot;)
			resultMessage += &quot;Blackjack\n&quot;;
		else if (playerHand.status === &quot;busted&quot;)
			resultMessage += &quot;Busted\n&quot;;
		else if (playerHand.result === &quot;push&quot;)
			resultMessage += &quot;Push\n&quot;;
		else if (playerHand.status === &quot;surrender&quot;)
			resultMessage += &quot;Surrender\n&quot;;
		else resultMessage += playerHand.value + &quot;\n&quot;;
	}
	
	//dealer
	if (dealerHand.status === &quot;blackjack&quot;)
		resultMessage += &quot;Dealer hand: Blackjack\n\n&quot;
	else if (dealerHand.status === &quot;busted&quot;)
		resultMessage += &quot;Dealer hand: Busted\n\n&quot;
	else resultMessage += &quot;Dealer hand: &quot; + dealerHand.value + &quot;\n\n&quot;;

	//winnings
	var notifySound = new SoundSource;
	if (win - this.$totalBet &gt; 0) {
		resultMessage += &quot;You win &quot; + (win -  this.$totalBet) + &quot; g\n&quot;;
		notifySound.sound = &quot;yah_gem_win.ogg&quot;;
	}
	else if (win - this.$totalBet &lt; 0) {
		resultMessage += &quot;You lose &quot; + (this.$totalBet - win) + &quot; g\n&quot;;
		notifySound.sound = &quot;yah_gem_lose.ogg&quot;;
	}
	else {
		resultMessage += &quot;You get even\n&quot;;
		notifySound.sound = &quot;yah_gem_win.ogg&quot;;
	}
	notifySound.play();
	
	resultMessage += &quot;\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	
	var options = {
		&quot;2_REBET&quot; : &quot;Change bet&quot;,
		&quot;3_EXIT&quot; : &quot;Exit&quot;
	};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= this.$bet)
		options[&quot;1_AGAIN&quot;] = &quot;Deal again (&quot; + this.$bet + &quot; g)&quot;;

	mission.runScreen({
		titleKey: &quot;yah_gem-blackjack-title&quot;,
		model: &quot;yah_gem_casino_blackjack_card_base&quot;,
		message: resultMessage,
		spinModel: false,
		background: &quot;yah_gem_table_bg.png&quot;,
		choices: options,
		allowInterrupt: true,
		screenID: &quot;yah_gem_blackjack&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function (choice) {
		if (choice === &quot;1_AGAIN&quot;) {
			this.$playGame(this.$bet);
			return;
		}
		else if (choice === &quot;2_REBET&quot;) {
			this.$intro();
			return;
		}
	});
	
	this.$updateScreen(-1);
	
	//red: lose
	//green: win
	//yellow: push
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		var result = this.$playerHands[i].result;
		if (result === &quot;win&quot;)
			mission.displayModel.flashers[i].color = &quot;greenColor&quot;;
		else if (result === &quot;loss&quot;)
			mission.displayModel.flashers[i].color = &quot;redColor&quot;;
		else mission.displayModel.flashers[i].color = &quot;yellowColor&quot;;
	}
	for (var j = i; j &lt; 4; j++)
		mission.displayModel.flashers[j].position = [0, 0, 50];
}

//draws a card from the current deck in play
this.$drawCard = function() {
	return this.$playDeck.splice(Math.floor(this.$playDeck.length * Math.random()),1)[0];
}

//update textures and positions for cards
this.$updateScreen = function() {
	//player cards subents 0-10, 11-21, 22 -32, 33-43
	//dealer cards subents 44-54

	//player cards
	for (var i = 0; i &lt; this.$playerHands.length; i++) {
		//show player hand
		var playerHand = this.$playerHands[i];
		for (var j = 0; j &lt; playerHand.cards.length; j++) {
			var card = playerHand.cards[j];
			var fileName = &quot;yah_gem_card_&quot; + card.suit + &quot;_&quot; + card.rank + &quot;.png&quot;;
			var place = i * 11 + j;
			mission.displayModel.subEntities[place].setMaterials({&quot;casino_poker_card_diffuse.png&quot;: {diffuse_map: fileName, emission_map: fileName, emission_modulate_color: &quot;darkGrayColor&quot;}});
		}
		//double down
		if (playerHand.bet === 2 * this.$bet) {
			mission.displayModel.subEntities[place].orientation = [0.5, 0.5, 0.5, 0.5];
		}
		//hide non used player subents from view
		for (var k = j; k &lt; 11; k++) this.$hideCard(i * 11 + k);
	}
	//hide non used player subents from view
	for (var k = i * 11; k &lt; 44; k++) this.$hideCard(k);
	
	//dealer cards
	var dealerHand = this.$dealerHands[0];
	for (var j = 0; j &lt; dealerHand.cards.length; j++) {
		var card = dealerHand.cards[j];
		if (card.hide) {
			var fileName = &quot;yah_gem_blackjack_card_diffuse.png&quot;;
		}
		else {
			var fileName = &quot;yah_gem_card_&quot; + card.suit + &quot;_&quot; + card.rank + &quot;.png&quot;;
		}
		mission.displayModel.subEntities[4 * 11 + j].setMaterials({&quot;casino_poker_card_diffuse.png&quot;: {diffuse_map: fileName, emission_map: fileName, emission_modulate_color: &quot;darkGrayColor&quot;}});
	}
	//hide non used dealer subents from view
	for (var k = 4 * 11 + j; k &lt; 54; k++) this.$hideCard(k);
}

//moves the cards to the centerline and turns them out of view
this.$hideCard = function(place) {
	var position = mission.displayModel.subEntities[place].position;
	position[2] = 0;
	mission.displayModel.subEntities[place].position = position;
	var orientation = [0, 0, 0, 1];
	mission.displayModel.subEntities[place].orientation = orientation;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/yah_gem_dice.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name = &quot;yah_gem_dice&quot;;
this.author = &quot;spara&quot;;

//game track with bet multipliers
this.$track = [0, 0, 0, 4, 0, 8, 0, 17, 0, 35];

//add interface, if the player has started the game anywhere elsewhere than constore
this.startUpComplete = function() {
	if (!player.ship.dockedStation.hasRole(&quot;constore&quot;)) {
		this.shipExitedWitchspace();
	}
}

this.shipExitedWitchspace = function() {
	var constores = system.shipsWithRole(&quot;constore&quot;);
	if (constores.length &gt; 0) {
		for (var i = 0; i &lt; constores.length; i++) {
			constores[i].setInterface(&quot;yah_gem-dice&quot;,{
				title: &quot;Smuggler&#39;s run&quot;,
				category: expandMissionText(&quot;yah_gem-gambling-category&quot;),
				summary: expandMissionText(&quot;yah_gem-dice-summary&quot;),
				callback: this.$intro.bind(this)
			});
		}
	}
}

//helper function for tabulating text on screen
this.$tabulate = function(line, width) {
	var hairSpace = String.fromCharCode(31);
	var space = defaultFont.measureString(&quot; &quot;);
	while (defaultFont.measureString(line) &lt; width - space)
		line += &quot; &quot;;
	while (defaultFont.measureString(line) &lt; width)
		line += hairSpace;
	return line;
}

//intro screen
this.$intro = function() {
	var bets = [1, 5, 10];
	//build and format the payoff table for screen
	var payoffMessage = &quot;Bet:&quot;;
	for (var i = 0; i &lt; 3; i++) {
		payoffMessage = this.$tabulate(payoffMessage, 5 * (i + 1));
		payoffMessage += bets[i] + &quot; g&quot;;
	}
	var payoffMessage2 = &quot;Score&quot;;
	for (var i = 0; i &lt; 3; i++) {
		payoffMessage2 = this.$tabulate(payoffMessage2, 5 * (i + 1));
		payoffMessage2 += &quot;Win!&quot;;
	}	
	payoffMessage = &quot;\n\n&quot; + payoffMessage + &quot;\n\n&quot; + payoffMessage2 + &quot;\n&quot;;

	for (i = this.$track.length - 1; i &gt; 0; i--) {
		if (this.$track[i] !== 0) {
			var line = this.$tabulate(&quot;&quot;, 0.5) + (i + 1);
			for (var j = 0; j &lt; 3; j++) {
				line = this.$tabulate(line, 5 * (j + 1));
				line += this.$track[i] * bets[j] + &quot; g&quot;;
			}
			payoffMessage += line+&quot;\n&quot;;
		}
	}
	
	//format player credits for screen
	var credits = expandMissionText(&quot;yah_gem-credits&quot;)+player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	
	var options = {
		&quot;1_EXIT&quot; : &quot;Exit&quot;
	};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 1)
		options[&quot;2_10&quot;] = &quot;Bet 1&quot;;
	else credits += expandMissionText(&quot;yah_gem-no-credit&quot;);
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 5)
		options[&quot;3_50&quot;] = &quot;Bet 5&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 10)
		options[&quot;4_100&quot;] = &quot;Bet 10&quot;;
	mission.runScreen({
		titleKey: &quot;yah_gem-dice-title&quot;,
		screenID: &quot;yah_gem_dice&quot;,
		message: expandMissionText(&quot;yah_gem-dice-intro-story&quot;)  + payoffMessage + credits,
		choices: options,
		background: &quot;yah_gem_dice_bg-intro.png&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function (choice) {
		if (choice === &quot;2_10&quot;) this.$playGame(1);
		else if (choice === &quot;3_50&quot;) this.$playGame(5);
		else if (choice === &quot;4_100&quot;) this.$playGame(10);
	}
	);
}

//da game
this.$playGame = function(bet, prevSum, round, track, select) {
	//init the game
	if (typeof round === &#39;undefined&#39;) {
		var round = 0;
		var track = this.$tabulate(&quot; &quot;, 3);
		player.ship.manifest[&quot;gem_stones&quot;] -= bet;
	}
	
	//roll the dice
	var die1 = Math.ceil(6 * Math.random());
	var die2 = Math.ceil(6 * Math.random());
	var sum = die1 + die2;

	//check the guess
	var pass = true;
	if (typeof prevSum !== &#39;undefined&#39;) {
		if (select === &quot;high_same&quot;) {
			if (sum &lt; prevSum) 
				pass = false;
		}
		else if (select === &quot;high&quot;) {
			if (sum &lt;= prevSum) 
				pass = false;
		}
		else if (select === &quot;low_same&quot;) {
			if (sum &gt; prevSum) 
				pass = false;
		}
		else if (select === &quot;low&quot;) {
			if (sum &gt;= prevSum)
				pass = false;
		}
	}

//debug	
//pass = true; 

	//build the track display
	track += sum;
	//don&#39;t add tabs to the final score
	if (round &lt; this.$track.length) {
		track = this.$tabulate(track, 3 + (round + 1) * 2.7);
	}
	var messageTrack = track;
	for (var i = round; i &lt; this.$track.length; i++) {
		if (this.$track[i] !== 0) {
			messageTrack += bet * this.$track[i] + &quot; g&quot;;
		}
		else messageTrack += &quot;?&quot;;
		if (i &lt; this.$track.length - 1) {
			messageTrack = this.$tabulate(messageTrack, 3 + (i + 2) * 2.7);
		}
	}

	var credits = &quot;Gems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	var betText = &quot;Bet: &quot; + bet + &quot;\n&quot;;

	//correct guess
	if (pass) {
		var options = {};
		//cash out
		if (round &gt; 0 &amp;&amp; this.$track[round-1] !== 0) {
			var cash_out = bet * this.$track[round-1] + &quot; g&quot;;
			options[&quot;1_CASH&quot;] = &quot;Cash out &quot; + cash_out;
			var message = expandMissionText(&quot;yah_gem-dice-track-cash&quot;);
			var background = &quot;yah_gem_dice_bg-cash.png&quot;;
		}
		else { 
			var message = expandMissionText(&quot;yah_gem-dice-track-basic&quot;);
			var background = &quot;yah_gem_dice_bg-basic.png&quot;;
		}
		
		var background = &quot;yah_gem_dice_bg-&quot; + round + &quot;.png&quot;
		//guess choices
		if (round !== this.$track.length) {
			if (sum &gt;= 7)
				options[&quot;2_HIGH_SAME&quot;] = &quot;Higher or same&quot;;
			else
				options[&quot;3_HIGH&quot;] = &quot;Higher&quot;;
			if (sum &lt;= 7)
				options[&quot;4_LOW_SAME&quot;] = &quot;Lower or same&quot;;
			else
				options[&quot;5_LOW&quot;] = &quot;Lower&quot;;
		}
		//game finished
		else {
			var message = expandMissionText(&quot;yah_gem-dice-track-final&quot;);
		}
		mission.runScreen({
			titleKey: &quot;yah_gem-dice-title&quot;,
			screenID: &quot;yah_gem_dice&quot;,
			overlay: &quot;yah_gem_dice_&quot;+die1+&quot;-&quot;+die2+&quot;.png&quot;,
			message: &quot;\n&quot; + messageTrack + &quot;\n\n&quot; + message + &quot;\n\n&quot; + credits + &quot;\n&quot; + betText,
			choices: options,
			background: background
		}, 
		function (choice) {
			if (choice === &quot;1_CASH&quot;) {
				var win = this.$track[round-1] * bet;
				player.ship.manifest[&quot;gem_stones&quot;] += win;
				var notifySound = new SoundSource;
				notifySound.sound = &quot;yah_gem_win.ogg&quot;;
				notifySound.play();
				this.$intro();
				return;
			}
			else if (choice === &quot;2_HIGH_SAME&quot;) {
				this.$playGame(bet, sum, round + 1, track, &quot;high_same&quot;);
				return;
			}
			else if (choice === &quot;3_HIGH&quot;) {
				this.$playGame(bet, sum, round + 1, track, &quot;high&quot;);
				return;
			}
			else if (choice === &quot;4_LOW_SAME&quot;) {
				this.$playGame(bet, sum, round + 1, track, &quot;low_same&quot;);
				return;
			}
			else if (choice === &quot;5_LOW&quot;) {
				this.$playGame(bet, sum, round + 1, track, &quot;low&quot;);
				return;
			}
		}
		);
	}
	else {
		var sound = &quot;yah_gem_lose.ogg&quot;;
		var options = {
			&quot;1_EXIT&quot; : &quot;Exit&quot;,
			&quot;2_AGAIN&quot; : &quot;Change bet&quot;
		};
		if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= bet) options[&quot;3_PLAY&quot;] = &quot;Play again&quot;;
		mission.runScreen({
			titleKey: &quot;yah_gem-dice-title&quot;,
			screenID: &quot;yah_gem_dice&quot;,
			overlay: &quot;yah_gem_dice_&quot;+die1+&quot;-&quot;+die2+&quot;.png&quot;,
			message: &quot;\n&quot; + messageTrack + &quot;\n\n&quot; + expandMissionText(&quot;yah_gem-dice-track-fail&quot;) + &quot;\n\n&quot; + credits + &quot;\n&quot; + betText,
			choices: options,
			music: sound,
			background: &quot;yah_gem_dice_bg-fail.png&quot;,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
		},
		function (choice) {
			if (choice === &quot;2_AGAIN&quot;) {
				this.$intro();
				return;
			}
			else if (choice === &quot;3_PLAY&quot;) {
				this.$playGame(bet);
				return;
			}
		}
		);
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/yah_gem_holdem.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name = &quot;yah_gem_holdem&quot;;
this.author = &quot;spara&quot;;

this.$highNames = [&quot;Seven&quot;, &quot;Eight&quot;, &quot;Nine&quot;, &quot;Ten&quot;, &quot;Jack&quot;, &quot;Queen&quot;, &quot;King&quot;, &quot;Ace&quot;];
this.$handRanks = [&quot;High&quot;, &quot;Pair&quot;,&quot;Two Pair&quot;,&quot;Three of a Kind&quot;,&quot;Straight&quot;,&quot;Flush&quot;,&quot;Full House&quot;,&quot;Four of a Kind&quot;,&quot;Straight Flush&quot;,&quot;Royal Flush&quot;];

//add interface, if the player has started the game anywhere elsewhere than constore
this.startUpComplete = function() {
	if (!player.ship.dockedStation.hasRole(&quot;constore&quot;)) {
		this.shipExitedWitchspace();
	}
}

this.shipExitedWitchspace = function() {
	var constores = system.shipsWithRole(&quot;constore&quot;);
	if (constores.length &gt; 0) {
		for (var i = 0; i &lt; constores.length; i++) {
			constores[i].setInterface(&quot;yah_gem-holdem&quot;,{
				title: &quot;hOopy hold&#39;em&quot;,
				category: expandMissionText(&quot;yah_gem-gambling-category&quot;),
				summary: expandMissionText(&quot;yah_gem-holdem-summary&quot;),
				callback: this.$intro.bind(this)
			});
		}
	}
}

//init a new deck
this.$virginDeck = function() {
	var deck = new Array();
	var suits = [&quot;triangle&quot;, &quot;crescent&quot;, &quot;square&quot;, &quot;star&quot;];
	for (var i = 0; i &lt; 4; i++) {
		for (var j = 1; j &lt; 14; j++) {
			var card = new Object();
			card.suit = suits[i];
			card.rank = j;
			card.show = false;
			deck.push(card);
		}
	}
	return deck;
}

//draws a card from the current deck in play
this.$drawCard = function() {
	return this.$playDeck.splice(Math.floor(this.$playDeck.length * Math.random()),1)[0];
}

this.$intro = function() {
	var credits = &quot;\n\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	var options = {};
	options[&quot;1_EXIT&quot;] = &quot;Exit&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 3)
		options[&quot;2_10&quot;] = &quot;Bet 1&quot;;
	else credits += expandMissionText(&quot;yah_gem-no-credit&quot;) + &quot; Minimum of 3 g is needed to play.&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 15)
		options[&quot;3_50&quot;] = &quot;Bet 5&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 30)
		options[&quot;4_100&quot;] = &quot;Bet 10&quot;;
	
	mission.runScreen({
		titleKey: &quot;yah_gem-holdem-title&quot;,
		message: expandMissionText(&quot;yah_gem-holdem-intro-story&quot;) + credits,
		model: &quot;yah_gem_casino_holdem_intro&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		choices: options,
		allowInterrupt: true,
		screenID: &quot;yah_gem_holdem&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function (choice) {
		if (choice === &quot;2_10&quot;) this.$play(1);
		else if (choice === &quot;3_50&quot;) this.$play(5);
		else if (choice === &quot;4_100&quot;) this.$play(10);
	}	
	);
}

//first pay, then deal
this.$play = function(bet) {
	player.ship.manifest[&quot;gem_stones&quot;] -= bet;
	this.$ante = bet;
	this.$bets = 0;
	this.$playDeck = this.$virginDeck();
	this.$cards = new Array();
	for (var i = 0; i &lt; 9; i++) this.$cards.push(this.$drawCard());
	
	//debug hands
	//var deal = [48, 41, 5, 6, 23, 33, 19, 21, 30];
	//for (var i = 0; i &lt; 9; i++) {
	//	this.$cards.push(this.$playDeck[deal[i]]);
	//}
	
	this.$deal(&quot;deal&quot;);
}

this.$deal = function(phase) {
	var message = &quot;Ante: &quot; + this.$ante;
	if (this.$bets &gt; 0) message += &quot;\nBets: &quot; + this.$bets;
	message += &quot;\n\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	var options = {};
	switch(phase) {
		case &quot;deal&quot; :	this.$cards[7].show = true; 
						this.$cards[8].show = true;
						options[&quot;1_FLOP&quot;] = &quot;Play (&quot; + this.$ante * 2 + &quot; g)&quot;;
						options[&quot;2_FOLD&quot;] = &quot;Fold&quot;;
						break;
		case &quot;flop&quot; :	this.$cards[2].show = true; 
						this.$cards[3].show = true;
						this.$cards[4].show = true;
						options[&quot;3_CHECK_TURN&quot;] = &quot;Check&quot;;
						if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= this.$ante)
							options[&quot;4_BET_TURN&quot;] = &quot;Bet (&quot; + this.$ante + &quot; g)&quot;;
						break;
		case &quot;turn&quot; :	this.$cards[5].show = true; 
						options[&quot;5_CHECK_RIVER&quot;] = &quot;Check&quot;;
						if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= this.$ante)
							options[&quot;6_BET_RIVER&quot;] = &quot;Bet (&quot; + this.$ante + &quot; g)&quot;;
						break;
	};
	mission.runScreen({
		titleKey: &quot;yah_gem-holdem-title&quot;,
		model: &quot;yah_gem_casino_holdem_base&quot;,
		message: message,
		background: &quot;yah_gem_table_bg.png&quot;,
		spinModel: false,
		screenID: &quot;yah_gem_holdem&quot;,
		choices: options
	},
	function(choice) {
		switch(choice) {
			case &quot;1_FLOP&quot; : player.ship.manifest[&quot;gem_stones&quot;] -= 2 * this.$ante;
							this.$bets += 2 * this.$ante;
							this.$deal(&quot;flop&quot;);
							return;
			case &quot;2_FOLD&quot; : this.$showDown(true);
							return;
			case &quot;3_CHECK_TURN&quot; : 	this.$deal(&quot;turn&quot;);
									return;
			case &quot;4_BET_TURN&quot; : player.ship.manifest[&quot;gem_stones&quot;] -= this.$ante;
								this.$bets += this.$ante;
								this.$deal(&quot;turn&quot;);
								return;
			case &quot;5_CHECK_RIVER&quot; : 	this.$showDown(false);
									return;
			case &quot;6_BET_RIVER&quot; : 	player.ship.manifest[&quot;gem_stones&quot;] -= this.$ante;
									this.$bets += this.$ante;
									this.$showDown(false);
									return;
		}
	});
	this.$updateCards();
}

this.$handName = function(value, high) {
	if (value &gt; 0)
		return this.$handRanks[value];
	else
		return this.$highNames[high - 7] + &quot; &quot; + this.$handRanks[0];
}

this.$formatHand = function(hand) {
	var formatted = &quot;(&quot;;
	for (var i = 0; i &lt; 5; i++) {
		var value = hand[0][i].value;
		if (value === 11) value = &quot;J&quot;;
		else if (value === 12) value = &quot;Q&quot;;
		else if (value === 13) value = &quot;K&quot;;
		else if (value === 14 || value === 1) value = &quot;A&quot;;
		formatted += value;
		if (i &lt; 4) formatted += &quot;, &quot;;
		else formatted += &quot;)&quot;;
	}
	return formatted;
}

this.$showDown = function(fold) {
	for (var i = 0; i &lt; 9; i++) this.$cards[i].show = true;
	var playerHand = this.$bestHand(2);
	var dealerHand = this.$bestHand(0);
	var playerValues = &quot;\n&quot; + this.$formatHand(playerHand) + &quot;\n\n&quot;;
	var dealerValues = &quot;\n&quot; + this.$formatHand(dealerHand) + &quot;\n\n&quot;;
	var message = &quot;Player: &quot; + this.$handName(playerHand[1], playerHand[0][0].value) + playerValues;
	message += &quot;Dealer: &quot; + this.$handName(dealerHand[1], dealerHand[0][0].value) + dealerValues;
	
	if (fold) var result = &quot;fold&quot;;
	else {
		var result = &quot;push&quot;;
		if (dealerHand[1] &gt; playerHand[1])
			result = &quot;loss&quot;;
		else if (dealerHand[1] &lt; playerHand[1]) {
			result = &quot;win&quot;;
		}
		else {
			for (var i = 0; i &lt; 5; i++) {
				if (playerHand[0][i].value &gt; dealerHand[0][i].value) {
					result = &quot;win&quot;;
					break;
				}
				else if (playerHand[0][i].value &lt; dealerHand[0][i].value) {
					result = &quot;loss&quot;;
					break;
				}
			}
		}
	}
	var notifySound = new SoundSource;
	switch (result) {
		case &quot;win&quot; : 	if (playerHand[1] &gt; 3) {
							var win = 2 * (this.$bets + this.$ante);
						}
						else var win = this.$ante + 2 * (this.$bets);
						message += &quot;You win &quot; + (win - this.$bets - this.$ante) + &quot; g&quot;;
						player.ship.manifest[&quot;gem_stones&quot;] += win;
						notifySound.sound = &quot;yah_gem_win.ogg&quot;;
						break;
		case &quot;loss&quot; : 	message += &quot;Dealer wins, you lose &quot; + this.$bets + &quot; g&quot;;
						notifySound.sound = &quot;yah_gem_lose.ogg&quot;;
						break;
		case &quot;push&quot; : 	message += &quot;It&#39;s a push, wagers returned.&quot;;
						notifySound.sound = &quot;yah_gem_win.ogg&quot;;
						player.ship.manifest[&quot;gem_stones&quot;] += this.$bets + this.$ante;
						break;
		case &quot;fold&quot; :	message += &quot;You fold and lose &quot; + this.$ante + &quot; g&quot;;
						notifySound.sound = &quot;yah_gem_lose.ogg&quot;;
						break;
	}
	notifySound.play();
	message += &quot;\n\nGems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g&quot;;
	var options = {};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 3 * this.$ante)
		options[&quot;7_DEAL&quot;] = &quot;Deal again (&quot; + this.$ante + &quot; g)&quot;;
	options[&quot;8_BET&quot;] = &quot;Change ante&quot;;
	options[&quot;9_EXIT&quot;] = &quot;Exit&quot;;
	mission.runScreen({
		titleKey: &quot;yah_gem-holdem-title&quot;,
		model: &quot;yah_gem_casino_holdem_base&quot;,
		message: message,
		background: &quot;yah_gem_table_bg.png&quot;,
		spinModel: false,
		choices: options,
		allowInterrupt: true,
		screenID: &quot;yah_gem_holdem&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function(choice) {
		switch(choice) {
			case &quot;7_DEAL&quot; : this.$play(this.$ante);
							return;
			case &quot;8_BET&quot; : this.$intro(1);
							return;
		};
	});
	this.$updateCards();
}

this.$updateCards = function() {
	for (var i = 0; i &lt; 9; i++) {
		var card = this.$cards[i];
		if (card.show) {
			var fileName = &quot;yah_gem_card_&quot; + card.suit + &quot;_&quot; + card.rank + &quot;.png&quot;;
		}
		else var fileName = &quot;yah_gem_holdem_card_diffuse.png&quot;;
		mission.displayModel.subEntities[i].setMaterials({&quot;casino_poker_card_diffuse.png&quot;: {diffuse_map: fileName, emission_map: fileName, emission_modulate_color: &quot;darkGrayColor&quot;}});
	}
}

this.$bestHand = function(start) {
	
	//make a new hand with new objects
	var hand = new Array();
	for (var i = start; i &lt; start + 7; i++) {
		var suits = [&quot;triangle&quot;, &quot;crescent&quot;, &quot;square&quot;, &quot;star&quot;];
		var card = new Object();
		card.value = this.$cards[i].rank;
		card.suit = suits.indexOf(this.$cards[i].suit);
		if (card.value === 1) card.value = 14;
		hand.push(card);
	}
	
	//order cards by suit
	hand.sort(function(a, b) {return a.suit - b.suit});

	//handle flushes first	
	if (hand[0].suit === hand[4].suit || hand[1].suit === hand[5].suit || hand[2].suit === hand[6].suit) {
		//suit of flush
		var suit = hand[2].suit;
		//remove wrong suit cards
		for (var i = 0; i &lt; 7; i++) {
			if (hand[6 - i].suit !== suit)
				hand.splice(6 - i, 1);
		}
		//order cards by value
		hand.sort(function(a, b) {return b.value - a.value})
		//handle possible ace by duplicating to a different value
		if (hand[0].value === 14) {
			card = new Object();
			card.value = 1;
			card.suit = suit;
			hand.push(card);
		}
		//look for a straight
		var straight = -1;
		var length = 0;
		for (var i = 0; i &lt; hand.length - 1; i++) {
			//tracking a straight
			if (hand[i].value - hand[i + 1].value === 1) length++;
			else if (hand[i].value - hand[i + 1].value != 0) length = 0;
			if (length === 4) {
				//highest straight starts from index i - 3
				straight = i - 3;
				break;
			}
		}
		//straight flush found
		if (straight &gt; -1) {
			hand = hand.splice(straight, 5);
			//royal flush
			if (hand[0].value === 14)
				return [hand, 9];
			//straight flush
			else return [hand, 8];
		}
		//a plain flush found
		else {
			//take five most valuable cards
			hand = hand.splice(0, 5);
			return [hand, 5];
		}
	}

	//order cards by value
	hand.sort(function(a, b) {return b.value - a.value});
	
	//handle possible ace by duplicating to a different value
	if (hand[0].value === 14) {
		card = new Object();
		card.value = 1;
		card.suit = hand[0].suit;
		hand.push(card);
	}

	//look for a straight
	var straight = -1;
	var length = 0;
	for (var i = 0; i &lt; hand.length - 1; i++) {
		//tracking a straight
		if (hand[i].value - hand[i + 1].value === 1) length++;
		else if (hand[i].value - hand[i + 1].value != 0) length = 0;
		if (length === 4) {
			//highest straight starts from index i - 3
			straight = i - 3;
			break;
		}
	}

	//straight found
	if (straight &gt; -1) {
		hand = hand.splice(straight, 5);
		return [hand, 4];
	}
	
	//remove possible added ace. this was needed for straight search
	if (hand[0].value === 14)
		hand.pop();

	//make a new array of the cards so that cards with the same value are grouped ot sub arrays
	var grouped = new Array();
	grouped.push([hand[0]]);
	for (var i = 1; i &lt; hand.length; i++) {
		//if there is a group for this card value, then push the card into it.
		if (hand[i].value === grouped[grouped.length - 1][0].value)
			grouped[grouped.length - 1].push(hand[i]);
		//otherwise create a new group
		else grouped.push([hand[i]]);
	}

	//sort grouped cards by group size
	grouped.sort(function(a, b) {return b.length - a.length});

	//four of a kind
	if (grouped[0].length === 4) {
		var newHand = grouped[0];
		var kicker = grouped[1][0];
		for (var i = 2; i &lt; grouped.length; i++) {
			if (grouped[i][0] &gt; kicker) kicker = grouped[i][0];
		}
		newHand.push(kicker);
		return [newHand, 7];
	}
	
	//three of a kind or full house
	if (grouped[0].length === 3) {
		var newHand = grouped[0];
		//full house
		if (grouped[1].length &gt; 1) {
			newHand.push(grouped[1][0]);
			newHand.push(grouped[1][1]);
			return [newHand, 6];
		}
		//three of a kind
		else {
			newHand.push(grouped[1][0]);
			newHand.push(grouped[2][0]);
			return [newHand, 3];
		}
	}
	
	//pair or two pair
	if (grouped[0].length === 2) {
		var newHand = grouped[0];
		//two pair
		if (grouped[1].length &gt; 1) {
			newHand.push(grouped[1][0]);
			newHand.push(grouped[1][1]);
			newHand.push(grouped[2][0]);
			return [newHand, 2];
		}
		//pair
		else {
			newHand.push(grouped[1][0]);
			newHand.push(grouped[2][0]);
			newHand.push(grouped[3][0]);
			return [newHand, 1];
		}
	}

	hand = hand.splice(0, 5);
	return [hand, 0];
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/yah_gem_poker.js</td>
                    <td><pre>&quot;use strict&quot;;

this.name = &quot;yah_gem_poker&quot;;
this.author = &quot;spara&quot;;

this.payoffHands = [&quot;Jacks or Better&quot;,&quot;Two Pair&quot;,&quot;Three of a Kind&quot;,&quot;Straight&quot;,&quot;Flush&quot;,&quot;Full House&quot;,&quot;Four of a Kind&quot;,&quot;Straight Flush&quot;,&quot;Royal Flush&quot;];
this.payoffTable = [[1,2,3,4,6,9,25,50,250],[2,4,6,8,12,18,50,100,500],[3,6,9,12,18,27,75,150,750],[4,8,12,16,24,36,100,200,1000],[5,10,15,20,30,45,125,250,4000]];

//add interface, if the player has started the game anywhere elsewhere than constore
this.startUpComplete = function() {
	if (!player.ship.dockedStation.hasRole(&quot;constore&quot;)) {
		this.shipExitedWitchspace();
	}
}

this.shipExitedWitchspace = function() {
	var constores = system.shipsWithRole(&quot;constore&quot;);
	if (constores.length &gt; 0) {
		for (var i = 0; i &lt; constores.length; i++) {
			constores[i].setInterface(&quot;yah_gem-poker&quot;,{
				title: &quot;Video poker&quot;,
				category: expandMissionText(&quot;yah_gem-gambling-category&quot;),
				summary: expandMissionText(&quot;yah_gem-poker-summary&quot;),
				callback: this.$intro.bind(this)
			});
		}
	}
}

//init a new deck
this.$virginDeck = function() {
	var deck = new Array();
	var suits = [&quot;triangle&quot;, &quot;crescent&quot;, &quot;square&quot;, &quot;star&quot;];
	for (var i = 0; i &lt; 4; i++) {
		for (var j = 1; j &lt; 14; j++) {
			var card = new Object();
			card.suit = suits[i];
			card.rank = j;
			card.hold = 0; 
			deck.push(card);
		}
	}
	return deck;
}

//helper function for tabulating text on screen
this.$tabulate = function(line, width) {
	var hairSpace = String.fromCharCode(31);
	var space = defaultFont.measureString(&quot; &quot;);
	while (defaultFont.measureString(line) &lt; width - space)
		line += &quot; &quot;;
	while (defaultFont.measureString(line) &lt; width)
		line += hairSpace;
	return line;
}

//intro screen
this.$intro = function() {	
	//build and format the payoff table for screen
	var payoffMessage = this.$tabulate(&quot;Hand&quot;, 10);
	for (var i = 0; i &lt; 5; i++) {
		payoffMessage += i + 1 + &quot; g&quot;;
		payoffMessage = this.$tabulate(payoffMessage, 10 + 4 * (i + 1));
	}
	payoffMessage = &quot;\n&quot; + payoffMessage + &quot;\n\n&quot;;
	for (i = 0; i &lt; this.payoffHands.length; i++) {
		var line = this.payoffHands[this.payoffHands.length - i - 1];
		line = this.$tabulate(line, 10);
		for (var j = 0; j &lt; 5; j++) {
			line = this.$tabulate(line, 10 + 4 * j);
			line += this.payoffTable[j][this.payoffHands.length - i - 1];
		}
		payoffMessage += line+&quot;\n&quot;;
	}
	
	//format player credits for screen
	var credits = &quot;Gems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g\n&quot;;
	
	//gambling choices
	var options = {
		&quot;1_EXIT&quot; : &quot;Exit&quot;
	};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 1) {
		options[&quot;2_10&quot;] = &quot;Bet 1&quot;;
	}
	else payoffMessage += expandMissionText(&quot;yah_gem-no-credit&quot;);
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 2)
		options[&quot;3_20&quot;] = &quot;Bet 2&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 3)
		options[&quot;4_30&quot;] = &quot;Bet 3&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 4)
		options[&quot;5_40&quot;] = &quot;Bet 4&quot;;
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= 5)
		options[&quot;6_50&quot;] = &quot;Bet 5&quot;;
	
	
	mission.runScreen({
		titleKey: &quot;yah_gem-poker-title&quot;,
		message: this.$tabulate(expandMissionText(&quot;yah_gem-poker-intro-story&quot;), 26) + credits + payoffMessage,
		model: &quot;yah_gem_casino_poker_card_spin&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		choices: options,
		allowInterrupt: true,
		screenID: &quot;yah_gem_poker&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
	function (choice) {
		if (choice === &quot;2_10&quot;) this.$play(1);
		else if (choice === &quot;3_20&quot;) this.$play(2);
		else if (choice === &quot;4_30&quot;) this.$play(3);
		else if (choice === &quot;5_40&quot;) this.$play(4);
		else if (choice === &quot;6_50&quot;) this.$play(5);
	}
	);
}

//first pay, then deal
this.$play = function(bet) {
	player.ship.manifest[&quot;gem_stones&quot;] -= bet;
	//init a new deck and draw a hand (don&#39;t show it yet)
	this.$playDeck = this.$virginDeck();
	var hand = new Array();
	for (var i = 0; i &lt; 5; i++) hand.push(this.$drawCard());
	this.$deal(bet, hand);
}

//Deal
this.$deal = function(bet, hand, choice) {
	if (typeof choice === &#39;undefined&#39;) var choice = &quot;0_HOLD&quot;;
	var options = {
		&quot;0_HOLD&quot; : &quot;Hold/Cancel 1.&quot;,
		&quot;1_HOLD&quot; : &quot;Hold/Cancel 2.&quot;,
		&quot;2_HOLD&quot; : &quot;Hold/Cancel 3.&quot;,
		&quot;3_HOLD&quot; : &quot;Hold/Cancel 4.&quot;,
		&quot;4_HOLD&quot; : &quot;Hold/Cancel 5.&quot;,
		&quot;5_DEAL&quot; : &quot;Draw&quot;
	}
	var credits = &quot;Gems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g\n&quot;;
	var betText = &quot;Bet: &quot; + bet + &quot;\n&quot;;
	mission.runScreen({
		titleKey: &quot;yah_gem-poker-title&quot;,
		message: this.$tabulate(expandMissionText(&quot;yah_gem-poker-deal-story&quot;), 26) + credits + this.$tabulate(&quot; &quot;, 26) + betText,
		model: &quot;yah_gem_casino_poker_card_base&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		spinModel: false,
		choices: options,
		screenID: &quot;yah_gem_poker&quot;,
		initialChoicesKey: choice
	},
	function (choice) {
		if (choice === &quot;0_HOLD&quot;)
			hand[0].hold = (hand[0].hold + 1) % 2;
		else if (choice === &quot;1_HOLD&quot;)
			hand[1].hold = (hand[1].hold + 1) % 2;
		else if (choice === &quot;2_HOLD&quot;)
			hand[2].hold = (hand[2].hold + 1) % 2;
		else if (choice === &quot;3_HOLD&quot;)
			hand[3].hold = (hand[3].hold + 1) % 2;
		else if (choice === &quot;4_HOLD&quot;)
			hand[4].hold = (hand[4].hold + 1) % 2;
		else if (choice === &quot;5_DEAL&quot;) {
			this.$outCome(bet, hand);
			return;
		}
		this.$deal(bet, hand, choice);
		return;
	}
	);
	//update the cards on screen
	for (var i = 0; i &lt; 5; i++)
		this.$changeCard(i, hand[i]);
}

//draw &amp;&amp; outcome
this.$outCome = function(bet, hand) {
	//draw new cards
	for (var i = 0; i &lt; 5; i++) {
		if (!hand[i].hold)
			hand[i] = this.$drawCard();
		else hand[i].hold = 0;
	}
	//check for wins
	var result = this.winCheck(hand);
	//fail
	if (result === -1) {
		var sound = &quot;yah_gem_lose.ogg&quot;;
		var resultText = expandMissionText(&quot;yah_gem-poker-fail&quot;);
	}
	//win
	else {
		var win = this.payoffTable[(bet - 1)][result];
		var resultText = this.payoffHands[result] + &quot;, you win &quot; + win + &quot; g of Gems.&quot;;
		player.ship.manifest[&quot;gem_stones&quot;] += win;
		var sound = &quot;yah_gem_win.ogg&quot;;
	}
	//format player credits for screen
	var credits = &quot;Gems: &quot; + player.ship.manifest[&quot;gem_stones&quot;] + &quot; g\n&quot;;
	var betText = &quot;Bet: &quot; + bet;
	var options = {
		&quot;1_EXIT&quot; : &quot;Exit&quot;,
		&quot;2_AGAIN&quot; : &quot;Change bet&quot;,
	};
	if (player.ship.manifest[&quot;gem_stones&quot;] &gt;= bet) options[&quot;3_DEAL&quot;] = &quot;Deal again&quot;;
	mission.runScreen({
		titleKey: &quot;yah_gem-poker-title&quot;,
		message: this.$tabulate(resultText, 26) + credits + this.$tabulate(&quot; &quot;, 26) + betText,
		model: &quot;yah_gem_casino_poker_card_base&quot;,
		background: &quot;yah_gem_table_bg.png&quot;,
		spinModel: false,
		choices: options,
		music: sound,
		allowInterrupt: true,
		screenID: &quot;yah_gem_poker&quot;,
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
	},
		function (choice) {
			if (choice === &quot;2_AGAIN&quot;) {
				this.$intro();
				return;
			}
			else if (choice === &quot;3_DEAL&quot;) {
				this.$play(bet);
				return;
			}
				
		}
	)
	//update the cards on screen
	for (var i = 0; i &lt; 5; i++)
		this.$changeCard(i, hand[i]);
}

//draws a card from the current deck in play
this.$drawCard = function() {
	return this.$playDeck.splice(Math.floor(this.$playDeck.length * Math.random()),1)[0];
}

//update the texture and position for a card
this.$changeCard = function(place, card) {
	var fileName = &quot;yah_gem_card_&quot; + card.suit + &quot;_&quot; + card.rank + &quot;.png&quot;;
	mission.displayModel.subEntities[place].setMaterials({&quot;casino_poker_card_diffuse.png&quot;: {diffuse_map: fileName, emission_map: fileName, emission_modulate_color: &quot;darkGrayColor&quot;}});
	if (card.hold) {
		var position = mission.displayModel.subEntities[place].position;
		position[2] = 3;
		mission.displayModel.subEntities[place].position = position;
	}
}

//rules for a winning hand
this.winCheck = function(hand) {
	//work with a hand that has been ordered by rank
	var orderedHand = hand.concat();
	orderedHand.sort(function(a, b) {return a.rank - b.rank});
	
	//check for flush
	var suit = orderedHand[0].suit;
	var i = 0;
	var flush = false;
	for (i = 1; i &lt; 5; i++) {
		if (orderedHand[i].suit !== suit) {
			i = -1; 
			break;
		}
	}
	//flush found
	if (i !== -1) flush = true;
	
	//check for straight
	var prevRank = orderedHand[0].rank;
	var straight = false
	for (i = 1; i &lt; 5; i++) {
		if (orderedHand[i].rank - prevRank !== 1 &amp;&amp; (i !== 1 || orderedHand[i].rank !== 10 || prevRank !== 1)) {
			i = -1; 
			break;
		}
		prevRank = orderedHand[i].rank;
	}

	//straight found
	if (i !== -1) straight = true;
	
	//straight flush
	if (flush &amp;&amp; straight) {
		if (orderedHand[0].rank === 1 &amp;&amp; orderedHand[4].rank === 13)
			return 8;//royal_flush
		else return 7;//straight_flush
	}
	
	//flush 
	if (flush) return 4;//flush&quot;
	
	//straight
	if (straight) return 3;//straight
	
	//in the ordered list, for every adjacent two cards, check if they form a rank pair.
	prevRank = orderedHand[0].rank;
	var pairs = new Array();
	for (i = 1; i &lt; 5; i++) {
		if (orderedHand[i].rank === prevRank) pairs.push(i);
		prevRank = orderedHand[i].rank;
	}

	//four of a kind (3 adjacent pairs)
	//full house (3 adjacent pairs)
	if (pairs.length === 3) {
		if (orderedHand[1].rank === orderedHand[2].rank &amp;&amp; orderedHand[2].rank === orderedHand[3].rank)
			return 6;//four_of_a_kind
		else return 5;//full_house
	}

	//three of a kind (2 adjacent pairs)
	//two pair (2 adjacent pairs)
	if (pairs.length === 2) {
		if (pairs[1] - pairs[0] === 1)
			return 2;//three_of_a_kind
		else return 1;//two pair
	}
	
	//pair (jacks or better)
	if (pairs.length === 1) {
		if (orderedHand[pairs[0]].rank &gt; 10 || orderedHand[pairs[0]].rank === 1)
			return 0;
	}
	
	return -1;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
