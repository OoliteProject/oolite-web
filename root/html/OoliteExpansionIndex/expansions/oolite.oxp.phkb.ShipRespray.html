<html>
    <head>
        <title>Expansion Ship Respray</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Ship Respray</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">33 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Resprays your ship using one of the installed OXP styles</td>
                    <td>Resprays your ship using one of the installed OXP styles</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.ShipRespray</td>
                    <td>oolite.oxp.phkb.ShipRespray</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Ship Respray</td>
                    <td>Ship Respray</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ambience</td>
                    <td>Ambience</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.3.7</td>
                    <td>1.3.7</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.24</li>
                    </td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.24</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/dc/ShipRespray.oxz">https://wiki.alioth.net/img_auth.php/d/dc/ShipRespray.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873486</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Ship%20Respray'>http://wiki.alioth.net/index.php/Ship%20Respray</a></p>
        <h3>readme.txt</h3>
        <pre>Ship Respray
by Nick Rogers

About this OXP
==============
This OXP provides a way to quickly switch the style of your ship, using whatever OXP player templates you have installed of the same class type. That is, if you are flying a Cobra Mark III, and you have Z_Groovy&#39;s Variety Packs installed, you can quickly and easily give your ship a new paint job, without having to mess about in the save game file.

There are a couple of variations for the Cobra Mark III, Cobra Mark I and the Python that come with Oolite by default, but not that many. For this OXP to do something really useful you need to have some extra ship OXP&#39;s installed. For instance:
	http://wiki.alioth.net/index.php/Griff_Industries
	http://wiki.alioth.net/index.php/Staer9%27s_Shipset
	http://wiki.alioth.net/index.php/No_Shaders_alternate_or_extra_ships_and_accessories#Dertien.27s_Griff_repaint_Variety
	http://wiki.alioth.net/index.php/Deepspace_Ships
	gsagostinho&#39;s Texture Packs
You can get a lot of additional shipsets from the download manager inside Oolite.
	
Once this OXP is installed a menu will appear on the ship outfitting screen, labelled &quot;Ship Respray&quot;. When you select this, a new screen will appear, listing all the available resprays for your ship. Select one of these, and you can then see what the respray will look like on your ship. Some ship models use the &quot;entityPersonality&quot; to adjust the look of the ship. You can select a random personality by selecting &quot;Change personality&quot;. 

Once you have selected a model, and found a personality look-and-feel you like, to go ahead with the paint job select &quot;Purchase this respray&quot; from the menu. The amount of time it will take to do the respray is showing on the menu item, and can be anywhere from 24 to 60 hours, depending on the size of the vessel.

This OXP uses the ShipStorageHelper to update the players ship to the selected model.

This OXP is slightly different to the &quot;Respray for Griffs&quot; OXP by Capt Murphy, as this will work with OXP&#39;s other than Griffs, and in no-shader mode.

3rd Party Interfaces
====================
As mentioned, this OXP uses the ShipStorageHelper OXP to switch the player ship between different ship variants. Howveer, there are times when SSH doesn&#39;t know of some important configuration setting specific to your OXP. To overcome this scenario and allow an OXP to perform specialised operations before or after the player&#39;s ship is stored using the Ship Storage Helper, the following interfaces are provided:

	var sr = worldScripts.ShipRespray;
	sr.$addPreSprayCall(&quot;my_worldscript_name&quot;, &quot;my_functionname&quot;);
	sr.$addPostSprayCall(&quot;my_worldscript_name&quot;, &quot;my_functionname&quot;);

The &quot;$addPreSprayCall&quot; adds a worldScript/functionName combination to the list of functions that will be called prior to the respray.
The &quot;$addPostSprayCall&quot; adds a worldScript/functionName combination to the list of functions that will be called after the respray.
 
Licence
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Image from https://icons8.com/
Icons made by http://www.freepik.com from https://www.flaticon.com licensed by Creative Commons BY 3.0 (http://creativecommons.org/licenses/by/3.0/)

Version History
===============
1.3.7
- Added missing &quot;;&quot; to shipdata-overrides.plist and descriptions.plist.

1.3.6
- Fixed issue with number of items on the page with &quot;big GUI&quot; enabled pushing heading text off page.
- Normalised price of ZGroovy&#39;s Cobra Mark I and Cobra Mark III.

1.3.5
- Ensured that a respray of your ship doesn&#39;t result in a loss of memory of player&#39;s actions.
- Added link to Home System OXP.

1.3.4
- Added better integration with New Lasers OXP (LMSS required).

1.3.3
- Added the ability to stop the ship model spinning, to make it easier to view a paint job.
- Removed the shipyard.plist entry for the Python Blackdog.
- Changed background overlay image.

1.3.2
- Removed the Python Blackdog from being an equivalent to the standard Python (it has a slightly different body shape).
- Cleaned up the background overlay image.

1.3.1
- Turned off some debug messages.
- Limited respraying services from being offered at rock hermits, as it doesn&#39;t seem likely they&#39;d offer the service.

1.3.0
- Added routines to allow 3rd party OXP&#39;s to have functions called both pre and post a respray, in case specialised setup needs to be performed before or after changing ships.

1.2.2
- Updated check for &quot;Allow Big GUI&quot;.
- Fixed error when leaving the ship respray selection screen without making a selection.
- Added a &quot;job completed&quot; message.
- Changed &quot;==&quot; comparisons to &quot;===&quot; for performance improvements.
- Fixed max_cargo size of oolite-cobra3-alternate-player, which is based on oolite_template_cobra3-alternate, which has a larger than standard max_cargo setting.
- Fixed various settings for the additional player versions of the Cobra Mk1 and Python ships so they match the standard versions of those ships.
- Added a shipdata override for some OXP ships to correct some bugs.

1.2.1
- Small text tweaks.
- Updated screenID&#39;s to enable BGS background sounds.
- Renamed background overlay image to prevent possibility of future duplication.
- Toned down overlay image.

1.2.0
- Added overlay background image to initial interface screen.

1.1.3
- Added a missing semi-colon in the manifest file.
- Added routine to use 1.83/4 code to check for big GUI HUD&#39;s.

1.1.2
- Fixed shipdata.plist entries for alternate Cobra Mk3&#39;s having reduced max speed and thrust.

1.1.1
- Added check for &quot;allow_big_gui&quot; HUD&#39;s.

1.1.0
- Added menu option to turn on/off view of ship data keys
- Improvements to the auto selection of menu items.

1.0.3 
- Removed ship keys from screen interfaces.

1.0.2
- Added some extra shipdata.plist and shipyard.plist entries so the player can choose from the built-in variations of the Cobra Mk III, Cobra Mk I, and the Python.
- Fixed a bug where the current page index was not being reset when opening the respray interface.

1.0.1
- For Oolite 1.82 and later, added an &quot;installation_time&quot; of 1 second to the equipment item, so opening the respray screen doesn&#39;t take any time.
- For Oolite 1.80, changed the cost of the equipment item to zero, so only 10 minutes of time is taken up when opening the initial page.
- Added a mass-based installation time calculation to the end of the process. So, respraying a Boa takes longer than respraying an Adder.
- The &quot;Purchase this respray&quot; option now also includes the installation time.
- Fixed a bug where doing a respray, buying a new ship and doing another respray could end up with a confused menu.
- Code cleanup

1.0.0
- Initial release</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SHIP_RESPRAY.html">Ship Respray</a></td>
                    <td>no</td>
                    <td align="right">1000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SHIP_RESPRAY_180.html">Ship Respray</a></td>
                    <td>no</td>
                    <td align="right">1000</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_admiral-PLAYER.html">noshaders_z_groovy_cobra_Mk3_admiral-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_alpha-PLAYER.html">noshaders_z_groovy_cobra_Mk3_alpha-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_bravo-PLAYER.html">noshaders_z_groovy_cobra_Mk3_bravo-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_charlie-PLAYER.html">noshaders_z_groovy_cobra_Mk3_charlie-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_delta-PLAYER.html">noshaders_z_groovy_cobra_Mk3_delta-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_echo-PLAYER.html">noshaders_z_groovy_cobra_Mk3_echo-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_flame-PLAYER.html">noshaders_z_groovy_cobra_Mk3_flame-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_foxtrot-PLAYER.html">noshaders_z_groovy_cobra_Mk3_foxtrot-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_golf-PLAYER.html">noshaders_z_groovy_cobra_Mk3_golf-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_hotel-PLAYER.html">noshaders_z_groovy_cobra_Mk3_hotel-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_india-PLAYER.html">noshaders_z_groovy_cobra_Mk3_india-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_juliet-PLAYER.html">noshaders_z_groovy_cobra_Mk3_juliet-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_kilo-PLAYER.html">noshaders_z_groovy_cobra_Mk3_kilo-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_lima-PLAYER.html">noshaders_z_groovy_cobra_Mk3_lima-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_mike-PLAYER.html">noshaders_z_groovy_cobra_Mk3_mike-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_november-PLAYER.html">noshaders_z_groovy_cobra_Mk3_november-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_oscar-PLAYER.html">noshaders_z_groovy_cobra_Mk3_oscar-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_papa-PLAYER.html">noshaders_z_groovy_cobra_Mk3_papa-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_quebec-PLAYER.html">noshaders_z_groovy_cobra_Mk3_quebec-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_romeo-PLAYER.html">noshaders_z_groovy_cobra_Mk3_romeo-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_sierra-PLAYER.html">noshaders_z_groovy_cobra_Mk3_sierra-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_tango-PLAYER.html">noshaders_z_groovy_cobra_Mk3_tango-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_uniform-PLAYER.html">noshaders_z_groovy_cobra_Mk3_uniform-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_victor-PLAYER.html">noshaders_z_groovy_cobra_Mk3_victor-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_whiskey-PLAYER.html">noshaders_z_groovy_cobra_Mk3_whiskey-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_xray-PLAYER.html">noshaders_z_groovy_cobra_Mk3_xray-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_yankee-PLAYER.html">noshaders_z_groovy_cobra_Mk3_yankee-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/noshaders_z_groovy_cobra_Mk3_zulu-PLAYER.html">noshaders_z_groovy_cobra_Mk3_zulu-PLAYER</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/oolite-cobra3-alternate-player.html">oolite-cobra3-alternate-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/oolite-cobra3-pirate-player.html">oolite-cobra3-pirate-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/oolite-cobramk1-alternate-player.html">oolite-cobramk1-alternate-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/oolite-cobramk1-miner-player.html">oolite-cobramk1-miner-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/oolite-python-alternate-player.html">oolite-python-alternate-player</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/respray_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;ShipRespray_Conditions&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2015 phkb&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

this.allowAwardEquipment = function(equipment, ship, context) {

	// the respray equipment can only happen via the ship outfitting, and the equipment item is removed straight away anyway, so only allow the purchase context
	if (context != &quot;purchase&quot;) return false;
	if (equipment === &quot;EQ_SHIP_RESPRAY_180&quot; &amp;&amp; oolite.compareVersion(&quot;1.80&quot;) &lt; 0) return false;
	if (equipment === &quot;EQ_SHIP_RESPRAY&quot; &amp;&amp; oolite.compareVersion(&quot;1.80&quot;) &gt;= 0) return false;
	// because some ships only have 1 type, but multiple personalities, I&#39;ve commented this restriction out
	//if (worldScripts.ShipRespray._data.length &lt;= 1) return false;

	// it&#39;s actually unlikely rockhermits would offer repainting services...
	if (player.ship.dockedStation.hasRole(&quot;rockhermit&quot;) === true) return false;
	
	// otherwise allowed
	return true;
}

</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/shiprespray.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;ShipRespray&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2015 phkb&quot;;
this.description = &quot;Allows user to select a respray of their ship using one of the installed OXP ship styles&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

this._data = [];				// storage array of ship data keys
this._selectedItem = &quot;&quot;;		// currently selected item from the main list
this._selectedIndex = 0;		// index of the currently selected item
this._personality = 0;			// current entityPersonality setting
this._displayType = 0;			// respray gui display mode 0 = main list, 1 = selected item
this._lastchoice = null;		// last item chosen from the list
this._curpage = 0;				// current page being shown
this._pagesize = 16;			// max number of entries on a page
this._lastsubchoice = &quot;&quot;;		// last item chosen from the selected item display
this._showDetails = false;		// when on, displays the datakey on the list and on the selected item page
this._baseTime = 48;			// base time, using cobra mk3 as a reference
this._preCalls = [];
this._postCalls = [];
this._spinning = true;

//-------------------------------------------------------------------------------------------------------------
this.$addPreSprayCall = function(ws, fn) {
	this._preCalls.push({worldScript:ws, functionName:fn});
}

//-------------------------------------------------------------------------------------------------------------
this.$addPostSprayCall = function(ws, fn) {
	this._postCalls.push({worldScript:ws, functionName:fn});
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	this.$compileData();
	// pick a random personality to start with
	this._personality = this.$rand(32768) - 1;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function(equipment) {
	var respray = false;
	if (equipment === &quot;EQ_SHIP_RESPRAY&quot;) {
		player.ship.removeEquipment(&quot;EQ_SHIP_RESPRAY&quot;);
		// for 1.82 and later, refund the credits at this point - if the player buys the respray it will be deducted later
		player.credits += 100;
		respray = true;
	}
	if (equipment === &quot;EQ_SHIP_RESPRAY_180&quot;) {
		player.ship.removeEquipment(&quot;EQ_SHIP_RESPRAY_180&quot;);
		// for 1.80, the cost is already zero.
		respray = true;
	}
	if (respray === true) {
		// reset the menu before displaying
		this._spinning = true;
		this._displayType = 0;
		this._curpage = 0;
		this._selectedItem = &quot;&quot;;
		this._selectedIndex = 0;
		this._lastchoice = null;
		this._lastsubchoice = null;
		this.$showPage();
	}
}

//-------------------------------------------------------------------------------------------------------------
// get a list of all datakeys available for the players current ship class type (ie. &quot;Cobra Mark III&quot;)
this.$compileData = function() {

	this._data = [];

	// get a list of all ship keys that have a role of &quot;player&quot; (ie. these are playable ships, not NPC ships)
	var shipKeys = Ship.keysForRole(&quot;player&quot;);
	var freq = &quot;&quot;;
	// loop through the list
	for (var i = 0; i &lt; shipKeys.length; i++) {
		// get the shipdata entry for this key
		var shipdata = Ship.shipDataForKey(shipKeys[i]);
		// does it match the player&#39;s current ship?
		if (shipdata.name === player.ship.shipClassName) {
			// add it to the array if it&#39;s not there already
			if (this.$itemIsInArray(shipKeys[i], this._data) === false) {
				this._data.push(shipKeys[i]);
			}
		}
	}
	// sort the array (basic alpha sort)
	this._data.sort();

}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtNewShip = function(ship, price) {
	// recompile the list whenever the player buys a new ship
	this.$compileData();
}

//=============================================================================================================
// screen interfaces

//-------------------------------------------------------------------------------------------------------------
this.$showPage = function() {

	var curChoices = {};

	if (this.$isBigGuiActive() === true) {
		this._pagesize = 22;
	} else {
		this._pagesize = 16;
	}

	if (this._displayType === 0) {

		var min = (this._curpage * this._pagesize);
		var max = this._curpage * this._pagesize + this._pagesize;
		if (max &gt;= this._data.length) max = this._data.length;

		for (var i = min; i &lt; max; i++) {
			curChoices[&quot;01_ITEM_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + this._data[i]] = {text:player.ship.shipClassName + &quot; respray style &quot; + (i + 1).toString() +
			(this._showDetails === true ? &quot; (&quot; + this._data[i] + &quot;)&quot; : &quot;&quot;), color:&quot;orangeColor&quot;, alignment:&quot;LEFT&quot;};
		}

		if (max - min &lt; this._pagesize) {
			for (var i = (this._pagesize - (max - min)); i &gt; 0; i--) {
				curChoices[&quot;02_SPACER_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i] = &quot;&quot;;
			}
		}

		if (this._showDetails === true) {
			curChoices[&quot;94_HIDEKEYS&quot;] = {text:&quot;Hide data keys&quot;};
		} else {
			curChoices[&quot;95_SHOWKEYS&quot;] = {text:&quot;Show data keys&quot;};
		}

		if (this._curpage &gt; 0) {
			curChoices[&quot;96_PREV&quot;] = {text:&quot;Previous page&quot;, color:&quot;yellowColor&quot;};
		} else {
			curChoices[&quot;96_PREV&quot;] = {text:&quot;Previous page&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
		}
		if (this._data.length &gt; this._pagesize &amp;&amp; this._curpage &lt; (Math.ceil(this._data.length / this._pagesize) - 1)) {
			curChoices[&quot;97_NEXT&quot;] = {text:&quot;Next page&quot;, color:&quot;yellowColor&quot;};
		} else {
			curChoices[&quot;97_NEXT&quot;] = {text:&quot;Next page&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
		}

		curChoices[&quot;99_EXIT&quot;] = {text:&quot;Exit&quot;, color:&quot;yellowColor&quot;};

		var def = &quot;99_EXIT&quot;;

		var opts = {
			screenID: &quot;oolite-shiprespray-main-map&quot;,
			title: player.ship.shipClassName + &quot; Respray&quot;,
			allowInterrupt: true,
			overlay: {name:&quot;sr-paint.png&quot;, height:546},
			exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
			choices: curChoices,
			initialChoicesKey: this._lastchoice?this._lastchoice:def,
			message: &quot;Select a respray style&quot;
		};
	}

	if (this._displayType === 1) {
		var calc = Math.floor((player.ship.mass / 214737.6875) * this._baseTime);
		if (calc &lt; 24) calc = 24;
		if (worldScripts.HomeSystem &amp;&amp; worldScripts.HomeSystem.$isHomeSystem(system.ID) === true) {
			calc /= 2;
		}
		var def = &quot;98_CLOSE&quot;;

		curChoices[&quot;02_SELECT&quot;] = {text:&quot;Purchase this respray (100 Cr, &quot; + calc.toFixed(1) + &quot; hours)&quot;, color:&quot;yellowColor&quot;};
		curChoices[&quot;03_PERSONALITY&quot;] = {text:&quot;Change personality (&quot; + this._personality + &quot;)&quot;, color:&quot;yellowColor&quot;};
		if (this._spinning === true) {
			curChoices[&quot;04_STOP_SPIN&quot;] = {text:&quot;Stop ship spinning&quot;, color:&quot;yellowColor&quot;};
		} else {
			curChoices[&quot;05_START_SPIN&quot;] = {text:&quot;Start ship spinning&quot;, color:&quot;yellowColor&quot;};
		}
		curChoices[&quot;98_CLOSE&quot;] = {text:&quot;Close&quot;, color:&quot;yellowColor&quot;};
		var opts = {
			screenID: &quot;oolite-shiprespray-item-map&quot;,
			title: player.ship.shipClassName + &quot; Respray&quot;,
			model:&quot;[&quot; + this._selectedItem + &quot;]&quot;,
			spinModel:this._spinning,
			modelPersonality: this._personality,
			exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
			allowInterrupt: true,
			choices: curChoices,
			initialChoicesKey: this._lastsubchoice?this._lastsubchoice:def,
			message: player.ship.shipClassName + &quot; respray style &quot; + (this._selectedIndex + 1).toString() + (this._showDetails === true ? &quot; (&quot; + this._selectedItem + &quot;)&quot; : &quot;&quot;)
		};
	}

	mission.runScreen(opts, this.$selectScreenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$selectScreenHandler = function(choice) {

	if (choice == null) return;
		
	if (choice.indexOf(&quot;~&quot;) &gt;= 0) {
		this._displayType = 1;
		this._selectedItem = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._selectedIndex = parseInt(choice.substring(8, 10));
		this._lastchoice = choice;
		this._lastsubchoice = null;
	} else if (choice === &quot;02_SELECT&quot;) {
		// need code to recreate player ship, transferring all cargo and equipment
		this.$resprayShip(this._selectedItem, this._personality);
		choice = &quot;99_EXIT&quot;;
	} else if (choice === &quot;04_STOP_SPIN&quot;) {
		this._spinning = false;
	} else if (choice === &quot;05_START_SPIN&quot;) {
		this._spinning = true;
	} else if (choice === &quot;03_PERSONALITY&quot;) {
		this._personality = this.$rand(32768) - 1;
		this._lastsubchoice = &quot;03_PERSONALITY&quot;;
	} else if (choice === &quot;94_HIDEKEYS&quot;) {
		this._showDetails = false;
		this._lastchoice = &quot;95_SHOWKEYS&quot;;
	} else if (choice === &quot;95_SHOWKEYS&quot;) {
		this._showDetails = true;
		this._lastchoice = &quot;94_HIDEKEYS&quot;;
	} else if (choice === &quot;96_PREV&quot;) {
		this._curpage -= 1;
		if (this._curpage &gt; 0) {
			this._lastchoice = choice;
		} else {
			this._lastchoice = &quot;97_NEXT&quot;;
		}
	} else if (choice === &quot;97_NEXT&quot;) {
		this._curpage += 1;
		if (this._curpage &lt; (Math.ceil(this._data.length / this._pagesize) - 1)) {
			this._lastchoice = choice;
		} else {
			this._lastchoice = &quot;96_PREV&quot;;
		}
	} else if (choice === &quot;98_CLOSE&quot;) {
		this._displayType = 0;
	}

	if (choice != &quot;99_EXIT&quot;) {
		this.$showPage();
	}
}

//-------------------------------------------------------------------------------------------------------------
// do the respray, using ShipStorageHelper
this.$resprayShip = function(dataKey, personality) {

	var p = player.ship;
	var playershipname = p.shipUniqueName;
	var hud = p.hud;

	if (this._preCalls.length &gt; 0) {
		for (var i = 0; i &lt; this._preCalls.length; i++) {
			var itm = this._preCalls[i];
			worldScripts[itm.worldScript][itm.functionName]();
		}
	}

	// first, store all equipment and cargo the player might have
	var shipstr = worldScripts[&quot;Ship_Storage_Helper.js&quot;].storeCurrentShip();
	
	// change the datakey to the new one
	var data = JSON.parse(shipstr);
	data[1] = dataKey; // apply the data key to the ship
	data[13] = personality; // apply the selected personality to the ship
	shipstr = JSON.stringify(data);

	var lmss = worldScripts.LMSS_Core;
	if (lmss) lmss._switching = true;

	// store the current list of player roles
	var roles = [];
	for (var i = 0; i &lt; p.roleWeights.length; i++) {
		roles.push(p.roleWeights[i]);
	}

	// restore the players ship
	worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(shipstr);

	// restore the previous list of roles
	for (var i = 0; i &lt; p.roleWeights.length; i++) {
		if (roles.length - 1 &gt;= i) p.setPlayerRole(roles[i], i);
	}

	if (lmss) lmss._switching = false;
	
	// restore some things that the storage helper doesn&#39;t replace
	p.shipUniqueName = playershipname;
	p.hud = hud;

	// charge the player
	player.credits -= 100;

	if (this._postCalls.length &gt; 0) {
		for (var i = 0; i &lt; this._postCalls.length; i++) {
			var itm = this._postCalls[i];
			worldScripts[itm.worldScript][itm.functionName]();
		}
	}
	
	// send an email if the email system is installed
	var w = worldScripts.EmailSystem;
	if (w) {
		var ga = worldScripts.GalCopAdminServices;
		w.$createEmail({sender:expandDescription(&quot;[purchase-maintenance-sender]&quot;),
			subject:p.shipClassName + &quot; Respray&quot;,
			date:global.clock.seconds,
			message:expandDescription(&quot;[respray_email]&quot;, {shipclass:p.shipClassName}),
			expiryDays:ga._defaultExpiryDays}
		);
	}

	// work out how much install time is required
	// using cobra mass as the benchmark
	var install = Math.floor((p.mass / 214737.6875) * this._baseTime);
	if (install &lt; 24) install = 24;
	// only half the time if this is our home system
	if (worldScripts.HomeSystem &amp;&amp; worldScripts.HomeSystem.$isHomeSystem(system.ID) === true) {
		install /= 2;
	}

	install = parseInt(install * 60 * 60);

	mission.runScreen({
		screenID:&quot;oolite-shiprespray-complete-map&quot;,
		title: player.ship.shipClassName + &quot; Respray&quot;,
		model:&quot;[&quot; + dataKey + &quot;]&quot;,
		modelPersonality: personality,
		allowInterrupt: true,
		message: &quot;Your ship has been successfully resprayed.&quot;,
		exitScreen: &quot;GUI_SCREEN_EQUIP_SHIP&quot;,
	});

	global.clock.addSeconds(install);

	// if the station dock control is installed, tell it to check for launched ships
	if (worldScripts.StationDockControl) {
		var w = worldScripts.StationDockControl;
		if (w._disable === false) {
			w.$checkForLaunchedShips();
		}
	}

	this._displayType = 0;
	this._lastchoice = null;
}

//=============================================================================================================
// helper functions

//-------------------------------------------------------------------------------------------------------------
// return a random number between 1 and max
this.$rand = function(max) {
	return Math.floor((Math.random() * max) + 1)
}

//-------------------------------------------------------------------------------------------------------------
// checks if a given element is in the array
this.$itemIsInArray = function(element, array) {
	var found = false;
	if (array != null &amp;&amp; array.length &gt; 0) {
		for (var i = 0; i &lt; array.length; i++) {
			if (array[i] === element) found = true;
		}
	}
	return found;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; 	// until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
