<html>
    <head>
        <title>Expansion Escort Formations</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Escort Formations</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Vary the flight formations used by escort pilots to give some alternatives to the usual &#39;v&#39; shape.</td>
                    <td>Vary the flight formations used by escort pilots to give some alternatives to the usual &#39;v&#39; shape.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.cim.escort-formations</td>
                    <td>oolite.oxp.cim.escort-formations</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Escort Formations</td>
                    <td>Escort Formations</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>cim</td>
                    <td>cim</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.3</td>
                    <td>1.3</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Escort_Formations">http://wiki.alioth.net/index.php/Escort_Formations</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/d4/Escort_Formations_1.3.oxz">https://wiki.alioth.net/img_auth.php/d/d4/Escort_Formations_1.3.oxz</a></td>
                    <td><a target="_blank" href="http://compsoc.dur.ac.uk/~cim/oolite/Escort_Formations_1.1.oxz">http://compsoc.dur.ac.uk/~cim/oolite/Escort_Formations_1.1.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-SA 3.0</td>
                    <td>CC-BY-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1693392141</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Escort%20Formations'>http://wiki.alioth.net/index.php/Escort%20Formations</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/escort-formations.js</td>
                    <td><pre>this.author = &quot;cim&quot;;
this.copyright = &quot;ï¿½ 2011-2014 cim.&quot;;
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version = &quot;1.3&quot;;
this.name = &quot;Escort Formations Randomiser&quot;;
this.description = &quot;Randomise escort formations for traders and pirates&quot;;

&quot;use strict&quot;;

this.startUp = function () {
	this.$escortPatterns = new Object;
	this.$escortPatterns[&quot;combat-spread&quot;] = [new Vector3D(1, 0, 0),
		new Vector3D(-1, 0, 0)
	];
	this.$escortPatterns[&quot;echelon&quot;] = [new Vector3D(1, 0, -1)];
	this.$escortPatterns[&quot;trail&quot;] = [new Vector3D(1, 0, -5),
		new Vector3D(-1, 0, -6)
	];
	this.$escortPatterns[&quot;vform&quot;] = [new Vector3D(1, 0, -1),
		new Vector3D(-1, 0, -1)
	];
	this.$escortPatterns[&quot;arrowhead&quot;] = [new Vector3D(1, 0, -1),
		new Vector3D(-1, 0, -1),
		new Vector3D(0, 1, -1),
		new Vector3D(0, -1, -1)
	];
	this.$escortPatterns[&quot;convoy&quot;] = [new Vector3D(0, 1, 7),
		new Vector3D(0, -1, -7),
		new Vector3D(1, 1, 6),
		new Vector3D(-1, 1, 6),		
		new Vector3D(-1, -1, -6),
		new Vector3D(1, -1, -6),
		new Vector3D(0, 1.5, -3),		
		new Vector3D(0, -1.5, 3)		
	];
	this.$escortPatterns[&quot;scouting-spread&quot;] = [new Vector3D(5, 0, -4),
		new Vector3D(-5, 0, 4)
	];
	this.$escortPatterns[&quot;planebox&quot;] = [new Vector3D(2, 0, 2),
		new Vector3D(-2, 0, -2),
		new Vector3D(-2, 0, 2),
		new Vector3D(2, 0, -2)
	];
	this.$escortPatterns[&quot;twistbox&quot;] = [new Vector3D(2, 0, 2),
		new Vector3D(0, 2, -2),
		new Vector3D(0, -2, -2),
		new Vector3D(-2, 0, 2)
	];
	this.$escortPatterns[&quot;octahedron&quot;] = [new Vector3D(4, 0, 0),
		new Vector3D(-4, 0, 0),
		new Vector3D(0, 4, 0),
		new Vector3D(0, -4, 0),
		new Vector3D(0, 1, 4),
		new Vector3D(0, -1, -4)
	];
	this.$escortPatterns[&quot;pyramid&quot;] = [new Vector3D(0, 1, 4.5),
		new Vector3D(3, 3, -3),
		new Vector3D(-3, -3, -3),
		new Vector3D(-3, 3, -3),
		new Vector3D(3, -3, -3)
	];
	this.$escortPatterns[&quot;wave&quot;] = [new Vector3D(1, 0, -0.5),
		new Vector3D(-1, 0, -0.5),
		new Vector3D(1, 0, -5.5),
		new Vector3D(-1, 0, -5.5),
		new Vector3D(2, 0, -6.5),
		new Vector3D(-2, 0, -6.5)
	];
	this.$escortPatterns[&quot;screen&quot;] = [new Vector3D(1, 0, 3),
		new Vector3D(-1, 0, 3),
		new Vector3D(4, 0, 2.5),
		new Vector3D(-4, 0, 2.5)
	];
	this.$escortPatterns[&quot;opencolumn&quot;] = [new Vector3D(-0.5, 0, -2),
		new Vector3D(0.5, 0, -2),
		new Vector3D(-0.5, 0, -4),
		new Vector3D(0.5, 0, -4),
		new Vector3D(-0.5, 0, -6),
		new Vector3D(0.5, 0, -6)
	];
	this.$escortPatterns[&quot;stack&quot;] = [new Vector3D(0.5, 1, 0),
		new Vector3D(-0.5, -1, 0)
	];
	this.$escortPatterns[&quot;flank&quot;] = [new Vector3D(1, 0, -1),
		new Vector3D(-1, 0, -1),
		new Vector3D(7, 0, -1),
		new Vector3D(-7, 0, -1)
	];
	this.$escortPatterns[&quot;bulge&quot;] = [new Vector3D(-1, 0, -1),
		new Vector3D(1, 0, -1),
		new Vector3D(0, 0.5, 7),
		new Vector3D(0, -0.5, -7)
	];
	this.$escortPatterns[&quot;near-far&quot;] = [new Vector3D(-1, 0, -1),
		new Vector3D(7, 0, -1),
		new Vector3D(1, 0, -1),
		new Vector3D(6, 0, -2)
	];
	this.$escortPatterns[&quot;helix&quot;] = [new Vector3D(-3, 0, -1),
		new Vector3D(0, 3, -2),
		new Vector3D(3, 0, -3),
		new Vector3D(0, -3, -4),
		new Vector3D(-4, 0, -5),
		new Vector3D(0, 4, -6),
		new Vector3D(4, 0, -7),
		new Vector3D(0, -4, -8)
	];
	this.$escortPatterns[&quot;trigon&quot;] = [new Vector3D(-1, -0.5, 4.14),
		new Vector3D(1, -0.5, 4.14),
		new Vector3D(0, 1, 3),		
		new Vector3D(0, -1.5, 3),
		new Vector3D(3, 1.5, 2),
		new Vector3D(-3, 1.5, 2)
	];
	this.$escortPatterns[&quot;tetrahedron&quot;] = [new Vector3D(-2, -0.83, 1.16), // 4 pos (tetrahedron), 8 pos (double-tetrahedron), 12-16 pos (swarm)
		new Vector3D(2, -0.83, 1.16),
		new Vector3D(0, -0.83, -2.31),		
		new Vector3D(0, 2.43, 0),
		new Vector3D(-2, 0.83, -1.16),
		new Vector3D(2, 0.83, -1.16),
		new Vector3D(0, 0.83, 2.31),		
		new Vector3D(0, -2.43, 0)
	];			
	this.$escortPatterns[&quot;vwide&quot;] = [new Vector3D(4, 0, -4),
		new Vector3D(-4, 0, -4)
	];		
}

this.shipSpawned = function (ship) {
	if (!ship.script) return; // odd, but seems to happen occasionally
	if (ship.script.coordinatesForEscortPosition != Script.prototype.coordinatesForEscortPosition) {
		this.$debug(ship.displayName + &quot; has escort coordinates already&quot;);
		return;
	} // already has some custom coordinates
	if (ship.script.$efr_pattern) {
		this.$debug(ship.displayName + &quot; has $efr_pattern already&quot;);
		return;
	} // variable name conflict
	if (ship.script.$efr_timer) {
		this.$debug(ship.displayName + &quot; has $efr_pattern already&quot;);
		return;
	} // variable name conflict
	var offensiveChance = 0;
	if (ship.primaryRole == &quot;trader&quot;) {
		offensiveChance = 0.15;
	} else if (ship.primaryRole == &quot;bigTrader&quot; &amp;&amp; ship.name != &quot;Super Bulk Hauler&quot;) {
		offensiveChance = 0.15;
	} else if (ship.primaryRole == &quot;liner&quot; || ship.primaryRole == &quot;coachwhip&quot; || ship.primaryRole == &quot;fuelship&quot;) { // from Transports OXP
		offensiveChance = 0.05;
	} else if (ship.primaryRole == &quot;pirate&quot;) {
		offensiveChance = 0.75;
	} else if (ship.primaryRole == &quot;police&quot; || ship.primaryRole == &quot;hunter&quot;) {
		offensiveChance = 0.9;
	} else {
		this.$debug(ship.displayName + &quot; has no included role&quot;);
		return; // stock ships only
	}
	if (Math.random() &lt; 0.10) {
		this.$debug(&quot;No escort change for &quot; + ship.displayName);
		return;
	} // keep default formation

	// timer to allow escorts to be set up too
	if (Math.random() &lt; offensiveChance) {
		ship.script.$efr_timer = new Timer(ship, function () {
			worldScripts[&quot;Escort Formations Randomiser&quot;].$setupOffensiveEscorts(ship);
		}, 0.25);
	} else {
		ship.script.$efr_timer = new Timer(ship, function () {
			worldScripts[&quot;Escort Formations Randomiser&quot;].$setupDefensiveEscorts(ship);
		}, 0.25);
	}
}

this.$setupOffensiveEscorts = function (ship) {
	var formations = new Array();
	if (!ship.escorts) {
		return; // no escorts
	} else if (ship.escorts.length &lt;= 2) {
		formations.push(&quot;combat-spread&quot;, &quot;echelon&quot;, &quot;vform&quot;, &quot;trail&quot;, &quot;near-far&quot;, &quot;trigon&quot;, &quot;vwide&quot;);
	} else if (ship.escorts.length &lt;= 4) {
		formations.push(&quot;combat-spread&quot;, &quot;echelon&quot;, &quot;arrowhead&quot;, &quot;vform&quot;, &quot;wave&quot;, &quot;stack&quot;, &quot;flank&quot;, &quot;near-far&quot;, &quot;trigon&quot;, &quot;helix&quot;, &quot;vwide&quot;);
	} else {
		formations.push(&quot;arrowhead&quot;, &quot;vform&quot;, &quot;wave&quot;, &quot;stack&quot;, &quot;flank&quot;, &quot;trigon&quot;, &quot;helix&quot;);
	}
	this.$setupEscortFormation(ship, formations[Math.floor(Math.random() * formations.length)]);
}

this.$setupDefensiveEscorts = function (ship) {
	var formations = new Array();
	if (!ship.escorts) {
		return; // no escorts
	} else if (ship.escorts.length &lt;= 2) {
		formations.push(&quot;convoy&quot;, &quot;vform&quot;, &quot;scouting-spread&quot;, &quot;screen&quot;, &quot;near-far&quot;, &quot;vwide&quot;);
	} else if (ship.escorts.length &lt;= 4) {
		formations.push(&quot;planebox&quot;, &quot;twistbox&quot;, &quot;vform&quot;, &quot;convoy&quot;, &quot;screen&quot;, &quot;opencolumn&quot;, &quot;bulge&quot;, &quot;near-far&quot;, &quot;tetrahedron&quot;, &quot;vwide&quot;);
	} else {
		formations.push(&quot;octahedron&quot;, &quot;pyramid&quot;, &quot;vform&quot;, &quot;convoy&quot;, &quot;tetrahedron&quot;, &quot;bulge&quot;);
	}
	this.$setupEscortFormation(ship, formations[Math.floor(Math.random() * formations.length)]);
}

this.$setupEscortFormation = function (ship, formation) {
	ship.script.$efr_pattern = formation;
	ship.script.coordinatesForEscortPosition = function (index) {
		var positions = worldScripts[&quot;Escort Formations Randomiser&quot;].$getEscortPositions(this.$efr_pattern);
		var layer = 1 + Math.floor(index / positions.length); 
		var component = index % positions.length;

		return positions[component].multiply(this.ship.collisionRadius * 5 * layer).add([0, 0, 7.5 * this.ship.collisionRadius]);
	}
	this.$debug(ship.displayName + &quot; assigned formation: &quot; + formation);
	ship.updateEscortFormation();
}

this.$getEscortPositions = function (pattern) {
	if (this.$escortPatterns[pattern]) { return this.$escortPatterns[pattern];
	} else { return this.$escortPatterns[&quot;vform&quot;]; }
}

this.$debug = function (msg) {
	//log(this.name,msg);
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
