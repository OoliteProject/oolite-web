<html>
    <head>
        <title>Expansion Fighters</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Fighters</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">22 Equipment</a></li>
          <li><a href="#ships">26 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">4 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Optional Expansions mismatch between OXP Manifest and Expansion Manager at character position 0061 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Tiny ships can use your cargo space as hangar: launch and attack your hostiles automatically. Finish core missions or travel to far galaxies for better fighters. You can control 8 fighters at once by default, buy a Fighter Bay to handle 16 and allow heavy fighters on board. The best hybrid types require Alien Items from Tharglets.</td>
                    <td>Tiny ships can use your cargo space as hangar: launch and attack your hostiles automatically. Finish core missions or travel to far galaxies for better fighters. You can control 8 fighters at once by default, buy a Fighter Bay to handle 16 and allow heavy fighters on board. The best hybrid types require Alien Items from Tharglets.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Fighters</td>
                    <td>oolite.oxp.Norby.Fighters</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Fighters</td>
                    <td>Fighters</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Weapons</td>
                    <td>Weapons</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby, Shipbuilder, Thargoid, Killer Wolf, Knotty</td>
                    <td>Norby, Shipbuilder, Thargoid, Killer Wolf, Knotty</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.5</td>
                    <td>1.5</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Thargoid.Armoury:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Thargoid.Armoury:</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Fighters">http://wiki.alioth.net/index.php/Fighters</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/8/8f/Fighters_1.5.oxz">https://wiki.alioth.net/img_auth.php/8/8f/Fighters_1.5.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873369</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Fighters'>http://wiki.alioth.net/index.php/Fighters</a></p>
        <h3>readme.txt</h3>
        <pre>Fighters OXP

Most ships are large in Oolite, even a cargo canister is as big (6x6x10m) as fighter planes.
This allow to use Fuel Scoop as launcher of light ships stored in cargo space.
No missiles and no cargo space on fighters but ejection seat is included so you should scoop your defeated pilots.

Fighters are available in equipment shop and not in shipyard.
Damaged fighters can not launch until not repaired in a station which has shipyard.
Small scratches are repaired right when your fighters land back into your ship.

You can force them to land either by run to green alert or initiate a hyperjump countdown, then cancel it before can happen and repeat until no more fighters outside.
You can follow the activity of your fighters in MFD.

In combat very hard to hit a fighter due to the extremely small size. The best if use your own fighters against them.

Worth to get more firepower or even decoy against pirates for these cheap costs.


Fighters

Fighter     Class  Size(m)  Speed    Cost  Occupy En.+Arm Recharg Pitch Laser      Other
Light       Knight 6x4x10   600      1000  5t     0+1     0       2.5   Pulse      No shields, just armor
Robot       AI     7x2x8    400      5000  1t     1       2       3     Pulse      No pilot so need only 1t cargo space
Swarm       Pawn   6x2x10   500      2000  5t     0+0.5   1       2     3*Pulse    3 ships in a group, Organic armor, need 3 Alien Items
Raider      Bishop 13x3x16  400      3000  10t    2       1       2     Dual Pulse ECM, passive cloak in cloaked era
GalTech     Rook   19x5x23  300/2100 5000  15t    2       2       1.8   Beam       ECM, Injectors, need Galaxy 6 or Constrictor mission
Steel Shark Queen  20x8x22  200      10000 20t    2       2       1.6   Sniper     ECM, need Galaxy 7 or Nova Mission
Shark       Queen  20x8x22  200/1400 10000 20t    2+2     2       1.4   Sniper     ECM, Organic, Injectors, need 5 Alien Items, Galaxy 7 or Nova
Iron King   King   28x6x18  100      20000 25t    2       2       1.2   Thargoid   ECM, need Galaxy 8 or Thargoid Plans
King        King   28x6x18  100/700  50000 25t    2+6     2       1     Thargoid   ECM, Organic, Injectors, need 10 Alien Items, Galaxy 8 or Thargoid Plans


Light Fighter

A standard Knight-class Light Fighter occupy 5t cargo space, use Pulse Laser but no shields, so damages repairable only when landed.
Lightning fast: 1.5 times faster than Asp but no Quirium fuel within so no Injectors nor hyperdrive.
Cost 1000 credits.


Robot Fighter

Very small AI controlled fighter, fit into a cargo canister and launch through Fuel Scoop. As fast as an Asp, use Pulse Laser, but has a single energy bank only and no fuel inside so no injectors nor hyperdrive. Use only 1t cargo space as hangar due to no pilot within, but 5 times more costly than a Light Fighter.


Swarm Fighter Group

Contain 3 Pawn-class fighters in a group, based on robot technology of Thargons which fly without pilots and save cargo space on mothership: need 1t for each fighter and additional 2t for supply so 5t in total.
Slower and less durable than Knight-class Light Fighters, no shields but its organic armor regenerates slowly.
A group together offer 3 Pulse Lasers but nothing else.

Use a single control link only due to the group always stay in close formation.
Named to Swarm because a Fighter Bay can handle 16 groups so 48 fighters! This huge swarm fit into a Python also using 100t cargo space: 16 x 5t = 80t, plus 20t for the bay.

Need 3 Alien Items to build a group and cost 2000 credits.
Repair first regroup 2 damaged groups into a single group without any cost. If only one group is damaged then need an Alien Item and 1000 credits or you can decide to wait until another group got damage then do merge.


Raider

Ships in Bishop-class need 10t space and Fighter Bay on your ship. Offer Dual Pulse Lasers, shields, ECM, more energy and faster recharge but slower than light fighters (still as fast as an Asp) and larger so less hard to hit.

Raiders will get passive stealth (decloak when fire) after you acquired a Cloaking Device.
No fuel within so missing injector speeds and hyperdrive.
Cost 3000 credits.


GalTech Interceptor

The gap between Bishop and Queen fighter classes should be filled with a 15t Rook class ship which can use Injectors.
This is why designers in Galaxy 6 made a smaller variant of GalTech Escort Fighter which is named to GalTech Interceptor.

Prototypes where sizes are reduced to half in all 3 dimensions show good results using a Beam Laser.
Stronger than a Raider due to the better energy recharge, longer fire range and unique intercept/runaway speed, at least until there are some fuel in the tank.

If you defeat Constrictor then you can get this ship anywhere and not in Galaxy 6 only.


Shark

Developers made efforts to produce a Queen-class fast heavy fighter with some organic armor, Injectors and a new Sniper Laser, which is a Pulse Laser with a revolutional, very accurate targeting system named to Sniper Lock, where most shots will hit! Measured in real combat situations that pilots are able to deliver about 10 times more shots with this extremly useful system.

The result need 5 Alien Items, 10000 credits, 20t cargo space, main station, moreover available in Galaxy 7 only until Nova mission is not completed.

A weakness is if armor destroyed then Injectors are unusable and Shark need repair in a station to be usable again.

You can buy &quot;Steel Shark&quot; variant (named by Commander Duggan) if you have no Alien Items, which missing organic armor and injectors.


King

The strongest King-class fighter occupy 25t in cargo bay, offer frangible but accurate turreted Thargoid Laser with Sniper Lock, ECM and shields, moreover very strong organic armour plates around the ship, which absorb all damages for a while and regenerates!

Has strong scanner with double range (50km) which keep up target lock far from the mother and at hyperjump can follow you into the wormhole from this far.
The slowest fighter but a King rarely retreat and Injectors can help a bit.

Fire less powerful shots than a Shark but longer range (17.5km instead of 12.5km) and hold 3 times more armor. King also need armor to use Injectors and very slow without so better if you go to pick up those who send a message about lost armor.

Very costly: need 50.000 credits and 10 Alien Items. Only main stations can build these, moreover the necessary parts are available in Galaxy 8 only. If you complete Thargoid Plans mission then you can buy it in other Galaxies also as a thank you from GalCop.

The cheaper &quot;Iron King&quot; variant (named by Commander Cody) is available for 20.000 credits without Alien Items but no organic armor nor injectors within.



Fighter Bay

Fighters from 10t occupied cargo space like Raider, GalTech Interceptor, Shark and King are heavy fighters which need Fighter Bay to get enough large doors for launch.
Allocate 20t cargo space for a control room to raise the number of fighters supported by your ship from 8 to 16.
Help also to do not lose your fighters if you jump to another system without landing them first, except those which are out of your scanner so can not reach your ship in time.


Fighter Support Center

Add communication and supply rooms like in a carrier which allow to handle 40 fighters, but occupy 100t space and need a ship over 400t mass like Anaconda.


Fighter Hangar

Convert your ship to a well equipped carrier by allocating space for very large supply rooms, which can handle 80 fighters at once.
Contain self-repair systems which make the hangar undamageable but not the stored fighters.
Need a big ship over 8000t mass which can not fit into regular docks, like Andromeda or Condor.
Occupy 200t space and cost 100.000 credits.


Credits

Model of Ejected Pilot comes from Knotty&#39;s Astronaut OXP.
Model of Light Fighter comes from Shipbuilder&#39;s Colonial_Viper_Mark_1_V1.03.oxp.
Model of Swarm comes from Thargoid&#39;s Swarm OXP.
Model of Raider comes from Shipbuilder&#39;s Cylon_Raider_Mk1_lower_detail_model_V1.01.oxp.
Model of GalTech Interceptor comes from Shipbuilder&#39;s GalTech Escort Fighter OXP.
Model of Shark comes from Thargoid&#39;s Aquatics OXP.
Model of King comes from Killer Wolf&#39;s kw-kc-capsule.dat in King Cobra OXP.

License

Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. 
To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.


Changelog
2020.09.17. v1.5  Robot Fighter added.
2017.05.16. v1.4  Fixed a rare error message around addDefenseTarget, thanks to cag.
2017.02.02. v1.3  Fixed a minor bug of Light Fighter in fighters_ship.js, thanks to Rustem.
2016.07.14. v1.2  Steel Shark and Iron King not need Alien Items but no organic armor nor injectors on these.
                  Repair of a Swarm group need a single Alien Item only instead of 2.
                  Fighter Hangar can handle 80 fighters on very big ships like Andromeda and Condor.
                  Fighter Support Center available on Anaconda again, as in v1.0.
2016.07.09. v1.1  Improved target selection of Fighters, aim owner&#39;s target only when near.
                  Damaged Light Fighters do landing regardless of alert level.
                  Fighter Support Center require very big undockable ship over 8000t mass.
                  Fixed Galtech fighter&#39;s stopover by lower accuracy (8, which disable sniper mode).
                  Shark laser power halved, still very effective due to Sniper Lock.
                  Sniper Lock range reduced to 6km.
                  King cost raised to 50000Cr.
2016.06.13. v1.0  First release.


Norby
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTERBAY.html">Fighter Bay</a></td>
                    <td>yes</td>
                    <td align="right">50000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTERHANGAR.html">Fighter Hangar</a></td>
                    <td>yes</td>
                    <td align="right">1000000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTERSREMOVE.html">Remove all fighters and related equipments</a></td>
                    <td>yes</td>
                    <td align="right">70</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTERSUPPORT.html">Fighter Support Center</a></td>
                    <td>yes</td>
                    <td align="right">100000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_GALTECH.html">GalTech Interceptor</a></td>
                    <td>yes</td>
                    <td align="right">50000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_IRONKING.html">Iron King</a></td>
                    <td>yes</td>
                    <td align="right">200000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_KING.html">King</a></td>
                    <td>yes</td>
                    <td align="right">500000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_LIGHT.html">Light Fighter</a></td>
                    <td>yes</td>
                    <td align="right">10000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_RAIDER.html">Raider</a></td>
                    <td>yes</td>
                    <td align="right">30000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_ROBOT.html">Robot Fighter</a></td>
                    <td>yes</td>
                    <td align="right">50000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_SHARK.html">Shark</a></td>
                    <td>yes</td>
                    <td align="right">100000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_STEELSHARK.html">Steel Shark</a></td>
                    <td>yes</td>
                    <td align="right">100000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FIGHTER_SWARM.html">Swarm Fighter Group</a></td>
                    <td>yes</td>
                    <td align="right">20000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_GALTECH.html">Refund a GalTech Interceptor</a></td>
                    <td>yes</td>
                    <td align="right">40</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_IRONKING.html">Refund an Iron King</a></td>
                    <td>yes</td>
                    <td align="right">60</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_KING.html">Refund a King</a></td>
                    <td>yes</td>
                    <td align="right">60</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_LIGHT.html">Refund a Light Fighter</a></td>
                    <td>yes</td>
                    <td align="right">10</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_RAIDER.html">Refund a Raider</a></td>
                    <td>yes</td>
                    <td align="right">30</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_ROBOT.html">Refund a Robot Fighter</a></td>
                    <td>yes</td>
                    <td align="right">10</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_SHARK.html">Refund a Shark</a></td>
                    <td>yes</td>
                    <td align="right">50</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_STEELSHARK.html">Refund a Steel Shark</a></td>
                    <td>yes</td>
                    <td align="right">50</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/REFUND_EQ_FIGHTER_SWARM.html">Refund a Swarm Fighter Group</a></td>
                    <td>yes</td>
                    <td align="right">20</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-alienitem.html">Alien Item</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-galtech.html">GalTech Interceptor</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-galtech-player.html">fighters-galtech-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-ironking.html">Iron King</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-ironking-player.html">fighters-ironking-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-king.html">King</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-king-player.html">fighters-king-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-kingheadsub.html">Head of King Fighter</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-kingsub.html">fighters-kingsub</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-light.html">Light Fighter</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-light-player.html">fighters-light-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-pilot.html">Ejected Pilot</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-raider.html">Raider</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-raider-player.html">fighters-raider-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-raidersub.html">fighters-raidersub</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-robot.html">Robot Fighter</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-robot-player.html">fighters-robot-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-shark.html">Shark</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-shark-player.html">fighters-shark-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-sharkheadsub.html">fighters-sharkheadsub</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-sharksub.html">fighters-sharksub</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-steelshark.html">Steel Shark</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-steelshark-player.html">fighters-steelshark-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-swarm.html">Swarm Group</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-swarm-player.html">fighters-swarm-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/fighters-swarmsub.html">Swarm Fighter</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/fighters-eqcond.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;fighters-eqcond&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2016 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;

this.allowAwardEquipment = function(eqKey, ship, context) {
    if (eqKey == &quot;EQ_FIGHTERBAY&quot;
        || ( eqKey == &quot;EQ_FIGHTERSUPPORT&quot; &amp;&amp; ship.mass &gt;= 400000 &amp;&amp; ship.mass &lt; 8000000 )
        || ( eqKey == &quot;EQ_FIGHTERHANGAR&quot; &amp;&amp; ship.mass &gt;= 8000000 )
        || eqKey == &quot;EQ_FIGHTERSREMOVE&quot; ) {
        if( ship == player.ship &amp;&amp; player.ship.docked
            &amp;&amp; player.ship.dockedStation &amp;&amp; player.ship.dockedStation.hasShipyard ) {
                return true; //buy or remove these at stations with shipyard only
        }
    } else if (eqKey &amp;&amp; (eqKey.indexOf(&quot;EQ_FIGHTER_&quot;) == 0 //new fighter
        || eqKey.indexOf(&quot;REFUND_EQ_FIGHTER_&quot;) == 0 ) ) {  //or refund
        if( context == &quot;purchase&quot; ) {
            if( ship == player.ship &amp;&amp; player.ship.docked //need station with shipyard
                &amp;&amp; player.ship.dockedStation &amp;&amp; player.ship.dockedStation.hasShipyard ) {

                if( eqKey.indexOf(&quot;EQ_FIGHTER_&quot;) == 0 ) { //new fighter or repair

                    var w = worldScripts.fighters;
                    if( w &amp;&amp; w._eqStats(ship, eqKey).dmg &gt; 0 ) return true; //repair

                    var ai = player.ship.manifest.alien_items;

                    //Swarm fighter need 3 Alien Items
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_SWARM&quot;) == 0 &amp;&amp; !(ai&gt;=3)) return false;

                    //GalTech fighter need Galaxy 6 or completed Constrictor Hunt core mission
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_GALTECH&quot;) == 0 &amp;&amp; galaxyNumber != 5
                            &amp;&amp; missionVariables.conhunt != &quot;MISSION_COMPLETE&quot; )
                        return false;

                    //Shark fighter need 5 Alien Items, mainStation and Galaxy 7
                    //or completed Nova core mission
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_SHARK&quot;) == 0 &amp;&amp; ( !(ai&gt;=5)
                        || player.ship.dockedStation != system.mainStation
                        || galaxyNumber != 6
                            &amp;&amp; missionVariables.nova != &quot;NOVA_HERO&quot; ) )
                        return false;
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_STEELSHARK&quot;) == 0 &amp;&amp; (
                        player.ship.dockedStation != system.mainStation
                        || galaxyNumber != 6
                            &amp;&amp; missionVariables.nova != &quot;NOVA_HERO&quot; ) )
                        return false;

                    //King fighter need 10 Alien Items, mainStation and Galaxy 8
                    //or completed Thargoid Plans core mission
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_KING&quot;) == 0 &amp;&amp; ( !(ai&gt;=10)
                        || player.ship.dockedStation != system.mainStation
                        || galaxyNumber != 7
                            &amp;&amp; missionVariables.thargplans != &quot;MISSION_COMPLETE&quot; ) )
                        return false;
                    if( eqKey.indexOf(&quot;EQ_FIGHTER_IRONKING&quot;) == 0 &amp;&amp; (
                        player.ship.dockedStation != system.mainStation
                        || galaxyNumber != 7
                            &amp;&amp; missionVariables.thargplans != &quot;MISSION_COMPLETE&quot; ) )
                        return false;

                    if( w &amp;&amp; w.$FightersOfPlayer &lt; w.$MaxFighters )
                        return true; //there is a room for a new fighter

                } else { //refund fighter
                    var k = eqKey.substring(7); //chop REFUND_ to get the eqkey of fighter
                    if(ship.equipmentStatus(k) == &quot;EQUIPMENT_OK&quot;)
                        return true; //there is an undamaged fighter from this type in this ship
                }
            }
        } else return true; //award a fighter eq at landing in space
    }
    return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fighters-ship.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;fighters-ship&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2016 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;ship script of fighters&quot;;

this.$FighterKey = &quot;&quot;; //store equipmentKey of this fighter to award back when landed
this.$FighterHull = this.ship.maxEnergy; //must repair in hangar, avoid recharge when no shields
this.$FighterNumber = 0; //order of this fighter in escort formation
this.$FighterOwner = null; //store the mothership
this.$FighterShields = true; //cache of this.ship.scriptInfo.npc_shields
this.$ForcedLanding = false; //forced due to damage, do not stop landing with others
this.$OwnerScoopPos = null; //store the mothership&#39;s scoop position for landing
this.$SniperLock = false; //cache of shipdata.plist script_info fighters-sniperlock field
this.$TimerLandNow = null; //trigger _landNow() after some time for sure landing
this.$ws = worldScripts.fighters;

//ship script events
this.shipAttackedOther = function(other) {
        if( other &amp;&amp; other.isDerelict &amp;&amp; other == this.ship.target )
                this.ship.target = null; //do not destroy derelicts, choose another target instead
}

this.shipBountyChanged = function(delta,reason) {
        //prevent orange scanner flag on player&#39;s fighters with ShipVersion OXP
        if(this.$FighterOwner == player.ship &amp;&amp; this.ship.bounty &gt; 0 ) {
                this.ship.bounty = 0; //Warning: this change trigger this event again!
        }                             //So must check before that bounty is greater than 0
}                                     //else this is an infinite loop which make Crash To Desktop!

this.shipCollided = this.shipWasScooped = function(otherShip) {
        if(otherShip == this.$FighterOwner) {
            this.ship.energy = this.ship.maxEnergy; //sometimes prevent destruction

            if(this.ship.AIState == &quot;LANDING&quot;) //put into the hangar
                this._landNow(this.ship, this.$FighterOwner);
        }
}

this.shipLaunchedEscapePod = function(escapepod, passengers) {
        this.ship.target = null;
        this.ship.performHold();
        this.ship.switchAI(&quot;nullAI.plist&quot;);
}

this.shipTakingDamage = function(amount, whom, type) {
        this.$FighterHull -= amount; //workaround recharge when no shields
        if( !this.$FighterShields ) { //light fighter without shields
                if(this.$FighterHull &lt; 0) { //out of hull
                        delete this.shipTakingDamage;//prevent infinite loop
                        if(this.ship &amp;&amp; this.ship.isValid) {
                                this.ship.abandonShip(); //eject pilot
                                this.ship.explode(); //destroy the defeated fighter
                        }
                } else if(this.$FighterHull &lt; this.ship.maxEnergy * 0.4) { //damaged
			var fi = this.ship;
                        var fai = &quot;fightersAI.plist&quot;;
                        if(fi.AI != fai ) fi.switchAI(fai);
                        fi.target = null; //clear target to stop attack
                        fi.AIState = &quot;LANDING&quot;;
                        this.$ForcedLanding = true;
                }
        } else { //make sure damages on heavy fighters are persistent by set ECM to damaged
                if(this.ship &amp;&amp; this.ship.energy &lt; 0.4 * this.ship.maxEnergy ) {
                        if( this.ship.equipmentStatus(&quot;EQ_ECM&quot;) == &quot;EQUIPMENT_OK&quot; ) {
                                this.ship.setEquipmentStatus(&quot;EQ_ECM&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
                                if(this.ship.dataKey === &quot;fighters-raider&quot;) { //lose a laser
                                        var su = this.ship.subEntities;
                                        if(su &amp;&amp; su[1]) su[1].remove();//no true within to display message
                                }
                        }
                }
        }
}

this.shipSpawned = function() {
        if( !this.ship ) return;
        var si = this.ship.scriptInfo;
        if( si &amp;&amp; si.npc_shields == &quot;no&quot; //Swarm has regenerating armor without CustiomShields
            &amp;&amp; this.ship.primaryRole != &quot;EQ_FIGHTER_SWARM&quot; ) {
                this.$FighterShields = false;
        } else this.$FighterShields = true;
        
        if( si &amp;&amp; si.fighters_sniperlock ) this.$SniperLock = true;
        
        if( this.ship.primaryRole === &quot;EQ_FIGHTER_RAIDER&quot; //stealth fighters in cloaked era
            &amp;&amp; ( player.ship.equipmentStatus(&quot;EQ_CLOAKING_DEVICE&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
                || missionVariables.cloak === &quot;COMPLETE&quot;  ) ) {
            this.ship.awardEquipment(&quot;EQ_CLOAKING_DEVICE&quot;);
        }
}

this.spawnedAsEscort = function(mother) {  //for NPC mothers
        if(mother &amp;&amp; mother.script) {
            if(!mother.script.$LaunchedFighters) mother.script.$LaunchedFighters = 1;
            else mother.script.$LaunchedFighters++;
            this.$FighterNumber = mother.script.$LaunchedFighters;
            if(!mother.script.$Fighters) mother.script.$Fighters = [];
            mother.script.$Fighters.push(this.ship);
            this.ship.displayName = this.ship.name+&quot; #&quot;+this.$FighterNumber;
        }
        this.$FighterOwner = mother;
}

this.shipTargetDestroyed = function(target) {
        if(this.ship == player.ship || this.$FighterOwner != player.ship )
            return; //exit if worldScript, do in ship script only
        if(target.primaryRole == &quot;constrictor&quot; &amp;&amp; missionVariables.conhunt &amp;&amp; missionVariables.conhunt == &quot;STAGE_1&quot;) {
                // just in case an escort kills the constrictor, let&#39;s not break the mission for the player...
                missionVariables.conhunt = &quot;CONSTRICTOR_DESTROYED&quot;;
        }
        
        if(target.isRock || target.isBoulder || target.isCargo || target.isWeapon)
                return;
        
//      player.score += 1; - score should remain personal
        var b = &quot;&quot;;
        if(target.bounty &gt; 0) {
            b = &quot; : &quot; + target.bounty + &quot;₢ awarded.&quot;;
            player.credits += target.bounty;
        }
        player.consoleMessage(this.ship.displayName+&quot; killed &quot;+target.name+b, 5);
        log(this.name, this.ship.displayName+&quot; killed &quot; + target.name + &quot; : &quot; + target.bounty +&quot;₢&quot;);
}

this.shipDied = function(whom,why) {
        if( !this.ship || this.ship == player.ship ) return; //exit if worldScript, do in ship script only
        if( this.ship.dataKey === &quot;fighters-swarm&quot; ) {
            var ai = system.addShips(&quot;fighters-alienitem&quot;, 1, this.ship.position, 20);
            if( ai &amp;&amp; ai[0] &amp;&amp; this.ship.velocity) ai[0].velocity = this.ship.velocity;
            var e = this.ship.subEntities;
            var l = 0;
            if( e ) l = e.length;
            if( l &gt; 0 ) { //there are subents so not all swarm fighters are lost
                var sw = system.addShips(&quot;fighters-swarm&quot;, 1, this.ship.position, 20)[0];
                if(sw) {
                    sw.target = this.ship.target;
                    if(this.ship.target) sw.addDefenseTarget(this.ship.target);
                    if(sw.script) {
                        sw.script.$FighterKey = this.$FighterKey;
                        sw.script.$FighterNumber = this.$FighterNumber;
                        sw.script.$FighterOwner = this.$FighterOwner;
                        sw.script.$TrailsDisabled = 1; //reduce load with Trails OXP
                    }
                    this.$FighterOwner.escortGroup.addShip(sw);
                    var f;
                    if(this.$FighterOwner === player.ship) f = this.$ws.$Fighters;
                    else f = this.$FighterOwner.script.$Fighters;
                    var fi = f.indexOf(this.ship);
                    if( fi &gt; -1 ) {
                        if(this.$FighterOwner === player.ship) this.$ws.$Fighters[fi] = sw;
                        else this.$FighterOwner.script.$Fighters = sw;
                    }
                    sw.velocity = this.ship.velocity;
                    sw.orientation = this.ship.orientation;
                    sw.displayName = this.ship.displayName;
                    if( this.$FighterOwner === player.ship ) {
                        sw.bounty = 0; //remove bounty from fighter given in shipdata.plist
                        sw.scannerDisplayColor1 = [0, 0.4, 0]; //green, mean frendly
                        //si.scannerDisplayColor2 = [0, 0.4, 0]; //green, mean frendly
                    } else {
                        if( ship.bounty == 0 ) sw.bounty = 0; //remove bounty from fighter given in shipdata.plist
                    }
                    var su = sw.subEntities;
                    if(su &amp;&amp; su[1]) {
                        su[1].remove(true); //remove a swarm fighter
                        if( l == 1 ) su[0].remove(true); //remove another also
                    }
                }
            }
        }
        if( this.ship.dataKey === &quot;fighters-shark&quot; ) {
                var a = Math.ceil(this.$ws._alienItems(&quot;EQ_FIGHTER_SHARK&quot;)/2);
                var ai = system.addShips(&quot;fighters-alienitem&quot;, a, this.ship.position, 100);
                if( ai &amp;&amp; this.ship.velocity )
                    for( var i = 0; i &lt; ai.length; i++ )
                        if(ai[i]) ai[i].velocity = this.ship.velocity;
        }
        if( this.ship.dataKey === &quot;fighters-king&quot; ) {
                var a = Math.ceil(this.$ws._alienItems(&quot;EQ_FIGHTER_KING&quot;)/2);
                var ai = system.addShips(&quot;fighters-alienitem&quot;, a, this.ship.position, 100);
                if( ai &amp;&amp; this.ship.velocity )
                    for( var i = 0; i &lt; ai.length; i++ )
                        if(ai[i]) ai[i].velocity = this.ship.velocity;
        }
        if( this.$FighterOwner == player.ship ) {
                var d = &quot; lost&quot;;
                if( whom &amp;&amp; whom.isValid &amp;&amp; whom != player.ship ) {
                        d = &quot; defeated by &quot;+whom.displayName;
                }
                player.commsMessage(this.ship.displayName + d, 10);
                this.$ws._MFD(); //update numbers in MFD
        }
        log(this.name, this.ship.displayName+&quot; terminated by &quot;+whom+&quot; &quot;+why); //log NPC fighters also
}


//fighter functions

this._escortPosition = function() {this._escortPosition2(this.ship);} //for fighterAI.plist

this._escortPosition2 = function(ship) {
        if( ship &amp;&amp; ship.isDerelict ) {
            ship.target = null;
            ship.performHold();
            ship.switchAI(&quot;nullAI.plist&quot;);
            return;
        }
        var sc = ship.script;
        if( !sc || !sc.$FighterNumber || !sc.$FighterOwner || !sc.$FighterOwner.isValid
            || ship == player.ship ) return; //for sure

        if( sc.$FighterOwner == player.ship &amp;&amp; //green alert or jump countdown
            ( player.alertCondition == 1 || this.$ws.$ForcedLanding ) ) {
            ship.AIState = &quot;LANDING&quot;;
            this.$ws._MFD(); //update if owner is the player
            return;
        }

        if( ship.target &amp;&amp; ship.target.hasHostileTarget ) {
            ship.setAI(&quot;interceptAI.plist&quot;);
            return;
        }

        var epos = sc.$ws.coordinatesForEscortPosition(sc.$FighterNumber);
        var pos = sc.$FighterOwner.position.add(epos);
        ship.savedCoordinates = pos;
        if( ship.injectorSpeedFactor &gt; 0 )
            ship.desiredSpeed = ship.injectorSpeedFactor * ship.maxSpeed;
        else ship.desiredSpeed = 7 * ship.maxSpeed; //for Oolite 1.80
        ship.desiredRange = 0; //go to the escort position in the formation
        ship.performFlyToRangeFromDestination();
        ship.reactToAIMessage(&quot;OWNER_FAR&quot;);//go back to owner
        //var dist = ship.position.distanceTo(sc.$FighterOwner.position);
        //if(dist &gt; 10000) ship.reactToAIMessage(&quot;OWNER_FAR&quot;);//go back to owner
        //else if(dist &gt; 5000) ship.reactToAIMessage(&quot;OWNER_NEAR&quot;);//go back to owner
        //else ship.reactToAIMessage(&quot;OWNER_NEXT&quot;);//keep formation
}

this._landing = function() {this._landing2(this.ship);}

this._landing2 = function(ship) {
        if( ship &amp;&amp; ship.isDerelict ) {
            ship.target = null;
            ship.performHold();
            ship.switchAI(&quot;nullAI.plist&quot;);
            return;
        }
        var sc = ship.script;
        if( !sc || ship == player.ship ) return; //for sure

        var owner = sc.$FighterOwner;
        if( !owner || !owner.isValid ) return;

        ship.target = null; //clear target to stop attack

        var landingdist = 50; //m from the scoop position of owner where put into hangar
        //make a waypoint below the owner&#39;s scoop position
        var scooppos = owner.position;
        var sp = this.$OwnerScoopPos;
        if( !sp ) { //first time read scoop pos from shipdata.plist
            var shipdata = Ship.shipDataForKey(owner.dataKey);
            if( shipdata ) {
                sp = shipdata[&quot;scoop_position&quot;];
                if(sp &amp;&amp; sp != &quot;undefined&quot;) {
                    sp = sp.split(&quot; &quot;,3);
                    if( sp &amp;&amp; sp.length == 3 ) {
                        this.$OwnerScoopPos = sp;
                        //log(this.name, owner.name+&quot; scoop_position:&quot;+sp); //debug
                    }
                }
            }
            if( !this.$OwnerScoopPos ) { //no scoop pos in shipdata so make one
                this.$OwnerScoopPos = [];
                this.$OwnerScoopPos[0] = 0;
                this.$OwnerScoopPos[1] = -20;
                this.$OwnerScoopPos[2] = 0;
                sp = this.$OwnerScoopPos;
            }
        }
        scooppos = scooppos.add(owner.vectorRight.multiply(sp[0]))
                            .add(owner.vectorUp.multiply(sp[1]))
                            .add(owner.heading.multiply(sp[2]));
        var down = 1.5*owner.collisionRadius; //AI never enter into collisionRadius
        var downpos = scooppos.add(owner.vectorUp.multiply(-down));
        ship.savedCoordinates = downpos.add(owner.velocity.multiply(6)); //go below the owner
        // also must use setDestinationFromCoordinates in AI.plist

        var d = ship.position.distanceTo(scooppos);
        var d2 = ship.position.distanceTo(downpos);
        //log(this.name, d);
        if( this.$ws.$TractorBeam ) {
                if( d &lt; landingdist ) { //enough near?: add to the hangar
                        this._landNow(ship, owner);
                        return;
                }
                if( d2 &lt; down ) { //arrived below the owner?
                        //if( owner.addCollisionException ) { //need Oolite v1.81
                        //    owner.addCollisionException(ship); //must go near
                            //log(this.name, &quot;coll.ex.len:&quot;+owner.collisionExceptions.length);//debug
                        //}

                        //go up to the owner&#39;s center point from below into the dock
                        ship.savedCoordinates = scooppos.add(owner.velocity.multiply(2));
                        // also must use setDestinationFromCoordinates in AI.plist

                        //apply &quot;tractor beam&quot; to pull this fighter to the scoop
                        var v = scooppos.subtract(ship.position);
                        ship.velocity = v.direction().multiply(80).add(v.multiply(0.4))
                                .add(owner.velocity);

                        //make sure the fighter will land after 10 seconds
                        if( !this.$TimerLandNow )
                                this.$TimerLandNow = new Timer(this, this._TimedLandNow.bind(this), 10);

                        ship.desiredSpeed = 0; //must set before &quot;OWNER_NEXT&quot;
                        ship.reactToAIMessage(&quot;OWNER_NEXT&quot;); //go straight
                        return;
                }
        } else { //land without tractor beam
                if( d &lt; landingdist ) {
                        //must be triggered outside collisionRadius of owner
                        this._landNow(ship, owner); //add to the hangar
                        return;
                } else if( d2 &lt; down ) { //surely land after 10 seconds
                        if( !this.$TimerLandNow )
                                this.$TimerLandNow = new Timer(this, this._TimedLandNow.bind(this), 10);
                        //go up to the owner&#39;s center point from below into the dock
                        ship.savedCoordinates = scooppos.add(owner.velocity);
                        ship.desiredSpeed = ship.maxSpeed; //must set before &quot;OWNER_NEXT&quot;
                        ship.reactToAIMessage(&quot;OWNER_NEXT&quot;); //go straight
                        return;
                }
        }

        if( d &lt; 2000 ) ship.reactToAIMessage(&quot;OWNER_NEAR&quot;); //approach owner at normal speed
        else ship.reactToAIMessage(&quot;OWNER_FAR&quot;); //use injectors in approach if available
}

this._landNow = function(ship, owner) { //put back into the internal hangar
        if(!ship || !owner || !owner.isValid) return; //for sure
        var f = [], f2 = []; //remove from $Fighters array
        this.$ws._awardFighter(ship, owner); //put back into the owner&#39;s equipment list
        if( owner == player.ship ) {
            if( this.$ws.$LaunchedFighters &gt; 0 ) this.$ws.$LaunchedFighters--;
            f = this.$ws.$Fighters;
        } else if( owner.script ) {
            if( owner.script.$LaunchedFighters &gt; 0 ) owner.script.$LaunchedFighters--;
            f = owner.script.$Fighters;
        }
        var out = 0;
        for(var i = 0; i &lt; f.length; i++) {
            var fi = f[i];
            if( fi != ship ) {
                f2.push(fi);
                if( fi &amp;&amp; fi.isValid ) out++;
            }
        }
        if( owner == player.ship ) {
            this.$ws.$Fighters = f2;
            this.$ws._MFD(); //update numbers in MFD
            if( out == 0 ) {
                player.commsMessage(&quot;All fighters landed&quot;, 10);
                player.consoleMessage(&quot; &quot;, 10); //make room to the countdown
            }
        } else if( owner.script ) owner.script.$Fighters = f2;

        //prevent double landing if both shipCollided and shipWasScooped is fired
        var sc = ship.script;
        if( sc ) sc.$FighterOwner = null;

        //if( owner.removeCollisionException ) { //need Oolite v1.81
        //    owner.removeCollisionException(ship); //must go near
            //log(this.name, &quot;coll.ex.len:&quot;+owner.collisionExceptions.length);//debug
        //}
        ship.remove(true); //landed
}

this._newTarget = function() {this._newTarget2(this.ship);} //AI in plist located new target

this._newTarget2 = function() { //AI in plist located new target
        var sc = ship.script;
        if( !sc || ship == player.ship ) return; //for sure
        var owner = sc.$FighterOwner;
        if( !owner || !owner.isValid || owner != player.ship ) return; //player&#39;s fighters only
        var t = ship.target;
        if( !this.$ws._isValidFighterTarget(t, owner) ) return;

        player.consoleMessage(ship.name+&quot; #&quot;+this.$FighterNumber+&quot; aim &quot;+t.displayName, 4.5);
        this.$ws._MFD(); //update numbers in MFD
}

this._TimedLandNow = function() { 
        if( this.$TimerLandNow ) {
                this.$TimerLandNow.stop();
                delete this.$TimerLandNow;
        }
        this._landNow(this.ship, this.$FighterOwner);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fighters-subent.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;fighters-subent&quot;;
this.author         = &quot;Norby&quot;;
this.copyright      = &quot;© 2016 Norby, Creative Commons: attribution, non-commercial, sharealike.&quot;;
this.description    = &quot;ship script for subentities of fighters&quot;;

this.shipDied = function (whom,why) {
    if( !this.ship || !this.ship.owner || !this.ship.owner.isValid ) return; //for sure

    switch(this.ship.dataKey) {
        case &quot;fighters-raidersub&quot;: {
            var m = &quot;I lost a laser, but there is another!&quot;;
            var e = this.ship.owner.subEntities;
            if( !e || e.length &lt; 1 ) m = &quot;No more laser!&quot;;
            this.ship.owner.commsMessage(m);
            break;
        };
        case &quot;fighters-swarmsub&quot;: {
            var ai = system.addShips(&quot;fighters-alienitem&quot;, 1, this.ship.owner.position, 20);
            if( ai &amp;&amp; ai[0] &amp;&amp; this.ship.velocity) ai[0].velocity = this.ship.velocity;

            var s = this.ship.owner.script;
            if( s &amp;&amp; s.$FighterOwner == player.ship ) {//for fighters of player only
                var by = &quot;&quot;;
                if(whom) by = &quot;by &quot;+whom.displayName;
                player.consoleMessage(&quot;A Swarm fighter destroyed&quot;+by);
            }
            log(this.name, this.ship.displayName+&quot; destroyed by &quot;+whom+&quot; &quot;+why); //log NPC fighters also
            break;
        };
        case &quot;fighters-sharkheadsub&quot;: {
            this.ship.owner.commsMessage(&quot;Front armor lost.&quot;);
            break;
        };
        case &quot;fighters-sharksub&quot;:
        case &quot;fighters-kingsub&quot;: {
            this.ship.owner.commsMessage(&quot;No more armor, Injectors unusable.&quot;);
            this.ship.owner.fuel = 0; //prevent usage of injectors
            this.ship.owner.setEquipmentStatus(&quot;EQ_HEAT_SHIELD&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
            break; //landing script will set fighter eq to damaged so forced repair in station
        };
        case &quot;fighters-kingheadsub&quot;: {
            this.ship.owner.commsMessage(&quot;I lost my turret.&quot;);
            break;
        };
    }
};</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/fighters.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;fighters&quot;;
this.author         = &quot;Norby&quot;;
this.copyright      = &quot;© 2016 Norby, Creative Commons: attribution, non-commercial, sharealike.&quot;;
this.description    = &quot;worldscript for fighters&quot;;

//settings
this.$AutoRepair = true; //pay for fighter repairs right at arrival screen
this.$FireDist = 12000; //where fighters accept new target, best within Pulse Laser range (12.5km)
this.$LaunchDelay = 1; //delay between launch of fighters in seconds
this.$MaxFightersIfNoBay = 8; //how many fighters you can control without Fighter Bay
this.$MFDName = &quot;Fighters&quot;; //name appear in HUD and MFD Selector Interface
this.$TractorBeam = true; //pull fighters to the scoop position of owner at landing

//internal variables, should not touch
this.$EscortPositions = []; //store positions for escort formation
this.$FCB = null; //FrameCallBack for sniperlock of Kings and Sharks
this.$FighterCost = []; //cost of fighters, read from equipment.plist in startUp
this.$FighterKeys = []; //[&quot;EQ_FIGHTER_LIGHT&quot;,&quot;EQ_FIGHTER_RAIDER&quot;]; //in equipment.plist
this.$Fighters = []; //Active, launched fighters
this.$FightersOfPlayer = 0; //actually how many figters owned by the player
this.$ForcedLanding = false; //must land when countdown active
this.$LastForced = false; //store forced status for next fighter launch
this.$LastTarget = null; //store target for next fighter launch
this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar
this.$LaunchInProgress = false; //do not launch fighters too often
this.$LeftBehindFighters = 0; //set in shipWillEnterWitchspace, read in shipExitedWormhole
this.$LeftBehindSystem = &quot;&quot;;  //set in shipWillEnterWitchspace, read in shipExitedWormhole
this.$MaxFighters = this.$MaxFightersIfNoBay; //how many fighters you can control currently
this.$simulator = false; //detect if combat simulator is running
this.$Targets = []; //Ships once targeted by fighters, indexed by entityPersonality
this.$TimerDelay = null; //for fighter launch delay


//event handlers

this.startUp = function() {
    this.$MaxFighters = this._maxFighters(player.ship);
    this.$FightersOfPlayer = missionVariables.$FightersOfPlayerPlusOne;
    if( !this.$FightersOfPlayer ) this.$FightersOfPlayer = 0;
    else this.$FightersOfPlayer--; //missionVariables store one more to avoid 0

    var j = 0;
    var alleq = EquipmentInfo.allEquipment;
    for(var i = 0; i &lt; alleq.length; i++) { //read fighter costs into local array
        var eq = alleq[i];
        if( eq ) {
            var k = eq.equipmentKey;
            if( k &amp;&amp; k.indexOf(&quot;EQ_FIGHTER_&quot;) == 0 ) {
                this.$FighterKeys[j] = k;
                //bubble sort keep smaller fighters first to ensure launch of heaviest first
                var sp = EquipmentInfo.infoForKey( k ).requiredCargoSpace;
                for( var x = j; x &gt; 0 &amp;&amp;
                    sp &lt; EquipmentInfo.infoForKey(this.$FighterKeys[x-1]).requiredCargoSpace;
                    x-- ) { //exchange the two fighters until smaller than the other
                    var tmpkey = this.$FighterKeys[x];
                    this.$FighterKeys[x] = this.$FighterKeys[x-1];
                    this.$FighterKeys[x-1] = tmpkey;
                }
                j++;
            }
        }
    }
    for(var i = 0; i &lt; this.$FighterKeys.length; i++) { //read fighter costs into local array
        var k = this.$FighterKeys[i];
        this.$FighterCost[i] = EquipmentInfo.infoForKey( k ).price/10;
    }

    var feq = this._fighterEqsOf(player.ship);
    if( feq != this.$FightersOfPlayer ) {
        log(this.name, &quot;Using &quot;+feq+&quot; fighter equipments instead of &quot;
            +this.$FightersOfPlayer+&quot; from missionVariables&quot;);
        this.$FightersOfPlayer = feq; //override by the number of counted fighter equipments
    }

    var h = worldScripts.hudselector;
    if( h &amp;&amp; h.$HUDSelectorAddMFD ) h.$HUDSelectorAddMFD(this.name, this.$MFDName);

    if( !isValidFrameCallback(this.$FCB) ) {
        this.$FCB = addFrameCallback( this._FCB.bind(this) ); //sniperlock of Kings and Sharks
    }

}

this.shipSpawned = function(ship) { //NPC with fighters
    if(this === worldScripts.fighters) return; //do nothing in worldscript, just in NPC ship script

    this.$MaxFighters = this._maxFighters(ship);

    if( !isValidFrameCallback(this.$FCB) ) {
        this.$FCB = addFrameCallback( this._FCB.bind(this) ); //sniperlock of Kings and Sharks
    }

}


this.alertConditionChanged = function(newCondition, oldCondition) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    this._MFD(); //update if player, even if not use fighters
    if( !this._playerHasFighters(ship) || player.docked ) return;

    if( newCondition == 1 ) { //green alert in space so fighters should go back to hangar
        var out = this._fightersLanding();
        if( out &gt; 0 ) {
            var s = out+&quot; fighters are&quot;;
            if( out == 1 ) s = &quot;A fighter is&quot;;
            player.consoleMessage(s+&quot; landing&quot;, 4.5);
        }
    } else if( newCondition == 3 &amp;&amp; player.alertHostiles ) {
        this._fightersStopLanding(); //cancel landing in red alert
        this._launchFighters(ship.target, true); //forced launch even if no valid target
    }
}

this.coordinatesForEscortPosition = function(index) {
    var pos = this.$EscortPositions[index]; //cache of positions
    if( !pos ) pos = this.$EscortPositions[index] = this.coordinatesForEscortPosition2(index);
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( ship &amp;&amp; ship.isValid ) pos = pos.add(ship.velocity.multiply(4)); //adjusted for movement
    return(pos);
}

this.coordinatesForEscortPosition2 = function(index) {
        //4 groups in square form, 4*4=16 fighters
        //always show the xz plane of system due to zero second coordinates
        var positions = [new Vector3D(1,0,1), new Vector3D(-1,0,1),
                         new Vector3D(1,0,-1), new Vector3D(-1,0,-1)];
        var space = 100; //m space between escorts in the same group
        var zoom = 1500; //m, scale group positions around the mothership

        //small adjustment in x position to form horizontal lines within groups
        var layer = 1+Math.floor(index/positions.length);
        var xdir = 1; //spread one left, one right, starting from center to outside
        var i = layer/2;
        var fi = Math.floor(i);
        if( fi == i ) xdir = -1;
        var x = xdir * space * ( 0.5 + (fi % 4) ); //x positions within a group: -50 50 -150 150

        //small adjustment in y position for more than 16 fighters
        var y = space * ( -0.5 + Math.floor(index/(4*positions.length)));

        var group = index % positions.length;
        return positions[group].multiply(zoom).add([x,y,0]);
}

this.distressMessageReceived = function(aggressor, sender) {
    this._launchFighters(aggressor);
}

this.equipmentDamaged = this.equipmentRepaired = this.equipmentRemoved = this.equipmentAdded = function(equipment) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    this.$MaxFighters = this._maxFighters(ship);
}


this.helpRequestReceived = function(ally, enemy) {
    this._launchFighters(enemy);
}

this.playerBoughtEquipment = function(equipmentKey) {
    if(equipmentKey === &quot;EQ_FIGHTERSREMOVE&quot;) {
        player.ship.removeEquipment(equipmentKey);
        var ai = 0, refund = 0, k, eqcost;
        for(var i = 0; i &lt; this.$FighterKeys.length; i++) { //remove all fighter types
            k = this.$FighterKeys[i];
            var e = this._eqStats(player.ship, k);
            eqcost = this.$FighterCost[i];
            refund += eqcost * e.ok + eqcost/2 * e.dmg; //half price for damaged fighters
            ai += (e.ok+e.dmg) * this._alienItems(k); //regain all built-in alien items
            //one less alien items in each damaged swarm fighter group
            if( k.indexOf(&quot;EQ_FIGHTER_SWARM&quot;) == 0 ) ai -= e.dmg;
            for(var j = 0; j &lt; e.ok + e.dmg; j++) { //remove all fighters
                player.ship.removeEquipment(k);//remove fighter
            }
        }
        var f = &quot;&quot;, fb = &quot;&quot;, fcc = &quot;&quot;;
        if(this.$FightersOfPlayer &gt; 1) f = this.$FightersOfPlayer+&quot; fighters&quot;;
        else if(this.$FightersOfPlayer == 1 ) f = &quot;a fighter&quot;;

        k = &quot;EQ_FIGHTERBAY&quot;;
        if( player.ship.equipmentStatus(k) != &quot;EQUIPMENT_UNAVAILABLE&quot; ) {
            eqcost = EquipmentInfo.infoForKey( k ).price/10;
            if(player.ship.equipmentStatus(k) == &quot;EQUIPMENT_OK&quot;) refund += eqcost;
            else refund += eqcost/2; //half money if damaged
            player.ship.removeEquipment(k);
            fb = &quot;Fighter Bay&quot;;
            if(f.length &gt; 0) f = &quot; and &quot;+f;
        }
        k = &quot;EQ_FIGHTERSUPPORT&quot;;
        if( player.ship.equipmentStatus(k) != &quot;EQUIPMENT_UNAVAILABLE&quot; ) {
            eqcost = EquipmentInfo.infoForKey( k ).price/10;
            if(player.ship.equipmentStatus(k) == &quot;EQUIPMENT_OK&quot;) refund += eqcost;
            else refund += eqcost/2; //half money if damaged
            player.ship.removeEquipment(k);
            if(f.length &gt; 0 &amp;&amp; fb.length &gt; 0) fcc = &quot;, &quot;;
            else if(fb.length &gt; 0) fcc = &quot; and &quot;;
            else if(f.length &gt; 0) f = &quot; and &quot;+f;
            fcc += &quot;Fighter Support Center&quot;;
        }
        k = &quot;EQ_FIGHTERHANGAR&quot;;
        if( player.ship.equipmentStatus(k) != &quot;EQUIPMENT_UNAVAILABLE&quot; ) {
            eqcost = EquipmentInfo.infoForKey( k ).price/10;
            if(player.ship.equipmentStatus(k) == &quot;EQUIPMENT_OK&quot;) refund += eqcost;
            else refund += eqcost/2; //half money if damaged
            player.ship.removeEquipment(k);
            if(f.length &gt; 0 &amp;&amp; fb.length &gt; 0) fcc = &quot;, &quot;;
            else if(fb.length &gt; 0) fcc = &quot; and &quot;;
            else if(f.length &gt; 0) f = &quot; and &quot;+f;
            fcc += &quot;Fighter Hangar&quot;;
        }
        var ais = &quot;&quot;;
        if( ai &gt; 0 ) {
                player.ship.manifest.alien_items += ai;
                ais=&quot; and &quot;+ai+&quot; Alien Items&quot;;
        }
        player.credits += refund;
        player.consoleMessage(refund+&quot; credits&quot;+ais+&quot; refunded for &quot;+fb+fcc+f, 10);
        this.$FightersOfPlayer = this._fighterEqsOf(player.ship); //should be 0
        this.$MaxFighters = this._maxFighters(player.ship);
    }

    if(equipmentKey === &quot;EQ_FIGHTERBAY&quot; 
        || equipmentKey === &quot;EQ_FIGHTERSUPPORT&quot;
        || equipmentKey === &quot;EQ_FIGHTERHANGAR&quot; ) {
        this.$MaxFighters = this._maxFighters(player.ship);
        player.consoleMessage(&quot;You can control &quot;+this.$MaxFighters+&quot; fighters from now&quot;, 10);
    }
    if(equipmentKey.indexOf(&quot;REFUND_EQ_FIGHTER_&quot;) == 0 ) {
        player.ship.removeEquipment(equipmentKey);
        var refund = 0;
        var k = equipmentKey.substring(7); //chop REFUND_ to get the eqkey of fighter
        if(player.ship.equipmentStatus(k) == &quot;EQUIPMENT_OK&quot;) {
            var eqcost = EquipmentInfo.infoForKey( k ).price/10;
            refund += eqcost;
            player.ship.removeEquipment(k);//remove fighter
            this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
            //if( this.$FightersOfPlayer &gt; 0 ) this.$FightersOfPlayer--;
            player.credits += refund;
            var ai = &quot;&quot;, a = this._alienItems(k);
            if( a &gt; 0 ) {
                player.ship.manifest.alien_items += a;
                ai = &quot; and &quot;+a+&quot; Alien Items&quot;;
            }
            var n = &quot;&quot;;
            if(equipmentKey.indexOf(&quot;REFUND_EQ_FIGHTER_I&quot;) == 0) n = &quot;n&quot;; //an Iron King
            player.consoleMessage(refund+&quot; credits&quot;+ai+&quot; refunded for a&quot;+n+&quot; &quot;
                +EquipmentInfo.infoForKey( k ).name, 10);
        }
    } else if(equipmentKey.indexOf(&quot;EQ_FIGHTER_&quot;) == 0 ) {
        //if there is a damaged then this event is called with the same eqkey at repair, must exclude!
        if( this._eqStats(player.ship, equipmentKey).dmg == 0 ) { //all ok
            var a = this._alienItems(equipmentKey);
            if( a &gt; 0 ) { //need some Alien Items to buy this fighter
                if(!(player.ship.manifest.alien_items &gt;= a)) {
                    player.ship.removeEquipment(equipmentKey);//remove fighter if not enough alien items
                    player.consoleMessage(&quot;You need &quot;+a+&quot; Alien Items to buy this fighter&quot;, 5);
                    return false;
                }
                player.ship.manifest.alien_items -= a;
            }
            this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
            //if( this.$FightersOfPlayer &lt; this.$MaxFighters ) this.$FightersOfPlayer++;
            var f = &quot;&quot;;
            if( this.$FightersOfPlayer &lt; this.$MaxFighters )
                f = &quot; of &quot;+this.$MaxFighters+&quot; fighters, buy again for more.&quot;;
            else f = &quot; fighters, this is the maximum.&quot;;
            player.consoleMessage(&quot;You have &quot;+this.$FightersOfPlayer+f, 5);
        } else { //handle repair
            if( equipmentKey.indexOf(&quot;EQ_FIGHTER_SWARM&quot;) == 0 ) {
                var ki = this.$FighterKeys.indexOf(&quot;EQ_FIGHTER_SWARM&quot;);
                if( this._eqStats(player.ship, equipmentKey).dmg == 1 ) {//exactly 1 damamged
                    if( player.ship.manifest.alien_items &gt;= 1 ) {
                        player.ship.manifest.alien_items -= 1;
                        player.consoleMessage(&quot;Repair of Swarm Fighter Group consumed an Alien Item&quot;, 10);
                    } else {
                        player.consoleMessage(&quot;Fixing need an Alien Item or 2 damaged groups&quot;, 10);
                        player.ship.removeEquipment(equipmentKey);//remove the gift awarded by the core
                        player.credits += this.$FighterCost[ki] / 2; //refund the cost, nothing happened
                        this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
                        return;
                    }
                } else { //make an ungamaged group from 2 damaged groups
                    player.consoleMessage(&quot;Two gappy Swarm Fighter Groups merged to a full group&quot;, 10);
                    player.credits += this.$FighterCost[ki] / 2; //give back the repair cost
                    if(player.ship.equipmentStatus(equipmentKey) == &quot;EQUIPMENT_OK&quot;) {
                        //there is an undamaged swarm fighter group
                        //so set a damaged group to ok due to the removeEq below will remove a good one
                        player.ship.setEquipmentStatus(equipmentKey, &quot;EQUIPMENT_OK&quot;);
                    }
                    player.ship.removeEquipment(equipmentKey);
                }
            }
            player.ship.removeEquipment(equipmentKey);//remove the gift awarded by the core
            player.ship.setEquipmentStatus(equipmentKey, &quot;EQUIPMENT_OK&quot;);//fix one fighter only
            this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
        }
    }
}

this.playerCancelledJumpCountdown = function() {  //stop landing
    if(!this._playerHasFighters(player.ship)) return;
    this.$ForcedLanding = false;
    this._fightersFollow();
}

this.playerJumpFailed = function(reason) {
    if(!this._playerHasFighters(player.ship)) return;
    this.$ForcedLanding = false;
    this._fightersFollow();
}

this.playerStartedJumpCountdown = function(type, seconds) { //landing fighters
    if(!this._playerHasFighters(player.ship)) return;
    this.$ForcedLanding = true;
    var out = this._fightersLanding();
    if( out &gt; 0 ) {
        var s = out+&quot; fighters&quot;;
        if( out == 1 ) s = &quot; a fighter&quot;;
        player.consoleMessage(&quot;Warning: &quot;+s+&quot; need landing!&quot;, 10);
        player.consoleMessage(&quot; &quot;, 10); //make room to the countdown
    }
}

this.playerWillSaveGame = function(message) {
    this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
    missionVariables.$FightersOfPlayerPlusOne = this.$FightersOfPlayer + 1;
}

this.shipAttackedOther = function(whom) {
    this._launchFighters(whom);
}

this.shipAttackedWithMissile = function(missile, whom) {
    this._launchFighters(whom);
}

this.shipBeingAttacked = function(whom) {
    this._launchFighters(whom);
}

this.shipWillExitWitchspace = function() {
    var lbf = this.$LeftBehindFighters;
    if( lbf &gt; 0 ) {
        var s = lbf+&quot; fighters&quot;;
        if( lbf == 1 ) s = &quot;a fighter&quot;;
        var msg = &quot;You left behind &quot;+s+&quot; in &quot;+this.$LeftBehindSystem;
        player.commsMessage(msg, 10);
        log(this.name, msg);
        this.$LeftBehindFighters = 0;
    }
}

this.shipFiredMissile = function(missile, target) {
    this._launchFighters(target);
}

// check when the player launches if this is a simulator run
this.shipLaunchedFromStation = function(station) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript

    if( !this._playerHasFighters(ship) ) return;

    var w = worldScripts[&quot;Combat Simulator&quot;];
    if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) this.$simulator = true;
    else this.$simulator = false;
}

this.shipTakingDamage = function(amount, whom, type) {
    this._launchFighters(whom);
}

this.shipTargetAcquired = function(t) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( ship == p ) {
        this._MFD(); //update if player, even if not use fighters
        if( !this._playerHasFighters(ship) ) return;
        this._reconsiderTargets(ship, t); //update targets of launched fighters
    }
}

this.shipTargetLost = function(t) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    if( ship == p ) {
        this._MFD(); //update if player, even if not use fighters
    }
}

this.shipWillDockWithStation = function(station) {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript

    // if this was a simulator run, reset the variable and return - no arrival report in this case
    if (this.$simulator == true) {
        this.$simulator = false;
    } else {
        if( ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) == &quot;EQUIPMENT_DAMAGED&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) == &quot;EQUIPMENT_DAMAGED&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) == &quot;EQUIPMENT_DAMAGED&quot; ) {
            var b = &quot;&quot;, l = &quot;&quot;;
            if( ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) == &quot;EQUIPMENT_DAMAGED&quot; ) {
                b = EquipmentInfo.infoForKey( &quot;EQ_FIGHTERBAY&quot; ).name;
                l = &quot; Without working &quot;+b+&quot; only light fighters can launch from your ship.&quot;;
            }
            if( ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) == &quot;EQUIPMENT_DAMAGED&quot; ) {
                if(b.length &gt; 0) b += &quot; and &quot;;
                b += EquipmentInfo.infoForKey( &quot;EQ_FIGHTERSUPPORT&quot; ).name;
            }
            if( ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) == &quot;EQUIPMENT_DAMAGED&quot; ) {
                if(b.length &gt; 0) b += &quot; and &quot;;
                b += EquipmentInfo.infoForKey( &quot;EQ_FIGHTERHANGAR&quot; ).name;
            }
            var s = &quot;&quot;; if( this.$FightersOfPlayer &gt; 1 ) s = &quot;s&quot;; //current fighters in plural
            player.addMessageToArrivalReport(expandDescription(&quot;[fighters-baydamaged]&quot;,
                {bay:b, fightersofplayer:this.$FightersOfPlayer,
                    plural:s, maxfighters:this.$MaxFighters, light:l}));
        }

        if( this._playerHasFighters(ship)
            || ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot; ) {
            var f = this.$Fighters;
            for(var i = 0; i &lt; f.length; i++) {
                var fi = f[i];
                if( !fi || !fi.isValid ) this.$FightersOfPlayer--; //reduce total with lost ones
                else {
                    this._awardFighter(fi, ship);
                    fi.remove(true); //do not leave fighters outside of the station
                }
            }
            this.$FightersOfPlayer = this._fighterEqsOf(player.ship);

            var d = this._damagedFighter(player.ship); //how many damaged fighters are on board
            var s2 = &quot;&quot;; if( this.$FightersOfPlayer &gt; 1 ) s2 = &quot;s&quot;; //current fighters in plural
            if( !d || !d[0] || d[0][0] === 0 ) { //no damaged fighters
                if( this.$FightersOfPlayer === this.$MaxFighters ) {
                    var s = &quot; is&quot;; if( this.$MaxFighters &gt; 1 ) s = &quot;s are&quot;; //fighters in plural
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-allfighters]&quot;,
                        {maxfighters:this.$MaxFighters, plural:s}));
                } else if( !station || !station.isValid || !station.hasShipyard ) {
                    //no shipyard, no replace
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-noshipyard]&quot;,
                        {fightersofplayer:this.$FightersOfPlayer, plural:s2,
                            maxfighters:this.$MaxFighters}));
                } else if( this.$FightersOfPlayer === 0 ) { //no fighters on board
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-emptybay]&quot;));
                } else { //less than maxFighters are on board
                    var s = &quot; is&quot;; if( this.$MaxFighters &gt; 1 ) s = &quot;s are&quot;; //fighters in plural
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-lessfighters]&quot;,
                        {fightersofplayer:this.$FightersOfPlayer, plural:s2,
                            maxfighters:this.$MaxFighters}));
                }
            } else { //there are damaged fighters
                var dm = d[0][0];//number of damaged fighters
                var dc = d[0][1];//credits needed for repair all damaged fighters
                var s = &quot;&quot;; if( dm &gt; 1 ) s = &quot;s&quot;; //damaged fighters in plural

                if( !station || !station.isValid || !station.hasShipyard ) {
                    //no shipyard, no repair
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-noshipyard]&quot;,
                        {fightersofplayer:this.$FightersOfPlayer, plural:s2,
                            maxfighters:this.$MaxFighters}));
                } else if( player.credits &lt; dc ) { //not enough money for all repairs
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-notenoughmoney]&quot;,
                        {damagedfighters:dm, plural:s}));
                } else if( !this.$AutoRepair ) { //repair disabled
                    player.addMessageToArrivalReport(expandDescription(&quot;[fighters-damaged]&quot;,
                        {damagedfighters:dm, plural:s}));
                } else { //repair damaged fighters
                    var dc2 = 0; //must count again to exclude cost of damaged swarm groups
                    var dm2 = 0; //must count again to exclude number of damaged swarm groups
                    for(var i = 1; d[i]; i++) {
                        var k = d[i][0];
                        if( k &amp;&amp; k.indexOf(&quot;EQ_FIGHTER_SWARM&quot;) == 0 ) {
                            continue; //do not repair swarm groups
                        }
                        for(var j = 0; j &lt; d[i][1]; j++) {
                            player.ship.setEquipmentStatus(k, &quot;EQUIPMENT_OK&quot;);
                            player.credits -= d[i][2];
                            dc2 += d[i][2];
                            dm2++;
                            log(this.name, &quot;Repair of &quot;+k+&quot; cost &quot;+d[i][2]+&quot; credits&quot;);
                        }
                    }
                    if( dm2 === 0 ) { //only swarm damages without repair
                        player.addMessageToArrivalReport(expandDescription(&quot;[fighters-damaged]&quot;,
                                {damagedfighters:dm, plural:s}));
                    } else { //repaired fighters
                        s = &quot;&quot;; if( dm2 &gt; 1 ) s = &quot;s&quot;; //damaged fighters in plural
                        player.addMessageToArrivalReport(expandDescription(&quot;[fighters-repaired]&quot;,
                            {cost:dc2, repaired:dm2, plural:s,
                                fightersofplayer:this.$FightersOfPlayer, plural2:s2,
                                maxfighters:this.$MaxFighters}));
                    }
                }
            }
        }
    }

    //free up arrays both in NPC ship scripts and player&#39;s array in worldScript
    delete this.$Fighters;
    delete this.$Targets;
    this.$Fighters = [];
    this.$Targets = [];
    this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar

}

this.shipWillEnterWitchspace = function() {
    var p = player.ship;
    var ship = this.ship;
    if( !ship ) ship = p; //called in worldScript
    this.$ForcedLanding = false;

    if( this._playerHasFighters(ship) ) {
        var bay = false;
        //Fighter Bays help to do not lose fighters which see the wormhole in its scanner
        if( ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
            || ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot; )
            bay = true;
        this.$LeftBehindFighters = 0; //will be displayed in shipExitedWormhole event
        this.$LeftBehindSystem = system.name;
        var f = this.$Fighters;
        for(var i = 0; i &lt; f.length; i++) {
            var fi = f[i];
            if( !fi || !fi.isValid ) this.$FightersOfPlayer--; //reduce total with lost ones
            else if( fi.script &amp;&amp; fi.script.$TimerLandNow ) {
                this.$TimerLandNow.stop();
                delete this.$TimerLandNow;
                fi.script._landNow(fi, ship); //use the last moment to land before left behind
            } else if( bay &amp;&amp; fi.position.distanceTo(ship.position) &lt; fi.scannerRange ) {
                //using the fighter&#39;s (and not mother&#39;s) scannerRange for King&#39;s 50km scanner
                fi.script._landNow(fi, ship); //Fighter bay help land fighters
            } else {
                this.$FightersOfPlayer--; //reduce total with left behind ones
                this.$LeftBehindFighters++; //increase left behind fighters
            }
        }
        //log(this.name,&quot;Left behind &quot;+this.$LeftBehindFighters+&quot; fighters in &quot;+this.$LeftBehindSystem);

        this.$FightersOfPlayer = this._fighterEqsOf(player.ship);
        delete this.$Fighters;
        delete this.$Targets;
        this.$Fighters = [];
        this.$Targets = [];
        this.$LaunchedFighters = 0;  //how many fighters launched from the internal hangar
    }
}

this.shipWillLaunchFromStation = function(station) {
    this.$ForcedLanding = false;
    this._MFD(); //show mfd as early as other MFDs
}


//local functions

this._alienItems = function(k) { //how many alien items needed to buy this fighter equipment
    if( !k || !(k.length &gt; 0)) return(0); //for sure
    var a = 0;
    if( k.indexOf(&quot;EQ_FIGHTER_SWARM&quot;) == 0 ) a = 3;
    if( k.indexOf(&quot;EQ_FIGHTER_SHARK&quot;) == 0 ) a = 5;
    if( k.indexOf(&quot;EQ_FIGHTER_KING&quot;) == 0 ) a = 10;
    return(a);
}

this._awardFighter = function(ship, owner) { //put back into the owner&#39;s equipment list when landed
    if(ship &amp;&amp; owner &amp;&amp; owner.isValid) { //must not require ship.isValid!
        var sc = ship.script;
        if( sc &amp;&amp; sc.$FighterKey ) {
            var damaged = false;
            if( sc.$FighterKey == &quot;EQ_FIGHTER_SWARM&quot; ) {
                //for Swarm only - do not set King fighter to damaged when a subent is lost
                if(!ship.subEntities || ship.subEntities.length &lt; ship.subEntityCapacity ) {
                    if( this._eqStats(owner, sc.$FighterKey).dmg &gt; 0 ) {
                        //there is a damamged group on board so fix that instead of award eq
                        owner.setEquipmentStatus(sc.$FighterKey, &quot;EQUIPMENT_OK&quot;);
                        if( owner === player.ship )
                            player.consoleMessage(&quot;Damaged Swarm Fighter Groups are merged&quot;, 4.5);
                        return; //used up to fix another damaged group, so prevent award it
                    } else damaged = true; //at least one ship is lost from the group
                }
            } else if( sc.$FighterShields ) { //heavy fighters, including King
                var eq = ship.equipment; 
                var i=-1;
                if(eq) while(eq[++i]) {
                    if(ship.equipmentStatus(eq[i].equipmentKey) == &quot;EQUIPMENT_DAMAGED&quot;) {
                        damaged = true; //if an equipment like ECM is damaged in shielded fighters
                        break;          //then set the fighter eq in owner to damaged
                    }
                }
            } else { //if no shields nor swarm fighter group then check hull damage
                if( sc.$FighterHull &lt; ship.maxEnergy * 0.4 ) //damaged
                    damaged = true;
            }
            owner.awardEquipment(sc.$FighterKey);
            if(damaged) owner.setEquipmentStatus(sc.$FighterKey, &quot;EQUIPMENT_DAMAGED&quot;);
        }
    }
}

this._damagedFighter = function(owner) { //how many damaged fighters are on board
    var damaged = [];
    damaged[0] = [0,0];//damaged fighters and needed credits for repair
    if(owner &amp;&amp; owner.isValid) {
        for(var i = 0; i &lt; this.$FighterKeys.length; i++) {
            var k = this.$FighterKeys[i];
            var d = this._eqStats(owner, k).dmg;
            if(d &gt; 0) {
                damaged[0][0] += d;
                var c = this.$FighterCost[i]/2; //fixing cost of a fighter
                damaged[0][1] += c;
                damaged.push([k, d, c]); //key, damaged fighters and needed credits
            }
        }
    }
    if(damaged[0][0] &gt; 0) return(damaged);
    else return(false);
}

this._eqStats = function(ship, eqKey) { //count damaged and ok eqs
    var ret = {ok:0, dmg:0};
    if(!ship || !ship.isValid
        || ship.equipmentStatus(eqKey) != &quot;EQUIPMENT_DAMAGED&quot;
            &amp;&amp; ship.equipmentStatus(eqKey) != &quot;EQUIPMENT_OK&quot;) 
        return(ret); //for sure
    if (0 &lt; oolite.compareVersion(&quot;1.81&quot;)) { //for Oolite v1.80
        var e = ship.equipment;
        var len = e.length;
        if(e) for(var i=0; i &lt; len; i++) {
            if(e[i] &amp;&amp; e[i].equipmentKey === eqKey) {
                var s = ship.equipmentStatus(eqKey);//report the best status
                if( s === &quot;EQUIPMENT_OK&quot; ) {
                    ret.ok++;
                    ship.removeEquipment(eqKey); //must remove to uncover damaged ones
                    e = ship.equipment; //reread the shorter equipment array
                    i--; //check again this item due to the remove it was the next
                    len = e.length; //the equipment array is shorter due to the remove
                } else if( s === &quot;EQUIPMENT_DAMAGED&quot; ) {
                    ret.dmg++;
                }
            }
        }
        for(var i=0; i &lt; ret.ok; i++) { //award back the removed ok ones
            ship.awardEquipment(eqKey);
        }
    } else { //from Oolite v1.81
        ret.ok = ship.equipmentStatus(eqKey, true).EQUIPMENT_OK;
        ret.dmg = ship.equipmentStatus(eqKey, true).EQUIPMENT_DAMAGED;
    }
    return(ret);
}

this._fightersAIState = function(state, stoplanding) { //set AI state of fighters to one defined in plist
    var p = player.ship; //AI is not applicable on player, must check to prevent error in log
    var f = this.$Fighters;
    var out = 0;
    for(var i = 0; i &lt; f.length ; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid &amp;&amp; fi != p ) {
            var fai = &quot;fightersAI.plist&quot;;
            if(fi.AI != fai ) fi.switchAI(fai);
            fi.target = null; //clear target to stop attack

            if( fi.script &amp;&amp; fi.script.$ForcedLanding ) {
                fi.AIState = &quot;LANDING&quot;;
            } else if( !stoplanding || fi.AIState == &quot;LANDING&quot; ) {
                fi.AIState = state; //FOLLOW or LANDING
            }
            out++;
        }
    }
    if( out &gt; 0 ) this._MFD(); //refresh
    return(out); //report how many fighters affected
}

this._fightersFollow = function() { //set AI of all valid fighters to follow
    return(this._fightersAIState(&quot;FOLLOW&quot;));
}

this._fightersLanding = function() { //start landing
    return(this._fightersAIState(&quot;LANDING&quot;));
}

this._fightersStopLanding = function() { //stop landing only, others untouched
    return(this._fightersAIState(&quot;FOLLOW&quot;, true));
}

this._fighterEqsOf = function(ship) { //count all equipments represents fighters on the given ship
    var e, f = 0, k;
    for(var i = 0; i &lt; this.$FighterKeys.length; i++) {
        k = this.$FighterKeys[i];
        e = this._eqStats(ship, k);
        f += e.dmg;
        f += e.ok;
    }
    return(f);
}

this._isNewTargetOrNeedMoreFighters_unused = function(ship, target) { 
    //deprecated, unused function
    if( !target || !target.isValid ) return false;
    //count nearby escorting fighters
    var ships = ship.checkScanner(true);
    //max. 32 ships are returned so this way allow to launch more than the limit if really needed
    //due to some escorts will not be in the returned 32 so leave space to launch another
    var escorts = 0;
    for( var i = 0; i &lt; ships.length; i++ ) {
        var nearbyship = ships[i];
        if( nearbyship &amp;&amp; nearbyship.isValid ) {
            if( this.$Fighters.indexOf(nearbyship) &gt; -1 ) {
                escorts++;
                if( escorts &gt; 24 ) return false; //there are enough fighters nearby
            } else {
                if( ship.escortGroup.containsShip(nearbyship) )
                    ship.escortGroup.removeShip(nearbyship); //make room for sure
            }
        }
    }
    return true; //too few fighters escorting so launch more
}

this._isNewTargetOrNeedMoreFighters_old = function(ship, target) {
    //deprecated function, unused due to can not provide proper limit of launched fighters
    minTargeters = 3; //how many active fighters must keep target lock to avoid additional launch
    if( !target || !target.isValid || target.script &amp;&amp; target.script.$FighterOwner == ship ) return false;
    if( this.$Targets[target.entityPersonality] != target ) {
        this.$Targets[target.entityPersonality] = target;
        return true; //new target, launch a fighter group
    }
    var targeters = 0; //how many active fighters has target lock on this attacker
    var f = this.$Fighters;
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid &amp;&amp; fi.target == target ) {
            targeters++;
            if( targeters &gt;= minTargeters ) return false; //there are enough fighters on this target
        }
    }
    return true; //too few fighters follow this target so launch more
}

this._isStation = function(entity) {
    return this._isStation2(entity, player.ship);
}

this._isStation2 = function(entity, ship) {
    return (entity &amp;&amp; entity.isValid &amp;&amp; entity.isStation
        &amp;&amp; entity.target != ship
        &amp;&amp; entity.dataKey.indexOf(&quot;carrier&quot;) == -1 );
}

this._isValidFighterTarget = function(target, owner) {
    if( target &amp;&amp; target.isValid &amp;&amp; !target.isDerelict
        //check hasHostileTarget but this is never set for player
        &amp;&amp; ( target.hasHostileTarget || target == player.ship )
        &amp;&amp; ( !owner || !owner.isValid || //next conditions need valid owner
            target != owner  //do not target its own mothership
            //do not target friendly figters
            &amp;&amp; ( !target.script || target.script.$FighterOwner != owner )
            //distance from owner is not too much
            &amp;&amp; target.position.distanceTo(owner.position) &lt; owner.scannerRange
            ) ) {
        return(target); //valid target for fighters
    } else return(false);
}

this._launchFighters = function(target, forced) {
    var ship = this.ship;
    if( !ship ) ship = player.ship; //called in worldScript
    if( !target || !target.isValid || target.isDerelict || target === ship //for sure
        || ship === player.ship &amp;&amp; !this._playerHasFighters(ship)) return;
    //continue if NPC or player use fighters

    if( !forced &amp;&amp; !this._isValidFighterTarget(target, ship) ) //forced mean launch without valid target
        return;//skip invalids like own fighters
    this.$LastForced = forced;//for timed launches in red alert

    if(target) {
        if(target.maxSpeed &gt; 0) //exclude stations but include mobile dockables
            ship.addDefenseTarget(target); //turrets and thargoid lasers will fire
        this._reconsiderTargets(ship, target); //update targets of launched fighters
    }

    if( !this.$LaunchInProgress &amp;&amp; this.$LaunchedFighters &lt; this.$MaxFighters
        &amp;&amp; ( ship != player.ship || this.$LaunchedFighters &lt; this.$FightersOfPlayer
             &amp;&amp; ( forced || !ship.withinStationAegis || player.alertCondition === 3 ) ) ) {
        //launch more fighters, must place far below the owner to avoid kill by collision at injector speed

        var scoop = true, bay = true;
        if( ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) != &quot;EQUIPMENT_OK&quot;
            &amp;&amp; ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) != &quot;EQUIPMENT_OK&quot;
            &amp;&amp; ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) != &quot;EQUIPMENT_OK&quot; )
            bay = false;
        if( !bay &amp;&amp; ship.equipmentStatus(&quot;EQ_FUEL_SCOOPS&quot;) != &quot;EQUIPMENT_OK&quot;
            &amp;&amp; ship.equipmentStatus(&quot;EQ_CARGO_SCOOPS&quot;) != &quot;EQUIPMENT_OK&quot; )
            scoop = false;

        var heavy, key, ships;
        var pos = ship.position.add(ship.vectorUp.multiply( -ship.collisionRadius ));
        for(var i = this.$FighterKeys.length-1; i &gt;= 0; i--) { //launch heavy fighters first
            key = this.$FighterKeys[i];
            var eqst = ship.equipmentStatus(key);
            if( eqst === &quot;EQUIPMENT_OK&quot; ) { //prevent launch of damaged fighters
                if( EquipmentInfo.infoForKey( key ).requiredCargoSpace &gt;= 10 ) { //heavy
                    if( !bay ) continue; //will not launch heavy fighters without undamaged fighter bay
                    else heavy = true; //from 10t it is a heavy fighter, will get ECM
                } else {
                    if( !scoop ) continue; //will not launch light fighters without scoop or fighter bay
                    else heavy = false; //below 10t it is a light fighter
                }
                ships = system.addShips(key, 1, pos, 0); //eq key must be in roles in shipdata.plist
                if(ships &amp;&amp; ships[0]) break;
            }
        }

        var name = &quot;Fighter&quot;;
        var oldlf = this.$LaunchedFighters;
        if(ships &amp;&amp; ships[0]) for(var i = 0; i &lt; ships.length; i++) {
            var si = ships[i];
            if(si) {
                ship.removeEquipment(key); //reduce fighter number in F5 screen
                this.$Fighters.push(si);
                this.$LaunchedFighters++;
                this.$LaunchInProgress = true;
                if(target) {
                    this.$LastTarget = target;
                    si.target = target;
                    si.addDefenseTarget(target);
                }
                si.displayName = si.name+&quot; #&quot;+this.$LaunchedFighters;
                name = si.name;
                if(!si.script) si.script = &quot;fighters-ship.js&quot;; //for sure
                if(si.script) {
                    si.script.$FighterKey = key;
                    si.script.$FighterNumber = this.$LaunchedFighters;
                    si.script.$FighterOwner = ship; //prevent fighters targeting each other
                    si.script.$TrailsDisabled = 1; //reduce load with Trails OXP
                }
                ship.escortGroup.addShip(si);
                //if(si.AI == &quot;escortAI.plist&quot;) si.AIState = &quot;NEXT_TARGET&quot;;
                si.velocity = ship.velocity.add(ship.vectorForward.multiply(500)); //initial push
                //horizontal line formation with 50m space between ships at -75, -25, 25 and 75m
                //si.position = pos.add(ship.vectorRight.multiply(50*(i-(ships.length-1)/2)));
                si.orientation = ship.orientation;
                if(key != &quot;EQ_FIGHTER_SWARM&quot;) si.awardEquipment(&quot;EQ_ESCAPE_POD&quot;); //swarm is unpiloted
                if(heavy) {
                    si.awardEquipment(&quot;EQ_ECM&quot;);
                    si.awardEquipment(&quot;EQ_HEAT_SHIELD&quot;);
                }
                si.performAttack();
                if( ship == player.ship ) {
                    si.bounty = 0; //remove bounty from fighter given in shipdata.plist
                    si.scannerDisplayColor1 = [0, 0.4, 0]; //green, mean frendly
                    //si.scannerDisplayColor2 = [0, 0.4, 0]; //green, mean frendly
                } else {
                    if( ship.bounty == 0 ) si.bounty = 0; //remove bounty from fighter given in shipdata.plist
                    si.displayName += &quot; of &quot;+ship.name; //not owned by the player
                }
            }
        }
        if( this.$LaunchInProgress &amp;&amp; !this.$TimerDelay ) {//disable future launches until delay
            this.$TimerDelay = new Timer(this, this._TimedDelay.bind(this), this.$LaunchDelay, this.$LaunchDelay);
        }
        if( ship === player.ship &amp;&amp; this.$LaunchedFighters &gt; oldlf ) {
            var newf = this.$LaunchedFighters - oldlf;
            var remain = this.$FightersOfPlayer - this.$LaunchedFighters;
            var t = &quot;&quot;;
            if(target) t = &quot; to &quot;+target.name;
            player.consoleMessage(name+&quot; launched&quot;+t, 4.5);
        }
    }
}

this._mass = function(mass) { //format ship mass to display it in MFD
    if(mass &gt; 0) {
        if(mass &gt; 1000000000) return(Math.floor(mass/1000000000)+&quot;Mt&quot;);
        if(mass &gt; 1000000) return(Math.floor(mass/1000000)+&quot;kt&quot;);
        return(Math.ceil(mass/1000)+&quot;t&quot;); //ceil needed by EscortDeck and ships under 1t
    } else return(&quot;&quot;);
}

this._maxFighters = function(ship) {
    var m = this.$MaxFightersIfNoBay; //base value
    if( ship.equipmentStatus(&quot;EQ_FIGHTERHANGAR&quot;) == &quot;EQUIPMENT_OK&quot; ) m = 80; //in equipment.plist also
    else if( ship.equipmentStatus(&quot;EQ_FIGHTERSUPPORT&quot;) == &quot;EQUIPMENT_OK&quot; ) m = 40; //in equipment.plist also
    else if( ship.equipmentStatus(&quot;EQ_FIGHTERBAY&quot;) == &quot;EQUIPMENT_OK&quot; ) m = 16; //in equipment.plist also
    return(m);
}

this._nameWithMass = function(t) {  //format ship name and mass to display it in MFD
    if( !t || !t.isValid ) return(&quot;&quot;);
    return( t.displayName + &quot; (&quot; + this._mass(t.mass)+&quot;)&quot; );
}

this._playerHasFighters = function(ship) { //check if this ship is a player ship and hold at least one fighter
    if( ship &amp;&amp; ship.isValid &amp;&amp; ship == player.ship ) {
        if( this.$FightersOfPlayer &gt; 0 ) return true;
    }
    return false;
}

this._reconsiderTargets = function(owner, target) { //all fighters pick targets
    target = this._isValidFighterTarget(target, owner);
    var f = this.$Fighters;
    var invalidfighters = 0;
    var oldtargetistargetofowner = 0; //how many fighters attacked the owner&#39;s target before reconsider
    var ownertarget;
    if( owner ) {
        if( owner == player.ship &amp;&amp; player.alertCondition == 1 ) { //green alert
            this.alertConditionChanged(1, 1); //keep up landing, do not target anything
            this._MFD(); //update if owner is the player
            return;
        }
        ownertarget = this._isValidFighterTarget(owner.target, owner);
    }

    var firedist = this.$FireDist; //fighters accept new target within this distance
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid ) {
            var oldtarget = fi.target; //call performAttack at the end if change

            if( !owner &amp;&amp; fi.script ) {
                owner = fi.script.$FighterOwner; //for sure
                if( owner ) ownertarget = this._isValidFighterTarget(owner.target, owner);
            }
            if( owner &amp;&amp; owner.isValid ) {
                if( fi.target &amp;&amp; fi.target.isValid &amp;&amp; fi.target == ownertarget ) {
                    oldtargetistargetofowner++;
                }
                //forget current target?
                if( fi.position.distanceTo(owner.position) &gt; 20000 //go back to owner
                    || !this._isValidFighterTarget(fi.target, owner) ) {
                    fi.target = null;
                }
            }

            //if no target then aim the nearest defensive target?
            var mindist = fi.scannerRange;
            if( owner &amp;&amp; owner.isValid &amp;&amp; ( !fi.target || !fi.target.isValid ) ) {
                var d = owner.defenseTargets;
                if( d &amp;&amp; d.length &gt; 0 ) {
                    var dmin = -1; //index of nearest defensive target
                    for(var j = 0; j &lt; d.length; j++) {
                        var dj = d[j]; //need valid non-stationary target
                        if( this._isValidFighterTarget(dj, owner) &amp;&amp; dj.maxSpeed &gt; 0 ) {
                            var df = dj.position.distanceTo(fi.position);
                            if( df &lt; mindist ) {
                                mindist = df; //nearest to this fighter
                                dmin = j;
                            }
                        }
                    }
                    if( dmin &gt; -1 ) {
                        fi.target = d[dmin];
                        fi.addDefenseTarget(d[dmin]);
                    }
                }
            }

            //if still no target or owner&#39;s tagret is nearer and within firedist then aim it
            if( ownertarget &amp;&amp; ownertarget != fi.target &amp;&amp; ownertarget != fi ) {
                //only the half of fighters attack the mother&#39;s target - removed
                //&amp;&amp; ( i - invalidfighters ) * 2 &lt; f.length - invalidfighters
                var aim = false;
                if( !fi.target || !fi.target.isValid ) aim = true;
                else {
                    var otd = ownertarget.position.distanceTo(fi.position);
                    if( otd &lt; firedist &amp;&amp; otd &lt; mindist ) {
                        fi.target = ownertarget; //attack the mother&#39;s target (except friends)
                        fi.addDefenseTarget(ownertarget);
                    }
                }
            }

            //only the half of fighters attack the mother&#39;s target - removed
            //if( fi.target &amp;&amp; fi.target.isValid &amp;&amp; fi.target == ownertarget ) {
            //    if( oldtargetistargetofowner*2 &gt; f.length - invalidfighters
            //        &amp;&amp; target &amp;&amp; target.isValid ) {
            //        fi.target = null;
            //    }
            //}


            //aim the new target?
            if( target &amp;&amp; target != fi &amp;&amp; target != fi.target ) {
                var aim = false;
                if( !fi.target || !fi.target.isValid ) aim = true;
                else {
                    var ftd = fi.target.position.distanceTo(fi.position);
                    var td = target.position.distanceTo(fi.position);
                    //replace any target if the given new target is more than 5km nearer
                    if( ftd - 5000 &gt; td ) aim = true;
                    //also if new target is within Pulse Laser range and old is almost outside
                    else if( ftd &lt; firedist &amp;&amp; td &gt; firedist ) aim = true;
                }
                if( aim ) {
                    fi.target = target; //lock on the newest aggressor
                    fi.addDefenseTarget(target);
                }
            }

            if(fi.target) { //attack the target
                if(fi.AI == &quot;fightersAI.plist&quot; ) fi.setAI(&quot;interceptAI.plist&quot;);
                if(fi.target != oldtarget) fi.performAttack();
            } else { //follow the owner at last resort
                if( fi.AI == &quot;interceptAI.plist&quot; ) fi.exitAI(); //step back to fighterAI
                if( fi.AI == &quot;fightersAI.plist&quot; &amp;&amp; fi.AIState != &quot;LANDING&quot; ) fi.AIState = &quot;FOLLOW&quot;;
            }
        } else invalidfighters++; //count lost fighters to exclude from total when calculate half of group
    }
    if( owner &amp;&amp; owner == player.ship ) { //tell the result of reconsider to the player
        if( owner.target &amp;&amp; owner.target.isValid ) {
            //count how many fighters target the same ship than owner
            var currenttargetistargetofowner = 0;
            for(var i = 0; i &lt; f.length; i++) {
                var fi = f[i];
                if( fi &amp;&amp; fi.isValid &amp;&amp; fi.target == owner.target) {
                    currenttargetistargetofowner++;
                }
            }
            if( currenttargetistargetofowner &gt; 0
                &amp;&amp; currenttargetistargetofowner != oldtargetistargetofowner ) {
                var s = &quot;&quot;;
                if( currenttargetistargetofowner &gt; 1 ) s = &quot;s&quot;;
                player.consoleMessage( currenttargetistargetofowner
                    +&quot; fighter&quot;+s+&quot; aim &quot;+owner.target.name, 3 );
            }
        }
        this._MFD(); //update if owner is the player
    }
}


this._FCB = function( delta ) { //FrameCallBack for sniperlock of Kings and Sharks
    var f = this.$Fighters;
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid &amp;&amp; fi.target &amp;&amp; fi.target.isValid
            &amp;&amp; fi.script &amp;&amp; fi.script.$SniperLock &amp;&amp; fi.AIState != &quot;LANDING&quot;
            &amp;&amp; fi.AIState != &quot;FLEE&quot; &amp;&amp; fi.AIState != &quot;FLEE_FOR_CLOAKED&quot;
            &amp;&amp; fi.AI != &quot;fleeQMineAI.plist&quot; &amp;&amp; fi.energy &gt; fi.maxEnergy/2
            &amp;&amp; fi.target.position.distanceTo(fi.position) &lt; 6000 ) { //exclude far targets
            var v = fi.target.position.subtract( fi.position ).direction();
            var angle = fi.heading.angleTo(v);
            var r = Math.min(fi.maxPitch*delta, angle);//rotation speed is limited by maxPitch
            var c = fi.heading.cross(v).direction(); //set the plane where we should rotate in
            fi.orientation = fi.orientation.rotate( c, -r );
            //log(this.name, fi.displayName+&quot; rotated by &quot;+r);
        }
    }
}

this._MFD = function() { //update Fighters MFD
    var p = player.ship; if( !p || !p.isValid ) return;

    var f = this.$Fighters;
    var t = []; //targets
    var n = []; //number of fighters on each targets
    var free = 0; //fighters without target
    var lost = 0; //lost fighters since last dock
    for(var i = 0; i &lt; f.length; i++) {
        var fi = f[i];
        if( fi &amp;&amp; fi.isValid ) {
            if( fi.target &amp;&amp; fi.target.isValid
                //&amp;&amp; fi.target.position.distanceTo(p.position) &lt; 25600 //exclude far targets
                ) {
                var j = t.indexOf(fi.target);
                if( j == -1 ) {
                    j = t.length;
                    t.push(fi.target);
                }
                if( n[j] &gt; 0 ) n[j]++; //one more fighter lock on this target
                else n[j] = 1; //this is the first fighter who lock on this target
            } else free++; //no target
        } else lost++; //launched but destroyed
    }

    var mfd = &quot;Fighters: &quot;;
    if( free &gt; 0 ) mfd += free+&quot; free, &quot;;
    var stay = this.$FightersOfPlayer - this.$LaunchedFighters;
    var d = this._damagedFighter(p);
    if( d ) {
        mfd += (stay-d[0][0])+&quot;+&quot;+d[0][0]; //damaged ones after +
    } else if( this.$FightersOfPlayer &gt; 0 ) {
        mfd += stay;
        //if(this.$LaunchedFighters == 0) mfd += &quot; stay&quot;;
    } else mfd += &quot;no one&quot;;  // none on Cobra Mark III
    mfd += &quot; in hangar&quot;;//+p.name;
    if( lost &gt; 0 ) mfd += &quot;, &quot;+lost+&quot; lost&quot;;
    mfd += &quot;\n&quot;;

    var pti = -1; //player target&#39;s index in t array
    var pt = p.target;
    if( pt &amp;&amp; pt.isValid &amp;&amp; (!pt.script || pt.script.$FighterOwner != p) ) {
        pti = t.indexOf(pt);
        var ptn = &quot;None&quot;;
        if( pti &gt; -1 ) ptn = n[pti];
        var ne = &quot;&quot;;
        if( pt.isDerelict ) ne = &quot;derelict &quot;;
        else if( !pt.hasHostileTarget ) ne = &quot;neutral &quot;;
        mfd += ptn+&quot; aim your &quot;+ne+&quot;target &quot;+this._nameWithMass(pt)+&quot;\n&quot;;
    }

    var max = 9;  //max. 9 lines left for targets in MFD
    for(var i = 0; i &lt; t.length &amp;&amp; i &lt; max; i++) {
        if( i != pti ) { //exclude player&#39;s target due to already displayed as first target
            mfd += n[i]+&quot; aim &quot;+this._nameWithMass(t[i])+&quot;\n&quot;;
        }
    }
    //while( i++ &lt; max) mfd += &quot;\n&quot;; //scroll down to the last line

    if( p.setMultiFunctionText ) p.setMultiFunctionText(this.$MFDName, mfd, true);
}

this._MFDAlign = function(left, right) { //insert as many spaces between as fill the line
        var width = 14.2;
        var space = &quot; &quot;;
        left += space;
        var t = left + right;
        while( defaultFont.measureString(t) &lt; width ) {
                left += space;
                t = left + right;
        }
        //fine tune with hair spaces - from spara&#39;s marketObserver
        var hairSpace = String.fromCharCode(31);
        while ( defaultFont.measureString(t + hairSpace) &lt; width ) {
                left += hairSpace;
                t = left + right;
        }
        return(t);
}

this._MFDFrom = function(whomposition) { //direction mark
        var ship = player.ship;
        if( !ship || !ship.isValid || !whomposition || !whomposition.dot ) return (&quot;&quot;);
        var v = ship.position.subtract(whomposition);
        var fw = ship.vectorForward.angleTo(v);
        var ri = ship.vectorRight.angleTo(v);
        var up = ship.vectorUp.angleTo(v);
        var s = &quot;&quot;; // refine if out of front 1 degree cone
        if( ri &lt; 1.56 ) s += &quot;&lt;&quot;;
        if( up &gt; 1.58 ) s += &quot;^&quot;;
        else if( up &lt; 1.56 ) s += &quot;v&quot;;
        if( ri &gt; 1.58 ) s += &quot;&gt;&quot;;
        return( s );
}

this._TimedDelay = function() {
        this.$LaunchInProgress = false; //enable fighter launch again
        var p = player.ship;
        var ship = this.ship;
        if( !ship ) ship = p; //called in worldScript
        if( ship == p &amp;&amp; //player in red alert of forced launch
            ( this.$LastForced || player.alertCondition == 3 &amp;&amp; player.alertHostiles )
            || ship.target &amp;&amp; ship.target.hasHostileTarget ) {//NPC in attack mode
            this._launchFighters(this.$LastTarget, this.$LastForced); //launch next fighter
        } else {
            this.$LastTarget = null;
            if( this.$TimerDelay ) {
                this.$TimerDelay.stop();
                delete this.$TimerDelay;
            }
        }
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
