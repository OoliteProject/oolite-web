<html>
    <head>
        <title>Expansion SellAll</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion SellAll</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Sell all cargo in Interfaces and can sell to an alternative cutomer if the market is full.</td>
                    <td>Sell all cargo in Interfaces and can sell to an alternative cutomer if the market is full.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.SellAll</td>
                    <td>oolite.oxp.Norby.SellAll</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>SellAll</td>
                    <td>SellAll</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.29</td>
                    <td>1.29</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/SellAll_OXP">http://wiki.alioth.net/index.php/SellAll_OXP</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/33/SellAll_1.29.oxz">https://wiki.alioth.net/img_auth.php/3/33/SellAll_1.29.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4.0</td>
                    <td>CC BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873264</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/SellAll'>http://wiki.alioth.net/index.php/SellAll</a></p>
        <h3>SellAll readme.txt</h3>
        <pre>Sell All OXP

You can sell all of your cargo under the &quot;Sell all cargo or find an alternative customer&quot; item in Interfaces (F4) screen.

The market capacity usually limited to 127t for each cargo type. If you have more from something than the current free space in the current station then you will find an Alternative Customer here who can buy your unsellable cargo, but pay very low prices only (below the half), less if you want to sell more.
Moreover sometimes you get conned or a few bounty to your head, more if you sell more.

In stations with custom markets will buy all of your cargo instead of the excess only due to calculating the exact market limits are complicated since Oolite 1.81. You still can sell what you can in the F8 screen then look into the interfaces when you have unsellable cargo to sell the excess only.


If you prefer the original limited markets only then change the $SellAllLimit variable to true and your chance for a customer will be reduced to zero.

Can not sell custom cargo types added by OXPs.
Incompatible with Commodity Markets OXP, suggested to use MarketObserver OXP with the included mO-Commodity_Markets to get similar different buy and sell prices.


Dependencies:
Oolite v1.77 or later.
BGS OXP from http://wiki.alioth.net/index.php/BGS if you want to see nice background on the Alternative Customer screen.
MarketObserver OXP if you use custom HUD to fix possible misplaced market messages.

Instructions:
Unzip the file, and then move the folder named &quot;.oxp&quot; into the AddOns directory of your Oolite installation.
Hold down the Shift key when you start the game first time until the splash screen appear.

License:
This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.

Changelog:
 2015.10.18. v1.29 Fixed for Kiota stations.
 2015.10.05. v1.28 Fixed for stations with custom markets since Oolite 1.81.
 2015.10.05. v1.27 A fix for Rock Hermits, thanks to diagoras.
 2015.09.15. v1.26 Compatible with Smugglers OXP.
 2015.08.10. v1.25 The &quot;Sell all&quot; function moved into the Interfaces for Oolite 1.82.
 2013.09.07. v1.24 Better messages, thanks Cody!
 2013.09.06. v1.23 Warning sound when you must watch your back.
 2013.09.06. v1.22 Get conned or bounty when sold alternatively (thanks for the ideas to Cody and Smivs).
 2013.09.05. v1.21 Compatibility fix for mO-Commodity_Markets.
 2013.09.04. v1.2  Alternative Customer added.
                   Compatible with AI Trading Assistant OXP.
 2013.09.04. v1.1  Profit displayed with MarketObserver OXP.
                   Markets limitable to 127t with $SellAllLimit127t.
                   Sell sound added.
 2013.09.04. v1.0  First version to satisfy the request in this topic: http://aegidian.org/bb/viewtopic.php?f=2&amp;t=15317
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/sellall.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;sellall&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;Sell all cargo with one keypress, sometimes over 127t also for less than half price.&quot;;

//customizable properties
this.$SellAllHowManyF8 = 1; //How many additional F8 keypress initiate sell all in the market screen, minimum 1.
this.$SellAllLimit = false; //can limit markets to the original capacity

//internal properties, should not touch
this.$SellAllCargoTypes = [&quot;food&quot;, &quot;textiles&quot;, &quot;radioactives&quot;, &quot;slaves&quot;, &quot;liquor_wines&quot;, &quot;luxuries&quot;,
	&quot;narcotics&quot;, &quot;computers&quot;, &quot;machinery&quot;, &quot;alloys&quot;, &quot;firearms&quot;, &quot;furs&quot;, &quot;minerals&quot;,
	&quot;gold&quot;, &quot;platinum&quot;, &quot;gem_stones&quot;, &quot;alien_items&quot;];
this.$SellAllF8Counter = 0; //F8 press counter
this.$SellAllSound = null; //sell soundsource
this.$SellAllSound2 = null; //warning soundsource
this.$SellAllSound3 = null; //conned soundsource
this.$SellAllPressTimer = null; //delayed message

this.startUp = function() {
	this.$SellAllF8Counter = 0;
	this.$SellAllSound = new SoundSource;
	if( worldScripts[&quot;BGS-M&quot;] ) {
		this.$SellAllSound.sound = &quot;bgs-c_sell.ogg&quot;;  //bgs sell sound
		this.$SellAllBG = &quot;bgs-i_market.png&quot;;
	} else {
		this.$SellAllSound.sound = &quot;sell.ogg&quot;; //sell sound
		if(worldScripts[&quot;Better Screens&quot;]) this.$SellAllBG = &quot;bs-base-bg.png&quot;;
		else this.$SellAllBG = &quot;&quot;;
	}
	this.$SellAllSound.loop = false;
	this.$SellAllSound.repeatCount = 1;
	this.$SellAllSound2 = new SoundSource;
	this.$SellAllSound2.sound = &quot;warning.ogg&quot;; //warning sound (original, fit better here than bgs warning)
	this.$SellAllSound2.loop = false;
	this.$SellAllSound2.repeatCount = 1;
	this.$SellAllSound3 = new SoundSource;
	this.$SellAllSound3.sound = &quot;boop.ogg&quot;; //conned sound (original, fit better here than bgs boop)
	this.$SellAllSound3.loop = false;
	this.$SellAllSound3.repeatCount = 1;
}

this.startUpComplete = function() {
	var station = system.mainStation;
	if( player.ship.docked ) station = player.ship.dockedStation;
	this.shipDockedWithStation(station);//to set interface
}

//world script events
/* removed to be compatible with Oolite 1.82 where F8F8 is used in the core
this.guiScreenWillChange = function(to, from) {
	if( player.ship.docked &amp;&amp; to == &quot;GUI_SCREEN_MARKET&quot;
		&amp;&amp; this.$SellAllF8Counter == this.$SellAllHowManyF8 - 1 ) { //next F8 will sell
		var c = this.$SellAllCargoTypes; //no message if no cargo on board
		var empty = true;
		for( var i = 0; i &lt; c.length; i++ ) {
			if( player.ship.manifest[c[i]] &gt; 0) {
				empty = false;
				i = c.length;
			}
		}
		if(!empty) this.$SellAllPressTimer = new Timer(this, this.SellAll_PressTimed, 0.05, 0);
	}
	if( player.ship.docked &amp;&amp; to == &quot;GUI_SCREEN_MARKET&quot; &amp;&amp; from == &quot;GUI_SCREEN_MARKET&quot; ) {
		this.$SellAllF8Counter++;
		if( this.$SellAllF8Counter &gt;= this.$SellAllHowManyF8 ) {
			this.$SellAllF8Counter = 0;
			this.SellAll_Cargo();
			if( this.$SellAllPressTimer ) { //to avoid press F8 message
				this.$SellAllPressTimer.stop();
				delete this.$SellAllPressTimer;
			}
		}
	} else this.$SellAllF8Counter = 0;
}
*/

this.shipDockedWithStation = function(station)
{
	this.$SellAllF8Counter = 0;
	station.setInterface(&quot;SellAll-bm&quot;,{
		title: &quot;Sell all cargo or find an alternative customer&quot;,
		category: &quot;Commerce&quot;,
		summary: &quot;Try to sell your cargo here if the market is full.&quot;,
		callback: this.SellAll_Interface.bind(this)
		});
}


//SellAll methods
this.SellAll_Cargo = function() {
	var c = this.$SellAllCargoTypes;
	var mo = worldScripts[&quot;market_observer&quot;];
	var mc = worldScripts[&quot;mo-commodity_markets&quot;];
	var station = system.mainStation;
	if( player.ship.docked ) station = player.ship.dockedStation;
	var max = this.SellAll_GetCapacity(station);
	var p = 0;
	var profit = 0;
	var tc = 0;
	var marketfull = false;
	for( var i = 0; i &lt; c.length; i++ ) {
		var q = player.ship.manifest[c[i]];
		var sq = station.market[c[i]].quantity;
		var rs = max - sq;
		if( q &gt; rs ) {
			q = rs;
			marketfull = true;
		}
		var pr = station.market[c[i]].price/10;
		if( q &gt; 0 ) {
			var cr = q * pr; //cargo cost
			tc += cr;
			station.setMarketQuantity(c[i], Math.min(max, sq + q));
			player.ship.manifest[c[i]] -= q;
			var pf = 1;
			if(mc &amp;&amp; mc.$priceFactor) {
				var id = mc.$commodities.indexOf(c[i]);
				if( id &gt; -1 ) pf = 2*(mc.$priceFactor[id]-1)+1; //4-10% more
			}
			if( mo ) {
				var b = mo.$buyLog[mo.$commodities.indexOf(c[i])];
				if( b &amp;&amp; b[0] ) p = q * (pr - pf * b[0][1] / 10);//can missing from the buyLog if scooped
				else p = cr;
				profit += p;
			}
			this.SellAll_Notify(c[i], q, pr);
			log(&quot;SellAll&quot;, &quot;Sell &quot;+q+&quot; &quot;+c[i]+&quot; at &quot;+pr+&quot;cr = &quot;+cr+&quot;cr profit:&quot;+p);
		}
	}
	var msg = &quot;Your cargo space is empty.&quot;;
	if( tc &gt; 0 ) {
		tc = Math.round( tc * 10 ) / 10;
		player.credits += tc;
		msg = &quot;You get &quot;+formatCredits(tc, true, true );
		if( mo ) msg+=&quot;, profit: &quot;+formatCredits(Math.round(profit*10)/10, true, true );
		this.$SellAllSound.play();
	} else if( marketfull ) msg = &quot;You cannot sell more, the market is full.&quot;;
	log(&quot;SellAll&quot;, msg);
	player.consoleMessage(msg, 10);
	if( mo ) mo.$printValues(&quot;                              &quot;+msg+&quot;\n\n&quot;); //refresh market screen
}

this.SellAll_Interface = function() {
	var sdm = worldScripts.Smugglers_DockMaster;
	if ( sdm ) {
		var l = player.ship.manifest.list;
		var m = &quot;&quot;;
		var ml = 0;
		for( var i = 0; i &lt; l.length; i++ ) {
			var check = sdm.$getTotalRelabelled(l[i].commodity);
			if( check &gt; 0 &amp;&amp; ml &lt; 20 ) { //max. 20 lines to fit into the screen
      // this means there is &quot;check&quot; number of tons of &quot;commodity_name&quot; that isn&#39;t really &quot;commodity_name&quot; - it&#39;s something else
      // you should skip these units from being sold
				m += &quot;You have &quot;+check+&quot;&quot;+l[i].unit+&quot; relabeled &quot;
					+l[i].displayName+&quot;.\n&quot;;
				ml++;
			}
		}
		if( ml &gt; 0 ) {
			mission.runScreen({
				title: &quot;Relabeled cargo&quot;,
				message: m+&quot;\nYou must not hold any relabeled cargo &quot;
					+&quot;to sell all of your cargo.&quot;,
				background: this.$SellAllBG,
				screenID: &quot;sellall&quot;,
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
				choices: {&quot;_0&quot; : &quot;OK&quot;}
			},function(choice) {
				if(choice == &quot;_0&quot;) {
					//exit
				}
			});
			return;
		}
	}
	
	var c = this.$SellAllCargoTypes;
	var station = system.mainStation;
	if( player.ship.docked ) station = player.ship.dockedStation;
	var max = this.SellAll_GetCapacity(station);
	var rem = 0;
	for( var i = 0; i &lt; c.length; i++ ) {
		var remq = 0;
		var q = player.ship.manifest[c[i]];
		var rs = 0;
		if( max &gt; 0 ) rs = max - station.market[c[i]].quantity;
		if( q &gt; rs ) {
			remq = q - rs;
			q = rs;
		}
		var pr = station.market[c[i]].price / 10; ///
		if( remq &gt; 0 ) rem += remq * pr;
	}
	
	var isac = false;
	var later = &quot;&quot;;
	var muchlater = &quot;&quot;;
	if( !this.$SellAllLimit ) {
		later = &quot;Try again later&quot;;
		muchlater = &quot; ... much later&quot;;
 		if( Math.floor( clock.hours/5 ) != clock.hours/5
			&amp;&amp; Math.floor( clock.days/7 ) != clock.days/7 ) {
 			muchlater = &quot;&quot;;
			if( Math.floor( clock.minutes/3 ) != clock.minutes/3 )
				isac = true;
		}
	}
	
	if( max == 0 || rem &gt; 0 &amp;&amp; isac ) {
		var part = 2 + Math.min(2, rem / 2000); //put below half price but at least 1/4
		rem = Math.round( 10 * rem / part ) / 10;
		mission.runScreen({
			title: &quot;Alternative Customer&quot;,
			message: &quot;Hello, I am Isaac. Of course, that is not my real name but an acronym &quot;
				+&quot;from there IS An Alternative Customer somewhere.&quot;
				+&quot;\n\nI see you have a problem selling all of your cargo as the market is full. &quot;
				+&quot;\nIf you promise that you will keep it in secret, I know a dealer who will buy &quot;
				+&quot;your excess cargo, but at a lower price... he will be taking a chance, you see.&quot;
				+&quot;\n\nYou can get &quot;+formatCredits(rem, false, true )
				+&quot; if you confirm to sell all of your excess cargo.&quot;,
			background: this.$SellAllBG,
			screenID: &quot;sellall&quot;,
			exitScreen: &quot;GUI_SCREEN_MARKET&quot;,
			choices: {&quot;_0&quot; : &quot;Yes&quot;,&quot;_1&quot; : &quot;No&quot;}
		},function(choice) {
			if(choice == &quot;_0&quot;) {
				for( var i = 0; i &lt; c.length; i++ ) {
					var q = player.ship.manifest[c[i]];
					var rs = 0;
					if( max &gt; 0 ) rs = max - station.market[c[i]].quantity;
					if( q &gt; rs ) {
						var pr = station.market[c[i]].price/(10*part); //below half price
						player.ship.manifest[c[i]] = rs;
						this.SellAll_Notify(c[i], q, pr);
					}
				}
				if( rem &gt; 100 &amp;&amp; Math.random() &lt; 0.1 ) {
					var msg = &quot;You received nothing for your cargo, you get conned!&quot;;
					this.$SellAllSound3.play(); //boop
				} else {
					player.credits += rem;
					var msg = &quot;You get &quot;+formatCredits(rem, false, true );
					if( rem &gt;= 200 &amp;&amp; Math.random() &lt; 0.2 ) {
						player.bounty += Math.ceil( rem / 500 );
						msg += &quot; ... but watch your back, Commander!&quot;;
						this.$SellAllSound2.play(); //warning
					} else {
						msg += &quot; from an alternative customer.&quot;;
						this.$SellAllSound.play(); //sell
					}
				}
				player.consoleMessage(msg, 10);
				log(&quot;SellAll&quot;, msg);
			}
		});
	} else {
		if( rem &gt; 0 &amp;&amp; !isac ) {
			mission.runScreen({
				title: &quot;No Alternative Customer&quot;,
				message: &quot;Isaac, the man who could help you to sell your excess cargo, &quot;
					+&quot;is not here at the moment. &quot;+later+muchlater+&quot;.&quot;
					+&quot;\n\nMeantime, you can sell your cargo at the&quot;
					+&quot; normal market up to the standard capacity.&quot;
					+&quot;\n\nAre you sure to sell?&quot;,
				background: this.$SellAllBG,
				screenID: &quot;sellall&quot;,
				exitScreen: &quot;GUI_SCREEN_MARKET&quot;,
				choices: {&quot;_0&quot; : &quot;Yes&quot;, &quot;_1&quot; : &quot;No&quot;}
			},function(choice) {
				if(choice == &quot;_0&quot;) {
					this.SellAll_Cargo();
				}
			});
		} else {
			mission.runScreen({
				title: &quot;Normal Market&quot;,
				message: &quot;You can sell all of your cargo at the normal market.&quot;
//					+&quot;\nCome back here if you can&#39;t.&quot;,
					+&quot;\n\nAre you sure to sell?&quot;,
				background: this.$SellAllBG,
				screenID: &quot;sellall&quot;,
				exitScreen: &quot;GUI_SCREEN_MARKET&quot;,
				choices: {&quot;_0&quot; : &quot;Yes&quot;, &quot;_1&quot; : &quot;No&quot;}
			},function(choice) {
				if(choice == &quot;_0&quot;) {
					this.SellAll_Cargo();
				}
			});
		}
	}
}

this.SellAll_GetCapacity = function(station) {
	var max = 127; //was fixed up to Oolite 1.80
	if (oolite.compareVersion(&quot;1.80&quot;) &lt; 0 //in Oolite 1.81 or greater
		&amp;&amp; station &amp;&amp; station.dataKey ) {
		var d = Ship.shipDataForKey(station.dataKey);
		if( d ) {
			if( d.market_capacity != null ) max = d.market_capacity;
			if( d.market_definition &amp;&amp; d.market_definition.length &gt; 0 ||
				d.market_script &amp;&amp; d.market_script.length &gt; 0 ) //needed by Kiotas
				max = 0;
			//too complex to check all custom markets so buy all goods instead
		}
	}
	return( max );
}

this.SellAll_Notify = function(c, q, pr) {
	var aa = worldScripts[&quot;AI Autotrade&quot;];
	var mc = worldScripts[&quot;mo-commodity_markets&quot;];
	var mo = worldScripts[&quot;market_observer&quot;];
	if( aa ) aa.$notifyOtherScripts(&quot;sold&quot;, c, q, pr);
	else if( mc ) mc.$notifySell(c, q, pr);
	else if( mo ) mo.playerSoldCargo(c, q, pr);
}

this.SellAll_PressTimed = function() {
	var msg = &quot;Press F8 to sell all of your cargo&quot;;
	var mo = worldScripts[&quot;market_observer&quot;];
	if( mo ) mo.$printValues(&quot;                              &quot;+msg+&quot;\n\n&quot;); //refresh market screen
	else player.consoleMessage(msg, 10);
	if( this.$SellAllPressTimer ) {
		this.$SellAllPressTimer.stop();
		delete this.$SellAllPressTimer;
	}
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
