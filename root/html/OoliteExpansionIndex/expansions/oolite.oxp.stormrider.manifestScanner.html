<html>
    <head>
        <title>Expansion Manifest Scanner</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Manifest Scanner</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>The manifest scanner allows you to scan a ships cargo manifest and display it in a MFD when activated.</td>
                    <td>The manifest scanner allows you to scan a ships cargo manifest and display it in a MFD when activated.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.stormrider.manifestScanner</td>
                    <td>oolite.oxp.stormrider.manifestScanner</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Manifest Scanner</td>
                    <td>Manifest Scanner</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Stormrider</td>
                    <td>Stormrider</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.3.2</td>
                    <td>1.3.2</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Manifest_Scanner">http://wiki.alioth.net/index.php/Manifest_Scanner</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/8/8c/Manifest_Scanner_1.3.2.oxz">https://wiki.alioth.net/img_auth.php/8/8c/Manifest_Scanner_1.3.2.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/img_auth.php/5/5f/ManifestScanner_1.3.2.oxz">http://wiki.alioth.net/img_auth.php/5/5f/ManifestScanner_1.3.2.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4.0</td>
                    <td>CC BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873357</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Manifest%20Scanner'>http://wiki.alioth.net/index.php/Manifest%20Scanner</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_MANIF_SCANNER.html">Manifest Scanner</a></td>
                    <td>yes</td>
                    <td align="right">32000</td>
                    <td align="center">8+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_MANIF_SCANNERX.html">Remove Manifest Scanner </a></td>
                    <td>no</td>
                    <td align="right">200</td>
                    <td align="center">4+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/ManifestScanner.js</td>
                    <td><pre>//			~~~I STRONGLY encourage the modification and development of this free software by anyone to meet your needs, I only ask that you give me credit for the original work. Thanks and enjoy.~~~
&quot;use strict&quot;;
this.author      = &quot;Morgan Orr&quot;; 
this.copyright   = &quot;� 2011-2017 Morgan Orr.&quot;; 
this.licence = &quot;CC-BY-SA 4.0&quot;;
this.version     = &quot;1.3.2&quot;; 



/* version 1.2 modifed by Nick Rogers (phkb)
 - made scan take a few seconds, rather than being instantaneous (makes it feel more real)
 - added manual/active scan modes (so you don&#39;t have to prime the equipment and activate a scan)
 - fixed issue with MFD where ships with more that 8 manifest types were not being displayed correctly. it was working on the basis of having 9 lines
   whereas there were only 8 lines available
 - if ship has more than 16 items, MFD will switch to a 3 column version. (Hopefully the chances of a ship needing 4 columns is remote!)
 - removed the framecallback for the scan process, reused it to check for lost target via wormholes
 - some general code tiding and refactoring.
*/


this.name        = &quot;ManifestScanner&quot;;
this.description = &quot;Scan a ship&#39;s manifest and displays results in a MFD&quot;;

this._scanTimer = null;
this._scanTime = 5;
this._scanMemory = [];
this.$manscanLst = false;
this.$manscanMsg =&quot;&quot;; //message for mfd
this._scanMode = 0; // 0 = manual scanning, 1 = active scanning
this._loadedPrevScan = false;
this._validScanClasses = [&quot;CLASS_NEUTRAL&quot;, &quot;CLASS_POLICE&quot;, &quot;CLASS_MILITARY&quot;];

//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
	this.$manscanlogging = true;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	if (missionVariables.ManifestScanner_ScanMode != null) this._scanMode = missionVariables.ManifestScanner_ScanMode;
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
	missionVariables.ManifestScanner_ScanMode = this._scanMode;
}

//-------------------------------------------------------------------------------------------------------------
//update the mfd message and start a framecallback on launch
this.shipWillLaunchFromStation = function() {
	this.$manscanmfdInfo();
	if (!this.$manscanmfd)
		this.$manscanmfd = addFrameCallback(this.$checkForLostTarget.bind(this));
	
	player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, &quot;&quot;+this.$manscanMsg+&quot;&quot;);
}

//-------------------------------------------------------------------------------------------------------------
//remove framecallback on docking or death
this.shipWillDockWithStation = function() {
	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) this._scanTimer.stop();
	this.$removeFCB();
}

//-------------------------------------------------------------------------------------------------------------
this.shipDied = function(whom, why) {
	this.$removeFCB();
}

//-------------------------------------------------------------------------------------------------------------
this.activated = function() { //try to enable scanner as primed eq
	var w = worldScripts.ManifestScanner;
	if (this._scanTimer == null || this._scanTimer.isRunning == false) {
		if (w.$manscanMsg.indexOf(&quot;Invalid target&quot;) != -1 || 
			w.$manscanMsg.indexOf(&quot;No target&quot;) != -1 || 
			w.$manscanMsg.indexOf(&quot;Target lost&quot;) != -1 ||
			w.$manscanMsg.indexOf(&quot;Unable to scan&quot;) != -1) return;

		w.$manscanLst = true;
		w.$manscanmfdInfo(0);
		
		player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, w.$manscanMsg+&quot;\n...scanning...&quot;);
			
		this._scanTimer = new Timer(this, this.$runScan.bind(this), this._scanTime, 0);
	} else if(this._scanTimer &amp;&amp; this._scanTimer.isRunning) {
		this._scanTimer.stop();
		player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, w.$manscanMsg);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.mode = function() { //attempt to make scanner update with &quot;n&quot; key
	var w = worldScripts.ManifestScanner;

	if (w._scanMode == 0) {
		w._scanMode = 1;
		player.consoleMessage(&quot;Manifest Scanner Active Scan Mode&quot;);
	} else {
		w._scanMode = 0;
		w._scanMemory = []; w.$manscanmfdInfo(0); if(w.$manscanlogging) log(w.name,w.name+&quot; : Clear scan memory&quot;) // rustem // 1 method
		player.consoleMessage(&quot;Manifest Scanner Manual Scan Mode&quot;);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function() {
	this._scanMemory = [];
	this.$manscanmfdInfo(0);
}

//-------------------------------------------------------------------------------------------------------------
this.shipEnteredWitchspace = function() {
	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) this._scanTimer.stop();
	this.$manscanMsg = &quot;Manifest Scanner: No target&quot;;
	this.$manscanmfdInfo();
	player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, &quot;&quot;+this.$manscanMsg+&quot;&quot;); 
}	

//-------------------------------------------------------------------------------------------------------------
// update when new target aquired
this.shipTargetAcquired = function(target) {
	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) this._scanTimer.stop();
	this.$manscanmfdInfo(0);
	//if(this.$manscanlogging) log(this.name,this.name+&quot;Target? : &quot;+player.ship.target)
	player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, &quot;&quot;+this.$manscanMsg+&quot;&quot;);
	// if active scanning is enabled, run the scan as soon as we have a target
	if (this._scanMode == 1 &amp;&amp; this._loadedPrevScan == false) {
		if (target.isShip &amp;&amp; this._validScanClasses.indexOf(target.scanClass) &gt;= 0) {
			this.activated();
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
//remove list when target lost ~~~ version 0.2.3 attempt to turn off so must be activated every time a new target is aquired
this.shipTargetLost = function(target) {
	if (this._scanTimer &amp;&amp; this._scanTimer.isRunning) this._scanTimer.stop();
	this.$manscanMsg = &quot;Manifest Scanner: Target lost&quot;;
	player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, &quot;&quot;+this.$manscanMsg+&quot;&quot;); 
}

//-------------------------------------------------------------------------------------------------------------
// removes the frame callback
this.$removeFCB = function() {
	if (this.$manscanmfd) {
		removeFrameCallback(this.$manscanmfd);
		delete this.$manscanmfd;
	}
}

//-------------------------------------------------------------------------------------------------------------
// runs the manifest scan and updates the MFD
this.$runScan = function() {
	this.$manscanLst = true;
	this.$manscanmfdInfo(1);
	player.ship.setMultiFunctionText(&quot;ManifestScanner&quot;, &quot;&quot;+this.$manscanMsg+&quot;&quot;);
}

//-------------------------------------------------------------------------------------------------------------
// checks to see if the players current target has disappeared (eg into a wormhole)
this.$checkForLostTarget = function() {
	if (player.ship.target == null &amp;&amp; this.$manscanMsg.indexOf(&quot;Manifest Scanner:&quot;) == -1) this.shipTargetLost();
}

//-------------------------------------------------------------------------------------------------------------
//display targets manifest in a MFD
this.$manscanmfdInfo = function(repType) {
	
	// rep type 0 = cargo capacity only
	// rep type 1 = all data

	var p = player.ship;
	if (!p || !p.isValid || p.equipmentStatus(&#39;EQ_MANIF_SCANNER&#39;) !== &#39;EQUIPMENT_OK&#39;) return;
	var target = &quot;&quot;;
	var t = p.target;

	this._loadedPrevScan = false;
	if (t != null) {
		var prevScan = worldScripts.ManifestScanner.$findShipScan(t);
		if (prevScan != &quot;&quot;) {
			this.$manscanMsg = prevScan;
			this._loadedPrevScan = true; 
			if(this.$manscanlogging) log(this.name,this.name+&quot; : will loaded prevScan for &quot;+t.displayName+&quot;[&quot;+t.cargoSpaceUsed+&quot;]&quot;); // rustem
			return;
		}
	}

	var tdn = &quot;&quot;;
	var message = &quot;Manifest Scanner: &quot;;
	if (!t) message += &quot;No target&quot;;
	if (t &amp;&amp; t.isValid) {
		if (this._validScanClasses.indexOf(t.scanClass) == -1) { 
			message += &quot;Invalid target&quot;;
		} else if(t.isDerelict) {
			message += &quot;Unable to scan\nNo power to ship systems.\nRemote query of manifest failed.&quot;;
		} else {
			tdn = t.displayName+&quot;\nCargo &quot; + t.cargoSpaceUsed + &quot; t (&quot; + t.cargoSpaceCapacity + &quot; t):&quot;;

			if (t.cargoSpaceCapacity == 0 || t.cargoSpaceUsed == 0) {
				tdn += &quot;\n  None.&quot;;
				// there is no capacity, or nothing stored, so no need to scan - tell calling routine to skip the scan process
				this._loadedPrevScan = true;
			}
			
			if (t.cargoSpaceCapacity &gt; 0 &amp;&amp; repType == 1) {
				var lst = t.cargoList;
				if (lst.length === 0) tdn += &quot;\n  None.&quot;;

				if(this.$manscanLst) {
					var units = new Array();
					for (var i = 0; i &lt; lst.length; i++) {
						var l = lst[i];
						units.push(l.quantity + &quot; &quot; + String.fromCharCode(215) + &quot; &quot;+ l.displayName);
					} 
					var columns = Math.ceil(units.length / 8);
					var colWidths = [15, 7.5, 7]; // 3rd column width is 7 - we want Oolite to squeeze the font in this instance
					var colWidth = colWidths[columns - 1];
					for (var i = 0; i &lt; 8; i++) {
						var line = &quot;&quot;;
						
						if (i &lt; units.length) line = &quot;\n&quot; + this.$padTextRight(&quot; &quot; + units[i], colWidth);
						if ((i + 8) &lt; units.length) line += this.$padTextRight(units[i+8], colWidth);
						if ((i + 16) &lt; units.length) line += this.$padTextRight(units[i+8], colWidth);
						
						if (line != &quot;&quot;) tdn += line;
					}
				}
			}
			message = tdn;
		}
	}
	this.$manscanMsg = message;
	if (t &amp;&amp; t.isValid &amp;&amp; t.isShip &amp;&amp; t.isPiloted &amp;&amp; repType == 1) worldScripts.ManifestScanner.$addShipScan(t, message);
}

//-------------------------------------------------------------------------------------------------------------
// adds or updates the scan for a ship
this.$addShipScan = function(shp, dta) {
	var index = null;
	var found = false;
	var shipKey = shp.displayName + shp.dataKey + shp.entityPersonality + shp.primaryRole; // rustem / 2 method: + shp.cargoSpaceUsed
	for (var i = 0; i &lt; this._scanMemory.length; i++) {
		if (this._scanMemory[i].ship == shipKey) { // rustem / 3 method: add check cargoSpaceUsed + add replace scanData
			index = i;													// found an any data
			if (this._scanMemory[i].shipCSU == shp.cargoSpaceUsed) { 	// found a last correct data
				found = true;
				this._scanMemory[i].scanCSU = shp.cargoSpaceUsed;
				this._scanMemory[i].scanData = dta;
				break;
			}
		}
	}
	if (found == false) {
		if (index == null) {		// rustem
			this._scanMemory.push({ship:shipKey, scanCSU:shp.cargoSpaceUsed, scanData:dta});
			if(this.$manscanlogging) log(this.name,this.name+&quot; : push data for &quot;+shp.displayName+&quot;[&quot;+shp.cargoSpaceUsed+&quot;]&quot;);
		} else {
			//index = index+1;
			this._scanMemory.splice(index, 1, {ship:shipKey, scanCSU:shp.cargoSpaceUsed, scanData:dta});
			if(this.$manscanlogging) log(this.name,this.name+&quot; : replace[&quot;+index+&quot;] data for &quot;+shp.displayName+&quot;[&quot;+shp.cargoSpaceUsed+&quot;]&quot;);			
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// checks the scan memory for a scan for this ship
this.$findShipScan = function(shp) {
	var shipKey = shp.displayName + shp.dataKey + shp.entityPersonality + shp.primaryRole; // rustem / 2 method: + shp.cargoSpaceUsed
	for (var i = 0; i &lt; this._scanMemory.length; i++) {
		if (this._scanMemory[i].ship == shipKey &amp;&amp; this._scanMemory[i].scanCSU == shp.cargoSpaceUsed) return this._scanMemory[i].scanData; // rustem / 3 method
	}
	return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function(currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;…&quot;;
	var currentLength = defaultFont.measureString(currentText);
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1)	{
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp == ellip) break;
		} while (defaultFont.measureString(tmp) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch == false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/ManifestScannerEq.js</td>
                    <td><pre>//			~~~I STRONGLY encourage the modification and development of this free software by anyone to meet your needs, I only ask that you give me credit for the original work. Thanks and enjoy.~~~
&quot;use strict&quot;;
this.author      = &quot;Morgan Orr&quot;; 
this.copyright   = &quot;� 2011-2017 Morgan Orr.&quot;; 
this.licence = &quot;CC-BY-SA 4.0&quot;;
this.version     = &quot;1.3.2&quot;; 


/* version 1.2 modifed by Nick Rogers (phkb)
 - Cleaned up unnecessary lines in equipment.plist
 - Expanded text displayed if the player is discovered with a manifest scanner while doing a renovation.
 - included gov type 4 in all government checks
*/


this.name        = &quot;ManifestScannerEq&quot;;
this.description = &quot;Equipment control script for the manifest scanner&quot;;

//restrict from mainstations communist-corprate systems
this.allowAwardEquipment = function(equipment, ship, context) {
	var p = player.ship;
	var stn = p.dockedStation;
	if (context == &quot;purchase&quot; &amp;&amp; system.government &gt;= 4 &amp;&amp; stn.allegiance == &quot;galcop&quot;) {
		return false;
	} else {
		return true;
	}
}

this.playerBoughtEquipment = function(equipment) {
	var p = player.ship;
	var stn = p.dockedStation;
	if( equipment === &quot;EQ_MANIF_SCANNERX&quot; ) {
		p.removeEquipment(&quot;EQ_MANIF_SCANNERX&quot;);
		p.removeEquipment(&quot;EQ_MANIF_SCANNER&quot;);
		var info = EquipmentInfo.infoForKey(&quot;EQ_MANIF_SCANNER&quot;);
		var refund = parseInt(((info.price / 10) * p.dockedStation.equipmentPriceFactor) * 0.9218);
		
		player.credits += refund; //2950
	}

	//Remove and fine if techies at mainstation find it in communist-corprate systems 
	if (equipment === &quot;EQ_RENOVATION&quot; &amp;&amp; 
		system.government &gt;= 4 &amp;&amp; 
		stn.allegiance == &quot;galcop&quot; &amp;&amp; 
		(p.equipmentStatus(&quot;EQ_MANIF_SCANNER&quot;) == &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_MANIF_SCANNER&quot;) == &quot;EQUIPMENT_DAMAGED&quot;)) {

		this._scannerRemove = true;
		mission.runScreen({
			title: &quot;Suspicious Activity&quot;, 
			message: &quot;It appears that some of your equipment has been tampered with.&quot;, 
			model:&quot;station&quot;}
		);
	}
}

this.missionScreenOpportunity= function() {
	if(this._scannerRemove) {
    	this._scannerRemove = false;
        mission.runScreen({
			title: &quot;Equipment Confiscated&quot;, 
			message: &quot;Your Manifest Scanner has been confiscated as per GalCop regulation GC-149874-2 which states:&quot; + 
			&quot;\n\n&#39;Devices designed to scan a ship&#39;s manifest while in space, operating in unauthorised vessels, are deemed to be illegal. &quot; + 
			&quot;Should such a device be discovered on a ship by a GalCop official in any capacity (be it law enforcement or engineering), it will be removed and destroyed.&#39;&quot; + 
			&quot;\n\nWe would normally issue a fine for this offence, but decided that a warning was sufficient. Please take care to obey GalCop laws in future.&quot;, 
			model: &quot;police&quot;
		});
		player.ship.removeEquipment(&quot;EQ_MANIF_SCANNER&quot;);
    }
}




</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
