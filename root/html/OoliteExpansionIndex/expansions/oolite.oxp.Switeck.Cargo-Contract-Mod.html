<html>
    <head>
        <title>Expansion Cargo-Contract-Mod</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Cargo-Contract-Mod</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER C)(&#39;[]&#39; vs &#39;[cargo, contract, economy]&#39;)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Cargo Contracts are given better choices and often greater profits as a result. (See readme for more details.)</td>
                    <td>Cargo Contracts are given better choices and often greater profits as a result. (See readme for more details.)</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Switeck.Cargo-Contract-Mod</td>
                    <td>oolite.oxp.Switeck.Cargo-Contract-Mod</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Cargo-Contract-Mod</td>
                    <td>Cargo-Contract-Mod</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Activities</td>
                    <td>Activities</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>cim, Switeck</td>
                    <td>cim, Switeck</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.5</td>
                    <td>1.5</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>cargo, contract, economy</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://aegidian.org/bb/viewtopic.php?f=3&amp;t=13757">http://aegidian.org/bb/viewtopic.php?f=3&amp;t=13757</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/images/f/f3/Oolite.oxp.Switeck.Cargo-Contract-Mod_1.5.oxz">https://wiki.alioth.net/images/f/f3/Oolite.oxp.Switeck.Cargo-Contract-Mod_1.5.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/images/f/f3/Oolite.oxp.Switeck.Cargo-Contract-Mod_1.5.oxz">http://wiki.alioth.net/images/f/f3/Oolite.oxp.Switeck.Cargo-Contract-Mod_1.5.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>Gnu Public License v2+</td>
                    <td>Gnu Public License v2+</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873512</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Cargo-Contract-Mod'>http://wiki.alioth.net/index.php/Cargo-Contract-Mod</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/oolite-contracts-cargo.js</td>
                    <td><pre>/*

oolite-contracts-cargo.js

Script for managing cargo contracts


Oolite
Copyright © 2004-2013 Giles C Williams and contributors

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
MA 02110-1301, USA.

*/

/*jslint white: true, undef: true, eqeqeq: true, bitwise: true, regexp: true, newcap: true, immed: true */
/*global galaxyNumber, missionVariables, system*/

&quot;use strict&quot;;

this.name			= &quot;oolite-contracts-cargo&quot;;
this.author			= &quot;cim and Switeck&quot;;
this.copyright		= &quot;© 2012-2013 the Oolite Team, 2014 Switeck&quot;;
this.licence			= &quot;Gnu Public License v2+&quot;;
this.description	= &quot;Cargo delivery contracts.&quot;;
this.version			= &quot;1.79 MOD 1.5&quot;;

// Mod changes by Switeck with help+ideas from PhantorGorth and others on Oolite IRC chat...
// All changes covered under creative commons open source:
// &quot;Creative Commons Attribution - Non-Commercial - Share Alike 3.0&quot;;

/**** Configuration options and API ****/

/* OXPs which wish to add a background to the summary pages should
   set this value */
this.$cargoSummaryPageBackground = &quot;&quot;;
/* OXPs which wish to add an overlay to the cargo mission screens
   should set this value */
this.$cargoPageOverlay = &quot;&quot;;


/* this._addCargoContractToSystem(cargo)
 * This function adds the defined cargo contract to the local main station&#39;s
 * interface list. A contract definition is an object with the following
 * parameters, all required:
 *
 * destination: system ID of destination system
 * commodity:   the cargo type
 * size:        the number of units of cargo
 * deadline:    the deadline for delivery, in clock seconds
 * payment:     the payment for delivery on time, in credits
 *
 * and optionally, the following parameters:
 *
 * deposit:     the deposit payment required by the player (default 0)
 * route:       a route object generated with system.info.routeToSystem
 *              describing the route between the source and destination
 *              systems.
 *
 * If this is not specified, it will be generated automatically.
 *
 * The function will return true if the contract can be added, false
 * otherwise.
 */
this._addCargoContractToSystem = function(cargo)
{
		if (!system.mainStation) {
				log(this.name,&quot;Contracts require a main station&quot;);
				return false;
		}
		if (cargo.destination &lt; 0 || cargo.destination &gt; 255) {
				log(this.name,&quot;Rejected contract: destination missing or invalid&quot;);
				return false;
		}
		if (cargo.deadline &lt;= clock.adjustedSeconds) {
				log(this.name,&quot;Rejected contract: deadline invalid&quot;);
				return false;
		}
		if (cargo.payment &lt; 0) {
				log(this.name,&quot;Rejected contract: payment invalid&quot;);
				return false;
		}
		if (!cargo.size || cargo.size &lt; 1) {
				log(this.name,&quot;Rejected contract: size invalid&quot;);
				return false;
		}
		if (!cargo.commodity) {
				log(this.name,&quot;Rejected contract: commodity unspecified&quot;);
				return false;
		}
		if (!system.mainStation.market[cargo.commodity]) {
				log(this.name,&quot;Rejected contract: commodity invalid&quot;);
				return false;
		}

		if (!cargo.route) {
				var destinationInfo = System.infoForSystem(galaxyNumber,cargo.destination);
				cargo.route = system.info.routeToSystem(destinationInfo);
				if (!cargo.route) {
						log(this.name,&quot;Rejected contract: route invalid&quot;);
						return false;
				}
		}
		if (!cargo.deposit) {
				cargo.deposit = 0;
		} else if (cargo.deposit &gt;= cargo.payment) {
				log(this.name,&quot;Rejected contract: deposit higher than total payment&quot;);
				return false;
		}

		this.$contracts.push(cargo);
		this._updateMainStationInterfacesList();
		return true;
}


/**** Internal methods. Do not call these from OXPs as they may change
 **** without warning. ****/

/* Event handlers */

this.startUp = function()
{
		this.$helper = worldScripts[&quot;oolite-contracts-helpers&quot;];

		this.$suspendedDestination = null;
		this.$suspendedHUD = false;

		// stored contents of local main station&#39;s parcel contract list
		if (missionVariables.oolite_contracts_cargo) {
				this.$contracts = JSON.parse(missionVariables.oolite_contracts_cargo);
		} else {
				this._initialiseCargoContractsForSystem();
		}

		this._updateMainStationInterfacesList();
}


this.shipWillExitWitchspace = function()
{
		if (!system.isInterstellarSpace &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.mainStation) {
				// must be a regular system with a main station
				this._initialiseCargoContractsForSystem();
				this._updateMainStationInterfacesList();
		}
}


this.playerWillSaveGame = function()
{
		// encode the contract list to a string for storage in the savegame
		missionVariables.oolite_contracts_cargo = JSON.stringify(this.$contracts);
}


// when the player exits the mission screens, reset their destination
// system and HUD settings, which the mission screens may have
// affected.
this.shipWillLaunchFromStation = function()
{
	this._resetViews();
}


this.guiScreenWillChange = function(to, from)
{
	this._resetViews();
}


this.guiScreenChanged = function(to, from)
{
	if (to != &quot;GUI_SCREEN_MISSION&quot;) this._resetViews();
}


/* Interface functions */

// resets HUD and jump destination
this._resetViews = function()
{
		if (this.$suspendedHUD !== false) {
				player.ship.hudHidden = false;
				this.$suspendedHUD = false;
		}
		if (this.$suspendedDestination !== null) {
				player.ship.targetSystem = this.$suspendedDestination;
				this.$suspendedDestination = null;
		}
}

// initialise a new cargo contract list for the current system
this._initialiseCargoContractsForSystem = function()
{
		// clear list
		this.$contracts = [];

		// this is not the same algorithm as in 1.76, but should give similar results with comparable efficiency.

		// no point in generating too many, as route-finding is slow
	var numContracts = Math.floor(5*(Math.random()+Math.random())+(system.government+player.contractReputationPrecise-player.bounty*0.02)*Math.random());
	// I added that bounty can reduce the number of contracts. Corporate state systems can add extra contracts.
	if (numContracts &lt; 0) numContracts = 0;
	if (player.contractReputationPrecise &gt;= 0 &amp;&amp; numContracts &lt; 5) numContracts += 5;
	if (numContracts &gt; 18) numContracts = 18;

	// some of these possible contracts may be discarded later on
	var nearbysystems = system.info.systemsInRange(80-player.contractReputationPrecise*7); // 31-80-129 LY range...done here to save recalculations time.

	log(this.name,&quot; player.contractReputation= &quot;+player.contractReputationPrecise+&quot; numContracts= &quot;+numContracts+&quot; nearbysystems.length= &quot;+nearbysystems.length);
//	log(this.name,&quot; player.contractReputation= &quot;+player.contractReputation+&quot; numContracts= &quot;+numContracts+&quot; nearbysystems.length= &quot;+nearbysystems.length+&quot; nearbysystems= &quot;+nearbysystems);

	for (var i = 0; i &lt; numContracts; i++) {
		var scratchval = 1;
		var attempts = 0;
		do {
			var scratchval = 1;
			attempts++;
		// pick a random system to take the goods to
//			var destination = Math.floor(Math.random()*256);	// ORIGINAL -- FOR TESTING ONLY!
			var destination = nearbysystems[Math.floor(Math.random() * nearbysystems.length)].systemID;
//		log(this.name,&quot; destination = &quot;+destination);

		// discard if chose the current system
			if (destination === system.ID) {
				var scratchval = 0;
			} else {
		// get the SystemInfo object for the destination
				var destinationInfo = System.infoForSystem(galaxyNumber,destination);

// Decides firsthand to drop a bad system and choose another one?
				if (Math.abs(system.economy - destinationInfo.economy)&lt;(1+player.contractReputationPrecise*0.28) &amp;&amp; player.contractReputationPrecise &lt; 6.5 &amp;&amp; system.economy &lt;7) {
					var scratchval = 0;	// Discarded, since identical or &quot;worse&quot; economies leave little opportunity for profitable trading.
				} else {
		// check that a route to the destination exists
		// route calculation is expensive so leave this check to last
					var routeToDestination = system.info.routeToSystem(destinationInfo);
//log(this.name,&quot; routeToDestination = &quot;+routeToDestination);
		// if the system cannot be reached, ignore this contract
					if (!routeToDestination) {
						var scratchval = 0;	// No route, no point trying!
					} else {
						var daysUntilDeparture = 1+(Math.random()*(7+player.contractReputationPrecise-destinationInfo.government));	// NEEDS a better estimate based on time needed to reach target!
						if (daysUntilDeparture &lt; 0) var scratchval = 0;	// negative reputation can make a contract out-of-time failed before starting.
					}
				}
			}
		} while (scratchval == 0 &amp;&amp; attempts &lt; 10);
		if (attempts &gt; 9) continue;	// failed to find a good destination.

		// we now have a valid destination, so generate the rest of the cargo contract details

//log(this.name,&quot; daysUntilDeparture = &quot;+daysUntilDeparture);
//		var commodities = Object.keys(system.mainStation.market);
		var attempts = 0;
		do {
			var unitPrice = 0;
			var unitMinPrice = 0;
			var unitMaxPrice = 0;
			var remotePrice = 0;
			var remoteMinPrice = 0;
			attempts++;

// if destinationInfo.economy &lt; system.economy	means destination is more industrial than start locaction.
// if system.economy &lt;4 then it&#39;s &quot;industrial&quot; so choose comp,lux,mach,alloys (+firearms?)
// else it&#39;s &quot;agricultural&quot; so choose food,textiles,radioactives,liquor_wines,furs,minerals (+slaves, narcotics?)
// Odds get lowered if offender/fugitive, raised if high reputation...forcing more controlled items if &quot;bad&quot; and more gold/plat/gems if &quot;good&quot;.

//			var commodities = [&quot;food&quot;,&quot;textiles&quot;,&quot;radioactives&quot;,&quot;slaves&quot;,&quot;liquor_wines&quot;,&quot;luxuries&quot;,&quot;narcotics&quot;,&quot;computers&quot;,&quot;machinery&quot;,&quot;alloys&quot;,&quot;firearms&quot;,&quot;furs&quot;,&quot;minerals&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;];
//			var commodity = commodities[Math.floor(Math.random()*commodities.length)];	// Chooses random commondity
			if (system.economy &gt; destinationInfo.economy || system.economy &gt;5) {
				if (system.economy &lt; destinationInfo.economy + 1 + player.contractReputationPrecise*0.4) {	// Eliminates marginal profit commodities from similar agri economies
					var commodities = [&quot;slaves&quot;,&quot;narcotics&quot;,&quot;liquor_wines&quot;,&quot;alloys&quot;,&quot;furs&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;]; // 7 entries, removed Gold!
					var preccutoff = 5;
					var scratchval = Math.floor(Math.random()*(commodities.length-3)+3); // Drops the controlled items and low profit stuff.
				} else {
				var commodities = [&quot;slaves&quot;,&quot;narcotics&quot;,&quot;food&quot;,&quot;minerals&quot;,&quot;textiles&quot;,&quot;radioactives&quot;,&quot;liquor_wines&quot;,&quot;furs&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;]; // 11 entries, sorted from worst to best
				var preccutoff = 8;
				var scratchval = Math.floor(Math.random()*(commodities.length-5)+5); // Drops the controlled items and low profit stuff.
				}
			} else if (system.economy &gt; destinationInfo.economy - Math.max(0, player.contractReputationPrecise*0.3)) {	// Eliminates low-profit commodities when start economy == destination (identical ind economies)
				var commodities = [&quot;alloys&quot;,&quot;furs&quot;,&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;]; // 5 entries
				var preccutoff = 2;
				var scratchval = Math.floor(Math.random()*commodities.length);
			} else if (system.economy &gt; destinationInfo.economy - 1 - player.contractReputationPrecise*0.2 ) {	// Eliminates low-profit commodities when start economy is only slightly more industrial than destination.
				var commodities = [&quot;narcotics&quot;,&quot;firearms&quot;,&quot;computers&quot;,&quot;alloys&quot;,&quot;furs&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;]; // 7 entries, removed Gold!
				var preccutoff = 5;
				var scratchval = Math.floor(Math.random()*(commodities.length-2)+2); // Drops the controlled items and low profit stuff.
			} else {
				var commodities = [&quot;narcotics&quot;,&quot;firearms&quot;,&quot;alloys&quot;,&quot;machinery&quot;,&quot;luxuries&quot;,&quot;computers&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;];	// 8 entries, sorted from worst to best, removed Gold!
				var preccutoff = 6;
				var scratchval = Math.floor(Math.random()*(commodities.length-2)+2); // Drops the controlled items and low profit stuff.
			}

			if (player.contractReputationPrecise &lt; 6.5 - Math.random()*5) {	// At rep&gt;2, there&#39;s a chance of getting ONLY good contracts. The odds of this are much better by rep&gt;5.
				var scratchval = Math.floor(Math.random()*(preccutoff+player.contractReputationPrecise*0.1-player.bounty*0.01));
			}
			if (scratchval &lt; 0) var scratchval = 0;	// If bad rep plus bad bounty pushes off leftside of the chart, give player &quot;worst&quot; contract.
			if (scratchval &gt;= preccutoff &amp;&amp; player.contractReputationPrecise &lt; 6.5) var scratchval = preccutoff -1;	// Prevents Gold contracts before player.contractReputation == 7
			if (scratchval &gt; commodities.length -1) var scratchval = commodities.length -1;	// If high rep pushes off rightside of the chart, give player &quot;best&quot; contract.

//			var commodities = [&quot;gold&quot;,&quot;platinum&quot;,&quot;gem_stones&quot;];	// 3 entries, tests only Gold/Plat/Gems!
//			var scratchval = Math.floor(Math.random()*commodities.length);
			var commodity = commodities[scratchval];

			if (system.mainStation.market[commodity].quantity &gt; 0) {	// ignore commodities with 0 availability here
				var unitPrice = Number((system.mainStation.market[commodity].price*0.1).toFixed(1));
				var unitMinPrice = Number((this._priceForCommodity(system.mainStation.market[commodity],System.infoForSystem(galaxyNumber,system.ID).economy,0)).toFixed(1));
				var unitMaxPrice = Number((this._priceForCommodity(system.mainStation.market[commodity],System.infoForSystem(galaxyNumber,system.ID).economy,255)).toFixed(1));
				var remoteMinPrice = Number((this._priceForCommodity(system.mainStation.market[commodity],destinationInfo.economy,0)).toFixed(1)); // ,0 means return smallest value
				var remotePrice = Number((this._priceForCommodity(system.mainStation.market[commodity],destinationInfo.economy,255)).toFixed(1)); // ,255 means return largest value
//				var remotePrice = Number((this._priceForCommodity(system.mainStation.market[commodity],destinationInfo.economy,Math.floor(Math.random()*256))).toFixed(1)); // random prices!

//		log(this.name,&quot; # &quot;+attempts+&quot;, &quot;+commodities+&quot;, &quot;+preccutoff+&quot;, &quot;+commodity+&quot; val1=&quot;+scratchval+&quot; Price=&quot;+unitPrice+&quot; MinPrice=&quot;+unitMinPrice+&quot; MaxPrice=&quot;+unitMaxPrice+&quot; remMin=&quot;+remoteMinPrice+&quot; remP= &quot;+remotePrice+&quot;, &quot;+system.economy+&quot;, &quot;+destinationInfo.economy);

// This can happen with narcotics!
				if(remotePrice&lt;remoteMinPrice) {
					var scratchval = remoteMinPrice;
					var remoteMinPrice = remotePrice;
					var remotePrice = scratchval;
				}
				if(unitMaxPrice&lt;unitMinPrice) {
					var scratchval = unitMaxPrice;
					var unitMaxPrice = unitMinPrice;
					var unitMinPrice = scratchval;
				}
				if(unitPrice&lt;unitMinPrice) unitMinPrice = unitPrice;
				if(unitPrice&gt;unitMaxPrice) unitMaxPrice = unitPrice;
			}
		} while ((remotePrice - unitMinPrice) &lt; Math.max(1,player.contractReputationPrecise*0.5 - system.mainStation.market[commodity].quantityUnit*3) &amp;&amp; attempts &lt; 10);	// Allows Gold more often!
		if (attempts &gt; 9) continue;	// failed to find a good commodity.

		var cargo = new Object;
		cargo.commodity = commodity;

		var amount = 0;
		var unitsize = 1;
		// larger unit sizes for kg/g commodities
		if (system.mainStation.market[commodity].quantityUnit == 1) {
			unitsize += Math.ceil((Math.random()+Math.random()+Math.random())*routeToDestination.route.length);	// Adds more if routeToDestination.route.length &gt; 5
		} else if (system.mainStation.market[commodity].quantityUnit == 2) {
			unitsize += Math.ceil((Math.random()+Math.random()+Math.random())*routeToDestination.route.length*2);
		}
		amount += Math.max(Math.ceil((1+Math.random()*32)*(1+Math.random()*16)),Math.floor(30+Math.random()*6))*unitsize; // forced minimum amount to always be at least 30-35. Eliminates while-looping here!

		if (amount &gt; 125 &amp;&amp; amount &gt; player.ship.cargoSpaceCapacity &amp;&amp; player.contractReputationPrecise &gt;= 0 &amp;&amp; system.mainStation.market[commodity].quantityUnit == 0) {	// reduce the number of contracts only suitable for Anacondas
			amount = Math.floor(amount/Math.floor(1+(Math.random()*4)));
		}

		cargo.size = amount;

		var localValue = Math.floor(unitPrice * amount);	// Total cost at Current/Original Price
		var remoteValue = Math.floor(remotePrice * amount);	// Remote max value
		var profitMax = remoteValue-Math.floor(unitMinPrice * amount);

		// discount adjustment to prices. Higher reputation and bulk quantities should make this more profitable
		var discount = Number((Math.ceil(Math.max(50,Math.min(100,20+ player.contractReputationPrecise*10 + routeToDestination.route.length*10 + amount*0.1 +50000/profitMax - player.bounty*0.1 - destinationInfo.government - system.government)))*0.01).toFixed(2));
		var profit = Math.ceil(profitMax * discount);	// Uses discount directly on max profit to determine profit.
//		if (profit &lt; 100 + player.contractReputationPrecise*100 || profit &gt; profitMax) profit = profitMax;	// Ensures higher profits if payout would otherwise be too low.

// Formulas to generate ORIGINAL PROFIT AMOUNTS!
/*
		var discount = Math.min(10+Math.floor(amount/10),35);
		var unitPrice = system.mainStation.market[commodity].price * (100-discount) / 1000;
		var localValue = Math.floor(unitPrice * amount);
		remotePrice = remotePrice * (200+discount) / 200;
		var remoteValue = Math.floor(remotePrice * amount);
		var profit = remoteValue-localValue;
*/
		var scratchval = this._priceForCommodity(system.mainStation.market[commodity],destinationInfo.economy,Math.floor(Math.random()*256)); // random prices!
//		var scratchval = remotePrice; // max selling price!
		var discount2 = Number(Math.min(0.1+Math.floor(amount*0.1)*0.01,0.35).toFixed(2));
		var profitORG = Math.floor(scratchval * (1 + 0.5*discount2 ) * amount ) - Math.floor(unitPrice * (1 - discount2 ) * amount );	// Original results for profit!
		var profitORGmax = Math.floor(remotePrice * (1 + 0.5*discount2 ) * amount ) - Math.floor(unitMinPrice * (1 - discount2 ) * amount );	// Theoretical MAX Original results for profit!

		// higher share for transporter for longer routes, less safe systems, and Higher reputation. lower share for high bounty! 100 bounty = 10% share loss!
		var share = 100 + destinationInfo.government - (10*routeToDestination.route.length);
		if (share &lt; 10) share = 10;
		if (share &gt; 100) share = 100;
		share = 100-share;
		var profitORGmax = Math.floor(profitORGmax*share*0.01);

	// safety: now multiply the fee by 2 compared with 1.76 contracts
	// prevents exploit discovered by Mad Hollander at
	// http://aegidian.org/bb/viewtopic.php?p=188127
//	localValue *= 2;	// This amount is so high in the event of a failed contract that it&#39;s practically PUNATIVE PUNISHMENT for those doing contracts.
	// this may need to be raised further

// fee is total selling price.
// This IF-ELSE makes the cargo deposit equal or greater than the current selling value for the commodity.
		if(localValue &gt; remoteValue-profit) {
			var fee = Math.ceil((localValue + profit) *0.1)*10; // round to nearest 10 credits
		} else {
			var fee = Math.ceil(remoteValue*0.1)*10; // round to nearest 10 credits
		}
		cargo.payment = fee;
		cargo.deposit = Math.ceil((fee - profit)*0.1)*10; // round to nearest 10 credits

// logs nearly everything
log(this.name,
&quot;Rep=&quot;+player.contractReputationPrecise
+&quot;, &quot;+commodity
+&quot; size=&quot;+cargo.size
+&quot; econ=&quot;+system.economy
+&quot; DestEcon=&quot;+destinationInfo.economy
+&quot; jumps=&quot;+routeToDestination.route.length
+&quot; unitPrice=&quot;+unitPrice
+&quot; MinP=&quot;+unitMinPrice
+&quot; MaxP=&quot;+unitMaxPrice
+&quot; remMinP=&quot;+remoteMinPrice
+&quot; remP=&quot;+remotePrice
+&quot; locVal=&quot;+localValue
+&quot; deposit=&quot;+cargo.deposit
+&quot; profit=&quot;+profit
+&quot; pMax=&quot;+profitMax
+&quot; *&quot;+discount
+&quot; pORG=&quot;+profitORG
+&quot; pORGmax=&quot;+profitORGmax
+&quot; share=&quot;+share
+&quot; discount=&quot;+discount2
+&quot; DestVal=&quot;+remoteValue
+&quot; Total=&quot;+fee
);

		cargo.destination = destination;
		// we&#39;ll need this again later, and route calculation is slow
		cargo.route = routeToDestination;

		// time allowed for delivery is time taken by &quot;fewest jumps&quot;
		// route, plus timer above. Higher reputation makes longer
		// times available.
		cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture*86400)+(cargo.route.time*3600);

		// add parcel to contract list
		if (cargo.deposit &lt; cargo.payment) this._addCargoContractToSystem(cargo);
	}
}

// this should be called every time the contents of this.$parcels
// changes, as it updates the summary of the interface entry.
this._updateMainStationInterfacesList = function()
{
	if (this.$contracts.length === 0) {
		// no contracts, remove interface if it exists
		system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;,null);
	} else {
		var title = expandMissionText(&quot;oolite-contracts-cargo-interface-title&quot;,{
			&quot;oolite-contracts-cargo-interface-title-count&quot;: this.$contracts.length
		});

		system.mainStation.setInterface(&quot;oolite-contracts-cargo&quot;,{
			title: title,
			category: expandMissionText(&quot;oolite-contracts-cargo-interface-category&quot;),
			summary: expandMissionText(&quot;oolite-contracts-cargo-interface-summary&quot;),
			callback: this._cargoContractsScreens.bind(this)
			// could alternatively use &quot;cbThis: this&quot; parameter instead of bind()
		});
	}
}


// if the interface is activated, this function is run.
this._cargoContractsScreens = function(interfaceKey)
{
	// the interfaceKey parameter is not used here, but would be useful if
	// this callback managed more than one interface entry

	this._validateContracts();

	// set up variables used to remember state on the mission screens
	this.$suspendedDestination = null;
	this.$suspendedHUD = false;
	this.$contractIndex = 0;
	this.$routeMode = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
	this.$lastOptionChosen = &quot;06_EXIT&quot;;

	// start on the summary page if more than one contract is available
	var summary = (this.$contracts.length &gt; 1);

	this._cargoContractsDisplay(summary);
}


// this function is called after the player makes a choice which keeps
// them in the system, and also on initial entry to the system
// to select the appropriate mission screen and display it
this._cargoContractsDisplay = function(summary) {

		// Again. Has to be done on every call to this function, but also
		// has to be done at the start.
		this._validateContracts();

		// if there are no contracts (usually because the player has taken
		// the last one) display a message and quit.
		if (this.$contracts.length === 0) {
				var missionConfig = {titleKey: &quot;oolite-contracts-cargo-none-available-title&quot;,
													 messageKey: &quot;oolite-contracts-cargo-none-available-message&quot;,
													 allowInterrupt: true,
													 screenID: &quot;oolite-contracts-cargo-none&quot;,
													 exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;};
				if (this.$cargoSummaryPageBackground != &quot;&quot;) {
						missionConfig.background = this.$cargoSummaryPageBackground;
				}
				if (this.$cargoPageOverlay != &quot;&quot;) {
						missionConfig.overlay = this.$cargoPageOverlay;
				}
				mission.runScreen(missionConfig);
				// no callback, just exits contracts system
				return;
		}

		// make sure that the &#39;currently selected contract&#39; pointer
		// is in bounds
		if (this.$contractIndex &gt;= this.$contracts.length) {
				this.$contractIndex = 0;
		} else if (this.$contractIndex &lt; 0) {
				this.$contractIndex = this.$contracts.length - 1;
		}
		// sub functions display either summary or detail screens
		if (summary) {
				this._cargoContractSummaryPage();
		} else {
				this._cargoContractSinglePage();
		}

}


// display the mission screen for the summary page
this._cargoContractSummaryPage = function()
{
		// column &#39;tab stops&#39;
		var columns = [10,16,21,26];

		// column header line
		var headline = expandMissionText(&quot;oolite-contracts-cargo-column-goods&quot;);
		// pad to correct length to give a table-like layout
		headline += this.$helper._paddingText(headline,columns[0]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-destination&quot;);
		headline += this.$helper._paddingText(headline,columns[1]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-within&quot;);
		headline += this.$helper._paddingText(headline,columns[2]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-deposit&quot;);
		headline += this.$helper._paddingText(headline,columns[3]);
		headline += expandMissionText(&quot;oolite-contracts-cargo-column-fee&quot;);
		// required because of way choices are displayed.
		headline = &quot; &quot;+headline;

		// setting options dynamically; one contract per line
		var options = new Object;
		var i;
		var anyWithSpace = false;
		for (i=0; i&lt;this.$contracts.length; i++) {
				// temp variable to simplify following code
				var cargo = this.$contracts[i];
				// write the description, padded to line up with the headers
				var optionText = this._descriptionForGoods(cargo);
				optionText += this.$helper._paddingText(optionText, columns[0]);
				optionText += System.infoForSystem(galaxyNumber, cargo.destination).name;
				optionText += this.$helper._paddingText(optionText, columns[1]);
				optionText += this.$helper._timeRemaining(cargo);
				optionText += this.$helper._paddingText(optionText, columns[2]);
				// right-align the fee so that the credits signs line up
				var priceText = formatCredits(cargo.deposit,false,true);
				priceText = this.$helper._paddingText(priceText, 3.25)+priceText;
				optionText += priceText
				optionText += this.$helper._paddingText(optionText, columns[3]);
				// right-align the fee so that the credits signs line up
				priceText = formatCredits(cargo.payment-cargo.deposit,false,true);
				priceText = this.$helper._paddingText(priceText, 3.25)+priceText;
				optionText += priceText
				
				// need to pad the number in the key to maintain alphabetical order
				var istr = i;
				if (i &lt; 10) istr = &quot;0&quot;+i;
				// needs to be aligned left to line up with the heading
				options[&quot;01_CONTRACT_&quot;+istr] = { text: optionText, alignment: &quot;LEFT&quot; };

				// check if there&#39;s space for this contract
				if (!this._hasSpaceFor(cargo)) {
						options[&quot;01_CONTRACT_&quot;+istr].color = &quot;darkGrayColor&quot;;
				} else {
						anyWithSpace = true;
						// if there doesn&#39;t appear to be sufficient time remaining
						if (this.$helper._timeRemainingSeconds(cargo) &lt; this.$helper._timeEstimateSeconds(cargo)) options[&quot;01_CONTRACT_&quot;+istr].color = &quot;orangeColor&quot;;
				}
		}
		// if we&#39;ve come from the detail screen, make sure the last
		// contract shown there is selected here
		var icstr = this.$contractIndex;
		if (icstr &lt; 10) icstr = &quot;0&quot;+this.$contractIndex;
		var initialChoice = &quot;01_CONTRACT_&quot;+icstr;
		// if none of them have any space...
		if (!anyWithSpace) initialChoice = &quot;06_EXIT&quot;;

		// next, an empty string gives an unselectable row
		options[&quot;02_SPACER&quot;] = &quot;&quot;;

		// numbered 06 to match the option of the same function in the other branch
		options[&quot;06_EXIT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-quit&quot;);

		// now need to add further spacing to fill the remaining rows, or
		// the options will end up at the bottom of the screen.
		var rowsToFill = 21;
		if (player.ship.hudHidden) rowsToFill = 27;

		for (i = 4 + this.$contracts.length; i &lt; rowsToFill ; i++) {
				// each key needs to be unique at this stage.
				options[&quot;07_SPACER_&quot;+i] = &quot;&quot;;
		}

		var missionConfig = {titleKey: &quot;oolite-contracts-cargo-title-summary&quot;,
												 message: headline,
												 allowInterrupt: true,
												 screenID: &quot;oolite-contracts-cargo-summary&quot;,
												 exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
												 choices: options,
												 initialChoicesKey: initialChoice};
		if (this.$cargoSummaryPageBackground != &quot;&quot;) {
				missionConfig.background = this.$cargoSummaryPageBackground;
		}
		if (this.$cargoPageOverlay != &quot;&quot;) {
				missionConfig.overlay = this.$cargoPageOverlay;
		}

		// now run the mission screen
		mission.runScreen(missionConfig, this._processCargoChoice, this);
		
}


// display the mission screen for the contract detail page
this._cargoContractSinglePage = function()
{
		// temp variable to simplify code
		var cargo = this.$contracts[this.$contractIndex];

		// This mission screen uses the long range chart as a backdrop.
		// This means that the first 18 lines are taken up by the chart,
		// and we can&#39;t put text there without overwriting the chart.
		// We therefore need to hide the player&#39;s HUD, to get the full 27
		// lines.

		if (!player.ship.hudHidden)
		{
				this.$suspendedHUD = true; // note that we hid it, for later
				player.ship.hudHidden = true;
		}

		// We also set the player&#39;s witchspace destination temporarily
		// so we need to store the old one in a variable to reset it later
		this.$suspendedDestination = player.ship.targetSystem;

		// That done, we can set the player&#39;s destination so the map looks
		// right.
		player.ship.targetSystem = cargo.destination;

		// start with 18 blank lines, since we don&#39;t want to overlap the chart
		var message = new Array(18).join(&quot;\n&quot;);
		
		message += expandMissionText(&quot;oolite-contracts-cargo-long-description&quot;,{
				&quot;oolite-contracts-cargo-longdesc-goods&quot;: this._descriptionForGoods(cargo),
				&quot;oolite-contracts-cargo-longdesc-destination&quot;: this.$helper._systemName(cargo.destination),
				&quot;oolite-contracts-cargo-longdesc-deadline&quot;: this.$helper._timeRemaining(cargo),
				&quot;oolite-contracts-cargo-longdesc-time&quot;: this.$helper._timeEstimate(cargo),
				&quot;oolite-contracts-cargo-longdesc-payment&quot;: formatCredits(cargo.payment,false,true),
				&quot;oolite-contracts-cargo-longdesc-deposit&quot;: formatCredits(cargo.deposit,false,true)
		});

		// use a special background
		var backgroundSpecial = &quot;LONG_RANGE_CHART&quot;;
		
		// the available options will vary quite a bit, so this rather
		// than a choicesKey in missiontext.plist
		var options = new Object;
		// this is the only option which is always available
		options[&quot;06_EXIT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-quit&quot;);
		
		// if the player has sufficient space
		if (this._hasSpaceFor(cargo)) {
				options[&quot;05_ACCEPT&quot;] = {text: expandMissionText(&quot;oolite-contracts-cargo-command-accept&quot;)};
				
				// if there&#39;s not much time left, change the option colour as a warning!
				if (this.$helper._timeRemainingSeconds(cargo) &lt; this.$helper._timeEstimateSeconds(cargo)) options[&quot;05_ACCEPT&quot;].color = &quot;orangeColor&quot;;
		} else {
				options[&quot;05_UNAVAILABLE&quot;] = {
						text: expandMissionText(&quot;oolite-contracts-cargo-command-unavailable&quot;),
						color: &quot;darkGrayColor&quot;,
						unselectable: true
				};
		}

		// if the ship has a working advanced nav array, can switch
		// between &#39;quickest&#39; and &#39;shortest&#39; routes
		// (and also upgrade the special background)
		if (player.ship.equipmentStatus(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
				backgroundSpecial = this.$routeMode;
				if (this.$routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;){
						options[&quot;01_MODE&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-ana-quickest&quot;);
				} else {
						options[&quot;01_MODE&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-ana-shortest&quot;);
				}
		}
		// if there&#39;s more than one, need options for forward, back, and listing
		if (this.$contracts.length &gt; 1) {
				options[&quot;02_BACK&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-back&quot;);
				options[&quot;03_NEXT&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-next&quot;);
				options[&quot;04_LIST&quot;] = expandMissionText(&quot;oolite-contracts-cargo-command-list&quot;);
		} else {
				// if not, we may need to set a different choice
				// we never want 05_ACCEPT to end up selected initially
				if (this.$lastChoice === &quot;02_BACK&quot; || this.$lastChoice === &quot;03_NEXT&quot; || this.$lastChoice === &quot;04_LIST&quot;) this.$lastChoice = &quot;06_EXIT&quot;;
		}

		var title = expandMissionText(&quot;oolite-contracts-cargo-title-detail&quot;,{
				&quot;oolite-contracts-cargo-title-detail-number&quot;: this.$contractIndex+1,
				&quot;oolite-contracts-cargo-title-detail-total&quot;: this.$contracts.length
		});

		// finally, after all that setup, actually create the mission screen

		var missionConfig = {
				title: title,
				message: message,
				allowInterrupt: true,
				screenID: &quot;oolite-contracts-cargo-details&quot;,
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
				backgroundSpecial: backgroundSpecial,
				choices: options,
				initialChoicesKey: this.$lastChoice
		};

		if (this.$cargoPageOverlay != &quot;&quot;) {
				missionConfig.overlay = this.$cargoPageOverlay;
		}

		mission.runScreen(missionConfig,this._processCargoChoice, this);
}


this._processCargoChoice = function(choice)
{
		this._resetViews();
		if (choice === null) return;	// can occur if ship launches mid mission screen

		// now process the various choices
		if (choice.match(/^01_CONTRACT_/)) {
				// contract selected from summary page
				// set the index to that contract, and show details
				var index = parseInt(choice.slice(12),10);
				this.$contractIndex = index;
				this.$lastChoice = &quot;04_LIST&quot;;
				this._cargoContractsDisplay(false);
		} else if (choice === &quot;01_MODE&quot;) {
				// advanced navigation array mode flip
				this.$routeMode = (this.$routeMode === &quot;LONG_RANGE_CHART_SHORTEST&quot;)?&quot;LONG_RANGE_CHART_QUICKEST&quot;:&quot;LONG_RANGE_CHART_SHORTEST&quot;;
				this.$lastChoice = &quot;01_MODE&quot;;
				this._cargoContractsDisplay(false);
		} else if (choice === &quot;02_BACK&quot;) {
				// reduce contract index (cargoContractsDisplay manages wraparound)
				this.$contractIndex--;
				this.$lastChoice = &quot;02_BACK&quot;;
				this._cargoContractsDisplay(false);
		} else if (choice === &quot;03_NEXT&quot;) {
				// increase contract index (cargoContractsDisplay manages wraparound)
				this.$contractIndex++;
				this.$lastChoice = &quot;03_NEXT&quot;;
				this._cargoContractsDisplay(false);
		} else if (choice === &quot;04_LIST&quot;) {
				// display the summary page
				this._cargoContractsDisplay(true);
		} else if (choice === &quot;05_ACCEPT&quot;) {
				this._acceptContract();
				// do not leave the setting as accept for the next contract!
				this.$lastChoice = &quot;03_NEXT&quot;;
				this._cargoContractsDisplay(false);
		}
		// if we get this far without having called cargoContractsDisplay
		// that means either &#39;exit&#39; or an unrecognised option was chosen
}


// move goods from the contracts list to the player&#39;s ship (if possible)
this._acceptContract = function()
{
	var cargo = this.$contracts[this.$contractIndex];

	if (cargo.deposit &gt; player.credits) {
		this.$helper._soundFailure();
		return;
	}

	// give the cargo to the player
/*
For half-sized cargo contracts...
cargo.size must be divided by 2 into 2 contracts, with 1 rounded up and the other rounded down.
cargo.payment likewise must be divided by 2 into 2 contracts, with 1 rounded up and the other rounded down.
cargo.deposit likewise must be divided by 2 into 2 contracts, with 1 rounded up and the other rounded down.

These must remain unchanged:
cargo.destination
cargo.route
cargo.deadline = clock.adjustedSeconds + Math.floor(daysUntilDeparture*86400)+(cargo.route.time*3600);
cargo.commodity
*/
// Split cargo contract into 2 half-sized contracts if the deadline is &gt;6 days or cargo size is &gt;99 TC
//	if(cargo.deadline &gt; (clock.adjustedSeconds + 6*86400) || (cargo.size &gt; 99 &amp;&amp; system.mainStation.market[cargo.commodity].quantityUnit == 0)) {
	if(cargo.route.time &gt; 6*(24-player.contractReputationPrecise) || (cargo.size &gt; 99 &amp;&amp; system.mainStation.market[cargo.commodity].quantityUnit == 0)) {
		var scratchval = Math.floor(cargo.size *0.5);
		cargo.size = Math.ceil(cargo.size *0.5);
		cargo.payment = Math.ceil(cargo.payment *0.5);
		cargo.deposit = Math.ceil(cargo.deposit *0.5);
		var result = player.ship.awardContract(cargo.size,cargo.commodity,system.ID,cargo.destination,cargo.deadline,cargo.payment,cargo.deposit);
		if (result) player.credits -= cargo.deposit;
		cargo.size = scratchval;
	}

	var result = player.ship.awardContract(cargo.size,cargo.commodity,system.ID,cargo.destination,cargo.deadline,cargo.payment,cargo.deposit);
		
	if (result) {
		// pay the deposit
		player.credits -= cargo.deposit;

		// remove the contract from the station list
		this.$contracts.splice(this.$contractIndex,1);

		// update the interface description
		this._updateMainStationInterfacesList();

		this.$helper._soundSuccess();
	} else {
		// else must have had manifest change recently (unlikely, but another OXP could have done it)
		this.$helper._soundFailure();
	}
}


// removes any expired contracts
this._validateContracts = function()
{
	var c = this.$contracts.length-1;
	var removed = false;
	// iterate downwards so we can safely remove as we go
	for (var i=c;i&gt;=0;i--) {
		// if the time remaining is less than 1/3 of the estimated
		// delivery time, even in the best case it&#39;s probably not
		// going to get there.
		if (this.$helper._timeRemainingSeconds(this.$contracts[i]) &lt; this.$helper._timeEstimateSeconds(this.$contracts[i]) / 3) {
			// remove it
			this.$contracts.splice(i,1);
			removed = true;
		}
	}
	if (removed) {
		// update the interface description if we removed any
		this._updateMainStationInterfacesList();
	}
}


/* Utility functions */

// calculates a sample price for a commodity in a distant system
//this._priceForCommodity = function(commodity,economy)
this._priceForCommodity = function(commodity,economy,rnd)
{
//	var rnd = Math.floor(Math.random()*256);
	var price = 0.4*(Math.floor(parseInt(commodity.marketBasePrice,10) + (rnd &amp; parseInt(commodity.marketMaskPrice,10)) + (economy*parseInt(commodity.marketEcoAdjustPrice,10)))&amp;255);
	return price;
}

// description of the cargo
this._descriptionForGoods = function(cargo)
{
		var unit = &quot;tons&quot;;
		if (system.mainStation.market[cargo.commodity].quantityUnit == &quot;1&quot;) {
				unit = &quot;kilograms&quot;;
		} else if (system.mainStation.market[cargo.commodity].quantityUnit == &quot;2&quot;) {
				unit = &quot;grams&quot;;
		}
		return cargo.size+expandDescription(&quot;[cargo-&quot;+unit+&quot;-symbol]&quot;)+&quot; &quot;+displayNameForCommodity(cargo.commodity);
}

// check if player&#39;s ship has space for the cargo and can afford the deposit
this._hasSpaceFor = function(cargo)
{
		if (cargo.deposit &gt; player.credits) return false;
		var amountInTC = cargo.size;
		if (system.mainStation.market[cargo.commodity].quantityUnit == &quot;1&quot;) {
				var spareSafe = 499-(player.ship.manifest[cargo.commodity] % 1000);
				amountInTC -= spareSafe;
				amountInTC = Math.ceil(amountInTC/1000);
				if (amountInTC &lt; 0) amountInTC = 0;
		} else if (system.mainStation.market[cargo.commodity].quantityUnit == &quot;2&quot;) {
				var spareSafe = 499999-(player.ship.manifest[cargo.commodity] % 1000000);
				amountInTC -= spareSafe;
				amountInTC = Math.ceil(amountInTC/1000000);
				if (amountInTC &lt; 0) amountInTC = 0;
		}

		return (amountInTC &lt;= player.ship.cargoSpaceAvailable);
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
