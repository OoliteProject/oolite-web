<html>
    <head>
        <title>Expansion Tionisla Chronicle Array</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Tionisla Chronicle Array</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">18 Equipment</a></li>
          <li><a href="#ships">5 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Adds the Tionisla Chronicle array to the Tionisla system. An array is also added to one system in each galactic sector.</td>
                    <td>Adds the Tionisla Chronicle array to the Tionisla system. An array is also added to one system in each galactic sector.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Storm.TionislaChronicleArray</td>
                    <td>oolite.oxp.Storm.TionislaChronicleArray</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Tionisla Chronicle Array</td>
                    <td>Tionisla Chronicle Array</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Dockables</td>
                    <td>Dockables</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Storm</td>
                    <td>Storm</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.05</td>
                    <td>1.05</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/4/49/TionislaChronicleArray.oxz">https://wiki.alioth.net/img_auth.php/4/49/TionislaChronicleArray.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1686145539</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Tionisla%20Chronicle%20Array'>http://wiki.alioth.net/index.php/Tionisla%20Chronicle%20Array</a></p>
        <h3>Readme.txt</h3>
        <pre>TIONISLA CHRONICLE ARRAY OXP (Version 1.04)

This OXP will add a few new broadcast arrays throughout the eight galactic charts.

The famous Tionisla Chronicle Array can be found in orbit on the dark side of Tionisla (Chart 1)

You will also be able to find:

The Views of the Worlds Array   (Xeabiti, Chart 2)
The GNN Array                   (Geusdi, Chart 3)
The Daily Wail Array            (Quonzo, Chart 4)
The G5TVN Array                 (Maeser, Chart 5)
The Rooters Array               (Tiregees, Chart 6)
The StarSports Array            (Zarausxe, Chart 7)
The Snoopers Array              (Maabile, Chart 8)

(StarSports being my own &#39;channel&#39; creation)

Please Note that:

Broadcast Arrays have a hexagon icon for the Advanced Space Compass to help you locate them.
No market or extra equipment (except fuel) are available at the TCA (though other OXP&#39;s might effect this)

In future versions, you can expect*
- Texturing / shaders / lighting improvements
- Missions

(*as authors free time allows)

This OXP is requires Oolite v1.79

Author: Storm

To install this OXP the &#39;.oxp&#39; folder should be moved to your Oolite AddOns folder. Consult the Wiki or BB if you are not sure where this is. 

This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/ or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.

My thanks to:
Drew for letting me use the TCA from his stories!
DaddyHoggy, Svengali, Drew and Disembodied for GNN, Rooters and Snoopers
DaddyHoggy again for Views of the Worlds and the Daily Wail
Smivs for G5TVN
Arhuman, Griff and Thargoid for the various shader and script snippets (large and small) I borrowed from their own OXP&#39;s to get this one working!
Okti for the assistance in putting the TCA into orbit in the right position and getting this Beta properly in order for initial release!
Cim for the workaround script advice for the logo changing on the docking display screen
Fatleaf and Commander McLane for the help in bugfixing shader scripts
... and various others for the bug reports!

Version History:
V1.01 - 18/03/12: Slight fix to shader .fragment files for older OpenGL issues
V1.02 - 18/03/12: Another slight fix, hoping to get more of those .fragment issues resolved
V1.03 - 19/03/12: The docking display &#39;billboards&#39; should now be correctly scrolling for older OpenGL versions
V1.04 - 08/11/17: (phkb) Updated populator to allow for saving at stations. Texture update. Packaged as OXZ.
V1.05 - 03/06/23: (Alnivel) Moved Tionisla Reporter mission to the station. Added limited shipyard and a few LibPAD entries.</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ADVANCED_NAVIGATIONAL_ARRAY_TCA.html">Advanced Navigational Array</a></td>
                    <td>yes</td>
                    <td align="right">22500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_BROADCASTCOMMSMFD_REMOVAL_TCA.html">Remove Broadcast Comms MFD</a></td>
                    <td>no</td>
                    <td align="right">500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_BROADCASTCOMMSMFD_TCA.html">Broadcast Comms MFD</a></td>
                    <td>yes</td>
                    <td align="right">2000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ELECTRONIC_THUMB_TCA.html">Electronic Thumb</a></td>
                    <td>yes</td>
                    <td align="right">9850</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_FUEL_INJECTION_TCA.html">Witchdrive Fuel Injectors</a></td>
                    <td>yes</td>
                    <td align="right">6000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_GCM_RANGE_FINDER_EXTENDER_TCA.html">Range Finder Extender</a></td>
                    <td>yes</td>
                    <td align="right">26500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_GCM_RANGE_FINDER_EXT_REMOVAL_TCA.html">Remove Range Finder MFD</a></td>
                    <td>yes</td>
                    <td align="right">15000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_GCM_RANGE_FINDER_MFD_TCA.html">Range Finder MFD</a></td>
                    <td>yes</td>
                    <td align="right">2500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_GCM_RANGE_FINDER_REMOVAL_TCA.html">Remove Range Finder MFD</a></td>
                    <td>yes</td>
                    <td align="right">1000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_MC_DESCRAMBLER_TCA.html">Mining Beacon Descrambler</a></td>
                    <td>yes</td>
                    <td align="right">500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SCANNER_ALERTING_ENHANCEMENT_TCA.html">Scanner Alerting Enhancement</a></td>
                    <td>yes</td>
                    <td align="right">7500</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SHIPS_LIBRARY_TCA.html">Ship&#39;s Library Flight Interface</a></td>
                    <td>yes</td>
                    <td align="right">2000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TEAPOT_TCA.html">Express Tea Maker</a></td>
                    <td>yes</td>
                    <td align="right">1000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_TRACKER_TCA.html">Tracker</a></td>
                    <td>yes</td>
                    <td align="right">25000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_VIMANA_SHIP_MODULE_TCA.html">Target Mod</a></td>
                    <td>yes</td>
                    <td align="right">15000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_VIMANA_TARGET_MODULE_TCA.html">Target Mod</a></td>
                    <td>yes</td>
                    <td align="right">25000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_VIMANA_TRAVEL_MODULE_TCA.html">Travel Mod</a></td>
                    <td>yes</td>
                    <td align="right">10000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WORMHOLE_SCANNER_TCA.html">Wormhole Scanner</a></td>
                    <td>yes</td>
                    <td align="right">23950</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/broadcast_array.html">Broadcast Array</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/broadcast_array_arm.html">Broadcast Array Arm</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/broadcast_array_beacon.html">Broadcast Array Navbouy</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/broadcast_array_display.html">Broadcast Array Display Screen</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/broadcast_array_dock.html">Broadcast Array Docking Port</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/tca_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Tionisla Chronicle Array - Equipment Conditions&quot;;


this.$oxpPostfix = &quot;_TCA&quot;;
this.$oxpEqPostfixOffset = -this.$oxpPostfix.length;

this.allowAwardEquipment = function(equipmentKey, ship, _context)
{
    const station = player.ship.dockedStation;
    if(!station || station.dataKey !== &quot;broadcast_array&quot;) {
        return false;
    }

    const tail = equipmentKey.slice(this.$oxpEqPostfixOffset);
    if(tail !== this.$oxpPostfix) {
        log(&quot;Tionisla Chronicle Array&quot;, &quot;Equipment key doesn&#39;t have correct postfix.&quot;);
        return false; // or true?
    }

    const originalEquipmentKey = equipmentKey.slice(0, this.$oxpEqPostfixOffset);
    
    return ship.canAwardEquipment(originalEquipmentKey);
}

this.updateEquipmentPrice = function(equipmentKey, currentPrice)
{
    const originalEquipmentKey = equipmentKey.slice(0, this.$oxpEqPostfixOffset);
    const equipmentInfo = EquipmentInfo.infoForKey(originalEquipmentKey);
    if(!equipmentInfo) {
        log(&quot;Tionisla Chronicle Array&quot;, &quot;There is no \&quot;&quot; + originalEquipmentKey + &quot;\&quot; key&quot;);
        return currentPrice;
    }

    const employeeDiscount = galaxyNumber === 0 &amp;&amp; missionVariables.tionisla_tr_finale === &quot;SUCCESS&quot;;
    const priceMult = 1 - (employeeDiscount? 0.25 : 0.1)

    return equipmentInfo.calculatedPrice * priceMult;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/tca_conditions_removal.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Tionisla Chronicle Array - Equipment Removal Conditions&quot;;


this.allowAwardEquipment = function(_equipmentKey, _ship, _context) 
{
    const station = player.ship.dockedStation;

    return station &amp;&amp; station.dataKey === &quot;broadcast_array&quot;;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/tca_script.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name			= &quot;Tionisla Chronicle Array OXP&quot;;
this.author			= &quot;Storm&quot;;
this.copyright		= &quot;Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license&quot;;
this.description	= &quot;Addition of a Broadcast Array station to each galactic chart&quot;;

// Arrays for the Broadcast Arrays locations by planet, their shipdata.plist names, and &#39;channel&#39; name 
this.broadcastArrayPlanet = [124, 103, 197, 58, 211, 225, 184, 206];
this.broadcastArrayName = [&quot;Tionisla Chronicle&quot;, &quot;Views of the Worlds&quot;, &quot;GNN&quot;, &quot;Daily Wail&quot;, &quot;G5TVN&quot;, &quot;Rooters&quot;, &quot;StarSports&quot;, &quot;Snoopers&quot;];
this.broadcastChannel = [&quot;tca&quot;, &quot;votw&quot;, &quot;gnn&quot;, &quot;dailywail&quot;, &quot;g5tvn&quot;, &quot;rooters&quot;, &quot;starsports&quot;, &quot;snoopers&quot;];
this._debug = false;

this.systemWillPopulate = function() {
	// Check if in a system where a Broadcast Array is based, and add if so...
	if(system.ID == this.broadcastArrayPlanet[galaxyNumber] || this._debug === true) {
		if(system.countShipsWithRole(&quot;broadcast_array&quot;) == 0) {
			// Work out the location for placement of the Broadcast Array and it&#39;s beacon...
			var vector = system.mainPlanet.position.subtract(system.sun.position).direction();
			var arraypos = system.mainPlanet.position.add(vector.multiply(system.mainPlanet.radius * 4));

			system.setPopulator(&quot;tca&quot;, {
				priority: 200,
				location: &quot;COORDINATES&quot;,
				groupCount: 1,
				callback: function(pos) {
					var tca = worldScripts[&quot;Tionisla Chronicle Array OXP&quot;];
					// Add Broadcast Array to system...
					var broadcastArray = system.addShips(&quot;broadcast_array&quot;, 1, pos, 0)[0];
					broadcastArray.orientation = system.mainPlanet.position.subtract(broadcastArray.position).direction().rotationTo([0, 0, 1]);
					broadcastArray.scannerDisplayColor1 = &quot;25 100 175&quot;;
					broadcastArray.scannerDisplayColor2 = &quot;50 150 255&quot;;

					var vect = system.mainPlanet.position.subtract(system.sun.position).direction();
							
					// Add the Broadcast Array&#39;s Beacon to system...
					var buoyPos = system.mainPlanet.position.add(vect.multiply((system.mainPlanet.radius * 4) - 10000));
					var navbuoy = system.addShips(&quot;broadcast_array_beacon&quot;, 1, buoyPos, 0)[0];
					navbuoy.orientation = system.mainPlanet.position.subtract(broadcastArray.position).direction().rotationTo([0,0,1]);
					// Change the Broadcast Array&#39;s docking display / beacon to match the appropriate &#39;channel&#39;...
					broadcastArray.displayName = (tca.broadcastArrayName[galaxyNumber] + &quot; Array&quot;);
					broadcastArray.beaconLabel = (tca.broadcastArrayName[galaxyNumber] + &quot; Array&quot;);
					var broadcastDisplayEmissionPng = (tca.broadcastChannel[galaxyNumber] + &quot;_display_emission_map.png&quot;);
					broadcastArray.subEntities[4].setMaterials(
						{&quot;broadcast_array_display.png&quot;:{diffuse_map: &quot;broadcast_array_display.png&quot;, emission_map: broadcastDisplayEmissionPng}}
					);
					// Can&#39;t pass galaxy number to shader so hack to pass it via &#39;fuel&#39; instead... this will allow
					// the broadcast arrays scrolling display in dock to &#39;change channel&#39; to appropriate galaxy
					broadcastArray.fuel = galaxyNumber / 10;
					navbuoy.displayName = (tca.broadcastArrayName[galaxyNumber] + &quot; Navigation Buoy&quot;);
					var navbuoyPng = (tca.broadcastChannel[galaxyNumber] + &quot;_beacon.png&quot;);
					navbuoy.setMaterials({&quot;broadcast_array_beacon.png&quot;: { diffuse_map: navbuoyPng }});

				},
				coordinates:arraypos,
				deterministic:true
			});
		}		
	}
}

this.shipWillLaunchFromStation = function(station) {
	if(station.hasRole(&quot;broadcast_array&quot;)) {
		missionVariables.trumbles = missionVariables.broadcastArray_storeTrumble; 
		// reactivate offer of trumble mission if it was available before docking
		missionVariables.broadcastArray_storeTrumble = null;
	}
}

this.shipWillDockWithStation = function(station) {
	if(station.hasRole(&quot;broadcast_array&quot;)) {
		// delay offer of trumble mission whilst docked at a broadcast array
		missionVariables.broadcastArray_storeTrumble = missionVariables.trumbles;
		missionVariables.trumbles = null;
	} 
}

/* Monkey-patch for TR - added by Alnivel and therefore and therefore all the blame on him */

this.startUp = function startUp() {
    const tr = worldScripts[&quot;Tionisla Reporter&quot;];
    if (tr) {
        tr.$TCA_addErewhonPADPages = this.$TCA_addErewhonPADPages;
        tr.$TCA_missionOffers_original = tr.missionOffers;
        tr.missionOffers = this.$TCA_missionOffers_replacement;
        tr.$TCA_choiceEvaluation_preamble = this.$TCA_choiceEvaluation_preamble;
    }

    this.$trScript = tr;
};

this.startUpComplete = function startUpComplete() {
	if (this.$trScript) {
        if (!missionVariables.tca_tr_erehwonVisited) {
            missionVariables.tca_tr_erehwonVisited = +(
                missionVariables.tca_tr_finale === &quot;SUCCESS&quot; ||
                missionVariables.erehwonGotStory === &quot;YES&quot;
            );
        }        
    }

    const Lib_PAD = this.$Lib_PAD = worldScripts.Lib_PAD;

	if(Lib_PAD) {
		Lib_PAD._addPageInCategory(&quot;SYSTEMS.Tionisla G1&quot;,
			{
				name: &quot;Tionisla G1&quot;,
				info: [
					&quot;Located in the south-west of Galaxy 1.&quot;,
					&quot;The Lizards of Tionisla wears mechanical masks in public.&quot;,
					&quot;Home of the Tionisla Orbital GraveYard (TOGY).&quot;,
					&quot;Home of the Tionisla Chronicle and its Array (TCA).&quot;
				]
			});
		if (missionVariables.tca_tr_erehwonVisited) {
			this.$TCA_addErewhonPADPages();
		}
        if(missionVariables.tca_intro) {
            this.$addTCAPADPages();
        }
	}    
};

this.$addTCAPADPages = function $addTCAPADPages() {
    const Lib_PAD = this.$Lib_PAD;
    if (!Lib_PAD)
        return;

    Lib_PAD._addPageInCategory(&quot;INFOS.Tionisla Chronicle Array&quot;,
        { // Page content
            name: &quot;Tionisla Chronicle Array&quot;,
            beacon: &quot;Tionisla Chronicle Array&quot;,
            location: &quot;In high orbit on the dark side of Tionisla&quot;,
            purpose: &quot;Massive communications platform&quot;,
            special: [
                // Results of the missions?
            ],
            t1: &quot;tca_lib_pad_tca.png&quot;
        }, 
        [ // Page parents
            &quot;SYSTEMS.Tionisla G1&quot;
        ]);
}

this.missionScreenOpportunity = function missionScreenOpportunity() {
    if (galaxyNumber === 0 &amp;&amp; system.ID == 124) {
        const dockedStation = player.ship.dockedStation;

        if (dockedStation.dataKey === &quot;broadcast_array&quot; &amp;&amp; !missionVariables.tca_intro) {
            missionVariables.tca_intro = 1;
            mission.runScreen({
                screenID: &quot;tca_intro&quot;,
                title: &quot;Tionisla Chronicle Array&quot;,
                messageKey: &quot;tca_intro&quot;
            });
            this.$addTCAPADPages();
        }
    }
};


this.shipDockedWithStation = function (station) {
    if (station.displayName === &quot;Erehwon Station&quot;) {
        missionVariables.tca_tr_erehwonVisited = 1;
        this.$TCA_addErewhonPADPages();
    }
};

this.$TCA_addErewhonPADPages = function $TCA_addErewhonPADPages() {
	const Lib_PAD = worldScripts.Lib_PAD;
	if(!Lib_PAD)
		return

	Lib_PAD._addPageInCategory(&quot;SYSTEMS.Erewhon G1&quot;,
        {
            name: &quot;Erewhon G1&quot;,
            info: [
                &quot;Located in the centre-west of Galaxy 1.&quot;,
                &quot;rare metals etc. Imports food, liquor, narcotics &amp; slaves.&quot;,
                &quot;Planet is inhabited by lizards &amp; rich in mineral deposits,&quot;,
                &quot;&#39;Lost&#39; planet in interstellar space between Biorle &amp; Usle.&quot;
            ]
        });
};


this.$TCA_missionOffers_replacement = function missionOffers_TionislaChronicleArray() {
    // this === worldScripts[&quot;Tionisla Reporter&quot;]
    const dockedStation = player.ship.dockedStation;
    const erehwonReconnaissance = missionVariables.erehwonReconnaissance;

    let passToOriginalHandler = true;

    if (system.ID == 124) { // Tionisla
        passToOriginalHandler = false;

        
        if (dockedStation.isMainStation &amp;&amp;
            erehwonReconnaissance === &quot;START&quot; &amp;&amp;
            !missionVariables.tca_tr_lureWasShown) {

            mission.runScreen({
                screenID: &quot;tionisla_reporter&quot;,
                title: &quot;Tionisla Chronicle&quot;,
                messageKey: &quot;tca_erehwonReconnaissance_lure&quot;
            });
            missionVariables.tca_tr_lureWasShown = 1;
        }
        else if (dockedStation.dataKey === &quot;broadcast_array&quot;) {
            // Do not show scene on main station if we already was at broadcast array
            missionVariables.tca_tr_lureWasShown = 1;

            if (erehwonReconnaissance === &quot;START&quot;) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_preamble&quot;,
                    choicesKey: &quot;tca_erehwonReconnaissance_choice0&quot;
                }, this.$TCA_choiceEvaluation_preamble
                );
            }
            else if (erehwonReconnaissance === &quot;SUCCESS&quot;) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_debriefing&quot;,
                    model: &quot;erehwonStation&quot;
                }
                );
                mission.displayModel.orientation = [0.75, 0, -0.6, 0];
                delete missionVariables.erehwonGotStory;
                delete missionVariables.erehwonFotoShot;
                delete missionVariables.erehwonPictureCount;

                delete missionVariables.erehwomMisJumpInfo;
                missionVariables.erehwonReconnaissance = &quot;EPILOGUE&quot;;
                missionVariables.erehwonEpilogue = 1;
                missionVariables.erehwonActiontime = clock.days + 30;
                player.ship.removeEquipment(&quot;EQ_EREHWON_PHOTOCAMERA&quot;);
                mission.setInstructionsKey(null);
                this.$unmarkSystem(124);
                player.credits += 500;

                // 
                missionVariables.tca_tr_finale = &quot;SUCCESS&quot;;
                //
            }
            else if (erehwonReconnaissance === &quot;ACCEPTED&quot; &amp;&amp;
                missionVariables.erehwonPictureCount == 0 &amp;&amp; missionVariables.erehwonFotoShot === &quot;NO&quot;) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_failure&quot;,
                    choicesKey: &quot;erehwonReconnaissance_choice2&quot;
                }, this.choiceEvaluation
                );
            }
            else if (erehwonReconnaissance === &quot;ACCEPTED&quot; &amp;&amp;
                player.ship.equipmentStatus(&quot;EQ_EREHWON_PHOTOCAMERA&quot;) === &quot;EQUIPMENT_DAMAGED&quot;) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_damaged&quot;,
                    choicesKey: &quot;erehwonReconnaissance_choice2&quot;
                }, this.choiceEvaluation
                );
            }
        }
        else if(erehwonReconnaissance === &quot;FINISHED&quot; || erehwonReconnaissance === &quot;EPILOGUE&quot;){
            passToOriginalHandler = true;
        }
    }

    if(passToOriginalHandler) {
        // &quot;DECLINED&quot; is set in mission screen callback, so check at next mission screen opportunity
        if (missionVariables.erehwonReconnaissance === &quot;DECLINED&quot;) {
            missionVariables.tca_tr_finale = &quot;DECLINED&quot;;
        }

        this.$TCA_missionOffers_original();

        if (dockedStation.displayName === &quot;Erehwon Station&quot; &amp;&amp; missionVariables.erehwonReconnaissance === &quot;SUCCESS&quot;) {
            mission.setInstructionsKey(&quot;tca_erehwonReconnaissance_missioninfo2&quot;);
        }
    }


};

this.$TCA_choiceEvaluation_preamble = function (choice) {
    switch (choice) {
        case &quot;OFFER_ACCEPTED&quot;:
            // If the mission screen has no choices then the callback&#39;s choice argument is null
            // Can (and should) I somehow distinguish if screen was ended with Space or interupted with F1?
            // If yes, then F1 == OFFER_DECLINED?

            let runPart3Callback = function (choice) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_briefing_p3&quot;,
                    choicesKey: &quot;erehwonReconnaissance_choice&quot;
                }, this.choiceEvaluation
                );
            };

            let runPart2Callback = function (choice) {
                mission.runScreen({
                    screenID: &quot;tionisla_reporter&quot;,
                    title: &quot;Tionisla Chronicle&quot;,
                    messageKey: &quot;tca_erehwonReconnaissance_briefing_p2&quot;
                }, runPart3Callback
                );
            };

            mission.runScreen({
                screenID: &quot;tionisla_reporter&quot;,
                title: &quot;Tionisla Chronicle&quot;,
                messageKey: &quot;tca_erehwonReconnaissance_briefing_p1&quot;
            }, runPart2Callback
            );

            break;
        case &quot;OFFER_DECLINED&quot;:
            missionVariables.erehwonReconnaissance = &quot;DECLINED&quot;;
            missionVariables.erehwonActiontime = clock.days + 30;
            break;
    }
};

/*** Limited shipyard with discount ***/
this.$oxpEqPostfix = &quot;_TCA&quot;;
this.$oxpEqPostfixOffset = -this.$oxpEqPostfix.length;

this.$removalEqInfix = &quot;_REMOVAL&quot;;
this.$removalEqInfixOffset = -this.$removalEqInfix.length + this.$oxpEqPostfixOffset;

this.playerBoughtEquipment = function playerBoughtEquipment(equipmentKey) {
    const postfix = equipmentKey.slice(this.$oxpEqPostfixOffset);
    if (postfix !== this.$oxpEqPostfix) {
        return;
    }

    const infix = equipmentKey.slice(this.$removalEqInfixOffset, this.$oxpEqPostfixOffset);
    if (infix === this.$removalEqInfix) {
        let originalEquipmentKey = equipmentKey.slice(0, this.$removalEqInfixOffset);
        let removalEquipmentKey = equipmentKey.slice(0, this.$oxpEqPostfixOffset);
        let ps = player.ship;

        switch (originalEquipmentKey) { // there may be some nontrivial cases
            case &quot;EQ_GCM_RANGE_FINDER&quot;:
                originalEquipmentKey = &quot;EQ_GCM_RANGE_FINDER_MFD&quot;;
            case &quot;EQ_GCM_RANGE_FINDER_EXT&quot;:
                let ws = worldScripts.GalCopBB_RangeFinder_MFD;
                ps.removeEquipment(equipmentKey);
                ws.playerBoughtEquipment(removalEquipmentKey);
                break;
            default:
                ps.removeEquipment(equipmentKey);
                ps.removeEquipment(originalEquipmentKey);
                // No money back?
                break;
        }

    }
    else {
        let originalEquipmentKey = equipmentKey.slice(0, this.$oxpEqPostfixOffset);

        let success = false;
        switch (originalEquipmentKey) { // there may be some nontrivial cases
            default:
                player.ship.removeEquipment(equipmentKey);
                success = player.ship.awardEquipment(originalEquipmentKey);
                break;
        }

        if (!success) {
            log(&quot;Tionisla Chronicle Array&quot;, &quot;Failed to award player with \&quot;&quot; + originalEquipmentKey + &quot;\&quot; when processing \&quot;&quot; + equipmentKey + &quot;\&#39;&quot;);
        }
    }

};
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
