<html>
    <head>
        <title>Expansion Carriers</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Carriers</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">23 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Build up your personal fleet and take with you on your Carrier. Requires EscortDeck OXP and Ship Storage Helper OXP.</td>
                    <td>Build up your personal fleet and take with you on your Carrier. Requires EscortDeck OXP and Ship Storage Helper OXP.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Carriers</td>
                    <td>oolite.oxp.Norby.Carriers</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Carriers</td>
                    <td>Carriers</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ships</td>
                    <td>Ships</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.10</td>
                    <td>0.10</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.Norby.EscortDeck:1.1</li>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.22</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Norby.EscortDeck:1.1</li>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.22</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Norby.EscortPack:1.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Norby.EscortPack:1.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Carriers">http://wiki.alioth.net/index.php/Carriers</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/d0/Carriers_0.10.oxz">https://wiki.alioth.net/img_auth.php/d/d0/Carriers_0.10.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4.0</td>
                    <td>CC BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1630137493</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Carriers'>http://wiki.alioth.net/index.php/Carriers</a></p>
        <h3>Carriers_readme.txt</h3>
        <pre>Carriers OXP

Requires EscortDeck and Ship Storage Helper, recommends EscortPack OXP.

When this addon will be finished then you can build up your escort fleet on the decks of a Carrier and you can sit into any escort ship to fight within a much faster and agile ship if needed.

The hull of a Carrier can hold up to 10 escort ships and barely fit into a standard 64m x 192m x 250m dock together with the carried ships. You can check your escorts in external views by pressing the &quot;v&quot; key.

Please select the configuration of your Escort Deck by purchasing either the default (for trading and salvaging) or the XL equipment (for combat).


Escort Deck equipment

Prime this equipment to launch and call back your escorts.

The default configuration allow 9 ships on board: 2 big traders (Anaconda), 2 ships up to Cobra Mark III and 5 escort ships: 1 heavy (Asp), 2 small (Gecko) and 2 mini (Adder). Practical for salvaging more derelict ships in the same time: if you like to earn money with a Towbar then a Carrier is especially useful for you.

Top decks (1.-2.): a large space on the front and another over the middle engine. Can hold ships with less than 130m width, 35m height, 95m length and 800t mass up to Cobra Mark III.

Center deck (3.): on the neck for a heavy escort up to Asp (65x29x95m and 130t), so Krait and Cobra Mark III can&#39;t fit. This deck is lifted over the others a bit to avoid collisions with big Anacondas in main decks or long Fer-De-Lances in front or aft top decks.

Aft side decks (4.-5.): hold small escorts over side engines (65x17x65m and 40t): Adder, Gecko or Sidewinder.

Main decks (6.-7.):  the largest space on the sides can hold a pair of large trader ships up to 90x64x170m and 800t mass: Anaconda, Boa or Python. Anaconda and larger ships will not launch automatically at red alert - not so good fighters, better if not send them into the combat if not forced by hand.
Heavy escorts (Asp) can fit also but if you want more escorts than all other decks can hold then you can change your configutation to the traderless XL Deck (see below).

Good trader ships which can fit into the main decks: D.T.T. Atlas, D.T.T. Cyclops, Python Class Cruiser, Python ET Special.
Large fighter-traders fit here: Granite Python from EscortPack and the very fast and agile Vector.

Forward decks (8-9): on front for two Adders and other mini ships up to 39x15x65m and 30t mass.
You can use these as additional shields on your Carrier if not launched.


For more details please read the documentation of Escort Deck OXP: http://wiki.alioth.net/index.php/EscortDeck


Escort Deck XL equipment

The combat configuration of Carriers can hold 10 fighters: 2 ships up to Cobra Mark III on the top and 8 escorts: 4 heavy (Asp) within the main decks, 2 wide (Krait) over the engines and 2 mini (Adder) on front to give fearsome firepower into your hands. Most pirate groups will flee insantly after you released your fleet.


Sit into an escort ship

You can sit into and launch within a carried escort ship if you change the mode of Escort Deck from &quot;avoid to sit into a selected escort&quot; to &quot;allow&quot; the same option. First prime the deck with &#39;Shift+N&#39;, then press mode key (b) until this message will be displayed after step over your escorts. Press activate (n) to show &quot;allow&quot; instead of &quot;avoid&quot;, then select an usable (non-salvage) escort ship landed on your deck with &#39;b&#39; and use the &#39;n&#39; key to launch yourself within the selected ship.

You can launch in playable ships only (has player role and view positions in shipdata.plist and defined in shipyard.plist at least with chance=0), otherwise the ship will be launched without you. EscortDeck will try to replace the -trader and -pirate suffixes in dataKeys and use the -player variant if available, but in other cases you must make playable by hand in the ship&#39;s OXP.

When you are not in the Carrier you still can check your wingmans on MFD and command them to attack a target by locking it and delivering a laser hit.

For landing you must hold your ident lock (using &#39;r&#39;) on your Carrier to get landing clearance, then approach within 500m and less than 100m/s speed difference to start the landing sequence. You will be transferred into the bridge of Carrier after the docking tunnel.

Unfortunately you can not sit into a ship with 0 max.missiles like standard Krait, Mamba and Sidewinder due to a core bug. Buyable Sidewinder Escorts has 1 max.missiles just to avoid this and allow sit into.

== FLYING ESCORTS CURRENTLY EXPERIMENTAL! For example do not dock into a station while you are in an escort, nor enter into a wormhole, go back into your Carrier first. ==



== Warning: informations below this point are unfinished, if there are scripted parts of these then in alpha state so probably contain bugs and missing features. ==


Instant launch

The top front landing position will acts as a command bridge: if your ship is landed on the first pad then you will be able to steer the Carrier and launch yourself immediately without going through the undocking tunnel. In this case the Carrier is a very large detachable escort deck under the Commander&#39;s ship.


Trading

You will be able to use the cargo capacity of traders on your deck. If you have 6 Cobra Mark I on board then your total cargo capacity is 110t, but you will not see this in one piece. You will be able to switch between your ships when you are in a dock but you will see one cargo bay only at a time.

If you want a really big trader ship then collect a pair of Anacondas into your carrier.


Fuel

Carriers has normal tanks only but will transfer fuel from the carried ships to keep over 6 ly, and will refuel the ship selected by the Commander before launch until there are any fuel in other ships on board.

The Commander can open a wormhole if he want to travel into another system and all ships in the fleet will jump into.



Have fun, Fleet Commander! :)



Instructions:

Do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.

Correct landed escort positions need Oolite 1.81. In 1.80 all escorts moved well over the hull to avoid collisions.

There is a savegame in the package, copy into your oolite-saves directory if you want an instant test flight.


License:

The 3D model of all Carriers is derived from HammerHead in Aquatics OXP, thanks to Thargoid and P.A. Groove.
Carriers_escortAI.plist is based on hiredGuns_escortAI.plist in Hired Guns OXP by Thargoid which is based on upsPrivateEscortAI.plist in UPS-Courier OXP by Eric Walch.
The carriers-escort.js is based on hiredGuns_escort.js in Hired Guns OXP by Thargoid.

This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.


Changelog:
 2021.08.21. v0.10 Fixed a couple of errors in the shipdata.plist file.
 2015.01.20. v0.9  Sit into feature is fixed and enabled by default.
 2015.01.11. v0.8  Use Escort Deck equipment to launch and call back escorts.
                   XL deck can hold 10 escorts.
                   Test version of the &quot;sit into an escort ship&quot; feature.
                   Pitch and yaw rates of Carriers are changed from 0.3 to 0.5.
 2014.06.20. v0.7  Center deck is lifted over others to fit more ship types up to Asp.
 2014.06.19. v0.6  Moray is fit into the center deck due to the narrow aft.
                   Fixed shader filename, thanks to Stormrider.
 2014.06.19. v0.5  Front Adder decks added.
 2014.06.18. v0.4  Top front deck is upgraded to hold a large ship.
 2014.06.17. v0.3  Narrower head on Carriers to fit Anaconda in straight.
 2014.06.16. v0.2  Anaconda and Fer-De-Lance Carrier models added.
 2014.06.15. v0.1  First ship models.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda-carrier.html">Anaconda Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda-carrier-pirate.html">anaconda-carrier-pirate</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/anaconda-carrier-player.html">anaconda-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/carriers-alloy.html">Carriers alloy</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/carriers-dock.html">Carriers dock</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/carriers-template.html">Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/carriers-vdock.html">Carriers vdock</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra1-carrier.html">Cobra Mark I Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra1-carrier-pirate.html">cobra1-carrier-pirate</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra1-carrier-player.html">cobra1-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra3-carrier.html">Cobra Mark III Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra3-carrier-pirate.html">cobra3-carrier-pirate</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra3-carrier-player.html">cobra3-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/empty-carrier.html">Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/empty-carrier-pirate.html">Fer-De-Lance Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/empty-carrier-player.html">empty-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/empty-carrier-police.html">Viper Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ferdelance-carrier.html">Fer-De-Lance Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ferdelance-carrier-pirate.html">ferdelance-carrier-pirate</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ferdelance-carrier-player.html">ferdelance-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/viper-carrier.html">Viper Carrier</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/viper-carrier-player.html">viper-carrier-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/viper-carrier-police.html">viper-carrier-police</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/carriers.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;carriers&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2015 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.description = &quot;Carriers with open decks.&quot;;

this.$Debug = false; //verbose log
this.$CarriersSitInto = true; //turn on the &quot;sit into the ecort during flight&quot;
this.$CarriersSitIntoWithMode = true; //show the mode menu item on primed EscortDeck to enable sit into

//internal properties, should not touch
this.$CarriersBG = &quot;&quot;; //backgroung image for missionscreens of Carriers
this.$CarriersCarrier = null; //the carrier ship object, used in carriers-escort.js ship script
this.$CarriersDocked = false; //flag if the player is the current ship is a carrier when player is docked
this.$CarriersED = null; //store a pointer to escortdeck worldscript
this.$CarriersEDEQ = null; //which deck player have: normal or XL
this.$CarriersEscortData = null; //temporary storage of selected escort&#39;s data when sit into
this.$CarriersEDCarrierPad = -1; //this pad on Escort Deck store the Carrier when player sit into an escort
this.$CarriersFCB = null; //FrameCallBack for calling event handlers after launch
this.$CarriersFCBArray = []; //store event handlers for FrameCallBack
this.$CarriersLastShip = null; //store the last player ship which is docked into a station for detect restore
this.$CarriersPirate = null; //store a created pirate carrier
this.$CarriersPlayerInEscort = false; //flag for EscortDeck FCB
this.$CarriersPrevCarrier = null; //save last name to avoid repeated landing clearance message
this.$CarriersS = null; //store the created trader ship to prevent recreates
this.$CarriersShip = null; //store the created trader ship to prevent recreates
this.$CarriersShipStorage = []; //store the carried escort ships, the 0. position store the carrier itself
this.$CarriersSH = null; //store a pointer to Ship_Storage_Helper.js worldscript
this.$CarriersSV = null; //store a pointer to shipversion worldscript
this.$CarriersSVB = null; //store the whole playerBoughtNewShip() code of shipversion
this.$CarriersT = null; //store a pointer to telescope worldscript
this.$CarriersTimer = null; //general timer for landing back on Carrier
//this.$CarriersTimerL = null; //delay timer for PS.launch()
//this.$CarriersTimerV = null; //delay timer for vdock remove
this.$CarriersVDock = null; //Virtual dock for ship change during launch an escort from the carrier
this.$EscortDeckLandingDist = 500; //landing distance, will be overwritten if EscortDeck OXP present

//world script events
this.startUp = function() {
	if(worldScripts[&quot;BGS-M&quot;]) this.$CarriersBG = &quot;bgs-i_equipship.png&quot;;
	else if(worldScripts[&quot;Better Screens&quot;]) this.$CarriersBG = &quot;bs-base-bg.png&quot;;
	else if(worldScripts[&quot;Gallery&quot;]) this.$CarriersBG = &quot;gallery_bg.png&quot;;
	
	this.$CarriersTimer = new Timer(this, this.$Carriers_Timed.bind(this), 2, 2);
	this.$CarriersED = worldScripts.escortdeck;
	if(!this.$CarriersED) log(&quot;Carriers&quot;, &quot;Error: Carriers can not handle escorts without EscortDeck OXP&quot;);
	else {
		this.$EscortDeckLandingDist = this.$CarriersED.$EscortDeckLandingDist;
		this.$CarriersED.$EscortDeckSitInto = this.$CarriersSitInto;
		this.$CarriersED.$EscortDeckSitIntoWithMode = this.$CarriersSitIntoWithMode;
	}
	
	this.$CarriersSH = worldScripts[&quot;Ship_Storage_Helper.js&quot;];
	if(!this.$CarriersSH) log(&quot;Carriers&quot;, &quot;Error: Carriers can not change ship without Ship Storage Helper OXP&quot;);
	else {
//		player.credits += 1000000;//debug ;)
	}
	this.$CarriersSV = worldScripts.shipversion;
	this.$CarriersT = worldScripts.telescope;

	var s = missionVariables.$CarriersShipStorage;
	if( s &amp;&amp; s.length &gt; 0 )	this.$CarriersShipStorage = JSON.parse(s);

	this.$CarriersVDock = null; //Virtual dock for ship change during launch an escort from the carrier
	this.$CarriersEDCarrierPad = -1; //this pad store the Carrier when player sit into an escort
	this.$CarriersPlayerInEscort = false;

	this.$Carriers_CheckCarrier();
}

this.guiScreenChanged = function(to, from) {
	var ps = player.ship;
	var w = this.$CarriersED;
	if( to != &quot;GUI_SCREEN_STATUS&quot; || !ps.docked ) return;
	if(this.$Debug) log(&quot;Carriers&quot;, &quot;guiScreenChanged &quot;+to+&quot; docked:&quot;+ps.docked+&quot; &quot;+ps.dockedStation+&quot; &quot;
		+this.$CarriersSitInto+&quot; vdock:&quot;+this.$CarriersVDock);
	if( !w || !this.$CarriersVDock ) return;

	var h = worldScripts.hudselector;
	if( h ) h.$HUDSelectorRestoreHUD(); //give back the actual HUD - must if restoreShipData breaks

//5. step: Call launch() to do not stay within the virtual dock.
	ps.launch();
//call in timer if do not work well here
//	this.$CarriersTimerL = new Timer(this, this.$Carriers_TimedL.bind(this), 0.001, 0);
//	if(this.$Debug) log(this.name,&quot;TimerL started: &quot;+this.$CarriersTimerL);
//	var f = this.$Carriers_TimedL.bind(this); f(&quot;aha&quot;); //skip timer delay and call instantly
	
	if( ps != this.$CarriersCarrier ) { //restore escort equipments
		w.$EscortDeck_RestoreShipData(ps, this.$CarriersEscortData, w);
		//Escort Deck or XL deck for using MFD and primable functions
		ps.awardEquipment(this.$CarriersEDEQ);//again for sure
		if( h ) h.$HUDSelectorRestoreHUD(); //give back the actual HUD again for sure
	}
}

this.playerWillSaveGame = function(message) {
       missionVariables.$CarriersShipStorage = JSON.stringify(this.$CarriersShipStorage);
}

this.shipAttackedOther = function(other) { //player hits other
	if( !other.script ) other.script = &quot;oolite-default-ship-script.js&quot;; //for sure
	if( other.script ) other.script.$Carriers_Target = 1; //flag for carrier AI
}

this.shipCollided = function( pt ) {
	if( pt &amp;&amp; pt.isValid &amp;&amp; pt == this.$CarriersCarrier //exclude carriers in exhibitions of Gallery OXP
		&amp;&amp; player.ship &amp;&amp; player.ship.isValid &amp;&amp; player.ship.target == pt ) {
		this.$Carriers_DockPlayer( pt );
	}
}

this.shipDockedWithStation = function(station) {
	var ps = player.ship;
	var w = this.$CarriersED;
	if(this.$Debug) log(&quot;Carriers&quot;, &quot;sDWS station.dataKey:&quot;+station.dataKey
		+&quot; pad:&quot;+w.$EscortDeckSelectedPad+&quot; cpad:&quot;+this.$CarriersEDCarrierPad
		+&quot; ps.dockedStation:&quot;+ps.dockedStation+&quot; inEscort:&quot;+this.$CarriersPlayerInEscort
		+&quot; vdock:&quot;+this.$CarriersVDock);
	if( !w || !this.$CarriersVDock ) return;

	if( this.$CarriersPlayerInEscort ) { //sit into the carrier
		this.$CarriersPlayerInEscort = false;
		player.consoleMessage(&quot;Welcome home, Commander &quot;+player.name+&quot;!&quot;, 5);
		this.$Carriers_SitIntoTheCarrier();
		this.$CarriersEDCarrierPad = -1;
		if( ps.equipmentStatus(&quot;EQ_ESCORTDECKXL&quot;) == &quot;EQUIPMENT_OK&quot; )
			ps.removeEquipment(&quot;EQ_ESCORTDECK&quot;); //bugfix
		return;
	} else { //launch player in an escort
//3. step: Replace player ship to the escort using Ship Storage Helper.
		//this pad on Escort Deck store the Carrier when player sit into an escort
		var pad = this.$CarriersEDCarrierPad;

		this.$CarriersEDEQ = &quot;EQ_ESCORTDECK&quot;;
		if( ps.equipmentStatus(&quot;EQ_ESCORTDECKXL&quot;) == &quot;EQUIPMENT_OK&quot; )
			this.$CarriersEDEQ = &quot;EQ_ESCORTDECKXL&quot;; //save the current deck equipment

		this.$CarriersEscortData = w.$EscortDeckShipData[pad];
		var s = JSON.stringify(this.$CarriersEscortData);
		if(this.$Debug) log(&quot;Carriers&quot;, &quot;pad &quot;+pad+&quot;: &quot;+s);
		if( s &amp;&amp; s.length &gt; 0 ) {
			this.$CarriersCarrier = ps;
			if(ps.script) ps.script.$EscortDeckUsable = 1; //carrier is always usable
			this.$CarriersShipStorage[0] = this.$Carriers_StoreShip(); //save the carrier
//4. step: Remove the old escort and spawn a Carrier.
			if( w.$EscortDeckShip[pad] &amp;&amp; w.$EscortDeckShip[pad].isValid
				&amp;&amp; w.$EscortDeckShip[pad] != ps )
				w.$EscortDeckShip[pad].remove(true);//remove NPC escort
			w.$EscortDeckShipData[pad] = null; //prevent recreation in dock
			w.$EscortDeckShipPos[pad] = null; //do not update position in FCB
			if(this.$Debug) log(&quot;Carriers&quot;,&quot;Stored: &quot;+this.$CarriersShipStorage[0]);
			this.$CarriersPlayerInEscort = true; //set it before RestoreShip to avoid salvaging
			if( !this.$Carriers_RestoreShip(s, true) ) {
				this.$CarriersPlayerInEscort = false;//set back if restore failed
				log(&quot;Carriers&quot;,&quot;Error: can not sit into &quot;+s);
				return; //failed to sit into the escort
			}
		} else return;
		if(this.$Debug) log(&quot;Carriers&quot;, &quot;Player ship changed to pad &quot;+pad+&quot;: &quot;+s);

		var c = null; //spawn the carrier behind the player after takeoff
		var pos = this.$CarriersVDock.position.add(this.$CarriersVDock.heading
			.multiply(-(this.$EscortDeckLandingDist-100)));
		var b = JSON.parse(this.$CarriersShipStorage[0]); // destringify the carrier
		if( b.length &gt; 1 &amp;&amp; b[1].length &gt; 0 ) //b[1] is the stored dataKey of carrier
			c = system.addShips(&quot;[&quot;+b[1]+&quot;]&quot;, 1, pos, 10);
		if( c &amp;&amp; c[0] &amp;&amp; c[0].isValid ) {
			w.$EscortDeck_RestoreShipData(c[0], b, w);
			if(c[0].addCollisionException) { //from v1.81
				for(var i = 0; i &lt; w.$EscortDeckPadPos.length; i++ ) {
					if( w.$EscortDeckShip &amp;&amp; w.$EscortDeckShip[i] )
						c[0].addCollisionException(w.$EscortDeckShip[i]);
				}
			}
			w.$EscortDeckShip[pad] = c[0]; //replace the escort with the Carrier in MFD
			this.$Carriers_EscortSetup(c[0], 0); //give AI to the npc carrier
			this.$CarriersCarrier = c[0];
			
		} else log(&quot;Carriers&quot;,&quot;Error: can not create Carrier at escort takeoff&quot;);
		if(this.$Debug) {
			log(&quot;Carriers&quot;,&quot;b:&quot;+b);
			log(&quot;Carriers&quot;,&quot;c:&quot;+c);
		}
		
		w.$EscortDeck_RestoreShipData(ps, this.$CarriersEscortData, w);
		//Escort Deck or XL deck for using MFD and primable functions
		ps.awardEquipment(this.$CarriersEDEQ);
//5. step: Call launch() to do not stay within the virtual dock.
//		ps.launch(); - drop player.ship.dockedStation is null error in Commander&#39;s Log
	}
}

this.shipLaunchedFromStation = function() {
//6. step: Remove the virtual dock - need allow_launching=true; of vdock in shipdata.plist
	if(this.$Debug) log(this.name,this.name+&quot;.shipLaunchedFromStation called&quot;);
	this.$Carriers_RemoveVDock();
}

this.shipTargetAcquired = function(target) {
	this.$CarriersPrevCarrier = null; //to get landing clearance message a bit later
}

this.shipWillDockWithStation = function() {
	this.$Carriers_CheckCarrier();
}

this.shipWillLaunchFromStation = function() {
	if(this.$Debug) log(this.name,this.name+&quot;.shipWillLaunchFromStation called&quot;);
/*	if( this.$CarriersVDock ) {
		this.$CarriersTimerV = new Timer(this, this.$Carriers_TimedV.bind(this), 4, 0);
		if(this.$Debug) log(this.name,&quot;TimerV started: &quot;+this.$CarriersTimerV);
	}*/
}

//Carriers functions
this.$Carriers_CheckCarrier = function() {
	var ws = worldScripts[&quot;carriers&quot;];
	var ps = player.ship;
	if( ps &amp;&amp; ps.isValid &amp;&amp; ps.dataKey &amp;&amp; ps.dataKey.indexOf(&quot;carrier-player&quot;) &gt; -1 ) { //current ship is a carrier
		ws.$CarriersDocked = true;
		ws.$CarriersCarrier = ps;
		ws.$CarriersShipStorage[0] = ws.$Carriers_StoreShip(); //save the carrier
	} else ws.$CarriersDocked = false;
}

this.$Carriers_DockPlayer = function( pt ) {
	var ws = worldScripts.carriers;
	//check speed difference
	var diff = player.ship.velocity.subtract( pt.velocity ).magnitude();
	if( diff &gt; 100 ) {
		player.consoleMessage(Math.round(diff)+&quot; m/s speed difference deny landing on &quot;
			+ws.$CarriersPrevCarrier, 5);
	} else {
		var ps = player.ship;
		var w = ws.$CarriersED;
		var pos = pt.position.add(pt.vectorForward.multiply(1000));
		ws.$CarriersVDock = system.addShips(&quot;[carriers-vdock]&quot;, 1, pos, 100)[0];
		if( w &amp;&amp; ws.$CarriersVDock ) {
			ws.$CarriersVDock.orientation = pt.orientation; //the direction of launch
			if(ps.addCollisionException)  //from v1.81
				ps.addCollisionException(ws.$CarriersVDock);
			ws.$CarriersVDock.dockPlayer();
		} else log(&quot;Carriers&quot;, &quot;Error: can not create virtual dock for sit into the carrier&quot;);
	}
}

this.$Carriers_EscortSetup = function( e, id ) {
	var ws = worldScripts.carriers;
	var w = ws.$CarriersED;
	var ai = &quot;interceptAI.plist&quot;; //fallback ai if no escortdeck oxp present
	if( w ) ai = &quot;EscortDeck_AI.plist&quot;;

	var ps = player.ship;
	if( e &amp;&amp; e.isValid ) {
		if(!ps.group) ps.group = new ShipGroup(&quot;CarriersEscorts&quot;, ps); //player ship is the leader
		ps.group.addShip(e);
		e.switchAI(ai);
		if( w ) e.AIState = (&quot;GOTO&quot;);
		e.scannerDisplayColor1 = [0.3, 1, 0.3]; //lightgreen
		var usable = 0;
		var sl = 0;
		if(e.script) {
			usable = e.script.$EscortDeckUsable; //must set again after setScript
			sl = e.script.$SSH_serviceLevel; //must set again after setScript
		}
		if( w ) e.setScript(&quot;escortdeck_escort.js&quot;);
		if(e.script) {
			e.script.$CarriersEscortHome = ws.$CarriersCarrier; //set the owner carrier
			e.script.$CarriersShipStorageID = id; //position in $CarriersShipStorage array
			e.script.$EscortDeckUsable = usable;
			e.script.$SSH_serviceLevel = sl;
		}
		e.orientation = ps.orientation;
	} else log(&quot;Carriers&quot;,&quot;Error: can not setup escort #&quot;+id+&quot; &quot;+e);
}
			
this.$Carriers_FCB = function( delta ) { //FrameCallBack for calling event handlers after sit into an escort
	var ws = worldScripts.carriers;
	var f = null;
	if( ws.$CarriersFCBArray ) f = ws.$CarriersFCBArray.pop();
	if( f ) {
		//if(ws.$Debug) log(ws.name,(ws.$CarriersFCBArray.length+1)+&quot;. call &quot;+f);
		f( ws.$CarriersVDock );
	}
}

this.$Carriers_RemoveVDock = function() {
	var ws = worldScripts.carriers;
	if( ws.$CarriersVDock ) {
		ws.$CarriersVDock.remove(true);
		ws.$CarriersVDock = null;
		if(ws.$Debug) log(ws.name,&quot;VDock removed&quot;);
	}
	if( isValidFrameCallback( ws.$CarriersFCB ) )
		removeFrameCallback( ws.$CarriersFCB );
	if( ws.$CarriersTimerV ) {
		ws.$CarriersTimerV.stop();
		delete ws.$CarriersTimerV;
	}
}

this.$Carriers_RestoreShip = function(storedShipString, escort) {
	var ws = worldScripts.carriers;
	if(ws.$CarriersSH) {
		var h = worldScripts.hudselector;
		if( h ) h.$HUDSelectorRestoreHUD(); //give back the actual HUD
		if( escort ) {
			var d = JSON.parse(storedShipString);
			if(ws.$Debug) log(&quot;Carriers&quot;, &quot;d1:&quot;+d[1]+&quot; d13:&quot;+d[13]+&quot; d:&quot;+d);
			if( !player.replaceShip(d[1],d[13]) ) return false;
			var w = ws.$CarriersED;
			if( w ) w.$EscortDeck_RestoreShipData(player.ship, d, w);
			if(ws.$Debug) log(&quot;Carriers&quot;, &quot;new player.ship: &quot;+player.ship);
		} else {
			var e = ws.$CarriersSH.restoreStoredShip(storedShipString); //carrier
			if(ws.$Debug) log(&quot;Carriers&quot;, &quot;player.ship: &quot;+player.ship+&quot; e:&quot;+e);
			if( e &amp;&amp; e.length &gt; 1 ) return false;
		}
//		if(ws.$Debug) log(&quot;Carriers&quot;, &quot;player.ship.maxEscorts: &quot;+player.ship.maxEscorts);
		//player.ship.maxEscorts= 16; //16 is the maximum allowed by the core game - but read only
		return true;
	} else log(&quot;Carriers&quot;, &quot;Error: Carriers can not restore ship without Ship Storage Helper OXP&quot;);
	return false;
}

this.$Carriers_SitIntoAnEscort = function(ship) { //called from EscortDeck&#39;s EQActivated
	var ps = player.ship;
	this.$CarriersCarrier = ps;
	var ws = worldScripts.carriers;
	
//1. step: Spawn a virtual dock (a ship with a dock subentity) near the player ship.
	var pos = ps.position.add(ps.vectorForward.multiply(1000));
	ws.$CarriersVDock = system.addShips(&quot;[carriers-vdock]&quot;, 1, pos, 100)[0];
	if( ws.$CarriersVDock &amp;&amp; ws.$CarriersED ) {
		ws.$CarriersEDCarrierPad = ws.$CarriersED.$EscortDeckSelectedPad;
		player.consoleMessage( ship.name+&quot; takeoff from &quot;+ps.displayName, 10 );
		ws.$CarriersVDock.orientation = ps.orientation; //the direction of launch
		if(ps.addCollisionException)  //from v1.81
			ps.addCollisionException(ws.$CarriersVDock);
//2. step: Call dockPlayer() into vdock which show the docking tunnel.
		ws.$CarriersVDock.dockPlayer();
		//continued in this.guiScreenChanged
	} else log(&quot;Carriers&quot;, &quot;Error: can not create virtual dock for launch an escort&quot;);
}

this.$Carriers_SitIntoTheCarrier = function() {
	//add the current escort ship into the first empty item of ship storage
	var ws = worldScripts.carriers;
	var w = ws.$CarriersED;
	if( w ) {
		w.$EscortDeckSelectedPad = -1;
		var b = w.$EscortDeck_MakeShipData(player.ship);//need to be docked
		var c = null; //spawn the escort behind the player
		var pad = ws.$CarriersEDCarrierPad;
		var pos = player.ship.position.add(player.ship.heading
			.multiply(-(w.$EscortDeckLandingDist-100)));
		if( b.length &gt; 1 &amp;&amp; b[1].length &gt; 0 ) //b[1] is the stored dataKey of escort
			c = system.addShips(&quot;[&quot;+b[1]+&quot;]&quot;, 1, pos, 1000);
		if( c &amp;&amp; c[0] &amp;&amp; c[0].isValid ) {
			if(c[0].addCollisionException) { //from v1.81
				c[0].addCollisionException(player.ship);
			}
			w.$CarriersLastShip = c[0];
			w.$EscortDeck_RestoreShipData(c[0], b, w);
			w.$EscortDeck_PutShip(c[0], pad, player.ship, w, false, true );
		} else log(&quot;Carriers&quot;,&quot;Error: can not create escort in&quot;
			+&quot;$Carriers_SitIntoTheCarrier b[1]:&quot;+b[1]+&quot; c:&quot;+c+&quot; pos:&quot;+pos);
		if( ws.$CarriersCarrier != player.ship ) ws.$CarriersCarrier.remove(true); //remove the npc carrier
		ws.$Carriers_RestoreShip(ws.$CarriersShipStorage[0]);
		ws.$CarriersCarrier = player.ship;
	}
	if(ws.$Debug) log(&quot;Carriers&quot;, &quot;CSITC Player ship:&quot;+player.ship.dataKey
		+&quot; &quot;+player.ship.name+&quot;/&quot;+player.ship.displayName);//debug
}

this.$Carriers_StoreShip = function() {
	var ws = worldScripts.carriers;
	var sh = ws.$CarriersSH;
	if( sh ) {
		var storedShipString = sh.storeCurrentShip();
		sh.disableVortexPBNSFunc(&quot;delete&quot;);
		sh.disableMaelstromPBNSFunc(&quot;delete&quot;);
		sh.disableTCATPBNSFunc();
		return(storedShipString);
	} else log(&quot;Carriers&quot;, &quot;Error: Carriers can not store ship without Ship Storage Helper OXP&quot;);
}

this.$Carriers_Timed = function() {
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //player died

	if( this.$CarriersPlayerInEscort ) {
		var c = this.$CarriersCarrier;
		if( !c || !c.isValid ) {
			this.$CarriersPlayerInEscort = false; //if carrier died
			var w = this.$CarriersED;
			if( w ) {
				w.$EscortDeck_ControlAll( true, false, w ); //launch all
				var pad = w.$CarriersEDCarrierPad;
				w.$EscortDeckShip[pad] = null;
				w.$EscortDeckShipData[pad] = null;
				w.$CarriersEDCarrierPad = -1;
			}
		}
	}

	var m = system.mainStation; //add some NPC carriers
	if( m &amp;&amp; m.isValid &amp;&amp; ( !this.$CarriersShip || !this.$CarriersShip.isValid ) ) { //delayed create
		if( system.government &lt; 5 )
			this.$CarriersPirate = system.addShipsToRoute(&quot;carriers-pirate&quot;, 1, Math.random(), &quot;wp&quot;)[0];
		this.$CarriersShip = system.addShips(&quot;carriers-trader&quot;, 1, m.position, 150000)[0];
//		this.$CarriersShip = system.addShips(&quot;anaconda-carrier&quot;, 1, m.position, 15000)[0];//debug
//		this.$CarriersShip = system.addShips(&quot;cobra1-carrier&quot;, 1, m.position, 15000)[0];//debug
//		this.$CarriersShipRH = system.addShips(&quot;rockhermit&quot;, 1, this.$CarriersShip.position, 15000)[0];//debug
//		this.$CarriersShipRH.target = this.$CarriersShip;
//		this.$CarriersShip.target = this.$CarriersShipRH;
//		this.$CarriersShip.setAI(&quot;dockingAI.plist&quot;);
//		this.$CarriersShip = system.addShips(&quot;empty-carrier&quot;, 1, m.position, 5000)[0];//debug
//		this.$CarriersShip.setAI(&quot;nullAI.plist&quot;);//debug
		if(this.$Debug) log(&quot;Carriers&quot;, &quot;Added &quot;+this.$CarriersShip);//debug
	}
	
	var pt = ps.target; //player is landing on carrier
	if( pt &amp;&amp; pt.isValid &amp;&amp; pt.dataKey &amp;&amp; pt.dataKey.indexOf(&quot;carrier&quot;) &gt; -1
		&amp;&amp; pt == this.$CarriersCarrier ) { //exclude carriers in exhibitions of Gallery OXP
		var d = ps.position.distanceTo(pt) - pt.collisionRadius;
		if( d &lt; 25000 &amp;&amp; pt.displayName != this.$CarriersPrevCarrier ) { //carrier within 25km
			pt.switchAI(&quot;EscortDeck_AI.plist&quot;); //leave waypoint AI
			pt.AIState = &quot;LANDING&quot;; //do not run from the player
			player.consoleMessage( &quot;Landing approved on &quot;+pt.displayName, 10 );
			this.$CarriersPrevCarrier = pt.displayName; //save last name to avoid repeated message
		} else if( d &lt; this.$EscortDeckLandingDist ) { //carrier within 500m
			this.$Carriers_DockPlayer( pt );
		}
	}
	
	if( this.$CarriersT &amp;&amp; ps.viewPositionForward ) { //fix telescope visual target pos.(need 1.79)
		this.$CarriersT.$TelescopeVPos =
			ps.viewPositionForward.add(this.$CarriersT.$TelescopeVPosHUD);
	}
}
/*
this.$Carriers_TimedL = function(a) {
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //player died
	var ws = worldScripts.carriers;

	var h = worldScripts.hudselector;
	if( h ) h.$HUDSelectorRestoreHUD(); //give back the actual HUD
	
//5. step: Call willLaunch handlers  - not needed if allow_launching=true; in the vdock
//then launch() to do not stay within the virtual dock.
	if( !isValidFrameCallback( ws.$CarriersFCB ) )
		ws.$CarriersFCB = addFrameCallback( ws.$Carriers_FCB );

	ws.$CarriersFCBArray = [];
	ws.$CarriersFCBArray.push( function() {player.ship.launch();} );
	for(var i in worldScripts) {
		var f = worldScripts[i].shipWillLaunchFromStation;
		if( f ) {
			ws.$CarriersFCBArray.push( f.bind( worldScripts[i] ) );
			if(ws.$Debug) log(ws.name, ws.$CarriersFCBArray.length+&quot;. &quot;+i
				+&quot;.shipWillLaunchFromStation added to FCBArray&quot;);
		}
	}
	ps.launch();
	if( ws.$CarriersTimerL ) {
		ws.$CarriersTimerL.stop();
		delete ws.$CarriersTimerL;
	}
	if(ws.$Debug) log(ws.name,&quot;TimerL executed, a:&quot;+a+&quot; this:&quot;+this);
}

this.$Carriers_TimedV = function() {
	var ps = player.ship;
	if( !ps || !ps.isValid ) return; //player died
	var ws = worldScripts.carriers;

//6. step: call launched events - not needed if allow_launching=true; in the vdock
// then remove the virtual dock
	ws.$CarriersFCBArray = [];
	ws.$CarriersFCBArray.push( ws.$Carriers_RemoveVDock.bind(ws) );
	for(var i in worldScripts) {
		var f = worldScripts[i].shipLaunchedFromStation;
		if( f &amp;&amp; i != ws.name ) {
			ws.$CarriersFCBArray.push( f.bind( worldScripts[i] ) );
			if(ws.$Debug) log(ws.name, ws.$CarriersFCBArray.length+&quot;. &quot;+i
				+&quot;.shipLaunchedFromStation added to FCBArray&quot;);
		}
	}

	if( ws.$CarriersTimerV ) {
		ws.$CarriersTimerV.stop();
		delete ws.$CarriersTimerV;
	}
	if(ws.$Debug) log(ws.name,&quot;TimerV executed&quot;);
}*/

</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
