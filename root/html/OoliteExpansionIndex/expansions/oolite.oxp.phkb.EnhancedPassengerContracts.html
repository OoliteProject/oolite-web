<html>
    <head>
        <title>Expansion Enhanced Passenger Contracts</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Enhanced Passenger Contracts</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Expansion to passenger contracts system.</td>
                    <td>Expansion to passenger contracts system.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.EnhancedPassengerContracts</td>
                    <td>oolite.oxp.phkb.EnhancedPassengerContracts</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Enhanced Passenger Contracts</td>
                    <td>Enhanced Passenger Contracts</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Missions</td>
                    <td>Missions</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.4</td>
                    <td>0.4</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.phkb.BulletinBoardSystem:1.6</li>
                    </td>
                    <td>
                            <li>oolite.oxp.phkb.BulletinBoardSystem:1.6</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.phkb.BroadcastCommsMFD:1.2.8</li>
                            <li>oolite.oxp.phkb.BountySystem:0.4.1</li>
                    </td>
                    <td>
                            <li>oolite.oxp.phkb.BroadcastCommsMFD:1.2.8</li>
                            <li>oolite.oxp.phkb.BountySystem:0.4.1</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/d/d9/EnhancedPassengerContracts.oxz">https://wiki.alioth.net/img_auth.php/d/d9/EnhancedPassengerContracts.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1670936999</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Enhanced%20Passenger%20Contracts'>http://wiki.alioth.net/index.php/Enhanced%20Passenger%20Contracts</a></p>
        <h3>readme.txt</h3>
        <pre>Enhanced Passenger Contracts
by Nick Rogers

Overview
========
This OXP aims to expand on passenger contracts in a number of ways. 

1. The player will occasionally receive comms messages from passengers in a variety of situations.

2. Some passengers will now have a stipulation that they do not want a rough ride. Get involved in too much fighting, and throw the ship around too much, and your final payment will be reduced by 50%.

3. Some passengers will have a stipulation that they do not want to dock at GalCop stations in systems with a particular government (eg Anarchies). If you do, the contract will be cancelled.

4. Some passengers will have a stipulation that they do not want to dock at GalCop stations in systems where a particular species (eg Rodents) are the primary inhabitant. If you do, the contract will be cancelled.

5. Some passengers will have a stipulation that they do not want to dock at a GalCop station in a particular system (eg Lave, Tionisla). If you do, the contract will be cancelled.

6. Some passengers will offer a bonus amount if the player docks at GalCop stations in particular systems before reaching the final destination. 

7. If you have the Broadcast Comms MFD available, you might find that sometimes passengers will change their minds. You might get a request from a passenger to take them to a different destination to the one you signed up for. You&#39;ll have the option of accepting the new destination (which comes with a bonus payment), or to keep the contract the way it was.

8. If you have the Bounty System installed, some passengers might have a stipulation that they do not want to be scanned by police or bounty hunters at any time during transit. If you get scanned, the final payment will be reduced by 75%. 

9. Again, if you have the Bounty System installed, passengers can have a bounty amount, and if police discover that bounty during a scan in certain systems, you may receive a small penalty to your offender status.

Configuration
=============
You can control what types of contracts will be created, and whether any of the comms messages will be sent, by changing settings made available through Library Config. The settings are:

	A:Government-type restrictions - passengers indicating they don&#39;t want to visit systems of a particular government type.
	B:Species-type restrictions - passengers indicating they don&#39;t want to visit systems with particular inhabitants.
	C:System restrictions - passengers indicating they don&#39;t want to visit particular systems.
	D:Bonus systems - passengers offering bonuses for visiting particular systems before the final destination.
	E:Passenger bounties - passenger can have bounties (visible or hidden) which can be picked up by police warrant scanners.
	F:No bounty scan restrictions - passengers indicating they do not want your ship scanned with a warrant scanner.
	G:Smooth flight restrictions - passengers indicating they want their journey to be without any combat in it.
	H:Mid-flight changes - passengers changing their minds about their destination somewhere along the way.
	I:Passenger comms - passengers will send comms messages to the player in certain conditions.

Setting a value to &quot;1&quot; turns the option on. Setting it to &quot;0&quot; turns it off. Turning all values to 0 will render the OXP inoperative, and the types of passenger contracts generated will be identical to the core passenger contract system.

Once a contract setting is turned off, it will take until your next jump for available contracts to reflect the changes. However, the setting will have an immediate impact on existing contracts (ie if you turn off the &quot;Government-type restrictions&quot; after accepting a contract of this type, no government-type checking will take place).

Required OXP&#39;s
==============
The following OXP&#39;s are listed as required:

- Bulletin Board System (1.6)
	Required as all passenger missions are accessed through this interface.

Recommended OXP&#39;s
=================
The following OXP&#39;s are listed as recommended, in that additional text and/or gameplay options will become available if they are installed.

- Broadcast Comms MFD (v1.2.8)
- Bounty System (v0.4.1)
- Email System (v1.7.4)
- Library (v1.4)

Licence
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Version History
===============
0.4
- Fixed JS referencing error.

0.3
- Removed PhraseGen code, reverted to original name generation code, to reduce the size of the code base.

0.2
- Better timer handling.

0.1
- Initial release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/epc_passenger_contracts.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name					= &quot;EnhancedPassengerContracts&quot;;
this.author					= &quot;phkb&quot;;
this.copyright              = &quot;2018 phkb&quot;;
this.description			= &quot;Expands the passenger contracts system&quot;;
this.licence                = &quot;CC BY-NC-SA 4.0&quot;;

/*
    todo:
        passengers who get injured during battles and need medical treatment at the next station
        passengers who steal cargo and disappear
        passengers who steal parcels and disappear
*/
//

this._flags = [1,1,1,1,1,1,1,1,1];
this._settings = 511;
this._simulator = false;
this._internal = false;
this._loading = true;
this._emailDisable = false;
this._sendEmailType = 0;
this._informPlayerOfSystem = false;

this._avoidGovTypeLoading = 1.2; // 20% increase
this._avoidSpeciesLoading = 1.3; // 30% increase
this._avoidSystemLoading = 1.05; // 5% for each system
this._smoothFlightLoading = 2.0; // 100% increase
this._bountyLoading = 1.6; // 60% increase
this._noScanLoading = 1.6; // 60% increase
this._bonusSystemLoading = 0.1; // 10%

this._changeTimer = null;
this._monitorWildMovementTimer = null;
this._chatTimer = null;
this._complimentTimer = null;
this._damageTimer = null;
this._impatientTimer = null;
this._interstellarSpaceTimer = null;
this._transmissions = [];

this._govTypeNames = [&quot;Anarchy&quot;,&quot;Feudal&quot;,&quot;Multi-Government&quot;,&quot;Dictatorship&quot;,&quot;Communist&quot;,&quot;Confederate&quot;,&quot;Democratic&quot;,&quot;Corporate State&quot;];
this._inhabitantTypes = [&quot;Lobsters&quot;,&quot;Felines&quot;,&quot;Humanoids&quot;,&quot;Insects&quot;,&quot;Frogs&quot;,&quot;Lizards&quot;,&quot;Rodents&quot;,&quot;Birds&quot;,&quot;Colonials&quot;];

this._config = {
    Name:this.name, 
    Display:&quot;Config&quot;, 
    Alias:&quot;Enh. Passenger Contracts&quot;, 
    Alive:&quot;_config&quot;, 
    Notify:&quot;$onChange&quot;,
    EInt:{
        E0:{
            Name:&quot;_settings&quot;, 
            Def:511, 
            Min:0, 
            Max:511, 
            Desc:[
                &quot;A:Gov type restr.&quot;,
                &quot;B:Species type restr.&quot;,
                &quot;C:System restr.&quot;,
                &quot;D:Bonus systems&quot;,
                &quot;E:Passenger bounties&quot;,
                &quot;F:No bounty scan restr.&quot;,
                &quot;G:Smooth flight restr.&quot;,
                &quot;H:Mid-flight changes&quot;,
                &quot;I:Passenger comms&quot;
            ]
        },
        Info:&quot;Options A-H control what type of enhanced contracts will be generated. Option I controls whether passengers will send the player any comms messages.&quot;
    },
};

//-------------------------------------------------------------------------------------------------------------
this.$onChange = function() {
	var set = 1;
	for (var i = 0; i &lt; this._flags.length; i++) {
		if (this._settings &amp; set) {
			this._flags[i] = 1;
		} else {
			this._flags[i] = 0;
		}
		set *= 2;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
    // turn off standard passenger contract system
    // disable script and empty its dataset
    this.$disableCorePassengerContracts();
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
    if (worldScripts.BountySystem_Core) {
        // tell the bounty system about the new offense type
        var b = worldScripts.BountySystem_Core;
        b.$uncoverBounties_endpoint = b.$uncoverBounties;
        b.$uncoverBounties = this.$ovr_bountySystem_uncoverBounties;
		b._offenceTypes[&quot;transporting offenders&quot;] = {description:&quot;Transporting and associating with known offenders.&quot;, severity:1};
    }
    if (worldScripts.AutoPrimeEquipment) {
        // sync up autoprime equip so selecting our MFD automatically primes broadcast comms
        worldScripts.AutoPrimeEquipment.$addConfig(&quot;EnhancedPassengerMFD&quot;, &quot;EQ_BROADCASTCOMMSMFD&quot;);
    }
    if (missionVariables.EnhancedPassengers_Settings) {
        // pull out the stored value
        this._settings = parseInt(missionVariables.EnhancedPassengers_Settings);
    } else {
        // build settings from flags array (in case a user has manually changed the defaults)
        var set = 1;
        this._settings = 0;
        for (var i = 0; i &lt; this._flags.length; i++) {
            if (this._flags[i] === 1) {
                this._settings += set;
            }
            set *= 2;
        }
    }
    
    // register our settings, if Lib_Config is present
	if (worldScripts.Lib_Config) worldScripts.Lib_Config._registerSet(this._config);
}

//-------------------------------------------------------------------------------------------------------------
this.systemWillPopulate = function() {
    // add our station key to the main station, so the contracts are only offered there
    if (system.mainStation) {
        worldScripts.BulletinBoardSystem.$addStationKey(this.name, system.mainStation, &quot;mainStation&quot;);        
    }
}

//-------------------------------------------------------------------------------------------------------------
this.missionScreenOpportunity = function() {
    if (this._loading === true) {
        this._loading = false;
        this.$removeExistingContracts();
        if (this.$countAvailableContracts() === 0) this.$createPassengerContracts();
        // force the interface entry to update
        worldScripts.BulletinBoardSystem.$initInterface(player.ship.dockedStation);
        delete this.missionScreenOpportunity;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredContract = function(type, contract) {
    if (this._internal === true) {
        if (this._sendEmailType &gt; 0) {
            switch (this._sendEmailType) {
                case 1: 
                    this.$customPassengerContractEmail(contract);
                    break;
                default:
                    this.$contractAdjustmentEmail(contract);
                    break;
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.playerCompletedContract = function(type, result, fee, contract) {
    if (type === &quot;passenger&quot;) {
        var bb = worldScripts.BulletinBoardSystem;
        for (var i = 0; i &lt; bb._data.length; i++) {
            var itm = bb._data[i];
            if (itm != null &amp;&amp; itm.accepted === true) {
                // is this item the one we&#39;re dealing with?
                if (itm.destination === contract.destination &amp;&amp; itm.payment === contract.fee &amp;&amp; itm.source === contract.start) {
                    bb.$removeBBMission(itm.ID);
                    break;
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$epc_shipBeingAttacked = function(whom) {
    player.ship.script._epc_attacked += 1;
}

//-------------------------------------------------------------------------------------------------------------
this.$epc_shipTargetDestroyed = function(target) {
    if (Math.random() &lt; 0.4) {
        if (!this._complimentTimer || this._complimentTimer.isRunning === false) {
            this._complimentTimer = new Timer(this, this.$niceShotMessage, 2, 0);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$epc_shipTakingDamage = function(amount, whom, type) {
    if (amount &gt; 0 &amp;&amp; (player.ship.energy - amount) &gt; 0 &amp;&amp; Math.random() &lt; 0.6) {
        if (!this._damageTimer || this._damageTimer.isRunning === false) {
            this._damageTimer = new Timer(this, this.$damageMessage, 2, 0);
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipDied = function(whom, why) {
    if (this._simulator === true) return;
    this.$stopTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function(station) {
    if (this.$simulatorRunning() === true) {
        this._simulator = true;
        return;
    }
    this.$startTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function(station) {
	if (this._simulator === true) return;
    this.$stopTimers();
    
    // check if we have any contracts to terminate
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    for (var i = data.length - 1; i &gt;= 0; i--) {
        if (data[i].accepted === true &amp;&amp; data[i].worldScript === this.name) {
            var contract = data[i].data.details;
            var terminate = false;
            if (station.allegiance === &quot;galcop&quot;) {
                if (this._flags[0] === 1 &amp;&amp; contract.avoidGovType &gt;= 0 &amp;&amp; contract.avoidGovType === system.government) {
                    player.addMessageToArrivalReport(expandDescription(&quot;[epc_avoid-government-fail]&quot;, {name:contract.name, govType:system.governmentDescription}));
                    terminate = true;
                }
                if (this._flags[1] === 1 &amp;&amp; contract.avoidSpecies != &quot;&quot; &amp;&amp; system.info.inhabitants.indexOf(contract.avoidSpecies) &gt;= 0) {
                    player.addMessageToArrivalReport(expandDescription(&quot;[epc_avoid-species-fail]&quot;, {name:contract.name, species:contract.avoidSpecies}));
                    terminate = true;
                }
                if (this._flags[2] === 1 &amp;&amp; contract.avoidSysList &amp;&amp; contract.avoidSysList.length &gt; 0) {
                    if (contract.avoidSysList.indexOf(system.ID) &gt;= 0) {
                        player.addMessageToArrivalReport(expandDescription(&quot;[epc_avoid-system-fail]&quot;, {name:contract.name, system:system.name}));
                        terminate = true;
                    }
                }
                if (this._flags[3] === 1 &amp;&amp; contract.bonusSysList &amp;&amp; contract.bonusSysList.length &gt; 0) {
                    var idx = contract.bonusSysList.indexOf(system.ID);
                    if (idx &gt;= 0) {
                        // remove the system now, so the player can&#39;t get the bonus twice
                        contract.bonusSysList.splice(idx, 1);
                        // remove this system from the map
                        for (var j = 0; j &lt; data[i].additionalMarkers.length; j++) {
                            if (data[i].additionalMarkers[j].destination === system.ID) {
                                data[i].additionalMarkers.splice(j, 1);
                                break;
                            }
                        }
                        // because we are still mid-mission at this point, the BB system will not automatically remove
                        // any chart markers (it will wait until the mission is finished to do this). 
                        /// So we&#39;ll do it now manually.
                        mission.unmarkSystem({system:system.ID, name:this.name + &quot;_&quot; + data[i].ID});
                        // add an arrival report
                        player.addMessageToArrivalReport(expandDescription(&quot;[epc_bonus-system-success]&quot;, {name:contract.name, bonus:formatCredits(data[i].payment * this._bonusSystemLoading, true, true)}));
                        // pay the player
                        player.credits += Math.floor((data[i].payment * this._bonusSystemLoading) * 10) / 10;
                    }
                }
            }
            if (terminate === true) {
                // send an email message for our special case
                var w = worldScripts.EmailSystem;
                if (w &amp;&amp; this._emailDisable === false) {
                    var sndr = expandDescription(&quot;[passenger-contract-sender]&quot;);
                    var msg = expandDescription(&quot;[passenger-contract-terminated]&quot;,
                        {contractname:contract.name,
                        systemname:System.systemNameForID(contract.destination),
                        time:global.clock.clockStringForTime(data[i].expiry)
                    });
                    var subj = expandDescription(&quot;[passenger-contract-terminated-subject]&quot;);
            
                    w.$createEmail({sender:sndr,
                        subject:subj,
                        date:global.clock.adjustedSeconds,
                        message:msg,
                        expiryDays:worldScripts.GalCopAdminServices._defaultExpiryDays
                    });
                }

                player.ship.removePassenger(contract.name);
                player.decreasePassengerReputation();
                bb.$removeBBMission(data[i].ID);
                break;
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillExitWitchspace = function() {
    if (!system.isInterstellarSpace &amp;&amp; !system.sun.hasGoneNova &amp;&amp; system.mainStation) {
        // must be a regular system with a main station
        this.$createPassengerContracts();
    }
    var p = player.ship;
    p.script._epc_wildMovement = 0;
    p.script._epc_attacked = 0;

    // only try and do a change if broadcast comms is installed
    if (p.passengerCount &gt; 0 &amp;&amp; p.equipmentStatus(&quot;EQ_BROADCASTCOMMSMFD&quot;) === &quot;EQUIPMENT_OK&quot;) {
        if (system.isInterstellarSpace) {
            if (this._flags[8] === 1) this._interstellarSpaceTimer = new Timer(this, this.$interstellarSpaceMessage.bind(this), 7, 0);
        } else {
            if (this._flags[8] === 1) {
                if (this._impatientTimer &amp;&amp; this._impatientTimer.isRunning) this._impatientTimer.stop();
                this._impatientTimer = new Timer(this, this.$impatientMessage.bind(this), (60 * 10), (60 * 5)); // after 10 minutes, then every 5 mins after that
            }
            if (this._flags[7] === 1) {
                if (this._changeTimer &amp;&amp; this._changeTimer.isRunning) this._changeTimer.stop();
                this._changeTimer = new Timer(this, this.$doContractChange.bind(this), Math.random() * 60 + 30, 0);
            }
        }
    }

    this.$resetFoundFlag();
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function(to, from) {
    if (this._informPlayerOfSystem === true) {
        player.consoleMessage(&quot;New destination marked with white &#39;X&#39;&quot;, 6);
        this._informPlayerOfSystem = false;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$createPassengerContracts = function() {
    var bountySys = false;
    if (worldScripts.BountySystem_Core) bountySys = true;

	// no point in generating too many, but generally want 5 or more
	// some of them will be discarded later
	var numContracts = Math.floor(5 * Math.random() + 5 * Math.random() + 5 * Math.random() + (player.passengerReputationPrecise * Math.random()));
	if (player.passengerReputationPrecise &gt;= 0 &amp;&amp; numContracts &lt; 5)	{
		numContracts += 5;
	}
	if (numContracts &gt; 16) {
		numContracts = 16;
	} else if (numContracts &lt; 0) {
		numContracts = 0;
	}

	// some of these possible contracts may be discarded later on
	for (var i = 0; i &lt; numContracts; i++) {
		// pick a random system to take the passenger to
		var destination = Math.floor(Math.random() * 256);
		// discard if chose the current system
		if (destination === system.ID) continue;
		// get the SystemInfo object for the destination
		var destinationInfo = System.infoForSystem(galaxyNumber, destination);
        // skip nova systems
		if (destinationInfo.sun_gone_nova) continue;

        // create a passenger contract record
        this.$createRecord(destinationInfo, bountySys);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$createRecord = function(sys, bountySystem) {
    // this part is the same as core
    var passenger = {};
    var daysUntilDeparture = 1 + (Math.random() * (7 + player.passengerReputationPrecise - sys.government));
    if (daysUntilDeparture &lt;= 0) { 
        // loses some more contracts if reputation negative
        return;
    }
   
    var route = system.info.routeToSystem(sys);
    if (!route || route.route.length === 0) return;

    passenger.payment = 0;
    passenger.destination = sys.systemID;
    passenger.route = route;
    if (Math.random() &lt; 0.5) {// 50% local inhabitant
        passenger.species = system.info.inhabitant;
    } else { // 50% random species (which will be 50%ish human)
        passenger.species = System.infoForSystem(galaxyNumber, Math.floor(Math.random() * 256)).inhabitant;
    }

    if (passenger.species.match(new RegExp(expandDescription(&quot;[human-word]&quot;), &quot;i&quot;))) {
        passenger.name = expandDescription(&quot;%N &quot;) + expandDescription(&quot;[nom]&quot;);
    } else {
        passenger.name = randomName() + &quot; &quot; + randomName();
    }

    /* Because passengers with duplicate names won&#39;t be accepted,
     * check for name duplication with either other passengers
     * here or other passengers carried by the player, and adjust
     * this passenger&#39;s name a little if there&#39;s a match */
    do {
        var okay = true;
        for (var j = 0; j &lt; player.ship.passengers.length; j++) {
            if (player.ship.passengers[j].name == passenger.name) {
                okay = false;
                break;
            }
        }
        if (okay) {
            var bb = worldScripts.BulletinBoardSystem;
            var data = bb._data;
            for (var j = 0; j &lt; data.length; j++) {
                var item = data[j];
                if (item.data &amp;&amp; item.data.hasOwnProperty(&quot;type&quot;) &amp;&amp; item.data.type === &quot;enhanced_passenger&quot; &amp;&amp; item.data.details.name == passenger.name) {
                    okay = false;
                    break;
                }
            }
        }
        if (!okay) passenger.name += &quot;a&quot;;
    } while (!okay);

    // risk
    passenger.risk = Math.floor(Math.random()*3);
    passenger.species = expandDescription(&quot;[passenger-description-risk&quot; + passenger.risk + &quot;]&quot;) + &quot; &quot; + passenger.species;
    
    // time allowed for delivery is time taken by &quot;fewest jumps&quot;
    // route, plus timer above. Higher reputation makes longer
    // times available.
    var d_time = Math.floor(daysUntilDeparture * 86400) + (passenger.route.time * 3600);
    passenger.deadline = clock.adjustedSeconds + d_time;
    if (passenger.risk &lt; 2 &amp;&amp; sys.government &lt;= 1 &amp;&amp; Math.random() &lt; 0.5) {
        passenger.risk++;
    }

    // ok, we have a valid target - what sort of destination is this?
    // total payment is:
    passenger.payment = Math.floor(
        // payment per hop (higher at rep &gt; 5)
        5 * Math.pow(route.route.length - 1, (passenger.risk * 0.2) + (player.passengerReputationPrecise &gt; 5 ? 2.45 : 2.3)) +
            // payment by route length
            route.distance * (8 + (Math.random() * 8)) +
            // premium for delivery to more dangerous systems
            (5 * (7 - sys.government) * (7 - sys.government))
    );
    passenger.payment *= (Math.random() + Math.random() + Math.random() + Math.random()) / 2;

    var prudence = (2 * Math.random()) - 1;
    var desperation = (Math.random() * (0.5 + passenger.risk)) * (1 + 1 / (Math.max(0.5, d_time - (route.time * 3600))));
    var competency = Math.max(50, (route.route.length - 1) * (0.5 + (passenger.risk * 2)));
    if (passenger.risk == 0) competency -= 30;

    passenger.payment = Math.floor(passenger.payment * (1 + (0.4 * prudence)));
    passenger.payment += (passenger.risk * 200);
    passenger.skill = Math.min(60, competency + 20 * (prudence - desperation));

    // this is the enhanced stuff
    passenger.changed = false;

    var typeCheck = Math.random() * (10 + (7 - sys.economy));
    var avoidGov = 0.2;
    var avoidSpecies = 0.2;
    var avoidSystem = 0.2;
    var bonusSystem = 0.2; 
    var smooth = 0.1;
    var noScan = 0.2;
    if (typeCheck &gt;= 9) {
        smooth = 0.5;
        noScan = 0.6;
    } else if (typeCheck &gt;= 7) {
        smooth = 0.2;
        noScan = 0.4;
    }
    //log(this.name, &quot;Passenger &quot; + passenger.name);

    passenger.smooth = false;
    // only low-risk passengers want smooth flights, on shorter trips only
    if (this._flags[6] === 1 &amp;&amp; passenger.risk === 0 &amp;&amp; route.route.length &lt; 10 &amp;&amp; Math.random() &lt; smooth) {
        // this passenger wants a smooth flight
        passenger.smooth = true;
        // make the payment a bit larger 
        //log(this.name, &quot;pre smooth loading  = &quot; + passenger.payment);
        passenger.payment = Math.floor(passenger.payment * this._smoothFlightLoading);
        //log(this.name, &quot;post smooth loading = &quot; + passenger.payment);
        //passenger.changed = true; // we&#39;ll prevent these passengers from making mid-route changes, though
    }

    passenger.avoidGovType = -1;
    if (this._flags[0] === 1 &amp;&amp; Math.random() &lt; avoidGov) {
        do {
            passenger.avoidGovType = Math.floor(Math.random() * 8);
        } while (passenger.avoidGovType === sys.government || passenger.avoidGovType === system.government);
        //log(this.name, &quot;pre avoidGov loading  = &quot; + passenger.payment);
        passenger.payment = Math.floor(passenger.payment * this._avoidGovTypeLoading);
        //log(this.name, &quot;post avoidGov loading = &quot; + passenger.payment);
    }

    passenger.avoidSpecies = &quot;&quot;;
    if (this._flags[1] === 1 &amp;&amp; passenger.avoidGovType === -1 &amp;&amp; Math.random() &lt; avoidSpecies) {
        do {
            passenger.avoidSpecies = this._inhabitantTypes[Math.floor(Math.random() * this._inhabitantTypes.length)];
        } while (sys.inhabitants.indexOf(passenger.avoidSpecies) &gt;= 0 || passenger.species.indexOf(passenger.avoidSpecies) &gt;= 0);
        //log(this.name, &quot;pre avoidSpecies loading  = &quot; + passenger.payment);
        passenger.payment = Math.floor(passenger.payment * this._avoidSpeciesLoading);
        //log(this.name, &quot;post avoidSpecies loading = &quot; + passenger.payment);
    }

    var rt = system.info.routeToSystem(sys, &quot;OPTIMIZED_BY_TIME&quot;);
    
    passenger.avoidSysList = [];
    if (this._flags[2] === 1 &amp;&amp; Math.random() &lt; avoidSystem) {
        // how many will we have to avoid?
        var num = Math.floor(route.route.length * 0.2);
        if (num &gt; 3) num = 3;
        if (num &lt; 1) num = 1;
        //log(this.name, &quot;number to avoid &quot; + num + &quot;, routeLen = &quot; + route.route.length);
        for (var i = 0; i &lt; num; i++) {
            // sometime pick a system on the quick route
            if (Math.random() &gt; 0.6) {
                var tgt = System.infoForSystem(galaxyNumber, rt.route[Math.floor(Math.random() * (rt.route.length - 1))]);
            } else {
                var tgt = System.infoForSystem(galaxyNumber, route.route[Math.floor(Math.random() * (route.route.length - 1))]);
            }
            // make sure we avoid any conflicts with other clauses
            if ((passenger.avoidGovType === -1 || passenger.avoidGovType != tgt.government) &amp;&amp; 
                (passenger.avoidSpecies === &quot;&quot; || tgt.inhabitants.indexOf(passenger.avoidSpecies) === -1) &amp;&amp;
                tgt.systemID != system.ID &amp;&amp; 
                passenger.avoidSysList.indexOf(tgt.systemID) === -1) {
                passenger.avoidSysList.push(tgt.systemID);
                passenger.payment = Math.floor(passenger.payment * this._avoidSystemLoading);
            }
        }
        //log(this.name, &quot;avoid sysList = &quot; + passenger.avoidSysList.length);
    }

    passenger.bonusSysList = [];
    if (this._flags[3] === 1 &amp;&amp; Math.random() &lt; bonusSystem) {
        // how many extra will we have?
        var num = Math.floor(route.route.length * 0.2);
        if (num &gt; 3) num = 3;
        if (num &lt; 1) num = 1;
        // get the fast route as well
        //log(this.name, &quot;potential bonus systems &quot; + num + &quot;, routeLen = &quot; + route.route.length);
        for (var i = 0; i &lt; num; i++) {
            // make sure the point we pick along the route is not the start or end point
            var point = Math.floor(Math.random() * (route.route.length - 2)) + 1;
            var tgtList = System.infoForSystem(galaxyNumber, route.route[point]).systemsInRange(6);
            var tgt = tgtList[Math.floor(Math.random() * tgtList.length)];
            // make sure we avoid any conflicts with other clauses
            if ((passenger.avoidGovType === -1 || passenger.avoidGovType != tgt.government) &amp;&amp; 
                (passenger.avoidSpecies === &quot;&quot; || tgt.inhabitants.indexOf(passenger.avoidSpecies) === -1) &amp;&amp;
                route.route.indexOf(tgt.systemID) === -1 &amp;&amp; 
                rt.route.indexOf(tgt.systemID) === -1 &amp;&amp; 
                passenger.avoidSysList.indexOf(tgt.systemID) === -1 &amp;&amp;
                passenger.bonusSysList.indexOf(tgt.systemID) === -1) 
                passenger.bonusSysList.push(tgt.systemID);
        }
        //log(this.name, &quot;bonus sysList = &quot; + passenger.bonusSysList.length);
    }

    passenger.noScan = false;
    passenger.bounty = 0;
    passenger.hiddenBounty = 0;
    passenger.found = false;
    var custMenu = null;
    if (bountySystem) {
        // warrant check only available if player is clean
        if (player.bounty === 0 &amp;&amp; this._flags[4] === 1) {
            custMenu = [];
            custMenu.push({text:&quot;Request GalCop Warrant Information&quot;, worldScript:this.name, callback:&quot;$doWarrantCheck&quot;, condition:&quot;$warrantCheckAvailable&quot;, autoRemove:true});
        }

        if (this._flags[4] === 1 &amp;&amp; Math.random() &lt; ((8 - system.government) / 8)) {
            if (Math.random() &gt; 0.8) { 
                // this passenger has a bounty
                passenger.bounty += Math.floor(Math.random() * (10 - system.government) + 5);
                // make the payment a bit larger - this passenger knows it&#39;s riskier
                //log(this.name, &quot;pre bounty loading  = &quot; + passenger.payment);
                passenger.payment = Math.floor(passenger.payment * this._bountyLoading);
                //log(this.name, &quot;post bounty loading = &quot; + passenger.payment);
            } else {
                // this passenger has a hidden bounty
                passenger.hiddenBounty += Math.floor(Math.random() * (10 - system.government) + 5);
                //log(this.name, passenger.name + &quot; - &quot; + passenger.hiddenBounty);
            }
        }
        if (this._flags[5] === 1 &amp;&amp; Math.random() &gt; 0.8) { 
            // but only some will care, even those who don&#39;t have a bounty
            if (passenger.smooth === false &amp;&amp; Math.random() &lt; noScan) {
                passenger.noScan = true;
                // make the payment a bit larger 
                //log(this.name, &quot;pre noscan loading  = &quot; + passenger.payment);
                passenger.payment = Math.floor(passenger.payment * this._noScanLoading);
                //log(this.name, &quot;post noscan loading = &quot; + passenger.payment);
            }
        }
    }

    passenger.advance = Math.min(passenger.payment * 0.9, Math.max(0, Math.floor(passenger.payment * (0.05 + (0.1 * desperation) + (0.02 * player.passengerReputationPrecise))))); // some% up front
    passenger.payment -= passenger.advance;

    this.$ovr_addPassengerToSystem(passenger, custMenu);
}

//-------------------------------------------------------------------------------------------------------------
this.$disableCorePassengerContracts = function() {
    var psngr = worldScripts[&quot;oolite-contracts-passengers&quot;];
    // remove the event hooks
    delete psngr.shipWillExitWitchspace;
    delete psngr.playerWillSaveGame;
    delete psngr.shipWillLaunchFromStation;
    delete psngr.guiScreenWillChange;
    delete psngr.guiScreenChanged;
    // intercept the _addPassengerToSystem function
    psngr._addPassengerToSystem = this.$ovr_addPassengerToSystem;

    // if contracts on BB is installed, we don&#39;t need this function
    if (worldScripts.ContractsOnBB) {
        delete this.playerCompletedContract;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$removeExistingContracts = function() {
    // clear the array
    var psngr = worldScripts[&quot;oolite-contracts-passengers&quot;];
    if (psngr.$passengers &amp;&amp; psngr.length &gt; 0) psngr.$passengers.length = 0;
    system.mainStation.setInterface(&quot;oolite-contracts-passengers&quot;, null);
    // remove any pre-existing BB passenger contracts
    if (worldScripts.ContractsOnBB) {
        var cobb = worldScripts.ContractsOnBB;
        var bb = worldScripts.BulletinBoardSystem;
        // remove anything already there
        var curr = cobb.$countContracts(32000);
        //log(this.name, &quot;current &quot; + curr);
        if (curr &gt; 0) {
            for (var i = 0; i &lt; curr; i++) {
                bb.$removeBBMission(32000 + i);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$ovr_addPassengerToSystem = function(passenger, custMenu) {
    var xui = false;
    var ovr = &quot;&quot;;
    if (worldScripts.XenonReduxUI) {
        xui = true;
        ovr = {name:&quot;xrui-boardingpass.png&quot;, height:546};
    }
    if (worldScripts.XenonUI) {
        xui = true;
        ovr = {name:&quot;xui-boardingpass.png&quot;, height:546};
    } 

    // we won&#39;t attempt to change any other passenger - just the ones we create
    // so we&#39;ll flag any contract that arrives here as having been changed
    if (passenger.hasOwnProperty(&quot;changed&quot;) === false) {
        passenger.changed = true;
    }

    var cust = [];
    if (passenger.advance &gt; 0) cust.push({heading:expandDescription(&quot;[epc_contract-advance]&quot;), value:formatCredits(passenger.advance, true, true)});
    cust.push({heading:expandDescription(&quot;[epc_contract-clientname]&quot;), value:passenger.name + &quot;, a &quot; + passenger.species});

    if (passenger.hasOwnProperty(&quot;bounty&quot;) &amp;&amp; passenger.bounty &gt; 0) {
        cust.push({heading:expandDescription(&quot;[epc_contract-bounty]&quot;), value:(passenger.bounty &gt;= 50 ? &quot;Fugitive&quot; : &quot;Offender&quot;) + &quot; (&quot; + passenger.bounty + &quot;)&quot;});
    }
    var additional = &quot;.&quot;;
    var addCount = 0;

    var smooth_text = &quot;&quot;;
    if (passenger.hasOwnProperty(&quot;smooth&quot;) === true &amp;&amp; passenger.smooth === true) {
        smooth_text = expandDescription(&quot;[epc_contract-no-wildness]&quot;);
        addCount += 1;
    } else {
        passenger.smooth = false;
    }
    var scan_text = &quot;&quot;;
    if (passenger.hasOwnProperty(&quot;noScan&quot;) === true &amp;&amp; passenger.noScan === true) {
        scan_text = expandDescription(&quot;[epc_contract-no-scan]&quot;);
        addCount += 1;
    } else {
        passenger.noScan = false;
    }
    var avoidGov_text = &quot;&quot;;
    if (passenger.hasOwnProperty(&quot;avoidGovType&quot;) === true &amp;&amp; passenger.avoidGovType &gt;= 0) {
        avoidGov_text = expandDescription(&quot;[epc_contract-avoid-gov]&quot;, {govType:this._govTypeNames[passenger.avoidGovType]});
        addCount += 1;
    } else {
        passenger.avoidGovType = -1;
    }
    var avoidSpecies_text = &quot;&quot;;
    if (passenger.hasOwnProperty(&quot;avoidSpecies&quot;) === true &amp;&amp; passenger.avoidSpecies != &quot;&quot;) {
        avoidSpecies_text = expandDescription(&quot;[epc_contract-avoid-species]&quot;, {species:passenger.avoidSpecies});
        addCount += 1;
    } else {
        passenger.avoidSpecies = &quot;&quot;
    }
    var addMarkers = [];
    var avoidSysList_text = &quot;&quot;;
    var govs = new Array();
    for (var i = 0; i &lt; 8 ; i++) govs.push(String.fromCharCode(i));
    if (passenger.hasOwnProperty(&quot;avoidSysList&quot;) === true &amp;&amp; Array.isArray(passenger.avoidSysList) === true &amp;&amp; passenger.avoidSysList.length &gt; 0) {
        var listText = &quot;&quot;;
        for (var i = 0; i &lt; passenger.avoidSysList.length; i++) {
            var sys = System.infoForSystem(galaxyNumber, passenger.avoidSysList[i]);
            listText += &quot;\n -- &quot; + sys.name + &quot; (&quot; + govs[sys.government] + &quot; TL&quot; + (sys.techlevel + 1) + &quot;)&quot;;
            addMarkers.push({destination:sys.systemID, markerColor:&quot;yellowColor&quot;, markerShape:&quot;MARKER_X&quot;});
        }
        avoidSysList_text = expandDescription(&quot;[epc_contract-avoid-systems]&quot;, {syslist:listText});
        addCount += 1;
    }
    var bonusSysList_text = &quot;&quot;;
    if (passenger.hasOwnProperty(&quot;bonusSysList&quot;) === true &amp;&amp; Array.isArray(passenger.bonusSysList) === true &amp;&amp; passenger.bonusSysList.length &gt; 0) {
        var listText = &quot;&quot;;
        for (var i = 0; i &lt; passenger.bonusSysList.length; i++) {
            var sys = System.infoForSystem(galaxyNumber, passenger.bonusSysList[i]);
            listText += &quot;\n -- &quot; + sys.name + &quot; (&quot; + govs[sys.government] + &quot; TL&quot; + (sys.techlevel + 1) + &quot;)&quot;;
            addMarkers.push({destination:sys.systemID, markerColor:&quot;greenColor&quot;, markerShape:&quot;MARKER_X&quot;});
        }
        bonusSysList_text = expandDescription(&quot;[epc_contract-bonus-systems]&quot;, {bonus:formatInteger(this._bonusSystemLoading * 100) + &quot;% of payment&quot;, syslist:listText});
        addCount += 1;
    }
    if (addCount &gt; 0) additional = expandDescription(&quot;[epc_additional-clauses]&quot;, {multiChange:(addCount === 1 ? &quot;&quot; : &quot;s&quot;)});

    var customMenu = &quot;&quot;;
    if (custMenu != undefined) customMenu = custMenu;

    var bb = worldScripts.BulletinBoardSystem;
    bb.$addBBMission({
        source:system.ID,
        destination:passenger.destination,
        stationKey:&quot;mainStation&quot;,
        description:expandDescription(&quot;[epc_contract-passenger-title]&quot;),
        details:expandDescription(&quot;[epc_contract-passenger-description]&quot;, {client:passenger.name, destination:System.systemNameForID(passenger.destination), extra:(additional + smooth_text + avoidGov_text + avoidSpecies_text + avoidSysList_text + bonusSysList_text + scan_text)}),
        payment:passenger.payment,
        allowTerminate:false,
        completionType:&quot;IMMEDIATE&quot;,
        stopTimeAtComplete:true,
        allowPartialComplete:false,
        expiry:passenger.deadline,
        disablePercentDisplay:true,
        noEmails:true,
        playAcceptedSound:false,
        markerShape:&quot;NONE&quot;, // marker control will be handled by contracts system
        overlay:(xui === true ? ovr : &quot;&quot;),
        customDisplayItems:cust,
        customMenuItems:customMenu,
        additionalMarkers:addMarkers,
        initiateCallback:&quot;$acceptPassengerContract&quot;,
        availableCallback:&quot;$passengerContractAvailable&quot;,
        worldScript:this.name,
        data:{type:&quot;enhanced_passenger&quot;, details:passenger}
    });
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptPassengerContract = function(missID) {
    //log(this.name, &quot;accepted contract &quot; + missID);
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    this.$acceptContract(item.data.details);
}

//-------------------------------------------------------------------------------------------------------------
// perform checks to see if the passenger contract can be accepted by the player
this.$passengerContractAvailable = function(missID) {
    var pc = worldScripts[&quot;oolite-contracts-passengers&quot;];
    var item = worldScripts.BulletinBoardSystem.$getItem(missID);
	// temp variable to simplify code
    var passenger = item.data.details;
    if (passenger) {
        var playerrep = worldScripts[&quot;oolite-contracts-helpers&quot;]._playerSkill(player.passengerReputationPrecise);
        if (player.ship.passengerCapacity &lt;= player.ship.passengerCount) {
            return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable&quot;).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
        } 
        else if (playerrep &lt; passenger.skill) {
            var utype = &quot;both&quot;;
            if (player.passengerReputationPrecise*10 &gt;= passenger.skill) {
                utype = &quot;kills&quot;;
            } else if (Math.sqrt(player.score) &gt;= passenger.skill) {
                utype = &quot;rep&quot;;
            }
            return expandMissionText(&quot;oolite-contracts-passengers-command-unavailable-&quot;+utype).replace(&quot;(&quot;, &quot;&quot;).replace(&quot;)&quot;, &quot;&quot;);
        }
    }
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptContract = function(passenger) {
    // give the passenger to the player
    this._internal = true;
    this.$disableEmails();
    this._sendEmailType = 1;
    var result = player.ship.addPassenger(passenger.name, system.ID, passenger.destination, passenger.deadline, passenger.payment, passenger.advance, passenger.risk);
    this.$enableEmails();
    this._sendEmailType = 0;
    this._internal = false;
	var helpers = worldScripts[&quot;oolite-contracts-helpers&quot;];
	if (result)	{
        // pay the advance
		player.credits += passenger.advance;

		helpers._soundSuccess();

		if (passenger.risk &gt; 0) {
			// once for medium risk
			helpers._setClientName(passenger.name);
			if (passenger.risk &gt; 1) {
				// three times for high risk
				helpers._setClientName(passenger.name);
				helpers._setClientName(passenger.name);
			}
		}
	} else {
		// else must have had another passenger board recently
		// (unlikely, but another OXP could have done it)
		helpers._soundFailure();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$countAvailableContracts = function() {
    var count = 0;
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    for (var i = 0; i &lt; data.length; i++) {
        var item = data[i];
        if (item.accepted === false &amp;&amp; item.data &amp;&amp; item.data.hasOwnProperty(&quot;type&quot;) &amp;&amp; item.data.type === &quot;enhanced_passenger&quot;) count += 1;
    }
    //log(this.name, &quot;count contracts &quot; + count);
    return count;
}

//-------------------------------------------------------------------------------------------------------------
this.$doContractChange = function $doContractChange() {
    // go through all the accepted passenger contracts and see if any of them want to change their destination
    var p = player.ship;
    if (player.alertCondition === 3) {
        if (Math.random() &gt; 0.0) {
            this._changeTimer = new Timer(this, this.$doContractChange.bind(this), Math.random() * 60 + 30, 0);
        }
        return; // maybe try again shortly
    }
    // make sure we still have broadcast comms (might have been damaged)
    if (p.equipmentStatus(&quot;EQ_BROADCASTCOMMSMFD&quot;) !== &quot;EQUIPMENT_OK&quot;) return;
    for (var i = 0; i &lt; p.passengers.length; i++) {
        var passenger = p.passengers[i];
        if (Math.random() &gt; 0.0 &amp;&amp; passenger.destination != system.ID) {  // 0.8
            // how far away is the destination
            var sys = System.infoForSystem(galaxyNumber, passenger.destination);
            var rt = system.info.routeToSystem(sys, &quot;OPTIMIZED_BY_TIME&quot;);
            // if there&#39;s no route to the system, or there&#39;s more than 2 jumps left, we&#39;re good to go
            if (!rt || rt.route.length &gt; 2) {
                var sysList = system.info.systemsInRange(30);
                var newsys = sysList[Math.floor(Math.random() * sysList.length)];
                var newrt = system.info.routeToSystem(newsys, &quot;OPTIMIZED_BY_TIME&quot;);
                if (newrt &amp;&amp; newrt.route.length &gt; 1 &amp;&amp; newrt.route.length &gt; rt.route.length) {
                    var bb = worldScripts.BulletinBoardSystem;
                    var data = bb._data;
                    var bbitem = null;
                    for (var j = 0; j &lt; data.length; j++) {
                        var item = data[j];
                        if (item.accepted === true &amp;&amp; item.worldScript === this.name) {
                            if (item.data.details.name === passenger.name &amp;&amp; item.data.details.destination === passenger.destination) {
                                bbitem = item;
                                break;
                            }
                        }
                    }
                    // if this passenger has already done a mid-flight change, don&#39;t do another one
                    if (!bbitem) continue;
                    var dtls = bbitem.data.details;
                    if (dtls.changed === true) continue;
                    // make sure we dont conflict with other types
                    if (dtls.avoidGovType &gt;= 0 &amp;&amp; newsys.government === dtls.avoidGovType) continue;
                    if (dtls.avoidSpecies != &quot;&quot; &amp;&amp; newsys.inhabitants.indexOf(dtls.avoidSpecies) &gt;= 0) continue;
                    if (dtls.avoidSysList.length &gt; 0 &amp;&amp; dtls.avoidSysList.indexOf(newsys.systemID) &gt;= 0) continue;
                    if (dtls.bonusSysList.length &gt; 0 &amp;&amp; dtls.bonusSysList.indexOf(newsys.systemID) &gt;= 0) continue;
                    // found a target!
                    // time to power up the MFD
                    var diff = Math.abs(newrt.route.length - rt.route.length);
                    //log(this.name, &quot;diff &quot; + diff + &quot;, risk &quot; + passenger.risk + &quot;, gov &quot; + newsys.government);
                    var extra = Math.pow(diff, (passenger.risk + 1) * 1.5) * (14 - newsys.government);
                    if (extra &lt; 50) extra = 50;
                    var txt = expandDescription(&quot;[epc_new-destination]&quot;, {client:passenger.name, original_system:sys.name, new_system:newsys.name, extra:formatCredits(extra, false, true)});
                    // store some data for quick pickup later
                    this._newDest = {
                        name:passenger.name, 
                        original:sys.systemID, 
                        source:item.source,
                        newDest:newsys.systemID, 
                        deadline:clock.adjustedSeconds + (newrt.time * 3600),
                        species:passenger.species,
                        risk:passenger.risk,
                        skill:dtls.skill,
                        advance:passenger.premium,
                        payment:passenger.fee,
                        newRoute:newrt,
                        smooth:dtls.smooth,
                        noScan:dtls.noScan,
                        bounty:dtls.bounty,
                        avoidGovType:dtls.avoidGovType,
                        avoidSpecies:dtls.avoidSpecies,
                        // next two should always be empty (because we are preventing those types from changing their minds)
                        // but in case /we/ ever change our minds...
                        avoidSysList:(dtls.hasOwnProperty(&quot;avoidSysList&quot;) ? dtls.avoidSysList : []),
                        bonusSysList:(dtls.hasOwnProperty(&quot;bonusSysList&quot;) ? dtls.bonusSysList : []),
                        hiddenBounty:dtls.hiddenBounty,
                        found:dtls.found,
                        bbID:bbitem.ID,
                        extra:extra
                    };

                    mission.markSystem({system:newsys.systemID, name:&quot;epc_newDest&quot;, markerColor:&quot;whiteColor&quot;, markerShape:&quot;MARKER_X&quot;});
                    this._informPlayerOfSystem = true;
                    // set this value so if the player declines, we won&#39;t keep asking on this passenger
                    bbitem.data.details.changed = true;
                    // communicate with player about the new mission
                    worldScripts.EnhancedPassengerMFD.$updateMFD(txt);
                    break;
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
// routine to check the combat simulator worldscript, to see if it&#39;s running or not
this.$simulatorRunning = function() {
	var w = worldScripts[&quot;Combat Simulator&quot;];
	if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptPendingChange = function() {
    if (!this._newDest || this._newDest == null) return;
    // get a copy of the passenger details
    var p = player.ship;
    // remove the system mark
    mission.unmarkSystem({system:this._newDest.newDest, name:&quot;epc_newDest&quot;});
    this._informPlayerOfSystem = false;
    // remove the old passenger
    p.removePassenger(this._newDest.name)
    // add them back in with the new details
    this._internal = true;
    this.$disableEmails();
    this._sendEmailType = 2;
    var result = p.addPassenger(this._newDest.name, this._newDest.source, this._newDest.newDest, this._newDest.deadline, parseInt(this._newDest.payment) + parseInt(this._newDest.extra), this._newDest.advance, this._newDest.risk);
    this._sendEmailType = 0;
    this.$enableEmails();
    this._internal = false;
    // update the bb
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(this._newDest.bbID);
    item.destination = this._newDest.newDest;
    item.destinationName = System.systemNameForID(this._newDest.newDest);
    item.expiry = this._newDest.deadline;
    item.payment = this._newDest.payment + this._newDest.extra;
    item.data.details = {
        payment: this._newDest.payment + this._newDest.extra,
        destination: this._newDest.newDest,
        route: this._newDest.newRoute,
        species: this._newDest.species,
        name: this._newDest.name,
        risk: this._newDest.risk,
        deadline: this._newDest.deadline,
        skill: this._newDest.skill,
        advance: this._newDest.advance,
        smooth: this._newDest.smooth,
        noScan: this._newDest.noScan,
        bounty: this._newDest.bounty,
        avoidGovType: this._newDest.avoidGovType,
        avoidSpecies: this._newDest.avoidSpecies,
        avoidSysList: this._newDest.avoidSysList,
        bonusSysList: this._newDest.bonusSysList,
        hiddenBounty: this._newDest.hiddenBounty,
        found: this._newDest.found,
        changed: true
    };

    delete this._newDest;
}

//-------------------------------------------------------------------------------------------------------------
this.$declinePendingChange = function() {
    // remove the system mark
    mission.unmarkSystem({system:this._newDest.newDest, name:&quot;epc_newDest&quot;});
    this._informPlayerOfSystem = false;
    // just delete the details
    delete this._newDest;
}

//-------------------------------------------------------------------------------------------------------------
this.$startTimers = function() {
    // check if we have any need to monitor for movement/attacks
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    var start = false;
    var found = false;
    // look for any passengers, and if we need to monitor for wild movement
    for (var i = 0; i &lt; data.length; i++) {
        if (data[i].accepted === true &amp;&amp; data[i].worldScript === this.name) {
            found = true;
            if (data[i].data.details.smooth === true) {start = true; break;}
        }
    }
    // set up the chat timer
    if (found === true &amp;&amp; this._flags[8] === 1) {
        this._transmissions.length = 0;
        this._chatTimer = new Timer(this, this.$sendChatMessage, Math.floor(Math.random() * 120 + 60), Math.floor(Math.random() * 120) + 60);
        this.shipTargetDestroyed = this.$epc_shipTargetDestroyed;
        this.shipTakingDamage = this.$epc_shipTakingDamage;
    }
    // if we don&#39;t have a need for a wild movement monitor, exit here.
    if (start === false) return;
    // otherwise, set up the properties, events, fcb and monitor timer
    var p = player.ship;
    p.script._epc_wildMovement = 0;
    p.script._epc_wildMovementWarning = false;
    p.script._epc_attacked = 0;
    p.script._epc_stable = 0.0;
    // some ships will be sluggish, so &quot;wild movement&quot; isn&#39;t really possible for them
    // so max sure than wild movement will only be calculated for ships that have the possibility of it
    // for those with pitch/roll stats lower than these values, it won&#39;t trigger
    p.script._maxPitch = Math.max(0.75, p.maxPitch);
    p.script._maxRoll = Math.max(1, p.maxRoll);
    this.shipBeingAttacked = this.$epc_shipBeingAttacked;
    this._frameCallbackID = addFrameCallback(this.$checkForWildMovement.bind(this));
    this._monitorWildMovementTimer = new Timer(this, this.$monitorWildMovement.bind(this), 5, 5);
}

//-------------------------------------------------------------------------------------------------------------
this.$stopTimers = function() {
    if (this._chatTimer &amp;&amp; this._chatTimer.isRunning) {
        this._chatTimer.stop();
        this._chatTimer = null;
    }
	if (this._changeTimer &amp;&amp; this._changeTimer.isRunning) {
        this._changeTimer.stop();
        this._changeTimer = null;
    }
    if (this._monitorWildMovementTimer &amp;&amp; this._monitorWildMovementTimer.isRunning) {
        this._monitorWildMovementTimer.stop();
        this._monitorWildMovementTimer = null;
    }
    if (this._complimentTimer &amp;&amp; this._complimentTimer.isRunning) {
        this._complimentTimer.stop();
        this._complimentTimer = null;
    }
    if (this._damageTimer &amp;&amp; this._damageTimer.isRunning) {
        this._damageTimer.stop();
        this._damageTimer = null;
    }
    if (this._impatientTimer &amp;&amp; this._impatientTimer.isRunning) {
        this._impatientTimer.stop();
        this._impatientTimer = null;
    }
    delete this.shipTargetDestroyed;
    delete this.shipTakingDamage;
    this.$stopFrameCallback();
}

//-------------------------------------------------------------------------------------------------------------
this.$stopFrameCallback = function() {
	if (this._frameCallbackID &amp;&amp; isValidFrameCallback(this._frameCallbackID)) {
		removeFrameCallback(this._frameCallbackID);
	}
    delete this._frameCallbackID;
    delete this.shipBeingAttacked;
}

//-------------------------------------------------------------------------------------------------------------
this.$checkForWildMovement = function $checkForWildMovement(delta) {
    var p = player.ship;
    var ps = p.script;
    if (!p || p.isValid === false || !ps) return;
    // are we moving around a lot?
    if (ps._maxPitch - Math.abs(p.pitch) &lt; 0.0001) {ps._epc_wildMovement += delta; ps._epc_stable = 0; return;}
    if (ps._maxRoll - Math.abs(p.roll) &lt; 0.0001) {ps._epc_wildMovement += delta; ps._epc_stable = 0; return;}
    // monitor how long we&#39;ve been flying in a stable way
    ps._epc_stable += delta;
    // every 30 seconds or so, bring down our wild movement amount
    if (ps._epc_stable &gt; 15) {
        ps._epc_stable = 0;
        if (ps._epc_wildMovement &gt; 0) {
            ps._epc_wildMovement -= 1;
        }
        if (ps._epc_attacked &gt; 0) {
            ps._epc_attacked -= 1;
        }
        // reset the warning flag if we get back to 0 again
        if (ps._epc_wildMovement &lt;= 0 || ps._epc_attacked &lt;= 0) {
            ps._epc_wildMovementWarning = false;
            ps._epc_wildMovement = 0;
            ps._epc_attacked = 0;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$monitorWildMovement = function $monitorWildMovement() {
    var p = player.ship;
    var ps = p.script;
    var ding = false;
    if (!p || p.isValid === false || !ps) {
        this._monitorWildMovementTimer.stop();
        return;
    }
    //log(this.name, &quot;wm = &quot; + ps._epc_wildMovement + &quot;, lh &quot; + ps._epc_attacked);
    // send warning after 15 seconds of wild movement or 20 laser hits
    if ((ps._epc_wildMovement &gt; 15 || ps._epc_attacked &gt; 20) &amp;&amp; ps._epc_wildMovementWarning === false) {
        // find a contract who can act as spokesperson for anyone else.
        var bb = worldScripts.BulletinBoardSystem;
        var data = bb._data;
        for (var i = 0; i &lt; data.length; i++) {
            var item = data[i];
            if (item.accepted === true &amp;&amp; item.worldScript === this.name) {
                var passenger = item.data.details;
                if (passenger.smooth === true) {
                    //log(this.name, &quot;sending wild movement warning for &quot; + passenger.name);
                    this.$transmitMessageFromPassenger(passenger, &quot;[passenger-response-not-comfortable-warning]&quot;);
                    break;
                }
            }
        }
        ps._epc_wildMovementWarning = true;
        player.consoleMessage(&quot;&quot;);
        return;
    }
    // 30 seconds of wild movement or 40 hits
    if (ps._epc_wildMovement &gt; 30 || ps._epc_attacked &gt; 40) {
        ding = true;
        // reset the values so we don&#39;t keep sending the same message
        ps._epc_wildMovement = 0;
        ps._epc_attacked = 0;
    }

    if (ding === true) {
        // stop the frame callback - we&#39;re done
        this.$stopFrameCallback();

        var bb = worldScripts.BulletinBoardSystem;
        var data = bb._data;
        for (var i = 0; i &lt; data.length; i++) {
            var item = data[i];
            if (item.accepted === true &amp;&amp; item.worldScript === this.name) {
                var passenger = item.data.details;
                if (passenger.smooth === true) {
                    // oh dear
                    this.$transmitMessageFromPassenger(passenger, &quot;[passenger-response-not-comfortable]&quot;);

                    item.payment = item.payment * 0.5; // 50% reduction
                    passenger.payment = item.payment;
                    passenger.smooth = false; // turn this off now, so it can&#39;t happen twice
                    item.data.details = passenger;
                    // find and update the actual passenger record
                    for (var j = 0; j &lt; p.passengers.length; j++) {
                        var psngr = p.passengers[j];
                        if (psngr.name === passenger.name &amp;&amp; psngr.destination === item.destination) {
                            //log(this.name, &quot;failed for &quot; + psngr.name);
                            // remove the old passenger
                            p.removePassenger(passenger.name)
                            // add them back in with the new details
                            this._internal = true;
                            this.$disableEmails();
                            this._sendEmailType = 3;
                            var result = p.addPassenger(passenger.name, item.source, item.destination, passenger.deadline, passenger.payment, passenger.advance, passenger.risk);
                            this._sendEmailType = 0;
                            this.$enableEmails();
                            this._internal = false;
                            break;
                        }
                    }
                }
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$ovr_bountySystem_uncoverBounties = function(source) {
    var p = player.ship;
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    var done = false;
    // only do the check if the source of the scan is a police vessel, and we&#39;re in a high-level government system
    // (never in an anarchy, but more and more likely the higher the government level)
    if ((Math.random() * 7) &lt; system.government) {
        for (var i = 0; i &lt; data.length; i++) {
            var item = data[i];
            if (item.accepted === true &amp;&amp; item.worldScript === &quot;EnhancedPassengerContracts&quot;) {
                var passenger = item.data.details;
                // check for any passengers carrying a bounty - and potentially add a bounty to the player
                if (passenger.hiddenBounty &gt; 0 || passenger.bounty &gt; 0) {
                    // found one!
                    // ding the player and inform them
                    if (done === false &amp;&amp; passenger.found === false &amp;&amp; source.isPolice) {
                        done = true;
                        player.ship.setBounty(player.bounty + Math.floor(Math.random() * 5 + 2), &quot;transporting offenders&quot;);
                        source.commsMessage(expandDescription(&quot;[police-comms-offender-passenger]&quot;), player.ship);
                    }
                    passenger.found = true;
                    // add a custom display item to display the passenger bounty
                    if (passenger.bounty === 0) {
                        passenger.bounty = passenger.hiddenBounty;
                        passenger.hiddenBounty = 0;
                        item.customDisplayItems.push({heading:expandDescription(&quot;[epc_contract-bounty]&quot;), value:passenger.bounty});
                        item.data.details = passenger;
                    }
                }
                // check for any passengers who don&#39;t want to be scanned
                if (passenger.noScan === true) {
                    // oh dear
                    var epc = worldScripts.EnhancedPassengerContracts;
                    epc.$transmitMessageFromPassenger(passenger, &quot;[passenger-response-got-scanned]&quot;);

                    item.payment = item.payment * 0.25; // 75% reduction
                    passenger.payment = item.payment;
                    passenger.noScan = false; // turn this off now, so it can&#39;t happen twice
                    for (var j = 0; j &lt; p.passengers.length; j++) {
                        var psngr = p.passengers[j];
                        if (psngr.name === passenger.name &amp;&amp; psngr.destination === item.destination) {
                            // remove the old passenger
                            p.removePassenger(passenger.name)
                            // add them back in with the new details
                            epc._internal = true;
                            epc.$disableEmails();
                            epc._sendEmailType = 3;
                            var result = p.addPassenger(passenger.name, item.source, item.destination, passenger.deadline, passenger.payment, passenger.advance, passenger.risk);
                            epc._sendEmailType = 0;
                            epc.$enableEmails();
                            epc._internal = false;
                            break;
                        }
                    }
                    item.data.details = passenger;
                }
            }
        }
    }

    // do the standard uncover bounties
    this.$uncoverBounties_endpoint(source);
}

//-------------------------------------------------------------------------------------------------------------
this.$doWarrantCheck = function(missID) {
    var p = player.ship;
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    var found = false;

    var passenger = item.data.details;
    if (passenger.hiddenBounty &gt; 0) {
        passenger.bounty = passenger.hiddenBounty;
        passenger.hiddenBounty = 0;
        item.customDisplayItems.push({heading:expandDescription(&quot;[epc_contract-bounty]&quot;), value:passenger.bounty});
        player.consoleMessage(expandDescription(&quot;[epc_reveal-bounty]&quot;, {name:passenger.name, bounty:passenger.bounty}), 5);
        found = true;
    } else {
        player.consoleMessage(expandDescription(&quot;[epc_reveal-no-bounty]&quot;, {name:passenger.name}), 5);
    }
    item.payment = item.payment * 0.8; // 20% reduction
    passenger.payment = item.payment;
    item.data.details = passenger;
    for (var j = 0; j &lt; p.passengers.length; j++) {
        var psngr = p.passengers[j];
        if (psngr.name === passenger.name &amp;&amp; psngr.destination === item.destination) {
            // remove the old passenger
            p.removePassenger(passenger.name)
            // add them back in with the new details
            this._internal = true;
            this.$disableEmails();
            if (found === false) this._sendEmailType = 4;
            var result = p.addPassenger(passenger.name, item.source, item.destination, passenger.deadline, passenger.payment, passenger.advance, passenger.risk);
            this._sendEmailType = 0;
            this.$enableEmails();
            this._internal = false;
            break;
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$warrantCheckAvailable = function(missID) {
    var bb = worldScripts.BulletinBoardSystem;
    var item = bb.$getItem(missID);
    if (item.accepted === false) return &quot;only when contract accepted&quot;;
    if (item.data.details.bounty &gt; 0) return &quot;bounty already visible&quot;;
    return &quot;&quot;;
}

//-------------------------------------------------------------------------------------------------------------
this.$resetFoundFlag = function() {
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    for (var i = 0; i &lt; data.length; i++) {
        var item = data[i];
        if (item.accepted === true &amp;&amp; item.worldScript === this.name) {
            item.data.details.found = false;
        }
    }    
}

//-------------------------------------------------------------------------------------------------------------
// turns off contract emails, if they aren&#39;t already
this.$disableEmails = function() {
    if (worldScripts.GalCopAdminServices) {
        var ga = worldScripts.GalCopAdminServices;
        this._emailDisable = ga._disableContracts;
        ga._disableContracts = true;
    }
}

//-------------------------------------------------------------------------------------------------------------
// turns on contracts emails, if it was previously
this.$enableEmails = function() {
    if (worldScripts.GalCopAdminServices) {
        var ga = worldScripts.GalCopAdminServices;
        ga._disableContracts = this._emailDisable;
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$customPassengerContractEmail = function(contract) {
	var w = worldScripts.EmailSystem;
    if (!w || this._emailDisable === true) return;

    // look up the BB item
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    var item = null;
    for (var i = 0; i &lt; data.length; i++) {
        if (data[i].accepted === true &amp;&amp; 
            data[i].worldScript === this.name &amp;&amp; 
            data[i].destination === contract.destination &amp;&amp; 
            data[i].payment === contract.fee &amp;&amp; 
            data[i].source === contract.start) {

            item = data[i].data.details;
        }
    }
    if (item === null) return;

    var extras = this.$buildExtrasText(item);
    var sndr = expandDescription(&quot;[passenger-contract-sender]&quot;);
    var subj = &quot;Accepted contract: &quot; + contract.name;
    var msg = expandDescription(&quot;[epc_email-passenger-contract-start]&quot;,
        {contractname:contract.name,
        systemname:System.systemNameForID(contract.destination),
        time:global.clock.clockStringForTime(contract.arrival_time),
        fee:formatCredits(contract.fee, true, true),
        extras:extras
    });

	if (sndr != &quot;&quot;) {
		w.$createEmail({sender:sndr,
			subject:subj,
			date:global.clock.adjustedSeconds,
			message:msg
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$contractAdjustmentEmail = function(contract) {
	var w = worldScripts.EmailSystem;
    if (!w || this._emailDisable === true) return;

    // look up the BB item
    var bb = worldScripts.BulletinBoardSystem;
    var data = bb._data;
    var item = null;
    for (var i = 0; i &lt; data.length; i++) {
        if (data[i].accepted === true &amp;&amp; 
            data[i].worldScript === this.name &amp;&amp; 
            data[i].destination === contract.destination &amp;&amp; 
            data[i].payment === contract.fee &amp;&amp; 
            data[i].source === contract.start) {

            item = data[i].data.details;
        }
    }
    if (item === null) return;

    var adjType = &quot;&quot;;
    switch (this._sendEmailType) {
        case 2:
            adjType = &quot;[epc_email-contract-amend-destination]&quot;;
            break;
        case 3:
            adjType = &quot;[epc_email-contract-amend-payment]&quot;;
            break;
        case 4:
            adjType = &quot;[epc_email-contract-amend-privacy]&quot;;
            break;
    }
    var extras = this.$buildExtrasText(item);
    var sndr = expandDescription(&quot;[passenger-contract-sender]&quot;);
    var subj = &quot;Amended contract: &quot; + contract.name;
    var msg = expandDescription(adjType,
        {contractname:contract.name,
        systemname:System.systemNameForID(contract.destination),
        time:global.clock.clockStringForTime(contract.arrival_time),
        fee:formatCredits(contract.fee, true, true),
        extras:extras
    });

	if (sndr != &quot;&quot;) {
		w.$createEmail({sender:sndr,
			subject:subj,
			date:global.clock.adjustedSeconds,
			message:msg
		});
	}
    
}

//-------------------------------------------------------------------------------------------------------------
this.$buildExtrasText = function(item) {
    var govs = new Array();
    for (var i = 0; i &lt; 8 ; i++) govs.push(String.fromCharCode(i));

    var extras = &quot;&quot;;
    if (item.hasOwnProperty(&quot;smooth&quot;) &amp;&amp; item.smooth === true) {
        extras += expandDescription(&quot;[epc_contract-no-wildness]&quot;);
    }
    if (item.hasOwnProperty(&quot;noScan&quot;) &amp;&amp; item.noScan === true) {
        extras += expandDescription(&quot;[epc_contract-no-scan]&quot;);
    }
    if (item.hasOwnProperty(&quot;avoidGovType&quot;) &amp;&amp; item.avoidGovType &gt;= 0) {
        extras += expandDescription(&quot;[epc_contract-avoid-gov]&quot;, {govType:this._govTypeNames[item.avoidGovType]});
    }
    if (item.hasOwnProperty(&quot;avoidSpecies&quot;) &amp;&amp; item.avoidSpecies != &quot;&quot;) {
        extras += expandDescription(&quot;[epc_contract-avoid-species]&quot;, {species:item.avoidSpecies});
    }
    if (item.hasOwnProperty(&quot;avoidSysList&quot;) &amp;&amp; item.avoidSysList.length &gt; 0) {
        var listText = &quot;&quot;;
        for (var i = 0; i &lt; item.avoidSysList.length; i++) {
            var sys = System.infoForSystem(galaxyNumber, item.avoidSysList[i]);
            listText += &quot;\n -- &quot; + sys.name + &quot; (&quot; + govs[sys.government] + &quot; TL&quot; + (sys.techlevel + 1) + &quot;)&quot;;
        }
        extras += expandDescription(&quot;[epc_contract-avoid-systems]&quot;, {syslist:listText});
    }
    if (item.hasOwnProperty(&quot;bonusSysList&quot;) &amp;&amp; item.bonusSysList.length &gt; 0) {
        var listText = &quot;&quot;;
        for (var i = 0; i &lt; item.bonusSysList.length; i++) {
            var sys = System.infoForSystem(galaxyNumber, item.bonusSysList[i]);
            listText += &quot;\n -- &quot; + sys.name + &quot; (&quot; + govs[sys.government] + &quot; TL&quot; + (sys.techlevel + 1) + &quot;)&quot;;
        }
        extras += expandDescription(&quot;[epc_contract-bonus-systems]&quot;, {bonus:formatInteger(this._bonusSystemLoading * 100) + &quot;% of payment&quot;, syslist:listText});
    }
    return extras;
}

//-------------------------------------------------------------------------------------------------------------
this.$sendChatMessage = function $sendChatMessage() {
    // don&#39;t send any messages if there is a pending contract change
    if (this._newDest) return;
    // don&#39;t sent chat messages in Interstellar space
    if (system.isInterstellarSpace) return;
    // overheating
    if (player.ship.temperature &gt;= 0.65) {
        if (Math.random() &lt; 0.5) {
            this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-overheating]&quot;);
        }
        // if the ship is overheating, don&#39;t continue and potentially send a small talk message
        return;
    }
    // low energy
    if (player.ship.energy &lt; 32) {
        if (Math.random() &lt; 0.5) {
            this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-low-energy-concern]&quot;);
        }
        return;
    }
    // low altitude
    if (player.alertAltitude) {
        // altitude could be low near the sun, too, but hopefully the temperature message above will prevent conflicts
        if (Math.random() &lt; 0.5) {
            this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-low-altitude-concern]&quot;);
        }
        return;
    }
    // don&#39;t send small talk during read alert
    if (player.alertCondition === 3) return;
    // small talk
    if (Math.random() &lt; 0.2) {
        // pick a passenger
        var passenger = this.$pickRandomPassenger();
        if (passenger) {
            // set up any mission variables that might be used by the chat text
            var ds = this.$getSystemsByDescription(&quot;disease&quot;);
            missionVariables.diseaseSystem = ds[Math.floor(Math.random() * ds.length)].name;
            var es = this.$getSystemsByDescription(&quot;earthquake&quot;);
            missionVariables.earthquakeSystem = es[Math.floor(Math.random() * es.length)].name;
            missionVariables.finalDestination = System.systemNameForID(passenger.destination);
            var shipTypes = [&quot;Cobra Mark III&quot;,&quot;Boa&quot;,&quot;Boa Class Cruiser&quot;,&quot;Anaconda&quot;,&quot;Fer-de-Lance&quot;];
            for (var i = 0; i &lt; shipTypes.length; i++) {
                if (player.ship.name !== shipTypes[i]) {
                    missionVariables.altShipName = shipTypes[i];
                    break;
                }
            }
            var data = expandDescription(&quot;[passenger-chat]&quot;);
            var idx = parseInt(data.split(&quot;|&quot;)[0]);
            var msg = data.split(&quot;|&quot;)[1];
            // clean up the mission variables we added
            delete missionVariables.altShipName;
            delete missionVariables.finalDestination;
            delete missionVariables.diseaseSystem;
            delete missionVariables.earthquakeSystem;
            if (this._transmissions.indexOf(idx) === -1) {
                this.$transmitMessageFromPassenger(passenger, msg);
                this._transmissions.push(idx);
            }
        }
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$niceShotMessage = function $niceShotMessage() {
    // pick a passenger
    this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-nice-shooting]&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$damageMessage = function $damageMessage() {
    this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-damage-concern]&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$impatientMessage = function $impatientMessage() {
    this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-impatient]&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$interstellarSpaceMessage = function $interstellarSpaceMessage() {
    this.$transmitMessageFromPassenger(this.$pickRandomPassenger(), &quot;[passenger-interstellar]&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$pickRandomPassenger = function() {
    var p = player.ship;
    return p.passengers[Math.floor(Math.random() * p.passengers.length)];
}

//-------------------------------------------------------------------------------------------------------------
this.$transmitMessageFromPassenger = function(passenger, message) {
    if (!passenger) return;
    if (message.indexOf(&quot;[&quot;) === 0) message = expandDescription(message);

    var notifySound = new SoundSource;
	notifySound.sound = &quot;[@beep]&quot;;
	notifySound.play();

    player.commsMessage(&quot;Message from passenger &quot; + passenger.name + &quot;: &quot; + message, 5);
    // add to comms log (if installed) so that it doesn&#39;t disappear with other messages
    if (worldScripts.CommsLogMFD) {
        worldScripts.CommsLogMFD.commsMessageReceived(message, null, &quot;Passenger &quot; + passenger.name);
    }
}

//-------------------------------------------------------------------------------------------------------------
this.$getSystemsByDescription = function(options) {
	var planets = SystemInfo.filteredSystems(this, function(other) {
		return (other.description.indexOf(options) &gt;= 0 &amp;&amp; other.systemID != system.ID);
	});
	return planets;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/epc_passenger_mfd.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;EnhancedPassengerMFD&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2018 phkb&quot;;
this.description = &quot;Controls the output the MFD&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

this._lineLength = 14;
this._mfdID = -1;
this._offerTimeout = 180;		// number of seconds to wait for response (3 mins, to allow for player research time)
this._offerTimer = null;		// timer for mission offer
this._timeoutCounter = 0;
this._currentMFDText = &quot;&quot;;
this._displayPoint = 0;
this._holdData = {};
this._subMessageTimer = null;
this._originalMsg = &quot;&quot;;
this._final = false;
this._declineMessageTimer = null;
this._declineType = false;
this._acceptMessageTimer = null;
this._disableReplyOptions = false;

//-------------------------------------------------------------------------------------------------------------
this.shipWillEnterWitchspace = function(cause, destination) {
	if (this._offerTimer &amp;&amp; this._offerTimer.isRunning) {
		this.$stopTimers();
		worldScripts.EnhancedPassengerContracts.$declinePendingChange();
		this.$removeBCReplyOptions();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function(station) {
	if (this._simulator === true) return;
	if (this._offerTimer &amp;&amp; this._offerTimer.isRunning) {
		// make sure we don&#39;t leave any half-accepted change hanging around
		this.$stopTimers();
		worldScripts.EnhancedPassengerContracts.$declinePendingChange();
		epc.$removeBCReplyOptions();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDied = function(whom, why) {
	this.$stopTimers();
}

//-------------------------------------------------------------------------------------------------------------
this.$stopTimers = function $stopTimers() {
	if (this._offerTimer &amp;&amp; this._offerTimer.isRunning) {
		this._offerTimer.stop();
		this._offerTimer = null;
	}
	if (this._subMessageTimer &amp;&amp; this._subMessageTimer.isRunning) {
		this._subMessageTimer.stop();
		this._subMessageTimer = null;
	}
	if (this._declineMessageTimer &amp;&amp; this._declineMessageTimer.isRunning) {
		this._declineMessageTimer.stop();
		this._declineMessageTimer = null;
	}
	if (this._acceptMessageTimer &amp;&amp; this._acceptMessageTimer.isRunning) {
		this._acceptMessageTimer.stop();
		this._acceptMessageTimer = null;
	}
	this._declineType = false;
}

//-------------------------------------------------------------------------------------------------------------
// breaks text up into appropriate lengths for an MFD
this.$processText = function $processText(msg) {
	var line = &quot;&quot;;
	// the replace here should ensure all newline commands are at the end of a word, and not in the middle of one
	var words = msg.replace(new RegExp(&quot;\n&quot;, &#39;g&#39;), &quot;\n &quot;).split(&quot; &quot;);
	var word = &quot;&quot;;
	var output = &quot;&quot;;

	for (var i = 0; i &lt; words.length; i++) {
		word = words[i].trim();
		// make sure we have a word to add before trying to add it
		if (word !== &quot;&quot;) {
			if (defaultFont.measureString(line + &quot; &quot; + word) &lt;= this._lineLength) {
				line += (line === &quot;&quot; ? &quot;&quot; : &quot; &quot;) + word;
				// if the word ended in a newline command, add the line to the output and reset
				if (word.indexOf(&quot;\n&quot;, word.length - 2) !== -1) {
					output += line;
					line = &quot;&quot;;
				}
			} else {
				output += line + &quot;\n&quot;;
				line = word;
				// if the word ended in a newline command, add the line to the output and reset
				if (word.indexOf(&quot;\n&quot;, word.length - 2) !== -1) {
					output += line;
					line = &quot;&quot;;
				}
			}
		}
	}
	output += line;
	
	// update MFD so that new text goes on the bottom.
	var lines = this._currentMFDText.split(&quot;\n&quot;);
	if (this._currentMFDText === &quot;&quot;) lines = [];
	var newlines = output.split(&quot;\n&quot;);
	
	for (var i = 0; i &lt; newlines.length; i++) {
		lines.push(newlines[i]);
	}
	
	var final = &quot;&quot;;
	if (lines.length &lt;= 10) {
		final = lines.join(&quot;\n&quot;);
	} else {
		for (var i = lines.length - 10; i &lt; lines.length; i++) {
			final += (final === &quot;&quot; ? &quot;&quot; : &quot;\n&quot;) + lines[i];
		}
	}
	
	this._currentMFDText = final;
	
	return final;
}

//-------------------------------------------------------------------------------------------------------------
// updates the text of the MFD
this.$updateMFD = function $updateMFD(msg) {
	var p = player.ship;

	if (this._originalMsg === &quot;&quot;) this._originalMsg = msg;
	
	var msglist = msg.split(&quot;\n&quot;);
	var currmsg = msglist[this._displayPoint];
	// if this is the final message, just select the last one
	if (this._final === true) {
		currmsg = msglist[msglist.length - 1];
	}
	
	// if the hud is hidden don&#39;t try an update - it will get confusing as to which mfd slot is open or not.
	if (p.hudHidden === false) {
        // find the slot currently set for this MFD
        this.$findMFDID();
        // if we haven&#39;t got a set slot (this._mfdID === -1) or the set slot we had is now unavailable...
        if (this._mfdID === -1 ||
            (p.multiFunctionDisplayList[this._mfdID] &amp;&amp; p.multiFunctionDisplayList[this._mfdID] !== &quot;&quot; &amp;&amp; p.multiFunctionDisplayList[this._mfdID] !== this.name)) {
            // find a free slot
            // first, make sure we reset our slot id marker (in the case where the previous one is in use)
            this._mfdID = -1;
            // search for a free slot
            for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
                if (!p.multiFunctionDisplayList[i] || p.multiFunctionDisplayList[i] === &quot;&quot;) {
                    this._mfdID = i;
                    break;
                }
            }
        }
		
		// we have a free slot, so force the mfd to display
		if (this._mfdID !== -1) {
			// set the text in the MFD
			var output = this.$processText(currmsg);
			p.setMultiFunctionText(this.name, output, false);

			p.setMultiFunctionDisplay(this._mfdID, this.name);
		} else {
			if (useComms === true &amp;&amp; src &amp;&amp; src.isInSpace &amp;&amp; player.ship.position.distanceTo(src) &lt; player.ship.scannerRange) {
				// yay! comms is working!
				src.commsMessage(currmsg, p);
			} else {
				// oh well, make it a console message
				player.consoleMessage(currmsg, 20);
			}
		}
	}
	
	if (this._final === false) {
		this._displayPoint += 1;
		if (this._displayPoint &lt; msglist.length) {
			this._holdData.msg = msg;
			this._subMessageTimer = new Timer(this, this.$processNextMessage, 5, 0);
			// return at this point so the accept/reject items only appear when all the messages are displayed.
			return;
		}
	}

	this._holdData = {};
	if (this._disableReplyOptions === false) this.$displayBCReplyOptions();
}

//-------------------------------------------------------------------------------------------------------------
// re-run the update function so the next message in the list can be displayed
this.$processNextMessage = function $processNextMessage() {
	this.$updateMFD(this._holdData.msg);
}

//-------------------------------------------------------------------------------------------------------------
// records the index of the MFD that currently holds the damage report mfd
this.$findMFDID = function $findMFDID() {
	var p = player.ship;
	for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
		if (p.multiFunctionDisplayList[i] === this.name) this._mfdID = i;
	}
}

//-------------------------------------------------------------------------------------------------------------
// hides all instances of the damage report MFD
this.$autoHideMFD = function $autoHideMFD() {
	var p = player.ship;
	if (p &amp;&amp; p.multiFunctionDisplayList) {
		for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
			if (p.multiFunctionDisplayList[i] === this.name) {
				p.setMultiFunctionDisplay(i, &quot;&quot;);
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// add the secondary mission accept/decline options to broadcast comms
this.$displayBCReplyOptions = function $displayBCReplyOptions() {
	var bc = worldScripts.BroadcastCommsMFD;
	if (bc.$checkMessageExists(&quot;epc_accept_change&quot;) === true || bc.$checkMessageExists(&quot;epc_decline_change&quot;) === true) return;
	bc.$createMessage({messageName:&quot;epc_accept_change&quot;, callbackFunction:this.$acceptContractChange.bind(this), displayText:&quot;(* Accept Contract Change *)&quot;, messageText:&quot;&quot;, transmissionType:&quot;broadcast&quot;, deleteOnTransmit:true, delayCallback:1});
	bc.$createMessage({messageName:&quot;epc_decline_change&quot;, callbackFunction:this.$declineContractChange.bind(this), displayText:&quot;(* Decline Contract Change *)&quot;, messageText:&quot;&quot;, transmissionType:&quot;broadcast&quot;, deleteOnTransmit:true, delayCallback:1});
	// reset the timer counter
	this._timeoutCounter = 0;
	// start a timer to wait for player response
	this._offerTimer = new Timer(this, this.$removeOffer, 1, 1);
}

//-------------------------------------------------------------------------------------------------------------
this.$acceptContractChange = function $acceptContractChange() {
    player.consoleMessage(&quot;Contract change accepted&quot;);
    if (this._mfdID !== -1) {
        this.$updateMFD(this._originalMsg + &quot;\n&gt;&gt; &quot; + expandDescription(&quot;[epc_accept-change]&quot;));
    }
	worldScripts.EnhancedPassengerContracts.$acceptPendingChange();
	this.$removeBCReplyOptions();
	this._acceptMessageTimer = new Timer(this, this.$sendAcceptComms, 5, 0);
}

//-------------------------------------------------------------------------------------------------------------
this.$sendAcceptComms = function $sendAcceptComms() {
    if (this._mfdID !== -1) {
        this._final = true;
        this._disableReplyOptions = true;
        this.$updateMFD(this._originalMsg + &quot;\n&quot; + expandDescription(&quot;[epc_accept-response]&quot;));
    }
	// turn off the MFD (if it was used)
	this.$turnOffMFD();
}

//-------------------------------------------------------------------------------------------------------------
this.$declineContractChange = function $declineContractChange(send_message) {
    this._declineType = false;
    if (send_message == null) {
        this._declineType = true;
        player.consoleMessage(&quot;Contract change declined&quot;);
        if (this._mfdID !== -1) {
            this.$updateMFD(this._originalMsg + &quot;\n&gt;&gt; &quot; + expandDescription(&quot;[epc_decline-change]&quot;));
        }
    }
	this.$removeBCReplyOptions();
	this._declineMessageTimer = new Timer(this, this.$sendDeclineComms, 5, 0);
}

//-------------------------------------------------------------------------------------------------------------
this.$sendDeclineComms = function $sendDeclineComms() {
    if (this._declineType === true) {
        if (this._mfdID !== -1) {
            this._final = true;
			this._disableReplyOptions = true;
            this.$updateMFD(this._originalMsg + &quot;\n&quot; + expandDescription(&quot;[epc_decline-response]&quot;));
        }
    }
	worldScripts.EnhancedPassengerContracts.$declinePendingChange();
	// turn off the MFD (if it was used)
	this.$turnOffMFD();
}

//-------------------------------------------------------------------------------------------------------------
this.$turnOffMFD = function $turnOffMFD() {
	// turn off the MFD (if it was used)
	this._currentMFDText = &quot;&quot;;
	this._originalMsg = &quot;&quot;;
	this._final = false;
	this._displayPoint = 0;
	if (this._mfdID !== -1) {
		if (this._subMessageTimer &amp;&amp; this._subMessageTimer.isRunning) this._subMessageTimer.stop();
		this._subMessageTimer = new Timer(this, this.$autoHideMFD, 3, 0);
	}
	this._disableReplyOptions = false;
}

//-------------------------------------------------------------------------------------------------------------
this.$removeBCReplyOptions = function $removeBCReplyOptions() {
	if (this._offerTimer &amp;&amp; this._offerTimer.isRunning) {
		this._offerTimer.stop();
		this._offerTimer = null;
	}
	var bc = worldScripts.BroadcastCommsMFD;
	if (bc.$checkMessageExists(&quot;epc_accept_change&quot;) === true) bc.$removeMessage(&quot;epc_accept_change&quot;);
	if (bc.$checkMessageExists(&quot;epc_decline_change&quot;) === true) bc.$removeMessage(&quot;epc_decline_change&quot;);
}

//-------------------------------------------------------------------------------------------------------------
this.$removeOffer = function $removeOffer() {
	this._timeoutCounter += 1;
	// have we timed out
	if (this._timeoutCounter &gt;= this._offerTimeout) {
		this.$declineContractChange(true);
		return;
	}
}

</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
