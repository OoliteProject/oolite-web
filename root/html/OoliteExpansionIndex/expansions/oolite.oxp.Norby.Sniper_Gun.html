<html>
    <head>
        <title>Expansion Sniper Gun</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Sniper Gun</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">6 Equipment</a></li>
          <li><a href="#ships">42 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Sniper Gun is a strong long range laser placed outside of hull for the best cooling. Ships must hold a clearly visible big gun mount to use it: you find Asp SG, Boa SG, Cobra Mark III SG, Fer-de-Lance SG, Krait SG and Viper SG in high-tech shipyards. Press &#39;i&#39; for more info about Heavy Sniper Gun and Sapper mode of this weapon.

        Heavy Sniper Gun has 2x power but need large ship like Python HSG, Python BattleCruiser or Prototype Boa.
        Sapper is the overdrive mode of Sniper Gun: deliver 5x more damage at point blank range than at max. range but use 5x energy and make double heat. The 5x hit is within 500m, 2x at 2km, 1x at 20km. Note the base damage/second value is only the half than in Sniper mode, so at and within 500m provide 2.5x more damage than a Sniper Gun in the same time.  Cause some damage when a shot narrowly misses the target and can mine asteroids. You can set auto or manual switching between Sniper Gun and Sapper using Sapper Mode equipment. Anti-Sapper equipments and Hard Shields almost negate the effect. Can not be separated and break your cloak when you fire. Overheat can damage Sapper and reduce it to Sniper Gun, in this case you must repair Sapper Mode.</td>
                    <td>Sniper Gun is a strong long range laser placed outside of hull for the best cooling. Ships must hold a clearly visible big gun mount to use it: you find Asp SG, Boa SG, Cobra Mark III SG, Fer-de-Lance SG, Krait SG and Viper SG in high-tech shipyards. Press &#39;i&#39; for more info about Heavy Sniper Gun and Sapper mode of this weapon.

        Heavy Sniper Gun has 2x power but need large ship like Python HSG, Python BattleCruiser or Prototype Boa.
        Sapper is the overdrive mode of Sniper Gun: deliver 5x more damage at point blank range than at max. range but use 5x energy and make double heat. The 5x hit is within 500m, 2x at 2km, 1x at 20km. Note the base damage/second value is only the half than in Sniper mode, so at and within 500m provide 2.5x more damage than a Sniper Gun in the same time.  Cause some damage when a shot narrowly misses the target and can mine asteroids. You can set auto or manual switching between Sniper Gun and Sapper using Sapper Mode equipment. Anti-Sapper equipments and Hard Shields almost negate the effect. Can not be separated and break your cloak when you fire. Overheat can damage Sapper and reduce it to Sniper Gun, in this case you must repair Sapper Mode.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Sniper_Gun</td>
                    <td>oolite.oxp.Norby.Sniper_Gun</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Sniper Gun</td>
                    <td>Sniper Gun</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Weapons</td>
                    <td>Weapons</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.3</td>
                    <td>1.3</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Norby.Separated_Lasers:1.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Norby.Separated_Lasers:1.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Sniper_Gun">http://wiki.alioth.net/index.php/Sniper_Gun</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/e/e9/Sniper_Gun_1.3.oxz">https://wiki.alioth.net/img_auth.php/e/e9/Sniper_Gun_1.3.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873504</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Sniper%20Gun'>http://wiki.alioth.net/index.php/Sniper%20Gun</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ANTISAPPER.html">Anti-Sapper Equipment</a></td>
                    <td>yes</td>
                    <td align="right">200000</td>
                    <td align="center">14+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SAPPERMODE.html">Sapper Mode</a></td>
                    <td>yes</td>
                    <td align="right">60000</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WEAPON_CANNON_HEAVY_SAPPER.html">Heavy Sapper</a></td>
                    <td>yes</td>
                    <td align="right">2060000</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN.html">Heavy Sniper Gun</a></td>
                    <td>yes</td>
                    <td align="right">2000000</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WEAPON_CANNON_SAPPER.html">Sapper</a></td>
                    <td>yes</td>
                    <td align="right">260000</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_WEAPON_CANNON_SNIPER_GUN.html">Sniper Gun</a></td>
                    <td>yes</td>
                    <td align="right">200000</td>
                    <td align="center">12+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/asp-sg.html">Asp SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/asp-sg-player.html">asp-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa-sg.html">Boa SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/boa-sg-player.html">boa-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra3-sg.html">Cobra Mark III SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cobra3-sg-player.html">cobra3-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/constrictor-sg.html">Constrictor SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/constrictor-sg-player.html">constrictor-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ferdelance-sg.html">Fer-de-Lance SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/ferdelance-sg-player.html">ferdelance-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/krait-sg.html">Krait SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/krait-sg-player.html">krait-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-battlecruiser.html">Python BattleCruiser</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-battlecruiser-player.html">python-battlecruiser-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-hsg.html">Python HSG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-hsg-player.html">python-hsg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-sg.html">python-sg</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/python-sg-player.html">python-sg-player</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun.html">Sniper Gun</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-dummy.html">snipergun-dummy</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-dummy-npc.html">snipergun-dummy-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy.html">Heavy Sniper Gun</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-dummy.html">Heavy Sniper Gun</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-dummy-npc.html">Heavy Sniper Gun</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-l.html">Heavy Sniper Gun L</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-l-npc.html">snipergun-heavy-l-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-npc.html">snipergun-heavy-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-r.html">Heavy Sniper Gun R</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy-r-npc.html">snipergun-heavy-r-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2.html">Heavy Sniper Gun 2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2-l.html">Heavy Sniper Gun 2 L</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2-l-npc.html">snipergun-heavy2-l-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2-npc.html">snipergun-heavy2-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2-r.html">Heavy Sniper Gun 2 R</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-heavy2-r-npc.html">snipergun-heavy2-r-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-l.html">Sniper Gun L</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-l-npc.html">snipergun-l-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-npc.html">snipergun-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-r.html">Sniper Gun R</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/snipergun-r-npc.html">snipergun-r-npc</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/viper-sg.html">Viper SG</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/viper-sg-player.html">viper-sg-player</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/sappermode.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;sappermode&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2016 Norby&quot;;
this.description= &quot;Sapper Mode equipment script&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;

this._w = worldScripts.snipergun;

//equipment events for Sapper Mode equipment
this.activated = function() {
        var w = this._w;
        w._sapperSwitchPlayer( w );
}

this.mode = function() {
        var w = this._w;
        w.$SapperMode++;
        if( w.$SapperMode &gt; 8 ) w.$SapperMode = 1;
        var near = w._setSapperDist( player.ship, w );
        var far = player.ship.script.$SapperFarDistance;
        switch( w.$SapperMode ) {
                case 1: //auto mode
                        player.consoleMessage( &quot;Sapper in auto mode (&quot;+near+&quot;-&quot;+far
                                +&quot; km distance and heat).&quot;, 4.5 );
                        break;
                case 2: //preset mode (1-2 km)
                        player.consoleMessage( &quot;Sapper in preset mode (&quot;+near+&quot;-&quot;+far
                                +&quot; km distance and heat).&quot;, 4.5 );
                        break;
                case 3: //0. distance mode (5-6 km)
                case 4: //1. distance mode (2-3 km)
                case 5: //2. distance mode (1-2 km)
                case 6: //3. distance mode (0.5-1 km)
                        player.consoleMessage( &quot;Sapper in target distance mode (&quot;+near+&quot;-&quot;+far
                                +&quot; km).&quot;, 4.5 );
                        break;
                case 7: //heat mode
                        player.consoleMessage( &quot;Sapper in laser heat mode.&quot;, 4.5 );
                        break;
                case 8: //manual mode
                default:
                        var n = String.fromCharCode( oolite.gameSettings.keyConfig.key_activate_equipment );
                        player.consoleMessage( &quot;Sapper in manual mode, press &#39;&quot;+n+&quot;&#39; to activate.&quot;, 4.5 );
                        break;
        }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/snipergun-conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;snipergun-conditions&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2016 Norby&quot;;
this.description= &quot;Sniper Gun condition script&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;

//equipment condition
this.allowAwardEquipment = function(equipment, ship, context)
{
        // OXP hook to allow stations to forbid specific equipment
        if (context == &quot;purchase&quot; &amp;&amp; player.ship.dockedStation
                &amp;&amp; player.ship.dockedStation.scriptInfo[&quot;oolite-barred-equipment&quot;])
        {
                if (player.ship.dockedStation.scriptInfo[&quot;oolite-barred-equipment&quot;].indexOf(equipment) != -1)
                {
                        return false;
                }
        }

        // OXP hook to allow ships to forbid specific &quot;available to all&quot; equipment
        if (ship.scriptInfo &amp;&amp; ship.scriptInfo[&quot;oolite-barred-equipment&quot;]
                &amp;&amp; ship.scriptInfo[&quot;oolite-barred-equipment&quot;].indexOf(equipment) != -1)
        {
                return false;
        }

//      player.consoleMessage( eqKey+&quot; &quot;+ship+&quot; &quot;+context );//debug

        if( equipment == &quot;EQ_ANTISAPPER&quot; ) {
                if( ship.mass &lt; 30000 ) return false;
                return true;
        }

        var w = worldScripts.snipergun;
        return w._allowAwardSniperGun(equipment, ship, context, w);
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/snipergun.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;snipergun&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2016 Norby&quot;;
this.description= &quot;Sniper Gun in subentity&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;
//Sniper Guns are usable only for ships over certain mass and with a big gun subentity.

//customizable properties
this.$DmgCh = 0.3; //chance in % when overheat cause damage in Sapper (0:never, 1:always)
this.$Hot = 0.81; //Sapper will switch back to Sniper over this heat, red zone start at 0.8
this.$ManualOverride = 0.25; //seconds after manual sapper activation without auto change back
this.$SapperActivationVolume = 1.0; //loudness of sapper activation sound, adjust between 0 and 1
this.$SapperDistance = 2; //km, in preset mode sapper auto switch on within this target distance
this.$SapperFarDistance = 5; //km, in preset mode sapper switch back to sniper over this
this.$SapperHitVolume = 0.9; //loudness of sapper hit sounds, adjust between 0 and 1
this.$SapperMinEnergy = 64; //Sapper need at least this much energy in banks to fire

//internal properties, should not touch
this.$AC = false; //store a pointer to worldScripts.[&quot;Auto Crosshairs&quot;] if installed
this.$AConTargetCrosshairs = false; //store original crosshairs of autocrosshairs
this.$Cwp = null; //currentWeapon when a switch between sapper and sniper is initiated
this.$Delay = 2; //switch between sapper and sniper gun need this many seconds
this.$HS = false; //store a pointer to worldScripts.hardships if installed
this.$OverHeat = 0.85; //Sapper has $DmgCh chance to damage over this heat, laser cutoff at 0.85
this.$SapperDistances = [5, 2, 1, 0.5, 0.5, 0.5]; //sapper auto distances for multiple lasers
this.$SapperMode = 1; //sapper mode: 1=auto, 2=preset, 3-8=distances, 9=laser heat, 10=manual
this.$SL = false; //store a pointer to worldScripts.separatedlasers if installed
this.$SLReplace = false; //flag for allowAwardSniperGun with separated lasers
this.$Sound = null; //soundsource of partial and far sapper hit on player&#39;s target
this.$Sound0 = null; //soundsource of sapper hit on player&#39;s target
this.$Sound1 = null; //additional soundsource of sapper hit on player&#39;s target for more volume
this.$Sound2 = null; //soundsource of partial sapper hit on the player
this.$Sound3 = null; //soundsource of sapper activation
this.$Sound4 = null; //soundsource of sapper deactivation
this.$Sound5 = null; //soundsource of sapper break due to overheat
this.$Timer = null; //timer for check and auto switch between sapper and sniper
this.$TCr = -1; //store crosshairs in timer during switching animation
this.$TOHeat = false; //flag to check heat once only each time when exceed $OverHeat limit
this.$TSapper = 0; //countdown in timer for changes between sniper and sapper
this.$VDir = null; //current viewDirection when a switch between sapper and sniper is initiated
this.$XH = false; //store a pointer to worldScripts.XenonHUD if installed

//worldScript events

this.startUp = function() {
        var a = worldScripts[&quot;Auto Crosshairs&quot;];
        if( a ) {
                this.$AC = a;
                //make sure SG&#39;s autoCrosshairs run after AC&#39;s shipTargetAcquired
                a.$SG = this;//worldScripts.snipergun;
                a._shipTargetAcquired2 = a.shipTargetAcquired;
                a.shipTargetAcquired = function( t ) {
                    a._shipTargetAcquired2( t );
                    a.$SG.autoCrosshairs( a.$SG ); //update autocrosshairs
                }
        }
        var s = worldScripts.separatedlasers;
        if( s ) this.$SL = s;
        var h = worldScripts.hardships;
        if( h ) this.$HS = h;

        this.$Sound = new SoundSource;  //soundsource of partial and far sapper hit on player&#39;s target
        this.$Sound.sound = &quot;sapperhits.ogg&quot;;
        this.$Sound.loop = false;
        this.$Sound.repeatCount = 1;
        this.$Sound.volume = this.$SapperHitVolume;

        this.$Sound0 = new SoundSource;  //soundsource of sapper hit on player&#39;s target
        this.$Sound0.sound = &quot;sapperhits.ogg&quot;;
        this.$Sound0.loop = false;
        this.$Sound0.repeatCount = 1;
        this.$Sound0.volume = this.$SapperHitVolume;

        this.$Sound1 = new SoundSource;  //additional soundsource of sapper hit on player&#39;s target
        this.$Sound1.sound = &quot;sapperhits.ogg&quot;;
        this.$Sound1.loop = false;
        this.$Sound1.repeatCount = 1;
        this.$Sound1.volume = this.$SapperHitVolume;

        this.$Sound2 = new SoundSource;  //soundsource of sapper hit on the player
        this.$Sound2.sound = &quot;sapperhits.ogg&quot;;
        this.$Sound2.loop = false;
        this.$Sound2.repeatCount = 1;
        this.$Sound2.volume = this.$SapperHitVolume;

        this.$Sound3 = new SoundSource;  //soundsource of sapper activation
        this.$Sound3.sound = &quot;sapper-on.ogg&quot;;
        this.$Sound3.loop = false;
        this.$Sound3.repeatCount = 1;
        this.$Sound3.volume = this.$SapperActivationVolume;

        this.$Sound4 = new SoundSource;  //soundsource of sapper deactivation
        this.$Sound4.sound = &quot;sapper-off.ogg&quot;;
        this.$Sound4.loop = false;
        this.$Sound4.repeatCount = 1;
        this.$Sound4.volume = this.$SapperActivationVolume;

        this.$Sound5 = new SoundSource;  //soundsource of sapper break due to overheat
        this.$Sound5.sound = &quot;sapperbreak.ogg&quot;;
        this.$Sound5.loop = false;
        this.$Sound5.repeatCount = 1;
        this.$Sound5.volume = 1;

        var m = missionVariables.$SapperMode;
        if( m ) this.$SapperMode = m;
        this._setSapperDist( player.ship, this ); //player sapper distance based on $SapperMode

        var h = worldScripts.XenonHUD;
        if( h ) {
                this.$XH = h;
                var sg = &quot;xenon_crosshairs_alt4.png&quot;; //cross and many stuff
                var sp = &quot;xenon_crosshairs_alt2.png&quot;; //double circle
                var hsg = &quot;xenon_crosshairs_alt5.png&quot;; //thick blue cross
                var hsp = &quot;xenon_crosshairs_alt3.png&quot;; //oval and dot
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SNIPER_GUN&quot;, filename:sg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SNIPER_GUN_2&quot;, filename:sg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SNIPER_GUN_3&quot;, filename:sg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SNIPER_GUN_4&quot;, filename:sg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SNIPER_GUN_5&quot;, filename:sg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_SAPPER&quot;, filename:sp});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot;, filename:hsg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN_2&quot;, filename:hsg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN_3&quot;, filename:hsg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN_4&quot;, filename:hsg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN_5&quot;, filename:hsg});
                h.$customCrosshairs({laser:&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot;, filename:hsp});
        }

        this.playerBoughtNewShip(); //validate sniper guns
}

this.alertConditionChanged = function(newCondition, oldCondition) {
        if( newCondition &lt; 2 &amp;&amp; this._isSapper( player.ship.currentWeapon, this ) )
                this._startSwitchToSniper( player.ship, this );
}

this.playerBoughtEquipment = function(equipmentKey) {
        this._validate(equipmentKey, this);
        this._setSapperDist( player.ship, this ); //player sapper distance based on $SapperMode
}

this.playerBoughtNewShip = function() {
        //search for sniper guns and validate
        this._validate(&quot;EQ_WEAPON_CANNON_SNIPER_GUN&quot;, this);
        this._validate(&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot;, this);
        this._validate(&quot;EQ_WEAPON_CANNON_SAPPER&quot;, this);
        this._validate(&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot;, this);
}

this.playerWillSaveGame = function(message) {
        missionVariables.$SapperMode = this.$SapperMode;
}

this.shipAttackedOther = function(other) {
        var p = player.ship; //replace player.ship to this.ship in ship scripts
        var w = this;
        if( other != player.ship ) { //must exclude player when called from ship scripts
                var dmg = w._sapper( p, other, 1, w );
                if( dmg &gt; 0 ) w._sapperBreak( p, w ); //check overheat damage
                w._checkSapperMode( p, other, w ); //switch between sniper and sapper in auto modes
        }
}

this.shipBeingAttacked = function(whom) {
        //do not use shipBeingAttacked in ship scripts due to if attacker is cloaked then no source ship
        //but must use here for sure at least for the player due to injecting into the ship script
        //is not enough if ship script is changed after spawned like in escortdeck
        var p = player.ship; //replace player.ship to this.ship in ship scripts
        var w = this;
        var dmg = w._sapper( whom, p, 1, w );
        if( dmg &gt; 0 ) w._sapperBreak( whom, w ); //check overheat damage
}

this.shipBeingAttackedUnsuccessfully = function(whom) {
        var p = player.ship; //replace player.ship to this.ship in ship scripts
        var w = this;
        var dmg = w._sapper( whom, p, 0.5, w ); //half damage only
        if( dmg &gt; 0 ) {
                w._sapperBreak( whom, w ); //check overheat damage
                w._switchToSniper( whom, w ); //NPC switch back to sniper when missed
                w.$Sound2.play(); //notify the player about the hit on his ship
        }
}

this.shipLaunchedFromStation = function(station) {
        this.autoCrosshairs( this ); //update autocrosshairs first time
}

this.shipSpawned = function(ship) {
        //Inject the following functions into all ship scripts
        //except player.ship which use these in snipergun worldscript
        if( ship == player.ship ) return; //exclude player for sure
        var w = this;

        if( w._checkSubEnt(ship, &quot;snipergun&quot;, w) &gt;= 0 ) { //find snipergun subentity
                //in HardShips AntiSapper requires Hard Shield X so award this first
                if( w.$HS ) ship.awardEquipment(&quot;EQ_HARDSHIELD_10&quot;);
                ship.awardEquipment(&quot;EQ_ANTISAPPER&quot;); //default on all SG ships
                ship.awardEquipment(&quot;EQ_SAPPERMODE&quot;); //must to Sapper be able to damaged by overheat
                var d = w._setSapperDist( ship, w ); //set default sapper distance for multiple lasers
//              log(w.name, ship.name+&quot; SapperDistance set to &quot;+d+&quot; km.&quot;); //debug
        }

        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure
        var s = ship.script;
        s.$wsg = w; //worldScripts.snipergun

        var sa = s.shipAttackedOther;
        if( sa ) eval(&quot;s._SniperGun_shipAttackedOther_Orig = &quot;+sa);
        //must exclude player from the next function when called from ship scripts
        //due to player is handled in shipBeingAttacked in snipergun worldScript
        //and comments are pulled out from the eval string
        eval(&quot;s.shipAttackedOther = function(other) { \
                var p = this.ship; \
                var w = this.$wsg; \
                var dmg = 0; \
                if( other != player.ship ) dmg = w._sapper( p, other, 1, w ); \
                if( dmg &gt; 0 ) w._sapperBreak( p, w ); \
                w._checkSapperMode( p, other, w ); \
                if( this._SniperGun_shipAttackedOther_Orig ) \
                        this._SniperGun_shipAttackedOther_Orig(other); \
        }&quot;);

        var sb = s.shipBeingAttackedUnsuccessfully;
        if( sb ) eval(&quot;s._SniperGun_shipBeingAttackedUnsuccessfully_Orig = &quot;+sb);
        //0.5 in _sapper() mean half damage only
        //if(whom != player.ship) mean NPC switch back from sapper to sniper gun
        //else player switch back to sniper in auto mode if needed
        //_sapperBreak() check overheat damage
        eval(&quot;s.shipBeingAttackedUnsuccessfully = function(whom) { \
                var w = this.$wsg; \
                var dmg = w._sapper(whom, this.ship, 0.5, w); \
                if( dmg &gt; 0 ) { \
                        if(whom != player.ship) \
                                w._switchToSniper( whom, w ); \
                        else { \
                                w._checkSapperMode( whom, this.ship, w ); \
                        } \
                        w._sapperBreak(whom, w); \
                } \
                if( this._SniperGun_shipBeingAttackedUnsuccessfully_Orig ) \
                        this._SniperGun_shipBeingAttackedUnsuccessfully_Orig(whom); \
        }&quot;);

        var st = s.shipTargetAcquired;
        if( st ) eval(&quot;s._SniperGun_shipTargetAcquired_Orig = &quot;+st);
        //switch between sniper and sapper
        eval(&quot;s.shipTargetAcquired = function(t) { \
                var w = this.$wsg; \
                w._checkSapperMode( this.ship, t, w ); \
                if( this._SniperGun_shipTargetAcquired_Orig ) \
                        this._SniperGun_shipTargetAcquired_Orig(t); \
        }&quot;);
}

this.shipTargetAcquired = function(t) {
        this._checkSapperMode( player.ship, t, this ); //switch between sniper and sapper
        this.autoCrosshairs( this ); //update autocrosshairs
}

this.viewDirectionChanged = function(viewString) {
        //sapper in auto mode could set different distances for aft and forward sappers
        if( this.$SapperMode == 1 ) this._setSapperDist( player.ship, this );
        this.autoCrosshairs( this ); //update autocrosshairs
}


//snipergun functions

this._allowAwardSniperGun = function(equipment, ship, context, w) {
        //called from snipergun-condition.js and separatedlasers.js also
        if( !w ) w = worldScripts.snipergun;

        //Sniper Gun can not fit into very small ships below 30t mass
        if( ship.mass &lt; 30000 ) return false;

        var datakey = &quot;snipergun&quot;; //begin of dataKeys in shipdata.plist

        //Heavy Sniper Gun need 250t mass like Python, need indexOf instead of == for separated lasers
        if( equipment.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot;) &gt; -1
                || equipment.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot;) &gt; -1 ) {
                if( ship.mass &lt; 250000 ) return false;
                datakey = &quot;snipergun-heavy&quot;; //dataKey of Heavy Sniper Gun in shipdata.plist
        }


        //check if there is a proper subentity or snipergun_dummy on the ship
        var sub = w._checkSubEnt(ship, datakey, w);
//      log(w.name, ship.name+&quot; &quot;+equipment+&quot; &quot;+context+&quot; sub=&quot;+sub); //debug

        if( sub &gt;= 0 ) {  //found subentity
                //sapper gun and sapper mode equipment is purchasable
                if( w.$SLReplace //do not use context != &quot;purchase&quot; due to a core bug
                                 //which set context to purchase even if called from script
                        || !w._isSniper(equipment, this) 
                        //must exclude when player is not docked else switch back from sapper
                        //during fligth will not work
                        || ship != player.ship || !player.ship.docked ) return true;
                //sniper purchase need no sapper on board to prevent free cash after mode switching
                if( !w._isSapper(ship.forwardWeapon, this)
                    &amp;&amp; !w._isSapper(ship.aftWeapon, this)
                    &amp;&amp; !w._isSapper(ship.portWeapon, this)
                    &amp;&amp; !w._isSapper(ship.starboardWeapon, this) ) return true;
                return false;
        } else if( context == &quot;scripted&quot;) {
                log(w.name, &quot;Missing snipergun subentity on &quot;+(ship.name)+&quot; for &quot;+
                        equipment+&quot; but awarded due to context is scripted&quot;);
                return true;
        }

        return false; //refused
}

this._aft = function(o) { //check if o is oriented aft
        var v = Vector3D(0, 0, -1); //aft direction
        if( o.vectorForward().direction().distanceTo(v) == 0 ) return true; //exactly aft
        return false; //not exactly aft
}

this.autoCrosshairs = function ( w ) { //update autocrosshairs
        if( !w ) w = worldScripts.snipergun;
        var p = player.ship;
        if( !w.$AC || !p || !p.isValid
                || w.$AC.$crosshairs &amp;&amp; w.$AC.$crosshairs[p.hud] ) { //skip custom hud crosshairs
                return;
        }
        var t = p.target;
        var k = w._isSniperOrSapper( p.currentWeapon );
        if( k == 1  ) { //Sniper Gun with 20km range
                if( t &amp;&amp; t.isValid &amp;&amp; p.position.distanceTo(t.position) - t.collisionRadius &lt; 20000 )
                        w.autoCrosshairsLock( w );
                else {
                        w.$AConTargetCrosshairs = w.$AC.$onTargetCrosshairs; //save original
                        w.$AC.$onTargetCrosshairs = &quot;crosshairs.plist&quot;;
                }
        } else if( k == 2  ) { //Heavy Sniper Gun with 25km range
                if( t &amp;&amp; t.isValid &amp;&amp; p.position.distanceTo(t.position) - t.collisionRadius &lt; 25000 )
                        w.autoCrosshairsLock( w );
                else {
                        w.$AConTargetCrosshairs = w.$AC.$onTargetCrosshairs; //save original
                        w.$AC.$onTargetCrosshairs = &quot;crosshairs.plist&quot;;
                }
        } else if( k == 3 || k == 4 ) { //Sapper with 500m optimal range
                if( t &amp;&amp; t.isValid &amp;&amp; p.position.distanceTo(t.position) - t.collisionRadius &lt; 500 )
                        w.autoCrosshairsLock( w );
                else {
                        w.$AConTargetCrosshairs = w.$AC.$onTargetCrosshairs; //save original
                        w.$AC.$onTargetCrosshairs = &quot;crosshairs.plist&quot;;
                }
        } else {
                if( w.$AConTargetCrosshairs ) {
                        w.$AC.$onTargetCrosshairs = w.$AConTargetCrosshairs; //restore original
                        w.$AConTargetCrosshairs = false;
                }
        }
        w.$AC.$currentState = null; //force crosshairs replace in the next frame
}

this.autoCrosshairsLock = function ( w ) { //lock with autocrosshairs
        w.$AConTargetCrosshairs = w.$AC.$onTargetCrosshairs; //save original
        if( w.$XH &amp;&amp; w.$XH.$xenonHUDActive() ) //original autocrs looks better with Xenon HUD
                w.$AC.$onTargetCrosshairs = &quot;auto-crosshairs-on-target.plist&quot;;
        else w.$AC.$onTargetCrosshairs = &quot;snipergun-crosshairs-box.plist&quot;;
}

this._checkAftSubEnt = function(ship, datakey, w) {
        if( !w ) w = worldScripts.snipergun;
        return w._checkSubEnt2(ship, datakey, w, 2);
}

this._checkForwardSubEnt = function(ship, datakey, w) {
        if( !w ) w = worldScripts.snipergun;
        return w._checkSubEnt2(ship, datakey, w, 1);
}

this._checkSapperMode = function( ship, other, w ) {
        var p = player.ship;
        if( !w ) w = worldScripts.snipergun;
        if( ship.energy &lt; w.$SapperMinEnergy &amp;&amp; w._isSapper( ship.currentWeapon, w ) ) {
                if( ship == player.ship )
                        player.consoleMessage( &quot;Not enough energy for Sapper&quot; );
                w._startSwitchToSniper( ship, w );
                return;
        }
        if( ship.equipmentStatus(&quot;EQ_SAPPERMODE&quot;) != &quot;EQUIPMENT_OK&quot; //don&#39;t work if damaged
                || ship == p &amp;&amp; w.$SapperMode == 8 ) return; //or player in manual mode
        if( !other || !other.isValid ) {
                //overheat should be checked even if no target
                if( w._isSapper( ship.currentWeapon, w ) &amp;&amp;
                    w._isHot( ship, w ) &amp;&amp; ( ship != p  //NPC or
                            //player not in target distance modes
                            || w.$SapperMode &lt;= 2 || w.$SapperMode == 7 ) )
                    w._startSwitchToSniper( ship, w );
        } else if( w._isSapper( ship.currentWeapon, w ) ) { //check if sapper should switch to sg
                if( other.script &amp;&amp; other.script.$hasAntiSapper ) { //back to sg if has AntiSapper
                        w._startSwitchToSniper( ship, w );
                } else if( ship != p || w.$SapperMode == 1 || w.$SapperMode == 2 ) {
                        //NPC, auto or preset mode need both condition
                        if( w._isFar( ship, other, w ) || w._isHot( ship, w ) )
                                w._startSwitchToSniper( ship, w );
                } else if( w.$SapperMode &gt; 2 &amp;&amp; w.$SapperMode &lt; 7 //target distance modes
                                &amp;&amp; w._isFar( ship, other, w ) //target is too far
                        || w.$SapperMode == 7 &amp;&amp; w._isHot( ship, w ) ) { //laser is in red heat
                                w._startSwitchToSniper( ship, w );
                }
        } else if( w._isSniper( ship.currentWeapon, w )  //check if sg should switch to sapper
                &amp;&amp; (!other.script || !other.script.$hasAntiSapper )) { //do not against AntiSapper
                if( ship != p || w.$SapperMode == 1 || w.$SapperMode == 2 ) {
                        //NPC, auto or preset mode need both condition
                        if( w._isNear( ship, other, w ) &amp;&amp; !w._isHot( ship, w ) )
                                w._startSwitchToSapper( ship, w );
                } else if( w.$SapperMode &gt; 2 &amp;&amp; w.$SapperMode &lt; 7 //target distance modes
                                &amp;&amp; w._isNear( ship, other, w ) //target is enough near
                        || w.$SapperMode == 7 &amp;&amp; !w._isHot( ship, w ) ) { //laser is not in red heat
                                w._startSwitchToSapper( ship, w );
                }
        }
}

this._checkSubEnt = function(ship, datakey, w) {
        if( !w ) w = worldScripts.snipergun;
        return w._checkSubEnt2(ship, datakey, w, 0);
}

this._checkSubEnt2 = function(ship, datakey, w, flag) {
        if( !w ) w = worldScripts.snipergun;
        //check if there is a proper subentity or snipergun-dummy on the ship
        var sub = -1;
        var s = ship.subEntities;
        if( s &amp;&amp; s.length &gt; 0 ) for(var i=0; i &lt; s.length; i++) {
                if( s[i].dataKey.indexOf(datakey) == 0 ) { //matching at the first character
                        if( flag == 2 &amp;&amp; w._aft(s[i].orientation) ) sub = i; //aft found
                        if( flag == 1 &amp;&amp; !w._aft(s[i].orientation) ) sub = i; //forward found
                        if( flag == 0 ) sub = i; //either fw or aft found for allowAwardEquipment
//                      if(sub == i) log(w.name, s[i].dataKey+&quot; subentity with orientation &quot;
//                                +s[i].orientation+&quot; flag:&quot;+flag+(w._aft(s[i].orientation))); //debug
                }
        }
        return sub; //return the found index in subentity array or -1 if not found
}

this._getMulti = function(ship, w) { //how many multiple lasers are on this ship in current mount
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( ship.currentWeapon == ship.aftWeapon ) return w._getMultiAft(ship, w);
        if( ship.currentWeapon == ship.portWeapon ) return w._getMultiPort(ship, w);
        if( ship.currentWeapon == ship.starboardWeapon ) return w._getMultiSb(ship, w);
        return w._getMultiFw(ship, w);  //forward mount
}

this._getMultiAft = function(ship, w) {  //how many aft multiple lasers are on this ship
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure
        var m = ship.script._cachedAftWeapons; //read cached variable
        if( !m ) {
                m = w._getMultiSide(ship, 2); //read aft multiple weapons length
                ship.script._cachedAftWeapons = m; //store into a cache variable
        }
        return( m );
}

this._getMultiFw = function(ship, w) {  //how many forward multiple lasers are on this ship
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure
        var m = ship.script._cachedFwWeapons; //read cached variable
        if( !m ) {
                m = w._getMultiSide(ship, 1); //read forward multiple weapons length
                ship.script._cachedFwWeapons = m; //store into a cache variable
        }
        return( m );
}

this._getMultiPort = function(ship, w) {  //how many port multiple lasers are on this ship
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure
        var m = ship.script._cachedPortWeapons; //read cached variable
        if( !m ) {
                m = w._getMultiSide(ship, 3); //read port multiple weapons length
                ship.script._cachedPortWeapons = m; //store into a cache variable
        }
        return( m );
}

this._getMultiSb = function(ship, w) {  //how many starboard multiple lasers are on this ship
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure
        var m = ship.script._cachedSbWeapons; //read cached variable
        if( !m ) {
                m = w._getMultiSide(ship, 4); //read starboard multiple weapons length
                ship.script._cachedSbWeapons = m; //store into a cache variable
        }
        return( m );
}

this._getMultiSide = function(ship, side) {  //how many multiple lasers are on this ship
        var length = 1;  //default is a single laser
        if( 0 &lt; oolite.compareVersion(&quot;1.83&quot;) ) length = 1; //no multiple before Oolite 1.83
        else {
                var shipdata = Ship.shipDataForKey(ship.dataKey);
                if( shipdata &amp;&amp; shipdata[&quot;weapon_mount_mode&quot;] == &quot;multiply&quot; ) {
                        if( side == 2 ) length = ship.weaponPositionAft.length;
                        else if( side == 3 ) length = ship.weaponPositionPort.length;
                        else if( side == 4 ) length = ship.weaponPositionStarboard.length;
                        else length = ship.weaponPositionForward.length; //forward is the default
                }
        }
        return (length);
}

this._isFar = function(ship, other, w) { //target is too far to use sapper?
        if( !w ) w = worldScripts.snipergun;
        if( ship &amp;&amp; ship.isValid &amp;&amp; other &amp;&amp; other.isValid ) {
                var d = ship.position.distanceTo(other.position);
                if( ship.script &amp;&amp; ship.script.$SapperFarDistance ) { //set in _setSapperDist()
                        if( d &gt; ship.script.$SapperFarDistance * 1000 ) return true;
                } else { //fallback to preset far distance
                        if( d &gt; w.$SapperFarDistance * 1000 ) return true;
                }
        }
        return false;
}

this._isHeavy = function( weapon, w ) { //weapon is a heavy sniper gun or a heavy sapper?
        if( !weapon ) return false;
        if( !w ) w = worldScripts.snipergun;
        var k = w._isSniperOrSapper( weapon );
        if( k == 2 || k == 4 ) return( k );
        return false;
}

this._isHot = function(ship, w) { //current laser is too hot so in red heat zone?
        if( ship &amp;&amp; ship.isValid ) { //multiple sappers make multiple heat with a shot
                var h = w.$Hot - ( w._getMulti(ship, w) - 1 ) * 0.039; // 10/256=3.9% heat
                if( ship.laserHeatLevel &gt; h ) return true;
        }
        return false;
}

this._isNear = function(ship, other, w) { //target is enough near to switch to sapper?
        if( !w ) w = worldScripts.snipergun;
        if( ship &amp;&amp; ship.isValid &amp;&amp; other &amp;&amp; other.isValid ) {
                var d = ship.position.distanceTo(other.position);
                if( ship.script &amp;&amp; ship.script.$SapperDistance ) { //set in _setSapperDist()
                        if( d &lt; ship.script.$SapperDistance * 1000 ) return true;
                } else { //fallback to preset near distance
                        if( d &lt; w.$SapperDistance * 1000 ) return true;
                }
        }
        return false;
}

this._isSapper = function( weapon, w ) { //weapon is a sapper?
        if( !weapon ) return false;
        if( !w ) w = worldScripts.snipergun;
        var k = w._isSniperOrSapper( weapon );
        if( k == 3 || k == 4 ) return( k );
        return false;
}

this._isSniper = function( weapon, w ) { //weapon is a sniper gun (and not a sapper)?
        if( !weapon ) return false;
        if( !w ) w = worldScripts.snipergun;
        var k = w._isSniperOrSapper( weapon );
        if( k == 1 || k == 2 ) return( k );
        return false;
}

this._isSniperOrSapper = function( weapon ) {
        var eq;
        if( weapon &amp;&amp; weapon.equipmentKey ) eq = weapon.equipmentKey;
        else eq = weapon; //the key is directly in the parameter
        if( !eq || !eq.length ) return false;
        //indexOf check separated guns also
        if( eq.indexOf(&quot;EQ_WEAPON_CANNON_SNIPER_GUN&quot;) &gt; -1 ) return 1;
        if( eq.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot; ) &gt; -1 ) return 2;
        if( eq.indexOf(&quot;EQ_WEAPON_CANNON_SAPPER&quot;) &gt; -1 ) return 3;
        if( eq.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot; ) &gt; -1 ) return 4;
        return false;
}

this._refund = function(eq, length) { //refund weapon price, length is the size of multiple weapons array
        var f = 1;
        if( player.ship &amp;&amp; player.ship.dockedStation ) {
                var e = player.ship.dockedStation.equipmentPriceFactor;
                if( e &gt; 0 ) f = e;
        }
        if( 0 &lt; oolite.compareVersion(&quot;1.83&quot;) ) length = 1; //no multiple weapons before Oolite 1.83
        var refund = 0, n = &quot;Laser&quot;;
        var k = EquipmentInfo.infoForKey( eq );
        if( k ) {
                refund = f * length * k.price/10;
                player.credits += refund;
                n = k.name;
        }
        var m = n+&quot; removed from invalid mount, &quot;+refund+&quot; credits refunded.&quot;;
        player.consoleMessage(m, 10);
        log(this.name, m);
        return( refund );
}

this._replaceLasers = function(ship, w) { //call replace in separated lasers OXP
        if( w.$SL ) {
                w.$SLReplace = true; //needed to allowAwardSniperGun allow replace
                w.$SL._Replace_Lasers(ship, w.$SL, false); //replace without refund
                w.$SLReplace = false; //do not allow at purchase
        }
}

this._sapper = function(source, target, x, w) { //apply sapper damage
        if( !w ) w = worldScripts.snipergun;
        var dmg = 0;
        if( source &amp;&amp; source.currentWeapon &amp;&amp; target &amp;&amp; target.isValid ) {
                var d = 0;
                var k = w._isSapper( source.currentWeapon, w );
                if ( k == 3 ) d = 10; //base damage of a Sapper, must be equal with damage in eq plist
                else if ( k == 4 ) d = 20; //base damage of a Heavy Sapper, equal with damage in eq plist
                if( d &gt; 0 ) {
                        if( !x ) x = 1;
                        x = Math.min( 1, Math.max( 0, x ) ); //x must be min. 0 and max. 1
                        d = d * x;
                        if( source.isCloaked ) source.isCloaked = false; //break cloak
                        dmg = d * w._sapperBonus( source, target, w );
                        dmg = Math.min( target.energy - 1, dmg ); //do not destroy the ship
                        var e, name, p = player.ship;
                        if( target == p ) {
                                if( p.forwardShield &gt; dmg/2 &amp;&amp; p.aftShield &gt; dmg/2 ) {
                                        p.forwardShield -= dmg/2; //both shields are affected
                                        p.aftShield -= dmg/2;
                                } else p.energy -= dmg;
                                e = Math.round( p.forwardShield ) + &quot;+&quot; +
                                        + Math.round( p.aftShield ) + &quot; shield and &quot;
                                        + Math.round( p.energy );
                                name = &quot;Player&quot;;
                        } else { //NPC
                                target.energy -= dmg;
                                e = Math.round(target.energy);
                                name = target.name + &quot; &quot; + target.entityPersonality;
                                if( source == p ) {
                                        if( dmg &lt; 2*d || x &lt; 1 ) { //partial or far sapper hit
                                                w.$Sound.play();
                                        } else if( dmg &lt; d * 4 ) { //average sapper hit (2x volume)
                                                w.$Sound0.play();
                                                w.$Sound1.play();
                                        } else { //maximal sapper hit (3x volume)
                                                w.$Sound.play();
                                                w.$Sound0.play();
                                                w.$Sound1.play();
                                        }
                                }
                        }
                        if( source == p || target == p ) { //do not log NPC-NPC hits
                                var dm = &quot;Sapper damage: &quot;+Math.round(dmg);
                                if( x &lt; 1 ) dm = &quot;partial (&quot;+x+&quot;x) &quot; + dm;
                                log( this.name, name+&quot; taking &quot;+dm+&quot;, &quot;+e+&quot; energy left&quot;);
                        }
                }
        }
        return( dmg );
}

this._sapperBonus = function( source, target, w ) { //calculate sapper multiplier
        if( !source || !source.isValid || !target || !target.isValid ) return( 0 );
        if( !w ) w = worldScripts.snipergun;
        if( target.equipmentStatus(&quot;EQ_SAPPERNULLIFIER&quot;) == &quot;EQUIPMENT_OK&quot; ) {
                if( target.script ) target.script.$hasAntiSapper = true;
                if( source == player.ship )
                        player.consoleMessage( target.name+&quot; has Sapper Nullifier equipment&quot; );
                return( 0 );
        }
        var dist = source.position.distanceTo(target.position) - target.collisionRadius; //as on target box
        var s = 1; //1x damage is given by the core, s contain the bonus over core so s=1 mean 2x in total
        //2x damage at 2km, 4x at 1km, 5x within 500m, but only single damage over 20km
        if( dist &lt; 2000 ) {
                s = Math.max( 1, 4 - Math.max(0, dist - 500)/500 ); //fast gain within 2km
        } else s = (20000 - dist)/18000; //slow dissipation over 2km down to no bonus at 20km
//      var m = w._getMulti(source, w);//multiple laser - commented out due to handled by the core well
//      if( m &gt; 1 ) s = s * Math.min( m, 3 ); //max. 3x, let&#39;s say other lasers are too far from center
        if( w.$HS ) s = s - w.$HS.$HardShips_GetHardShieldLevel( target ) / 3;
        if( target.equipmentStatus(&quot;EQ_ANTISAPPER&quot;) == &quot;EQUIPMENT_OK&quot; ) {
                if( target.script ) target.script.$hasAntiSapper = true;
                if( source == player.ship )
                        player.consoleMessage( target.name+&quot; has Anti-Sapper equipment&quot; );
                s = s / 2; //half damage
        }
        return( Math.max( 0, s ) ); //exclude negative values
} //return the bonus damage over the base value (which is applied by the core), so 4 mean 5x dmg.

this._sapperBreak = function(ship, w) { //check if sapper is break in overheat
        if( !w ) w = worldScripts.snipergun;
        //log(w.name, ship.name+&quot; Heat:&quot;+ship.laserHeatLevel);//debug
        var brk = false;
        if( ship.laserHeatLevelForward &gt; w.$OverHeat &amp;&amp; w._isSapper( ship.forwardWeapon, w ) ) {
                if( Math.random() &lt; w.$DmgCh ) brk = true;
        }
        if( ship.laserHeatLevelAft &gt; w.$OverHeat &amp;&amp; w._isSapper( ship.aftWeapon, w ) ) {
                if( Math.random() &lt; w.$DmgCh ) brk = true;
        }
        if( ship.laserHeatLevelPort &gt; w.$OverHeat &amp;&amp; w._isSapper( ship.portWeapon, w ) ) {
                if( Math.random() &lt; w.$DmgCh ) brk = true;
        }
        if( ship.laserHeatLevelStarboard &gt; w.$OverHeat
                &amp;&amp; w._isSapper( ship.starboardWeapon, w ) ) {
                if( Math.random() &lt; w.$DmgCh ) brk = true;
        }
        if( brk ) {
                if( ship.equipmentStatus(&quot;EQ_SAPPERMODE&quot;) == &quot;EQUIPMENT_OK&quot; ) {
                        ship.setEquipmentStatus(&quot;EQ_SAPPERMODE&quot;, &quot;EQUIPMENT_DAMAGED&quot;);
                        var n;
                        var m = &quot;Sapper Mode damaged by overheat, reduced to Sniper Gun&quot;;
                        if( ship.currentWeapon != ship.forwardWeapon )
                                ship.forwardWeapon = w._sapperToSniper( ship.forwardWeapon );
                        if( ship.currentWeapon != ship.aftWeapon )
                                ship.aftWeapon = w._sapperToSniper( ship.aftWeapon );
                        if( ship.currentWeapon != ship.portWeapon )
                                ship.portWeapon = w._sapperToSniper( ship.portWeapon );
                        if( ship.currentWeapon != ship.starboardWeapon )
                                ship.starboardWeapon = w._sapperToSniper( ship.starboardWeapon );
                        if( ship == player.ship ) {
                                n = &quot;Player&#39;s &quot;;
                                player.consoleMessage( m, 10 );
                                w.$Sound5.play(); //sound of sapper break due to overheat
                                w._startSwitchToSniper( ship, w );
                        } else {
                                n = ship.name+&quot; &quot;+ship.entityPersonality;
                                ship.currentWeapon = w._sapperToSniper( ship.currentWeapon );
                        }
                        log(w.name, n+&quot; &quot;+m);//debug
                        //Overheat damaged Sapper Mode, reduce all Sappers to Sniper Gun
                }
                //replace to separated lasers without refund
                w._replaceLasers(ship, w);
        }
        return( brk );
}

this._sapperSwitchPlayer = function( w ) { //called from equipment script when activated
        if( !w ) w = worldScripts.snipergun;
        var p = player.ship;
        if( !p || !p.isValid ) return;
        if( p.equipmentStatus(&quot;EQ_SAPPERMODE&quot;) == &quot;EQUIPMENT_DAMAGED&quot; ) {
                player.consoleMessage( &quot;Sapper Mode is damaged, can not switch.&quot; );
                return;
        } else if( p.equipmentStatus(&quot;EQ_SAPPERMODE&quot;) != &quot;EQUIPMENT_OK&quot; ) return;

        w._sapperSwitch( p, w );
        w.$TManual = w.$ManualOverride * 4;  //no auto change right after manual keypress
}

this._sapperSwitch = function( ship, w ) {
        if( !w ) w = worldScripts.snipergun;
        if( w._isSniper( ship.currentWeapon, w ) ) {
                w._startSwitchToSapper( ship, w );
        } else if( w._isSapper( ship.currentWeapon, w ) ) {
                w._startSwitchToSniper( ship, w );
        }
}

this._sapperToSniper = function(weapon) {
        if( !weapon || !weapon.equipmentKey ) return (&quot;&quot;);
        if( weapon.equipmentKey.indexOf(&quot;EQ_WEAPON_CANNON_SAPPER&quot;) &gt; -1 )
                return (&quot;EQ_WEAPON_CANNON_SNIPER_GUN&quot;);
        if( weapon.equipmentKey.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot;) &gt; -1 )
                return (&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot;);
        return (weapon.equipmentKey); //no change
}

this._setSapperDist = function( ship, w ) { //set Sapper Distance, will switch to Sniper Gun outside
        if( !w ) w = worldScripts.snipergun;
        if( !ship || !ship.isValid ) return 0;
        if( !ship.script ) ship.setScript(&quot;oolite-default-ship-script.js&quot;); //for sure

        var d = 2;//default distance
        if( ship == player.ship &amp;&amp; w.$SapperMode == 2 ) { //player&#39;s preset mode
                ship.script.$SapperDistance = d = w.$SapperDistance;
                ship.script.$SapperFarDistance = w.$SapperFarDistance;
        } else {
                if( ship == player.ship ) {
                        if( w.$SapperMode == 1 ) { //auto mode, different for forward and aft mounts
                                var m = Math.min( 5, Math.max( 0, w._getMulti(ship, w) ) );
                                d = w.$SapperDistances[ m ]; //select optimal distance for multiple lasers
                                ship.script.$SapperDistance = d; //used in _isNear()
                        } else { //distance modes (3-6)
                                d = w.$SapperDistances[ w.$SapperMode - 3 ]; //0-5 is valid in array
                                if( d &gt; 0 ) ship.script.$SapperDistance = d; //set a valid distance
                                //fallback to preset mode in invalid mode for sure
                                else ship.script.$SapperDistance = d = w.$SapperDistance;
                        }
                } else { //NPC always use forward mount to determine optimal distance for multiple lasers
                        var m = Math.min( 5, Math.max( 0, w._getMultiFw(ship, w) ) );
                        d = w.$SapperDistances[ m ];
                        ship.script.$SapperDistance = d; //used in _isNear()
                }
                //if switch to sapper within 0.5km then back to sniper over 1km
                if( d &lt; 1 ) ship.script.$SapperFarDistance = d + 0.5; //used in _isFar()
                else ship.script.$SapperFarDistance = d + 1; //1km hysteresis before switch back to sg
        }
        return( d );
}

this._sniperToSapper = function(weapon) {
        if( !weapon || !weapon.equipmentKey ) return (&quot;&quot;);
        if( weapon.equipmentKey.indexOf(&quot;EQ_WEAPON_CANNON_SNIPER_GUN&quot;) &gt; -1 )
                return (&quot;EQ_WEAPON_CANNON_SAPPER&quot;);
        if( weapon.equipmentKey.indexOf(&quot;EQ_WEAPON_CANNON_HEAVY_SNIPER_GUN&quot;) &gt; -1 )
                return (&quot;EQ_WEAPON_CANNON_HEAVY_SAPPER&quot;);
        return (weapon.equipmentKey); //no change
}

this._startSwitchToSniper = function( ship, w ) {
        if( !w ) w = worldScripts.snipergun;
        if( ship == player.ship ) { //start delay
                if( w.$TSapper == 0 ) { //make sure no changing in progress
                        //positive  mean sapper to sniper in timer
                        w.$TSapper = Math.max( 1, Math.ceil(w.$Delay*4) );
                        w.$VDir = player.ship.viewDirection;
                        if( w.$VDir != &quot;VIEW_AFT&quot; &amp;&amp; w.$VDir != &quot;VIEW_PORT&quot;
                                &amp;&amp; w.$VDir != &quot;VIEW_STARBOARD&quot; ) {
                                w.$VDir = &quot;VIEW_FORWARD&quot;;  //in custom or gui view also
                                w.$Cwp = ship.forwardWeapon;
                                ship.forwardWeapon = null;
                        } else {
                                w.$Cwp = ship.currentWeapon;
                                ship.currentWeapon = null;
                        }
                        if( w.$XH  &amp;&amp; w.$XH.$xenonHUDActive() ) 
                                w.$XH.viewDirectionChanged( w.$VDir ); //update crosshairs
                        else {
                                if( w.$TCr == -1 ) w.$TCr = player.ship.crosshairs;
                                var h = &quot;&quot;;
                                if( w._isHeavy( w.$Cwp, w ) ) h = &quot;heavy&quot;;
                                player.ship.crosshairs = &quot;snipergun-crosshairs-7&quot;+h+&quot;.plist&quot;;
                        }
                        w.$Sound4.play(); //sapper off
                }
        } else w._switchToSniper( ship, w ); //NPC switch instantly
}

this._startSwitchToSapper = function( ship, w ) {
        if( !w ) w = worldScripts.snipergun;
        if( ship.energy &lt; w.$SapperMinEnergy ) {
                if( ship == player.ship )
                        player.consoleMessage( &quot;Not enough energy for Sapper&quot; );
                return;
        }
        if( ship == player.ship ) { //start delay
                if( w.$TSapper == 0 ) { //make sure no changing in progress
                        //negative mean sniper to sapper in timer
                        w.$TSapper = Math.min( -1, -Math.ceil(w.$Delay*4) );
                        w.$VDir = player.ship.viewDirection;
                        if( w.$VDir != &quot;VIEW_AFT&quot; &amp;&amp; w.$VDir != &quot;VIEW_PORT&quot;
                                &amp;&amp; w.$VDir != &quot;VIEW_STARBOARD&quot; ) {
                                w.$VDir = &quot;VIEW_FORWARD&quot;;  //in custom or gui view also
                                w.$Cwp = ship.forwardWeapon;
                                ship.forwardWeapon = null;
                        } else {
                                w.$Cwp = ship.currentWeapon;
                                ship.currentWeapon = null;
                        }
                        if( w.$XH &amp;&amp; w.$XH.$xenonHUDActive() )
                                w.$XH.viewDirectionChanged( w.$VDir ); //update crosshairs
                        else {
                                if( w.$TCr == -1 ) w.$TCr = player.ship.crosshairs;
                                var h = &quot;&quot;;
                                if( w._isHeavy( w.$Cwp, w ) ) h = &quot;heavy&quot;;
                                player.ship.crosshairs = &quot;snipergun-crosshairs-1&quot;+h+&quot;.plist&quot;;
                        }
                        w.$Sound3.play(); //sapper on
                }
        } else w._switchToSapper( ship, w ); //NPC switch instantly
}

this._switchToSapper = function( ship, w ) { //instant switch weapons
        if( !w ) w = worldScripts.snipergun;
        var vd = player.ship.viewDirection;
        if( ship == player.ship &amp;&amp; w.$VDir ) {
                var nw = w._sniperToSapper( w.$Cwp ); //new weapon
                if( w.$VDir == &quot;VIEW_AFT&quot; ) ship.aftWeapon = nw;
                else if( w.$VDir == &quot;VIEW_PORT&quot; ) ship.portWeapon = nw;
                else if( w.$VDir == &quot;VIEW_STARBOARD&quot; ) ship.starboardWeapon = nw;
                else ship.forwardWeapon = nw;
                w.$Cwp = null;
                w.$VDir = null;
        } else ship.currentWeapon = w._sniperToSapper( ship.currentWeapon ); //NPC
        if( ship == player.ship ) {
                if( w.$XH ) w.$XH.viewDirectionChanged( vd ); //update Xenon HUD crosshairs
                w.autoCrosshairs( w ); //update autocrosshairs
//                if( ship.currentWeapon )
//                        player.consoleMessage( ship.currentWeapon.name+&quot; activated&quot; );
        }
        //separated laser replace is not needed due to sappers are not separable weapons
}

this._switchToSniper = function( ship, w ) { //instant switch weapons
        if( !w ) w = worldScripts.snipergun;
        var vd = player.ship.viewDirection;
        if( ship == player.ship &amp;&amp; w.$VDir ) {
                var nw = w._sapperToSniper( w.$Cwp ); //new weapon
                if( w.$VDir == &quot;VIEW_AFT&quot; ) ship.aftWeapon = nw;
                else if( w.$VDir == &quot;VIEW_PORT&quot; ) ship.portWeapon = nw;
                else if( w.$VDir == &quot;VIEW_STARBOARD&quot; ) ship.starboardWeapon = nw;
                else ship.forwardWeapon = nw;
                w.$Cwp = null;
                w.$VDir = null;
        } else ship.currentWeapon = w._sapperToSniper( ship.currentWeapon ); //NPC
        if( ship == player.ship ) {
                if( w.$XH ) w.$XH.viewDirectionChanged( vd ); //update crosshairs
                w.autoCrosshairs( w ); //update autocrosshairs
//                if( ship.currentWeapon )
//                        player.consoleMessage( ship.currentWeapon.name+&quot; activated&quot; );
        }
        w._replaceLasers(ship, w); //separated lasers
}

this._timed = function() { //regular target distance check and delayed sapper-sniper changes
        var p = player.ship;
        var w = this;
        if( !p || !p.isValid ) return;
        if( p.laserHeatLevel &gt; w.$OverHeat ) {
                if( !w.$TOHeat ) {  //check overheat damage
                        w.$TOHeat = true; //do not check again until not below $OverHeat
                        w._sapperBreak( p, w );
                }
        } else w.$TOHeat = false;
        if( w.$TSapper == 0 ) { //make sure no changing in progress
                if( w.$TManual &gt; 0 ) w.$TManual--; //no auto change right after manual keypress
                else w._checkSapperMode( p, p.target, w );
        } else { //changing in progress
                if( w.$TSapper &gt; 0 ) { //sapper to sniper
                        if( w.$TSapper &gt; 1 ) {
                                w.$TSapper--; //countdown to 1
                                if( !w.$XH || !w.$XH.$xenonHUDActive() ) {
                                        if( w.$TCr == -1 ) w.$TCr = player.ship.crosshairs;
                                        var h = &quot;&quot;;
                                        if( w._isHeavy( w.$Cwp, w ) ) h = &quot;heavy&quot;;
                                        var tc = Math.min( 7, w.$TSapper ); //animation in max. 7 steps
                                        player.ship.crosshairs = &quot;snipergun-crosshairs-&quot;+tc+h+&quot;.plist&quot;;
                                        //player.consoleMessage(player.ship.crosshairs, 1);//debug
                                }
                        } else { //change at 1
                                w.$TSapper = 0;
                                if( !w.$XH || !w.$XH.$xenonHUDActive() ) {
                                        if( !w.$TCr ) w.$TCr = &quot;crosshairs.plist&quot;; //never set to null!
                                        player.ship.crosshairs = w.$TCr; //end of animation
                                        //player.consoleMessage(player.ship.crosshairs, 1);//debug
                                        w.$TCr = -1;
                                }
                                w._switchToSniper( p, w );
                        }
                } else  { //sniper to sapper
                        if( w.$TSapper &lt; -1 ) {
                                w.$TSapper++; //count up to -1
                                if( !w.$XH || !w.$XH.$xenonHUDActive() ) {
                                        if( w.$TCr == -1 ) w.$TCr = player.ship.crosshairs;
                                        var h = &quot;&quot;;
                                        if( w._isHeavy( w.$Cwp, w ) ) h = &quot;heavy&quot;;
                                        var tc = Math.max( 1, w.$TSapper+8 ); //animation in max. 7 steps
                                        player.ship.crosshairs = &quot;snipergun-crosshairs-&quot;+tc+h+&quot;.plist&quot;;
                                        //player.consoleMessage(player.ship.crosshairs, 1);//debug
                                }
                        } else { //change at -1
                                w.$TSapper = 0;
                                if( !w.$XH || !w.$XH.$xenonHUDActive() ) {
                                        if( !w.$TCr ) w.$TCr = &quot;crosshairs.plist&quot;; //never set to null!
                                        player.ship.crosshairs = w.$TCr; //end of animation
                                        //player.consoleMessage(player.ship.crosshairs, 1);//debug
                                        w.$TCr = -1;
                                }
                                w._switchToSapper( p, w );
                        }
                }
        }
        if( w.$TCr == -1 ) w.autoCrosshairs( w ); //update autocrosshairs
}

this._validate = function(equipmentKey, w) {
    //called from playerBoughtEquipment, playerBoughtNewShip and startUp
    if( !w ) w = worldScripts.snipergun;
    var valid = false;
    var datakey = false; //dataKey of snipergun subentity
    var sg = w._isSniperOrSapper( equipmentKey );
    if( sg == 1 || sg == 3 ) datakey = &quot;snipergun&quot;; //sniper gun or sapper
    else if( sg == 2 || sg == 4 ) datakey = &quot;snipergun-heavy&quot;; //heavy sniper or heavy sapper
    if( datakey ) { //player bought a sniper gun
            var p = player.ship;
//          log(w.name, equipmentKey+&quot; &quot;+datakey+&quot; &quot;+p.forwardWeapon+&quot; &quot;+p.aftWeapon+&quot; &quot;+p.portWeapon+&quot; &quot;+p.starboardWeapon); //debug

            //check if there is a sniper gun in the ship
            //can not put sniper guns into side mounts
            if( p.portWeapon &amp;&amp; p.portWeapon.equipmentKey //match at start for separated lasers
                    &amp;&amp; p.portWeapon.equipmentKey.indexOf( equipmentKey ) == 0 ) {
                    w._refund( p.portWeapon.equipmentKey, w._getMultiPort(p, w) );
                    p.portWeapon = null;
            }

            if( p.starboardWeapon &amp;&amp; p.starboardWeapon.equipmentKey
                    &amp;&amp; p.starboardWeapon.equipmentKey.indexOf( equipmentKey ) == 0 )  {
                    w._refund( p.starboardWeapon.equipmentKey, w._getMultiSb(p, w)  );
                    p.starboardWeapon = null;
            }

            //check if there is a needed subentity in the ship
            //aft mount need aft orientation
            if( p.aftWeapon &amp;&amp; p.aftWeapon.equipmentKey
                    &amp;&amp; p.aftWeapon.equipmentKey.indexOf( equipmentKey ) == 0 ) {
                    if( !(w._checkAftSubEnt(p, datakey, w) &gt;= 0) ) {
                            w._refund( p.aftWeapon.equipmentKey, w._getMultiAft(p, w) );
                            p.aftWeapon = null;
                    } else valid = true;
            }

            //forward mount need subentity with non-aft orientation
            if( p.forwardWeapon &amp;&amp; p.forwardWeapon.equipmentKey
                    &amp;&amp; p.forwardWeapon.equipmentKey.indexOf( equipmentKey ) == 0 ) {
                    if( !(w._checkForwardSubEnt(p, datakey, w) &gt;= 0) ) {
                            w._refund( p.forwardWeapon.equipmentKey, w._getMultiFw(p, w) );
                            p.forwardWeapon = null;
                    } else valid = true;
            }

            if( valid ) {
                    if( sg == 3 || sg == 4 ) p.awardEquipment(&quot;EQ_SAPPERMODE&quot;);
                    if( !w.$Timer ) w.$Timer = new Timer(w, w._timed.bind(this), 0.25, 0.25);
            }

    }
    return( valid );
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
