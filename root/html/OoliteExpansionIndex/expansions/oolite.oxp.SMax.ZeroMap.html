<html>
    <head>
        <title>Expansion ZeroMap</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion ZeroMap</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>http://wiki.alioth.net/index.php/ZeroMap -&gt; 404 Not Found</li>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN CAPITAL LETTER H)(&#39;[]&#39; vs &#39;[HIDE, MAP]&#39;)</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Hide map. Show only visited planets and nearby planets. Visited - all info. In 7LY - only names. In 10LY - as dots (for search isolated regions).</td>
                    <td>Hide map. Show only visited planets and nearby planets. Visited - all info. In 7LY - only names. In 10LY - as dots (for search isolated regions).</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.SMax.ZeroMap</td>
                    <td>oolite.oxp.SMax.ZeroMap</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>ZeroMap</td>
                    <td>ZeroMap</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>SMax</td>
                    <td>SMax</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.6</td>
                    <td>0.6</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>HIDE, MAP</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/a/aa/ZeroMap_0.6.oxz">https://wiki.alioth.net/img_auth.php/a/aa/ZeroMap_0.6.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873407</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        
        <h3>README.md</h3>
        <pre>Zero Map

By S Max

Hide map. Show only visited planets and nearby planets.

Difficulty levels:
------------------

 * Easy - shows full map of the Galaxy without names of systems.
     * Visited systems - all information.
     * Systems in 7LY - all information.
     * Systems in 10LY - only name of system.
 * Normal - hides map of the Galaxy. Some information about the surrounding systems are available. Isolated regions can be founded.
     * Visited systems - all information.
     * Systems in 7LY - only name of system.
     * Systems in 10LY - without name of system.
 * Hard - hides map of the Galaxy. Minimum information about the surrounding systems are available.
     * Visited systems - all information.
     * Systems in 7LY - without name of system.
 * Disable - shows standard map of the Galaxy.

Available in [Oolite](http://www.oolite.org/) package manager (Mechanics).

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Version History
===============

Release 0.6

* Fix additional store concealment state in save-file

Release 0.5

* Add difficulty levels.

Release 0.4

* In 1.84 work fine
* Visual observation allows to define system 10LY (for searching isolated systems).

Release 0.3

* Show marked systems or target systems in missions
* Map hudes only on map screens (and system info). Mission generation work fine.

Release 0.2

* Bugfix

Release 0.1

* Initial release</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>/* global system log worldScripts player mission missionVariables */

this.name = &quot;ZeroMap&quot;;
this.author = &quot;SMax&quot;;
this.copyright = &quot;2016 SMax&quot;;
this.licence = &quot;CC-BY-NC-SA 4.0&quot;;
this.description = &quot;Hide map. Show only visited planets and nearby planets. Visited - all info. In 7LY - only names. In 10LY - as dots (for search isolated regions).&quot;;
this.version = &quot;0.6&quot;;

&quot;use strict&quot;;

this._DEBUG = false;

this._visitedSystems = [
    [],
    [],
    [],
    [],
    [],
    [],
    [],
    []
];

// 0 - full info
// 100 - name
// 200 - as dot
// 300 - hide
// [not vis, visited, 7LY, targets, 10LY]
this._LEVEL = [
    [200, 0, 0, 100, 100], // Easy
    [300, 0, 100, 200, 200], // Normal
    [300, 0, 200, 200, 300], // Hard
    [0, 0, 0, 0, 0] // Disable
];
this._LEVEL_CURRENT = 1;

this._timer_start = new Date();
this._logger = function(msg, ignore_ts) {
    if (this._DEBUG) {
        if (ignore_ts) {
            log(this.name, msg);
        }
        else {
            var t = new Date();
            log(this.name, msg + &quot; [+&quot; + (t.getTime() - this._timer_start.getTime()) + &quot;ms]&quot;);
            this._timer_start = t;
        }
    }
};

// Импорт данных из Explorers Club
this._importFromExplorersClub = function() {
    this._logger(&quot;this._importFromExplorersClub()&quot;);

    var g = system.info.galaxyID;

    if (this._visitedSystems[g].length == 0) {

        this._visitedSystems[g] = [];
        for (var i = 0; i &lt; 256; i++) {
            this._visitedSystems[g][i] = 0;
        }

        var EC = worldScripts[&quot;Explorers Club&quot;];
        if (EC) {
            for (var i = 0; i &lt; 256; i++) {
                if (EC._playerVisited(g, i)) {
                    this._markVisitedSystem(g, i);
                }
            }
        }
    }

    this._logger(&quot;this._importFromExplorersClub END&quot;);
};

// Показать все системы (чтобы отработал System.infoForSystem как надо)
this._showAll = function(g) {
    this._logger(&quot;this._showAll(&quot; + g + &quot;)&quot;);

    for (var i = 0; i &lt; 256; i++) {
        System.infoForSystem(g, i).setProperty(2, &quot;concealment&quot;, null);
    }

    this._logger(&quot;this._showAll END&quot;);
};

// Скрыть все системы согласно this._visitedSystems
this._hideAll = function(g) {
    this._logger(&quot;this._hideAll(&quot; + g + &quot;)&quot;);
    var settings = this._LEVEL[this._LEVEL_CURRENT];

    for (var i = 0; i &lt; 256; i++) {
        var c = settings[this._visitedSystems[g][i]];
        if (typeof c == &#39;undefined&#39;) {
            c = 0;
        }
        System.infoForSystem(g, i).setProperty(2, &quot;concealment&quot;, c);
    }

    this._logger(&quot;this._hideAll END&quot;);
};

// Пометить систему и ее соседей как видимые (полостью или частично)
this._markVisitedSystem = function(g, i) {
    this._logger(&quot;this._markVisitedSystem(&quot; + g + &quot;,&quot; + i + &quot;)&quot;, 1);

    this._visitedSystems[g][i] = 1;
    var s = System.infoForSystem(g, i).systemsInRange();

    this._logger(&quot;Step 1: System.infoForSystem: &quot; + s.length, 1);

    for (var j = 0; j &lt; s.length; j++) {
        this._logger(s[j].name + &quot;:&quot; + this._visitedSystems[g][s[j].systemID]);
        if (this._visitedSystems[g][s[j].systemID] != 1) {
            this._visitedSystems[g][s[j].systemID] = 2;
        }
    }

    // Покажем ближайшие системы как результат визуального наблюдения
    s = System.infoForSystem(g, i).systemsInRange(10);

    this._logger(&quot;Step 2: System.infoForSystem: &quot; + s.length, 1);

    for (var j = 0; j &lt; s.length; j++) {
        this._logger(s[j].name + &quot;:&quot; + this._visitedSystems[g][s[j].systemID]);
        if (this._visitedSystems[g][s[j].systemID] == 0 || this._visitedSystems[g][s[j].systemID] == 3) {
            this._visitedSystems[g][s[j].systemID] = 4;
        }
    }

    this._logger(&quot;this._markVisitedSystem END&quot;, 1);
};

this._isInteger = function(value) {
    return typeof value === &quot;number&quot; &amp;&amp;
        isFinite(value) &amp;&amp;
        Math.floor(value) === value;
};

this._markTargetSystems = function() {
    this._logger(&quot;this._markTargetSystems()&quot;);

    var g = system.info.galaxyID;

    // Убирем старые отметки
    for (var i = 0; i &lt; 256; i++) {
        if (this._visitedSystems[g][i] == 3) {
            this._visitedSystems[g][i] = 0;
        }
    }

    // Контракты на доставу
    var contracts = player.ship.contracts;
    for (var i = 0; i &lt; contracts.length; i++) {
        this._markTarget(g, contracts[i].destination);
    }

    // Перевозка пассажиров
    var passengers = player.ship.passengers;
    for (var i = 0; i &lt; passengers.length; i++) {
        this._markTarget(g, passengers[i].destination);
    }

    // Доставка посылок
    var parcels = player.ship.parcels;
    for (var i = 0; i &lt; parcels.length; i++) {
        this._markTarget(g, parcels[i].destination);
    }

    // Отмеченные системы
    var markedSystems = mission.markedSystems;
    for (var i = 0; i &lt; markedSystems.length; i++) {
        var obj = markedSystems[i];
        if (typeof obj.system != &#39;undefined&#39;) {
            if (obj.name != &quot;exclubmap&quot;) { // Игнорим метки от Explorers Club (чтобы всю карту не показывать)
                this._markTarget(g, obj.system);
            }
        }
        else {
            this._markTarget(g, obj);
        }
    }

    this._logger(&quot;this._markTargetSystems() END&quot;);
};

this._markTarget = function(g, i) {
    this._logger(&quot;this._markTarget(&quot; + g + &quot;,&quot; + i + &quot;)&quot;, 1);

    if (this._visitedSystems[g][i] == 0) {
        this._visitedSystems[g][i] = 3;
    }
};

// Выполнить &quot;полный&quot; цикл работы - импорт из ExplorersClub + малый цикл.
this._doWorkFull = function() {
    this._logger(&quot;this._doWorkFull()&quot;);

    this._importFromExplorersClub();
    this._doWork();

    this._logger(&quot;this._doWorkFull END&quot;);
};

// Выполнить &quot;малый&quot; цикл работы
this._doWork = function() {
    this._logger(&quot;this._doWork()&quot;);

    // Если мы не в межсистемном пространстве
    if (system.ID != -1) {
        var g = system.info.galaxyID;
        this._markVisitedSystem(g, system.ID);
    }

    this._logger(&quot;this._doWork END&quot;);
};

// Старт игры
this.startUpComplete = function() {
    this._logger(&quot;this.startUpComplete()&quot;);

    this._loadData();

    // Тестирование видимости и достижимости систем (проверка изолированных систем)
    //this._setInRangeTester();

    this._doWorkFull();

    this._showMission(player.ship.dockedStation);

    this._logger(&quot;this.startUpComplete END&quot;);
};

// Определение &quot;Достижимых&quot; и &quot;видимых визуально&quot; систем из текущей
this._setInRangeTester = function() {
    var arr = [];
    arr.push(system.ID);
    var g = system.info.galaxyID;
    this._visitedSystems = [
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        []
    ];
    for (var i = 0; i &lt; 256; i++) {
        this._visitedSystems[g][i] = 0;
    }
    while (arr.length != 0) {
        this._logger(arr);
        var id = arr.pop();


        this._visitedSystems[g][id] = 1;
        var s = System.infoForSystem(g, id).systemsInRange();

        //this._logger(&quot;Step 1: System.infoForSystem: &quot; + s.length, 1);

        for (var j = 0; j &lt; s.length; j++) {
            //this._logger(s[j].name + &quot;:&quot; + this._visitedSystems[g][s[j].systemID]);
            if (this._visitedSystems[g][s[j].systemID] != 1) {
                this._visitedSystems[g][s[j].systemID] = 1;
                arr.push(s[j].systemID);
            }
        }

        // Покажем ближайшие системы как результат визуального наблюдения
        s = System.infoForSystem(g, id).systemsInRange(10);

        //this._logger(&quot;Step 2: System.infoForSystem: &quot; + s.length, 1);

        for (var j = 0; j &lt; s.length; j++) {
            //this._logger(s[j].name + &quot;:&quot; + this._visitedSystems[g][s[j].systemID]);
            if (this._visitedSystems[g][s[j].systemID] == 0) {
                this._visitedSystems[g][s[j].systemID] = 4;
            }
        }
    }

    this._logger(&quot;Not showing &quot; + g);
    for (var i = 0; i &lt; 256; i++) {
        if (this._visitedSystems[g][i] != 1) {
            var t = System.infoForSystem(g, id);
            this._logger(t.name + &quot;:&quot; + this._visitedSystems[g][i]);
        }
    }
    this._logger(&quot;Not showing END&quot;);
};

// Сохранение
this.playerWillSaveGame = function() {
    this._logger(&quot;this.playerWillSaveGame()&quot;);

    this._saveData();

    this._logger(&quot;this.playerWillSaveGame END&quot;);
};

// Выход из гипера
this.shipExitedWitchspace = function() {
    this._logger(&quot;this.shipExitedWitchspace()&quot;);

    this._doWork();

    this._logger(&quot;this.shipExitedWitchspace END&quot;);
};

// Переход между галактиками
this.playerEnteredNewGalaxy = function() {
    this._logger(&quot;this.playerEnteredNewGalaxy()&quot;);

    if (system.isInterstellarSpace) {
        return;
    }

    this._doWorkFull();

    this._logger(&quot;this.playerEnteredNewGalaxy END&quot;);
};

// Изменение экрана
this.guiScreenWillChange = function(to, from) {
    this._logger(&quot;this.guiScreenWillChange(): &quot; + from + &quot; -&gt; &quot; + to);

    this._mapShowOrHide(to, from);

    this._logger(&quot;this.guiScreenWillChange END&quot;);
};
this.guiScreenChanged = function(to, from) {
    this._logger(&quot;this.guiScreenChanged(): &quot; + from + &quot; -&gt; &quot; + to);

    this._mapShowOrHide(to, from);

    this._logger(&quot;this.guiScreenChanged END&quot;);
};

this._mapShowOrHide = function(to, from) {
    var g = system.info.galaxyID;

    if (to == &#39;GUI_SCREEN_SHORT_RANGE_CHART&#39; || to == &#39;GUI_SCREEN_LONG_RANGE_CHART&#39; || to == &#39;GUI_SCREEN_MISSION&#39; || to == &#39;GUI_SCREEN_SYSTEM_DATA&#39;) {
        this._hideGUIScreen();
        //this._timer = new Timer(this, this._hideGUIScreen, 0, -1);
    }
    else {
        this._showAll(g);
    }
};

this._hideGUIScreen = function() {
    this._logger(&quot;this._hideGUIScreen()&quot;);

    var g = system.info.galaxyID;
    this._markTargetSystems();
    this._hideAll(g);

    this._logger(&quot;this._hideGUIScreen END&quot;);
};

this._saveData = function() {
    // Сохраняем в save-файл посещения
    missionVariables.ZeroMap_VISITED_SYSTEMS__0_3 = JSON.stringify(this._visitedSystems);
    missionVariables.ZeroMap_SETTINGS_LEVEL = this._DIFFICULTY[this._LEVEL_CURRENT];
};

this._loadData = function() {
    // Инициализируем посещения
    this._visitedSystems = [
        [],
        [],
        [],
        [],
        [],
        [],
        [],
        []
    ];

    // Загружаем настройки
    var level = missionVariables.ZeroMap_SETTINGS_LEVEL;
    if (this._DIFFICULTY.indexOf(level) != -1) {
        this._logger(&quot;Level: &quot; + level);
        this._LEVEL_CURRENT = this._DIFFICULTY.indexOf(level);
    }

    // Загружаем посещения
    var tmp = JSON.parse(missionVariables.ZeroMap_VISITED_SYSTEMS__0_3);

    // Если загрузка не произошла - пытаемся импортировать исторические данные
    if (!tmp) {
        tmp = this._importFromOld();
    }

    // Если загрузили успешно
    if (tmp) {
        this._visitedSystems = tmp;
    }
};

this._importFromOld = function() {
    // Удаляем данные до версии 0.3
    delete missionVariables.ZeroMap_VISITED_SYSTEMS;

    return null;
};

this.shipDockedWithStation = function(station) {
    this._showMission(station);
};

this._DIFFICULTY = [&quot;Easy&quot;, &quot;Normal&quot;, &quot;Hard&quot;, &quot;Disable&quot;];

this._showMission = function(station) {
    this._logger(&quot;ZeroMap difficulty: &quot; + this._LEVEL_CURRENT + &quot; : &quot; + this._DIFFICULTY[this._LEVEL_CURRENT]);

    station.setInterface(&quot;ZeroMap_OXP&quot;, {
        title: &quot;ZeroMap&quot;,
        category: &quot;Options&quot;,
        summary: &quot;ZeroMap OXP settings&quot;,
        callback: this._missionCallBack.bind(this)
    });
};

this._missionCallBack = function(state) {

    player.ship.hudHidden = false;
    var states = [&quot;ZeroMap_01_EASY&quot;, &quot;ZeroMap_02_NORMAL&quot;, &quot;ZeroMap_03_HARD&quot;, &quot;ZeroMap_04_OFF&quot;];

    if (state == &quot;ZeroMap_OXP&quot;) {

        var choices_arr = [{
            text: &quot;Easy&quot;,
            //alignment: &quot;LEFT&quot;
        }, {
            text: &quot;Normal&quot;,
            //alignment: &quot;LEFT&quot;
        }, {
            text: &quot;Hard&quot;,
            //alignment: &quot;LEFT&quot;
        }, {
            text: &quot;Disable&quot;,
            //alignment: &quot;LEFT&quot;
        }];

        var choices = {};
        for (var i = 0; i &lt; choices_arr.length; i++) {
            choices[states[i]] = choices_arr[i];
        }

        choices.ZeroMap_00_Diff = {
            text: &quot;Difficulty&quot;,
            //alignment: &quot;LEFT&quot;,
            unselectable: true,
            color: &quot;whiteColor&quot;
        };

        choices.ZeroMap_50 = {
            text: &quot;&quot;,
            //alignment: &quot;LEFT&quot;
        };

        choices.ZeroMap_99_EXIT = {
            text: &quot;Exit&quot;,
            //alignment: &quot;LEFT&quot;
        };

        var current = current = choices_arr[this._LEVEL_CURRENT];
        current.text = &quot;* &quot; + current.text + &quot; *&quot;;
        current.color = &quot;greenColor&quot;;

        player.ship.hudHidden = true;
        mission.runScreen({
                title: &quot;Select ZeroMap difficulty&quot;,
                message: this._buildDescription(this._difficultyDescription),
                choices: choices,
                initialChoicesKey: &quot;ZeroMap_99_EXIT&quot;,
                exitScreen: &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot;
            },
            this._missionCallBack);
    }

    if (states.indexOf(state) != -1) {
        this._LEVEL_CURRENT = states.indexOf(state);

        player.ship.hudHidden = true;
        mission.runScreen({
                allowInterrupt: true,
                title: &quot;ZeroMap difficulty: &quot; + this._DIFFICULTY[this._LEVEL_CURRENT],
                message: &quot;Saved. Current settings are:\n\n&quot; + this._buildDescription(this._difficultyDescription[this._LEVEL_CURRENT]),
                //backgroundSpecial: &quot;SHORT_RANGE_CHART&quot;,
                exitScreen: &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot;
            },
            this._missionCallBack);
    }
};

this._buildDescription = function(desc) {
    var str = &quot;&quot;;

    for (var i = 0; i &lt; desc.length; i++) {
        var d = desc[i];
        if (Array.isArray(d)) {
            str += this._buildDescription(d) + &quot;\n&quot;;
        }
        else {
            str += d + &quot;\n&quot;;
        }
    }

    return str;
};

this._difficultyDescription = [
    [
        &quot;Easy - shows full map of the Galaxy without names of systems.&quot;,
        &quot;* Visited systems - all information.&quot;,
        &quot;* Systems in 7LY - all information.&quot;,
        &quot;* Systems in 10LY - only name of system.&quot;
    ],
    [
        &quot;Normal - hides map of the Galaxy. Some information about the surrounding systems are available. Isolated regions can be founded.&quot;,
        &quot;* Visited systems - all information.&quot;,
        &quot;* Systems in 7LY - only name of system.&quot;,
        &quot;* Systems in 10LY - without name of system.&quot;
    ],
    [
        &quot;Hard - hides map of the Galaxy. Minimum information about the surrounding systems are available.&quot;,
        &quot;* Visited systems - all information.&quot;,
        &quot;* Systems in 7LY - without name of system.&quot;
    ],
    [
        &quot;Disable - shows standard map of the Galaxy.&quot;
    ]
];</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
