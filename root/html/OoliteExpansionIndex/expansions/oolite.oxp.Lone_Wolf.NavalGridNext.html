<html>
    <head>
        <title>Expansion Naval Grid Next</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Naval Grid Next</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN CAPITAL LETTER E)(&#39;[]&#39; vs &#39;[Equipment, Shields]&#39;)</li>
                <li>Conflict Expansions mismatch between OXP Manifest and Expansion Manager at character position 0063 (DIGIT ZERO vs LATIN SMALL LETTER N)</li>
                <li>Unknown key &#39;upload_date&#39; at https://wiki.alioth.net/img_auth.php/b/ba/NavalGridNext-2.0.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Enhanced energy grid to link the energy units to the shields, enhancing recharging rates. There is a civilian and a naval version, requiring an Extra or  Naval Energy Unit.</td>
                    <td>Enhanced energy grid to link the energy units to the shields, enhancing recharging rates. There is a civilian and a naval version, requiring an Extra or  Naval Energy Unit.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Lone_Wolf.NavalGridNext</td>
                    <td>oolite.oxp.Lone_Wolf.NavalGridNext</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Naval Grid Next</td>
                    <td>Naval Grid Next</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Lone_Wolf</td>
                    <td>Lone_Wolf</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>2.0</td>
                    <td>2.0</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>Equipment, Shields</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                            <li>oolite.oxp.Thargoid.NavalGrid:0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Thargoid.NavalGrid:</li>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/NavalGrid_OXP">http://wiki.alioth.net/index.php/NavalGrid_OXP</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/b/ba/NavalGridNext-2.0.oxz">https://wiki.alioth.net/img_auth.php/b/ba/NavalGridNext-2.0.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-SA 4.0</td>
                    <td>CC-BY-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873454</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Naval%20Grid%20Next'>http://wiki.alioth.net/index.php/Naval%20Grid%20Next</a></p>
        <h3>Readme.txt</h3>
        <pre>Naval Grid Next
---------------
by Lone_Wolf

This OXP allows the the increased energy recharge rate from Extra Energy Unit (EEU) or Naval Energy Unit (NEU) to improve shield recharging.

The ship&#39;s factory energy grid will not transfer more than 4 energy units each second into the shields (2 to the forward and 2 to the aft shields) even if the energy is available, i. e., the ship&#39;s energy recharge rate exceeds 4 units/s. The Military Shield Enhancement include an upgrade of the fatcory energy grid to handle a recharge of 6 energy units each second (3 for each shield), but the same limitations apply : if the ship&#39;s energy recharge rate exceeds the 6 unit/s, that energy can&#39;t be used to recharge the shields.

This OXP creates two new energy grids allowing higher energy transfers to the shields if there is enough energy generation capability:

Enery grid

This is a civilian version built with standard components. It can only handle limited amounts of recharge energy, but is compatible with the EEU, routing up to 50% of the available recharge energy to the shields, and with the NEU, when it&#39;s capable of routing up to 30% of available recharge energy to the shields (which is still 20% higher than what would be transferred had the ship only an EEU).
Cost : 2,500 , techlevel 10

Naval Energy Grid

The military version meant for use with the Naval Energy Unit - it works with the EEU, but with the NEU it can accomplish its full potential. It&#39;s price is steep, but it can handle the huge amount of available recharge energy provided by the Naval Energy Unit: it will route up to 90% of the available energy recharge to the shields.
Cost : 65,000 , Techlevel 14 .


Notes for OXP developers
------------------------

This OXP makes available two helper functions:

* worldScripts.NavalGrid.$ng_calc_booster_recharge(ship)
    Parameters:
        ship: ship object

    Calculates the shield recharge rate taking into account the ship&#39;s scriptInfo (if any) and the ship&#39;s Shield Booster equipments. Does not update the ship&#39;s shield recharge rate properties.
    Output: object with properties &#39;aft&#39; and &#39;fwd&#39;


* worldScripts.NavalGrid.$ng_calc_shield_recharge_update(ship, shield_recharge_rates, context)
    Parameters:
        ship: ship object;
        shield_recharge_rates: object whith two properties (&#39;fwd&#39; and &#39;aft&#39;) with the ship&#39;s shield recharge rates (the ship&#39;s factory rates plus any Shield Booster);
        context: string describing the circunstances of the call, for logging purposes;

    Calculates the updated shield recharge rates given any Energy Grid (civillian or naval) installed in the ship. Does not update the ship&#39;s shield recharge rate properties.
    Output: object with properties &#39;aft&#39; and &#39;fwd&#39;


License 
-------

CC-BY-NC-SA 4.0 - Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International
(https://creativecommons.org/licenses/by-nc-sa/4.0/)


OXP History
-----------

The OXP was started by Thargoid, taken over by Lone_Wolf when Thargoid announced on forum he lacked time to keep maintaining his many oxps, then taken up by Dybal some years later (v2.x).

Up to v1.13, the energy grids were player ship only - they could be awarded to a NPC ship, but the NPC would get no additional shield recharge from them, even if the player were running an OXP do handle shields for the NPCs.

Version 2.0 is a re-write that aims to enable the OXP functionality for NPCs too, by making available functions that any OXP supplying a shield implementation for NPCs (like N-Shields) can use to discover the updated shield recharge rates.


Change Log
----------

v2.0
- made the Naval Energy Grid compatible with the EEU - if it can handle the NEU output, it sure can handle EEU&#39;s.
- NEU or EEU can be sold for a 40% refund.
- made the civilian energy grid transfer a lower fraction of the available energy when NEU (instead of EEU) was installed (lower fraction of a larger amount of energy is still a higher energy transfer).
- re-write to expose functions to calculate the shield recharge rates taking into account the Shield Boosters and taking into account the Energy Grids for other OXPs (N-Shields) to use enabling the Energy Grids for NPC ships.

v1.13 
- correcting Extra Energy Unit string identifier in equipment.plist thhat prevented the civilian Energy Grid from being available for purchase

v1.12 
- replacing handlers gave problems, switched to a different method of combining additive(NG next) and multiplicative modifiers.

v1.11.1
- replacement add/remove equipment handlers used wrong function name

v1.11
- it was impossible to install Naval Energy Unit or Naval Grid if you had civilian energy grid installed, added sell option for energy grid to solve this
- fixed errors in the functions that handle apply/revert the modificationss to the shield charge values

v1.10
- rewrite to make use of 1.82 feautures, especially the now writable shield recharge value.
- no longer uses a timer, core game now handles the actual shield recharging
- removed primable part as it&#39;s no longer relevant/needed with the new design
- added a lower spec civilian version that depends on EEU instead of NEU, so players can now get extra shield recharge if they have an EEU installed.
This should help survival in early/mid-game . (the energy is available, why not use it ? )


Older versions 

v1.00 initial release by Thargoid.

--------------------------------------------------------------

Acknowledgements:

With thanks to Zireael for the original inspiration and request.
Thargoid for creating this excellent oxp.
Lone_Wolf for a great re-write that simplified the equipments operation fot the player.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_ENERGY_GRID.html">Energy Grid</a></td>
                    <td>yes</td>
                    <td align="right">25000</td>
                    <td align="center">10+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_NAVAL_GRID.html">Naval Energy Grid</a></td>
                    <td>yes</td>
                    <td align="right">650000</td>
                    <td align="center">14+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SELL_ENERGY_GRID.html">Sell Energy Grid</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">10+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SELL_NAVAL_GRID.html">Sell Naval Energy Grid</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">14+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/NavalGrid.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;NavalGrid&quot;;
this.author      = &quot;Dybal&quot;;
this.copyright   = &quot;2020 Dybal&quot;;
this.licence     = &quot;CC-BY-NC-SA 4.0&quot;;
this.description = &quot;Naval Grid worldscript event handlers and functions&quot;;
this.version     = &quot;2.0&quot;;

this.$relatedEquipment = [  
                            &quot;EQ_ENERGY_GRID&quot;,
                            &quot;EQ_NAVAL_GRID&quot;,
                            &quot;EQ_ENERGY_UNIT&quot;,
                            &quot;EQ_NAVAL_ENERGY_UNIT&quot;,
                            &quot;EQ_SHIELD_BOOSTER&quot;,
                            &quot;EQ_NAVAL_SHIELD_BOOSTER&quot;
                        ];
this.$directEquipment = [
                            &quot;EQ_ENERGY_GRID&quot;,
                            &quot;EQ_NAVAL_GRID&quot;,
                        ];
this.$equipmentRemoval = {
                            EQ_SELL_ENERGY_GRID: &quot;EQ_ENERGY_GRID&quot;,
                            EQ_SELL_NAVAL_GRID: &quot;EQ_NAVAL_GRID&quot;
                         };
this.$debug = true;
this.$started = false;

//
// Event Handlers
//

//---------------------------------------------------------------------------------//
this.startUpComplete = function _startUpComplete() {
    this.$started = true;
    this._ng_player_update(&quot;startup&quot;);
}

//---------------------------------------------------------------------------------//
this.playerBoughtEquipment = function _playerBoughtEquipment(eqKey) {
    var _equipmentRemoval = this.$equipmentRemoval;
    if (eqKey in _equipmentRemoval) {
        var eq_to_remove = _equipmentRemoval[eqKey];
        player.ship.removeEquipment(eqKey);
        player.ship.removeEquipment(eq_to_remove);
        player.credits += 0.4 * EquipmentInfo.infoForKey(eq_to_remove).price;
    }
}  

//---------------------------------------------------------------------------------//
this.equipmentAdded = function _equipmentAdded(eqKey) {
    // don&#39;t alter the player ship&#39;s shieldRechargeRate until Oolite Equipment Control has 
    // initialized its baseline structure at startUp
    if (!this.$started) return;

    if (this.$relatedEquipment.indexOf(eqKey) &gt;= 0) {
        if (this.$directEquipment.indexOf(eqKey) &gt;= 0)
            this._ng_player_update(eqKey+&quot; added&quot;);
        else if (!this.$playerUpdateTimer) {
            // delay setup to allow Oolite Equipment Control&#39;s equipmentAdded to run first
            if (this.$debug) log(this.name, &quot;Delaying action on adding &quot;+eqKey);
            this.$playerUpdateTimer = new Timer(this, this._ng_player_update.bind(this, eqKey+&quot; added&quot;), 0);
        } else 
            if (this.$debug) log(this.name, &quot;equipmentAdded &quot;+eqKey+&quot;, there is already a timer running&quot;);
    }
}
 
//---------------------------------------------------------------------------------//
this.equipmentRemoved = function _equipmentRemoved(eqKey) {
    // don&#39;t alter the player ship&#39;s shieldRechargeRate until Oolite Equipment Control has 
    // initialized its baseline structure at startUp
    if (!this.$started) return;

    if (this.$relatedEquipment.indexOf(eqKey) &gt;= 0) {
        if (this.$directEquipment.indexOf(eqKey) &gt;= 0)
            this._ng_player_update(eqKey+&quot; removed&quot;);
        else if (!this.$playerUpdateTimer) {
            // delay setup to allow Oolite Equipment Control&#39;s equipmentRemoved to run first
            log(this.name, &quot;Delaying action on removing &quot;+eqKey);
            if (this.$debug) this.$playerUpdateTimer = new Timer(this, this._ng_player_update.bind(this, eqKey+&quot; removed&quot;), 0);
        } else
            if (this.$debug) log(this.name, &quot;equipmentRemoved &quot;+eqKey+&quot;, there is already a timer running&quot;);
    }
};  


//
//  Functions for OXPs to use
//

//-----------------------------------------------------------------------------------//
// Calculates Shield Recharge Rates based on the ship&#39;s original shield recharge rate and the
// shield booster devices installed on the ship.
// Does NOT alter the ship&#39;s properties.
this.$ng_calc_booster_recharge = function _ng_calc_booster_recharge(ship) {
    var that = _ng_calc_booster_recharge;
    var shieldBoosterEqs = (that.shieldBoosterEqs = shieldBoosterEqs || [ &quot;EQ_SHIELD_BOOSTER&quot;,
                                                                          &quot;EQ_NAVAL_SHIELD_BOOSTER&quot;,
                                                                          &quot;EQ_NSHIELDS_NPC_SHIELD_BOOSTER&quot;,
                                                                          &quot;EQ_NSHIELDS_NPC_NAVAL_SHIELD_BOOSTER&quot;
                                                                        ]);
    var shieldRecharge = { fwd: 2, aft: 2 };

    if (ship.scriptInfo) {
        if (ship.scriptInfo.shield_recharge_forward) shield_recharge.fwd = parseInt(ship.scriptInfo.shield_recharge_forward);
        if (ship.scriptInfo.shield_recharge_aft) shield_recharge.aft = parseInt(ship.scriptInfo.shield_recharge_aft);
    }

    var eq, scriptInfo, i = shieldBoosterEqs.length;
    while (i--) {
        eq = shieldBoosterEqs[i];
        if (ship.equipmentStatus(eq) === &quot;EQUIPMENT_OK&quot;) {
            scriptInfo = EquipmentInfo.infoForKey(eq).scriptInfo;
            if (this.$debug) log(&quot;NavalGrid&quot;, eq+&quot;, scriptInfo:&quot;+ JSON.stringify(scriptInfo));
            let recharge_boost = parseFloat(scriptInfo.oolite_shield_recharge_multiplier);
            shieldRecharge.fwd *= recharge_boost;
            shieldRecharge.aft *= recharge_boost;
        }
    }
    if (this.$debug) log(&quot;NavalGrid&quot;, ship.displayName+&quot;, shieldRechargeRate after Boosters: &quot;+shieldRecharge.fwd.toFixed(2)+&quot;/&quot;+shieldRecharge.aft.toFixed(2)+&quot;, shields: &quot;+ship.maxForwardShield+&quot;/&quot;+ship.maxAftShield);
    return shieldRecharge;
}

//-----------------------------------------------------------------------------------//
// Caculates the updated values for the Shield Recharge Rates based on the Grid equipment installed and functional on the ship.
// Deals only with the Grid effects, all other effects must already be incorporated into the base recharge rates input into this.
// NPC enabled, might be called by N-Shields when setting up NPC&#39;s shields.
// Does NOT alter the ship&#39;s properties.
// Input:
//      ship: reference to the ship object (player or NPC);
//      shRechargeRates: object with properties &#39;fwd&#39; and &#39;aft&#39;, containing the base shield recharge rate (the ship&#39;s original 
//                       shield recharge rates plus improvements from shield boosters) ;
//      context: string describing the circunstances of the call, for logging purposes;
// Output:
//      Object with properties &#39;fwd&#39; and &#39;aft&#39; with the updated (original + grid improvements) shield 
//      recharge rates;
this.$ng_calc_shield_recharge_update = function _ng_update(ship, shRechargeRates, context) { 
    var ng_switch_max = 0;
    var result = {
                    fwd: shRechargeRates.fwd,
                    aft: shRechargeRates.aft
    };
    
    // find the fraction of the energy &quot;production&quot; that should be earmarked for shields
    // based on the type of grid; this doesn&#39;t take into account at all the other energy
    // consuming equipments installed in the ship (shields have priority!), which could lead
    // to energy bank depletion (and ship destruction) if the shields keep being drained faster
    // than the improved recharge
    if (ship.equipmentStatus(&quot;EQ_ENERGY_GRID&quot;) === &quot;EQUIPMENT_OK&quot;) {
        if (ship.equipmentStatus(&quot;EQ_ENERGY_UNIT&quot;) === &quot;EQUIPMENT_OK&quot;)
            ng_switch_max = 0.5;
        else if (ship.equipmentStatus(&quot;EQ_NAVAL_ENERGY_UNIT&quot;) === &quot;EQUIPMENT_OK&quot;)
            // civillian grid shouldn&#39;t be able to carry full NEU load to the shields... 
            // this adds around 20% energy transfer compared to EEU
            ng_switch_max = 0.3;
    } else if (ship.equipmentStatus(&quot;EQ_NAVAL_GRID&quot;) === &quot;EQUIPMENT_OK&quot;) {
        if (ship.equipmentStatus(&quot;EQ_ENERGY_UNIT&quot;) === &quot;EQUIPMENT_OK&quot; ||
            ship.equipmentStatus(&quot;EQ_NAVAL_ENERGY_UNIT&quot;) === &quot;EQUIPMENT_OK&quot;)
            ng_switch_max = 0.9;
    }

    var total_shield_recharge_rate = shRechargeRates.fwd + shRechargeRates.aft;
    var available_energy = ship.energyRechargeRate - total_shield_recharge_rate;
    if (available_energy &gt; 0) {
        // only a part of the available energy &quot;production&quot; can be redirected to shields
        available_energy *= ng_switch_max;
        // distribute the available energy between the shields proportional to their recharge rates
        // shtRechRat = shRechRat + availEnerg*(shRechRat/totalRechRate)
        result.fwd *= 1 + (available_energy / total_shield_recharge_rate);
        result.aft *= 1 + (available_energy / total_shield_recharge_rate);
    }
    if (this.$debug) log(&quot;NavalGrid&quot;, ship.displayName+&quot;, shieldRechargeRate, from &quot;+shRechargeRates.fwd.toFixed(2)+&quot;/&quot;+shRechargeRates.aft.toFixed(2)+&quot; to &quot;+result.fwd.toFixed(2)+&quot;/&quot;+result.aft.toFixed(2)+&quot;, energyRechargeRate:&quot;+ship.energyRechargeRate.toFixed(2)+&quot;, available:&quot;+available_energy.toFixed(2));
    return result;
}


//
// Internal functions
//

//-----------------------------------------------------------------------------------//
this._ng_player_update = function _ng_player_update(context) {
    if (this.$debug) log(this.name, &quot;Updating player ship for &quot;+context);
    var ship = player.ship;

    var shieldRechargeRates = this.$ng_calc_booster_recharge(ship);
    var result = this.$ng_calc_shield_recharge_update(ship, shieldRechargeRates, context);

    ship.forwardShieldRechargeRate = result.fwd;
    ship.aftShieldRechargeRate = result.aft;
    delete this.$playerUpdateTimer;
}

</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
