<html>
    <head>
        <title>Expansion Damage Report MFD</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Damage Report MFD</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER M)(&#39;[]&#39; vs &#39;[mfd, equipment]&#39;)</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Displays a list of damaged equipment in an MFD.</td>
                    <td>Displays a list of damaged equipment in an MFD.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.DamageReportMFD</td>
                    <td>oolite.oxp.phkb.DamageReportMFD</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Damage Report MFD</td>
                    <td>Damage Report MFD</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>HUDs</td>
                    <td>HUDs</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>2.4</td>
                    <td>2.4</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>mfd, equipment</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/3d/DamageReportMFD.oxz">https://wiki.alioth.net/img_auth.php/3/3d/DamageReportMFD.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873279</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Damage%20Report%20MFD'>http://wiki.alioth.net/index.php/Damage%20Report%20MFD</a></p>
        <h3>readme.txt</h3>
        <pre>Damage Report MFD
By Nick Rogers

Overview - MFD
==============
This is a simple MFD that will automatically pop up in the first free MFD slot when equipment items are damaged. It will list items in cost order descending, so the more expensive items are listed at the top. The first line will display a count of the number of damaged items, and then the top 9 damaged items will be listed underneath.

The MFD has a couple of modes, selectable via a primable equipment item. Press &quot;B&quot; to change the mode. Available modes are:

Visible when damaged    - The damage report will always be visible when items are damaged.
Autohide after 60 sec   - The damage report will auto-hide itself after displaying damaged items for 60 seconds.
Manual                  - The damage report will only be displayed when the user makes it visible using the MFD selection keys.

The Damage Report MFD costs 250 Cr and is available from any system of tech level 4 or above.

The selected mode is stored in the save game file.

Damage Report Interface
-----------------------
When this OXP is installed, and your ship has damaged equipment, a new interface screen will become available on the F4 screen, called &quot;Damage Report&quot;. Opening this screen will list each damaged item, the estimated cost of repairs, and the minimum tech level required in order to repair it.

If you select an item in the list and press enter, a long range chart will appear, mapping the route to the closest destination of a suitable tech level where repairs can be conducted. Below this will be details of that equipment item, including the estimated repair cost and tech level required for purchase.  

If the closest planet for repairs is not the current planet, you will be able to automatically set your destination to that planet with the option &quot;Set course for (planet name)&quot;. 

If you have bought the MFD equipment, you will also have the ability to set the mode here. A menu option will be available, displaying the current type of MFD (Active or Passive), as well as the current mode. Selecting this menu item will cycle through all the available options.

MFD Active: The mode can be changed during flight using primable equipment.
MFD Passive: The mode can&#39;t be changed during flight, only via the interface screen.

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Image from http://simpleicon.com/wrench.html.

Version History
===============
2.4
- Fixed discrepancy between route shown on map and the number of jumps shown in text.
- Integration with planned OXP&#39;s.

2.3.4
- Bug fixes.

2.3.3
- When setting a course to a target system, F7 screen will now display the new destination.
- When viewing course to nearest repair system, map with switch to a short range chart if the distance to it is less than 7.4 LY.

2.3.2
- Added total estimated costs to the F4 interface page if more than 1 item is damaged.
- Code refactoring.

2.3.1
- Added number of jumps to map screen.

2.3.0
- Included Ship Configuration armour repair items in damaged list.
- Included IronHide armour repair item in damaged list.

2.2.8
- Better integration with the ANA.

2.2.7
- Fixed issue with HUD not becoming visible again when launching while viewing the damage report screen.

2.2.6
- Fixed issue where player destination was getting reset when a chart screen is exited by pressing a function key, rather than via the &quot;Exit&quot; command.

2.2.5
- Fixed issue where displaying course info when there is no system in the current chart with the required TL would result in a blank page, rather than the chart.
- Added check for above condition, so now the player is told there is no system with the required TL in the current chart.
- Fixed issue where, if the system with the required TL was more than 99 ly away, it was being assumed there was no system available.

2.2.4
- Updated check for &quot;Allow Big GUI&quot;.
- Bug fixes.

2.2.3
- Fixed small bug when attempting to update the MFD after the player ship is destroyed.
- Updated screenID&#39;s to enable BGS background sounds.
- Renamed background overlay image to prevent possibility of future duplication.
- Toned down overlay image.
- Trimmed unnecessary items from equipment.plist.
- Code refactoring.

2.2.2
- Fixed small issue with manifest file.

2.2.1
- Updated distance calculations to use route distance, rather than point-to-point distance.
- Fixed missing &quot;;&quot; in Javascript file.

2.2.0
- Added overlay background image to interface screen.

2.1.1
- Added routine to use 1.83/4 code to check for big GUI HUD&#39;s.

2.1.0
- MFD can now be removed.
- MFD now has two types: active (where the mode can be changed during flight) and passive (where the mode can only be changed via the interface screen)
- Added mission screen exception for Xenon Redux UI.
- Code refactoring.

2.0.1
- Added direct support for the MFD configuration system in the HUD Selector OXP.
- Improved the ability of the MFD to autohide itself when there are no damaged items.

2.0.0
- Added &quot;Damage Report&quot; interface screen.

1.0.0
- Initial release</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DAMAGE_REPORT_MFD.html">Damage Report MFD</a></td>
                    <td>yes</td>
                    <td align="right">2500</td>
                    <td align="center">4+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DAMAGE_REPORT_MFD_PASSIVE.html">Damage Report MFD</a></td>
                    <td>yes</td>
                    <td align="right">2500</td>
                    <td align="center">4+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DAMAGE_REPORT_MFD_PASSIVE_REMOVAL.html">Remove Damage Report MFD</a></td>
                    <td>no</td>
                    <td align="right">500</td>
                    <td align="center">4+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DAMAGE_REPORT_MFD_REMOVAL.html">Remove Damage Report MFD</a></td>
                    <td>no</td>
                    <td align="right">500</td>
                    <td align="center">4+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/damagereport_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;DamageReportMFD_Conditions&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2016 phkb&quot;;
this.description = &quot;Condition script for the Damage Report MFD (Passive Mode)&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.allowAwardEquipment = function(equipment, ship, context) {
	var p = player.ship;
	if (equipment == &quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) {
		if (context != &quot;scripted&quot;) return false;
	}
	if (equipment == &quot;EQ_DAMAGE_REPORT_MFD&quot;) {
		if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_DAMAGED&quot;) return false;
	}
	return true
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/damagereport_equip.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;DamageReportMFD_Equipment&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2016 phkb&quot;;
this.description = &quot;Allows the Damage Report MFD mode to be changed.&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

this.mode = function() {

	var w = worldScripts.DamageReportMFD;
	var p = player;

	w._mode += 1;
	if (w._mode == 3) w._mode = 0;

	switch (w._mode) {
		case 0:
			p.consoleMessage(&quot;Mode now &#39;Visible when damaged&#39;&quot;);
			break;
		case 1:
			p.consoleMessage(&quot;Mode now &#39;Autohide after &quot; + w._timeout + &quot; sec&#39;&quot;);
			break;
		case 2:
			p.consoleMessage(&quot;Mode now &#39;Manual&#39;&quot;);
			break;
	}
	w.$updateMFD();

}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/damagereport_mfd.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;DamageReportMFD&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2016 phkb&quot;;
this.description = &quot;Displays damaged equipment in an MFD&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

this._mfdID = -1;
this._mode = 0;							// can be 0 = Visible when damaged, 1 = Autohide 60, 2 = manual
this._timeout = 60;						// number of seconds mode 1 will take to autohide

this._maxpage = 0;						// total number of pages available for display
this._curpage = 0;						// the current page being displayed
this._msRows = 18;						// rows to display on the mission screen
this._displayMode = 0;					// controls the type of display (0 = master list, 1 = detail item)
this._selectedKey = &quot;&quot;; 				// equipment key of the currently selected item on the damage report interface screen.
this._routeMode = &quot;SHORTEST&quot;;			// default mode for long range chart

//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
	this._suspendedDestination = null;
	this._hudHidden = false;
	this._damageReportOpen = false;

	this._govs = new Array();
	for (var i = 0; i &lt; 8 ; i++) this._govs.push(String.fromCharCode(i));
	
	this._ecos = new Array();
	for (i = 0; i &lt; 8 ; i++) this._ecos.push(String.fromCharCode(23 - i));
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	if (missionVariables.DamageReportMFD_Mode) {
		// get the stored mode value
		this._mode = missionVariables.DamageReportMFD_Mode;
	}
	if (player.ship.docked) {
		this.$initInterface(player.ship.dockedStation);
	}
	// add a mission screen exception to Xenon UI
	if (worldScripts.XenonUI) {
		var wx = worldScripts.XenonUI;
		wx.$addMissionScreenException(&quot;oolite-damagereport-detail-map&quot;);
	}
	// add a mission screen exception to Xenon Redux UI
	if (worldScripts.XenonReduxUI) {
		var wxr = worldScripts.XenonReduxUI;
		wxr.$addMissionScreenException(&quot;oolite-damagereport-detail-map&quot;);
	}

	// add interface to HUD selector
	var h = worldScripts.hudselector;
	if (h) h.$HUDSelectorAddMFD(this.name, this.name);
}

//=============================================================================================================
// event interfaces

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
	// save the mode value
	missionVariables.DamageReportMFD_Mode = this._mode;
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillLaunchFromStation = function(station) {
	this.$updateMFD();
	if (this._mode == 0 &amp;&amp; this.$hasDamagedEquipment() == false) {
		if (this._autoHide &amp;&amp; this._autoHide.isRunning) this._autoHide.stop();
		this._autoHide = new Timer(this, this.$autoHideMFD, 1, 0);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function(station) {
	this.$initInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentDamaged = function(equipment) {
	this.$updateMFD();
}

//-------------------------------------------------------------------------------------------------------------
this.equipmentRepaired = function(equipment) {
	// theoretically this shouldn&#39;t happen during flight, as repairs are normally conducted at a station.
	// but if something like &quot;repair bots oxp&quot; is inatlled, then it could potentially happen.
	// so we&#39;ll update the mfd here as well
	this.$updateMFD();
	if (player.ship.docked) this.$initInterface(player.ship.dockedStation);
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function(equipment) {
	var p = player.ship;
	if (equipment == &quot;EQ_DAMAGE_REPORT_MFD_REMOVAL&quot;) {
		p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD&quot;);
		p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD_REMOVAL&quot;);
		delete missionVariables.DamageReportMFD_Mode;
	}
	if (equipment == &quot;EQ_DAMAGE_REPORT_MFD_PASSIVE_REMOVAL&quot;) {
		p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;);
		p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE_REMOVAL&quot;);
		delete missionVariables.DamageReportMFD_Mode;
	}
	if (equipment == &quot;EQ_DAMAGE_REPORT_MFD&quot;) {
		this.$initInterface(p.dockedStation);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function(to, from) {
	if (from == &quot;GUI_SCREEN_MISSION&quot; &amp;&amp; this._damageReportOpen) {
		this._damageReportOpen = false;
		if (this.$isBigGuiActive() == false) player.ship.hudHidden = this._hudHidden;
		if (this._suspendedDestination) player.ship.targetSystem = this._suspendedDestination;
		this._suspendedDestination = null;
	}
}

//=============================================================================================================
// MFD code

//-------------------------------------------------------------------------------------------------------------
// updates the text of the damage report MFD
this.$updateMFD = function() {
	function comparePrice(a,b) {
		if (a.price &lt; b.price) return 1;
		if (a.price &gt; b.price) return -1;
		return 0;
	}

	var output = &quot;&quot;;
	var p = player.ship;

	// only report if the player is in space
	if (p.isInSpace == false) return;
	// if we haven&#39;t bought the mfd, or it&#39;s damaged itself, don&#39;t display anything
	if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) != &quot;EQUIPMENT_OK&quot;) return;

	var eq = p.equipment;
	var list = [];

	// look for any visible, damaged equipment
	for (var i = 0; i &lt; eq.length; i++) {
		var q = eq[i];
		if (q.isVisible &amp;&amp; p.equipmentStatus(q.equipmentKey) == &quot;EQUIPMENT_DAMAGED&quot;) {
			list.push({key:q.equipmentKey, price:q.price, name:q.name});
		}
	}
	var bl = worldScripts.BreakableLasers_Main;
	if (bl) {
		if (p.forwardWeapon.equipmentKey == bl._damagedEq) {
			var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;FORWARD&quot;].primary);
			list.push({key:q.equipmentKey, price:q.price, name:q.name});
		}
		if (p.aftWeapon.equipmentKey == bl._damagedEq) {
			var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;AFT&quot;].primary);
			list.push({key:q.equipmentKey, price:q.price, name:q.name});
		}
		if (p.portWeapon.equipmentKey == bl._damagedEq) {
			var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;PORT&quot;].primary);
			list.push({key:q.equipmentKey, price:q.price, name:q.name});
		}
		if (p.starboardWeapon.equipmentKey == bl._damagedEq) {
			var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;STARBOARD&quot;].primary);
			list.push({key:q.equipmentKey, price:q.price, name:q.name});
		}
	}

	if (list.length == 0) {
		// no damaged equipment. yay!
		output = &quot;Damage Report:\n\nAll systems operational&quot;;
	} else {
		// some damaged equipment. bummer.
		list.sort(comparePrice);

		output = &quot;Damage Report: &quot; + list.length + (list.length == 1 ? &quot; item&quot; : &quot; items&quot;);

		// once we hit 9 items, we can&#39;t display any more so break out of the loop
		var limit = 9;
		if (list.length &lt; 9) limit = list.length
		for (var i = 0; i &lt; limit; i++) {
			output += &quot;\n&quot; + list[i].name;
		}
	}

	// set the text in the MFD
	p.setMultiFunctionText(this.name, output, false);

	// if the hud is hidden don&#39;t try an update - it will get confusing as to which mfd slot is open or not.
	if (p.hudHidden == false) {
		// mode 0 (on when damaged), and mode 1 (autohide after 60 secs), see if we need to force the mfd to display
		if (this._mode == 0 || this._mode == 1) {
			// find the slot currently set for this MFD
			this.$findMFDID();

			// if we haven&#39;t got a set slot (this._mfdID == -1) or the set slot we had is now unavailable...
			if (this._mfdID == -1 ||
				(p.multiFunctionDisplayList[this._mfdID] &amp;&amp; p.multiFunctionDisplayList[this._mfdID] != &quot;&quot; &amp;&amp; p.multiFunctionDisplayList[this._mfdID] != this.name)) {
				// find a free slot
				// first, make sure we reset our slot id marker (in the case where the previous one is in use)
				this._mfdID = -1;
				// search for a free slot
				for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
					if (!p.multiFunctionDisplayList[i] || p.multiFunctionDisplayList[i] == &quot;&quot;) {
						this._mfdID = i;
						break;
					}
				}
			}

			// we have a free slot, so force the mfd to display
			if (this._mfdID != -1) {
				if (list.length &gt; 0) {
					p.setMultiFunctionDisplay(this._mfdID, this.name);
				} else {
					// hide the MFD if there are no damaged items
					if (this._mode == 0) this.$autoHideMFD();
				}
				if (this._mode == 1) {
					// set a timer to hide the mfd
					if (this._autoHide &amp;&amp; this._autoHide.isRunning) this._autoHide.stop();
					this._autoHide = new Timer(this, this.$autoHideMFD, this._timeout, 0);
				}
			}
		}
		// for mode 2 (Manual) we don&#39;t need to do anything. The player will control the visibility of the MFD
	}
}

//-------------------------------------------------------------------------------------------------------------
// records the index of the MFD that currently holds the damage report mfd
this.$findMFDID = function() {
	var p = player.ship;
	for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
		if (p.multiFunctionDisplayList[i] == this.name) this._mfdID = i;
	}
}

//-------------------------------------------------------------------------------------------------------------
// hides all instances of the damage report MFD
this.$autoHideMFD = function $autoHideMFD() {
	var p = player.ship;
	if (p &amp;&amp; p.multiFunctionDisplayList) {
		for (var i = 0; i &lt; p.multiFunctionDisplayList.length; i++) {
			if (p.multiFunctionDisplayList[i] == this.name) {
				p.setMultiFunctionDisplay(i, &quot;&quot;);
			}
		}
	}
}

//=============================================================================================================
// Interface screen code

//-------------------------------------------------------------------------------------------------------------
// returns true if there is damaged equipment on the ship, otherwise false
this.$hasDamagedEquipment = function() {
	var p = player.ship;
	var eq = p.equipment;
	var result = false;
	for (var i = 0; i &lt; eq.length; i++) {
		var itm = eq[i];
		if (p.equipmentStatus(itm.equipmentKey) == &quot;EQUIPMENT_DAMAGED&quot;) {
			result = true;
			break;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
this.$initInterface = function(station) {
	var p = player.ship;
	if ((p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) == &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot;) || this.$hasDamagedEquipment() == true) {
		station.setInterface(this.name,{
			title:&quot;Damage report&quot;,
			category:expandDescription(&quot;[interfaces-category-logs]&quot;),
			summary:&quot;Lists all damaged equipment and details of potential repair costs and locations&quot;,
			callback:this.$initReport.bind(this)
		});
	} else {
		station.setInterface(this.name, null);
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$initReport = function() {
	this._displayMode = 0;
	this._curpage = 0;
	delete this._lastchoice;
	this._routeMode = player.ship.routeMode;
	this.$showDamageReport();
}

//-------------------------------------------------------------------------------------------------------------
// displays either the list of damaged equipment (_displayMode = 0) or the long range chart with route to nearest fix (_displayMode = 1)
this.$showDamageReport = function() {
	function comparePrice(a,b) {
		if (a.price &lt; b.price) return 1;
		if (a.price &gt; b.price) return -1;
		return 0;
	}

	var p = player.ship;

	var curChoices = {};
	var def = &quot;99_EXIT&quot;;
	var text = &quot;&quot;;

	// turn off the HUD (unless the hud implements the big Gui)
	this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() == false) {
		p.hudHidden = true;
	}
	this._msRows = 18;
	if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) == &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot;)
		this._msRows = 17;

	this._damageReportOpen = true;
	var total = 0;

	// lists all damaged equipment
	if (this._displayMode == 0) {
		var eq = p.equipment;
		var list = [];

		// look for any visible, damaged equipment
		for (var i = 0; i &lt; eq.length; i++) {
			var q = eq[i];
			if (q.isVisible &amp;&amp; p.equipmentStatus(q.equipmentKey) == &quot;EQUIPMENT_DAMAGED&quot;) {
				list.push({key:q.equipmentKey, price:q.price, name:q.name, techLevel:(q.effectiveTechLevel == 0 ? 1 : q.effectiveTechLevel), repairCost:(q.price / 10) * 0.5});
				total += (q.price / 10) * 0.5;
			}
		}

		// look for damaged lasers
		if (worldScripts.BreakableLasers_Main) {
			var bl = worldScripts.BreakableLasers_Main;
			if (p.forwardWeapon.equipmentKey == bl._damagedEq) {
				var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;FORWARD&quot;].primary);
				list.push({key:q.equipmentKey, price:q.price, name:q.name, techLevel:(q.effectiveTechLevel == 0 ? 1 : q.effectiveTechLevel), repairCost:(q.price / 10) * 0.5});
			}
			if (p.aftWeapon.equipmentKey == bl._damagedEq) {
				var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;AFT&quot;].primary);
				list.push({key:q.equipmentKey, price:q.price, name:q.name, techLevel:(q.effectiveTechLevel == 0 ? 1 : q.effectiveTechLevel), repairCost:(q.price / 10) * 0.5});
			}
			if (p.portWeapon.equipmentKey == bl._damagedEq) {
				var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;PORT&quot;].primary);
				list.push({key:q.equipmentKey, price:q.price, name:q.name, techLevel:(q.effectiveTechLevel == 0 ? 1 : q.effectiveTechLevel), repairCost:(q.price / 10) * 0.5});
			}
			if (p.starboardWeapon.equipmentKey == bl._damagedEq) {
				var q = EquipmentInfo.infoForKey(bl._holdDamage[&quot;STARBOARD&quot;].primary);
				list.push({key:q.equipmentKey, price:q.price, name:q.name, techLevel:(q.effectiveTechLevel == 0 ? 1 : q.effectiveTechLevel), repairCost:(q.price / 10) * 0.5});
			}
		}

		// look for ShipConfig damaged items
		if (worldScripts.ShipConfiguration_Core) {
			var sc = worldScripts.ShipConfiguration_Core;
			var arm = worldScripts.ShipConfiguration_Armour;
			var k2 = sc.$equipmentItemInUse(&quot;armour&quot;, player.ship);
			if (k2 !== &quot;&quot;) {
				var cur = parseInt(parseInt(((200 - (arm._armourFront + arm._armourAft)) / 200) * 100) / 10);
				if ((arm._armourFront &lt; 100 || arm._armourAft &lt; 100) &amp;&amp; cur === 0) cur = 1;
				if (cur &gt; 0) {
					var k1 = k2 + &quot;_REPAIR&quot; + cur
					var q1 = EquipmentInfo.infoForKey(k1);
					list.push({key:k1, price:q1.price, name:q1.name.replace(&quot;Repair:&quot;,&quot;&quot;).trim(), techLevel:(k1.effectiveTechLevel === 0 ? 1 : q1.effectiveTechLevel), repairCost:(q1.price / 10) * 0.5});
					total += (q1.price / 10) * 0.5;
				}
			}
		}
		
		// iron hide damage?
		if (p.equipmentStatus(&quot;EQ_IRONHIDE&quot;) === &quot;EQUIPMENT_OK&quot;) {
			if (missionVariables.ironHide_percentage &lt; 100) {
				var q1 = EquipmentInfo.infoForKey(&quot;EQ_IRONHIDE_REPAIR&quot;);
				list.push({key:q1.equipmentKey, price:q1.price, name:q1.name.replace(&quot;Repair:&quot;,&quot;&quot;).trim(), techLevel:(q1.effectiveTechLevel === 0 ? 1 : q1.effectiveTechLevel), repairCost:&quot;Unknown&quot;});
			}
		}
		
		var col1 = 15;
		var col2 = 9;
		var col3 = 8;

		if (list.length == 0) {
			// no damaged equipment. yay!
			text = &quot;All systems operational&quot;;
			this._maxpage = 0;
			this._curpage = 0;
		} else {
			// some damaged equipment. bummer.
			list.sort(comparePrice);

			// calculate the max number of pages
			this._maxpage = Math.ceil(list.length / this._msRows);

			text = &quot;Note: Estimated costs are dependant on the station where the repairs are carried out. Actual costs may be higher.&quot; + 
				(list.length &gt; 1 ? &quot; (Total estimated costs &quot; + formatCredits(total, false, true) + &quot;)&quot; : &quot;&quot;) + &quot;\n\n&quot;;

			text += this.$padTextRight(&quot;Equipment item&quot;, col1);
			text += this.$padTextLeft(&quot;Est Repair Cost&quot;, col2);
			text += this.$padTextLeft(&quot;Tech Level Req&quot;, col3);

			var items = 0;
			var start = this._curpage * this._msRows;
			var end = (this._curpage * this._msRows) + this._msRows;
			var itemText = &quot;&quot;;
			var repairItem = 0;

			for (var i = 0; i &lt; list.length; i++) {
				items += 1;
				if ((items - 1) &gt;= start &amp;&amp; (items - 1) &lt; end) {
					repairItem += 1;
					itemText = this.$padTextRight(list[i].name, col1) +
								this.$padTextLeft((this.$isNumeric(list[i].repairCost) ? list[i].repairCost.toFixed(2) : list[i].repairCost), col2) +
								this.$padTextLeft(list[i].techLevel, col3);
					curChoices[&quot;01_&quot; + (repairItem &lt; 10 ? &quot;0&quot; : &quot;&quot;) + repairItem + &quot;_REPAIRITEM_&quot; + i + &quot;:&quot; + list[i].key] = {text:itemText, color:&quot;orangeColor&quot;, alignment:&quot;LEFT&quot;};
				}
			}
			for (var i = 0; i &lt; (this._msRows + 1) - repairItem; i++) {
				curChoices[&quot;02_SPACER_&quot; + i.toString()] = &quot;&quot;;
			}

			if (this._curpage &lt; this._maxpage - 1) {
				curChoices[&quot;10_GOTONEXT&quot;] = {text:&quot;[option_nextpage]&quot;, color:&quot;yellowColor&quot;};
			} else {
				curChoices[&quot;10_GOTONEXT&quot;] = {text:&quot;[option_nextpage]&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
			}
			if (this._curpage &gt; 0) {
				curChoices[&quot;11_GOTOPREV&quot;] = {text:&quot;[option_prevpage]&quot;, color:&quot;yellowColor&quot;};
			} else {
				curChoices[&quot;11_GOTOPREV&quot;] = {text:&quot;[option_prevpage]&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
			}
		}

		if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) == &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot;) {
			var mfdType = &quot;DR_TYPE1&quot;;
			if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot;) mfdType = &quot;DR_TYPE2&quot;;

			mfdType += &quot;_MODE&quot; + this._mode;

			curChoices[&quot;80_&quot; + mfdType] = expandDescription(&quot;[&quot; + mfdType + &quot;]&quot;);
		}

		curChoices[&quot;99_EXIT&quot;] = &quot;Exit Damage Report&quot;;

		var opts = {
			screenID: &quot;oolite-damagereport-main-summary&quot;,
			title: &quot;Damage Report&quot; + (this._maxpage &lt;= 1 ? &quot;&quot; : &quot; - Page &quot; + (this._curpage + 1) + &quot; of &quot; + this._maxpage),
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			overlay: {name:&quot;dr-wrench.png&quot;, height:546},
			choices: curChoices,
			initialChoicesKey: this._lastchoice?this._lastchoice:def,
			message: text
		};
	}

	// displays the long range chart with route to nearest fix, plus equipment repair details
	if (this._displayMode == 1) {
		var equip = EquipmentInfo.infoForKey(this._selectedKey);
		var closest = this.$findClosestTechLevel(equip.effectiveTechLevel - 1);
		var rt = system.info.routeToSystem(System.infoForSystem(galaxyNumber, closest.id), (this._routeMode === &quot;SHORTEST&quot; ? &quot;OPTIMIZED_BY_JUMPS&quot; : &quot;OPTIMIZED_BY_TIME&quot;));

		text = &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&quot;; // make sure we don&#39;t overlay the chart
		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) &amp;&amp; rt &amp;&amp; rt.route.length &gt; 1) {
			text += this.$padTextRight(&quot;&quot;, 6.45) + &quot;Jumps: &quot; + (rt.route.length - 1) + &quot;\n&quot;;
		} else {
			text += &quot;\n&quot;;
		}
		text += this.$padTextRight(&quot;Equipment item: &quot;,10) + this.$padTextLeft(equip.name.replace(&quot;Repair:&quot;,&quot;&quot;).trim(), 22) + &quot;\n&quot;;
		if (equip.price &gt; 0) {
			text += this.$padTextRight(&quot;Estimated repair cost: &quot;, 15) + this.$padTextLeft(((equip.price / 10) * 0.5).toFixed(2), 17) + &quot;\n&quot;;
		} else {
			text += this.$padTextRight(&quot;Estimated repair cost: &quot;, 15) + this.$padTextLeft(&quot;Unknown&quot;, 17) + &quot;\n&quot;;
		}
		text += this.$padTextRight(&quot;Tech level required for repair: &quot;, 20) + this.$padTextLeft((equip.effectiveTechLevel == 0 ? 1 : equip.effectiveTechLevel).toString(), 12) + &quot;\n&quot;;

		var bg = &quot;LONG_RANGE_CHART&quot;;

		if (closest != null) {
			if (system.info.distanceToSystem(System.infoForSystem(galaxyNumber, closest.id)) &lt; 7.4) bg = &quot;SHORT_RANGE_CHART&quot;;
			// hold the player&#39;s destination
			this._suspendedDestination = p.targetSystem;

			// override it for the display
			p.targetSystem = closest.id;

			text += this.$padTextRight(&quot;Nearest planet with suitable tech level: &quot;, 17)
				+ this.$padTextLeft(closest.name + &quot; (TL:&quot; + closest.techLevel + &quot;) &quot;
				+ this._ecos[closest.economy] + this._govs[closest.government]
				+ (closest.id === system.ID ? &quot; *Current*&quot; : &quot;&quot;), 15);

			if (bg === &quot;LONG_RANGE_CHART&quot;) {
				if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
					if (this._routeMode == &quot;SHORTEST&quot;) {
						bg = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
						curChoices[&quot;90_SHORTEST&quot;] = {text:&quot;Show shortest route&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
						curChoices[&quot;91_QUICKEST&quot;] = &quot;Show quickest route&quot;;
					} else {
						bg = &quot;LONG_RANGE_CHART_QUICKEST&quot;;
						curChoices[&quot;90_SHORTEST&quot;] = &quot;Show shortest route&quot;;
						curChoices[&quot;91_QUICKEST&quot;] = {text:&quot;Show quickest route&quot;, color:&quot;darkGrayColor&quot;, unselectable:true};
					}
				}
			}
			if (closest.id != system.ID &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
				curChoices[&quot;96_SETCOURSE:&quot; + closest.id] = &quot;Set course for &quot; + closest.name;
			}
		} else {
			text += &quot;\nALERT: No system of required tech level located!\n&quot;;
			if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
				bg = &quot;LONG_RANGE_CHART_SHORTEST&quot;;
			}
			// hold the player&#39;s destination
			this._suspendedDestination = p.targetSystem;
			p.targetSystem = system.ID;
		}

		curChoices[&quot;98_CLOSE&quot;] = &quot;Close&quot;;
		def = &quot;98_CLOSE&quot;;

		var opts = {
			screenID: &quot;oolite-damagereport-detail-map&quot;,
			title: &quot;Damage Report Detail&quot;,
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	mission.runScreen(opts, this.$screenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
// handles UI responses on the damage report screen
this.$screenHandler = function(choice) {

	delete this._lastchoice;
	var newChoice = &quot;&quot;;

	if (this._suspendedDestination) player.ship.targetSystem = this._suspendedDestination;
	this._suspendedDestination = null;

	if (!choice) {
		return; // launched while reading?
	} else if (choice.indexOf(&quot;REPAIRITEM&quot;) &gt;= 0) {
		// get the selected item
		// use the index attached to the end of the choice
		this._selectedKey = choice.substring(choice.indexOf(&quot;:&quot;) + 1);
		this._displayMode = 1;
		this._savedChoice = choice;
	} else if (choice == &quot;11_GOTOPREV&quot;) {
		this._curpage -= 1;
		if (this._curpage == 0) {
			newChoice = &quot;10_GOTONEXT&quot;;
		}
	} else if (choice == &quot;10_GOTONEXT&quot;) {
		this._curpage += 1;
		if (this._curpage == this._maxpage - 1) {
			newChoice = &quot;11_GOTOPREV&quot;;
		}
	} else if (choice.indexOf(&quot;80_&quot;) &gt;= 0) {
		var mfdType = choice.substring(6, 11);
		var mfdMode = parseInt(choice.substring(16));
		mfdMode += 1;
		if (mfdMode == 3) {
			mfdMode = 0;
			if (mfdType == &quot;TYPE1&quot;) {
				mfdType = &quot;TYPE2&quot;;
			} else {
				mfdType = &quot;TYPE1&quot;;
			}
		}
		this.$switchMFDType(mfdType);
		this._mode = mfdMode;
		newChoice = &quot;80_DR_&quot; + mfdType + &quot;_MODE&quot; + mfdMode;
	} else if (choice.indexOf(&quot;96_SETCOURSE&quot;) &gt;= 0) {
		var id = parseInt(choice.substring(choice.indexOf(&quot;:&quot;) + 1));
		player.ship.targetSystem = id;
		player.ship.infoSystem = player.ship.targetSystem;
		// force the Xenon HUD to update it&#39;s destination
		if (worldScripts.XenonHUD) {
			var w = worldScripts.XenonHUD;
			w.guiScreenChanged(&quot;&quot;, &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot;);
		}
		this._displayMode = 0;
	} else if (choice == &quot;90_SHORTEST&quot;) {
		this._routeMode = &quot;SHORTEST&quot;;
	} else if (choice == &quot;91_QUICKEST&quot;) {
		this._routeMode = &quot;QUICKEST&quot;;
	} else if (choice == &quot;98_CLOSE&quot;) {
		this._displayMode = 0;
		this._selectedKey = &quot;&quot;;
		newChoice = this._savedChoice;
		delete this._savedChoice;
	}

	this._lastchoice = choice;
	if (newChoice != &quot;&quot;) {
		this._lastchoice = newChoice;
	}

	if (choice != &quot;99_EXIT&quot;) {
		this.$showDamageReport();
	}

}

//-------------------------------------------------------------------------------------------------------------
// switch between the different types of MFD: TYPE1 = normal, with primable equipment, or TYPE2 = passive, can&#39;t be set during flight.
this.$switchMFDType = function(mfdType) {
	var p = player.ship;
	switch (mfdType) {
		case &quot;TYPE2&quot;:
			if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) != &quot;EQUIPMENT_OK&quot;) return;
			if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) == &quot;EQUIPMENT_OK&quot;) return;
			p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD&quot;);
			p.awardEquipment(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;);
			break;
		case &quot;TYPE1&quot;:
			if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;) != &quot;EQUIPMENT_OK&quot;) return;
			if (p.equipmentStatus(&quot;EQ_DAMAGE_REPORT_MFD&quot;) == &quot;EQUIPMENT_OK&quot;) return;
			p.removeEquipment(&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;);
			p.awardEquipment(&quot;EQ_DAMAGE_REPORT_MFD&quot;);
			break;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function(currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;â€¦&quot;;
	var currentLength = defaultFont.measureString(currentText.toString().replace(/%%/g, &quot;%&quot;));
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1)	{
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp == ellip) break;
		} while (defaultFont.measureString(tmp.replace(/%%/g, &quot;%&quot;)) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch == false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function(currentText, desiredLength) {
	return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
// returns an object containing the id, name, tl, government and distance of the closest system whose TechLevel is greater than or equal to the passed value
this.$findClosestTechLevel = function(requiredTL) {
	var planets = SystemInfo.filteredSystems(this, function(other) {
		return (other.techlevel &gt;= requiredTL);
	});

	var dist = 200;
	var selected = -1;
	var checkDist = 0;

	for (var i = 0; i &lt; planets.length; i++) {
		var chkrt = system.info.routeToSystem(planets[i]);
		if (chkrt) {
			checkDist = chkrt.distance;
		} else {
			checkDist = system.info.distanceToSystem(planets[i]);
		}
		if (checkDist &lt; dist) {
			dist = checkDist;
			selected = planets[i].systemID;
		}
	}

	if (selected != -1) {
		var info = System.infoForSystem(galaxyNumber, selected);
		var rt = system.info.routeToSystem(info);
		if (rt) {
			var dist = rt.distance;
		} else {
			var dist = system.info.distanceToSystem(info);
		}
		return {id:selected, techLevel:(info.techlevel + 1), name:info.name, economy:info.economy, government:info.government, distance:dist};
	} else {
		return null;
	}

}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; 	// until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns true if passed value is numeric, otherwise false
this.$isNumeric = function(n) {
	return !isNaN(parseFloat(n)) &amp;&amp; isFinite(n);
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
