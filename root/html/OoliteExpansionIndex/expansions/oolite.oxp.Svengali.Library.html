<html>
    <head>
        <title>Expansion Library</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Library</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">18 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">21 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER C)(&#39;[]&#39; vs &#39;[config, configuration, effects, helper, library, misc, parent, tools, sanity, shaders]&#39;)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Library is a collection of useful snippets, helpers and resources to simplify some common tasks used by AddOns.</td>
                    <td>Library is a collection of useful snippets, helpers and resources to simplify some common tasks used by AddOns.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Svengali.Library</td>
                    <td>oolite.oxp.Svengali.Library</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Library</td>
                    <td>Library</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Misc</td>
                    <td>Misc</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Svengali &amp; BlackWolf</td>
                    <td>Svengali &amp; BlackWolf</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.7.1</td>
                    <td>1.7.1</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>config, configuration, effects, helper, library, misc, parent, tools, sanity, shaders</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Library">http://wiki.alioth.net/index.php/Library</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/f/f2/Library1.7.1.oxz">https://wiki.alioth.net/img_auth.php/f/f2/Library1.7.1.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-by-nc-sa 4.0, partly MIT</td>
                    <td>CC-by-nc-sa 4.0, partly MIT</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873512</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Library'>http://wiki.alioth.net/index.php/Library</a></p>
        <h3>Readme.txt</h3>
        <pre>Library 1.7.1 for Oolite, Revision: 68
Copyright 2016-2018 by Svengali &amp; BlackWolf.
Licences: see below
November 2018

REQUIREMENTS:
- Oolite v1.88

DOCUMENTATION:
- http://wiki.alioth.net/index.php/Library


PROBLEMS:
In case of problems, please report it: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=18074

Please include the following infos:
- Oolites version (and if trunk or nightly is used the revision number)
- OS, Graphics card (and driver version)
- Fullscreen/Windowed mode
- Shader mode
- List of used OXPs (incl. versions)

Licences:
Creative Commons Attribution-NonCommercial-ShareAlike 4.0 Unported License.
To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or
 send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.

The avatar pics and most of the character pics have been created by BlackWolf!

Many thanks to:
Ahruman, Cody, Commander McLane, Dr.J R Stockton, Eric Walch, Getafix, Michael Werle, Lonewolf, Nicholas Zakas, Nikos Barkas, Norbert Nagy, Paul Bourke, phkb, Smivs and Terry Yuen.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms.html">lib_ms</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_cube_a.html">lib_ms_cube_a</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_cubes.html">lib_ms_cubes</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_exhaust.html">lib_ms_exhaust</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper.html">lib_ms_helper</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper12.html">lib_ms_helper12</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper12x.html">lib_ms_helper12x</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper3x.html">lib_ms_helper3x</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper3y.html">lib_ms_helper3y</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper4y.html">lib_ms_helper4y</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper6x.html">lib_ms_helper6x</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper6y.html">lib_ms_helper6y</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_helper_cut.html">lib_ms_helper_cut</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_laser.html">lib_ms_laser</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_laserDist.html">lib_ms_laserDist</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_moon.html">lib_ms_moon</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_ms_ov.html">lib_ms_ov</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/lib_test.html">Boa</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_2DCollision.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_2DCollision&quot;;

/** _inBox() - Checks if point is inside the bounding box
	@box - Array. 4 positions in a.x,a.y,b.x,b.y
	@pos - Vector. Position to be checked
	@return - Boolean. True if inside
*/
this._inBox = function(box,pos){
	if(pos.x&lt;box[0] || pos.x&gt;box[1] || pos.y&lt;box[2] || pos.y&gt;box[3]) return false;
	return true;
};

/** _inPoly() - Checks if a point is inside a polygon
	@nvert - Number of vertices in the polygon
	@vertx, verty - Arrays containing the x- and y-coordinates of the polygon&#39;s vertices
	@pos - Vector. x- and y-coordinate of the test point
	@con - Boolean. Concave shapes may need to set it
	@return - Boolean. True if inside
*/
this._inPoly = function(nvert,vertx,verty,pos,con){
	var i,j,c = false,r1=0;
	for(i=0,j=nvert-1;i&lt;nvert;j=i++){
		if(((verty[i]&gt;pos.y)!==(verty[j]&gt;pos.y)) &amp;&amp; (pos.x&lt;(vertx[j]-vertx[i])*(pos.y-verty[i])/(verty[j]-verty[i])+vertx[i])){
			c = !c;
			r1++;
		}
		if(!con &amp;&amp; r1&gt;1) break;
	}
	return c;
};

/** _onLine() - Checks if point is on a specified line
	@pa - Vector. Starting point of the line
	@pb - Vector. End point of the line
	@pc - Vector. Position to be checked
	@tol - Number. Tolerance. Default 0.01
	@return - Boolean. True if on line (within tolerance)
*/
this._onLine = function(pa,pb,pc,tol){
	var s,rnum,denom,check,distLine,distSegment,dist1,dist2;
	if(typeof(tol)!==&#39;number&#39;) tol = 0.01;
	rnum = (pc.x-pa.x)*(pb.x-pa.x)+(pc.y-pa.y)*(pb.y-pa.y);
	denom = (pb.x-pa.x)*(pb.x-pa.x)+(pb.y-pa.y)*(pb.y-pa.y);
	check = rnum/denom;
	s = ((pa.y-pc.y)*(pb.x-pa.x)-(pa.x-pc.x)*(pb.y-pa.y))/denom;
	distLine = Math.abs(s)*Math.sqrt(denom);
	if(check&gt;=0 &amp;&amp; check&lt;=1) distSegment = distLine;
	else {
		dist1 = (pc.x-pa.x)*(pc.x-pa.x)+(pc.y-pa.y)*(pc.y-pa.y);
		dist2 = (pc.x-pb.x)*(pc.x-pb.x)+(pc.y-pb.y)*(pc.y-pb.y);
		if(dist1&lt;dist2) distSegment = Math.sqrt(dist1);
		else distSegment = Math.sqrt(dist2);
	}
	return (distSegment&lt;tol);
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Animator.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global _Animator,Sound,SoundSource,Timer,Vector3D,addFrameCallback,clock,isValidFrameCallback,mission,player,removeFrameCallback,setScreenBackground,setScreenOverlay,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Animator&quot;;
/** 
* TODO:
* 	Flags - append
*	Fixme - modifyMaterials
*/
this._start = function(ani){
	if(!player.ship.docked || !ani || !ani.model || !ani.flow || (this._a &amp;&amp; !ani.replace &amp;&amp; !ani.capture)) return false;
	if((this._a &amp;&amp; (!ani.replace || !ani.capture) ) &amp;&amp; (!mission.displayModel || mission.displayModel.dataKey!==ani.model)) return false;
	var obj = worldScripts.Lib_Main._lib.objClone(ani),hud,hudHide,i,msc;
	if(this._a &amp;&amp; (obj.replace || obj.capture)){
		this._a.reset();
		if(this.$anim){
			hud = this.$anim.prevHUD;
			hudHide = this.$anim.prevHUDHide;
		}
		this._cleanUp(1);
	}
	this._a = new this._Animator();
	if(!obj.capture){
		msc = {
			background: null,
			choices: (obj.choices?obj.choices:null),
			choicesKey: (obj.choicesKey?obj.choicesKey:null),
			model: (obj.model?obj.model:null),
			music: (obj.music?obj.music:null),
			overlay: null,
			screenID: (obj.screenID?obj.screenID:&quot;Lib_Animator&quot;),
			spinModel: false,
			title: (obj.title?obj.title:&quot;&quot;)
		};
		if(obj.text) msc.message = obj.text;
		if(obj.background){
			msc.background = obj.background;
			this._a.bg.name = obj.background;
		}
		if(obj.overlay){
			msc.overlay = obj.overlay;
			this._a.ov.name = obj.overlay;
		}
		if(obj.fadeIn) msc.overlay = {name:&quot;lib_blend10.png&quot;,width:1024,height:512};
	}
	this.$anim = {
		count: 0,
		index: 0,
		flow: obj.flow,
		caller: (obj.caller?obj.caller:null),
		callback: (obj.callback?obj.callback:null),
		checkpoint: (obj.checkpoint?obj.checkpoint:null),
		prevHUD: (hud?hud:player.ship.hud),
		prevHUDHide: (typeof hudHide!==&quot;undefined&quot;?hudHide:player.ship.hudHidden),
		custom: obj.custom,
		capture: obj.capture?obj.capture:null,
		md: obj.model
	};
	if(!obj.capture){
		if(obj.hud){
			player.ship.hud = obj.hud;
			player.ship.hudHidden = false;
		} else player.ship.hudHidden = true;
		mission.runScreen(msc,this._choiceEval);
	}
	if(!mission.displayModel) return false;
	this._a.init(mission.displayModel);
	this.$waitUntil = -1;
	if(obj.corner) this._a.screenCornerPos(obj.corner);
	if(obj.aPos) for(i=0;i&lt;obj.aPos.length;i++) this._a.setPosition(obj.aPos[i]);
	if(obj.aExh) for(i=0;i&lt;obj.aExh.length;i++) this._a.setExhaust(obj.aExh[i]);
	if(obj.aOris) for(i=0;i&lt;obj.aOris.length;i++) this._a.setOrientation(obj.aOris[i]);
	if(obj.aBinds) for(i=0;i&lt;obj.aBinds.length;i++) this._a.setBinding(obj.aBinds[i]);
	if(obj.aProps) for(i=0;i&lt;obj.aProps.length;i++) this._a.setProp(obj.aProps[i]);
	if(obj.bPos) for(i=0;i&lt;obj.bPos.length;i++) this._a.setPosition(obj.bPos[i]);
	if(obj.bOris) for(i=0;i&lt;obj.bOris.length;i++) this._a.setOrientation(obj.bOris[i]);
	if(obj.bBinds) for(i=0;i&lt;obj.bBinds.length;i++) this._a.setBinding(obj.bBinds[i]);
	if(obj.bProps) for(i=0;i&lt;obj.bProps.length;i++) this._a.setProp(obj.bProps[i]);
	if(obj.shadeMaps) for(i=0;i&lt;obj.shadeMaps.length;i++) this._a.setShaderProp(obj.shadeMaps[i]);
	if(obj.pilots) for(i=0;i&lt;obj.pilots.length;i++) this._a._setPilot(obj.pilots[i]);
	if(obj.subRots) for(i=0;i&lt;obj.subRots.length;i++) this._a.subs[obj.subRots[i].e].subEntityRotation = obj.subRots[i].r;
	if(obj.subTex) for(i=0;i&lt;obj.subTex.length;i++) this._a.setMaterials(obj.subTex[i]);
	this.$sndA = new SoundSource();
	this.$sndB = new SoundSource();
	if(obj.delta) this._a.defDelta = obj.delta;
	else this._a.defDelta = 0.005;
	if(!this.$animTimer) this.$animTimer = new Timer(this,this._doAnimTimer,0,0.25);
	else this.$animTimer.start();
	return true;
};
this._cleanUp = function(all){
	if(this.$animTimer) this.$animTimer.stop();
	delete this.$animTimer;
	if(all){
		delete this.$anim;
		delete this.$sndA;
		delete this.$sndB;
		delete this._a;
	}
};
this._choiceEval = function(choice){worldScripts.Lib_Animator._choice(choice); return;};
this._choice = function(choice){
	this._a.reset();
	player.ship.hud = this.$anim.prevHUD;
	player.ship.hudHidden = this.$anim.prevHUDHide;
	var a = this.$anim.caller, b = this.$anim.callback;
	this._cleanUp(1);
	if(a &amp;&amp; b) worldScripts[a][b](choice);
	return;
};
this._doAnimTimer = function(){
	if(!this.$anim.flow.length || !mission.displayModel || !mission.displayModel.isValid || this.$anim.index&gt;=this.$anim.flow.length){
		this._a.reset();
		this._cleanUp();
		return;
	}
	var cur = this.$anim.flow[this.$anim.index],i,p;
	if(this.$anim.count &gt;= cur[0]){
		// [time,cmd,obj,other]
		switch(cur[1]){
			case &quot;reset&quot;: this._a.reset(); break;
			case &quot;clr&quot;: this._a.clear(); break;
			case &quot;clrMov&quot;: this._a.clearMoves(); break;
			case &quot;kill&quot;: // Get CPU usage down
				if(this.$anim.index===this.$anim.flow.length-1){
					mission.displayModel.remove();
					if(cur[2] &amp;&amp; cur[2].txt) mission.addMessageText(cur[2].txt);
				}
				break;
			case &quot;rotw&quot;: this._a.rotateW(cur[2]); break;
			case &quot;rot&quot;: this._a.rotate(cur[2]); break;
			case &quot;rotTo&quot;: this._a.rotateTo(cur[2]); break;
			case &quot;rotX&quot;: this._a.rotateXDeg(cur[2]); break;
			case &quot;rotY&quot;: this._a.rotateYDeg(cur[2]); break;
			case &quot;rotZ&quot;: this._a.rotateZDeg(cur[2]); break;
			case &quot;stopRot&quot;: this._a.stopRotate(cur[2]); break;
			case &quot;fly&quot;: this._a.flight(cur[2]); break;
			case &quot;flyTo&quot;: this._a.flightTo(cur[2]); break;
			case &quot;stopFly&quot;: this._a.stopFlight(cur[2]); break;
			case &quot;velo&quot;: this._a.velocity(cur[2]); break;
			case &quot;veloTo&quot;: this._a.velocityTo(cur[2]); break;
			case &quot;veloSet&quot;: this._a.setVelocity(cur[2]); break;
			case &quot;stopVelo&quot;: this._a.stopVelocity(cur[2]); break;
			case &quot;walk&quot;: this._a.walk(cur[2]); break;
			case &quot;walkTo&quot;: this._a.walkTo(cur[2]); break;
			case &quot;stopWalk&quot;: this._a.stopWalk(cur[2]); break;
			case &quot;aiDest&quot;: this._a.aiDestination(cur[2]); break;
			case &quot;aiFace&quot;: this._a.aiFace(cur[2]); break;
			case &quot;aiFly&quot;: this._a.aiFly(cur[2]); break;
			case &quot;aiHold&quot;: this._a.aiHold(cur[2]); break;
			case &quot;aiRange&quot;: this._a.aiRange(cur[2]); break;
			case &quot;aiSpeed&quot;: this._a.aiSpeed(cur[2]); break;
			case &quot;aiStop&quot;: this._a.aiStop(cur[2]); break;
			case &quot;zoom&quot;: this._a.zoom(cur[2]); break;
			case &quot;zoomTo&quot;: this._a.zoomTo(cur[2]); break;
			case &quot;stopZoom&quot;: this._a.stopZoom(cur[2]); break;
			case &quot;prop&quot;: this._a.setProp(cur[2]); break;
			case &quot;matSet&quot;: this._a.setMaterials(cur[2]); break;
			case &quot;matMod&quot;: this._a.modifyMaterials(cur[2]); break;
			case &quot;lit&quot;: this._a.highlight(cur[2]); break;
			case &quot;tex&quot;: this._a.setTextures(cur[2]); break;
			case &quot;shadeSet&quot;: this._a.setShader(cur[2]); break;
			case &quot;shadeMod&quot;: this._a.setShaderProp(cur[2]); break;
			case &quot;sun&quot;: this._a.sun(cur[2]); break;
			case &quot;twinkle&quot;: this._a.twinkle(cur[2]); break;
			case &quot;moon&quot;: this._a.moon(cur[2]); break;
			case &quot;boom&quot;: this._a.explosion(cur[2]); break;
			case &quot;hyper&quot;:
				this._a.hyper(cur[2]);
				this.$sndB.playSound(&quot;[bgs_fxWitch]&quot;);
				break;
			case &quot;shoot&quot;:
				var d = [0.00001,clock.absoluteSeconds,0];
				//if(cur[2].rear) d[2] = cur[2].rear;
				if(this._a.cur[cur[2].tg].ang&gt;0.098){
					this.$sndA.playSound(&quot;[player-laser-miss]&quot;);
				} else {
					d[0] = 1/this._a.cur[cur[2].tg].mag;
					this.$sndA.playSound(&quot;[player-laser-hit]&quot;);
				}
				this._a.setProp({e:cur[2].e,p:&quot;destination&quot;,v:d});
				break;
			case &quot;laser&quot;:
				var act, tg, mag, ang, v;
				var d = [0.00001,clock.absoluteSeconds,0];
				if(cur[2].e&gt;-1) act = this._a.subs[cur[2].e];
				else act = this._a.ent;
				if(cur[2].tg&gt;-1) tg = this._a.subs[cur[2].tg];
				else tg = this._a.ent;
				v = act.position.subtract(tg.position).direction().multiply(-1);
				mag = act.position.subtract(tg.position).magnitude();
				ang = act.heading.angleTo(v);
				if(ang&gt;0.098){
					this.$sndA.playSound(&quot;[player-laser-miss]&quot;);
				} else {
					d[0] = 1/mag;
					this.$sndA.playSound(&quot;[player-laser-hit]&quot;);
				}
				this._a.setProp({e:cur[2].e,p:&quot;destination&quot;,v:d});
				break;
			case &quot;bind&quot;: this._a.setBinding(cur[2]); break;
			case &quot;stopBind&quot;: this._a.stopBinding(cur[2]); break;
			case &quot;pos&quot;: this._a.setPosition(cur[2]); break;
			case &quot;posTo&quot;: this._a.setPositionTo(cur[2]); break;
			case &quot;posFl&quot;: this._a.setFlasherPositionTo(cur[2]); break;
			case &quot;ori&quot;: this._a.setOrientation(cur[2]); break;
			case &quot;snap&quot;: this._a.snapIn(cur[2]); break;
			case &quot;bg&quot;: this._a.setBackground(cur[2]); break;
			case &quot;bgZoom&quot;: this._a.zoomBackground(cur[2]); break;
			case &quot;bgZoomTo&quot;: this._a.zoomBackgroundTo(cur[2]); break;
			case &quot;bgStop&quot;: this._a.stopBackground(); break;
			case &quot;bgClr&quot;: this._a.clearBackground(); break;
			case &quot;bgRes&quot;: this._a.resetBackground(cur[2]); break;
			case &quot;ov&quot;: this._a.setOverlay(cur[2]); break;
			case &quot;ovZoom&quot;: this._a.zoomOverlay(cur[2]); break;
			case &quot;ovStop&quot;: this._a.stopOverlay(); break;
			case &quot;ovClr&quot;: this._a.clearOverlay(); break;
			case &quot;ovFadeIn&quot;: this._a.fadeIn(cur[2]); break;
			case &quot;ovFadeOut&quot;: this._a.fadeOut(cur[2]); break;
			case &quot;corner&quot;: this._a.screenCornerPos(cur[2]); break;
			case &quot;txt&quot;: mission.addMessageText(cur[2]); break;
			case &quot;snd1&quot;: this.$sndA.playSound(cur[2].snd); break;
			case &quot;snd2&quot;: this.$sndB.playSound(cur[2].snd); break;
			case &quot;mus&quot;: Sound.playMusic(cur[2].snd); break;
			case &quot;custom&quot;: this.$anim.custom[cur[2]](); break;
			case &quot;goto&quot;: this._goto(cur[2]); break;
			case &quot;check&quot;:
				var ch = false;
				if(this.$anim.caller &amp;&amp; this.$anim.checkpoint) ch = worldScripts[this.$anim.caller][this.$anim.checkpoint](cur[0]);
				if(typeof ch===&#39;number&#39;) this._goto(ch);
				else {
					if(!ch){this._a.reset(); this._cleanUp();}
				}
				break;
			case &quot;waitExt&quot;:
				if(this.$waitUntil&gt;-1){
					this._goto(this.$waitUntil);
					this.$waitUntil = -1;
				} else {
					this.$anim.index--;
					this.$anim.count--;
				}
				break;
			case &quot;speak&quot;:
				this._a._pilotSpeak(cur[2]);
				if(cur[2].snd) this.$sndB.playSound(cur[2].snd);
				break;
		}
		if(cur[3]){
			for(i=0;i&lt;cur[3].length;i++){
				p = cur[3][i];
				switch(p.id){
					case &quot;txt&quot;: mission.addMessageText(p.txt); break;
					case &quot;snd1&quot;: this.$sndA.playSound(p.snd); break;
					case &quot;snd2&quot;: this.$sndB.playSound(p.snd); break;
					case &quot;mus&quot;: Sound.playMusic(p.snd); break;
				}
			}
		}
		this.$anim.index++;
	}
	this.$anim.count++;
	return;
};
this._goto = function(cmp){
	var from,to;
	if(cmp&gt;this.$anim.count){
		from = this.$anim.index;
		to = this.$anim.flow.length;
	} else {
		from = 0;
		to = this.$anim.index;
	}
	for(var i=from;i&lt;to;i++){
		if(this.$anim.flow[i][0]===cmp){
			this.$anim.index = i-1;
			this.$anim.count = cmp-1;
			break;
		}
	}
};
/** Animation API
*/
this._Animator = function(){};
_Animator.prototype = {
	constructor: _Animator,
	w: 1024,
	h: 512,
	fcb: 0,
	fcbs: [],
	bg: {name:null,width:this.w,height:this.h,mw:1,mh:1},
	ov: {name:null,width:this.w,height:this.h,mw:1,mh:1},
	ovFade: {n:10,dir:1,t:2,cur:0},
	defDelta: 0.005,
	ent: null,
	subs: null,
	flow: {
		bind:{},
		flight:{},
		props:{},
		rotate:{},
		velocity:{},
		walk:{},
		zoom:{},
		bg:{},
		ov:{},
		aiDest:{}
	},
	cur: {},
	/** ent = Entity. Must be called before anything else!
	*/
	init: function(ent){
		this.cur = {&quot;-1&quot;:{mf:0,ang:0,mag:0,tOri:null}};
		this.ent = ent;
		if(ent.subEntities &amp;&amp; ent.subEntities.length){
			this.subs = ent.subEntities;
			for(var i=0;i&lt;ent.subEntities.length;i++) this.cur[i] = {mf:0,ang:0,mag:0,tOri:null};
		}
		else this.subs = null;
		this.w = 1024;
		this.h = 512;
		this.bg.width = this.w;
		this.bg.height = this.h;
		this.ov.width = this.w;
		this.ov.height = this.h;
	},
	reset: function(){
		this.clear();
		this.bg = {name:null,width:this.w,height:this.h,mw:1,mh:1};
		this.ov = {name:null,width:this.w,height:this.h,mw:1,mh:1};
		this.ovFade = {n:10,dir:1,t:2,cur:0};
		this.ent = null;
		this.subs = null;
		this.defDelta = 0.005;
	},
	clear: function(){
		this._removeFCBs();
		this.flow = {
			bind:{},
			flight:{},
			props:{},
			rotate:{},
			velocity:{},
			walk:{},
			zoom:{},
			bg:{},
			ov:{},
			aiDest:{}
		};
	},
	clearMoves: function(){
		var m = [&quot;flight&quot;,&quot;rotate&quot;,&quot;velocity&quot;,&quot;walk&quot;,&quot;zoom&quot;,&quot;aiDest&quot;],k;
		for(var o=0;o&lt;m.length;o++){
			k = Object.keys(this.flow[m[o]]);
			for(var i=0;i&lt;k.length;i++){
				this._stopIt({e:k[i]},m[o]);
			}
		}
	},
	/** e, t, rx,ry,rz [, z, da, db]		World!
	*/
	rotateW: function(obj){
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].rx) act.orientation = act.orientation.rotateX(c[4].rx*da*db*bz*f);
			if(c[4].ry) act.orientation = act.orientation.rotateY(c[4].ry*da*db*bz*f);
			if(c[4].rz) act.orientation = act.orientation.rotateZ(c[4].rz*da*db*bz*f);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, rx,ry,rz [, z, da, db]		Model!
	*/
	rotate: function(obj){
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].rx) act.orientation = act.orientation.rotate(act.vectorRight,c[4].rx*da*db*bz*f);
			if(c[4].ry) act.orientation = act.orientation.rotate(act.vectorUp,c[4].ry*da*db*bz*f);
			if(c[4].rz) act.orientation = act.orientation.rotate(act.vectorForward,c[4].rz*da*db*bz*f);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, tg [, z, da, db, s]
	*/
	rotateTo: function(obj){
		this._stopIt(obj,&quot;rotate&quot;);
		if(!obj.tg.isShip){
			if(typeof obj.tg===&#39;number&#39;) obj.tg = this.subs[obj.tg];
			else if(obj.tg.constructor.name===&quot;Array&quot;) obj.tgv = new Vector3D(obj.tg);
		}
		var c = [this.ent,this.subs,0,this.defDelta,obj,this.cur[obj.e]];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid || !c[4].tg || (!c[4].tg.isValid &amp;&amp; !c[4].tgv)) return;
			var f=1, bz=1, da=1, db=1, act, v, a, cr, steps = 0.01;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].tgv){
				v = act.position.subtract(c[4].tgv).direction().multiply(-1);
				c[5].mag = act.position.subtract(c[4].tgv).magnitude();
			} else {
				v = act.position.subtract(c[4].tg.position).direction().multiply(-1);
				c[5].mag = act.position.subtract(c[4].tg.position).magnitude();
			}
			a = act.heading.angleTo(v);
			c[5].ang = a;
			if(c[4].z) bz = 1-1/Math.sqrt(Math.max(Math.abs(act.position.z),0.001));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].s) steps = c[4].s*da;
			cr = act.heading.cross(v);
			act.orientation = act.orientation.rotate(cr,-a*steps*f*bz*da*db);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, deg [, z, da, db, inf]		World!
	*/
	rotateXDeg: function(obj){
		if(obj.e&gt;-1) obj.nt = this.subs[obj.e].orientation.rotateX(0.017453293916206696*obj.deg);
		else obj.nt = this.ent.orientation.rotateX(0.017453293916206696*obj.deg);
		if(obj.inf) this.cur[obj.e].tOri = obj.nt;
		obj.st = obj.deg/(obj.t*1000);
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act, sp;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			sp = act.orientation.dot(c[4].nt);
			if(sp&gt;0.999) return;
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].deg) act.orientation = act.orientation.rotateX(c[4].st*da*db*bz*f);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, deg [, z, da, db, inf]		World!
	*/
	rotateYDeg: function(obj){
		if(obj.e&gt;-1) obj.nt = this.subs[obj.e].orientation.rotateY(0.017453293916206696*obj.deg);
		else obj.nt = this.ent.orientation.rotateY(0.017453293916206696*obj.deg);
		if(obj.inf) this.cur[obj.e].tOri = obj.nt;
		obj.st = obj.deg/(obj.t*1000);
//		obj.st = ((0.017453293916206696*obj.deg)/obj.t)*this.defDelta;
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act, sp;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			sp = act.orientation.dot(c[4].nt);
			if(sp&gt;0.9999) return;
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].deg) act.orientation = act.orientation.rotateY(c[4].st*da*db*bz*f);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, deg [, z, da, db, inf]		World!
	*/
	rotateZDeg: function(obj){
		if(obj.e&gt;-1) obj.nt = this.subs[obj.e].orientation.rotateZ(0.017453293916206696*obj.deg);
		else obj.nt = this.ent.orientation.rotateZ(0.017453293916206696*obj.deg);
		if(obj.inf) this.cur[obj.e].tOri = obj.nt;
		obj.st = obj.deg/(obj.t*1000);
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act, sp;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			sp = act.orientation.dot(c[4].nt);
			if(sp&gt;0.999) return;
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].deg) act.orientation = act.orientation.rotateZ(c[4].st*da*db*bz*f);
			return;
		});
		this._addTo(&quot;rotate&quot;,this.fcb,obj);
		return true;
	},
	/** e
	*/
	stopRotate: function(obj){
		this._stopIt(obj,&quot;rotate&quot;);
		return true;
	},
	/** e, t, mu,mr,mf, rx,ry,rz [,da, db, z, fu, en]
	*/
	flight: function(obj){
		this.rotate(obj);
		this.velocity(obj);
	},
	/** e, t, tg, s, mu,mr,mf [, da, db, z, fu, en]
	*/
	flightTo: function(obj){
		this.rotateTo(obj);
		this.velocityTo(obj);
	},
	/** e
	*/
	stopFlight: function(obj){
		this.stopVelocity(obj);
		this.stopRotate(obj);
		return true;
	},
	aiDestination: function(obj){
		var act;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		this._stopIt(obj,&quot;aiDest&quot;);
		if(obj.dest){
			if(typeof obj.dest===&#39;number&#39;) act.destination = this.subs[obj.dest];
			else act.destination = obj.dest;
		} else {
			var c = [this.ent,this.subs,0,this.defDelta,obj,0];
			this.fcb = addFrameCallback(function(delta){
				if(!delta || !c[0] || !c[0].isValid) return;
				var act, st;
				c[2] += delta;
				c[5]++;
				// Updating only every 50. framecallback!!!
				if(c[2]&gt;=c[4].t || c[5]&lt;50) return;
				if(c[4].e&gt;-1) act = c[1][c[4].e];
				else act = c[0];
				act.destination = c[1][c[4].tg].position;
				c[5] = 0;
				return;
			});
			this._addTo(&quot;aiDest&quot;,this.fcb,obj);
		}
	},
	aiFace: function(obj){
		this.aiDestination(obj);
		if(obj.e&gt;-1) this.subs[obj.e].performFaceDestination();
		else this.ent.performFaceDestination();
	},
	aiFly: function(obj){
		this.aiSpeed(obj);
		this.aiRange(obj);
		this.aiDestination(obj);
		var act;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.performFlyToRangeFromDestination();
	},
	aiHold: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].performHold();
		else this.ent.performHold();
		this._stopIt(obj,&quot;aiDest&quot;);
	},
	aiRange: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].desiredRange = obj.rng;
		else this.ent.desiredRange = obj.rng;
	},
	aiSpeed: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].desiredSpeed = obj.spd;
		else this.ent.desiredSpeed = obj.spd;
	},
	aiStop: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].performStop();
		else this.ent.performStop();
		this._stopIt(obj,&quot;aiDest&quot;);
	},
	/** e, t, mu,mr,mf [,da, db, z, fu, en]
	*/
	velocity: function(obj){
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].mu) act.velocity = act.vectorUp.multiply(c[4].mu*bz*da*db*f);
			if(c[4].mr) act.velocity = act.vectorRight.multiply(c[4].mr*bz*da*db*f);
			if(c[4].mf) act.velocity = act.vectorForward.multiply(c[4].mf*bz*da*db*f);
			if(c[4].fu) act.fuel = (act.velocity.magnitude()/act.maxSpeed)*7;
			if(c[4].en) act.energy = (act.velocity.magnitude()/act.maxSpeed)*act.maxEnergy;
			return;
		});
		this._addTo(&quot;velocity&quot;,this.fcb,obj);
		return true;
	},
	/** e, t, tg, mu,mr,mf [, da, db, z, fu, en]
	*/
	velocityTo: function(obj){
		this._stopIt(obj,&quot;velocity&quot;);
		var x;
		if(!obj.tg.isShip){
			if(typeof obj.tg===&#39;number&#39;) obj.tg = this.subs[obj.tg];
			else if(obj.tg.constructor.name===&quot;Array&quot;) obj.tgv = new Vector3D(obj.tg);
		} else if(obj.tg.isInSpace) obj.tgv = obj.tg.position;
		if(obj.e&gt;-1) x = this.subs[obj.e].velocity.magnitude();
		else x = this.ent.velocity.magnitude();
		if(x&gt;1) obj.da = obj.da/x;
		var c = [this.ent,this.subs,0,this.defDelta,obj,this.cur[obj.e],0];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid || c[6]) return;
			var f=1, bz=1, da=1, db=1, act, col, v, dist, mul,slow, check;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			col = act.collisionRadius;
			if(c[4].tgv) v = c[4].tgv;
			else v = c[4].tg;
			if(c[4].tg.isInSpace) col += c[4].tg.collisionRadius;
			dist = act.position.distanceTo(v);
			if(dist&lt;col*4){
				f *= 1/(col*4/dist);
				slow = 1;
			}
			if(dist&lt;col){
				if(!c[6]){
					act.velocity = [0,0,0];
					c[6] = 1;
					if(c[4].fu) act.fuel = 0;
					if(c[4].en) act.energy = 0;
					c[5].mf = 0;
				}
				return;
			}
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			mul = bz*da*db*f;
			if(c[4].mu) act.velocity = act.vectorUp.multiply(c[4].mu*mul);
			if(c[4].mr) act.velocity = act.vectorRight.multiply(c[4].mr*mul);
			if(c[4].mf){
				check = c[4].mf*mul;
				if(!slow &amp;&amp; c[5].mf&gt;check) check = c[5].mf;
				act.velocity = act.vectorForward.multiply(check);
				c[5].mf = check;
			}
			if(c[4].fu) act.fuel = (act.velocity.magnitude()/act.maxSpeed)*7;
			if(c[4].en) act.energy = (act.velocity.magnitude()/act.maxSpeed)*act.maxEnergy;
			return;
		});
		this._addTo(&quot;velocity&quot;,this.fcb,obj);
		return true;
	},
	/** e, velo
	*/
	setVelocity: function(obj){
		this._stopIt(obj,&quot;velocity&quot;);
		if(obj.e&gt;-1) this.ent.subEntities[obj.e].velocity = obj.velo;
		else this.ent.velocity = obj.velo;
		return true;
	},
	/** e
	*/
	stopVelocity: function(obj){
		this._stopIt(obj,&quot;velocity&quot;);
		if(obj.e&gt;-1) this.ent.subEntities[obj.e].velocity = [0,0,0];
		else this.ent.velocity = [0,0,0];
		return true;
	},
	/** e, t, st [,z, da, db]
	*/
	walk: function(obj){
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act, up,rol, mul, steps;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			steps = Math.floor(c[2]);
			if(c[2]&gt;=c[4].t || steps&gt;=c[4].st) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			mul = Math.PI*bz*da*db*f;
			rol = Math.cos(c[2]*mul);
			up = Math.cos(c[2]*3*mul);
			act.position = act.position.subtract([rol*0.05,up*0.15,mul*0.15]);
			return;
		});
		this._addTo(&quot;walk&quot;,this.fcb,obj);
		return true;
	},
	walkTo: function(){},
	/** e
	*/
	stopWalk: function(obj){
		this._stopIt(obj,&quot;walk&quot;);
		return true;
	},
	/** e, t, mz [, z, da, db]
	*/
	zoom: function(obj){
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, bz=1, da=1, db=1, act, mf=1;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].z) bz = Math.sqrt(Math.abs(act.position.z));
			if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
			if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
			if(c[4].mz&gt;1) mf = 1+(da*db*bz*(c[4].mz%1));
			else mf = 1-(f*da*db*bz*(1%c[4].mz));
			act.position = act.position.multiply(mf);
			return;
		});
		this._addTo(&quot;zoom&quot;,this.fcb,obj);
		return true;
	},
	zoomTo: function(){},
	/** e
	*/
	stopZoom: function(obj){
		this._stopIt(obj,&quot;zoom&quot;);
		return true;
	},
	/** e, p, v [, t, da, db]
	*/
	setProp: function(obj){
		if(!obj.t){
			if(obj.e&gt;-1) this.subs[obj.e][obj.p] = obj.v;
			else this.ent[obj.p] = obj.v;
		} else {
			var c = [this.ent,this.subs,0,this.defDelta,obj];
			this.fcb = addFrameCallback(function(delta){
				if(!delta || !c[0] || !c[0].isValid) return;
				var f=1, da=1, db=1, act;
				if(c[3]&gt;delta) f = 1/(c[3]/delta);
				else f = 1-(c[3]-delta);
				c[2] += delta;
				if(c[2]&gt;=c[4].t) return;
				if(c[4].e&gt;-1) act = c[1][c[4].e];
				else act = c[0];
				if(c[4].da &amp;&amp; c[2]&lt;c[4].da) da = 1-((c[4].da-c[2])/c[4].da);
				if(c[4].db &amp;&amp; c[2]&gt;c[4].t-c[4].db) db = (c[4].t-c[2])/c[4].db;
				if(typeof act[c[4].p]===&#39;number&#39;) act[c[4].p] += c[4].v*f*da*db/c[4].t;
				else act[c[4].p] = act[c[4].p].multiply(c[4].v*f*da*db/c[4].t); // TODO check
				return;
			});
			this._addTo(&quot;props&quot;,this.fcb,obj);
		}
		return true;
	},
	/** e, mat, sha
	*/
	setMaterials: function(obj){
		var act;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		if(obj.mat &amp;&amp; obj.sha) act.setMaterials(obj.mat,obj.sha);
		else if(obj.mat) act.setMaterials(obj.mat,{});
		else if(obj.sha) act.setMaterials({},obj.sha);
		return true;
	},
	/** e, prop
	* i, p, v
	*/
	modifyMaterials: function(obj,prop){
		var m = this._getMaterials(obj),k = Object.keys(m),w;
		if(!k.length) return;
		for(var o=0;o&lt;obj.prop.length;o++){
			w = obj.prop[o];
			m[k[w.i]][w.p] = w.v;
		}
		this._setMaterials(obj,m);
	},
	/** e, mat, tex, col
	*/
	highlight: function(obj){
		var act,m;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		m = act.getMaterials();
		m[obj.mat].emission_map = obj.tex;
		m[obj.mat].emission_modulate_color = obj.col;
		act.setMaterials(m);
	},
	setTextures: function(obj){},
	/** e, sha [, rep]
	*/
	setShader: function(obj){
		if(obj.rep){
			var k = Object.keys(obj.sha),w,h,v;
			for(var o=0;o&lt;k.length;o++){
				w = obj.sha[k[o]].uniforms;
				h = Object.keys(w);
				for(var i=0;i&lt;h.length;i++){
					v = obj.sha[k[o]].uniforms[h[i]];
					if(v.value===&quot;p1&quot;) v.value = clock.absoluteSeconds-1;
				}
			}
		}
		if(obj.e&gt;-1) this.subs[obj.e].setShaders(obj.sha);
		else this.ent.setShaders(obj.sha);
		return true;
	},
	/** e, tex (Array), uni (Array), val (Array)
	*/
	setShaderProp: function(obj){
		var a,b,flagM,i;
		a = this._getShaders(obj);
		b = Object.keys(a);
		if(!b.length){
			a = this._getMaterials(obj);
			flagM = 1;
			b = Object.keys(a);
		}
		if(!b.length) return false;
		if(obj.tex) for(i=0;i&lt;obj.tex.length;i++) a[b[0]].textures = obj.tex;
		if(obj.uni) for(i=0;i&lt;obj.uni.length;i++) a[b[0]].uniforms[obj.uni[i]].value = obj.val[i];
		if(flagM){
			if(obj.e&gt;-1) this.subs[obj.e].setMaterials(a);
			else this.ent.setMaterials(a);
		} else {
			if(obj.e&gt;-1) this.subs[obj.e].setShaders(a);
			else this.ent.setShaders(a);
		}
		return true;
	},
	/** e, id, scale, pos
	*/
	explosion: function(obj){
		var act,sha = {};
		sha[obj.id] = {
			fragment_shader:&quot;lib_ms_whexit.fs&quot;,
			vertex_shader:&quot;lib_ms_bbT.vs&quot;,
			textures:[&quot;lib_explode2.png&quot;],
			uniforms:{
				colorMap:{type:&quot;texture&quot;,value:0},
				Time:{binding:&quot;universalTime&quot;},
				Dest:{binding:&quot;destination&quot;,bindToSubentity:true,normalized:false}}};
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.destination = [2,clock.absoluteSeconds-1,obj.scale];
		act.setShaders(sha);
		if(obj.pos) act.position = obj.pos;
	},
	/** e, id, scale, pos
	*/
	hyper: function(obj){
		var act,sha = {};
		sha[obj.id] = {
			fragment_shader:&quot;lib_ms_whexit.fs&quot;,
			vertex_shader:&quot;lib_ms_bbT.vs&quot;,
			textures:[&quot;lib_hyper.png&quot;],
			uniforms:{
				colorMap:{type:&quot;texture&quot;,value:0},
				Time:{binding:&quot;universalTime&quot;},
				Dest:{binding:&quot;destination&quot;,bindToSubentity:true,normalized:false}}};
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.destination = [6,clock.absoluteSeconds-1,obj.scale];
		act.setShaders(sha);
		if(obj.pos) act.position = obj.pos;
	},
	/** e, id, scale, pos, col
	*/
	sun: function(obj){
		var act,sha = {};
		sha[obj.id] = {
			fragment_shader:&quot;lib_ms_sun.fs&quot;,
			vertex_shader:&quot;lib_ms_bbT.vs&quot;,
			uniforms:{
				Suncolor:{type:&quot;vector&quot;,value:obj.col},
				Time:{type:&quot;float&quot;,value:0},
				Dest:{binding:&quot;destination&quot;,bindToSubentity:true,normalized:false}}};
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.destination = [1,1,obj.scale];
		act.setShaders(sha);
		if(obj.pos) act.position = obj.pos;
	},
	/** e, id, scale, pos, col
	*/
	twinkle: function(obj){
		var act,sha = {};
		sha[obj.id] = {
			fragment_shader:&quot;lib_ms_bg_twinkle.fs&quot;,
			vertex_shader:&quot;lib_ms_bbT.vs&quot;,
			uniforms:{
				Time:{binding:&quot;universalTime&quot;},
				Dest:{binding:&quot;destination&quot;,bindToSubentity:true,normalized:false}}};
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.destination = [99999999,0,obj.scale];
		act.setShaders(sha);
		if(obj.pos) act.position = obj.pos;
	},
	/** e, id, scale, pos, col
	*/
	moon: function(obj){
		var act,sha = {};
		sha[obj.id] = {
			fragment_shader:&quot;lib_ms_moon.fs&quot;,
			vertex_shader:&quot;lib_ms_moon.vs&quot;,
			textures:[{name:obj.tex,cube_map:true}],
			uniforms:{
				colorMap:{type:&quot;texture&quot;,value:0},
				Suncolor:{type:&quot;vector&quot;,value:obj.col},
				Scale:{type:&quot;float&quot;,value:obj.scale}}};
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.setShaders(sha);
		if(obj.pos) act.position = obj.pos;
	},
	/** e, t, tg, [exh, fe, dist, swap]
	*/
	setBinding: function(obj){
		if(typeof obj.tg===&#39;number&#39;){
			if(obj.tg&gt;-1) obj.tg = this.subs[obj.tg];
			else obj.tg = this.ent;
		}
		if(obj.dist){
			if(obj.e&gt;-1) obj.distv = this.subs[obj.e].position.subtract(obj.tg.position);
			else obj.distv = obj.tg.position;
		}
		var c = [this.ent,this.subs,0,this.defDelta,obj];
		this.fcb = addFrameCallback(function(delta){
			if(!delta || !c[0] || !c[0].isValid) return;
			var f=1, act, p, o, s = 0;
			if(c[3]&gt;delta) f = 1/(c[3]/delta);
			else f = 1-(c[3]-delta);
			c[2] += delta;
			if(c[2]&gt;=c[4].t) return;
			if(c[4].e&gt;-1) act = c[1][c[4].e];
			else act = c[0];
			if(c[4].fe){
				act.fuel = c[4].tg.fuel;
				act.energy = c[4].tg.energy;
			}
			if(c[4].exh){
				if(c[4].tg.desiredSpeed) s = c[4].tg.speed+1;
				act.fuel = (s/c[4].tg.maxSpeed)*0.7;
				act.energy = (s/c[4].tg.maxSpeed)*c[4].tg.maxEnergy;
			}
			if(c[4].dsor){
				act.destination = c[4].tg.position;
				act.energy = 0;
			}
			if(c[4].distv){
				o = c[4].tg.orientation;
				if(c[4].swap) o = o.rotate(c[4].tg.vectorUp,-Math.PI);
				act.orientation = o;
				p = c[4].tg.position.add(c[4].distv.rotateBy(o));
				act.position = p;
			}
			return;
		});
		this._addTo(&quot;bind&quot;,this.fcb,obj);
		return true;
	},
	/** e
	*/
	stopBinding: function(obj){
		this._stopIt(obj,&quot;bind&quot;);
		return true;
	},
	/** e, pos
	*/
	setPosition: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].position = obj.pos;
		else this.ent.position = obj.pos;
		return true;
	},
	/** e, tg, ex, p
	*/
	setExhaust: function(obj){
		if(obj.e&gt;-1){
			this.subs[obj.e].position = this.subs[obj.tg].exhausts[obj.ex].position;
			this.subs[obj.e][obj.p] = this.subs[obj.tg].exhausts[obj.ex].size.multiply(0.11764); // .dat 1/8.5
		}
		return true;
	},
	/** e, tg [, off]
	*/
	setPositionTo: function(obj){
		var pos;
		if(obj.tg&gt;-1) pos = this.subs[obj.tg].position;
		else pos = this.ent.position;
		if(obj.off) pos.add(obj.off);
		if(obj.e&gt;-1) this.subs[obj.e].position = pos;
		else this.ent.position = pos;
		return true;
	},
	/** e, f, tg [, off]
	*/
	setFlasherPositionTo: function(obj){
		var pos;
		if(obj.tg&gt;-1) pos = this.subs[obj.tg].position;
		else pos = this.ent.position;
		if(obj.off) pos = pos.add(obj.off);
		if(obj.e&gt;-1) this.subs[obj.e].flashers[obj.f].position = pos;
		else this.ent.flashers[obj.f].position = pos;
		return true;
	},
	/** e, ori
	*/
	setOrientation: function(obj){
		if(obj.e&gt;-1) this.subs[obj.e].orientation = obj.ori;
		else this.ent.orientation = obj.ori;
		return true;
	},
	/** e, inf
	*/
	snapIn: function(obj){
		this._stopIt(obj,&quot;rotate&quot;);
		var act,ori;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		ori = act.orientation;
		ori.w = this._snapIn(ori.w);
		ori.x = this._snapIn(ori.x);
		ori.y = this._snapIn(ori.y);
		ori.z = this._snapIn(ori.z);
		act.orientation = ori;
	},
	/** n
	*/
	setBackground: function(obj){
		this.bg.name = obj.n;
		setScreenBackground(this.bg);
	},
	/** mw, mh [, n]
	*/
	zoomBackground: function(obj){
		this.bg.mw = obj.mw;
		this.bg.mh = obj.mh;
		if(obj.n) this.bg.name = obj.n;
		this.fcb = addFrameCallback(this._zoomBG.bind(this));
		this.fcbs.push(this.fcb);
		this.flow.bg[&quot;-1&quot;] = [this.fcb];
	},
	zoomBackgroundTo: function(){},
	/**
	*/
	stopBackground: function(){
		this._stopIt({e:-1},&quot;bg&quot;);
	},
	/**
	*/
	clearBackground: function(){
		this.stopBackground();
		setScreenBackground(null);
	},
	resetBackground: function(obj){
		this.stopBackground();
		this.bg = {name:null,width:this.w,height:this.h,mw:1,mh:1};
		if(obj &amp;&amp; obj.n) this.setBackground(obj);
	},
	/** n
	*/
	setOverlay: function(obj){
		this.ov.name = obj.n;
		setScreenOverlay(this.ov);
	},
	/** mw, mh [, n]
	*/
	zoomOverlay: function(obj){
		this.ov.mw = obj.mw;
		this.ov.mh = obj.mh;
		if(obj.n) this.ov.name = obj.n;
		this.fcb = addFrameCallback(this._zoomOV.bind(this));
		this.fcbs.push(this.fcb);
		this.flow.ov[&quot;-1&quot;] = [this.fcb];
	},
	/**
	*/
	stopOverlay: function(){
		this._stopIt({e:-1},&quot;ov&quot;);
	},
	/**
	*/
	clearOverlay: function(){
		this.stopOverlay();
		setScreenOverlay(null);
	},
	/** t
	*/
	fadeIn: function(obj){
		this._stopIt({e:-1},&quot;ov&quot;);
		this.ov = {name:&quot;lib_blend0.png&quot;,width:this.w,height:this.h,mw:1,mh:1};
		this.ovFade = {n:0,dir:1,t:obj.t};
		this.fcb = addFrameCallback(this._fadeOV.bind(this));
		this.fcbs.push(this.fcb);
		this.flow.ov[&quot;-1&quot;] = [this.fcb];
	},
	/** t
	*/
	fadeOut: function(obj){
		this._stopIt({e:-1},&quot;ov&quot;);
		this.ov = {name:&quot;lib_blend10.png&quot;,width:this.w,height:this.h,mw:1,mh:1};
		this.ovFade = {n:0,dir:0,t:obj.t};
		this.fcb = addFrameCallback(this._fadeOV.bind(this));
		this.fcbs.push(this.fcb);
		this.flow.ov[&quot;-1&quot;] = [this.fcb];
	},
	/** e, lv, x, y, mz
	*/
	screenCornerPos: function(obj){
		var pos,
			w = 1024/this.w,
			h = 768/this.h;
		if(obj.e&gt;-1) pos = this.subs[obj.e].position;
		else pos = this.ent.position;
		pos.x = obj.lv*pos.z*obj.x;
		pos.y = obj.lv*pos.z*0.75*obj.y;
		if(obj.mz) pos.z *= obj.mz;
		else pos.z *= 1.3;
		var wh = w/h;
		pos = pos.add([w*wh-1,h*wh-1,0]);
		this.ent.position = pos;
		return true;
	},
	// Sub functions
	_addTo: function(w,id,obj){
		this.fcbs.push(id);
		if(this.flow[w][obj.e]) this.flow[w][obj.e].push(id);
		else this.flow[w][obj.e] = [id];
	},
	/** e, what
	*/
	_stopIt: function(obj,what){
		var f = this.flow[what][obj.e],ind;
		if(!f) return false;
		for(var i=0;i&lt;f.length;i++){
			if(isValidFrameCallback(f[i])) removeFrameCallback(f[i]);
			ind = this.fcbs.indexOf(f[i]);
			if(ind!==-1) this.fcbs.splice(ind,1);
		}
		this.flow[what][obj.e] = [];
		return true;
	},
	/**
	*/
	_zoomBG: function(delta){
		if(!delta) return;
		this.bg.width *= this.bg.mw;
		this.bg.height *= this.bg.mh;
		setScreenBackground(this.bg);
	},
	/**
	*/
	_zoomOV: function(delta){
		if(!delta) return;
		this.ov.width *= this.ov.mw;
		this.ov.height *= this.ov.mh;
		setScreenOverlay(this.ov);
	},
	/**
	*/
	_fadeOV: function(delta){
		if(!delta) return;
		var f = Math.floor(this.ovFade.n*10/this.ovFade.t);
		if(this.ovFade.dir) f = 10-f;
		else f++;
		if(f&lt;0) f = 0;
		if(f&gt;10) f = 10;
		this.ov.name = &quot;lib_blend&quot;+f+&quot;.png&quot;;
		setScreenOverlay(this.ov);
		this.ovFade.n += delta;
	},
	_removeFCBs: function(){
		if(!this.fcbs.length) return false;
		for(var i=0;i&lt;this.fcbs.length;i++){
			if(isValidFrameCallback(this.fcbs[i])) removeFrameCallback(this.fcbs[i]);
		}
		this.fcb = 0;
		this.fcbs = [];
		return true;
	},
	_getMaterials: function(obj){
		if(obj.e&gt;-1) return this.subs[obj.e].getMaterials();
		return this.ent.getMaterials();
	},
	_setMaterials: function(obj,m){
		if(obj.e&gt;-1) return this.subs[obj.e].setMaterials(m);
		return this.ent.setMaterials(m);
	},
	_getShaders: function(obj){
		if(obj.e&gt;-1) return this.subs[obj.e].getShaders();
		return this.ent.getShaders();
	},
	_setPilot: function(obj){
		var act;
		this.setShaderProp(obj);
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.destination = obj.scpos;
		act.lightsActive = obj.init;
	},
	_pilotSpeak: function(obj){
		var act;
		if(obj.e&gt;-1) act = this.subs[obj.e];
		else act = this.ent;
		act.energy = obj.fade;
		if(obj.txt) mission.addMessageText(obj.txt);
	},
	_sRND: function(seed,max){
		return ((0x731753*seed)&gt;&gt;16)%max;
	},
	_snapIn: function(e){
		if(e&gt;0.9) e = 1;
		if(e&gt;0.6 &amp;&amp; e&lt;0.8) e = 0.707107;
		if(e&gt;0.4 &amp;&amp; e&lt;0.6) e = 0.5;
		if(e&gt;-0.1 &amp;&amp; e&lt;0.1) e = 0.0;
		if(e&gt;-0.6 &amp;&amp; e&lt;-0.4) e = -0.5;
		if(e&gt;-0.8 &amp;&amp; e&lt;-0.6) e = -0.707107;
		if(e&lt;-0.9) e = -1;
		return e;
	}
};
}).call(this);</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Animator.txt</td>
                    <td><pre>Lib_Animator

The Animator is a helper for animations on missionscreens.

Methods:

_start(obj)
worldScripts.Lib_Animator._start(obj);

Required members:
obj.model		- String. Role
obj.flow		- Array. Animation flow object.

Optional members:
obj.background	- String.
obj.choices		- Object.
obj.choicesKey	- String.
obj.music		- String
obj.overlay		- String.
obj.screenID	- String.
obj.title		- String.

obj.fadeIn		- Bool. If used replaces obj.overlay.
obj.corner		- Object. See below.
obj.aPos		- Array.
obj.aOris		- Array.
obj.aBinds		- Array.
obj.aProps		- Array.
obj.bPos		- Array.
obj.bOris		- Array.
obj.bBinds		- Array.
obj.bProps		- Array.
obj.pilots		- Array. Sets texture, scale, position and display for character overlay.

obj.caller		- String. worldScript name for callback and checkpoints.
obj.callback	- String. Function to be called when user  
obj.checkpoint	- String. Function to be called when &#39;check&#39; gets processed.
obj.custom		- Object. Holds custom Functions to be called when &#39;custom&#39; gets processed.
obj.hud			- String.

obj.aSnd		- String.
obj.bSnd		- String.
obj.delta		- Number.


obj.flow
	
	Array containing Arrays with at least 2 members (frame and cmd).
		frame	- Number.
		cmd		- String. Action command.
		obj		- Object or String.
		subCMD	- Array.

Action commands:

reset
	Removes all Framecallbacks
clr
	Removes all Framecallbacks and resets 
clrMov
	Removes all object movement Framecallbacks (flight, rotate, speed, velocity, walk and zoom).
kill
	Removes mission.displayModel.

rotw
	Rotate entity in world space.
	e, t, rx,ry,rz [, z, da, db]
rot
	Rotate entity in model space
	e, t, rx,ry,rz [, z, da, db]
rotTo
	Rotate entity to target. Clears other rotations for this entity.
	e, t, tg [, z, da, db, s]
stopRot
	Clear rotations for this entity.
	e
fly
	e, t, mu,mr,mf, rx,ry,rz [,da, db, z, fu, en]
flyTo
	e, t, tg, s, mu,mr,mf [, da, db, z, fu, en]
stopFly
	e
KI
stopKI

spd
spdTo
stopSpd
velo
	e, t, mu,mr,mf [,da, db, z, fu, en]
veloTo
	e, t, tg, mu,mr,mf [, da, db, z, fu, en]
veloSet
	e, velo
stopVelo
	e
walk
	e, t, st [,z, da, db]
walkTo
	
stopWalk
	e
zoom
	e, t, mz [, z, da, db]
zoomTo
	
stopZoom
	e
prop
	e, t, p, v [, da, db]
matSet
	e, mat, sha
matMod
	e, prop
		i, p, v
tex
shadeSet
	e, sha, rep
shadeMod
	e, tex, uni, val
sun
	Replaces shader with textureless sun shader.
	e, id, scale, pos, col
moon
	Replaces shader with cubemapped moon shader.
	e, id, scale, pos, col
boom
	Replaces shader with explosion shader.
	e, id, scale, pos
hyper
	Replaces shader with hyperjump exit shader and plays sound.
	e, id, scale, pos
shoot
	Sets energy for laser shader and plays sound.
speak
	Sets energy for character overlay and plays sound or adds message text.
bind
	e, t, tg [,fe, dist, swap]
stopBind
	e
pos
	e, pos
posTo
	e, tg [, off]
posFl
	e, f, tg [, off]
ori
	e, ori
bg
	n
bgZoom
	mw, mh [, n]
bgZoomTo

bgStop
	none
bgClr
	none
ov
	n
ovZoom
	mw, mh [, n]
ovStop
	none
ovClr
	none
ovFadeIn
	t
ovFadeOut
	t
corner
	e, lv, x, y [, mz]
txt
	String.
snd1
	snd
snd2
	snd
mus
	snd
custom
	Calls custom function declared in the passed obj.custom.
	String.
goto
	Goto animation frame time.
	Number.
check
	Request action from obj.caller. Passes current frame time.
	If returned value is a Number goto frame.
	If no returned value (or false) stops the animation.
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_BinSearch.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global _lib_BinSearch */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_BinSearch&quot;;

/** This search tree uses two corresponding entries.
*	Must be instantiated! 
*	this.$myTree = new worldScripts.Lib_BinSearch._lib_BinSearch();
*/
this._lib_BinSearch = function(){this._lbs = null;};
_lib_BinSearch.prototype = {
	constructor: _lib_BinSearch,

	/** add() - Adds nodes to the search tree with the corresponding entry.
	@key - String. Add node with key.
	@val - Object. Corresponding entry
	*/
	add: function(key,val){
		var node = {key: key,left: null,right: null, val: val},cur;
		if(this._lbs === null) this._lbs = node;
		else {
			cur = this._lbs;
			while(true){
				if(key &lt; cur.key){
					if(cur.left === null){
						cur.left = node;
						break;
					} else cur = cur.left;
				} else if(key &gt; cur.key){
					if(cur.right === null){
						cur.right = node;
						break;
					} else cur = cur.right;
				} else break;
			}
		}
		return;
	},

	/** contains() - Returns corresponing entry or false.
	@key - String. Search for entry.
	@return - Object. Corresponding entry or false.
	*/
	contains: function(key){
		var found = false,cur = this._lbs;
		while(!found &amp;&amp; cur){
			if(key &lt; cur.key) cur = cur.left;
			else if(key &gt; cur.key) cur = cur.right;
			else found = true;
		}
		if(!found) return false;
		return cur.val;
	},

	traverse: function(process){
		function inOrder(node){
			if(node){
				if(node.left !== null) inOrder(node.left);
				process.call(this,node);
				if(node.right !== null) inOrder(node.right);
			}
		}
		inOrder(this._lbs);
	},

	/** size() - Returns the number of nodes in the search tree.
	@return - Number. Number of nodes.
	*/
	size: function(){
		var length = 0;
		this.traverse(function(node){length++;});
		return length;
	},

	/** toArray() - Returns an array containing all nodes in the search tree. The nodes are processed in-order.
	@return - Array. Entries.
	*/
	toArray: function(){
		var result = [];
		this.traverse(function(node){result.push(node.key,node.val);});
		return result;
	},

	/** toString() - Returns a comma-separated string consisting of all entries. The nodes are processed in-order.
	@separator - String. Optional. If specified separates the elements.
	@return - String. Concatenation of all entries.
	*/
	toString: function(separator){
		if(separator) return this.toArray().join(separator);
		else return this.toArray().toString();
	}
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Config.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global expandMissionText,log,mission,player,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Config&quot;;
this.description = &quot;Options for AddOns which ship configurable user-friendly features.&quot;;

this.$sets = {}; // Settings objects
this.$setNames = []; // Sorting
this.$setProbs = {}; // Error codes
this.$curSet = null;
this.$defCHC = {
	allowInterrupt: false,
	choices: {ZZZ: &quot;Exit&quot;},
	initialChoicesKey: null,
	message: &quot;&quot;,
	screenID: this.name,
	textEntry: false,
	title: &quot;Config&quot;
};
this.$oxpc = {
	curBit: 0,
	curInd: 0,
	curKeys: [],
	curMSB: 0,
	curOpt: 0,
	curPage: 0,
	curTyp: 0,
	div: &quot;&quot;,
	entry: 0,
	intern: 0,
	resort: 0,
	scr: [&#39;Bool&#39;,&#39;SInt&#39;,&#39;EInt&#39;]
};
/** _registerSet(obj) - Use on .startUpComplete() or later.
	@obj - Settings object
	@return Number. Error code. 0 - ok, &gt;0 - error (see missiontext.plist)
*/
this._registerSet = function(obj){
	if(this.startUp) return 99;
	if(!obj || typeof obj!==&#39;object&#39;) return 101;
	if(!Object.keys(obj).length) return 102;
	var e = this._checkSet(obj);
	if(e) return e;
	var id = obj.Name+obj.Display,
		ind = this.$setNames.indexOf(id);
	this.$sets[id] = obj; // Store or update
	if(ind===-1){ // No double entries
		this.$setNames.push(id);
		this.$oxpc.entry++;
		this.$oxpc.resort = 1;
		this.$setProbs[id] = e;
	}
	return 0;
};
/** _unregisterSet(obj)
	@obj - Settings object
	@return Number. Error code. 0 - ok, &gt;0 - error (see missiontext.plist)
*/
this._unregisterSet = function(obj){
	if(typeof obj!==&#39;object&#39;) return 501;
	var id = obj.Name+obj.Display,
		ind = this.$setNames.indexOf(id);
	if(!this.$sets[id]) return 502;
	if(ind===-1) return 503;
	delete this.$sets[id];
	this.$oxpc.entry--;
	this.$oxpc.resort = 1;
	this.$setNames.splice(ind,1);
	return 0;
};
this._updSet = function(obj){
	if(typeof obj!==&#39;object&#39;) return 601;
	var ind = -1,
		tmp,tmps,
		e = this._checkSet(obj);
	if(!e || e===211){
		ind = this.$setNames.indexOf(obj.Name+obj.Display);
		if(ind!==-1){
			tmp = this.$setNames[ind];
			if(tmp){
				if(!e){
					tmps = this._aid.objGrab(worldScripts[obj.Name],obj.Alive);
					this.$sets[tmp] = tmps[0][tmps[1]];
				}
				this.$curSet = this.$sets[tmp];
			}
		} else { // Not registered
			this.$curSet = obj;
			this.$oxpc.intern = 0;
			return e;
		}
	} else this.$curSet = obj;
	return e;
};
this.startUp = function(){
	delete this.startUp;
	this._aid = worldScripts.Lib_Main._lib; // Covered by manifest
	worldScripts.Lib_GUI.$IDRules.Lib_Config = {pic:1,mus:1};
	this.$oxpc.div = this._aid.scrToWidth(&quot;-&quot;,31,&quot;-&quot;)+&quot;\n&quot;;
};
this.startUpComplete = function(){
	delete this.startUpComplete;
	this.shipDockedWithStation(); // Implement interface
};
this.shipDockedWithStation = function(){
	if(!player.ship || !player.ship.isValid || !player.ship.docked) return;
	player.ship.dockedStation.setInterface(this.name,{
		title: &quot;Config for AddOns&quot;,
		category: &quot;AddOns&quot;,
		summary: this.description,
		callback: this._showStart.bind(this)
	});
};
this._checkSet = function(obj){
	var e = 0, t = [&#39;string&#39;,&#39;function&#39;,&#39;object&#39;,&#39;undefined&#39;], noti;
	if(typeof obj.Name!==t[0]) return 201;
	if(typeof obj.Display!==t[0]) return 202;
	if(typeof obj.Alive!==t[0]) return 203;
	if(obj.Alias &amp;&amp; typeof obj.Alias!==t[0]) return 209;
	if(obj.Notify){
		if(typeof obj.Notify!==t[0]) return 204;
		noti = this._aid.objGrab(worldScripts[obj.Name],obj.Notify);
		if(typeof noti[0]===&#39;undefined&#39;) return 212;
		if(typeof noti[0]!==t[1] &amp;&amp; typeof noti[0][noti[1]]!==t[1]) return 212;
	}
	var k = this.$oxpc.scr,v;
	for(var i=0;i&lt;k.length;i++){
		v = k[i];
		if(typeof obj[v]!==t[3]){
			if(typeof obj[v]!==t[2]) return 206+i;
			if(!obj[v] || !Object.keys(obj[v]).length) return 213+i;
		} else e++;
	}
	if(e===3) return 205;
	if(!this._checkAvail(obj)) return 211;
	return 0;
};
this._checkAvail = function(obj){
	var ws = worldScripts[obj.Name];
	if(!ws || ws.$deactivated) return false;
	var a = this._aid.objGrab(ws,obj.Alive);
	if(typeof a[0][a[1]]!==&#39;object&#39; || !Object.keys(a[0][a[1]]).length) return false;
	return true;
};
this._checkHeader = function(obj){
	var h = {Name:&quot;-&quot;,Alias:0,Display:&quot;-&quot;,Mani:&quot;-&quot;,Author:&quot;-&quot;,Copyright:&quot;-&quot;,Licence:&quot;-&quot;,Desc:&quot;-&quot;,Version:&quot;-&quot;,Ref:false,Extern:false},
		ws = worldScripts[obj.Name];
	h.Ref = this._checkAvail(obj);
	if(ws){
		if(ws.name) h.Name = ws.name;
		if(obj.Name) h.Name = obj.Name;
		if(ws.author) h.Author = ws.author;
		if(ws.copyright) h.Copyright = ws.copyright;
		if(ws.licence) h.Licence = ws.licence;
		else if(ws.license) h.Licence = ws.license;
		if(ws.description) h.Desc = ws.description;
		if(ws.version) h.Version = ws.version;
		if(ws.oolite_manifest_identifier) h.Mani = ws.oolite_manifest_identifier;
	} else if(obj.Name) h.Name = obj.Name;
	if(obj.Display) h.Display = obj.Display;
	if(obj.Alias) h.Alias = obj.Alias;
	if(!this.$oxpc.intern) h.Extern = true;
	return h;
};
this._checkValues = function(obj,typ){
	var wc = obj[typ],
		ws = worldScripts[obj.Name],
		max = 16777215, min = -16777215,
		c,ty,de,val;
	switch(typ){
		case &#39;Bool&#39;: ty = &#39;boolean&#39;; de = &#39;string&#39;; break;
		case &#39;SInt&#39;: ty = &#39;number&#39;; de = &#39;string&#39;; break;
		case &#39;EInt&#39;: ty = &#39;number&#39;; de = &#39;object&#39;; break;
	}
	for(var t in wc){
		if(!wc[t]) return 301;
		if(t===&#39;Info&#39; || t===&#39;Notify&#39;) continue;
		c = wc[t];
		if(typeof c.Name!==&#39;string&#39;) return 302;
		if(typeof c.Def!==ty) return 303;
		if(typeof c.Desc!==de) return 304;
		val = this._aid.objGet(ws,c.Name);
		if(typeof val!==ty) return 401;
		if(typ!==&#39;Bool&#39;){
			if(typeof c.Max!==ty) return 311;
			if(typeof c.Min!==ty) return 312;
			if(typ===&#39;EInt&#39;) min = 0;
			if(c.Max&lt;min) return 313;
			if(c.Max&gt;max) return 314;
			if(c.Min&gt;c.Max) return 315;
			if(c.Min&lt;min) return 316;
			if(c.Def&gt;c.Max) return 317;
			if(c.Def&lt;c.Min) return 318;
			if(c.Def&gt;max) return 319;
			if(c.Def&lt;min) return 320;
			if(val&gt;max || val&gt;c.Max) return 411;
			if(val&lt;min || val&lt;c.Min) return 412;
		}
	}
	return 0;
};
this._fillOptions = function(chc,tit,ent){
	var obj = JSON.parse(JSON.stringify(this.$defCHC));
	if(chc) obj.choices = chc;
	if(tit) obj.title = tit;
	if(ent) obj.textEntry = true;
	return obj;
};
this._resort = function(){
	this.$setNames = this.$setNames.sort();
	this.$oxpc.resort = 0;
};
this._reset = function(){
	this.$curSet = null;
	this.$defCHC.initialChoicesKey = null;
	var o = this.$oxpc;
	o.curBit = 0;
	o.curMSB = 0;
	o.curInd = 0;
	o.curKeys = [];
	o.curOpt = 0;
	o.curPage = 0;
	o.curTyp = 0;
	o.intern = 0;
};
this._showScr = function(obj,mes,mesKey,cb){
	if(mesKey){
		obj.messageKey = mesKey;
		obj.message = null;
	} else if(mes) obj.message = mes;
	if(cb) mission.runScreen(obj,cb);
	else mission.runScreen(obj,this._choiceEval);
};
this._showStart = function(){
	var ch = {goLI:&quot;List Settings&quot;,ZZZ:&quot;Exit&quot;},
		chc,txt,
		o = this.$oxpc;
	this._reset();
	if(!o.entry) ch = this._aid.scrChcUnsel(ch,&#39;goLI&#39;);
	chc = this._fillOptions(ch);
	chc.exitScreen = &quot;GUI_SCREEN_INTERFACES&quot;;
	this._showScr(chc,0,&#39;LIBC_HEAD&#39;);
	txt = o.div;
	o.intern = 1;
	txt += &quot;\nCurrently registered settings: &quot;+o.entry+&quot;\n\nChoose your option.&quot;;
	mission.addMessageText(txt);
	if(o.resort) this._resort();
};
this._showList = function(){
	var ch = {LINext:&quot;Next Setting&quot;,lioOXP:&quot;Select Setting&quot;,LIPNext:&quot;Next page&quot;,LIPPrev:&quot;Previous page&quot;,LIRet:&quot;Back&quot;},
		chc,txt,tmp,tmq,ind,
		o = this.$oxpc,
		max = o.curPage*10,
		e = o.entry;
	txt = this._aid.scrAddLine([[&quot;&quot;,1],[&quot;Settings&quot;,10],[&quot;Script/Alias&quot;,10],[&quot;Version&quot;,7],[&quot;Ref&quot;,3]],&quot;&quot;,&quot;\n&quot;);
	txt += o.div;
	for(var i=0;i&lt;10;i++){
		ind = i+max;
		if(e&lt;=ind) break;
		tmq = this.$setNames[ind];
		tmp = this._checkHeader(this.$sets[tmq]);
		txt += this._aid.scrAddLine([[(o.curInd===ind?&quot;&gt;&quot;:&quot;&quot;),1]]);
		txt += this._addHeader(tmp,1);
	}
	if(e&lt;=max) ch = this._aid.scrChcUnsel(ch,&#39;LINext&#39;);
	if(e&lt;=(1+o.curPage)*10) ch = this._aid.scrChcUnsel(ch,&#39;LIPNext&#39;);
	if(!o.curPage) ch = this._aid.scrChcUnsel(ch,&#39;LIPPrev&#39;);
	chc = this._fillOptions(ch);
	this._showScr(chc,txt);
};
/** _showOXPPage(obj) - for direct access
	@obj - Settings object
	@return Number. Error code. 0 - ok, &gt;0 - error (see missiontext.plist)
*/
this._showOXPPage = function(obj){
	if(!obj || typeof obj!==&#39;object&#39;) return 101;
	if(!Object.keys(obj).length) return 102;
	var e = this._updSet(obj),
		ch = {goBool:&quot;Show switches&quot;,goEInt:&quot;Show flags&quot;,goSInt:&quot;Show values&quot;,OXPZZZ:&quot;Back&quot;},
		c = this.$curSet,
		o = this.$oxpc,
		tmp = this._checkHeader(c),
		chc,txt;
	if(e || !tmp.Ref){
		ch = this._aid.scrChcUnsel(ch,&#39;goBool&#39;);
		ch = this._aid.scrChcUnsel(ch,&#39;goEInt&#39;);
		ch = this._aid.scrChcUnsel(ch,&#39;goSInt&#39;);
	} else {
		if(!c.Bool) ch = this._aid.scrChcUnsel(ch,&#39;goBool&#39;);
		if(!c.EInt) ch = this._aid.scrChcUnsel(ch,&#39;goEInt&#39;);
		if(!c.SInt) ch = this._aid.scrChcUnsel(ch,&#39;goSInt&#39;);
		if(c.Reset) ch.OXPDef = &quot;Reset to defaults&quot;;
	}
	txt = this._addHeader(tmp);
	txt += o.div;
	txt += this._aid.scrAddLine([[&quot;Author(s): &quot;+tmp.Author,29],[&quot;Manifest: &quot;+tmp.Mani,29],[&quot;Copyright: &quot;+tmp.Copyright,29],[&quot;Licence: &quot;+tmp.Licence,29],[&quot;Desc: &quot;+tmp.Desc,29]],&quot;\n&quot;);
	txt += o.div;
	if(e || !tmp.Ref) txt += &quot;\n&quot;+this._addError(tmp,e,&#39;obj&#39;);
	else txt += &quot;\nSettings object found.\n&quot;;
	chc = this._fillOptions(ch,tmp.Display);
	this._showScr(chc,txt);
	o.curBit = 0;
	o.curMSB = 0;
	o.curOpt = 0;
	o.curTyp = 0;
	return e;
};
/** _showOXPSub(obj) - for direct access
	@obj - Settings object
	@typ - String. Either &quot;Bool&quot;,&quot;SInt&quot; or &quot;EInt&quot;
	@return Number. Error code. 0 - ok, &gt;0 - error (see missiontext.plist)
*/
this._showOXPSub = function(obj,typ){
	if(!obj || typeof obj!==&#39;object&#39;) return 101;
	if(!Object.keys(obj).length) return 102;
	if(!typ || this.$oxpc.scr.indexOf(typ)===-1) return 701;
	var e = this._updSet(obj),
		c = this.$curSet,
		ch = {OXPNext:&quot;Next option&quot;,OXPToggle:&quot;Change current&quot;,OXPZZZ:&quot;Back&quot;},
		o = this.$oxpc,
		r,tp,val,inf,
		z = 0, sh = 1;
	o.curTyp = typ;
	var op = Object.keys(c[typ]),
		opl = op.length,
		opk = [],
		pass = this._checkValues(c,typ),
		tmp = this._checkHeader(c),
		txt = this._addHeader(tmp);
	if(e || pass) sh = 0;
	txt += o.div;
	if(sh){
		for(var x=0;x&lt;opl;x++){
			tp = op[x];
			if(tp===&#39;Info&#39; || tp===&#39;Notify&#39;) continue;
			if(opk.length&gt;8) break;
			if(!c[typ][tp].Hide) opk.push(tp);
		}
		o.curKeys = opk;
		if(!opk.length){
			txt += &quot;Nothing to configure yet.\n&quot;;
			z++;
		} else {
			for(var t in c[typ]){
				if(z&gt;8) break;
				if(t===&#39;Info&#39; || t===&#39;Notify&#39;) continue;
				val = c[typ][t];
				if(!val || val.Hide) txt += this._aid.scrAddLine([[&quot;&quot;,1],[&quot;-&quot;,1]],&quot;&quot;,&quot;\n&quot;);
				else {
					if(!o.curOpt) o.curOpt = t;
					r = this._calcs(val);
					switch(typ){
						case &#39;Bool&#39;:
							txt += this._aid.scrAddLine([[(o.curOpt===t?&quot;&gt;&quot;:&quot; &quot;),1],[z,1],[r.Dec,4],[&quot;D:&quot;+val.Def,5],[val.Desc,8]],&quot;&quot;,&quot;\n&quot;);
							break;
						case &#39;SInt&#39;:
							txt += this._aid.scrAddLine([[(o.curOpt===t?&quot;&gt;&quot;:&quot;&quot;),1],[z,1],[r.Dec,5],[&quot;D:&quot;+r.Def,5],[&quot;R:&quot;+r.Min+&quot; - &quot;+r.Max,10],[val.Desc,8]],&quot;&quot;,&quot;\n&quot;);
							break;
						case &#39;EInt&#39;:
							o.curMSB = r.msb;
							txt += this._aid.scrAddLine([[&quot;&quot;,1],[z,10],[r.Dec,5],[r.str,14],[r.msb,0]],&quot;&quot;,&quot;\n&quot;);
							for(var i=0;i&lt;r.msb;i++){
								if(i &amp;&amp; 0===i%3) txt += &quot;\n&quot;;
								txt += this._aid.scrAddLine([[(o.curBit===i?&quot;&gt;&quot;:&quot;&quot;),1],[(r.revstr.length&gt;i?r.revstr[i]:&quot;0&quot;),1],[(val.Desc.length&gt;i?val.Desc[i]:&quot; &quot;),8]],&quot;&quot;);
							}
							txt += &quot;\n&quot;;
							z = Math.ceil(r.msb/3);
							break;
					}
				}
				z++;
			}
		}
	} else {
		if(e) txt += this._addError(tmp,e,typ);
		if(pass) txt += this._addError(tmp,pass,typ);
		z += (e?1:0)+(pass?1:0);
	}
	txt += this._aid.scrFillLines(z,9);
	if(c[typ].Info){
		inf = c[typ].Info;
		if(inf[0]===&quot;^&quot;) inf = expandMissionText(inf.substr(1));
		txt += &quot;\nDesc:\n&quot;+inf.toString().substr(0,240)+&quot;\n&quot;;
	}
	if(!sh || (opk.length&lt;2 &amp;&amp; typ!==&#39;EInt&#39;)) ch = this._aid.scrChcUnsel(ch,&#39;OXPNext&#39;);
	if(!sh || !opk.length) ch = this._aid.scrChcUnsel(ch,&#39;OXPToggle&#39;);
	var chc = this._fillOptions(ch,tmp.Display);
	this._showScr(chc,txt);
	return e;
};
this._calcs = function(val){
	var s = this._aid.objGet(worldScripts[this.$curSet.Name],val.Name);
	var r = {Dec: s};
	switch(this.$oxpc.curTyp){
		case &#39;SInt&#39;:
			r.Dec = r.Dec;
			r.Def = val.Def;
			r.Max = val.Max;
			r.Min = val.Min;
			break;
		case &#39;EInt&#39;:
			r.str = this._aid.toBase(r.Dec,2);
			r.msb = this._aid.getMSB(val.Max);
			r.revstr = this._aid.strRev(r.str);
			break;
	}
	return r;
};
this._showOXPValueEnter = function(){
	var c = this.$curSet,
		o = this.$oxpc,
		tmp = this._checkHeader(c),
		txt = this._addHeader(tmp)+o.div,
		val = c[o.curTyp][o.curOpt],
		r = this._calcs(val);
	txt += this._aid.scrAddLine([[&quot;&quot;,1],[&quot;&quot;,1],[r.Dec,5],[&quot;D:&quot;+r.Def,5],[&quot;R:&quot;+r.Min+&quot; - &quot;+r.Max,10],[val.Desc,0]],&quot;&quot;,&quot;\n&quot;);
	txt += o.div;
	txt += &quot;\nHexadecimal whole numbers, e.g. &#39;0xff&#39;.&quot;;
	if(val.Min&lt;0) txt += &quot;\nNegative values, e.g. dec &#39;-32&#39; or hexadecimal &#39;-0x20&#39;.&quot;;
	if(val.Float) txt += &quot;\nFloating point values , e.g &#39;1.1&#39;.&quot;;
	txt += &quot;\n\nEnter your value.&quot;;
	var chc = this._fillOptions({},tmp.Name,1);
	this._showScr(chc,txt,null,this._choiceEnter);
};
this._addHeader = function(tmp,flag){
	return this._aid.scrAddLine([[tmp.Display,10],[(tmp.Alias?tmp.Alias:tmp.Name),10],[tmp.Version,4],[(flag?&quot;&quot;:&quot;#&quot;),1],[(flag?&quot;&quot;:&quot;&quot;),1],[(flag?&quot;&quot;:(tmp.Extern?&quot;Ex&quot;:&quot;&quot;)),1],[(tmp.Ref?&quot;&quot;:&quot;!&quot;)+(tmp.Extern?&quot;-&quot;:String(this.$setProbs[tmp.Name+tmp.Display])),2.5]],&quot;&quot;,&quot;\n&quot;);
};
this._addError = function(w,e,typ){
	this.$setProbs[w.Name+w.Display] = e;
	log(this.name,&quot;Error: &quot;+w.Name+&quot; &quot;+w.Display+&quot; - (&quot;+typ+&quot;) &quot;+expandMissionText(&#39;LIBC_E&#39;+e));
	return &quot;Error: &quot;+e+&quot; - (&quot;+typ+&quot;) &quot;+expandMissionText(&#39;LIBC_E&#39;+e)+&quot;\n&quot;;
};
this._notiError = function(s,w){
	log(this.name,&quot;Notification failed for &quot;+s+&quot;.&quot;+w+&quot;!&quot;);
};
this._choiceEval = function(choice){worldScripts.Lib_Config._choices(choice); return;};
this._choices = function(choice){
	if(choice) this.$defCHC.initialChoicesKey = choice;
	var o = this.$oxpc,
		c = this.$curSet,
		p = Math.floor(o.curInd/10),
		cur = this.$setNames[o.curInd],
		a,b,flag,ind,ok,ws;
	var pp = p*10;
	switch(choice){
		case &#39;goBool&#39;:
			this._showOXPSub(c,&#39;Bool&#39;);
			break;
		case &#39;goEInt&#39;:
			this._showOXPSub(c,&#39;EInt&#39;);
			break;
		case &#39;goLI&#39;:
			o.intern = 1;
			this._showList();
			break;
		case &#39;lioOXP&#39;:
			this._showOXPPage(this.$sets[cur]);
			break;
		case &#39;goSInt&#39;:
			this._showOXPSub(c,&#39;SInt&#39;);
			break;
		case &#39;LINext&#39;:
			o.curInd++;
			if(o.curInd&gt;=pp+10 || o.curInd&lt;pp || o.curInd&gt;=o.entry) o.curInd = pp;
			this._showList();
			break;
		case &#39;LIPNext&#39;:
			o.curPage++;
			o.curInd = pp+10;
			this._showList();
			break;
		case &#39;LIPPrev&#39;:
			if(o.curPage&gt;-1){
				o.curPage--;
				o.curInd = pp-10;
			}
			this._showList();
			break;
		case &#39;LIRet&#39;:
			this._showStart();
			break;
		case &#39;OXPDef&#39;:
			ws = worldScripts[c.Name];
			if(c.Notify) a = 1;
			ind = o.scr;
			for(var i=0;i&lt;3;i++){
				flag = ind[i];
				if(c[flag]){
					if(!a &amp;&amp; c[flag].Notify) b = 1;
					else b = 0;
					for(var j in c[flag]){
						if(typeof c[flag][j]!==&#39;object&#39;) continue;
						this._aid.objSet(ws,c[flag][j].Name,c[flag][j].Def);
						if(!a &amp;&amp; !b &amp;&amp; c[flag][j].Notify) this._aid.objPass(ws,c[flag][j].Notify,j);
					}
					if(b) this._aid.objPass(ws,c[flag].Notify,flag);
				}
			}
			if(a) this._aid.objPass(ws,c.Notify,&quot;All&quot;);
			this._showOXPPage(this.$sets[cur]);
			mission.addMessageText(&quot;Reset to defaults.&quot;);
			break;
		case &#39;OXPNext&#39;:
			switch(o.curTyp){
				case &#39;Bool&#39;:
				case &#39;SInt&#39;:
					ind = o.curKeys.indexOf(o.curOpt)+1;
					if(ind&gt;o.curKeys.length-1) ind = 0;
					o.curOpt = o.curKeys[ind];
					break;
				case &#39;EInt&#39;:
					o.curBit++;
					if(o.curBit&gt;=o.curMSB) o.curBit = 0;
					break;
			}
			this._showOXPSub(c,o.curTyp);
			break;
		case &#39;OXPToggle&#39;:
			ws = worldScripts[c.Name];
			ind = c[o.curTyp][o.curOpt].Name;
			switch(o.curTyp){
				case &#39;Bool&#39;:
					a = this._aid.objGet(ws,ind);
					a = !a;
					this._aid.objSet(ws,ind,a);
					flag = 1;
					break;
				case &#39;SInt&#39;:
					this._showOXPValueEnter();
					break;
				case &#39;EInt&#39;:
					a = this._aid.objGet(ws,ind);
					b = Math.pow(2,o.curBit);
					if(c[o.curTyp][o.curOpt].OneOf) a = b;
					else if(c[o.curTyp][o.curOpt].OneOfZero){
						if(a===b) a = 0;
						else a = b;
					} else {
						if(a&amp;b) a -= b;
						else a += b;
					}
					this._aid.objSet(ws,ind,a);
					flag = 1;
					break;
			}
			if(flag){
				if(c[o.curTyp][o.curOpt].Notify){
					ok = this._aid.objPass(ws,c[o.curTyp][o.curOpt].Notify,o.curOpt);
					if(!ok) this._notiError(c.Name,c[o.curTyp][o.curOpt].Notify);
				}
				this._showOXPSub(c,o.curTyp);
			}
			break;
		case &#39;OXPZZZ&#39;:
			ws = worldScripts[c.Name];
			if(o.curTyp){
				if(c[o.curTyp].Notify){
					ok = this._aid.objPass(ws,c[o.curTyp].Notify,o.curTyp);
					if(!ok) this._notiError(c.Name,c[o.curTyp].Notify);
				}
				this._showOXPPage(c);
			} else {
				if(c.Notify){
					ok = this._aid.objPass(ws,c.Notify,&quot;All&quot;);
					if(!ok) this._notiError(c.Name,c.Notify);
				}
				this.$curSet = null;
				if(o.intern){
					this.$defCHC.initialChoicesKey = &#39;LIRet&#39;;
					this._showList();
				} else this._reset(); // Bye
			}
			break;
		case &#39;ZZZ&#39;:
			this._reset();
			break;
	}
};
// Numerical input
this._choiceEnter = function(choice){worldScripts.Lib_Config._choiceEnterB(choice); return;};
this._choiceEnterB = function(choice){
	var o = this.$oxpc,
		c = this.$curSet,
		ws = worldScripts[c.Name],
		ind = c[o.curTyp][o.curOpt],
		sign = 1,
		ok,val;
	if(choice){
		// Store sign
		if(choice[0]===&#39;-&#39;){
			choice = choice.substr(1);
			sign = -1;
		}
		if(choice.length&gt;2 &amp;&amp; choice.substr(0,2)===&quot;0x&quot; &amp;&amp; !isNaN(parseInt(choice))) val = parseInt(choice);
		else if(ind.Float &amp;&amp; !isNaN(parseFloat(choice))) val = parseFloat(choice);
		else if(!isNaN(parseInt(choice))) val = parseInt(choice);
		if(typeof(val)!==&#39;undefined&#39;){
			val *= sign; // Reapply sign
			val = this._aid.clamp(val,ind.Min,ind.Max);
			this._aid.objSet(ws,ind.Name,val);
			if(c[o.curTyp][o.curOpt].Notify){
				ok = this._aid.objPass(ws,c[o.curTyp][o.curOpt].Notify,o.curOpt);
				if(!ok) this._notiError(c.Name,c[o.curTyp][o.curOpt].Notify);
			}
		}
	}
	this._showOXPSub(c,o.curTyp);
};
}).call(this);</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Crypt.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global log */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Crypt&quot;;

/** _decrypt() - Decrypts string.
	@str - String. Minimum length 6 chars.
	@pwd - String. Password. Minimum length 4 chars.
	@return - String/Boolean. String or false.
	Author: Terry Yuen.
*/
this._decrypt = function(str,pwd){
	if(!str || !pwd || str.length&lt;6 || pwd.length&lt;4){log(this.name,&quot;Parameters error.&quot;); return false;}
	var prand = &quot;&quot;;
	for(var i=0;i&lt;pwd.length;i++) prand += pwd.charCodeAt(i).toString();
	var sPos = Math.floor(prand.length/5);
	var mult = parseInt(prand.charAt(sPos)+prand.charAt(sPos*2)+prand.charAt(sPos*3)+prand.charAt(sPos*4)+prand.charAt(sPos*5),null);
	var incr = Math.round(pwd.length/2);
	var modu = Math.pow(2,31)-1;
	var salt = parseInt(str.substring(str.length-8,str.length),16);
	str = str.substring(0,str.length-8);
	prand += salt;
	while(prand.length&gt;10) prand = (parseInt(prand.substring(0,10),null)+parseInt(prand.substring(10,prand.length),null)).toString();
	prand = (mult*prand+incr)%modu;
	var enc_chr = &quot;&quot;,dec_str = &quot;&quot;;
	for(var j=0;j&lt;str.length;j+=2){
		enc_chr = parseInt(parseInt(str.substring(j,j+2),16)^Math.floor((prand/modu)*255),null);
		dec_str += String.fromCharCode(enc_chr);
		prand = (mult*prand+incr)%modu;
	}
	return dec_str;
};

/** _encrypt() - Encrypts string.
	@str - String. Minimum length 6 chars.
	@pwd - String. Password. Minimum length 4 chars.
	@return - String/Boolean. String or false.
	Author: Terry Yuen.
*/
this._encrypt = function(str,pwd){
	if(!str || !pwd || str.length&lt;6 || pwd.length&lt;4){log(this.name,&quot;Parameters error in encrypt.&quot;); return false;}
	var prand = &quot;&quot;;
	for(var i=0;i&lt;pwd.length;i++) prand += pwd.charCodeAt(i).toString();
	var sPos = Math.floor(prand.length/5);
	var mult = parseInt(prand.charAt(sPos)+prand.charAt(sPos*2)+prand.charAt(sPos*3)+prand.charAt(sPos*4)+prand.charAt(sPos*5),null);
	var incr = Math.ceil(pwd.length/2);
	var modu = Math.pow(2,31)-1;
	if(mult&lt;2){log(this.name,&quot;Algorithm cannot find a suitable hash.&quot;); return false;}
	var salt = Math.round(Math.random()*1000000000)%100000000;
	prand += salt;
	while(prand.length&gt;10) prand = (parseInt(prand.substring(0,10),null)+parseInt(prand.substring(10,prand.length),null)).toString();
	prand = (mult*prand+incr)%modu;
	var enc_chr = &quot;&quot;,enc_str = &quot;&quot;;
	for(var j=0;j&lt;str.length;j++){
		enc_chr = parseInt(str.charCodeAt(j)^Math.floor((prand/modu)*255),null);
		if(enc_chr&lt;16) enc_str += &quot;0&quot;+enc_chr.toString(16);
		else enc_str += enc_chr.toString(16);
		prand = (mult*prand+incr)%modu;
	}
	salt = salt.toString(16);
	while(salt.length&lt;8) salt = &quot;0&quot;+salt;
	enc_str += salt;
	return enc_str;
};

/** _getCRC() - Returns simple checksum. Limits every char via &amp;0xff and result via &amp;0x3fff.
*/
this._getCRC = function(str){
	var crc = 0, i = str.length;
	while(i--) crc += (str.charCodeAt(i)&amp;0xff);
	return crc&amp;0x3fff;
};

/** _rot5() - Number rotation. Can be paired with _rot13.
*/
this._rot5 = function(str){
	return (str+&#39;&#39;).replace(/[0-9]/g,function(s){return String.fromCharCode(s.charCodeAt(0)+(s&lt;&#39;5&#39;?5:-5));});
};

/** _rot13() - Alphabet rotation. Can be paired with _rot5.
*/
this._rot13 = function(str){
	return (str+&#39;&#39;).replace(/[a-z]/gi,function(s){return String.fromCharCode(s.charCodeAt(0)+(s.toLowerCase()&lt;&#39;n&#39;?13:-13));});
};

/** _rot513 - Combined rot5 and rot13.
*/
this._rot513 = function(str){
	var a = this._rot5(str),b = this._rot13(a);
	return b;
};

/** _rot47() - Expanded rotation.
*/
this._rot47 = function(a,b){return++b?String.fromCharCode((a=a.charCodeAt()+47,a&gt;126?a-94:a)):a.replace(/[^ ]/g,this._rot47);};

/** _Vigenere
* input   String.
* key     String. Alphabetical key.
* forward Bool. Set to true for decryption.
* $return String.
*/
this._Vigenere = function(input, key, forward){
	var alphabet = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;,
		adjusted_key = &quot;&quot;, i, key_char, output = &quot;&quot;, key_index = 0, in_tag = false;
	if(key===null) key = &quot;&quot;;
	key = key.toUpperCase();
	var key_len = key.length;
	for(i=0;i&lt;key_len;i++){
		key_char = alphabet.indexOf(key.charAt(i));
		if(key_char&lt;0) continue;
		adjusted_key += alphabet.charAt(key_char);
	}
	key = adjusted_key;
	key_len = key.length;
	if (key_len===0){
		key = &quot;a&quot;;
		key_len = 1;
	}
	var input_len = input.length;
	for(i=0;i&lt; input_len;i++){
		var input_char = input.charAt(i);
		if(input_char===&quot;&lt;&quot;) in_tag = true;
		else if(input_char===&quot;&gt;&quot;) in_tag = false;
		if(in_tag){
			output += input_char;
			continue;
		}
		var input_char_value = alphabet.indexOf(input_char);
		if(input_char_value&lt;0){
			output += input_char;
			continue;
		}
		var lowercase = input_char_value &gt;= 26 ? true : false;
		if(forward) input_char_value += alphabet.indexOf(key.charAt(key_index));
		else input_char_value -= alphabet.indexOf(key.charAt(key_index));
		input_char_value += 26;
		if(lowercase) input_char_value = input_char_value % 26 + 26;
		else input_char_value %= 26;
		output += alphabet.charAt(input_char_value);
		key_index = (key_index + 1) % key_len;
	}
	return output;
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Cubecode.js</td>
                    <td><pre>/* global mission,worldScripts,SoundSource */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Cubecode&quot;;

/** _initCubes
* @obj.pass - Number
* @obj.card - Texture
* @obj.ws - String
* @obj.path - String
*/
this._initCubes = function(obj){
	if(this.$cub.init) return false;
	var ret,map = &quot;lib_lock.png&quot;,lo = 0,ws=null,wsf=null;
	if(obj){
		if(obj.card) map = obj.card;
		if(typeof obj.pass===&quot;number&quot;) lo = obj.pass;
		if(obj.ws &amp;&amp; obj.path){
			ws = obj.ws;
			wsf = obj.path;
		}
	}
	this.$cub.lock = lo;
	this.$cub.ws = ws;
	this.$cub.path = wsf;
	this.$head.subTex[0].mat[&quot;lib_null.png&quot;].emission_map = map;
	this.$cub.code = -1;
	this.$cub.init = 1;
	ret = this._showCubes();
	return ret;
};
this.startUp = function(){
	this.$head = {
		model: &quot;lib_ms_cubes&quot;,
		title: &quot;Security check&quot;,
		background: &quot;lib_console_bg.png&quot;,
		choices: {NEXT:&quot;Next&quot;,ROTX:&quot;Rotate X&quot;,ROTY:&quot;Rotate Y&quot;,ROTZ:&quot;Rotate Z&quot;,ZZZ:&quot;QUIT&quot;},
		text: &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n                                        Select your option:&quot;,
		caller: this.name,
		callback: &quot;_choiceEval&quot;,
		checkpoint: &quot;_checkpoints&quot;,
		aOris: [{e:-1,ori:[1,0,0,0]}],
		aPos: [{e:-1,pos:[0,30,250]}],
		subTex: [{e:0,mat:{&quot;lib_null.png&quot;:{emission_map:&quot;lib_lock.png&quot;}}}],
		flow:[]
	};
	this.$cub = {
		code:-1,
		lock:0,
		cur:1,
		init:0,
		ws:null,
		path:null,
		curOri:[[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0]],
		flows:{a:[4,&quot;rotX&quot;,{e:1,t:2,deg:90,da:1,db:1,inf:1}],b:[4,&quot;rotY&quot;,{e:1,t:2,deg:90,da:1,db:1,inf:1}],c:[4,&quot;rotZ&quot;,{e:1,t:2,deg:90,da:1,db:1,inf:1}]}
	};
	this.$snd = new SoundSource();
	this._aid = worldScripts.Lib_Main._lib;
};
this._showCubes = function(fl,w){
	var obj = this._aid.objClone(this.$head),ac,c = 0,ret,i,un = [&#39;ROTX&#39;,&#39;ROTY&#39;,&#39;ROTZ&#39;,&#39;ZZZ&#39;],m = &quot;lib_ms_cube_a.png&quot;;
	for(i=1;i&lt;10;i++){obj.aOris.push({e:i,ori:this.$cub.curOri[i]});}
	if(w) obj.replace = 1;
	else {
		obj.fadeIn = true;
		obj.flow.push([c,&quot;ovFadeIn&quot;,{t:1.5}]);
		c++;
		obj.flow.push([c,&quot;snd1&quot;,{snd:&quot;lib_enter_code.ogg&quot;}]);
		c++;
	}
	if(this.$cub.lock===this.$cub.code){
		for(i=0;i&lt;4;i++) obj.choices = this._aid.scrChcUnsel(obj.choices,un[i]);
		obj.flow.push([c,&quot;clr&quot;]);
		c++;
		for(i=1;i&lt;10;i++){
			obj.flow.push([c,&quot;lit&quot;,{e:i,mat:m,tex:m,col:[0,0.6,0,1]}]);
			c++;
		}
	} else {
		obj.flow.push([c,&quot;lit&quot;,{e:this.$cub.cur,mat:m,tex:m,col:[0,0.6,0,1]}]);
		c++;
		if(fl){
			ac = this.$cub.flows[fl];
			ac[0] = c;
			ac[2].e = this.$cub.cur;
			obj.flow.push(ac);
			c++;
			obj.flow.push([c,&quot;check&quot;]);
			c+=5;
			obj.flow.push([c,&quot;snap&quot;,{e:this.$cub.cur}]);
			c++;
			obj.flow.push([c,&quot;check&quot;]);
			c++;
		}
	}
	c+=5;
	obj.flow.push([c,&quot;clr&quot;]);
	ret = worldScripts.Lib_Animator._start(obj);
	if(ret &amp;&amp; !w &amp;&amp; !fl) this._getRes();
	return ret;
};
this._choiceEval = function(choice){worldScripts.Lib_Cubecode._delayChoice(choice); return;};
this._delayChoice = function(choice){
	var cb,ws;
	switch(choice){
		case &quot;NEXT&quot;:
			this.$cub.cur++;
			if(this.$cub.cur&gt;9) this.$cub.cur = 1;
			if(this.$cub.lock===this.$cub.code){
				cb = 1;
				this.$cub.init = 0;
			} else this._showCubes(0,1);
			break;
		case &quot;ROTX&quot;: this._showCubes(&quot;a&quot;,1); break;
		case &quot;ROTY&quot;: this._showCubes(&quot;b&quot;,1); break;
		case &quot;ROTZ&quot;: this._showCubes(&quot;c&quot;,1); break;
		case &quot;ZZZ&quot;: cb = 1; this.$cub.init = 0; break;
	}
	if(cb &amp;&amp; this.$cub.ws &amp;&amp; this.$cub.path){
		ws = worldScripts[this.$cub.ws];
		this._aid.objPass(ws,this.$cub.path,this.$cub.code);
	}
	this.$snd.sound = &quot;[changed-option]&quot;;
	this.$snd.play();
};
this._checkpoints = function(n){
	var o;
	switch(n){
		case 2:
			o = worldScripts.Lib_Animator._a;
			if(o) this.$cub.curOri[this.$cub.cur] = o.cur[this.$cub.cur].tOri;
			break;
		case 8:
			this._getRes();
			if(this.$cub.lock===this.$cub.code){
				this.$snd.sound = &quot;lib_code_verified.ogg&quot;;
				this.$snd.play();
				this._showCubes(0,1);
			}
			break;
	}
	return true;
};
this._getRes = function(){
	var res = 0,pri = [3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61],a,b,c = mission.displayModel;
	for(var i=1;i&lt;10;i++){
		a = pri[i];
		b = c.subEntities[i].vectorUp;
		if(b.x&gt;0) res += b.x*11*a;
		if(b.y&gt;0) res += b.y*13*a;
		if(b.z&gt;0) res += b.z*17*a;
		b = c.subEntities[i].vectorRight;
		if(b.x&gt;0) res += b.x*19*a;
		if(b.y&gt;0) res += b.y*23*a;
		if(b.z&gt;0) res += b.z*29*a;
		b = c.subEntities[i].vectorForward;
		if(b.x&gt;0) res += b.x*31*a;
		if(b.y&gt;0) res += b.y*37*a;
		if(b.z&gt;0) res += b.z*41*a;
	}
	this.$cub.code = Math.floor(res);
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_EntityStrength.js</td>
                    <td><pre>/* global system,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_EntityStrength&quot;;

this.$weapons = [&quot;EQ_WEAPON_NONE&quot;,&quot;EQ_WEAPON_MINING_LASER&quot;,&quot;EQ_WEAPON_PULSE_LASER&quot;,&quot;EQ_WEAPON_BEAM_LASER&quot;,&quot;EQ_WEAPON_MILITARY_LASER&quot;,&quot;EQ_WEAPON_THARGOID_LASER&quot;];
this.$slotsA = [&quot;forwardWeapon&quot;,&quot;aftWeapon&quot;,&quot;portWeapon&quot;,&quot;starboardWeapon&quot;];
this.$slotsB = [&quot;weaponPositionForward&quot;,&quot;weaponPositionAft&quot;,&quot;weaponPositionPort&quot;,&quot;weaponPositionStarboard&quot;];
/** Returns strength value for passed entity.
*/
this._check = function(ent){
	var w = ent.weaponFacings,
		eq = ent.equipment,
		esc = ent.escorts,
		sec = ent.subEntityCapacity,
		c = 0, wc = 0, ind = 0,
		i, l, s, t, tt;
	c += ent.maxEnergy*(ent.maxPitch+ent.maxRoll+ent.maxYaw)*ent.energyRechargeRate;
	if(ent.isPlayer) c += (ent.maxAftShield*ent.aftShieldRechargeRate+ent.maxForwardShield*ent.forwardShieldRechargeRate)*0.5;
	c += ent.maxSpeed*ent.maxThrust;
	c *= 0.001;
	if(eq &amp;&amp; eq.length){
		if(ent.isPlayer) c += eq.length;
		else c += eq.length*5;
	}
	if(esc &amp;&amp; esc.length){
		l = esc.length;
		for(i=0;i&lt;l;i++) c += this._check(esc[i])*0.5;
	}
	c += ent.maxEscorts;
	if(w){
		for(i=0;i&lt;4;i++){
			t = ent[this.$slotsA[i]];
			if(t &amp;&amp; t.equipmentKey){
				ind = this.$weapons.indexOf(t.equipmentKey);
				if(ind&lt;0) ind = 6;
				tt = ent[this.$slotsB[i]];
				if(tt &amp;&amp; tt.length) ind += tt.length; // multi
				wc += ind;
			}
		}
		if(ent.accuracy&gt;1) wc *= ent.accuracy;
		c += wc*10;
	}
	if(sec){
		s = ent.subEntities;
		l = (s?s.length:0);
		for(i=0;i&lt;l;i++) if(s[i].isTurret) c += 50;
		if(ent.isPlayer &amp;&amp; l&lt;sec) c += 50*(sec-l); // no cheats
	}
	c += ent.missileCapacity*5;
	if(!ent.maxSpeed) c /= ent.mass*0.000005;
	if(ent.isThargoid) c *= 1.5;
	c = Math.round(c);
	// Add value to ship script.
	if(ent.script) ent.script.$libStrength = c;
	return c;
};
/** Returns maximum value of NPC ships in the system.
	Params:
		rel - Piloted ships relative to entity.
		all - Return Array of all numbers.
		redo - Set script values. Do not use careless.
*/
this._gather = function(rel,all,redo){
	var a = [],b,l,i=0,c;
	if(rel) b = system.filteredEntities(this,function(e){return(e.isShip &amp;&amp; e.isValid &amp;&amp; e.isPiloted &amp;&amp; !e.isPlayer);},rel,52000);
	else {
		b = system.allShips;
		i = 1;
	}
	l = b.length;
	if(l&gt;400) l = 400; // Cap
	if(redo){
		for(i;i&lt;l;i++) a.push(this._check(b[i]));
	} else {
		for(i;i&lt;l;i++){
			if(b[i].script){
				if(typeof b[i].script.$libStrength===&#39;number&#39;) c = b[i].script.$libStrength;
				else c = this._check(b[i]);
			} else c = -1;
			a.push(c);
		}
	}
	if(!all){
		if(a.length) a = Math.max.apply(Math,a);
		else a = 0;
		if(!isFinite(a)) a = 999999;
		if(!rel) worldScripts.Lib_Main._lib.$entLastStrength = a;
	}
	return a;
};
this.shipSpawned = function(ent){
	this._check(ent);
	if(ent.primaryRole===&quot;lib_test&quot; &amp;&amp; ent.script.name!==&quot;lib_test&quot;) worldScripts.Lib_Main._lib.$entCstRemoved = true;
};
this.missionScreenOpportunity = function(){this._gather(0,0,1); delete this.missionScreenOpportunity;};
this.shipWillDockWithStation = this.shipExitedWitchspace = function(){this._gather(0,0,1);};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_GUI.js</td>
                    <td><pre>/* global addFrameCallback,galaxyNumber,guiScreen,mission,missionVariables,player,removeFrameCallback,setScreenBackground,setScreenOverlay,worldScripts,SoundSource,System */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_GUI&quot;;
this.copyright = &quot;(C)2016-2018&quot;;
this.description = &quot;GUI images and sounds handling.&quot;;

// Full Sets
this.$guis = {};
this.$IDs = {};
// Extension - temporary overrides, FIFO
this.$guisExt = {
	GUI_SCREEN_EQUIP_SHIP: [],
	GUI_SCREEN_GAMEOPTIONS: [],
	GUI_SCREEN_INTERFACES: [],
	GUI_SCREEN_KEYBOARD: [],
	GUI_SCREEN_LOAD: [],
	GUI_SCREEN_LONG_RANGE_CHART: [],
	GUI_SCREEN_MANIFEST: [],
	GUI_SCREEN_MARKET: [],
	GUI_SCREEN_MARKETINFO: [],
	GUI_SCREEN_OPTIONS: [],
	GUI_SCREEN_REPORT: [],
	GUI_SCREEN_SAVE: [],
	GUI_SCREEN_SAVE_OVERWRITE: [],
	GUI_SCREEN_SHIPLIBRARY: [],
	GUI_SCREEN_SHIPYARD: [],
	GUI_SCREEN_SHORT_RANGE_CHART: [],
	GUI_SCREEN_STATUS: [],
	GUI_SCREEN_STICKMAPPER: [],
	GUI_SCREEN_STICKPROFILE: [],
	GUI_SCREEN_SYSTEM_DATA: []
};
// Extension
this.$IDsExt = {};
// screenID rules - expand, but do not change!
this.$IDRules = {
	&quot;oolite-contracts-cargo-none&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-contracts-cargo-details&quot;: {mpic:1,snd:1,mus:1},
	&quot;oolite-contracts-cargo-summary&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-contracts-parcels-none&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-contracts-parcels-details&quot;: {mpic:1,snd:1,mus:1},
	&quot;oolite-contracts-parcels-summary&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-contracts-passengers-none&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-contracts-passengers-details&quot;: {mpic:1,snd:1,mus:1},
	&quot;oolite-contracts-passengers-summary&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-primablemanager&quot;: {pic:1,ov:1,snd:1,mus:1},
	&quot;oolite-register&quot;: {pic:1,ov:1,snd:1,mus:1}
};
this.$ambi = {
	audio: true,
	guiFX: true,
	ex: 0,
	last: 0,
	reinit: 0,
	crowd: &quot;generic&quot;,
	generic: [],
	redux: [],
	none: []
};
this.$noEx = Object.keys(this.$IDRules);

this.startUp = function(){
	this._aid = worldScripts.Lib_Main._lib;
	for(var i=0;i&lt;this.$noEx.length;i++) this._aid.objLock(this.$IDRules[this.$noEx[i]]);
	this._aid.objLock(this.$IDRules);
};
// remove missionVariables.LIB_GUI sometime
this.startUpComplete = function(){
	delete this.startUpComplete;
	var gu,ms = missionVariables.LIB_GUI,ind=0,max=0,mv=missionVariables.LIB_GUI_CONFIG,mvp;
	this.$s = new SoundSource();
	this.$amb = new SoundSource();
	this.$op = null;
	this.$cur = null;
	this.$k = Object.keys(this.$guis);
	if(ms &amp;&amp; worldScripts[ms]) this.$cur = ms;
	if(mv){
		mvp = JSON.parse(missionVariables.LIB_GUI_CONFIG);
		if(mvp.cur &amp;&amp; worldScripts[mvp.cur]) this.$cur = mvp.cur;
		this.$ambi.audio = mvp.audio;
		this.$ambi.guiFX = mvp.guiFX;
	}
	gu = this.$k;
	if(!this.$cur &amp;&amp; gu.length) this.$cur = gu[gu.length-1];
	if(gu &amp;&amp; gu.length){
		ind = gu.indexOf(this.$cur);
		this.$E0 = 0;
		if(ind!==-1){
			ind = Math.pow(2,ind);
			this.$E0 = ind;
		}
		max = Math.pow(2,gu.length)-1;
		this.$inf = {Name:&quot;Lib_GUI&quot;,Alias:&quot;Library&quot;,Display:&quot;GUI-Config&quot;,Alive:&quot;$inf&quot;,
			Bool:{
				B0:{Name:&quot;$ambi.audio&quot;,Def:true,Desc:&quot;Ambience Audio&quot;},
				B1:{Name:&quot;$ambi.guiFX&quot;,Def:true,Desc:&quot;SFX on GUIs&quot;}
			},
			EInt:{E0:{Name:&quot;$E0&quot;,Def:ind,Min:0,Max:max,Desc:gu,Notify:&quot;_chgSet&quot;,OneOfZero:1},Info:&quot;Choose your background set.&quot;}};
		worldScripts.Lib_Config._registerSet(this.$inf);
	}
	// TODO: Attempt to avoid JS-reset bug - remove when solved.
	setScreenBackground(&quot;lib_black.png&quot;);
	this._setCrowd(player.ship.dockedStation);
	this._stationAmb();
	missionVariables.LIB_GUI = null;
};
this._chgSet = function(){
	var gu = this.$k, ind = this._aid.getMSB(this.$E0)-1;
	if(ind&lt;0) this.$cur = null;
	else this.$cur = gu[ind];
};
this.playerWillSaveGame = function(){
	var o = {
		cur: this.$cur,
		audio: this.$ambi.audio,
		guiFX: this.$ambi.guiFX
	};
	missionVariables.LIB_GUI_CONFIG = JSON.stringify(o);
};
this.alertConditionChanged = function(){
	if(player.ship.isInSpace) this.guiScreenChanged();
};
this.gameResumed = function(){
	this.guiScreenChanged();
	this._stationAmb();
};
this.gamePaused = function(){
	this._stationAmb(1);
};
this.shipDied = function(){
	if(this.$guiFCB) removeFrameCallback(this.$guiFCB);
	this._stationAmb(1);
};
this.shipDockedWithStation = function(st){
	this._setCrowd(st);
	this._stationAmb();
};
this._setCrowd = function(st){
	var inf, p = [&quot;generic&quot;,&quot;redux&quot;,&quot;none&quot;];
	if(st.scriptInfo &amp;&amp; st.scriptInfo.lib_crowd &amp;&amp; p.indexOf(st.scriptInfo.lib_crowd)&gt;-1) inf = st.scriptInfo.lib_crowd;
	if(!st.isMainStation &amp;&amp; !st.hasNPCTraffic &amp;&amp; !inf) this.$ambi.crowd = &quot;none&quot;;
	else {
		if(inf) this.$ambi.crowd = inf;
		else if(st.name===&quot;Rock Hermit&quot;) this.$ambi.crowd = &quot;redux&quot;;
		else this.$ambi.crowd = &quot;generic&quot;;
	}
};
this._stationAmb = function(s){
	if(player.ship.isInSpace || s){
		if(this.$AmbTimer) this.$AmbTimer.stop();
		this.$amb.stop();
		this.$ambi.last = 0;
	} else {
		if(!this.$ambi.audio) return;
		if(this.$ambi.ex){
			this.$ambi.last = 0;
			if(this.$AmbTimer){
				this.$AmbTimer.stop();
				this.$AmbTimer.nextTime = clock.absoluteSeconds+1;
				this.$AmbTimer.start();
			}
			return;
		}
		var w = this.$ambi[this.$ambi.crowd], i = Math.floor(Math.random()*w.length), d,r;
		if(w.length){
			this.$amb.sound = w[i].name;
			this.$amb.volume = w[i].vol;
			this.$amb.play();
			d = w[i].dur-1;
			if(this.$AmbTimer) this.$AmbTimer.stop();
			else this.$AmbTimer = new Timer(this,this._stationAmb,-1,d);
			this.$AmbTimer.nextTime = clock.absoluteSeconds+d;
			this.$AmbTimer.start();
			this.$ambi.reinit = 0;
			this.$ambi.last = clock.absoluteSeconds+d;
		}
	}
};
this.shipWillLaunchFromStation = function(){
	this.$s.stop();
	this._stationAmb(1);
};
this.guiScreenChanged = function(){
	var gu = guiScreen, amb;
	switch(gu){
		case &quot;GUI_SCREEN_EQUIP_SHIP&quot;:
		case &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;:
		case &quot;GUI_SCREEN_MANIFEST&quot;:
		case &quot;GUI_SCREEN_MARKET&quot;:
		case &quot;GUI_SCREEN_MARKETINFO&quot;:
		case &quot;GUI_SCREEN_REPORT&quot;:
		case &quot;GUI_SCREEN_SHIPYARD&quot;:
		case &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot;:
		case &quot;GUI_SCREEN_STATUS&quot;:
			this.$op = null;
			this._setGUI(gu,0);
			this.$ambi.ex = 0;
			break;
		case &quot;GUI_SCREEN_SYSTEM_DATA&quot;:
			var inf = System.infoForSystem(galaxyNumber,player.ship.infoSystem),sp = 0;
			if(inf.sun_gone_nova || inf.sun_going_nova) sp = 1;
			this.$op = null;
			this._setGUI(gu,sp);
			this.$ambi.ex = 0;
			break;
		case &quot;GUI_SCREEN_INTERFACES&quot;:
		case &quot;GUI_SCREEN_SHIPLIBRARY&quot;:
			this.$op = gu;
			this._setGUI(gu,0);
			this.$ambi.ex = 0;
			break;
		case &quot;GUI_SCREEN_GAMEOPTIONS&quot;:
		case &quot;GUI_SCREEN_KEYBOARD&quot;:
		case &quot;GUI_SCREEN_LOAD&quot;:
		case &quot;GUI_SCREEN_OPTIONS&quot;:
		case &quot;GUI_SCREEN_SAVE&quot;:
		case &quot;GUI_SCREEN_SAVE_OVERWRITE&quot;:
		case &quot;GUI_SCREEN_STICKMAPPER&quot;:
		case &quot;GUI_SCREEN_STICKPROFILE&quot;:
			this.$op = gu;
			this._setGUI(gu,0);
			this._stationAmb(1);
			amb = 1;
			break;
		case &quot;GUI_SCREEN_MISSION&quot;:
			this.$op = null;
			if(mission.screenID) this._setMS(mission.screenID);
			else {
				this._stationAmb(1);
				this.$ambi.reinit = 1;
				amb = 1;
			}
			if(mission.exitScreen) this.$op = gu;
			break;
		case &quot;GUI_SCREEN_MAIN&quot;:
			amb = 1;
			this.$op = null;
			break;
		default:
			this.$op = null;
	}
	if(this.$op){
		if(!this.$guiFCB) this.$guiFCB = addFrameCallback(this._checkGUI.bind(this));
	} else {
		if(this.$guiFCB) removeFrameCallback(this.$guiFCB);
		delete this.$guiFCB;
	}
	if(!amb &amp;&amp; !this.$ambi.reinit &amp;&amp; this.$ambi.last&lt;=clock.absoluteSeconds+2) this._stationAmb();
	if(amb) this.$ambi.ex = 1;
};
this.missionScreenEnded = function(){
	if(this.$ambi.reinit) this._stationAmb();
};
this._checkGUI = function(){
	if(!player.ship.isValid) return;
	if(this.$op &amp;&amp; guiScreen!==this.$op &amp;&amp; guiScreen!==&quot;GUI_SCREEN_MISSION&quot;) this.guiScreenChanged();
};
this._setGUI = function(gui,spc){
	if(!this.$cur &amp;&amp; !this.$guisExt[gui].length){
		setScreenBackground(&quot;lib_black.png&quot;);
		return;
	}
	var g = this.$guis[this.$cur],
		ex = this.$guisExt[gui],
		big = player.ship.hudAllowsBigGui,
		img,ov,ref,snd,sou,w;
	if(!ex.length &amp;&amp; (!g || (!g[gui] &amp;&amp; !g.generic))) return;
	if(ex.length) w = ex[0];
	else if(g[gui]) w = g[gui];
	else w = g.generic;
	if(player.ship.isInSpace){
		sou = &quot;sndF&quot;;
		if(spc &amp;&amp; w.picNova) img = &quot;picNova&quot;;
		else if(w.picFlight) img = &quot;picFlight&quot;;
		else if(w.pic) img = &quot;pic&quot;;
	} else {
		sou = &quot;snd&quot;;
		if(spc &amp;&amp; w.picNova) img = &quot;picNova&quot;;
		else if(player.ship.dockedStation.script.$guiVoid &amp;&amp; w.picVoid){
			img = &quot;picVoid&quot;;
			sou = null;
		} else if(w.pic) img = &quot;pic&quot;;
	}
	if(sou){
		if(w[sou]) snd = w[sou];
		else if(w.sndRef){
			ref = this.$guis[w.sndRef];
			if(ref &amp;&amp; ref[gui] &amp;&amp; ref[gui][sou]) snd = ref[gui][sou];
		}
	}
	if(img){
		if(player.alertCondition===3 &amp;&amp; w[img+&quot;Red&quot;]) img = img+&quot;Red&quot;;
		if(big &amp;&amp; w[img+&quot;Big&quot;]) img = img+&quot;Big&quot;;
		this._applyBG(w[img]);
	}
	if(w.ov){
		ov = &quot;ov&quot;;
		if(player.alertCondition===3 &amp;&amp; w[ov+&quot;Red&quot;]) ov = ov+&quot;Red&quot;;
		if(big &amp;&amp; w[ov+&quot;Big&quot;]) ov = ov+&quot;Big&quot;;
		this._applyOV(w[ov]);
	}
	if(snd &amp;&amp; this.$ambi.guiFX) this.$s.playSound(snd);
	this.$guisExt[gui].shift();
};
this._setMS = function(id){
	if(!this.$cur &amp;&amp; !this.$IDsExt[id]) return;
	var m = this.$IDRules,
		s = this.$IDs[this.$cur],
		ex = (this.$noEx.indexOf(id)===-1?this.$IDsExt[id]:null),
		big = player.ship.hudAllowsBigGui,
		sou = &quot;snd&quot;,
		img,ov,w,ref;
	if(!m[id] || (!ex &amp;&amp; !s &amp;&amp; (!s[id] &amp;&amp; !s.generic))){
		this.$s.stop();
		this._stationAmb(1);
		this.$ambi.reinit = 1;
		this.$ambi.ex = 1;
		return;
	}
	if(ex) w = ex;
	else if(s[id]) w = s[id];
	else w = s.generic;
	if(player.ship.isInSpace) sou = &quot;sndF&quot;;
	if(m[id].snd &amp;&amp; this.$ambi.guiFX){
		if(w[sou]) this.$s.playSound(w[sou]);
		else if(w.sndRef){
			ref = this.$IDs[w.sndRef];
			if(ref &amp;&amp; ref[id] &amp;&amp; ref[id][sou]) this.$s.playSound(ref[id][sou]);
		} else this.$s.stop();
	} else this.$s.stop();
	if(m[id].mpic &amp;&amp; w.mpic) ov = &quot;mpic&quot;;
	else {
		if(m[id].pic &amp;&amp; w.pic) img = &quot;pic&quot;;
		if(m[id].ov &amp;&amp; w.ov) ov = &quot;ov&quot;;
	}
	if(img){
		if(big &amp;&amp; w.picBig) img = &quot;picBig&quot;;
		this._applyBG(w[img]);
	}
	if(ov){
		if(big &amp;&amp; w[ov+&quot;Big&quot;]) ov = ov+&quot;Big&quot;;
		this._applyOV(w[ov]);
	}
};
this._applyBG = function(img){
	if(typeof img===&quot;object&quot; &amp;&amp; img.scale){
		var sc = this._aid.ooImageScale(img.x,img.y,img.zoom);
		setScreenBackground({name:img.name,height:sc.height,width:sc.width});
	} else setScreenBackground(img);
};
this._applyOV = function(ov){
	if(typeof ov===&quot;object&quot; &amp;&amp; ov.scale){
		var sc = this._aid.ooImageScale(ov.x,ov.y,ov.zoom);
		setScreenOverlay({name:ov.name,height:sc.height,width:sc.width});
	} else setScreenOverlay(ov);
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Main.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global _libMain,defaultFont,expandMissionText,galaxyNumber,global,log,missionVariables,oolite,player,system,worldScripts,Ship,System */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 - Helper functions and data objects */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Main&quot;;
this.author = &quot;Svengali&quot;;

/** _libMain - Main class. There&#39;s often no need to instantiate it for other AddOns.
* Just create a reference -&gt; this._aid = worldScripts.Lib_Main._lib;
*/
this._libMain = function(){};
_libMain.prototype = {
	constructor: _libMain,
	/** Contains connected systems based on players position when
	* the game starts or player jumps to a new galaxy.
	*/
	$connections: [[],[],[],[],[],[],[],[]],
	$missionActive: null,
	/** Contains data keys of all ships.
	*/
	$ships: [],
	spc: String.fromCharCode(31),
	spcw: defaultFont.measureString(String.fromCharCode(31)),
	spcs: String.fromCharCode(32),
	spcsw: defaultFont.measureString(String.fromCharCode(32)),
	// Sanity
	$entCstChanged: [],
	$entCstPatched: false,
	$entCstRemoved: false,
	$entLastStrength: 0,

	// ***** Number *****
	/** Returns clamped Number in range min...max.
	*/
	clamp: function(n,min,max){
		return((n&gt;max)?max:(n&lt;min)?min:n);
	},
	/** Counts set bits in Number.
	*/
	cntBits: function(n){
		var res = 0;
		if(n&lt;0) n = ~n;
		while(n&gt;0){
			if((n&amp;1)) res++;
			n&gt;&gt;=1;
		}
		return res;
	},
	/** Returns greatest common denominator.
	*/
	gcd: function(x,y){
		return(y===0?x:this.gcd(y,x%y));
	},
	/** Returns position of most significant bit of non-negative Number or zero.
	*/
	getMSB: function(n){
		var res = 15;
		for(var r=8;r&gt;0;r&gt;&gt;=1) res = (n&lt;1&lt;&lt;res)?res-r:res+r;
		return((n&lt;1&lt;&lt;res)?res:res+1);
	},
	/** Modulo. Differs from JS native for negative values.
	* -2%3 = -2 while this._aid.mod(-2,3) = 1
	*/
	mod: function(x,y){
		return x-Math.floor(x/y)*y;
	},
	/** Returns random Number in range 0...n.
	*/
	rand: function(n){
		return n*(Math.random()%1) | 0;
	},
	/** Returns random Number in range min...max.
	*/
	randXY: function(min,max){
		return min+this.rand(max-min+1);
	},
	/** Returns String with converted base of Number.
	* this._aid.toBase(-29,16) = &quot;-1d&quot;
	*/
	toBase: function(n,bas,from){
		return parseInt(n,from || 10).toString(bas);
	},
	/** Returns String with converted base of Number. Programmers version.
	* this._aid.toBaseSign(-29,16) = &quot;-0xffffe3&quot;
	*/
	toBaseSign: function(n,bas){
		return (n&lt;0?&quot;-&quot;:&quot;&quot;)+(bas===16?&quot;0x&quot;:&quot;&quot;)+(parseInt((n&lt;0?(0xffffffffffff+n)+1:n),10)&amp;0xffffff).toString(bas);
	},
	/** Returns String with a leading zero if n&lt;10.
	*/
	toLZ: function(n){
		return((n!==null&amp;&amp;n&lt;10&amp;&amp;n&gt;=0?&quot;0&quot;:&quot;&quot;)+n);
	},
	/** Returns String with a leading zeros if n&lt;100.
	*/
	toLZZ: function(n){
		return(n!==null&amp;&amp;n&lt;100&amp;&amp;n&gt;=0?&quot;0&quot;+this.toLZ(n):&quot;&quot;+n);
	},
	/** Returns String with specified length filled with leading zeros.
	*/
	toNLZ: function(n,len){
		return (&quot;0000000000000000&quot;+n).substr(-len);
	},
	/** Returns rounded Number with specified precision.
	*/
	toPrec: function(n,p){
		if(!n) return 0;
		var y = Math.pow(10,p);
		return Math.round(n*y)/y;
	},

	// ***** String *****
	/** Returns reverted String.
	*/
	strRev: function(str){
		if(!str) return &quot;&quot;;
		var i = str.length, res = &quot;&quot;;
		while(i--) res += str[i];
		return res;
	},
	/** Returns random String with specified length.
	*/
	strRND: function(len,chars){
		chars = chars || &#39;abcdefghijklmnopqrstuvwxyz&#39;;
		var res = &#39;&#39;, rndPos;
		for(var i=0;i&lt;len;i++){
			rndPos = Math.floor(Math.random()*chars.length);
			res += chars.substring(rndPos,rndPos+1);
		}
		return res;
	},
	/** Returns random numbered String with specified length.
	*/
	strRNDInt: function(len){
		var res = String(1000000000+Math.random()*1000000000 | 0);
		return res.substr(0,len);
	},
	/** Returns trimmed String. Unlike .trim() it also removes control chars.
	*/
	strTrim: function(str){
		return str.replace(/[\f\r\n\t\v]/g,&quot;&quot;).trim();
	},

	// ***** Array *****
	/** Merges nested Arrays
	*/
	arrConcat: function(arrA,arrB){
		if(this.typeGet(arrB)!==&quot;array&quot;) return arrA;
		var res = arrA.slice(0), na = arrB.slice(0);
		var la = res.length, lb = na.length;
		for(var i=0;i&lt;lb;i++){
			if(i&gt;la-1) break;
			if(this.typeGet(na[i])===&quot;array&quot;) res[i] = res[i].concat(na[i]);
		}
		return res;
	},
	/** Returns difference between Arrays. Strict equality.
	*/
	arrDiff: function(a,b,oneway){
		var res = [], i = a.length;
		while(i--) if(b.indexOf(a[i])===-1) res.push(a[i]);
		if(oneway) return res;
		i = b.length;
		while(i--) if(a.indexOf(b[i])===-1) res.push(b[i]);
		return res;
	},
	/** Returns flattened Array.
	*/
	arrFlat: function(arr){
		return this._arrFlatten(arr,[]);
	},
	/** Returns Array with min and max of flat input Array containing only numbers.
	*/
	arrMinMax: function(arr){
		return [Math.min.apply(Math,arr),Math.max.apply(Math,arr)];
	},
	/** Returns Array without specified element. Strict equality.
	*/
	arrOmit: function(arr,ele){
		var len = arr.length, res = arr.slice(0);
		for(var i=0;i&lt;len;i++){
			if(res[i]===ele) res.splice(i,1);
		}
		return res;
	},
	/** Returns shuffled Array.
	*/
	arrShuffle: function(arr){
		var j,k,t, res = arr.slice(0);
		j = res.length;
		do{
			k = (Math.random()*(j--))&lt;&lt;0;
			t = res[j];
			res[j] = res[k];
			res[k] = t;
		} while(j);
		return res;
	},
	/** Returns sorted Array of Objects. Selectionsort.
	*/
	arrSortBy: function(arr,prop){
		var res = arr.slice(0), len = res.length, min,i,j;
		for(i=0;i&lt;len;i++){
			min = i;
			for(j=i+1;j&lt;len;j++){
				if(j&gt;0 &amp;&amp; j&lt;len &amp;&amp; res[j][prop]&lt;res[min][prop]) min = j;
			}
			if(i!==min) this._arrSwap(res,i,min);
		}
		return res;
	},
	/** Merges Arrays.
	*/
	arrUnion: function(){
		var len = arguments.length, res = [];
		while(len--){
			var arg = arguments[len];
			for(var i=0;i&lt;arg.length;i++){
				var ele = arg[i];
				if(res.indexOf(ele)===-1) res.push(ele);
			}
		}
		return res;
	},
	/** Returns Array with unique entries. Strict equality.
	*/
	arrUnique: function(arr){
		var res = arr.slice(0), len = res.length, i = -1;
		while(i++&lt;len){
			var j = i+1;
			for(;j&lt;res.length;++j){
				if(res[i]===res[j]) res.splice(j--,1);
			}
		}
		return res;
	},

	// ***** Object *****
	/** Return deep cloned Object.
	*/
	objClone: function(obj){
		if(typeof obj!==&#39;object&#39; || obj===null) return obj;
		var res = obj.constructor();
		for(var i in obj) res[i] = this.objClone(obj[i]);
		return res;
	},
	/** Deep freeze Object. In-place.
	*/
	objFreeze: function(obj){
		var prop, propKey;
		Object.freeze(obj);
		for(propKey in obj){
			prop = obj[propKey];
			if(!obj.hasOwnProperty(propKey) || typeof prop!==&quot;object&quot; || Object.isFrozen(prop)) continue;
			this.objFreeze(prop);
		}
	},
	/** Returns value of the Objects member in the specified path or null.
	*/
	objGet: function(obj,path){
		var a = this.objGrab(obj,path);
		if(!a[0] || !a[1]) return null;
		return a[0][a[1]];
	},
	/** Returns Array with Object and key following the specified path.
	*/
	objGrab: function(obj,path){
		var p = path.split(&quot;.&quot;), len = p.length-1, last = p.pop(), o = obj;
		if(len&lt;1) return [obj,last];
		for(var i=0;i&lt;len;i++) o = this._objRet(o,p[i]);
		return [o,last];
	},
	/** Lock object, but leave expandable.
	*/
	objLock: function(obj){
		var props = Object.getOwnPropertyNames(obj);
		for(var i=0;i&lt;props.length;i++){
			var desc = Object.getOwnPropertyDescriptor(obj,props[i]);
			if(&quot;value&quot; in desc) desc.writable = false;
			desc.configurable = false;
			Object.defineProperty(obj,props[i],desc);
		}
	},
	/** Returns merged object. In-place.
	*/
	objMerge: function(target,obj,omit){
		for(var key in obj){
			if(!this._objHasOwn(obj,key)) continue;
			if(omit &amp;&amp; !this._objHasOwn(target,key)) continue;
			var val = obj[key];
			if(typeof target[key]===&quot;object&quot;){
				if(!target[key]) target[key] = this.objClone(val);
				else target[key] = this.objMerge(target[key] || {},val);
			} else target[key] = this.objClone(val);
		}
		return target;
	},
	/** Returns deep merged object. In-place.
	*/
	objMergeDeep: function(orig,objects){
		if(typeof orig!==&quot;object&quot;) orig = {};
		var len = arguments.length, target = this.objClone(orig);
		for(var i=1;i&lt;len;i++){
			var val = arguments[i];
			if(typeof val===&quot;object&quot;) this.objMerge(target,val);
		}
		return target;
	},
	/** Passes value to Function in Object following the specified path. Returns true or false.
	*/
	objPass: function(obj,path,val){
		var a = this.objGrab(obj,path);
		if(!a[0] || !a[1]) return false;
		if(typeof a[0][a[1]]===&#39;function&#39;){
			a[0][a[1]](val);
			return true;
		}
		return false;
	},
	/** Passes value to Function in Object following the specified path. Returns returned value.-)
	*/
	objRequest: function(obj,path,val){
		var a = this.objGrab(obj,path);
		if(!a[0] || !a[1]) return false;
		if(typeof a[0][a[1]]===&#39;function&#39;) return a[0][a[1]](val);
		return false;
	},
	/** Deep seal Object. In-place.
	*/
	objSeal: function(obj){
		var prop, propKey;
		Object.seal(obj);
		for(propKey in obj){
			prop = obj[propKey];
			if(!obj.hasOwnProperty(propKey) || typeof prop!==&quot;object&quot; || Object.isSealed(prop)) continue;
			this.objSeal(prop);
		}
	},
	/** Sets value in Object following the specified path. Returns true or false.
	*/
	objSet: function(obj,path,val){
		var a = this.objGrab(obj,path);
		if(!a[0] || !a[1]) return false;
		if(!a[1]){
			obj[path] = val;
			return true;
		}
		a[0][a[1]] = val;
		return true;
	},

	// ***** Type *****
	/** Returns lowercase type of Argument for JS native and Oolites classes.
	*/
	typeGet: function(obj){
		var t = typeof obj;
		switch(t){
			case &#39;undefined&#39;:
			case &#39;boolean&#39;:
			case &#39;number&#39;:
			case &#39;string&#39;:
			case &#39;function&#39;: return t;
		}
		if(!obj) return null;
		t = Object.prototype.toString.call(obj).substr(8).replace(&quot;]&quot;,&quot;&quot;);
		return t.toLowerCase();
	},

	// ***** AddOn *****
	/** Checks required worldScripts and versions. The Array req is expected to contain two elements
	* (name and version) per check and version must be null for legacy scripts or if you want to
	* check only for existance!
	* Note: Checks property &#39;$deactivated&#39; in scripts.
	*/
	addOnVersion: function(who,req,quiet){
		var ok,ws, len = req.length, res = [];
		for(var i=0;i&lt;len;i+=2){
			ok = 1;
			ws = worldScripts[req[i]];
			if(typeof ws===&#39;undefined&#39;) ok = 0;
			else if(ws.$deactivated || (req[i+1] &amp;&amp; !this.cmpVersion(ws.version,req[i+1]))) ok = 0;
			if(!ok){
				if(!quiet){
					if(!req[i+1]) this._addOnVersion(who,req[i],null);
					else this._addOnVersion(who,req[i],req[i+1]);
				}
			}
			res.push(ok);
		}
		return res;
	},
	/** Clears specified missionVariables.
	*/
	clrMVs: function(arr){
		var i = 0, l = arr.length;
		for(i;i&lt;l;i++) missionVariables[arr[i]] = null;
		return;
	},
	/** Delete specified properties.
	*/
	clrProps: function(where,arr){
		var i = 0, l = arr.length;
		for(i;i&lt;l;i++) delete worldScripts[where][arr[i]];
		return;
	},
	/** Compares dotted version Strings. Strips pre-/suffixes in first argument.
	* Returns 0 if smaller, 1 if equal and 2 if bigger.
	* JS native .localeCompare() may be another option.
	*/
	cmpVersion: function(act,exp){
		var x = act.replace(/[^\d\.]/g,&quot;&quot;).split(&#39;.&#39;),y = exp.split(&#39;.&#39;);
		if(!x.length) return 0;
		for(var i=0;i&lt;x.length;i++){
			if(i&gt;y.length-1 || x[i]&gt;y[i]) return 2;
			if(x[i]&lt;y[i]) return 0;
		}
		return 1;
	},

	// ***** Screens *****
	/** Returns aligned String.
	* e.g. this._aid.scrAddLine([ [&quot;First&quot;,8],[&quot;Second&quot;,8],[&quot;Third&quot;,8] ],&quot;&quot;,&quot;\n&quot;);
	*/
	scrAddLine: function(line,sep,brk){
		if(!line){
			if(brk) return brk;
			return &quot;&quot;;
		}
		var le = line.length,res = &quot;&quot;,coun = 0,tmp;
		for(var i=0;i&lt;le;i++){
			if(coun&gt;30) break;
			tmp = this.scrToWidth(line[i][0],line[i][1],&quot;&quot;,1);
			res += tmp[0]+(sep?sep:&quot;&quot;);
			coun += tmp[1];
			if(sep===&quot;\n&quot;) coun = 0;
		}
		if(brk) res += brk;
		return res;
	},
	/** Sets unselectable flag for missionscreen choices. In-place.
	*/
	scrChcUnsel: function(opt,key){
		if(typeof opt[key]===&#39;string&#39;) opt[key] = {text:opt[key],unselectable:true};
		else if(typeof opt[key]===&#39;object&#39;) opt[key].unselectable = true;
		return opt;
	},
	/** Returns String with linebreaks up to max.
	*/
	scrFillLines: function(cur,max){
		var res = &quot;&quot;;
		for(var i=cur;i&lt;max;i++) res += &quot;\n&quot;;
		return res;
	},
	/** Returns String with specified length in em.
	* Truncated if width &gt; max, otherwise filled up with space or chr.
	*/
	scrToWidth: function(str,max,chr,ret,rgt){
		if(typeof str===&#39;object&#39; &amp;&amp; str) str = str.toSource();
		str = String(str);
		var l = defaultFont.measureString(str),c,d;
		if(max&lt;1){
			if(ret) return [str,l];
			return str;
		}
		if(chr) c = defaultFont.measureString(chr);
		if(l&gt;max){
			while(l&gt;max){
				if(str &amp;&amp; str.length&gt;1) str = str.substr(0,str.length-1);
				d = defaultFont.measureString(str);
				l = d;
			}
		}
		if(l&lt;max){
			while(l&lt;max){
				if(chr &amp;&amp; c&lt;max-l){
					str += chr;
					l += c;
				} else {
					if(max-l&gt;this.spcsw){
						if(rgt) str = this.spcs+str;
						else str += this.spcs;
						l += this.spcsw;
					} else {
						if(max-l&gt;this.spcw){
							if(rgt) str = this.spc+str;
							else str += this.spc;
							l += this.spcw;
						} else break;
					}
				}
			}
		}
		if(ret) return [str,l];
		return str;
	},

	// ***** Oolite *****
	/** Returns Object with width, height, gcd and ratio of screen window.
	*/
	ooScreen: function(){
		var g = this._ooGame(),w,h,d,a;
		w = g.gameWindow.width;
		h = g.gameWindow.height;
		d = this.gcd(w,h);
		a = w/h;
		return {width:w,height:h,gcd:d,ratio:a};
	},
	/** Returns shader support level.
	*/
	ooShaders: function(){
		var g = this._ooGame();
		if(g.wireframeGraphics) return 0;
		switch(g.detailLevel){
			case &#39;DETAIL_LEVEL_MINIMUM&#39;:
			case &#39;DETAIL_LEVEL_NORMAL&#39;: return 0;
			case &#39;DETAIL_LEVEL_SHADERS&#39;: return 1;
			case &#39;DETAIL_LEVEL_EXTRAS&#39;: return 2;
			default: return 0;
		}
	},
	/** Returns Object with width and height to be used for images
	* x and y are width and height in pixels, zoom any number or 0.
	* Author: Norbert Nagy.
	*/
	ooImageScale: function(x,y,zoom){
		var he = 480, wi = 0, o = this.ooScreen();
		if(x&gt;0 &amp;&amp; y&gt;0){
			if(o.ratio&gt;=x/y){
				if(zoom&lt;0) wi = 0;
				else {
					if(zoom) he = 0;
					wi = o.ratio*480;
				}
			} else if(zoom&lt;0){
				he = 0;
				wi = o.ratio*480;
			} else if(!zoom) wi = o.ratio*480;
		}
		if(!wi &amp;&amp; he&gt;0) wi = null;
		else if(wi&gt;0 &amp;&amp; !he) he = null;
		return {height:he,width:wi};
	},

	// ***** Entities *****
	/** Spawns VisualEffect in front of (or behind) the player.
	*/
	entFXCreate: function(ent,mul){
		return system.addVisualEffect(ent,player.ship.position.add(player.ship.vectorForward.multiply(mul)));
	},
	/** Sets main texture for entity.
	*/
	entSetMainTex: function(ent,tex){
		var ta = ent.getMaterials(), tb = Object.keys(ta), tc = ta[tb[0]].textures;
		if(!tc) return false;
		if(typeof tc[0] === &#39;string&#39;) ta[tb[0]].textures[0] = tex;
		else ta[tb[0]].textures[0].name = tex;
		ent.setMaterials(ta);
	},
	setMaterials: function(ent,obj){
		if(obj.mat &amp;&amp; obj.sha) ent.setMaterials(obj.mat,obj.sha);
		else if(obj.mat) ent.setMaterials(obj.mat,{});
		else if(obj.sha) ent.setMaterials({},obj.sha);
		return true;
	},

	// ***** Helper *****
	_addOnVersion: function(w,r,v){
		log(&quot;Check&quot;,w+&quot; requirement not matched : &quot;+r+(v?&quot; required min. version &quot;+v:&quot;&quot;)+&quot; not found.&quot;);
		return;
	},
	_arrFlatten: function(arr,res){
		var len = arr.length, i = -1;
		while(len--){
			var cur = arr[++i];
			if(Array.isArray(cur)) this._arrFlatten(cur,res);
			else res.push(cur);
		}
		return res;
	},
	_arrSwap: function(arr,f,s){
		var temp = arr[f];
		arr[f] = arr[s];
		arr[s] = temp;
	},
	_chkGlobal: function(){
		var a = Object.getOwnPropertyNames(global), warn=[], t, ok = expandMissionText(&quot;LIBC_GLOB&quot;).split(&quot;|&quot;);
		for(var i=0;i&lt;a.length;i++) if(ok.indexOf(a[i])===-1) warn.push(a[i]);
		if(warn.length){
			log(&quot;WARNING&quot;,&quot;Warning! Global namespace polluted by:&quot;);
			t = JSON.stringify(warn);
			log(&quot;WARNING&quot;,t);
		}
	},
	_cmpNum: function(a,b){return a-b;},
	_cmpGen: function(a,b){return (b&lt;a)-(a&lt;b);},
	_cmpObjKey: function(a,b,k){return a[k]-b[k];},
	_cmpArrKey: function(a,b){return a[0]-b[0];},
	_getMat: function(ent){
		var ta = ent.getMaterials(),tb = Object.keys(ta);
		return ta[tb[0]];
	},
	// Collecting the data + Class A algorithm is expensive.
	_getConnected: function(gal,sys,coo){
		var gn = galaxyNumber,
			id = system.ID,
			cpp = player.ship.galaxyCoordinatesInLY,
			check = [], cur = [], gInfo = [],
			c,cp,dist,len,i,o,r,s,t,u,w;
		if(typeof gal===&#39;number&#39;){
			gn = gal;
			cpp = coo;
			id = sys;
		}
		// Collect coordinates
		for(i=0;i&lt;256;i++){
			c = System.infoForSystem(gn,i).coordinates;
			r = {x: c.x, y: c.y, id: i, done: 0};
			gInfo.push(r);
		}
		cp = {x: cpp.x, y: cpp.y, z: 0};
		gInfo = this.arrSortBy(gInfo,&quot;x&quot;);
		this.$connections[gn] = [];
		// Start loop
		for(u=0;u&lt;256;u++){
			t = gInfo[u];
			if(t.x&gt;cp.x+7.15) break;
			if(t.x&lt;cp.x-7.15 || t.y&lt;cp.y-7.15 || t.y&gt;cp.y+7.15) continue;
			dist = Math.sqrt((cp.x-t.x)*(cp.x-t.x)+(cp.y-t.y)*(cp.y-t.y));
			if(dist&lt;7.341) cur.push(t);
		}
		// Grow
		while(cur.length){
			check = check.concat(cur);
			cur = [];
			for(o=0;o&lt;check.length;o++){
				cp = check[o];
				if(cp.id===id || cp.done) continue;
				for(i=0;i&lt;256;i++){
					t = gInfo[i];
					if(t.x&gt;cp.x+7.15) break;
					if(t.x&lt;cp.x-7.15 || t.y&lt;cp.y-7.15 || t.y&gt;cp.y+7.15) continue;
					dist = Math.sqrt((cp.x-t.x)*(cp.x-t.x)+(cp.y-t.y)*(cp.y-t.y));
					if(dist&lt;7.341 &amp;&amp; check.indexOf(t)===-1 &amp;&amp; cur.indexOf(t)===-1) cur.push(t);
				}
			}
			len = check.length;
			for(w=0;w&lt;len;w++) check[w].done = 1;
		}
		len = check.length;
		for(s=0;s&lt;len;s++) this.$connections[gn].push(check[s].id);
	},
	_objHasOwn: function(obj,key){return Object.prototype.hasOwnProperty.call(obj,key);},
	_objRet: function(obj,prop){
		if(obj[prop] &amp;&amp; typeof obj[prop]===&#39;object&#39;) return obj[prop];
		return obj;
	},
	_ooGame: function(){return oolite.gameSettings;},
	_sanity: function(){return {changed:this.$entCstChanged,removed:this.$entCstRemoved,strength:this.$entLastStrength,patched:this.$entCstPatched};},
	_shuffle: function(){return 0.5-Math.random();}
};
/* Do before startUp. These features are useful for other OXPs, but are somewhat slow
	and it&#39;s better to have it done only once instead of slow code in lots of OXPs.
*/
this._lib = new this._libMain(); // Create instance
this._lib.$ships = Ship.keys().sort();

this.startUp = this.playerEnteredNewGalaxy = function(){
	this._lib._getConnected();
};
this.missionScreenOpportunity = function(){
	delete this.missionScreenOpportunity;
	this._lib._chkGlobal();
	this.shipWillExitWitchspace();
};
this.shipWillExitWitchspace = function(){
	system.addShips(&#39;lib_test&#39;,1,[99999999,99999999,99999999],15000);
};

}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_MissionCoord.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global galaxyNumber,log,system,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_MissionCoord&quot;;

// TODO: use $missionActive in Lib_Main
this.$pool = [];
this.startUp = function(){
	delete this.startUp;
	this._bSearch = new worldScripts.Lib_BinSearch._lib_BinSearch();
	this.$checked = false;
	this.$isMission = false;
	this.$dbg = false;
};
this._prepare = function(){
	var s = [],r = this.$pool.length;
	if(r){
		var merged = [],pos=0;
		for(var m=0;m&lt;r;m++){
			s = this.$pool[m];
			if(s.length!==2 || !s[1].name || typeof s[1].name!==&#39;string&#39; || !s[1].func || typeof s[1].func!==&#39;string&#39;) continue;
			if(s[1].hasOwnProperty(&quot;incOXP&quot;)){
				var temp = s[1].incOXP;
				for(var i=0;i&lt;temp.length;i++){
					if(worldScripts[temp[i]]!==&#39;undefined&#39;){
						log(this.name,&quot;Dropping token &quot;+s[0]+&quot; : &quot;+s[1].name+&quot;.&quot;+s[1].func+&quot; because of incompatibility with &quot;+temp[i]+&quot;.&quot;);
						continue;
					}
				}
			}
			if(!s[1].hasOwnProperty(&quot;mutalEx&quot;) || typeof s[1].mutalEx!==&#39;number&#39;) s[1].mutalEx = 0;
			pos = merged.indexOf(s[0]);
			if(pos===-1) merged.push(s[0],{0:s[1]});
			else {
				var q = merged[pos+1];
				for(var p=1;p&lt;10;p++){
					if(q.hasOwnProperty(p)) continue;
					q[p] = s[1];
					break;
				}
			}
		}
		r = merged.length;
		for(var j=0;j&lt;r;j+=2){
			this._bSearch.add(merged[j],merged[j+1]);
		}
		if(this.$dbg) log(this.name,&quot;merged: &quot;+JSON.stringify(merged));
	} else {
		delete this._performCheck;
		delete this.shipWillExitWitchspace;
		delete this.shipWillLaunchFromStation;
		this.$checked = true;
	}
	delete this.alertConditionChanged;
	delete this.guiScreenChanged;
	delete this._prepare;
};
this._performCheck = function(early){
	this.$checked = true;
	if(this.$isMission) return;
	var test = system.description,prop;
	var pRand = Math.floor(100*system.scrambledPseudoRandomNumber(system.ID));
	var rest = test.replace(/[^a-zA-Z]/g,&#39; &#39;);
	rest = rest.split(&quot; &quot;);
	rest = worldScripts.Lib_Main._lib.arrUnique(rest);
	var fflag = false, l = rest.length, muteGroup = [];
	for(var s=0;s&lt;l;s++){
		fflag = this._bSearch.contains(rest[s]);
		if(fflag){
			for(prop in fflag){
				var c = fflag[prop];
				if((early &amp;&amp; !c.early) || (!early &amp;&amp; c.early)) continue;
				if(muteGroup.indexOf(c.mutalEx)!==-1) continue;
				if(c.chance &amp;&amp; Math.random()&gt;c.chance) continue;
				if(c.gal &amp;&amp; c.gal.indexOf(galaxyNumber)===-1) continue;
				if(c.ID &amp;&amp; c.ID.indexOf(system.ID)===-1) continue;
				if(c.gov &amp;&amp; c.gov.indexOf(system.government)===-1) continue;
				if(c.seeds &amp;&amp; c.seeds.indexOf(pRand)===-1) continue;
				if(c.exToken &amp;&amp; rest.indexOf(c.exToken)!==-1) continue;
				if(this.$dbg) log(this.name,&quot;check: &quot;+c.name+&quot; - muteGroup: &quot;+c.mutalEx+&quot; rest[s]:&quot;+rest[s]);
				if(worldScripts[c.name]){
					var act = false;
					if(c.func &amp;&amp; worldScripts[c.name][c.func]) act = worldScripts[c.name][c.func](rest[s]);
					if(act){
						muteGroup.push(c.mutalEx);
						this.$isMission = true;
					}
				}
			}
		}
	}
};
this.alertConditionChanged = this.guiScreenChanged = function(){
	if(this._prepare) this._prepare();
	if(!this.$checked &amp;&amp; this._performCheck) this._performCheck();
};
this.shipWillExitWitchspace = function(){
	this.$isMission = false;
	if(this._performCheck) this._performCheck(1);
};
this.shipExitedWitchspace = function(){
	if(this._performCheck) this._performCheck();
};
this.shipWillLaunchFromStation = function(){
	if(this._prepare) this._prepare();
	if(!this.$checked &amp;&amp; this._performCheck) this._performCheck(1);
};
this.shipLaunchedFromStation = function(){
	if(!this.$checked &amp;&amp; this._performCheck) this._performCheck();
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Music.js</td>
                    <td><pre>/* jshint forin:false, bitwise:false */
/* global Sound,SoundSource,Timer,clock,guiScreen,mission,missionVariables,player,system,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Music&quot;;
this.copyright = &quot;(C)2016-2018&quot;;
this.description = &quot;Event-driven and generic music handling.&quot;;

this.$E0 = 0;
this.$inf = {
	Name:&quot;Lib_Music&quot;,Display:&quot;Music-Config&quot;,Alive:&quot;$inf&quot;,Alias:&quot;Library&quot;,
	SInt:{S0:{Name:&quot;$dub.vol&quot;,Def:0.8,Min:0,Max:1,Float:true,Desc:&quot;Volume&quot;,Notify:&quot;_updateVol&quot;}},
	EInt:{E0:{Name:&quot;$E0&quot;,Def:0,Min:0,Max:1,Hide:true,Desc:[&quot; &quot;]},Info:&quot;No AddOn installed.&quot;,Notify:&quot;_buildList&quot;}
};
this.$act = {
	generic:0
};
this.$groupIDs = [];
this.$radios = [];
this.$media = {
	aegis:{enter:[],exit:[]},
	alert:{red:[]},
	docked:{main:[],any:[]},
	exitWS:{inter:[],goneNova:[],doNova:[],standard:[]},
	killed:{any:[]},
	launch:{inter:[],goneNova:[],doNova:[],main:[],any:[]},
	planetIn:{enterMain:[],enterSun:[],any:[]},
	planetOut:{exitMain:[],exitSun:[],any:[]},
	radio:{generic:[]},
	rescued:{any:[]},
	scooped:{any:[]},
	scoopFuel:{fuel:[]}
};
this.$dub = {
	auto:0,
	channel:null,
	cnt:0,
	cur:null,
	dur:0,
	ent:null,
	hand:null,
	kick:0,
	lockAlert:1,
	lockDock:0,
	lockFuel:1,
	lockKill:1,
	lockPlanet:1,
	now:0,
	queue:[],
	radio:null,
	reinit:0,
	spec:null,
	vol:0.8
};
this.startUp = function(){
	delete this.startUp;
	var mus;
	this._aid = worldScripts.Lib_Main._lib;
	this.$snd = new SoundSource();
	this.$snd.sound = &quot;lib_music_fade.ogg&quot;;
	if(missionVariables.LIB_MUSIC){
		mus = JSON.parse(missionVariables.LIB_MUSIC);
		this.$dub.vol = mus.vol;
		this.$snd.volume = mus.vol;
	}
};
this.playerWillSaveGame = function(){
	var t, s = [], ind, mus = {};
	if(this.$E0){
		t = [].concat(this.$inf.EInt.E0.Desc);
		for(var i=0;i&lt;t.length;i++){
			ind = Math.pow(2,i);
			if(this.$E0&amp;ind) s.push(t[i]);
		}
		if(s.length&gt;24) s.length = 24;
		missionVariables.LIB_RADIO = JSON.stringify(s);
	} else missionVariables.LIB_RADIO = null;
	mus.vol = this.$dub.vol;
	missionVariables.LIB_MUSIC = JSON.stringify(mus);
};
/** Expects Object with the structure of this.$media (can be partial),
* except radio. The Arrays contain Objects with members:
* {snd: &lt;filename&gt;, dur: duration seconds &lt;integer&gt;, vol: optional, volume 0...1 &lt;float&gt;}
*/
this._addEventMusic = function(obj,ID){
	if(!obj || typeof obj!==&quot;object&quot; || typeof ID!==&quot;string&quot;) return false;
	var c = this._aid.objClone(obj);
	for(var h in c){
		if(!this.$media[h] || h===&quot;radio&quot;) continue;
		for(var s in c[h]){
			if(s===&quot;any&quot; &amp;&amp; !this.$media[h][s]) continue;
			if(!this.$media[h][s]) this.$media[h][s] = [];
			for(var i=0;i&lt;c[h][s].length;i++){
				c[h][s][i].act = ID;
				this.$media[h][s].push(c[h][s][i]);
			}
		}
	}
	if(this.$actClone){
		this.$actClone[ID] = 0;
		this.$act[ID] = 0;
	} else if(typeof this.$act[ID]!==&quot;number&quot;) this.$act[ID] = 0;
	if(this.$groupIDs.indexOf(ID)===-1) this.$groupIDs.push(ID);
	return true;
};
/** Toggle status for group ID.
* - ID: Name &lt;string&gt;
*/
this._toggleGroup = function(ID){
	var a = this.$act;
	if(typeof a[ID]!==&quot;number&quot;) return false;
	if(this.$actClone) a = this.$actClone;
	if(!a[ID]) a[ID] = 1;
	else a[ID] = 0;
	return a[ID];
};
/** Take priority for the specified GroupID.
* - ID: Name &lt;string&gt;
*/
this._setPriorityGroup = function(ID){
	var g,i,l;
	if(typeof this.$act[ID]!==&quot;number&quot;) return false;
	this._clrPriorityGroup();
	this.$actClone = this._aid.objClone(this.$act);
	g = this.$groupIDs;
	l = g.length;
	for(i=0;i&lt;l;i++) this.$act[g[i]] = 0;
	this.$act[ID] = 1;
	return true;
};
/** Clear priority.
*/
this._clrPriorityGroup = function(){
	if(this.$actClone) this.$act = this.$actClone;
	delete this.$actClone;
	return;
};
/** Add radio channel or merges. Expects Object with members:
* - name: Channel name &lt;string&gt;. Can be generic, docking, fight, (docked) entity name or a custom channel
* - sounds: Array of Objects with {snd: &lt;filename&gt;, dur: duration seconds &lt;integer&gt;, vol: optional, volume &lt;float&gt;}
* - radio: If set channel name will be listed in this.$radios
*/
this._addChannel = function(obj){
	var c = this._aid.objClone(obj),i,len=obj.sounds.length;
	if(!this.$media.radio[c.name]) this.$media.radio[c.name] = [];
	for(i=0;i&lt;len;i++){
		c.sounds[i].act = c.name;
		this.$media.radio[c.name].push(c.sounds[i]);
	}
	if(this.$actClone){
		this.$actClone[c.name] = 1;
		this.$act[c.name] = 0;
	} else this.$act[c.name] = 1;
	if(c.radio &amp;&amp; this.$radios.indexOf(c.name)===-1) this.$radios.push(c.name);
	return true;
};
/** Sets or clears custom radio channel.
* - str: Channel name &lt;string&gt; or null.
*/
this._setChannel = function(str){
	var d = this.$dub;
	switch(typeof str){
		case &quot;string&quot;: if(typeof this.$act[str]===&quot;number&quot; &amp;&amp; typeof this.$media.radio[str]!==&quot;undefined&quot;) d.channel = str; break;
		case &quot;object&quot;: if(!str) d.channel = null; break;
	}
	return d.channel;
};
this._buildList = function(){
	var c = this.$radios, l = c.length, ind, d = [];
	for(var i=0;i&lt;l;i++){
		ind = Math.pow(2,i);
		if(this.$E0&amp;ind) d = d.concat(this.$media.radio[c[i]]);
	}
	if(this.$E0 &amp;&amp; d.length){
		this._addChannel({name:&quot;RadioPlaylist&quot;,sounds:[]});
		this.$media.radio.RadioPlaylist = d;
		this._setChannel(&quot;RadioPlaylist&quot;);
	} else this.$dub.channel = null;
};
this._updateInf = function(){
	var c = this.$radios, l = c.length, max = Math.pow(2,l)-1, o = this.$inf.EInt;
	o.E0.Max = max&amp;0xffffff;
	o.E0.Desc = [].concat(c);
	if(l){
		o.E0.Hide = false;
		o.Info = &quot;Push selected radio channels to main playlist.&quot;;
	}
};
this._updateVol = function(){
	var d = this.$dub, mus, vol, cvol=1, i;
	if(d.cur){
		mus = Sound.musicSoundSource();
		vol = d.vol;
		if(mus.isPlaying){
			for(i=0;i&lt;d.queue.length;i++){
				if(d.queue[i].snd===d.cur){
					if(d.queue[i].vol) cvol = d.queue[i].vol;
					break;
				}
			}
			mus.volume = vol*cvol;
		}
	}
	this.$snd.volume = d.vol;
};
this._selectGeneric = function(d){
	if(d.channel){
		d.queue = this.$media.radio[d.channel];
		d.spec = &quot;generic&quot;;
	} else {
		if(d.radio){
			d.queue = this.$media.radio[d.radio];
			d.spec = d.radio;
		} else {
			d.queue = this.$media.radio.generic;
			d.spec = &quot;generic&quot;;
		}
	}
	d.hand = &quot;radio&quot;;
	d.now = 0;
};
this._resetTimer = function(t){
	if(this.$mediaTimer) this.$mediaTimer.stop();
	this.$mediaTimer = null;
	if(typeof t===&quot;number&quot;) this.$mediaTimer = new Timer(this,this._doPlay,t,1);
};
this._doPlay = function(q,d){
	var sel,r,found,vol;
	if(!d) d = this.$dub;
	d.cnt++;
	if(!q){
		q = [];
		if(d.lockDock &amp;&amp; player.ship.isValid &amp;&amp; player.ship.docked){
			d.lockDock = 0;
			this.shipDockedWithStation(player.ship.dockedStation);
			return;
		}
	}
	if(d.cnt&gt;d.dur){
		if(!d.now &amp;&amp; d.hand===&quot;radio&quot;) this._selectGeneric(d);
		if(!q.length){
			this._selectGeneric(d);
			q = d.queue;
			if(q.length) found = 1;
		} else found = 1;
		if(found){
			if(d.now &amp;&amp; d.kick) this.$snd.play();
			// TODO: selection
			r = Math.floor(Math.random()*q.length);
			sel = q[r];
			vol = d.vol;
			if(sel.vol) vol *= sel.vol;
			Sound.playMusic(sel.snd,false,vol);
			d.dur = sel.dur;
			d.cnt = d.dur-2;
			d.cur = sel.snd;
		} else {
			d.dur = 1;
			d.cnt = 0;
		}
		d.ent = null;
		d.now = 0;
		d.kick = 0;
		if(found) this._resetTimer(d.dur+this._aid.randXY(13,22));
		else this._resetTimer();
		if(d.hand!==&quot;radio&quot;) return d.dur;
		else return 10;
	} else d.hand = &quot;radio&quot;;
	return 0;
};
this._performMedia = function(hand,spec,ent){
	var d = this.$dub,i,q=[],len,w, add = this.$media[hand].any, any = 1;
	if(hand!==&quot;alert&quot; &amp;&amp; guiScreen===&quot;GUI_SCREEN_MISSION&quot;) return 0;
	if(!ent &amp;&amp; d.radio===&quot;fight&quot; &amp;&amp; player.alertHostiles &amp;&amp; hand!==&quot;killed&quot;) return 0;
	if(ent &amp;&amp; this.$media[hand][ent]){
		w = this.$media[hand][ent];
		if(w.length) any = 0;
	} else w = this.$media[hand][spec];
	if((!w || !w.length) &amp;&amp; any &amp;&amp; add){
		if(w) w = w.concat(add);
		else w = add;
	}
	if(w){
		len = w.length;
		// TODO: move the hard work to _toggleGroup and _setPriorityGroup
		for(i=0;i&lt;len;i++){
			if(this.$act[w[i].act]) q.push(w[i]);
		}
		if(q.length){
			d.cnt = 1;
			d.dur = 0;
			d.hand = hand;
			d.spec = spec;
			d.queue = q;
			if(ent) d.ent = ent;
			else d.ent = null;
			d.now = 1;
			return this._doPlay(q,d);
		}
	}
	d.kick = 0;
	return 10;
};
// Handler
this.alertConditionChanged = function(to){
	var c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace) return;
	switch(to){
		case 1:
		case 2: 
			if(d.radio===&quot;fight&quot;) d.radio = &quot;generic&quot;;
			break;
		case 3:
			if(c&gt;=d.lockAlert){
				d.kick = 1;
				d.lockAlert = c+this._performMedia(&quot;alert&quot;,&quot;red&quot;);
			}
			if(this.$media.radio.fight){
				d.radio = &quot;fight&quot;;
				if(!this.$mediaTimer || !this.$media.alert.red.length) this._resetTimer(0);
			}
			break;
	}
};
this.playerRescuedEscapePod = function(fee,reason,occupant){
	var c = clock.absoluteSeconds;
	if(!occupant || !occupant.name || c&lt;this.$dub.lockDock) return;
	this.$dub.lockDock = clock.absoluteSeconds+this._performMedia(&quot;rescued&quot;,&quot;ent&quot;,occupant.name);
};
this.shipDockedWithStation = function(station){
	var c = clock.absoluteSeconds, d = this.$dub;
	this._clrLock();
	if(!station) return;
	if(this.$media.radio[station.name]) d.radio = station.name;
	else d.radio = &quot;generic&quot;;
	if(c&lt;d.lockDock) return;
	this._resetTimer(0); // autopilot!
	if(station.isMainStation) this._performMedia(&quot;docked&quot;,&quot;main&quot;);
	else this._performMedia(&quot;docked&quot;,&quot;ent&quot;,station.name);
	d.lockDock = 0;
};
this.shipEnteredPlanetaryVicinity = function(planet){
	var aa,ab,c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || !planet || c&lt;d.lockPlanet) return;
	if(planet.isMainPlanet) aa = &quot;enterMain&quot;;
	else if(planet.isSun) aa = &quot;enterSun&quot;;
	else {
		aa = &quot;ent&quot;;
		ab = planet.name;
	}
	d.kick = 1;
	d.lockPlanet = c+this._performMedia(&quot;planetIn&quot;,aa,ab);
};
this.shipEnteredStationAegis = function(station){
	var c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || !station || c&lt;d.lockPlanet) return;
	d.kick = 1;
	d.lockPlanet = c+this._performMedia(&quot;aegis&quot;,&quot;enter&quot;);
};
this.shipExitedStationAegis = function(station){
	var c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || !station || c&lt;d.lockPlanet) return;
	d.kick = 1;
	d.lockPlanet = c+this._performMedia(&quot;aegis&quot;,&quot;exit&quot;);
};
this.shipExitedPlanetaryVicinity = function(planet){
	var aa,ab,c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || !planet || c&lt;d.lockPlanet) return;
	if(planet.isMainPlanet) aa = &quot;exitMain&quot;;
	else if(planet.isSun) aa = &quot;exitSun&quot;;
	else {
		aa = &quot;ent&quot;;
		ab = planet.name;
	}
	d.kick = 1;
	d.lockPlanet = c+this._performMedia(&quot;planetOut&quot;,aa,ab);
};
this.shipExitedWitchspace = function(){
	this._clrLock();
	var a;
	if(!player.ship.isInSpace) return;
	if(system.isInterstellarSpace) a = &quot;inter&quot;;
	else if(system.sun.hasGoneNova) a = &quot;goneNova&quot;;
	else if(system.sun.isGoingNova) a = &quot;doNova&quot;;
	else a = &quot;standard&quot;;
	this.$dub.kick = 1;
	this._performMedia(&quot;exitWS&quot;,a);
};
this.shipKilledOther = function(whom){
	var c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || c&lt;d.lockKill) return;
	d.kick = 1;
	if(whom &amp;&amp; whom.name) d.lockKill = c+this._performMedia(&quot;killed&quot;,&quot;ent&quot;,whom.name);
	else d.lockKill = c+this._performMedia(&quot;killed&quot;,&quot;any&quot;);
};
this.shipScoopedFuel = function(){
	var c = clock.absoluteSeconds, d = this.$dub;
	if(!player.ship.isInSpace || c&lt;d.lockFuel) return;
	d.kick = 1;
	d.lockFuel = c+this._performMedia(&quot;scoopFuel&quot;,&quot;fuel&quot;);
};
this.shipScoopedOther = function(whom){
	if(!player.ship.isInSpace || !whom || !whom.name) return;
	this.$dub.kick = 1;
	this._performMedia(&quot;scooped&quot;,&quot;ent&quot;,whom.name);
};
this.shipTargetDestroyed = function(target){
	var c = clock.absoluteSeconds, d = this.$dub, t;
	if(!player.ship.isInSpace || c&lt;d.lockKill) return;
	d.kick = 1;
	if(target){
		t = target.name;
		if(t &amp;&amp; this.$media.killed[t]){
			d.lockKill = c+this._performMedia(&quot;killed&quot;,&quot;ent&quot;,t);
			return;
		}
	}
	d.lockKill = c+this._performMedia(&quot;killed&quot;,&quot;any&quot;);
};
this.shipWillDockWithStation = function(){
	var d = this.$dub;
	d.auto = 0;
	if(d.cur) Sound.stopMusic(d.cur);
};
this.shipWillLaunchFromStation = function(station){
	var d = this.$dub;
	if(!station) return;
	d.radio = &quot;generic&quot;;
	d.lockDock = 0;
	d.kick = 1;
	this._resetTimer(0);
	if(station.isMainStation) this._performMedia(&quot;launch&quot;,&quot;main&quot;);
	else this._performMedia(&quot;launch&quot;,&quot;ent&quot;,station.name);
};
// Special cases
this.gamePaused = function(){
	if(this.$dub.cur) Sound.stopMusic(this.$dub.cur);
	this._clrLock();
};
this.gameResumed = function(){
	if(this.$dub.auto &amp;&amp; this.$media.radio.docking){
		this.playerStartedAutoPilot();
	} else this._resetTimer(0);
};
this.guiScreenChanged = function(){
	var d = this.$dub, k,m;
	if(guiScreen===&quot;GUI_SCREEN_MISSION&quot;){
		m = mission.screenID;
		if(m) k = worldScripts.Lib_GUI.$IDRules[m];
		if(!m || !k || !k.mus){
			if(d.cur) Sound.stopMusic(d.cur);
			this._resetTimer();
			d.reinit = 1;
		}
	}
};
this.missionScreenEnded = function(){
	if(this.$dub.reinit){
		this.$dub.reinit = 0;
		this._resetTimer(0);
	}
};
// Start session
this.missionScreenOpportunity = function(){
	delete this.missionScreenOpportunity;
	if(guiScreen!==&quot;GUI_SCREEN_MISSION&quot;) this.shipDockedWithStation(player.ship.dockedStation);
	else this.$dub.reinit = 1;
	var c = this.$radios, l = c.length, ind, s;
	this._updateInf();
	if(missionVariables.LIB_RADIO){
		s = JSON.parse(missionVariables.LIB_RADIO);
		for(var i=0;i&lt;l;i++){
			ind = c.indexOf(s[i]);
			if(ind!==-1) this.$E0 += Math.pow(2,ind);
		}
		this._buildList();
	}
	worldScripts.Lib_Config._registerSet(this.$inf);
};
this.playerCancelledAutoPilot = function(){
	var d = this.$dub;
	if(d.auto &amp;&amp; d.cur) Sound.stopMusic(d.cur);
	d.radio = &quot;generic&quot;;
	d.auto = 0;
	this._resetTimer(0);
};
this.playerStartedAutoPilot = function(){
	if(this.$media.radio.docking){
		Sound.stopMusic();
		this.$dub.radio = &quot;docking&quot;;
		this.$dub.auto = 1;
		this._resetTimer(0);
	} else this._resetTimer();
};
this.shipDied = function(){
	this._resetTimer();
	if(this.$dub.cur) Sound.stopMusic(this.$dub.cur);
};
this.shipLaunchedEscapePod = function(){
	this.shipDied();
};
this._clrLock = function(){
	var d = this.$dub;
	d.lockAlert = 1;
	d.lockFuel = 1;
	d.lockKill = 1;
	d.lockPlanet = 1;
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_PAD.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global clock,expandMissionText,mission,missionVariables,player,worldScripts */
/* (C) Svengali &amp; BlackWolf 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_PAD&quot;;

this.$data = {
	categories:{GALCOP:&quot;GalCop&quot;,GUILDS:&quot;Guilds&quot;,INFOS:&quot;Infos&quot;,LOGS:&quot;Logbook&quot;,PERSONS:&quot;Persons&quot;,SYSTEMS:&quot;Systems&quot;,ZZX:&quot;Search&quot;,ZZY:&quot;Player data&quot;,ZZZ:&quot;Exit&quot;},
	GALCOP:{
		GENERIC:{name:&quot;&quot;,entry:&quot;2084004:01:01:01&quot;,enlisted:&quot;&quot;,kills:0,missions:[],awards:[],info:[],t0:11,t1:0,t2:0,t3:0,t4:0,t5:0},
		NAVY:{name:&quot;&quot;,entry:&quot;&quot;,enlisted:&quot;&quot;,kills:0,missions:[],awards:[],info:[],t0:21,t1:0,t2:0,t3:0,t4:0,t5:0}
	},
	GUILDS:{
		GENERIC:{name:&quot;&quot;,entry:&quot;2084004:01:01:01&quot;,enlisted:&quot;Trade Guild Member&quot;,kills:0,missions:[],awards:[],info:[],t0:20,t1:0,t2:0,t3:0,t4:0,t5:0}
	},
	INFOS:{
		GENERIC:{name:&quot;Lave Academy&quot;,location:&quot;Lave&quot;,beacon:&quot;None&quot;,purpose:&quot;Flight Exam&quot;,special:[&quot;Exam 1st grade.&quot;],notes:[],t0:20,t1:0,t2:0,t3:0,t4:0,t5:0}
	},
	LOGS:{
		GENERIC:{list:[&quot;2084004:01:01 Starting my career.&quot;]}
	},
	PERSONS:{
		GENERIC:{name:&quot;&quot;,origin:&quot;&quot;,species:&quot;&quot;,gender:&quot;&quot;,age:0,ship:&quot;&quot;,rank:&quot;&quot;,info:[],notes:[],t0:0,t1:0,t2:0,t3:0,t4:0,t5:0}
	},
	SYSTEMS:{
		GENERIC:{name:&quot;Lave G1&quot;,info:[&quot;Located in the south-west of Galaxy 1.&quot;,&quot;Part of the Old Worlds.&quot;,&quot;Seat of the Galactic Co-operative of Worlds.&quot;],notes:[],t0:0,t1:0,t2:0,t3:0,t4:0,t5:0}
	}
};
this.$config = {
	curCat:&quot;GALCOP&quot;,
	def:{XXX:&quot;Page up&quot;,YYY:&quot;Page down&quot;,ZZZ:&quot;Back&quot;},
	defSpecies:[&quot;Bird&quot;,&quot;Feline&quot;,&quot;Frog&quot;,&quot;Human&quot;,&quot;Humanoid&quot;,&quot;Insect&quot;,&quot;Lizard&quot;,&quot;Lobster&quot;,&quot;Rodent&quot;],
	defGender:[&quot;Male&quot;,&quot;Female&quot;,&quot;Neutral&quot;,&quot;Android&quot;],
	defImages:[
		{t1:&quot;lib_user.png&quot;,s:3,g:0,a:[26,27]},
		{t1:&quot;lib_avatar01.png&quot;,s:3,g:1,a:[23,36]},{t1:&quot;lib_avatar02.png&quot;,s:3,g:1,a:[23,32]},{t1:&quot;lib_avatar03.png&quot;,s:3,g:1,a:[23,32]},
		{t1:&quot;lib_avatar04.png&quot;,s:3,g:0,a:[26,37]},{t1:&quot;lib_avatar05.png&quot;,s:3,g:0,a:[24,33]},{t1:&quot;lib_avatar06.png&quot;,s:3,g:0,a:[44,63]},
		{t1:&quot;lib_avatar07.png&quot;,s:8,g:1,a:[23,43]},{t1:&quot;lib_avatar08.png&quot;,s:8,g:0,a:[30,43]},{t1:&quot;lib_avatar09.png&quot;,s:0,g:0,a:[28,43]},
		{t1:&quot;lib_avatar10.png&quot;,s:0,g:1,a:[28,43]},{t1:&quot;lib_avatar11.png&quot;,s:1,g:1,a:[28,43]},{t1:&quot;lib_avatar12.png&quot;,s:1,g:0,a:[34,48]},
		{t1:&quot;lib_avatar13.png&quot;,s:1,g:1,a:[24,41]},{t1:&quot;lib_avatar14.png&quot;,s:1,g:0,a:[24,41]},{t1:&quot;lib_avatar15.png&quot;,s:2,g:2,a:[24,41]},
		{t1:&quot;lib_avatar16.png&quot;,s:2,g:2,a:[24,41]},{t1:&quot;lib_avatar17.png&quot;,s:5,g:2,a:[24,51]},{t1:&quot;lib_avatar18.png&quot;,s:5,g:2,a:[24,51]},
		{t1:&quot;lib_avatar19.png&quot;,s:6,g:0,a:[24,151]},{t1:&quot;lib_avatar20.png&quot;,s:6,g:1,a:[24,111]},{t1:&quot;lib_avatar21.png&quot;,s:8,g:1,a:[21,31]},
		{t1:&quot;lib_avatar22.png&quot;,s:8,g:0,a:[24,35]}
	],
	defTemps:{
		GALCOP:{
			disp:{name:&quot;&quot;,entry:&quot;&quot;,enlisted:&quot;&quot;,kills:0,missions:[],awards:[],info:[]},
			silent:{missions:5,awards:5,info:5,t0:1,t1:1,t2:1,t3:1,t4:1,t5:1,model:&quot;lib_ms_helper6y&quot;}
		},
		GUILDS:{
			disp:{name:&quot;&quot;,entry:&quot;&quot;,enlisted:&quot;&quot;,kills:0,missions:[],awards:[],info:[]},
			silent:{missions:5,awards:5,info:5,t0:1,t1:1,t2:1,t3:1,t4:1,t5:1,model:&quot;lib_ms_helper6y&quot;}
		},
		INFOS:{
			disp:{name:&quot;&quot;,location:&quot;&quot;,beacon:&quot;&quot;,purpose:&quot;&quot;,special:[],notes:[],$crypt:&quot;&quot;},
			silent:{special:10,$crypt:1,notes:5,t0:1,t1:1,t2:1,t3:1,t4:1,t5:1,model:&quot;lib_ms_helper6y&quot;}
		},
		LOGS:{
			disp:{list:[]},silent:{list:20,model:null}
		},
		PERSONS:{
			disp:{name:&quot;&quot;,origin:&quot;&quot;,species:&quot;Human&quot;,gender:&quot;Male&quot;,age:0,rank:&quot;&quot;,ship:&quot;&quot;,info:[],notes:[]},
			silent:{info:7,notes:5,t0:1,t1:1,t2:1,t3:1,t4:1,t5:1,model:&quot;lib_ms_helper6y&quot;}
		},
		SYSTEMS:{
			disp:{name:&quot;&quot;,info:[],notes:[],$hide:&quot;&quot;},
			silent:{info:10,notes:5,$hide:1,t0:1,t1:1,t2:1,t3:1,t4:1,t5:1,model:&quot;lib_ms_helper6y&quot;}
		}
	},
	defOrgs:[null,
		&quot;lib_pad_org1.png&quot;,&quot;lib_pad_org2.png&quot;,&quot;lib_pad_org3.png&quot;,&quot;lib_pad_org4.png&quot;,&quot;lib_pad_org5.png&quot;,&quot;lib_pad_org6.png&quot;,
		&quot;lib_pad_org7.png&quot;,&quot;lib_pad_org8.png&quot;,&quot;lib_pad_org9.png&quot;,&quot;lib_pad_org10.png&quot;,&quot;lib_pad_org11.png&quot;,&quot;lib_pad_org12.png&quot;,
		&quot;lib_pad_org13.png&quot;,&quot;lib_pad_org14.png&quot;,&quot;lib_pad_org15.png&quot;,&quot;lib_pad_org16.png&quot;,&quot;lib_pad_org17.png&quot;,&quot;lib_pad_org18.png&quot;,
		&quot;lib_pad_org19.png&quot;,&quot;lib_pad_org20.png&quot;,&quot;lib_pad_org21.png&quot;,&quot;lib_pad_org22.png&quot;,&quot;lib_pad_org23.png&quot;,&quot;lib_pad_org24.png&quot;,
		&quot;lib_pad_org25.png&quot;,&quot;lib_pad_org26.png&quot;,&quot;lib_pad_org27.png&quot;,&quot;lib_pad_org28.png&quot;,&quot;lib_pad_org29.png&quot;,&quot;lib_pad_org30.png&quot;,
		&quot;lib_pad_org31.png&quot;
	],
	defRanks:[null,
		&quot;lib_pad_rank1.png&quot;,&quot;lib_pad_rank2.png&quot;,&quot;lib_pad_rank3.png&quot;,&quot;lib_pad_rank4.png&quot;,&quot;lib_pad_rank5.png&quot;,&quot;lib_pad_rank6.png&quot;,
		&quot;lib_pad_rank7.png&quot;,&quot;lib_pad_rank8.png&quot;,&quot;lib_pad_rank9.png&quot;
	],
	defAwards:[null,
		&quot;lib_pad_medal1.png&quot;,&quot;lib_pad_medal2.png&quot;,&quot;lib_pad_medal3.png&quot;,&quot;lib_pad_medal4.png&quot;,&quot;lib_pad_medal5.png&quot;,&quot;lib_pad_medal6.png&quot;,
		&quot;lib_pad_medal7.png&quot;,&quot;lib_pad_medal8.png&quot;,&quot;lib_pad_medal9.png&quot;,&quot;lib_pad_medal10.png&quot;,&quot;lib_pad_medal11.png&quot;,&quot;lib_pad_medal12.png&quot;,
		&quot;lib_pad_medal13.png&quot;,&quot;lib_pad_medal14.png&quot;,&quot;lib_pad_medal15.png&quot;,&quot;lib_pad_medal16.png&quot;,&quot;lib_pad_medal17.png&quot;
	],
	defFFF:[null,&quot;lib_pad_rank1.png&quot;],
	defGGG:[null,&quot;lib_pad_rank1.png&quot;],
	defTex:[&quot;t0&quot;,&quot;t1&quot;,&quot;t2&quot;,&quot;t3&quot;,&quot;t4&quot;,&quot;t5&quot;],
	defTexLookUp:[&quot;defOrgs&quot;,&quot;defImages&quot;,&quot;defRanks&quot;,&quot;defAwards&quot;,&quot;defFFF&quot;,&quot;defGGG&quot;],
	defHead:{
		exitScreen:&quot;GUI_SCREEN_INTERFACES&quot;,
		message:&quot;&quot;,
		background:{name:&quot;lib_pad_text_bg.png&quot;,height:512},
		screenID:this.name,
		spinModel:false
	},
	hide:[&quot;$crypt&quot;,&quot;$hide&quot;],
	HUD:0,
	last:{
		news:&quot;&quot;,
		add:&quot;&quot;,
		upd:&quot;&quot;
	},
	lastSearch:&quot;&quot;,
	noteAdd:&quot;&quot;,
	page:&quot;INIT&quot;,
	pageInd:0,
	setInd:0,
	setGal:0,
	relInd:0,
	ps:{
		age:26,
		gender:&quot;Male&quot;,
		species:&quot;Human&quot;,
		origin:&quot;Lave&quot;,
		image:&quot;lib_user.png&quot;
	},
	psUpd:1
};
this.startUp = function(){
	var d = this.$data,
		load;
	this._aid = worldScripts.Lib_Main._lib;
	worldScripts.Lib_GUI.$IDRules.Lib_PAD = {mus:1};
	if(missionVariables.LIB_PAD_DATA){
		load = JSON.parse(missionVariables.LIB_PAD_DATA);
		d.GALCOP.GENERIC = load.GALCOP;
		d.GALCOP.NAVY = load.NAVY;
		d.GUILDS.GENERIC = load.GUILDS;
		d.INFOS.GENERIC = load.INFOS;
		d.LOGS.GENERIC = load.LOGS;
		d.PERSONS.GENERIC = load.PERSONS;
		d.SYSTEMS.GENERIC = load.SYSTEMS;
		this.$config.ps = JSON.parse(missionVariables.LIB_PAD_PS);
		this.$config.last = JSON.parse(missionVariables.LIB_PAD_LAST);
	}
	this._updatePlayer(1);
	this.$Search = {
		&quot;GALCOP.GENERIC&quot;: [0,[],[]],
		&quot;GALCOP.NAVY&quot;: [0,[],[]],
		&quot;GUILDS.GENERIC&quot;: [0,[],[]],
		&quot;INFOS.GENERIC&quot;: [0,[],[]],
		&quot;LOGS.GENERIC&quot;: [0,[],[]],
		&quot;PERSONS.GENERIC&quot;: [0,[],[]],
		&quot;SYSTEMS.GENERIC&quot;: [0,[],[]]
	};
	this._fillSearch();
};
this._fillSearch = function(){
	var d = this.$data;
	this.$Search[&quot;GALCOP.GENERIC&quot;][0] = this._getEntries(d.GALCOP.GENERIC);
	this.$Search[&quot;GALCOP.NAVY&quot;][0] = this._getEntries(d.GALCOP.NAVY);
	this.$Search[&quot;GUILDS.GENERIC&quot;][0] = this._getEntries(d.GUILDS.GENERIC);
	this.$Search[&quot;INFOS.GENERIC&quot;][0] = this._getEntries(d.INFOS.GENERIC);
	this.$Search[&quot;LOGS.GENERIC&quot;][0] = this._getEntries(d.LOGS.GENERIC);
	this.$Search[&quot;PERSONS.GENERIC&quot;][0] = this._getEntries(d.PERSONS.GENERIC);
	this.$Search[&quot;SYSTEMS.GENERIC&quot;][0] = this._getEntries(d.SYSTEMS.GENERIC);
};
this.startUpComplete = function(){
	this._addInterface();
};
// store only GENERIC, NAVY, last and player data
this.playerWillSaveGame = function(){
	var d = this.$data,
		store = {
			GALCOP: d.GALCOP.GENERIC,
			NAVY: d.GALCOP.NAVY,
			GUILDS: d.GUILDS.GENERIC,
			INFOS: d.INFOS.GENERIC,
			LOGS: d.LOGS.GENERIC,
			PERSONS: d.PERSONS.GENERIC,
			SYSTEMS: d.SYSTEMS.GENERIC
		};
	missionVariables.LIB_PAD_DATA = JSON.stringify(store);
	missionVariables.LIB_PAD_PS = JSON.stringify(this.$config.ps);
	missionVariables.LIB_PAD_LAST = JSON.stringify(this.$config.last);
};
this.shipDockedWithStation = function(){
	if(!player.ship.docked) return;
	this._addInterface();
};
this._limit = function(who,how){
	for(var k in who) if(typeof(who[k])===&quot;object&quot; &amp;&amp; who[k].length) who[k] = who[k].splice(-how[k]);
	return who;
};
this._getEntries = function(obj){
	var ownProps = Object.keys(obj), i = ownProps.length, o, res = &quot;&quot;, ex = [&quot;t0&quot;,&quot;t1&quot;,&quot;t2&quot;,&quot;t3&quot;,&quot;t4&quot;,&quot;t5&quot;];
	while(i--){
		if(ex.indexOf(ownProps[i])!==-1) continue;
		o = obj[ownProps[i]];
		if(typeof(o)===&quot;object&quot;) res += this._getEntries(o);
		else res += &quot;|&quot;+o;
	}
	return res;
};
/** function _addPageInCategory
* path    String. Dotted path, e.g. &quot;GALCOP.NAVY&quot;.
* content Object.
* parent  Array. Member of other pages.
* sil     Bool. Silent mode. Does not add to latest additions.
* $return true on success, otherwise false.
*/
this._addPageInCategory = function(path,content,parent,sil){
	var con = this.$config,
		d = this.$data,
		q = this._aid.objGet(d,path),
		s = path.split(&quot;.&quot;),
		obj = this._aid.objClone(content),
		temp = this._aid.objClone(con.defTemps[s[0]].disp),
		i;
	if(q || !temp) return false;
	for(i=0;i&lt;6;i++) temp[con.defTex[i]] = 0;
	temp = this._aid.objMerge(temp,obj,1);
	temp = this._limit(temp,con.defTemps[s[0]].silent);
	this._aid.objSet(d,path,temp);
	if(!sil) con.last.add = s.join(&quot;:&quot;);
	con.psUpd = 1;
	this.$Search[path] = [this._getEntries(temp),[],[]];
	if(parent){
		this.$Search[path][1] = parent;
		for(i=0;i&lt;parent.length;i++){
			this.$Search[parent[i]][2].push(path);
		}
	}
	return true;
};
/** _setPageEntry
* path   String. Dotted path, e.g. &quot;LOGS.GENERIC.list&quot;.
* value  Primitive. Value.
* sil    Bool. Silent mode. Does not add to latest additions.
* $return true on success, otherwise false.
*/
this._setPageEntry = function(path,value,sil){
	var d = this.$data,
		q = this._aid.objGet(d,path),
		s = path.split(&quot;.&quot;),
		o = {},
		n = clock.clockString.substr(0,13),
		p;
	if(typeof(q)===&quot;undefined&quot;) return false;
	switch(this._aid.typeGet(q)){
		case &quot;array&quot;:
			if(s[2]===&quot;list&quot;) q.push(n+&quot; &quot;+value);
			else if(q.indexOf(value)&lt;0) q.push(value);
			o[s[2]] = q;
			q = this._limit(o,this.$config.defTemps[s[0]].silent)[s[2]];
			break;
		case &quot;number&quot;:
			if(value===&quot;++&quot;) q++;
			else q = value;
			break;
		default: q = value;
	}
	this._aid.objSet(d,path,q);
	p = this._aid.objGet(d,s[0]+&quot;.&quot;+s[1]);
	if(!sil) this.$config.last.upd = s[0]+&quot;:&quot;+s[1]+&quot; - &quot;+n+&quot; &quot;+value;
	this.$Search[s[0]+&quot;.&quot;+s[1]][0] = this._getEntries(p);
	return true;
};
/** _getData
* path String. Dotted path, e.g. &quot;GALCOP.NAVY&quot;.
* $return Object or null.
*/
this._getData = function(path){
	var q = this._aid.objGet(this.$data,path);
	if(q) return this._aid.objClone(q);
	return null;
};
this._addInterface = function(){
	player.ship.dockedStation.setInterface(this.name,{
		title: &quot;P.A.D.&quot;,
		category: &quot;Captains Log&quot;,
		summary: &quot;Personal Assistance Device&quot;,
		callback: this._showStart.bind(this)
	});
};
this._updatePlayer = function(ex){
	var a,b,c,i, ps = this.$config.ps;
	a = this.$data.PERSONS.GENERIC;
	a.name = player.name;
	a.ship = player.ship.displayName;
	a.species = ps.species;
	a.origin = ps.origin;
	a.gender = ps.gender;
	a.age = ps.age;
	a.rank = player.rank;
	a.t1 = ps.image;
	b = this.$data.GALCOP;
	c = Object.keys(b);
	for(i=0;i&lt;c.length;i++){
		b[c[i]].name = player.name;
		b[c[i]].t1 = ps.image;
	}
	b.GENERIC.kills = player.score;
	b = this.$data.GUILDS;
	c = Object.keys(b);
	for(i=0;i&lt;c.length;i++){
		b[c[i]].name = player.name;
		b[c[i]].t1 = ps.image;
	}
	b.GENERIC.kills = player.score;
	this.$config.psUpd = 0;
	if(!ex) this._fillSearch();
};
this._showStart = function(ini){
	var c = this.$config;
	if(ini===&quot;Lib_PAD&quot;){
		c.psUpd = 1;
		if(!player.ship.hudHidden) c.HUD = 1;
	}
	player.ship.hudHidden = true;
	if(c.psUpd) this._updatePlayer();
	c.curCat = &quot;INIT&quot;;
	var head = this._aid.objClone(c.defHead);
	head.choices = this.$data.categories;
	head.message = &quot;Last News:\n&quot;+c.last.news+&quot;\n\nLast Update:\n&quot;+c.last.upd+&quot;\n\nLast Addition:\n&quot;+c.last.add;
	head.background = {name:&quot;lib_pad_bg.png&quot;,height:512};
	head.title = &quot;Personal Assistance Device&quot;;
	mission.runScreen(head,this._choices);
};
this._showCategory = function(ick,note){
	var con = this.$config,
		cat = con.curCat,
		d = this.$data[cat],
		ind = con.pageInd,
		max = Object.keys(d),
		p = d[con.page],
		temps = Object.keys(con.defTemps),
		i,md,m,min,template,
		tt = con.defTex,
		head = this._aid.objClone(con.defHead),
		pm = this.$Search[cat+&quot;.&quot;+con.page];
	con.relInd = 0;
	head.choices = this._aid.objClone(con.def);
	head.initialChoicesKey = ick;
	head.model = con.defTemps[cat].silent.model;
	head.title = cat+(ind!==0?&quot;-&quot;+max[ind]:&quot;&quot;)+&quot; (&quot;+(ind+1)+&quot;/&quot;+max.length+&quot;)&quot;;
	if(max.length&lt;2){
		head.choices = this._aid.scrChcUnsel(head.choices,&#39;XXX&#39;);
		head.choices = this._aid.scrChcUnsel(head.choices,&#39;YYY&#39;);
	}
	if(p.list){
		if(!p.list.length) head.message = &quot;No entries yet.&quot;;
		else {
			min = p.list.length-1;
			max = Math.max(0,min-20);
			for(i=min;i&gt;=max;i--) head.message += this._aid.scrAddLine([[p.list[i],30]],&quot;&quot;,&quot;\n&quot;);
		}
	} else {
		if(temps.indexOf(cat)&gt;-1){
			template = con.defTemps[cat];
			m = this._fillTemplate(p,template);
			head.message = m[0];
		} else {
			head.message = &quot;No entries yet.&quot;;
		}
		if(m[1].silent.notes){
			if(con.page===&quot;GENERIC&quot;) head.choices.ZZW = &quot;Add note&quot;;
			else head.choices.ZZW = {text:&quot;Add note&quot;,unselectable:true};
		}
		if(m[1].$crypt) head.choices.ZZV = &quot;Decrypt&quot;;
	}
	if(pm[1].length || pm[2].length) head.choices.ZZU = &quot;Related info&quot;;
	if(note) head.message += note;
	mission.runScreen(head,this._choices);
	md = mission.displayModel;
	if(md){
		md.orientation = [1,0,1,0]; // invisible
		md.position = [50,8,150];
		for(i=0;i&lt;tt.length;i++){
			if(m[1][tt[i]]){
				md.subEntities[i].setMaterials({&quot;lib_null.png&quot;:{emission_map:m[1][tt[i]]}});
				md.subEntities[i].orientation = [-1,0,1,0];
			}
		}
		md.subEntities[0].position = [100,60,160]; // organisation
		md.subEntities[2].position = [25,14,-10]; // rank/enlisted
		md.subEntities[3].position = [25,-7,-10]; // medal
		md.subEntities[4].position = [25,-28,-10]; // tex
		md.subEntities[5].position = [140,75,-80]; // tex
	}
};
this._fillTemplate = function(obj,temp,ps){
	var con = this.$config,
		a = this._aid.objClone(obj),
		b = this._aid.objClone(temp),
		ca = Object.keys(b.disp),
		m = &quot;&quot;,i,j,min,max,fill,spec,
		tt = con.defTex,
		tts = con.defTexLookUp;
	for(i=0;i&lt;ca.length;i++){
		if(con.hide.indexOf(ca[i])!==-1) continue;
		if(a[ca[i]]){
			if(this._aid.typeGet(a[ca[i]])===&quot;array&quot;){
				if(ps) continue; // opt out for gallery
				fill = b.silent[ca[i]]-1;
				if(a[ca[i]].length){
					min = a[ca[i]].length-1;
					max = Math.max(0,a[ca[i]].length-b.silent[ca[i]]);
					for(j=min;j&gt;=max;j--){
						if(j===min) m += this._aid.scrAddLine([[ca[i].toUpperCase()+&quot;: &quot;,7],[a[ca[i]][j],23]],&quot;&quot;,&quot;\n&quot;);
						else m += this._aid.scrAddLine([[&quot; &quot;,7],[a[ca[i]][j],23]],&quot; &quot;,&quot;\n&quot;);
					}
					if(fill&gt;min){ // Fill up
						fill -= min;
						while(fill--) m += &quot;\n&quot;;
					}
				} else { // Fill up
					for(j=fill;j&gt;=0;j--){
						if(j===fill) m += this._aid.scrAddLine([[ca[i].toUpperCase()+&quot;: &quot;,7],[&quot;-&quot;,23]],&quot;&quot;,&quot;\n&quot;);
						else m += &quot;\n&quot;;
					}
				}
			} else m += this._aid.scrAddLine([[ca[i].toUpperCase()+&quot;: &quot;,7],[a[ca[i]],23]],&quot;&quot;,&quot;\n&quot;);
		} else m += this._aid.scrAddLine([[ca[i].toUpperCase()+&quot;: &quot;,7],[&quot;-&quot;,23]],&quot;&quot;,&quot;\n&quot;);
	}
	for(i=0;i&lt;tt.length;i++){
		spec = a[tt[i]];
		if(spec &amp;&amp; b.silent[tt[i]]){
			if(typeof(spec)===&quot;number&quot;){
				if(spec&gt;0 &amp;&amp; spec&lt;con[tts[i]].length) b[tt[i]] = con[tts[i]][spec];
			} else b[tt[i]] = spec;
		}
	}
	if(a.$crypt &amp;&amp; b.silent.$crypt) b.$crypt = a.$crypt;
	return [m,b];
};
this._showPlayer = function(){
	this._updatePlayer();
	var arr = [&quot;LIB_PAD_AVATAR&quot;,&quot;LIB_PAD_SPECIES&quot;,&quot;LIB_PAD_ORIGIN&quot;,&quot;LIB_PAD_GENDER&quot;,&quot;LIB_PAD_AGE&quot;],
		c = this.$config,m,md,mdt,min,i,
		head = this._aid.objClone(c.defHead);
	head.textEntry = true;
	head.model = &quot;lib_ms_helper&quot;;
	head.title = &quot;Personal Assistance Device&quot;;
	if(c.setInd===0) head.model = &quot;lib_ms_helper12x&quot;; // Gallery
	m = this._fillTemplate(this.$data.PERSONS.GENERIC,c.defTemps.PERSONS,1);
	head.message = m[0];
	head.message += &quot;\n&quot;+expandMissionText(arr[c.setInd]);
	mission.runScreen(head,this._pSettings);
	md = mission.displayModel;
	if(md &amp;&amp; m &amp;&amp; m[1].t1){
		md.setMaterials({&quot;lib_null.png&quot;:{emission_map:m[1].t1}});
		md.orientation = [1,0,0,0];
		if(this.$config.setInd===0){
			mdt = c.defImages;
			min = Math.min(mdt.length,c.setGal+12);
			for(i=c.setGal;i&lt;min;i++) md.subEntities[i-c.setGal].setMaterials({&quot;lib_null.png&quot;:{diffuse_map:&quot;lib_pad&quot;+(i-c.setGal+1)+&quot;.png&quot;,emission_map:mdt[i].t1}});
			md.position = [0,-12,150];
		} else md.position = [50,40,150];
	}
};
this._pSettings = function(choice){
	var c = this.$config, cint = parseInt(choice), mdt, v;
	if(choice){
		switch(c.setInd){
			case 0:
				if(/\.png/.test(choice)){ // No way to test if image exists. Undocumented.
					c.ps.image = choice;
				} else {
					if(!isNaN(cint)){
						mdt = c.defImages;
						if(cint===0){ // Next gallery
							c.setInd--;
							c.setGal += 12;
							if(c.setGal&gt;mdt.length-1) c.setGal = 0;
						} else {
							if(cint&lt;=mdt.length &amp;&amp; cint&gt;0){
								v = mdt[c.setGal+cint-1];
								if(!v) v = {t1:&quot;lib_user.png&quot;,s:3,g:0,a:[26,27]};
								c.ps.image = v.t1;
								c.ps.species = c.defSpecies[v.s];
								c.ps.gender = c.defGender[v.g];
								c.ps.age = this._aid.randXY(v.a[0],v.a[1]);
							} else c.setInd--;
						}
					} else c.setInd--;
				}
				break;
			case 1: c.ps.species = choice; break;
			case 2: c.ps.origin = choice; break;
			case 3: c.ps.gender = choice; break;
			case 4: if(!isNaN(cint) &amp;&amp; cint&gt;0 &amp;&amp; cint&lt;300) c.ps.age = cint; break;
		}
	}
	c.setInd++;
	if(c.setInd&lt;5) this._showPlayer();
	else {
		c.curCat = &quot;INIT&quot;;
		c.page = &quot;INIT&quot;;
		c.pageInd = 0;
		c.psUpd = 1;
		this._showStart(1);
	}
};
this._choices = function(choice){
	var con = this.$config,
		c = Object.keys(this.$data.categories),
		cat = con.curCat,
		d = this.$data[cat],
		ind = con.pageInd,
		max,p1,p2,act,p3,p4;
	if(!cat || cat===&quot;INIT&quot;){
		switch(choice){
			case &quot;ZZZ&quot;: // Bye
				if(con.HUD) player.ship.hudHidden = false;
				con.HUD = 0;
				con.curCat = &quot;&quot;;
				con.page = &quot;INIT&quot;;
				con.pageInd = 0;
				break;
			case &quot;ZZY&quot;: // Player settings
				con.setInd = 0;
				this._showPlayer();
				break;
			case &quot;ZZX&quot;: // Search
				this._showSearch();
				break;
			default:
				ind = c.indexOf(choice);
				if(ind&gt;-1){
					con.curCat = choice;
					con.page = &quot;GENERIC&quot;;
					con.pageInd = 0;
					this._showCategory(choice);
				}
		}
	} else {
		max = Object.keys(d);
		switch(choice){
			case &quot;XXX&quot;: // Page up
				ind++;
				if(ind&gt;=max.length) ind = 0;
				con.page = max[ind];
				con.pageInd = ind;
				this._showCategory(choice);
				break;
			case &quot;YYY&quot;: // Page down
				ind--;
				if(ind&lt;0) ind = max.length-1;
				con.page = max[ind];
				con.pageInd = ind;
				this._showCategory(choice);
				break;
			case &quot;ZZU&quot;: // Parent/Members
				this._showRelated();
				break;
			case &quot;ZZV&quot;: // De-Crypt
				p1 = d[con.page].$crypt.split(&quot;.&quot;);
				p2 = p1.shift();
				act = this._aid.objGet(worldScripts[p2],p1.join(&quot;.&quot;),1);
				if(act){
					p3 = d[con.page].special.join(&quot;|&quot;);
					p4 = worldScripts.Lib_Crypt._rot513(p3);
					d[con.page].special = p4.split(&quot;|&quot;);
					d[con.page].$crypt = 0;
					this.$Search[con.curCat+&quot;.&quot;+con.page][0] = this._getEntries(d[con.page]);
					this._showCategory(choice);
				} else this._showCategory(choice,&quot;Could not decrypt.&quot;);
				break;
			case &quot;ZZW&quot;: // Add note
				this._showAddNote(cat+&quot;.&quot;+con.page);
				break;
			case &quot;ZZZ&quot;: // Back
				con.curCat = &quot;INIT&quot;;
				con.page = &quot;INIT&quot;;
				con.pageInd = 0;
				this._showStart(1);
				break;
		}
	}
};
this._showAddNote = function(path){
	var m = this._aid.objGet(this.$data,path+&quot;.notes&quot;),
		f = m.slice(0).reverse(),
		head = this._aid.objClone(this.$config.defHead);
	head.textEntry = true;
	head.title = &quot;Add note (&quot;+path+&quot;)&quot;;
	this.$config.noteAdd = path;
	for(var i=0;i&lt;10;i++){
		if(i&lt;f.length) head.message += this._aid.scrAddLine([[f[i],23]],&quot;&quot;,&quot;\n&quot;);
		else head.message += &quot;\n&quot;;
	}
	mission.runScreen(head,this._noteAdded);
};
this._noteAdded = function(choice){
	if(choice &amp;&amp; choice!==&quot;&quot;){
		this._setPageEntry(this.$config.noteAdd+&quot;.notes&quot;,choice);
		this._showCategory(&quot;ZZW&quot;,&quot;Note added.&quot;);
	} else this._showCategory(&quot;ZZW&quot;);
	this.$config.noteAdd = &quot;&quot;;
};
this._showSearch = function(){
	var c = this.$config,
		head = this._aid.objClone(c.defHead);
	if(c.psUpd) this._updatePlayer();
	head.textEntry = true;
	head.message = null;
	head.messageKey = &quot;LIB_PAD_SEARCH&quot;;
	head.title = &quot;Personal Assistance Device&quot;;
	mission.runScreen(head,this._pSearch);
};
this._pSearch = function(choice){
	var res = null,i,max,
		head = this._aid.objClone(this.$config.defHead);
	head.choices = {ZZZ:&quot;Back&quot;};
	head.title = &quot;Search Results&quot;+(choice?&quot; for &quot;+choice:&quot;&quot;);
	if(choice){
		res = this._searchSData(choice);
		this.$config.lastSearch = choice;
	}
	if(res &amp;&amp; res.length){
		max = Math.min(res.length,20);
		for(i=0;i&lt;max;i++) head.choices[res[i]] = res[i].split(&quot;.&quot;).join(&quot; : &quot;);
		for(i=0;i&lt;26-max;i++) head.choices[&quot;ZZY&quot;+i] = {text:&quot;&quot;,unselectable:true};
	} else head.message = &quot;Nothing found.&quot;;
	mission.runScreen(head,this._pSearchRes);
};
this._pSearchRes = function(path){
	var con = this.$config,
		d = this.$data,
		k,ind;
	switch(path){
		case &quot;ZZZ&quot;: this._showStart(1); break;
		default:
			path = path.split(&quot;.&quot;);
			con.curCat = path[0];
			con.page = path[1];
			k = Object.keys(d[path[0]]);
			ind = k.indexOf(path[1]);
			con.pageInd = ind;
			this._showCategory(path[1]);
	}
};
// Returns array with pathes
this._searchSData = function(word){
	var w = new RegExp(word),
		s = this.$Search,
		k = Object.keys(s),
		kl = k.length,
		d,
		res = [];
	for(var i=0;i&lt;kl;i++){
		d = s[k[i]][0];
		if(w.test(d)) res.push(k[i]);
		if(res.length&gt;20) break;
	}
	return res;
};
this._showRelated = function(){
	var con = this.$config,
		head = this._aid.objClone(con.defHead),
		pm = this.$Search[con.curCat+&quot;.&quot;+con.page],
		pma = pm[1],
		pmb = pm[2],
		i;
	head.choices = this._aid.objClone(con.def);
	head.title = &quot;Related to &quot;+con.curCat+&quot;.&quot;+con.page;
	head.overlay = {name:&quot;lib_pad_text_ovcatmem.png&quot;,height:512};
	for(i=5*con.relInd;i&lt;5+(5*con.relInd);i++){
		if(pma.length&gt;i) head.choices[&quot;A&quot;+pma[i]] = pma[i];
		else head.choices[&quot;BZZZ&quot;+i] = {text:&quot;&quot;,unselectable:true};
	}
	head.choices.CZZZ = {text:&quot;&quot;,unselectable:true};
	for(i=15*con.relInd;i&lt;15+(15*con.relInd);i++){
		if(pmb.length&gt;i) head.choices[&quot;D&quot;+pmb[i]] = pmb[i];
		else head.choices[&quot;EZZZ&quot;+i] = {text:&quot;&quot;,unselectable:true};
	}
	head.choices.FZZZ = {text:&quot;&quot;,unselectable:true};
	head.choices.GZZZ = {text:&quot;&quot;,unselectable:true};
	head.choices.HZZZ = {text:&quot;&quot;,unselectable:true};
	if(pma.length&lt;6 &amp;&amp; pmb.length&lt;16){
		head.choices = this._aid.scrChcUnsel(head.choices,&#39;XXX&#39;);
		head.choices = this._aid.scrChcUnsel(head.choices,&#39;YYY&#39;);
	}
	mission.runScreen(head,this._related);
};
this._related = function(path){
	var con = this.$config,
		pm = this.$Search[con.curCat+&quot;.&quot;+con.page],
		pma = pm[1],
		pmb = pm[2],
		d = this.$data,
		k,ind;
	switch(path){
		case &quot;XXX&quot;:
			con.relInd++;
			if(pma.length&lt;=con.relInd*5 &amp;&amp; pmb.length&lt;=con.relInd*15) con.relInd = 0;
			this._showRelated();
			break;
		case &quot;YYY&quot;:
			con.relInd--;
			if(con.relInd&lt;0) con.relInd = Math.max(Math.ceil(pmb.length/15)-1,Math.ceil(pma.length/5)-1);
			this._showRelated();
			break;
		case &quot;ZZZ&quot;: this._showCategory(); break;
		default:
			path = path.substr(1);
			path = path.split(&quot;.&quot;);
			con.curCat = path[0];
			con.page = path[1];
			k = Object.keys(d[path[0]]);
			ind = k.indexOf(path[1]);
			con.pageInd = ind;
			this._showCategory(path[1]);
	}
};
this._Help = function(what){
	var h;
	switch(what){
		case &quot;_addPageInCategory&quot;: h = &quot;LIB_PAD_HELP_addPageInCategory&quot;; break;
		case &quot;_setPageEntry&quot;: h = &quot;LIB_PAD_HELP_setPageEntry&quot;; break;
		case &quot;_getData&quot;: h = &quot;LIB_PAD_HELP_getData&quot;; break;
		default: h = &quot;LIB_PAD_HELP&quot;;
	}
	return expandMissionText(h);
};
}).call(this);</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_PAD_Events.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global clock,galaxyNumber,guiScreen,mission,missionVariables,player,system,worldScripts */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_PAD_Events&quot;;

this.$config = {
	bounty:0,
	credits:0,
	fined:0,
	rank:&quot;Harmless&quot;,
	status:&quot;Clean&quot;,
	updCR:0,
	updNavy:1,
	updNova:1,
	updTP:0
};
this.$delay = [];
this.$init = 1;
this.startUp = function(){
	this.$init = 0;
};
this.startUpComplete = function(){
	var m = [&quot;PRELUDE&quot;,&quot;MISSION_COMPLETE&quot;,&quot;STAGE_1&quot;,&quot;RUNNING&quot;], mc = -1, mt = -1;
	if(missionVariables.Lib_PAD_EVENTS) this.$config = JSON.parse(missionVariables.Lib_PAD_EVENTS);
	if(missionVariables.conhunt) mc = m.indexOf(missionVariables.conhunt);
	if(missionVariables.thargplans) mt = m.indexOf(missionVariables.thargplans);
	if(this.$config.updNavy &amp;&amp; worldScripts.Lib_PAD.$data.GALCOP.NAVY.entry===&quot;&quot;) this._add(&quot;GALCOP.NAVY.entry&quot;,clock.clockString,1);
	this.$config.updNavy = 0;
	if(mc&gt;-1) this._addCurruthers(1);
	if(mt&gt;-1){
		this._addFortesque(1);
		if(mt&gt;0) this._addBlake(1);
	}
	if(this.$config.updNova &amp;&amp; missionVariables.nova===&quot;NOVA_HERO&quot;){
		this._add(&quot;PERSONS.GENERIC.info&quot;,&quot;Survived System Nova.&quot;,1);
		this.$config.updNova = 0;
	}
	this.$config.bounty = player.bounty;
	this.$config.credits = player.credits;
	this.$config.rank = player.rank;
	this.$config.status = player.legalStatus;
};
this.playerWillSaveGame = function(){
	missionVariables.Lib_PAD_EVENTS = JSON.stringify(this.$config);
};
this.guiScreenChanged = function(){
	if(!player.ship.docked) return;
	if(guiScreen===&quot;GUI_SCREEN_MISSION&quot; &amp;&amp; mission.screenID){
		switch(mission.screenID){
			case &quot;oolite-constrictor-hunt-briefing&quot;:
				if(this.$config.updNavy) this._add(&quot;GALCOP.NAVY.entry&quot;,clock.clockString.substr(0,13));
				this.$config.updNavy = 0;
				this._add(&quot;LOGS.GENERIC.list&quot;,&quot;A job for the Navy to hunt a ship.&quot;);
				this._addCurruthers();
				this.$config.updCR = 1;
				break;
			case &quot;oolite-constrictor-hunt-debriefing&quot;:
				this._add(&quot;LOGS.GENERIC.list&quot;,&quot;Yeeehaa. Got the Constrictor!&quot;);
				this._add(&quot;GALCOP.NAVY.missions&quot;,&quot;Eliminated the stolen Constrictor.&quot;);
				this._add(&quot;GALCOP.NAVY.kills&quot;,&quot;++&quot;,1);
				this.$config.updCR = 0;
				break;
			case &quot;oolite-thargoid-plans-briefing1&quot;:
				this._addFortesque();
				break;
			case &quot;oolite-thargoid-plans-briefing2&quot;:
				this._add(&quot;LOGS.GENERIC.list&quot;,&quot;A job for the Navy to deliver plans.&quot;);
				this._addBlake();
				this.$config.updTP = 1;
				break;
			case &quot;oolite-thargoid-plans-debriefing&quot;:
				this._add(&quot;GALCOP.NAVY.missions&quot;,&quot;Delivered Thargoid defence plans.&quot;);
				this._add(&quot;LOGS.GENERIC.list&quot;,&quot;Yeeehaa. Delivered the plans!&quot;);
				this.$config.updTP = 0;
				break;
			case &quot;oolite-nova-hero&quot;:
			case &quot;oolite-nova-disappointed&quot;:
			case &quot;oolite-nova-ignored&quot;:
			case &quot;oolite-nova-coward&quot;:
				this._add(&quot;PERSONS.GENERIC.info&quot;,&quot;Survived System Nova.&quot;);
				this.$config.updNova = 0;
				break;
		}
	}
};
this.playerCompletedContract = function(type,result,fee,contract){
	var txt,f;
	if(!fee){
		switch(type){
			case &quot;passenger&quot;: txt = &quot;Nooo!! &quot;+contract.name+&quot; did not pay anything.&quot;; break;
			case &quot;parcel&quot;: txt = &quot;Argh! Didn&#39;t get paid for &quot;+contract.name+&quot;.&quot;; break;
			case &quot;cargo&quot;: txt = &quot;Argh! Didn&#39;t get paid for &quot;+contract.cargo_description+&quot;.&quot;; break;
		}
	} else {
		f = formatCredits(fee/10,1);
		switch(type){
			case &quot;passenger&quot;: txt = (result===&quot;success&quot;?&quot;On arriving&quot;:&quot;Even if late&quot;)+&quot; &quot;+contract.name+&quot; paid &quot;+f+&quot; ₢.&quot;; break;
			case &quot;parcel&quot;: txt = (result===&quot;success&quot;?&quot;On arriving&quot;:&quot;Even if late&quot;)+&quot; I got &quot;+f+&quot; ₢ for delivering &quot;+contract.name+&quot;.&quot;; break;
			case &quot;cargo&quot;: txt = (result===&quot;success&quot;?&quot;On arriving&quot;:&quot;Even if &quot;+result)+&quot; I got &quot;+f+&quot; ₢ for delivering &quot;+contract.cargo_description+&quot;.&quot;; break;
		}
	}
	if(txt) this._add(&quot;LOGS.GENERIC.list&quot;,txt);
};
this.playerEnteredNewGalaxy = function(){
	this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Ship jumped to galaxy &quot;+(galaxyNumber+1)+&quot;.&quot;]);
};
this.playerRescuedEscapePod = function(fee, reason, pilot){
	fee = formatCredits(fee,1);
	if(system.isInterstellarSpace) this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Rescued &quot;+pilot.name+&quot; between worlds&quot;+(fee?&quot; Got &quot;+(fee/10)+&quot; ₢.&quot;:&quot;.&quot;)]);
	else this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Rescued &quot;+pilot.name+&quot; at &quot;+system.name+(fee?&quot; Got &quot;+(fee/10)+&quot; ₢.&quot;:&quot;.&quot;)]);
};
this.shipLaunchedEscapePod = function(){
	if(system.isInterstellarSpace) this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Nargh! Had to bail out to nowhere.&quot;]);
	else this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Nargh! Had to bail out at &quot;+system.name+&quot;.&quot;]);
};
this.shipWillDockWithStation = function(){
	this.$config.bounty = player.bounty;
	this.$config.credits = player.credits;
	if(player.rank!==this.$config.rank) this._add(&quot;LOGS.GENERIC.list&quot;,&quot;Rank of &quot;+player.rank+&quot; achieved!&quot;);
	this.$config.rank = player.rank;
	this.$config.status = player.legalStatus;
	this._addDelayed();
};
this.shipDockedWithStation = function(st){
	if(!player.ship.docked) return;
	var m;
	if(this.$config.credits!==player.credits){
		if(player.credits&gt;this.$config.credits) m = &quot;Yeah! Earned &quot;+formatCredits(player.credits-this.$config.credits,1)+&quot; ₢ at &quot;+st.displayName;
		else m = &quot;No! Lost &quot;+formatCredits(this.$config.credits-player.credits,1)+&quot; ₢ at &quot;+st.displayName;
		if(system.isInterstellarSpace) m += &quot;.&quot;;
		else m += &quot; &quot;+system.name+&quot;.&quot;;
		this._add(&quot;LOGS.GENERIC.list&quot;,m);
	}
	if(player.ship.markedForFines) this.$config.fined++;
};
this.playerBoughtNewShip = function(){
	this.$config.credits = player.credits;
};
// Note: Handler is fired (too?) early, so guarding (this.$init) is necessary!!!
this.equipmentAdded = function(eq){
	if(this.$init) return;
	this.$config.credits = player.credits;
	if(eq===&quot;EQ_NAVAL_ENERGY_UNIT&quot;){
		this._add(&quot;LOGS.GENERIC.list&quot;,&quot;Got a naval energy unit.&quot;);
		this._add(&quot;GALCOP.NAVY.awards&quot;,&quot;Naval energy unit.&quot;);
	}
	if(eq===&quot;EQ_CLOAKING_DEVICE&quot;){
		this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Got a cloaking device.&quot;]);
		this.$delay.push([&quot;PERSONS.GENERIC.info&quot;,&quot;Found cloaking device.&quot;]);
	}
};
this.shipLaunchedFromStation = function(){
	this.$config.bounty = player.bounty;
	this.$config.credits = player.credits;
	this.$config.rank = player.rank;
	this.$config.status = player.legalStatus;
};
this.shipBountyChanged = function(delta){
	var m;
	if(this.$config.bounty===player.bounty+delta) return;
	if(!player.bounty) m = &quot;Pfew. Clean again.&quot;;
	else {
		if(delta&gt;0) m = &quot;Ouch. Got a bounty.&quot;;
		if(delta&lt;0) m = &quot;Nice. They reduced my bounty.&quot;;
		if(this.$config.status!==player.legalStatus) m += &quot; Now I&#39;m &quot;+player.legalStatus+&quot;.&quot;;
	}
	if(m) this.$delay.push([&quot;LOGS.GENERIC.list&quot;,m]);
	this.$config.bounty = player.bounty;
	this.$config.status = player.legalStatus;
};
this.shipKilledOther = function(whom){
	if(player.rank!==this.$config.rank){
		this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Rank of &quot;+player.rank+&quot; achieved!&quot;]);
		this.$config.rank = player.rank;
	}
	if(this.$config.updTP &amp;&amp; whom &amp;&amp; whom.isThargoid) this.$delay.push([&quot;GALCOP.NAVY.kills&quot;,&quot;++&quot;,1]);
};
this.shipWillExitWitchspace = function(){
	if(system.isInterstellarSpace) this.$delay.push([&quot;LOGS.GENERIC.list&quot;,&quot;Witchspace misjump occurred.&quot;]);
};
this._add = function(p,w,s){
	worldScripts.Lib_PAD._setPageEntry(p,w,s);
};
this._addDelayed = function(p,w,s){
	var l = this.$delay.length;
	if(l){
		for(var i=0;i&lt;l;i++) worldScripts.Lib_PAD._setPageEntry(this.$delay[i][0],this.$delay[i][1],this.$delay[i][2]);
	}
	this.$delay.length = 0;
};
this._addPage = function(p,w,t,s){
	worldScripts.Lib_PAD._addPageInCategory(p,w,t,s);
};
this._addCurruthers = function(s){
	this._addPage(&quot;PERSONS.CAPTAIN CURRUTHERS&quot;,{name:&quot;James Curruthers&quot;,origin:&quot;Restricted data&quot;,species:&quot;Human colonial&quot;,gender:&quot;Male&quot;,age:45,ship:&quot;Viper&quot;,rank:&quot;Captain&quot;,t0:21,t1:&quot;lib_ovc_curruthers.png&quot;,t2:8},[&quot;GALCOP.NAVY&quot;],s);
};
this._addFortesque = function(s){
	this._addPage(&quot;PERSONS.CAPTAIN FORTESQUE&quot;,{name:&quot;Peter Fortesque&quot;,origin:&quot;Restricted data&quot;,species:&quot;Human colonial&quot;,gender:&quot;Male&quot;,age:41,ship:&quot;Viper&quot;,rank:&quot;Captain&quot;,t0:21,t1:&quot;lib_ovc_fortesque.png&quot;,t2:8},[&quot;GALCOP.NAVY&quot;],s);
};
this._addBlake = function(s){
	this._addPage(&quot;PERSONS.AGENT BLAKE&quot;,{name:&quot;Paul Blake&quot;,origin:&quot;Restricted data&quot;,species:&quot;Restricted data&quot;,gender:&quot;Male&quot;,age:34,ship:&quot;Restricted data&quot;,rank:&quot;Agent&quot;,t0:21,t1:&quot;lib_ovc_blake.png&quot;},[&quot;GALCOP.NAVY&quot;],s);
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Starmap.js</td>
                    <td><pre>/* jshint bitwise:false, forin:false */
/* global mission,player,system,worldScripts,Vector3D */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;Lib_Starmap&quot;;

this.startUpComplete = function(){
	worldScripts.Lib_GUI.$IDRules.Lib_Starmap = {mus:1};
	this.$defs = {
		off: Vector3D([0,0,0]),
		rel: Vector3D([0,0,0])
	};
	this._update();
	this.$VSE = null;
	this.$OP = worldScripts.Lib_Main._lib.ooShaders();
	this.$POI = null;
};
/** function _start( obj ) - System map
* obj - Object
*  ini - Array. Max 12 entries.
*    String or Object { map:TEXTURE,ent:ENTITY [,col:Number] }
*  message - Optional. String. Initial message text.
*  title - Optional. String. Screen title.
*  ani - Optional. Animation for Lib_Animator. Requires capture flag!
*  POI - Optional. Vector. Point of interest.
*  MUL - Optional. Number. Multiplier. Default 0.00015.
* $return -
*/
this._start = function(obj,force){
	if(!obj || (this.$VSE &amp;&amp; this.$VSE.isValid) || !this.$OP) return false;
	if(force) this._update();
	var absZ,col,fin,i,map,mat,md,mul,pos,tmp,rl, trck = [],
		maxZ = 0, maxY = 0, minZ = 0, minY = 0, mag = 0, sd = 0,
		dck = player.ship.docked, pls = 0, plm = 0, st = 0, as = 0;
	this.$POI = null;
	if(obj.POI){
		this.$POI = obj.POI;
		rl = obj.POI;
	} else rl = this.$defs.rel;
	if(obj.MUL) mul = obj.MUL;
	else mul = 0.00015;
	if(dck){
		var head = {
			choices:{ZZZ:&quot;Continue&quot;},
			message:obj.message?obj.message:&quot;&quot;,
			background:{name:&quot;lib_starmap_bg.png&quot;,height:512},
			screenID:&quot;Lib_Starmap&quot;,
			model:&quot;lib_ms_helper12&quot;,
			spinModel:false,
			title:obj.title?obj.title:&quot;System Map&quot;
		};
		this.$HUD = player.ship.hudHidden;
		player.ship.hudHidden = true;
		mission.runScreen(head,this._choices);
		md = mission.displayModel;
		md.orientation = [1,0,1,0];
		md.position = [0,0,500];
	} else {
		if(!this.$wp || (this.$wp &amp;&amp; !this.$wp.isValid)) this.$wp = system.addVisualEffect(&quot;lib_starmap_wp&quot;,[0,0,0]);
		md = system.addVisualEffect(&quot;lib_starmap12&quot;,player.ship.position);
		md.script.$defs = rl;
		md.script.$mul = mul;
	}
	md.lightsActive = false;
	if(obj){
		for(i=0;i&lt;12;i++){
			mat = md.subEntities[i].getMaterials();
			col = 0;
			if(i&gt;obj.ini.length-1){
				mat[&quot;lib_null.png&quot;].textures[0] = &quot;lib_blend0.png&quot;;
			} else {
				if(typeof(obj.ini[i])===&quot;string&quot;){
					pos = this.$defs.off;
					map = &quot;lib_blend0.png&quot;;
					switch(obj.ini[i]){
						case &quot;PS&quot;: map = &quot;lib_starmap_5.png&quot;; pos = player.ship.position; trck.push({ent:player.ship,sub:i}); break;
						case &quot;S&quot;: if(system.sun){map = &quot;lib_starmap_0.png&quot;; pos = system.sun.position; trck.push({ent:system.sun,sub:i});} break;
						case &quot;P&quot;: tmp = this._getPlanet(pls); pls++; if(tmp){map = tmp[0]; pos = tmp[1].position; trck.push({ent:tmp[1],sub:i});} break;
						case &quot;M&quot;: tmp = this._getMoon(plm); plm++; if(tmp){map = tmp[0]; pos = tmp[1].position; trck.push({ent:tmp[1],sub:i});} break;
						case &quot;ST&quot;: if(this.$st.sta){map = &quot;lib_starmap_3.png&quot;; pos = this.$st.sta.position; trck.push({ent:this.$st.sta,sub:i});} break;
						case &quot;STG&quot;: tmp = this._getGalStation(st); st++; if(tmp){map = tmp[0]; pos = tmp[1].position; trck.push({ent:tmp[1],sub:i});
							if(tmp[1].isPolice) col = 4; else col = 3;} break;
						case &quot;WP&quot;: map = &quot;lib_starmap_2.png&quot;; trck.push({ent:this.$wp,sub:i}); break;
						case &quot;H&quot;: if(this.$st.sth.length){map = &quot;lib_starmap_4.png&quot;; pos = this.$st.sth[0].position; trck.push({ent:this.$st.sth[0],sub:i});} break;
						case &quot;AS&quot;: tmp = this._getAsteroidField(as); as += 20; if(tmp){map = tmp[0]; pos = tmp[1].position; trck.push({ent:tmp[1],sub:i});} break;
					}
				} else {
					if(obj.ini[i].ent){
						pos = obj.ini[i].ent.position;
						trck.push({ent:obj.ini[i].ent,sub:i});
					} else {
						if(dck) pos = obj.ini[i].pos;
						else continue;
					}
					map = obj.ini[i].map;
					if(obj.ini[i].col) col = obj.ini[i].col;
				}
				if(col) mat[&quot;lib_null.png&quot;].uniforms.MC.value = this._getColor(col);
				mat[&quot;lib_null.png&quot;].textures[0] = map;
				pos = this._compress(pos);
				// Scale down for display
				fin = pos.subtract(rl).multiply(mul);
				if(dck){
					if(fin.z&gt;maxZ) maxZ = fin.z;
					if(fin.y&gt;maxY) maxY = fin.y;
					if(fin.z&lt;minZ) minZ = fin.z;
					if(fin.y&lt;minY) minY = fin.y;
				} else {
					mag = fin.magnitude();
					if(mag&gt;110) sd = (mag-100)*0.1;
				}
				md.subEntities[i].position = fin;
			}
			md.subEntities[i].setMaterials(mat);
		}
		if(dck){
			// Auto zoom
			absZ = Vector3D([(-minZ)+maxZ,(-minY)+maxY,0]).magnitude();
			absZ = Math.max(absZ,180);
			md.position = [0,0,absZ*2];
			// Animation
			if(obj.ani) worldScripts.Lib_Animator._start(obj.ani);
		} else {
			if(sd) md.script.$mul = mul/sd;
			// Track
			if(trck.length) md.script.$upd = trck;
			if(player.ship.compassTarget) md.orientation = player.ship.compassTarget.position.rotationTo(rl);
			else md.orientation = player.ship.position.rotationTo(rl);
			this.$VSE = md;
			this.$EnableTimer = new Timer(this,this._doEnableTimer,1);
		}
	}
	return true;
};
this._getPlanet = function(n){
	if(!n){
		if(!this.$pl.pla) return null;
		return([&quot;lib_starmap_1.png&quot;,this.$pl.pla]);
	}
	if(this.$pl.plp.length&lt;=n-1) return null;
	return([&quot;lib_starmap_P1.png&quot;,this.$pl.plp[n-1]]);
};
this._getMoon = function(n){
	if(this.$pl.plm.length&lt;=n) return null;
	return([&quot;lib_starmap_M1.png&quot;,this.$pl.plm[n]]);
};
this._getGalStation = function(n){
	if(this.$st.stgal.length&lt;=n) return null;
	if(this.$st.stgal[n].maxSpeed&gt;5) return([&quot;lib_starmap_i4.png&quot;,this.$st.stgal[n]]);
	return([&quot;lib_starmap_i5.png&quot;,this.$st.stgal[n]]);
};
this._getAsteroidField = function(n){
	if(this.$as.length&lt;=n) return null;
	return([&quot;lib_starmap_7.png&quot;,this.$as[n]]);
};
this._getColor = function(n){
	var c;
	switch(n){
		case 1: c = [0.8,0,0,1]; break; // red
		case 2: c = [0,0.8,0,1]; break; // green
		case 3: c = [0,0,0.8,1]; break; // blue
		case 4: c = [0.6,0,0.8,1]; break; // purple
		case 5: c = [0.4,0.4,0.4,1]; break; // gray
		case 6: c = [0,0.7,0.7,1]; break; // aqua
		case 7: c = [0.8,0.6,0,1]; break; // amber
		case 8: c = [0.8,0.6,0.3,1]; break; // gold
		case 9: c = [0.3,0,0.5,1]; break; // UV
		default: c = [1,1,1,1]; break; // white
	}
	return c;
};
this._addInFreeSlot = function(ent,map,col){
	if(!this.$VSE || !this.$VSE.isValid) return;
	var x = this.$VSE.script.$upd,m=x.length,slot,mat;
	for(var i=0;i&lt;12;i++){
		if(i&gt;m-1 || !x[i].ent){slot = i; break;}
	}
	if(typeof(slot)!==&quot;number&quot; || slot&gt;11) return false;
	mat = this.$VSE.subEntities[slot].getMaterials();
	mat[&quot;lib_null.png&quot;].textures[0] = map;
	mat[&quot;lib_null.png&quot;].uniforms.MC.value = this._getColor(col);
	if(slot&lt;=m) x[slot] = {ent:ent,sub:slot};
	else x.push({ent:ent,sub:slot});
	this.$VSE.script.$upd = x;
	this.$VSE.subEntities[slot].setMaterials(mat);
	this.$VSE.subEntities[slot].shaderVector1 = [0,0,0];
	return true;
};
// Inflight options
this._doEnableTimer = function(){
	if(player.alertCondition&lt;3 &amp;&amp; !player.ship.weaponsOnline){
		this._switchOn();
		if(!this.$VSE || !this.$VSE.isValid) return;
		this.$VSE.shaderFloat1 = 1;
	} else this._switchOff();
	this.$EnableTimer = null;
};
this.alertConditionChanged = function(s){
	if(s&gt;2) this._switchOff();
	else if(s&gt;0 &amp;&amp; !player.ship.weaponsOnline) this._switchOn();
};
this.compassTargetChanged = function(){
	if(!this.$VSE || !this.$VSE.isValid) return;
	if(this.$POI) this.$VSE.orientation = player.ship.compassTarget.position.rotationTo(this.$POI);
	else this.$VSE.orientation = player.ship.compassTarget.position.rotationTo(this.$defs.rel);
};
this.weaponsSystemsToggled = function(state){
	if(state) this._switchOff();
	else if(player.alertCondition&lt;3) this._switchOn();
};
this._switchOn = function(){
	if(!this.$VSE || !this.$VSE.isValid) return;
	this.$VSE.script.$hide = true;
	if(!this.$EnableTimer) this.$EnableTimer = new Timer(this,this._doEnableTimer,1);
};
this._switchOff = function(){
	if(!this.$VSE || !this.$VSE.isValid) return;
	this.$VSE.shaderFloat1 = 0;
	this.$VSE.script.$hide = false;
};
this._toggleMP = function(){
	if(!this.$VSE || !this.$VSE.isValid) return;
	this.$VSE.script.$PSC = !this.$VSE.script.$PSC;
};
// Update after populator
this.shipExitedWitchspace = this.shipWillDockWithStation = this.shipWillLaunchFromStation = function(){
	this._update();
};
this._update = function(){
	if(this.$VSE &amp;&amp; this.$VSE.isValid) this.$VSE.remove();
	this.$VSE = null;
	this._updPlanets();
	this._updStations();
	this._updAsteroids();
	this._getMidpoint();
};
this._updPlanets = function(){
	var pl = system.planets;
	this.$pl = {pla:null,plp:[],plm:[]};
	for(var i=0;i&lt;pl.length;i++){
		if(pl[i].isMainPlanet) this.$pl.pla = pl[i];
		else {
			if(pl[i].hasAtmosphere) this.$pl.plp.push(pl[i]);
			else this.$pl.plm.push(pl[i]);
		}
	}
};
this._updStations = function(){
	var st = system.stations;
	this.$st = {sta:null,sth:[],stgal:[],stoth:[]};
	for(var i=0;i&lt;st.length;i++){
		if(st[i].isMainStation) this.$st.sta = st[i];
		else if(st[i].isRock &amp;&amp; st[i].name===&quot;Rock Hermit&quot;) this.$st.sth.push(st[i]);
		else {
			switch(st[i].allegiance){
				case &quot;galcop&quot;:
				case &quot;hunter&quot;:
				case &quot;neutral&quot;: this.$st.stgal.push(st[i]); break;
				default: if(st[i].beaconCode) this.$st.stoth.push(st[i]);
			}
		}
	}
};
this._updAsteroids = function(){
	this.$as = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; entity.isRock &amp;&amp; entity.name===&quot;Asteroid&quot;;},player.ship);
};
this._getMidpoint = function(){
	if(system.isInterstellarSpace){
		this.$defs.rel = this.$defs.off;
		return;
	} else {
		// no c as WP is [0,0,0]
		var a = this._compress(system.sun.position), b = this._compress(system.mainPlanet.position);
		this.$defs.rel = Vector3D([(a.x+b.x)/3,(a.y+b.y)/3,(a.z+b.z)/3]);
	}
};
// Compress far out
this._compress = function(pos){
	var pmag = pos.magnitude();
	if(pmag&gt;1199998.8) pos = Vector3D.interpolate(this.$defs.off,pos,1199998.8/pmag);
	return pos;
};
this._choices = function(choice){worldScripts.Lib_Starmap._choiceEval(choice); return;};
this._choiceEval = function(choice){
	player.ship.hudHidden = this.$HUD;
};
}).call(this);</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/Lib_Starmap.txt</td>
                    <td><pre>// Display traders
var a = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; !entity.isStation &amp;&amp; !entity.owner &amp;&amp; entity.isTrader;},player.ship),b=[&quot;PS&quot;,&quot;WP&quot;,&quot;P&quot;,&quot;ST&quot;,&quot;S&quot;];
for(var i=0;i&lt;7;i++){if(a.length&gt;i){b.push({map:&quot;lib_starmap_i2.png&quot;,ent:a[i],col:5});}}worldScripts.Lib_Starmap._start({ini:b});

// Display pirates
var a = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; !entity.isStation &amp;&amp; !entity.owner &amp;&amp; entity.isPirate;},player.ship),b=[&quot;PS&quot;,&quot;WP&quot;,&quot;P&quot;,&quot;ST&quot;,&quot;S&quot;];
for(var i=0;i&lt;7;i++){if(a.length&gt;i){b.push({map:&quot;lib_starmap_i3.png&quot;,ent:a[i],col:1});}}worldScripts.Lib_Starmap._start({ini:b});

// Display police
var a = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; !entity.isStation &amp;&amp; !entity.owner &amp;&amp; entity.isPolice;},player.ship),b=[&quot;PS&quot;,&quot;WP&quot;,&quot;P&quot;,&quot;ST&quot;,&quot;S&quot;];
for(var i=0;i&lt;7;i++){if(a.length&gt;i){b.push({map:&quot;lib_starmap_i1.png&quot;,ent:a[i],col:4});}}worldScripts.Lib_Starmap._start({ini:b});

// Default - Player, Witchpoint, Planet, Sun, MainStation, Hermit, Asteroid fields and secondary stations
worldScripts.Lib_Starmap._start( { ini:[&quot;PS&quot;,&quot;WP&quot;,&quot;P&quot;,&quot;S&quot;,&quot;ST&quot;,&quot;H&quot;,&quot;AS&quot;,&quot;AS&quot;,&quot;AS&quot;,&quot;STG&quot;,&quot;STG&quot;,&quot;STG&quot;] } );

// Display fun
var a = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; !entity.isStation &amp;&amp; !entity.owner &amp;&amp; entity.isTrader},player.ship),
	c = system.filteredEntities(this,function(entity){return entity.isShip &amp;&amp; !entity.isStation &amp;&amp; !entity.owner &amp;&amp; entity.isPirate &amp;&amp; entity.group &amp;&amp; entity.group.leader &amp;&amp; entity.entityPersonality===entity.group.leader.entityPersonality;},player.ship),
	b=[&quot;PS&quot;,&quot;WP&quot;,&quot;P&quot;,&quot;ST&quot;,&quot;S&quot;];
for(var i=0;i&lt;15;i++){
	if(b.length===12) break;
	if((i&amp;1) &amp;&amp; a.length&gt;i){b.push({map:&quot;lib_starmap_i2.png&quot;,ent:a[i],col:5});}
	else if(c.length&gt;i){b.push({map:&quot;lib_starmap_i2.png&quot;,ent:c[i],col:1});}
}
worldScripts.Lib_Starmap._start({ini:b});
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/lib_conditions.js</td>
                    <td><pre>/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
&quot;use strict&quot;;
this.name = &quot;lib_conditions&quot;;

this.allowSpawnShip = function(shipKey){
	return true;
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/lib_fx.js</td>
                    <td><pre>/* global addFrameCallback,player,removeFrameCallback */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;lib_fx&quot;;

this.$time = 0;
// Set on spawning
this.$repos = 250; 
this.$reposTil = 0;
this.$ridTime = 4;
this.$look = 0;
this.$view = 0;
this.$offset = 0;
this.$glare = player.ship.sunGlareFilter;
player.ship.sunGlareFilter = 1;

this.effectSpawned = function(){
	this.$fcb = addFrameCallback(this._repos.bind(this));
};
this.effectRemoved = function(){
	removeFrameCallback(this.$fcb);
};
this._repos = function(delta){
	var ps = player.ship,vF=ps.vectorForward,lv,v,pos,npos,sgf;
	if(!ps.isValid || this.$time&gt;this.$ridTime){
		this.visualEffect.remove();
		return;
	}
	this.$time += delta;
	if(!delta) return;
	if(this.$glare&lt;1 &amp;&amp; this.$time&gt;this.$reposTil-1){
		if(ps.sunGlareFilter-delta&gt;this.$glare) ps.sunGlareFilter -= delta;
		else ps.sunGlareFilter = this.$glare;
	}
	if(this.$reposTil &amp;&amp; this.$time&gt;this.$reposTil) this.$repos = 0;
	if(this.$repos){
		if(this.$view){
			switch(ps.viewDirection){
				case &quot;VIEW_AFT&quot;: pos = ps.position.add(ps.viewPositionAft); break;
				case &quot;VIEW_PORT&quot;: pos = ps.position.add(ps.viewPositionPort); break;
				case &quot;VIEW_STARBOARD&quot;: pos = ps.position.add(ps.viewPositionStarboard); break;
				case &quot;VIEW_FORWARD&quot;: pos = ps.position.add(ps.viewPositionForward); break;
				default: pos = ps.position;
			}
			pos = pos.add(vF.multiply(this.$repos));
		} else pos = ps.position.add(vF.multiply(this.$repos)).add(ps.vectorUp.multiply(this.$offset));
		this.visualEffect.position = pos;
		this.visualEffect.orientation = ps.orientation;
		if(this.$look){
			switch(ps.viewDirection){
				case &quot;VIEW_AFT&quot;: lv = [0,0,-1.07]; break;
				case &quot;VIEW_PORT&quot;: lv = [-3,0,1.4]; break;
				case &quot;VIEW_STARBOARD&quot;: lv = [3,0,1.4]; break;
				case &quot;VIEW_FORWARD&quot;: lv = [0,0,1.4]; break;
				default: lv = [0,0,1.4];
			}
			this.visualEffect.shaderVector2 = lv;
		}
	}
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/lib_shield.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;lib_shield&quot;;

this.$fcb;
this.$parent;

this.effectSpawned = function(){
	this.$fcb = addFrameCallback(this._updatePosition.bind(this));
};
this.effectRemoved = function(){
	removeFrameCallback(this.$fcb);
};
this._updatePosition = function(){
	if(!this.$parent) return;
	if(player.ship.position){
		this.visualEffect.position = this.$parent.position.subtract(this.$parent.vectorForward.multiply(-120));
		this.visualEffect.position = this.visualEffect.position.add(this.$parent.position.subtract(player.ship.position).direction().multiply(3));
	} else removeFrameCallback(this.$fcb);
};
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/lib_starmap12.js</td>
                    <td><pre>/* global addFrameCallback,player,removeFrameCallback,Vector3D */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 */
(function(){
&quot;use strict&quot;;
this.name = &quot;lib_starmap12&quot;;

this.$upd = [];
this.$c = 0;
this.$pos = null;
this.$pmag = 0;
this.$ps = player.ship;
this.$defs = null;
this.$mul = 0.00015;
this.$hide = true;
this.$PSC = 0;
this.effectSpawned = function(){
	this.$fcb = addFrameCallback(this._repos.bind(this));
};
this.effectRemoved = function(){
	removeFrameCallback(this.$fcb);
};
this._repos = function(){
	if(!this.$ps.isValid || !this.$ps.isInSpace){
		this.visualEffect.remove();
		return;
	}
	if(!this.$defs || (!this.visualEffect.shaderFloat1 &amp;&amp; !this.$hide)) return;
	else {
		var ul = this.$upd.length;
		this.visualEffect.position = this.$ps.position.add(this.$ps.vectorForward.multiply(400)).add(this.$ps.vectorUp.multiply(80)).add(this.$ps.vectorRight.multiply(80));
		switch(this.$c){
			case 0: if(ul) this._updatePos(this.$upd[0]); break;
			case 1: if(ul&gt;1) this._updatePos(this.$upd[1]); break;
			case 2: if(ul&gt;2) this._updatePos(this.$upd[2]); break;
			case 3: if(ul&gt;3) this._updatePos(this.$upd[3]); break;
			case 4: if(ul&gt;4) this._updatePos(this.$upd[4]); break;
			case 5: if(ul&gt;5) this._updatePos(this.$upd[5]); break;
			case 6: if(ul&gt;6) this._updatePos(this.$upd[6]); break;
			case 7: if(ul&gt;7) this._updatePos(this.$upd[7]); break;
			case 8: if(ul&gt;8) this._updatePos(this.$upd[8]); break;
			case 9: if(ul&gt;9) this._updatePos(this.$upd[9]); break;
			case 10: if(ul&gt;10) this._updatePos(this.$upd[10]); break;
			case 11: if(ul&gt;11) this._updatePos(this.$upd[11]); break;
		}
		this.$c++;
		this.$c %= 12;
	}
};
this._updatePos = function(obj){
	if(!obj.ent) return;
	if(!obj.ent.isValid || !obj.ent.isInSpace){
		this.visualEffect.subEntities[obj.sub].shaderVector1 = [0,0,1];
		obj.ent = null;
	} else {
		this.$pos = obj.ent.position;
		this.$pmag = this.$pos.magnitude();
		if(this.$PSC){
			if(this.$pmag&gt;1199998.8) this.$pos = Vector3D.interpolate(this.$ps.position,this.$pos,1199998.8/this.$pmag);
			this.visualEffect.subEntities[obj.sub].position = this.$pos.subtract(this.$ps.position).multiply(this.$mul);
		} else {
			if(this.$pmag&gt;1199998.8) this.$pos = Vector3D.interpolate(this.$defs,this.$pos,1199998.8/this.$pmag);
			this.visualEffect.subEntities[obj.sub].position = this.$pos.subtract(this.$defs).multiply(this.$mul);
		}
	}
};
}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/lib_test.js</td>
                    <td><pre>/* global system,worldScripts,Timer */
/* (C) Svengali 2016-2018, License CC-by-nc-sa-4.0 - Detect changes in custom role entity */
(function(){
&quot;use strict&quot;;
this.name = &quot;lib_test&quot;;

// There are a few AddOns which are changing / removing custom role entities. Uncalled!

this.shipSpawned = function(){
	delete this.shipSpawned;
	this.$checkTimer = new Timer(this,this._doCheck,0.5);
};
this._stopTimers = function(warn){
	if(this.$checkTimer) this.$checkTimer.stop();
	this.$checkTimer = null;
	return;
};
this._doCheck = function _doCheck(){
	var eq = {
		accuracy: -2,
		autoAI: false,
		autoWeapons: false,
		bounty: 0,
		cloakAutomatic: false,
		energyRechargeRate: 3,
		fuel: 6,
		heatInsulation: 1,
		isBeacon: false,
		isCloaked: false,
		isDerelict: false,
		isJamming: false,
		isPirate: false,
		isPirateVictim: false,
		isPolice: false,
		isTrader: false,
		maxEnergy: 450,
		maxEscorts: 2,
		missileCapacity: 4,
		missileLoadTime: 4,
		name: &quot;Boa&quot;,
		shipClassName: &quot;Boa&quot;
	},
	eqs = {
		aftWeapon: [&quot;EQ_WEAPON_PULSE_LASER&quot;],
		equipment: [&quot;EQ_FUEL_SCOOPS&quot;,&quot;EQ_ESCAPE_POD&quot;],
		forwardWeapon: [&quot;EQ_WEAPON_PULSE_LASER&quot;],
		missiles: [&quot;EQ_MISSILE&quot;,&quot;EQ_MISSILE&quot;,&quot;EQ_MISSILE&quot;],
		portWeapon: [&quot;EQ_WEAPON_NONE&quot;],
		starboardWeapon: [&quot;EQ_WEAPON_NONE&quot;]
	},
	wps = [&quot;weaponPositionForward&quot;,&quot;weaponPositionAft&quot;,&quot;weaponPositionPort&quot;,&quot;weaponPositionStarboard&quot;],
	listA = Object.keys(eq), lA = listA.length,
	listB = Object.keys(eqs), lB = listB.length,
	i,j,k,cur, warn = worldScripts.Lib_Main._lib.$entCstChanged;
	for(i=0;i&lt;lA;i++) if(this.ship[listA[i]] !== eq[listA[i]] &amp;&amp; warn.indexOf(listA[i])===-1) warn.push(listA[i]);
	for(i=0;i&lt;lB;i++){
		cur = this.ship[listB[i]];
		if(cur.length){
			for(j=0;j&lt;cur.length;j++) if(cur[j].equipmentKey !== eqs[listB[i]][j] &amp;&amp; warn.indexOf(listB[i])===-1) warn.push(cur[j].equipmentKey);
		} else if(cur.equipmentKey !== eqs[listB[i]][0] &amp;&amp; warn.indexOf(listB[i])===-1) warn.push(listB[i]);
	}
	for(k=0;k&lt;4;k++) if(this.ship[wps[k]].length&gt;1 &amp;&amp; warn.indexOf(wps[k])===-1) warn.push(wps[k]);
	if(145!==this.shipDied.toSource().length+this.shipRemoved.toSource().length) worldScripts.Lib_Main._lib.$entCstPatched = true;
	this._stopTimers();
};
this.shipDied = function(){this._stopTimers();};
this.shipRemoved = function(){this._stopTimers(); worldScripts.Lib_Main._lib.$entCstRemoved = true;};
this.entityDestroyed = function(){this._stopTimers();};
this.shipLaunchedEscapePod = function(){this._stopTimers();};
this.shipWillEnterWormhole = function(){this._stopTimers();};
this.playerWillEnterWitchspace = function(){this._stopTimers();};
}).call(this);
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
