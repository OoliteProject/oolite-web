<html>
    <head>
        <title>Expansion Mining IFF Scanner Upgrade</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Mining IFF Scanner Upgrade</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
                <li>Unknown key &#39;information-url&#39; at https://wiki.alioth.net/img_auth.php/3/3e/Oolite.oxp.NewtSoup.MiningIFFScannerUpgrade.1.1.3.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>An upgrade to the IFF Scanner System to show asteroids, boulders and splinters in alternate colours for easier tracking when mining:  Asteroids are white/gray, Boulders white/orange and Splinters white/green. With an optional tweak to the scanner, cargo pods and escape pods can be included as white/cyan and white/purple respectively.

Updated by Milo to make the scanner upgrade equipment portable between ships, optimize status checks, change refund amount to full price as described (was coded as 10%), improve compatibility with OXPs that add cargo pods with non-standard names, improve compatibility with OXPs that manage ship equipment (e.g., Ship Storage Helper, Ship Configuration), and let other OXPs&#39; IFF colour overrides take priority (Asteroid Storm, Rescue Stations, Curse of the Black Sunspot, etc.).</td>
                    <td>An upgrade to the IFF Scanner System to show asteroids, boulders and splinters in alternate colours for easier tracking when mining:  Asteroids are white/gray, Boulders white/orange and Splinters white/green. With an optional tweak to the scanner, cargo pods and escape pods can be included as white/cyan and white/purple respectively.

Updated by Milo to make the scanner upgrade equipment portable between ships, optimize status checks, change refund amount to full price as described (was coded as 10%), improve compatibility with OXPs that add cargo pods with non-standard names, improve compatibility with OXPs that manage ship equipment (e.g., Ship Storage Helper, Ship Configuration), and let other OXPs&#39; IFF colour overrides take priority (Asteroid Storm, Rescue Stations, Curse of the Black Sunspot, etc.).</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.NewtSoup.MiningIFFScannerUpgrade</td>
                    <td>oolite.oxp.NewtSoup.MiningIFFScannerUpgrade</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Mining IFF Scanner Upgrade</td>
                    <td>Mining IFF Scanner Upgrade</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>NewtSoup, Milo</td>
                    <td>NewtSoup, Milo</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.1.3</td>
                    <td>1.1.3</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/3e/Oolite.oxp.NewtSoup.MiningIFFScannerUpgrade.1.1.3.oxz">https://wiki.alioth.net/img_auth.php/3/3e/Oolite.oxp.NewtSoup.MiningIFFScannerUpgrade.1.1.3.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873281</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Mining%20IFF%20Scanner%20Upgrade'>http://wiki.alioth.net/index.php/Mining%20IFF%20Scanner%20Upgrade</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_NS_MINING_SCANNER_UPGRADE.html">Mining IFF Scanner Upgrade</a></td>
                    <td>yes</td>
                    <td align="right">8000</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_NS_MINING_SCANNER_UPGRADE_REMOVAL.html">Sell Mining IFF Scanner Upgrade</a></td>
                    <td>no</td>
                    <td align="right">200</td>
                    <td align="center">12+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_NS_SCANNER_SCAVENGER_HACK.html">Apply Mining IFF Scanner Scavenger Hack</a></td>
                    <td>no</td>
                    <td align="right">200</td>
                    <td align="center">1+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_NS_UNDO_SCANNER_SCAVENGER_HACK.html">Restore Standard Mining IFF Scanner Code</a></td>
                    <td>no</td>
                    <td align="right">200</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>//This oxp was created mainly as a learning experience.  But also to give me better tracking on splinters when mining.  Works Great with  OreProcessor
//It was heavily influenced by Capt. Murphy&#39;s IFF Police Scanner Upgrade
&quot;use strict&quot;;
this.name		=&quot;NS_Mining_Scanner_Upgrade&quot;;
this.author		=&quot;NewtSoup&quot;;
this.copyright	=&quot;2017 NewtSoup&quot;;
this.licence	=&quot;CC BY-NC-SA 3.0&quot;; // see http://creativecommons.org/licenses/by-nc-sa/3.0/ for more info
this.description=&quot;Upgrade to the IFF Scanner to show Asteroids as white/gray, Boulders as white/orange and Splinters and Alloys ( collectible ) as white/green - with an optional add-on to include Cargo containers as white/cyan and Escape pods as white/purple.&quot;;
this.version	=&quot;1.1.3&quot;;

this.startUp = function()
{
	// initialize variables
	this.$equip_scanner_ok = false;
	this.$scavenger_upgrade = false;
	this.$MiningScannerTimer = null;
}

this._startTimer = function()
{
	if (this.$MiningScannerTimer) //if there is an existing timer already, simply restart it
	{
		this.$MiningScannerTimer.start();
		//player.consoleMessage(&quot;Mining IFF Scanner Upgrade Active&quot;);
	}
	else //otherwise, create a new timer called $MiningScannerTimer to call this._identifyRocks every 300 milliseconds and attach it to this equipment
	{
		this.$MiningScannerTimer = new Timer ( this, this._identifyRocks, 0, 0.3);
	}
}

this._stopTimer = function()
{
	//if scanner timer exists and is running then stop it 
	if (this.$MiningScannerTimer &amp;&amp; this.$MiningScannerTimer.isRunning)
	{
		this.$MiningScannerTimer.stop();
		//player.consoleMessage(&quot;Mining IFF Scanner Upgrade Stopped&quot;);
	}
}

//catch the playerBoughtEquipment event for removing the scanner or the hack
this.playerBoughtEquipment = function (equipment, paid) // 1.89 adds second parameter (paid), but we don&#39;t need it
{
	switch (equipment)
	{
		case &quot;EQ_NS_MINING_SCANNER_UPGRADE_REMOVAL&quot;:
			//remove the scanner
			player.ship.removeEquipment(&quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;);
			//remove the removal service placeholder as we don&#39;t want it to appear in the ship&#39;s installed equipment list
			player.ship.removeEquipment(&quot;EQ_NS_MINING_SCANNER_UPGRADE_REMOVAL&quot;);
			//refund the player the cost of the scanner
			player.credits += EquipmentInfo.infoForKey(&quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;).price;
			//check for the scavenger hack and if it exists then remove that too
			if ( player.ship.equipmentStatus(&quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;) !== &quot;EQUIPMENT_UNAVAILABLE&quot; )
			{
				player.ship.removeEquipment(&quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;);
			}
			break;
		case &quot;EQ_NS_UNDO_SCANNER_SCAVENGER_HACK&quot;:
			//remove the scanner hack
			player.ship.removeEquipment(&quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;);
			//remove the removal service placeholder
			player.ship.removeEquipment(&quot;EQ_NS_UNDO_SCANNER_SCAVENGER_HACK&quot;);
			break;
	}
}

//catch event when the player has launched
this.shipLaunchedFromStation = function (station)
{
	if ( player.ship.status === &quot;STATUS_IN_FLIGHT&quot; ) // double check
	{
		this.$equip_scanner_ok = player.ship.equipmentStatus(&quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;) === &quot;EQUIPMENT_OK&quot;; // true or false
		this.$scavenger_upgrade = player.ship.equipmentStatus(&quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;) === &quot;EQUIPMENT_OK&quot;; // true or false
		this._startTimer();
	}
}
//catch the player docking
this.shipWillDockWithStation = function(station)
{
	this._stopTimer();
}

//and entering witchspace
this.shipWillEnterWitchspace = function(cause, destination) // 1.81 adds second parameter (destination), but we don&#39;t need it
{
	this._stopTimer();
}
//and leaving witchspace
this.shipExitedWitchspace = function()
{
	this._startTimer();
}

this._filterRocksAndCargo = function _filterRocksAndCargo(entity)
{
	return (entity.scanClass === &quot;CLASS_ROCK&quot; || entity.scanClass ===&quot;CLASS_CARGO&quot;);
}

//called by the timer to change colours on the scanner to white and grey ( asteroid ), white and orange ( boulder ), white and green (splinter or alloy), white and cyan (cargo), white and purple (escape pod)
this._identifyRocks = function()
{
	//firstly check if the scanner is damaged or simply not there for some reason
	if (this.$equip_scanner_ok === false) return;

	var scanrange = player.ship.scannerRange; // get the current scanner range of the player&#39;s current ship - if we&#39;re zoomed in then this reduces the processing needed (I think)
	// filter entities with either scanClass &quot;CLASS_ROCK&quot; or &quot;CLASS_CARGO&quot; - asteroids and boulders are rock but splinters are cargo as they can be picked up by the player ship
	var rocks = system.filteredEntities(this, this._filterRocksAndCargo, player.ship, scanrange); //a variable to hold an array masquerading as a rock grader
	var idx = rocks.length;  //create an index variable for iterating
	//and awaaaaaay we go! (in your mind that&#39;s in the best Rick Sanchez voice you can imagine )
	while( idx-- ) // starting from the end and working backwards to simplify iteration
	{
		if ( (rocks[idx].scannerDisplayColor2 !== &quot;whiteColor&quot; &amp;&amp; rocks[idx].scannerDisplayColor2 !== null) || (rocks[idx].scannerDisplayColor1 !== &quot;whiteColor&quot; &amp;&amp; rocks[idx].scannerDisplayColor1 !== null) )
		{
			// the color was changed already (either by this timer on a previous check, or by another OXP) ... either way, don&#39;t override non-default colours, skip this &quot;rock&quot; (or alloy/cargo canister/escape pod)
			continue; // e.g., Asteroid Storm uses a cyan-like color, Rescue Stations has a scenario that colors certain rocks white/red, Curse of the Black Sunspot colors certain rocks red/yellow, etc.
		}
		else if ( rocks[idx].shipClassName === &quot;Asteroid&quot; )
		{
			//Asteroids will be White and Grey alternating
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;grayColor&quot;;
		}
		else if ( rocks[idx].shipClassName === &quot;Boulder&quot; )
		{
			//Boulders will be White and Orange alternating
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;orangeColor&quot;;
		}
		else if ( rocks[idx].shipClassName === &quot;Splinter&quot; || rocks[idx].shipClassName === &quot;Metal fragment&quot; ) // Staer9&#39;s Icesteroids OXP spawns alloys (metal fragments) instead of splinters
		{
			//Splinters or alloys - which can be collected - will be white and green alternating
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;greenColor&quot;;
		}
		else if ( this.$scavenger_upgrade === false ) // skip next two cases if no scavenger upgrade
		{
			continue;
		}
		else if ( rocks[idx].shipClassName === &quot;Cargo container&quot; )
		{
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;cyanColor&quot;;
		}
		else if ( rocks[idx].shipClassName === &quot;Escape capsule&quot; )
		{
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;purpleColor&quot;;
		}
		else if ( rocks[idx].hasRole(&quot;cargopod&quot;) ) // catch some OXP cargo pods that change the name from Cargo container to something else
		{
			rocks[idx].scannerDisplayColor1 = &quot;whiteColor&quot;;
			rocks[idx].scannerDisplayColor2 = &quot;cyanColor&quot;;
		}
	}
}

//catch the equipment damaged event
this.equipmentDamaged = function (equipment)
{
	switch (equipment)
	{
		case &quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;:
			//send a message to the console
			player.consoleMessage (&quot;Mining IFF Scanner Upgrade Damaged&quot;);
			this.$equip_scanner_ok = false;
			this._stopTimer();

			// below code disabled by Milo to avoid overwriting changes by other OXPs:  IFF colours already set remain, damaged equipment prevents colouring of newly detected entities

			//now remove the custom colours
			// var scanrange = player.ship.scannerRange;
			// I can&#39;t be bothered writing the same comments again, this is basically the same loop used to colour them in the first place.. read above.  If you don&#39;t get this you need more practice :P
			// var rocks = system.filteredEntities(this, this._filterRocksAndCargo, player.ship, scanrange);
			// var idx = rocks.length;
			// while ( idx-- )
			//{
				// if (rocks[idx].shipClassName === &quot;Asteroid&quot; || rocks[idx].shipClassName === &quot;Boulder&quot; || rocks[idx].shipClassName === &quot;Splinter&quot; || rocks[idx].shipClassName === &quot;Metal fragment&quot; || rocks[idx].shipClassName===&quot;Escape capsule&quot; || rocks[idx].shipClassName === &quot;Cargo container&quot;)
				//{
					// rocks[idx].scannerDisplayColor1 = null; // restore default scanner colour
					// rocks[idx].scannerDisplayColor2 = null; // restore default scanner colour
				// }
			// }
			break;
		//case &quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;: // not possible because equipment.plist sets damage_probability = 0 for this equipment
			//player.ship.setEquipmentStatus(&quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;, &quot;EQUIPMENT_OK&quot;);
			//break;
	}
}

//catch the equipment removed event added in Oolite 1.82 (called by removeEquipment and also when core replaces equipment with _DAMAGED variant due to damage or setEquipmentStatus)
this.equipmentRemoved = function(equipment)
{
	switch (equipment)
	{
		case &quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;:
			this.$equip_scanner_ok = false;
			this._stopTimer();
			break;
		case &quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;: // although equipment.plist sets damage_probability = 0 for this equipment, it can be removed by scripts or when player sells the scanner
			this.$scavenger_upgrade = false;
			break;
	}
}

//catch the equipment added event added in Oolite 1.82 (called by awardEquipment and also when core replaces _DAMAGED equipment with the original due to setEquipmentStatus)
this.equipmentAdded = function(equipment)
{
	switch (equipment)
	{
		case &quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;:
			this.$equip_scanner_ok = true;
			this._startTimer();
			break;
		case &quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;:
			this.$scavenger_upgrade = true;
			break;
	}
}

//catch the equipment repaired event
this.equipmentRepaired = function (equipment)
{
	switch (equipment)
	{
		case &quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;:
			this.$equip_scanner_ok = true;
			this._startTimer();
			break;
		case &quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;: // equipment.plist sets damage_probability = 0 for this equipment, so it shouldn&#39;t need to be repaired, but just in case a script overrides that ...
			this.$scavenger_upgrade = true;
			break;
	}
}

//player was killed
this.shipDied = function(whom, why)
{
	this.$equip_scanner_ok = false;
	this.$scavenger_upgrade = false;
	//stop all the clocks they are not needed any more, W.H Auden would be turning in his grave for that.
	this._stopTimer();
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/eq.ns.scavenger.hack.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name		=&quot;NS_Scavenger_Scanner_Hack&quot;;
this.author		=&quot;NewtSoup, Milo&quot;;
this.copyright	=&quot;2017 NewtSoup&quot;;
this.licence	=&quot;CC BY-NC-SA 3.0&quot;; // see http://creativecommons.org/licenses/by-nc-sa/3.0/ for more info.&quot;
this.description=&quot;Rock Hermit condition for purchasing the Mining Scanner Upgrade&quot;;
this.version	=&quot;1.1.2&quot;;

//this works without parameters because rock hermits are tech level 1 and sell nothing very much so no need to specify the equipment
//as it relies on the Mining Scanner Upgrade being present anyway.  So all we really need to do is when a player is browsing equipment just 
//check that they&#39;re docked at a rock hermit.

//revised by Milo so that Ship Storage Helper, Ship Configuration and other OXPs can manage this OXP&#39;s equipment
this.allowAwardEquipment = function(eqKey, ship, context) {
	if ( context === &quot;purchase&quot; &amp;&amp; player.ship.dockedStation.primaryRole !== &quot;rockhermit&quot;)
	{
		return false;
	}
	else // context === &#39;purchase&#39; (and rockhermit), &#39;scripted&#39; (Ship Storage Helper, etc.), &#39;newShips&#39; (other OXPs could list the scanner as standard equipment) or &#39;npc&#39; (if OXPs switch player ship temporarily, they may spawn a copy of the player ship under NPC/AI control, then switch back later -- allowing player equipment to be awarded to NPC ships in this case makes it easier for such OXPs to do the swap; we still have &quot;available_to_npcs&quot; = no; in equipment.plist to block random spawns)
	{
		return true;
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
