<html>
    <head>
        <title>Expansion SniperLockPlus</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion SniperLockPlus</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">2 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN CAPITAL LETTER E)(&#39;[]&#39; vs &#39;[Equipment]&#39;)</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>SniperLock Plus software keeps you on target, at ranges longer than 5km, with off-center weapon compensation</td>
                    <td>SniperLock Plus software keeps you on target, at ranges longer than 5km, with off-center weapon compensation</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.dybal.SniperLockPlus</td>
                    <td>oolite.oxp.dybal.SniperLockPlus</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>SniperLockPlus</td>
                    <td>SniperLockPlus</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Dybal</td>
                    <td>Dybal</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.0.2</td>
                    <td>1.0.2</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/SniperLockPlus">http://wiki.alioth.net/index.php/SniperLockPlus</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/f/f4/SniperLockPlus-1.0.2.oxz">https://wiki.alioth.net/img_auth.php/f/f4/SniperLockPlus-1.0.2.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4.0</td>
                    <td>CC BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873513</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/SniperLockPlus'>http://wiki.alioth.net/index.php/SniperLockPlus</a></p>
        <h3>Readme.txt</h3>
        <pre>SniperLock Plus
---------------
v1.0.2, by Dybal

SniperLock Plus is an upgraded version of SniperLock.

Like SniperLock, it makes small corrections to your ship steering to keep you on-target if you are in Forward or Aft views and your target is at least 5km away, but unlike its cousin it is able to compensate for of-center weapons.

It doesn&#39;t change the ship&#39;s optical pickups&#39; position, so if the ship has an off-center weapon, when SniperLock Plus is active the target will be locked aligned with the weapon and will appear off-center in the crosshairs.


Aknowledgements
---------------

This OXP is based on CommonSenseOTB&#39;s SniperLock OXP.

I would rather have updated the otiginal OXP, but since SniperLock OXP&#39;s license doesn&#39;t allow for modifications of the original OXP, I wrote instead an OXP that adds to it, without trying to completely supersed it: SniperLock Plus equipment costs significantly more and only brings a real benefit for those ships with weapons way off the longitudinal axis... for the vast majority of ships, whose weapons are not that off-center, SniperLock still offers better value.


Compatibility
-------------

This OXP requires Oolite version 1.89 or above.


License
-------

This work is release under the Creative Commons Attribution - Non-Commercial - Share Alike 4.0 (CC BY-NC-SA 4.0)
(https://creativecommons.org/licenses/by-nc-sa/4.0/)


Version History
---------------

Version 1.0.2 (december/2020):

* Fixes bug when calculating ship model weapon position offset.


Version 1.0.1 (december/2020):

* Fixes some issues with the plist format on Mac.


Version 1.0 (october/2020):

* Initial version
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SNIPERLOCK_PLUS.html">SniperLock Plus Software &amp; Control Interface</a></td>
                    <td>yes</td>
                    <td align="right">15000</td>
                    <td align="center">13+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SNIPERLOCK_PLUS_REMOVAL.html">Sell SniperLock Plus</a></td>
                    <td>yes</td>
                    <td align="right">0</td>
                    <td align="center">12+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/sniperlock_plus.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;sniperlock_plus&quot;;
this.author      = &quot;Dybal&quot;;
this.copyright   = &quot;Copyright 2020 Dybal&quot;;
this.license     = &quot;CC BY-NC-SA 4.0&quot;
this.description = &quot;Sniperlock Plus script&quot;;
this.version     = &quot;1.0.2&quot;;


this.$logging = true;
this.$debug = false;

this.$enabled = true; // Other OXPs can deactivate Sniper Lock Plus by assigning false to this
this.$slpAngleToLock = 0.002;  // How close to the target you have to move the crosshairs for SniperLock Plus to lock; default: 0.002
this.$slpAngleToUnlock = 0.06; // How far from the center of the crosshairs the target has to move between FCBs for SniperLock Plus to unlock; default: 0.06
this.$slpDuration = 12; // How long SniperLock keeps a target loked; default: 12
this.$slpOriginalPitch; // stores the player&#39;s ship original maxPitch, so we can detect maneuverability reductions and compensate
this.$slpState = &quot;OFF&quot;;
this.$slpTarget; // target in last FCB call
this.$slpLastAngle; // angle to target in last FCB call
//
// Event Handlers
//

//--------------------------------------------------------------------------------------------//
this.startUp = function _slp_startUp() {
    this.$enabled = true; // reset
    this.$slpState = &quot;OFF&quot;;
    this.$slpCounter = 0; // to control the time locked on target
    this.$slpTargetPosition_1 = null;// aim is 1 frame behind true target position
    this.$slpTargetPosition_2 = null;// aim is 2 frames behind true target position
    this.$slpTargetPosition_3 = null;// aim is 3 frames behind true target position
    this.$slpOriginalPitch = player.ship.maxPitch;
}  

//--------------------------------------------------------------------------------------------//
this.playerBoughtNewShip = this.playerReplacedShip = function _slp_newShip() {
    this.$slpOriginalPitch = player.ship.maxPitch;
}

//--------------------------------------------------------------------------------------------//
this.playerBoughtEquipment = function _slp_playerBoughtEquipment(equipmentKey) {      
    var _player = player;

    if (equipmentKey === (&quot;EQ_SNIPERLOCK_PLUS_REMOVAL&quot;)) {
        let eqInfo = EquipmentInfo.infoForKey(&quot;EQ_SNIPERLOCK_PLUS&quot;);
        _player.ship.removeEquipment(&quot;EQ_SNIPERLOCK_PLUS&quot;);
        _player.ship.removeEquipment(&quot;EQ_SNIPERLOCK_REMOVAL&quot;);
        _player.credits += eqInfo.calculatedPrice * 0.5 / 10;
    } 
}
    
//--------------------------------------------------------------------------------------------//
this.equipmentRemoved = function _slp_equipmentRemoved(equipmentKey) {
    if (equipmentKey === &quot;EQ_SNIPERLOCK_PLUS&quot; &amp;&amp; this.$FCB &amp;&amp; isValidFrameCallback(this.$FCB))
        removeFrameCallback(this.$FCB);
}

//--------------------------------------------------------------------------------------------//
this.equipmentAdded = function _slp_equipmentAdded(equipmentKey) {
    var ship = player.ship;
    if (equipmentKey === &quot;EQ_SNIPERLOCK_PLUS&quot; &amp;&amp; ship.status === &quot;STATUS_IN_FLIGHT&quot;) {
        this.$slpState = &quot;OFF&quot;;
        this.$FCB = addFrameCallback(this.$sniperLock.bind(this, ship));
    }
}

//--------------------------------------------------------------------------------------------//
this.shipWillLaunchFromStation = function _slp_shipWillLaunchFromStation()    {
    var ship = player.ship;

    if (ship.equipmentStatus(&quot;EQ_SNIPERLOCK_PLUS&quot;) === &quot;EQUIPMENT_OK&quot;) {
        // obtain compensations for off-center weapons
        if (ship.forwardWeapon &amp;&amp; ship.forwardWeapon.equipmentKey !== &quot;EQ_WEAPON_NONE&quot;) {
            this.$forwardModelCorrection = this.$weaponModelPositionCorrection(ship.weaponPositionForward, &quot;Forward&quot;);
            if (this.$logging) log(this.name, ship.displayName+&quot;: forward weapon correction: &quot;+this.$forwardModelCorrection);
        } else
            this.$forwardModelCorrection = Vector3D(0,0,0); // player might have changed ship

        if (ship.aftWeapon &amp;&amp; ship.aftWeapon.equipmentKey !== &quot;EQ_WEAPON_NONE&quot;) {
            this.$aftModelCorrection = this.$weaponModelPositionCorrection(ship.weaponPositionAft, &quot;Aft&quot;);
            if (this.$logging) log(this.name, ship.displayName+&quot;: aft weapon correction: &quot;+this.$aftModelCorrection);
        } else
            this.$aftModelCorrection = Vector3D(0,0,0); // player might have changed ship
        this.$slpState = &quot;OFF&quot;;
        this.$FCB = addFrameCallback(this.$sniperLock.bind(this, ship));
    }
}

//--------------------------------------------------------------------------------------------//
this.shipDockedWithStation = function _slp_shipDockedWithStation() {
    if (this.$FCB &amp;&amp; isValidFrameCallback(this.$FCB)) removeFrameCallback(this.$FCB);
}
    
//--------------------------------------------------------------------------------------------//
this.shipWillEnterWitchspace = function _slp_shipWillEnterWitchspace() {
    if (this.$FCB &amp;&amp; isValidFrameCallback(this.$FCB)) removeFrameCallback(this.$FCB);
}
    
//--------------------------------------------------------------------------------------------//
this.shipExitedWitchspace = function _slp_shipExitedWitchspace() {
    var ship = player.ship;
 
    if (ship.equipmentStatus(&quot;EQ_SNIPERLOCK_PLUS&quot;) === &quot;EQUIPMENT_OK&quot;) {
        this.$slpState = &quot;OFF&quot;;
        this.$FCB = addFrameCallback(this.$sniperLock.bind(this, ship));
    }   
}
    
//--------------------------------------------------------------------------------------------//
//this.shipTargetAcquired = function _slp_shipTargetAcquired() {
//    if (this.$enabled) {
//        this.$slpTargetPosition_1 = null;
//        this.$slpTargetPosition_2 = null;
//        this.$slpTargetPosition_3 = null;
//        this.$slpState = &quot;READY&quot;;
//        this.$slpCounter = 0;
//    }
//}

//--------------------------------------------------------------------------------------------//
this.shipDied = function _slp_shipDied() {
    if (this.$FCB &amp;&amp; isValidFrameCallback(this.$FCB)) removeFrameCallback(this.$FCB);
}      



//
// Internal Functions
//

//--------------------------------------------------------------------------------------------//
this.$sniperLock = function _slp_sniperLock(ship) {
    var that = _slp_sniperLock;
    var fwdModelCorrection = this.$forwardModelCorrection;
    var aftModelCorrection = this.$aftModelCorrection;
    var applyFwdCorrection = (fwdModelCorrection != Vector3D(0,0,0));
    var applyAftCorrection = (aftModelCorrection != Vector3D(0,0,0));
    var viewDirection = ship.viewDirection;
    var modelCorrection = (viewDirection === &quot;VIEW_FORWARD&quot; ? fwdModelCorrection : aftModelCorrection);
    var applyCorrection = (viewDirection === &quot;VIEW_FORWARD&quot; ? applyFwdCorrection : applyAftCorrection);
    var debug = this.$debug &amp;&amp; ship.weaponsOnline;
    var logging = this.$logging;
    // compensate for reduced maneuverability in the unlock angle
    var angleToUnlock = this.$slpAngleToUnlock * (ship.maxPitch / this.$slpOriginalPitch);
    var angleToLock = this.$slpAngleToLock;
    var angleChange;

    if (angleToUnlock &lt;= angleToLock) 
        // if maxPitch is reduced too much, angleToUnlock would become less tha angleToLock, making it impossble to keep a lock
        angleToUnlock = 1.1 * angleToLock;

    if (!ship.target || !this.$enabled || 
        (ship.target &amp;&amp; ship.speed &gt; ship.maxSpeed &amp;&amp; ship.target.dataKey === &quot;telescopemarker&quot;) ||
        ship.equipmentStatus(&quot;EQ_SNIPERLOCK_PLUS&quot;) !== &quot;EQUIPMENT_OK&quot; ||
        ship.equipmentStatus(&quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot;) !== &quot;EQUIPMENT_OK&quot; ||
        (viewDirection !== &quot;VIEW_FORWARD&quot; &amp;&amp; viewDirection !== &quot;VIEW_AFT&quot;)) {
        if (this.$slpState !== &quot;OFF&quot;) {
            this.$slpTargetPosition_1 = null;
            this.$slpTargetPosition_2 = null;
            this.$slpTargetPosition_3 = null;
            this.$slpState = &quot;OFF&quot;;
            this.$slpCounter = 0;
            this.$slpTarget = null;
            this.$slpLastAngle = null;
        }
        return;
    }

    var sh =(viewDirection === &quot;VIEW_FORWARD&quot; ? ship.heading : ship.heading.multiply(-1));
    var tp, tv, ta, tp_aim;
    if (ship.target.isValid) {
        tp = ship.target.position;
        this.$slpDistance = ((tp.distanceTo(ship) - ship.target.collisionRadius) / 1000);
    } else {
        this.$slpDistance = 0;
    }

    if (this.$slpDistance &gt; 5.0 &amp;&amp; this.$slpDistance &lt; 25.6) {
        if (!this.$slpTarget || this.$slpTarget != ship.target) {
            // new target, reset everything
            if (debug) log(this.name, &quot;Target changed from &quot;+(this.$slpTarget ? this.$slpTarget.displayName : &quot;None&quot;)+&quot; to &quot;+ship.target.displayName);
            this.$slpTargetPosition_1 = null;
            this.$slpTargetPosition_2 = null;
            this.$slpTargetPosition_3 = null;
            this.$slpState = &quot;READY&quot;;
            this.$slpCounter = 0;
            this.$slpTarget = ship.target;
        }

        tv = tp.subtract(ship).direction(); // direction to target
        ta = sh.angleTo(tv); // angle to target
        angleChange = (this.$slpLastAngle != null ? Math.abs(this.$slpLastAngle - ta) : null); 
        if (this.$slpState === &quot;READY&quot;) {
            this.$slpLastAngle = ta;
            if (debug &amp;&amp; (angleChange == null || angleChange &gt; 0.000001)) log(this.name, &quot;target: &quot;+ship.target.displayName+&quot;, angle to target: &quot;+ta.toFixed(4)+&quot; lock if &lt;= &quot;+angleToLock.toFixed(6)+&quot;, angle change: &quot;+(angleChange?angleChange.toFixed(7):&quot;None&quot;));

            if (ta &lt;= this.$slpAngleToLock) {
                // close enough, Lock!
                if (debug) log(this.name, &quot;target: &quot;+ship.target.displayName+&quot;, angle to target: &quot;+ta.toFixed(4)+&quot;, less than &quot;+this.angleToLock.toFixed(6)+&quot;, LOCKED&quot;);
                this.$slpTargetPosition_1 = tp;
                this.$slpTargetPosition_2 = tp;
                this.$slpTargetPosition_3 = tp;
                this.$slpLastAngle = null;
                this.$slpState = &quot;ON&quot;;
            }
        }

        if (this.$slpState === &quot;ON&quot;) {
            this.$slpCounter += 1;
            // if angle to target didn&#39;t change from last iteration, weapon is still aligned and nothing to do
            if (angleChange &amp;&amp; angleChange &lt; 0.000001) return;
            this.$slpLastAngle = ta;

            if ((angleChange &amp;&amp; angleChange &gt; angleToUnlock) || this.$slpCounter &gt; this.$slpDuration) {
            if (debug) log(this.name, &quot;target: &quot;+ship.target.displayName+&quot;, angle to target: &quot;+ta.toFixed(4)+&quot;, changed: &quot;+angleChange.toFixed(7)+&quot; threshold to unlock &quot;+angleToUnlock.toFixed(6)+&quot;, counter: &quot;+this.$slpCounter+&quot;, UNLOCKED&quot;);
                this.$slpTargetPosition_1 = null;
                this.$slpTargetPosition_2 = null;
                this.$slpTargetPosition_3 = null;
                this.$slpState = &quot;READY&quot;;
                this.$slpCounter = 0;
                return;
            }
            if (debug) log(this.name, &quot;target: &quot;+ship.target.displayName+&quot;, angle to target: &quot;+ta.toFixed(4)+&quot;, changed: &quot;+angleChange.toFixed(7)+&quot; less than &quot;+angleToUnlock.toFixed(6)+&quot;, KEPT LOCKED&quot;);
                
            if (applyCorrection) {
                var correction = this.$weaponPositionCorrection(ship, modelCorrection);
                tp_aim = this.$slpTargetPosition_3.add(correction);
                if (debug) log(this.name, ship.displayName+&quot; target position: &quot;+this.$slpTargetPosition_3+&quot;, aiming point:&quot; + tp_aim);
            } else
                tp_aim = this.$slpTargetPosition_3;
            let tvc = tp_aim.subtract(ship).direction();
            let tac = sh.angleTo(tvc);
            let cr = sh.cross(tvc).direction();
            let new_orientation = ship.orientation.rotate(cr,-tac);
            let dot = new_orientation.dot(ship.orientation); 
            if (dot &lt; 1) {
                if (debug) log(this.name, &quot;Orientation changed, dot=&quot;+dot.toFixed(4));
                ship.orientation = ship.orientation.rotate(cr,-ta);
            }
            this.$slpTargetPosition_3 = this.$slpTargetPosition_2;
            this.$slpTargetPosition_2 = this.$slpTargetPosition_1;
            this.$slpTargetPosition_1 = tp;
            this.$slpTarget = ship.target;
        } 
    }

    if (this.$slpState === &quot;ON&quot; &amp;&amp; this.$slpDistance &lt;= 5.0) {
        // target closer than minimun distacne, reset but keep target
        this.$slpTargetPosition_1 = null;
        this.$slpTargetPosition_2 = null;
        this.$slpTargetPosition_3 = null;
        this.$slpState = &quot;READY&quot;;
        this.$slpCounter = 0;
    }
}
    
//--------------------------------------------------------------------------------------------//
this.$weaponModelPositionCorrection = function _slp_weaponModelPositionCorrection(weaponPosition, str) {
    var avgX, avgY , avgZ;
    avgX = avgY = avgZ = 0;
    var i = weaponPosition.length;
    while (i--) {
        avgX += weaponPosition[i].x;
        avgY += weaponPosition[i].y;
        avgZ += weaponPosition[i].z;
    }
    avgX /= weaponPosition.length;
    avgY /= weaponPosition.length;
    var avg_wp_pos = Vector3D(avgX, avgY, avgZ);
    var z_wp_pos = Vector3D(0, 0, avgZ);
    var correction = z_wp_pos.subtract(avg_wp_pos);
    if (this.$debug) log(this.name, str+&quot;: average position: &quot;+avg_wp_pos+&quot;, centerline position: &quot;+z_wp_pos+&quot;, correction: &quot;+correction);
    return correction
}

//--------------------------------------------------------------------------------------------//
this.$weaponPositionCorrection = function _slp_weaponPositionCorrection(ship, model_correction) {
    var world_correction = model_correction.rotateBy(ship.orientation);
    var debug = this.$debug &amp;&amp; player.ship.weaponsOnline;

    if (this.$debug) log(this.name, ship.displayName+&quot; model_correction: &quot;+model_correction+&quot;, world: &quot;+world_correction+&quot;, ship position: &quot;+ship.position);
    return world_correction;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/sniperlock_plus_conditions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;sniperlock_plus_conditions&quot;;
this.author      = &quot;Dybal&quot;;
this.copyright   = &quot;Copyright 2020 Dybal&quot;;
this.license     = &quot;CC BY-NC-SA 4.0&quot;
this.description = &quot;Sniperlock Plus conditions script&quot;;
this.version     = &quot;1.0&quot;;



//--------------------------------------------------------------------------------------------//
this.updateEquipmentPrice = function _slp_updateEquipmentPrice(equipmentKey, currentPrice) {
    var ws = worldScripts.sniperlock_plus;
    var slStatus = player.ship.equipmentStatus(&quot;EQ_SNIPERLOCK&quot;);
    var slPrice = EquipmentInfo.infoForKey(&quot;EQ_SNIPERLOCK&quot;).price;

    if (slStatus === &quot;EQUIPMENT_OK&quot;) {
        var price = currentPrice - slPrice;
        if (ws.$debug) log(this.name, &quot;Rebating price of EQ_SNIPERLOCK (&quot;+formatCredits(slPrice/10, true, true)+&quot;) from &quot;+equipmentKey+&quot; price (&quot;+formatCredits(currentPrice/10,true,true)+&quot;): &quot;+formatCredits(price/10, true, true));
        return price;
    }
    if (ws.$debug) log(this.name, equipmentKey+&quot; price: &quot;+formatCredits(currentPrice/10, true, true));
    return currentPrice;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
