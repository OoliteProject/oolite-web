<html>
    <head>
        <title>Expansion Trails</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Trails</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Ships leaves condensation trails, rocks make gray vapour when move. Works without shaders but not recommended for old computers where FPS could be low when display many trails. No trails in Red Alert below 50 FPS if weapons are online.</td>
                    <td>Ships leaves condensation trails, rocks make gray vapour when move. Works without shaders but not recommended for old computers where FPS could be low when display many trails. No trails in Red Alert below 50 FPS if weapons are online.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Trails</td>
                    <td>oolite.oxp.Norby.Trails</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Trails</td>
                    <td>Trails</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ambience</td>
                    <td>Ambience</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.11</td>
                    <td>1.11</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Trails">http://wiki.alioth.net/index.php/Trails</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/c/ca/Trails_1.11.oxz">https://wiki.alioth.net/img_auth.php/c/ca/Trails_1.11.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 4</td>
                    <td>CC BY-NC-SA 4</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873471</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Trails'>http://wiki.alioth.net/index.php/Trails</a></p>
        <h3>Trails_readme.txt</h3>
        <pre>Trails

NPC ships leaves condensation trails. Rocks make gray vapour when move.

Player ship will not make trail to avoid disturbing the aft view.

Based on Zireael&#39;s Engine Trails but rewritten from scratch to avoid the &quot;Universe is full&quot; error.

The default lifetime of a trail element is 9 seconds, the maximal length is 300m and will be reduced automatically when the total number of entities step over 1500.

The lifetime and the number of used light sources will be reduced below 25 FPS which cause thicker trails.

No trails in Red Alert below 50 FPS if weapons are online for smooth combat.

Visual elements based on the fuel leak effect in CommonSenseOTB&#39;s CustomShields OXP.


Instructions:

Do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.

License:

This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.


Changelog:
 2016.05.04. v1.11 No trails after mini ships below 10t mass like Tie Fighters.
 2016.02.16. v1.9  No trails in Red Alert below 50 FPS if weapons are online for smooth combat.
                   Fixed trail on Gnat, thanks to phkb.
 2016.02.15. v1.8  Render trail elements in sight only, others moved far away.
                   Lifetime of elements start at 9 seconds and step down to 3 seconds in low-FPS.
 2016.02.14. v1.7  New low-FPS mode added.
 2016.02.13. v1.6  Time-based trail dissipation so trail length is depending on speed.
                   Less visible trails at long range.
                   Thinner trail on small ships.
                   Missiles are excluded.
 2016.02.03. v1.5  Sparks in Griff Alloys and Wreckage OXP are are excluded for explosions.
 2016.02.03. v1.4  Wreckages, alloys and cargopods are excluded for speed up explosions.
                   Increase quality back to normal over 50 FPS and not the double of MinFPS.
 2016.02.03. v1.3  Rocks make gray vapour when move.
                   Speedup for explosions: wreckages make rare trail only.
                   General speedup due to less flashers (half than before).
                   Another speedup on trails over 12km.
                   Default of MinFPS is increased to 25 FPS.
                   Fixed an oddity with Telescope.
 2015.05.01. v1.2  Escort ships on EscortDeck does not exhaust fumes anymore.
                   Fixed a gap after fast ships.
                   No more trails after ships without exhaust like Thargoids, Nyoka.
                   Steam trails after moving rocks.
                   Always use less flashers in trails over 10km.
                   Trail starts near the engine.
 2015.05.01. v1.1  Use less flashers in trails for better performance.
                   Visibility of trails increased up to 2x scanner range.
 2015.04.30. v1.0  First release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/trails.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name	= &quot;trails&quot;;
this.author	= &quot;Norby&quot;;
this.copyright	= &quot;2015 Norby&quot;;
this.description= &quot;Ships leaves condensation trails&quot;;
this.licence	= &quot;CC BY-NC-SA 4.0&quot;;

this.$GoodFPS = 50; //if FPS is over this and quality is reduced then increase back
this.$LowFPS = 25; //if fall below then reduce quality using smaller number in dataKey
this.$Zoom = false; //increase brightness over 12km to detect far ships, disabled in ambience pack

//internal properties, should not touch
this.$Delta = 0; //delta counter for FCB
this.$Delta2 = 0; //store first delta in the last second for FCB
this.$Distance = 60; //distance between trail elements based on effectada.plist
this.$ED = null; //store a pointer to escortdeck worldscript
this.$FC = 0; //frame counter for calculating FPS
this.$FP = null; //FCB pointer
this.$FPS = 60; //lastly measured FPS
this.$Length = this.$MaxLength; //actual length to avoid &quot;Universe is full&quot;
this.$MaxAngle = 0.7; //max. angle of sight in radian (0.7 for FOV80), move far away if out of sight
this.$MaxKey = 3; //max. used dataKey from effectdata.plist (&quot;trails3&quot;)
this.$Key = this.$MaxKey; //start at the max. available dataKey
this.$MaxLength = 50; //how many elements are in a trail (60m each) based on effectdata.plist
this.$MaxSec = 3 + 2*this.$MaxKey; //max timeout of trail elements in seconds (9)
this.$Old = false; //old version before Oolite v1.82
this.$Red = false; //No trails in red alert below 50 FPS if weapons are online
this.$S = [];	//tracked ships and visualEffects
		//$S[i][0]: the ship object,
		//$S[i][1]: last position of the ship where a visualEffect is created - unused
		//$S[i][2]: lastly used &quot;k&quot; indexes
                //$S[i][k] where k &gt;= 3: visualEffects
this.$Sec = this.$MaxSec; //timeout of trail elements in seconds (3-6)
this.$Shift = 10000000000; //x coord. shift if the trail element is not in sight
this.$T = [];	//timestamps of the creation of the trail elements
//this.$V = [];	//storage of all visualEffects

//worldscript events
this.startUp = function() {
	this.$ED = worldScripts.escortdeck;
	this.$Clear(this);
	this.$FC = 0; //frame counter
	this.$Delta = 0; //delta counter
	if (0 &lt; oolite.compareVersion(&quot;1.82&quot;)) {
		this.$Old = true;
/*		
		//pre-creating visualEffects
		var key = &quot;trails&quot;;
		var pos = Vector3D(100000000,0,0);
		for( var i = 0; i &lt; 100; i++ ) {
			this.$V.push(system.addVisualEffect( key, pos ));
		}
*/		
	} else { //from Oolite v1.82 flashers in subentities are usable, like in &quot;trails+&quot;
		this.$Old = false;
	}
	if( !isValidFrameCallback( this.$FP ) )
                this.$FP = addFrameCallback( this.$FCB.bind(this) );
}

this.shipWillEnterWitchspace = function() {
	this.$Clear(this);
}

//local methods
this.$Clear = function(w) {  //start a new array, free up memory
	w.$Length = w.$MaxLength;
        w.$RemoveAllTrails(w);
	delete w.$S;
	w.$S = [];
	w.$S[0] = [];
	w.$S[0][0] = player.ship; //the first ship
        delete w.$T;
        w.$T = [];
        w.$T[0] = [];
        w.$Red = false;
}

this.$FCB = function( delta ) {
	var w = this; //worldscript
	var p = player.ship;
	var pp = false;
	if( p &amp;&amp; p.isValid ) pp = p.position;
	w.$FC++; //frame counter for calculating FPS
	w.$Delta += delta;
	if( w.$Delta &gt; w.$Delta2 + 1 &amp;&amp; pp ) { //like an 1s timer, search for new ships
		w.$FPS = w.$FC; //save measured fps for the trail length reducer code below
		w.$FC = 0; //reset frame counter
		w.$Delta2 = w.$Delta; //save delta
		
		//No trails in red alert below 50 FPS if weapons are online
                if( player.alertCondition &gt; 2 &amp;&amp; p.weaponsOnline ) {
                        if( !w.$Red &amp;&amp; w.$FPS &lt; w.$GoodFPS ) {
                                //first time after red alert started
                                w.$RemoveAllTrails(w);
                                w.$Red = true;
                        } //restore trails in red alert over 100FPS only
                        if( w.$Red &amp;&amp; w.$FPS &lt; 2 * w.$GoodFPS ) return;
                }
                w.$Red = false;
		
		var ships = [];
		if( !p.docked ) ships = p.checkScanner(false);//faster than filteredEntities
				//must use checkScanner with false to add the &quot;green&quot; escorts
				//and a good side effect boulders get steam tails
				//moreover true return the full list in Oolite 1.80 (fixed in 1.81)
		for( var i = 1; i &lt; w.$S.length; i++ ) { //remove trails of far ships
			var o = w.$S[i]; //data of an old ship
			var x = -2;
			if( o &amp;&amp; o[0] &amp;&amp; o[0].isValid ) {
				x = ships.indexOf( o[0] );
				if( w.$ED ) { //disable escort trails on deck, enable if launched
					if( !o[0].script ) //for sure
						o[0].setScript(&quot;oolite-default-ship-script.js&quot;);
					var pad = w.$ED.$EscortDeckShip.indexOf( o[0] );
					if( pad != -1 ) { //change on ships used by escortdeck only
                                                if( w.$ED.$EscortDeckShipPos[pad] )
                                                        o[0].script.$TrailsDisabled = true;
                                                else o[0].script.$TrailsDisabled = false;
					}
				}
			}
			//if invalid then docked, jumped or destroyed, leave to run remove below
			if( x == -1 ) { //not in the scanner anymore?
				//must check distance due to many ships near exhibitions
				//can leave out important ones from the limited checkScanner list
				if( pp.distanceTo( o[0].position ) &gt; 2 * p.scannerRange ) {
					for( var k = 3; k &lt;= w.$Length; k++ ) {
						var v = o[k]; //remove visualEffects
						if( v &amp;&amp; v.isValid ) v.remove();
					}
					w.$S[i] = false; //remove this ship from the tracked array
				}
			} else if( x &gt;= 0 ) ships[x] = false; //don&#39;t add into $S if already in

		}
		
		if( p.docked ) {
			if( w.$S[1] ) w.$Clear(w); //start a new array, free up memory
		} else for( var i = 0; i &lt; ships.length; i++ ) { //add new ships into $S
			var ship = ships[i];
			if( ship &amp;&amp; ship.isValid &amp;&amp; ship.maxSpeed &gt; 0 //do not add buoy, etc.
				&amp;&amp; ( ship.exhausts &amp;&amp; ship.exhausts[0] //need valid exhaust
					|| ship.scanClass == &quot;CLASS_ROCK&quot; )
                                &amp;&amp; !ship.isMissile
                                &amp;&amp; ship.primaryRole != &quot;wreckage&quot; //exclude for explosions
                                &amp;&amp; ship.primaryRole != &quot;oolite-wreckage-chunk&quot;
                                &amp;&amp; ship.primaryRole != &quot;alloy&quot;
                                &amp;&amp; ship.primaryRole != &quot;cargopod&quot;
                                &amp;&amp; ship.primaryRole != &quot;griffspark&quot; //explosion in griff&#39;s wreckages
				&amp;&amp; ship.dataKey != &quot;telescopemarker&quot; //exclude for Telescope
                                &amp;&amp; ship.mass &gt; 10000 //exclude TIE fighters and too small ships
                                &amp;&amp; ship.scanClass != &quot;CLASS_NO_DRAW&quot; ) { //exclude for sure
				//do not add escorts landed on EscortDeck
				var add = true;
				if( w.$ED ) {
					var pad = w.$ED.$EscortDeckShip.indexOf( ship );
					if( pad != -1 &amp;&amp; w.$ED.$EscortDeckShipPos[pad] ) {
						add = false;
					}
				}
				if( add ) {
					var l = w.$S.length; //add after the last ship
					w.$S[l] = [];
					w.$S[l][0] = ship;
                                        w.$T[l] = [];
				}
			}
		}
	}
	if( w.$Red ) return; //No trails in red alert below 50 FPS if weapons are online

	//reduce the number of flashers if FPS is low
        var newkey = false;
        if( w.$FPS &lt; w.$LowFPS ) {
		if( w.$Key &gt; 1 ) {
			w.$Key--;
                        newkey = true;
//                      player.consoleMessage(&quot;FPS:&quot;+w.$FPS+&quot; key:&quot;+w.$Key); //debug
		}
                w.$FPS = w.$LowFPS; //do not reduce again until the next measue
	} else if( w.$FPS &gt; w.$GoodFPS ) { //extend up to maxkey
                if( w.$Key &lt; w.$MaxKey ) {
                        w.$Key++;
                        newkey = true;
//                      player.consoleMessage(&quot;FPS:&quot;+w.$FPS+&quot; key:&quot;+w.$Key); //debug
		}
                w.$FPS = w.$GoodFPS; //do not extend again until the next measue
	}
	var key = &quot;trails&quot;+w.$Key;
        if( newkey ) w.$Sec = w.$MaxSec - 2 * w.$MaxKey + 2 * w.$Key;

	//reduce length over 1500 entity to prevent &quot;Universe is full&quot; error at 2047
	var a = system.allShips.length + system.allVisualEffects.length;
        var r = w.$Length;
	if( a &gt; 1500 &amp;&amp; w.$Length &gt; 10 ) { //too much entity
		r = Math.ceil( w.$Length/2 ); //reduced length
                w.$RemoveAllTrails(w); //restart trails
		w.$Length = r;
	}
	
	var zoom = w.$Zoom;
	
	//create new trail elements
	var dist = w.$Distance;
        var shift = w.$Shift;
        var ma = w.$MaxAngle;
	for( var i = 1; i &lt; w.$S.length; i++ ) { //start from 0 and player ship will make trail also
		var t = w.$S[i];
		if( t ) {
			var ship = t[0];
			if( ship &amp;&amp; ship.isValid &amp;&amp; !ship.isDerelict
				&amp;&amp; !ship.script.$TrailsDisabled ) {
				var sp = ship.position;
				var sc = 1;
				
                                if( ship.scanClass == &quot;CLASS_ROCK&quot; ) key = &quot;trails-rock&quot;;
                                else {
                                        key = &quot;trails&quot;+w.$Key;//need if the previous ship was over 12km
				        if( pp ) { //create less flashers over 12km
					        var pd = sp.distanceTo( pp ) / 1000;
					        if( pd &gt; 12 ) {
						        key = &quot;trails0&quot;;
						        if( zoom ) //increase size in 12-20km for brightness
                                                            sc = 1.5+Math.max(0,Math.min(2,pd/5-2));
					        } //below the same formula is used again, keep these equal
				        }
                                }

				var c = 0; //safety counter to surely exit from the next cycle soon
				//check distance of the last position where a trail is created
				//need to do in cycle if travelled more in the last frame than
				//the length of a visualEffect element in effectdata.plist (20m)
				//which is happen often with more than 1x TAF
				var k = t[2];
                                var bp = sp;//.add(ship.heading.multiply(w.$Distance));//start earlier
                                var ez = 1; //default for ships without engine like rocks
                                var e = ship.exhausts; //use engine exhaust z distance from ship center
                                if( e &amp;&amp; e[0] &amp;&amp; e[0].position &amp;&amp; e[0].position.z )
                                        ez = 1-Math.min(0, e[0].position.z); //ez must &gt;=1 for Gnat
                                var kp = bp;
                                if(t[k] &amp;&amp; t[k].isValid) {
                                        kp = t[k].position;
                                        if( kp.x &gt; 0.9*shift ) {//moved far away
                                                kp = Vector3D(kp.x-shift, kp.y, kp.z);
//                                              if(p.target == ship) log(w.name, ship.name+&quot; far i:&quot;+i); //debug
                                        }
                                }
                                var kv = t[k];
				while( c &lt; 50 &amp;&amp; ( !k || !kv || !kv.isValid
					|| bp.distanceTo(kp) &gt; dist/2+ez )) {
					c++;
					if( !w.$S[i][2] ) w.$S[i][2] = 3; //new trail
					k = w.$S[i][2];
					if( !k ) k = 3;
					var a = w.$S[i][k]; //actual (lastly created) visualEffect
					var pos = bp;
					var q = ship.orientation; //for the first element
					if( a &amp;&amp; a.isValid ) { //from the second element
                                                var ap = a.position;
                                                if( ap.x &gt; 0.9*shift ) //moved far away
                                                        ap = Vector3D(ap.x-shift, ap.y, ap.z);
						var u = bp.subtract(ap).direction();
						pos = ap.add(u.multiply(dist));
						if( a &amp;&amp; a.isVisualEffect ) {
							//facing from the previous trail element
							q = a.orientation;
							var z=pos.subtract(ap).direction();
							var ah = a.heading;
							var angle = ah.angleTo(z);
							//set the plane where we should rotate in
							var cr = ah.cross(z).direction();
							q = q.rotate( cr, -angle );
						}
					}
//					w.$S[i][1] = pos; //save the new position - unused

					k++; //index of the next item
					if( k &gt; w.$Length ) k = 3; //restart over $Length
					w.$S[i][2] = k; //save the new index
					
/*                                      //make the end of the trail darker but prevent blue end on gray dust
					if( ship.scanClass != &quot;CLASS_ROCK&quot; ) {
					        var pk = k+1; //previous k points to the oldest visualEffect
					        if( pk &gt; w.$Length ) pk = 3;
					        var pv = w.$S[i][pk]; //the oldest visualEffect
					        if( pv &amp;&amp; pv.isVisualEffect ) {
						        var nv = system.addVisualEffect(
							        &quot;trails-end&quot;, pv.position );
						        if( nv ) {
							        nv.orientation = pv.orientation;
                                                                nv.scaleX = nv.scaleY = 0.5; //shrink
							        pv.remove();
							        w.$S[i][pk] = nv; //save the new item
                                                        }
						}
					}
*/
					//move or replace old visual item
					var ov = w.$S[i][k];
                                        if( ov &amp;&amp; ov.isVisualEffect &amp;&amp; ov.dataKey == key ) {
                                                ov.position = pos;
                                                ov.orientation = q;
                                        } else {
                                                if( ov &amp;&amp; ov.isVisualEffect ) {
                                                        ov.remove();
                                                }
                                                var v = system.addVisualEffect( key, pos );
                                                if( v ) {
                                                        v.orientation = q;
                                                        w.$S[i][k] = v; //save the new element
                                                }
                                        }

                                        w.$T[i][k] = w.$Delta; //Timestamp of creation
                                        kv = w.$S[i][k];
                                        if( kv &amp;&amp; kv.isValid ) {
                                                kp = kv.position;
                                                if( kp.x &gt; 0.9*shift ) //moved far away
                                                        kp = Vector3D(kp.x-shift, kp.y, kp.z);
                                        } else kp = bp;
				}
//				if(c &gt; 40) log(w.name, ship.name+&quot; new i:&quot;+i+&quot; c:&quot;+c); //debug
				//increase flasher size with the distance
				if( sc &gt; 1 ) for( var j = 3; j &lt;= w.$Length; j++ ) {
					var v = w.$S[i][j];
					if( v &amp;&amp; v.isValid ) v.scaleX = v.scaleY = sc;
				}				//but not scaleZ!
			} else { //ship docked, jumped or destroyed
				var k = t[2]; //actual item index - old code without timestamp
				if( k ) {
					k++;// += 0.5; //slower count for slower remove
					if( k &gt; w.$Length ) k = 3; //restart over $Length
					w.$S[i][2] = k; //save the new index
					if( k == Math.floor(k) ) {
						if( w.$S[i][k] == -1 ) { //all visualEffect removed
							//so remove this ship from the tracked array
							for( var k = 3; k &lt;= w.$Length; k++ ) {
								var v = t[k]; //remove again for sure
								if( v &amp;&amp; v.isValid ) v.remove();
							}
							w.$S[i] = false; 
						} else {
							var ov = t[k]; //remove old visual item
							if( ov &amp;&amp; ov.isVisualEffect ) ov.remove();
							w.$S[i][k] = -1; //flag for remove ship
						}
					}
				}
			}
			
                        if( pp &amp;&amp; ship &amp;&amp; ship.isValid &amp;&amp; ship.scanClass != &quot;CLASS_ROCK&quot; ) {
                                var max = 1;
                                var sd = ship.position.distanceTo( pp );
                                if( !zoom ) {
                                        if( ship.mass &lt; 20000 ) max = 0.2;
                                        else if( ship.mass &lt; 30000 ) max = 0.4;
                                        else if( ship.mass &lt; 130000 ) max = 0.8;
                                } else {
                                        if( sd &gt; 12000 ) //zoom in 12-20km, same formula as above
                                                max = 1.5+Math.max(0,Math.min(2,sd/5000-2));
                                        else if( ship.mass &lt; 20000 ) max = 0.4;
                                        else if( ship.mass &lt; 30000 ) max = 0.8;
                                }
//                              var c = 0;
                                for( var j = 3; j &lt;= w.$Length; j++ ) {
                                        var v = w.$S[i][j];
                                        if( v &amp;&amp; v.isValid &amp;&amp; w.$T[i][j] ) {
//                                              c++;
                                                if( w.$Delta &gt; w.$T[i][j] + w.$Sec ) { //timeout
                                                        v.remove();
                                                        w.$S[i][j] = null;
                                                        w.$T[i][j] = null;
                                                } else {
                                                        var vp = v.position;
                                                        var ph = p.heading;
                                                        switch( p.viewDirection ) {
                                                            case &quot;VIEW_AFT&quot;:
                                                                    ph = ph.multiply(-1);
                                                                    break;
                                                            case &quot;VIEW_PORT&quot;:
                                                                    ph = p.orientation.vectorRight()
                                                                            .multiply(-1);
                                                                    break;
                                                            case &quot;VIEW_STARBOARD&quot;:
                                                                    ph = p.orientation.vectorRight();
                                                                    break;
                                                        }

/*                                                      //reduce flashers if far or near parallel - cause jams
                                                        var key2 = key;
                                                        if( w.$Key == 1 ) {
                                                                var an = vp.subtract(pp).angleTo(v.heading);
                                                                if( vp.distanceTo( pp )&gt;12000 || an&lt;0.3 ) {
                                                                        key2 = &quot;trails0&quot;;
                                                                //improve if not enough paralell
                                                                } else key2 = &quot;trails1&quot;;
                                                                if(p.target==ship) log(w.name, //debug
                                                                    an+&quot; i:&quot;+i+&quot; j:&quot;+j+&quot; x:&quot;+vp.x+&quot; &quot;+key2);
                                                        }*/
                                                        if( w.$Key &lt; 2 &amp;&amp; v.dataKey != key ) {
                                                                //immediately reduce quality in lowest mode
                                                                z = system.addVisualEffect(key, v.position);
                                                                if( z ) {
                                                                        z.orientation = v.orientation;
                                                                        v.remove();
                                                                        w.$S[i][j] = z;
                                                                        v = z;
                                                                }
                                                        }

                                                        //time-based trail dissipation
                                                        var s = 4;
                                                        if( !zoom || sd &lt; 12000 )
                                                                s = 2.01-((w.$Delta-w.$T[i][j])/w.$Sec)*2;
                                                        //s must be always greater than 0 for scale!
                                                        v.scaleX = v.scaleY = Math.min(max, s);//shrink

                                                        //performance boost:
                                                        //move far away if not in sight or over 15km
                                                        if( vp.x &lt; 0.9*shift ) {
                                                                var ang = ph.angleTo(vp.subtract(pp));
                                                                if( ang &gt;= ma || !zoom &amp;&amp; sd &gt; 15000 ) {
                                                                        v.position = Vector3D(
                                                                        vp.x + shift, vp.y, vp.z );
                                                                }
                                                        } else { //move back if in sight again
                                                                vp = Vector3D(vp.x-shift, vp.y, vp.z);
                                                                if( ph.angleTo(vp.subtract(pp)) &lt; ma
                                                                        &amp;&amp; ( zoom || sd &lt;= 15000 ) ) {
                                                                        v.position = vp;
                                                                }
                                                        }
                                                }
                                        }
                                }
                                //if(c &gt; 45) log(w.name, ship.name+&quot; end i:&quot;+i+&quot; c:&quot;+c); //debug
			}
		}
	}
}

this.$RemoveAllTrails = function(w) {  
        var i, k, t, v;
        for( i = 0; i &lt; w.$S.length; i++ ) {
                t = w.$S[i];
                if( t ) {
                        //remove the whole long trail
                        for( k = 3; k &lt;= w.$Length; k++ ) {
                                v = t[k];
                                if( v &amp;&amp; v.isValid ) v.remove();
                        }
                        w.$S[i][2] = 3;//reset visualEffect index
                }
        }
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
