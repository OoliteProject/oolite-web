<html>
    <head>
        <title>Expansion Gallery</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Gallery</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Show and zoom ships, meet Exhibitions and gain Visitor Levels.</td>
                    <td>Show and zoom ships, meet Exhibitions and gain Visitor Levels.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.Gallery</td>
                    <td>oolite.oxp.Norby.Gallery</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Gallery</td>
                    <td>Gallery</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Activities</td>
                    <td>Activities</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby</td>
                    <td>Norby</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.21</td>
                    <td>1.21</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Gallery">http://wiki.alioth.net/index.php/Gallery</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/7/71/Gallery_1.21.oxz">https://wiki.alioth.net/img_auth.php/7/71/Gallery_1.21.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873334</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Gallery'>http://wiki.alioth.net/index.php/Gallery</a></p>
        <h3>Gallery_readme.txt</h3>
        <pre>Gallery OXP

Show encountered ships and other space objects in Interfaces (F4).
Extend your gallery by flying around and targeting or fighting with ships and other space objects.

If you are a new pilot then you will only see purchasable ships from the station shipyards.

Press F4 when you are docked, then choose &quot;Gallery of encounters&quot; to see ship statistics and rotating models.

You will see how many ships and other space objects you have currently gathered and the list of last encounters.

Only the first name from each initials listed here to fit into the screen when you will have one in each letter also.


Gallery Menu

 &quot;Name&quot;
 Previous
 Search
 Rotate X+ / Stop / X- / Stop / Y+ / Stop / Y- / Stop
 Move X+ / Stop / X- / Stop / Y+ / Stop / Y- / Stop
 Zoom + / Stop / Zoom - / Stop
 Exit
 Hide Menu

The first line shows name of the current object displayed, select it to see the next rotating model.
You can step back, search, rotate, move, zoom and hide the menu to get a better view of the rotating model.

The Search menu uses text entry in Oolite 1.79. Oolite 1.77 uses a selection list.


Exhibitions

Check incoming ship meetings in Exhibitions Interface (F4) where you can add rare ships into your Gallery.
Type specific exhibitions contain ships which not in largest ones.
Beware of Pirate Meetings, there are aggressive guards out there!

Plan your route to arrive to the advertised systems in time. Exhibitions are organized near witchpoints.

You can request permission to rotate exhibition ships for viewing, after you have received permission it you can rotate the ship by locking target on it.
To help find which ship is missing from your Gallery these start rotating initially.
Select each rotating ship with a target lock to add these into your Gallery.
Some ships may only differ in colour (colouring need shaders, if your system does not aupport shaders then these ships will look identical).
After 5 minutes you must join the exhibition queue again so that other exhibition visitors can have their turn.


Visitor levels

Your visit to an exhibition will be registered when you target at least one ship in an exhibition.
You can increase your Visitor Level if you check more exhibitions.
You will receive messages when you reach the following levels of appreciation:

 Visit	Level
 1	Novice Visitor
 2	Unexpected Visitor
 4	Poor Visitor
 8	Below Average Visitor
 16	Average Visitor
 32	Above Average Visitor
 64	Competent Visitor
 100	Trustworthy Visitor!
 300	Expected Visitor!
 1000	Elite Visitor!


Private Exhibition Control equipment

You can order a private exhibition of purchasable ships before the dock where you are by either pay out this equipment or order in Exhibitions Interface.
A few days will elapse until all ships arrive.
You will be fined if you destroy any of them.

You can start and stop all rotation in Private Exhibition by priming (Shift+N) and activating (n) the Private Exhibition Control equipment.
To rotate one ship simply target it. Target a rotating ship to stop it rotating.

The mode (b) of the primed equipment shows how many ships there are in the Private Exhibition.
Some parts of the Private Exhibition will be hidden if too many ships causes display problems on your system. If this happens, select the mode (b) key to show the next part.

The Private Exhibition will be closed if you dock with another station (you can order a new Private Exhibition before the new station) or you jump into another system. The Private Exhibition will remain active if you take a rest (save then load game).

 Cost: 100.0 Cr.
 Techlevel: 1


Instructions:

In Oolite v1.79 or later do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.
In Oolite v1.77 make a Gallery.oxp subfolder in your AddOns folder and unzip the .oxz file into the newly created subfolder.


Limitations:

Depends on Oolite v1.77 but v1.79 or later recommended.

Every menu selection redraws the ship model, so shader colours and decals will change by when you select Rotate, Move, etc. 

Ship details are hidden based on the following (maybe need to extend):
* Technical Reference Library OXP (validator copied from v1.0.1 but call the original if TRL OXP installed),
* ccl_missionShip in scriptInfo,
* &quot;stealth&quot; word within dataKey or primaryRole.

This OXP use Ship.keys(), Ship.roles() and Ship.keysForRole(&quot;role&quot;) methods in Oolite v1.79.
There is a slow and inaccurate method for Oolite v1.77 which tries to get all ships, but a few ships are randomly left out. This OXP can cause a crash at game start there is if not enough memory (if spinning cobras appear then you have enough memory). You can reduce the $GalleryMaxIt variable in gallery.js to avoid the problem if needed, but more ships will be left out.

Can show ship.energyRechargeRate and ship.extraCargo in v1.79 only.

Ships with &quot;subent&quot; word in dataKey are removed to skip subentities in Griff_Shipset_Replace_v1.34.oxp.

Turrets, docks and other subentities without &quot;subent&quot; rule will appear in v1.79 if all objects mode enabled in gallery.js, there is no exact method to skip all of these.
In v1.77 it is not a problem due to the fallback method can include ships with given roles only (see in gallery.js, you can extend if you want) so all OXP ships without standard roles left out completely.


Setings in Scripts/gallery.js:

 this.$GalleryAll = false; //Gallery of all objects (cheat)
 this.$GalleryDefaultZoom = 1.5; //default size of ships
 this.$GalleryMaxIt = 5; //max. iteration in Oolite v1.77, reduce if cause problems
 this.$GalleryLog = false; //verbose log
 this.$GalleryRoles = [&quot;all&quot;, &quot;player&quot;, ... ]; //main roles, you can add more
 this.$GallerySpeed = 2; //move and zoom speed

Setings in Scripts/exhibitions.js:

this.$ExhibitionsAllShipsInPrivateExhibition = false; //show NPC ships in Private Exhibition (cheat)
this.$ExhibitionsLog = false; //verbose log
this.$ExhibitionsMaxShipsInLargeExhibitions = 144; //should be square number and min. 64
this.$ExhibitionsMinFPS = 20; //split Private Exhibition to get more than this frames per second
this.$ExhibitionsSpace = 150; //m space between ships in exhibition matrix


License:

This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.

Background image source: Start Choices OXP by spara.


Changelog:
 2015.04.25. v1.21 Many small fixes, thanks to QCS.
 2014.07.04. v1.20 Fix for seedy space bar and ships with ship script.
 2014.07.03. v1.19 Exhibitioins are moved forward to 10km from the player&#39;s exit point.
                   Oversized ships in Exhibitions are moved farther from others.
                   Small fix in gallery search.
 2014.05.19. v1.18 Fast startup in Oolite 1.79 by the new shipDataForKey.
 2014.05.18. v1.17 Back to the previous startup method after a fix in Oolite.
 2014.05.18. v1.16 Faster startup in Oolite 1.79 if many OXZs are installed.
 2014.01.17. v1.15 Small fix against &quot;Unknown expansion key [Exhibition Guard]&quot; log messages.
 2013.12.28. v1.14 Further proofreading by Keeper and Salon renamed to Private Exhibition.
 2013.12.15. v1.12 Proofreading by Ranthe.
 2013.12.13. v1.1  Salon split into more parts if needed to reach $ExhibitionsMinFPS.
 2013.12.06. v1.0  Exhibitions and Visitor levels.
                   List of last encounters.
 2013.11.27. v0.9  Salon Control equipment: exhibition of buyable ships at Navigation Buoy.
 2013.11.26. v0.8  Show shields from NPC Shields OXP and CustomShields OXP.
                   Fixed empty and duplicated names.
 2013.11.25. v0.7  Show encountered and playable ships only by default.
                   Show max.energy in banks, recharge in words and name instead of dataKey.
                   Details of some ships are hidden using Technical Reference Library OXP by spara.
                   Must set $GalleryAll to true if wanted all ships and details.
                   Search menu with text entry in Oolite 1.79 and selection list in 1.77.
 2013.11.23. v0.6  Works with Oolite v1.77 also (but slow and limited).
 2013.11.22. v0.5  First usable version.
 2013.11.21. v0.1  First test files.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_SALON_CONTROL.html">Private Exhibition Control</a></td>
                    <td>yes</td>
                    <td align="right">1000</td>
                    <td align="center">1+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/exhibitions-ship-script.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;exhibitions-ship-script&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Deactivated ship script placeholder&quot;;

//do nothing but must exist to attach to ships in exhibition to prevent original scripts
//working but keep the ship.script object in exist for sure,
//for example deterctors oxp insert variables into the ship script
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/exhibitions.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;exhibitions&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Ship exhibitions near witchpoints where player can earn Visitor Levels.&quot;;

//customizable properties
this.$ExhibitionsAllShipsInPrivateExhibition = false; //show NPC ships in Private Exhibition (cheat)
this.$ExhibitionsLog = false; //verbose log
this.$ExhibitionsMaxShipsInLargeExhibitions = 144; //should be square number and min. 64
this.$ExhibitionsMinFPS = 20; //split Private Exhibition to get more than this frames per second
this.$ExhibitionsSpace = 150; //m space between ships in exhibition matrix

//internal properties, should not touch
this.$ExhibitionsEndDate = []; //store the last valid date of exhibitions
this.$ExhibitionsFCB = null; //FrameCallBack to fill up and rotate exhibition
this.$ExhibitionsRoles = //for large exhibitions, without escort, hunter, thargoid, trader, player and pirate
	[&quot;interceptor&quot;,&quot;miner&quot;,&quot;police&quot;,&quot;scavenger&quot;,&quot;shuttle&quot;,&quot;buoy&quot;,&quot;cargopod&quot;,&quot;missile&quot;];
this.$ExhibitionsJ = 0; //index in player ships during exhibition creation, 0 mean no active exhibition
this.$ExhibitionsLastMenu = 0; //set marker to the lastly used exhibition menu line
this.$ExhibitionsLastStation = null; //Private Exhibition will before this station, update when dock into a new one
this.$ExhibitionsMenuFCB = null; //FrameCallBack for exhibitions menu
this.$ExhibitionsMO = null; //store initial orientation in menu
this.$ExhibitionsPerm = false; //permission to rotate ships in current exhibition
this.$ExhibitionsPermReqSent = false; //permission request sent
this.$ExhibitionsPosition = [null, null, null, null]; //pos, ori, vR, vU of exhibitions, will adjusted to player
this.$ExhibitionsSalon = 0; //Salon mean Private Exhibition in short, this variable avoid recreating ships after jump
this.$ExhibitionsSalonCost = 100; //must match with the cost of Private Exhibition Control in equipment.plist
this.$ExhibitionsSalonDelta = 0; //count delta to determine FPS in Private Exhibition
this.$ExhibitionsSalonDeltaC = 0; //counter to determine FPS in Private Exhibition
this.$ExhibitionsSalonJ = 0; //index in player ships during Private Exhibition creation
this.$ExhibitionsSalonO = null; //store Salon initial orientation
this.$ExhibitionsSalonP = null; //store Salon central position
this.$ExhibitionsSalonR = null; //store Salon initial vectorRight
this.$ExhibitionsSalonRot = false; //rotating Salon
this.$ExhibitionsSalonU = null; //store Salon initial vectorUp
this.$ExhibitionsSalonFCB = null; //FrameCallBack to fill up and rotate Salon
this.$ExhibitionsSalonShips = []; //store salon ships to fine if destroyed by player
this.$ExhibitionsSalonPart = 1; //actual part in splitted salon
this.$ExhibitionsSalonPartMax = 1; //salon splitted into how many parts
this.$ExhibitionsShips = []; //store ships to fine if destroyed by player
this.$ExhibitionsShipKeys = []; //store ship keys
this.$ExhibitionsSystems = []; //store system IDs of exhibitions
this.$ExhibitionsStartDate = []; //store start date of exhibitions
this.$ExhibitionsType = []; //store types of introduced exhibitions
this.$ExhibitionsTypes = [[&quot;All exhibitions&quot;,&quot;ship&quot;], //0. line in this array mean all exhibitions
	[&quot;Large exhibitions&quot;,&quot;many&quot;], //special type for $ExhibitionsRoles
	[&quot;Escort exhibitions&quot;,&quot;escort&quot;], //type-role pairs, max. about 10 fit into the menu
	[&quot;Hunter exhibitions&quot;,&quot;hunter&quot;],
	[&quot;Trader exhibitions&quot;,&quot;trader&quot;],
	[&quot;Pirate meetings&quot;,&quot;pirate&quot;]];
this.$ExhibitionsTimer = null; //wait for Gallery startUp finished
this.$ExhibitionsTimerPerm = null; //timer for permission
this.$ExhibitionsU = null; //store initial vectorUp
this.$ExhibitionsVisited = []; //store of the visited exhibitions
this.$ExhibitionsVisKey = []; //startdate+systemid of visited exhibitions (unique key)
this.$ExhibitionsVisitor = [&quot;a Novice Visitor.&quot;, &quot;an Unexpected Visitor.&quot;, &quot;a Poor Visitor.&quot;,
	&quot;a Below Average Visitor.&quot;, &quot;an Average Visitor.&quot;, &quot;an Above Average Visitor.&quot;,
	&quot;a Competent Visitor.&quot;, &quot;a Trustworthy Visitor!&quot;, &quot;an Expected Visitor!&quot;,
	&quot;the only Elite Visitor in this Ooniverse!&quot;]; //string of visitor level


//equipment events
this.activated = function () { //attached to Private Exhibition Control equipment
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e.$ExhibitionsSalonRot ) {
		e.$ExhibitionsSalonRot = false;
		player.consoleMessage(&quot;Stop Private Exhibition rotation&quot;);
	} else {
		e.$ExhibitionsSalonRot = true;
		player.consoleMessage(&quot;Start Private Exhibition rotation&quot;);
	}
}

this.mode = function () { //attached to Private Exhibition Control equipment
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e.$ExhibitionsSalonPartMax &gt; 1 ) { //step to the next part in splitted salon
		var p = e.$Exhibitions_SalonShips();
		if( e.$ExhibitionsSalonPart &lt; e.$ExhibitionsSalonPartMax )
			e.$ExhibitionsSalonPart++; //next part
		else e.$ExhibitionsSalonPart = 1; //first part
		
		var s = e.$ExhibitionsSalonShips;
		for( var i = 0; i &lt; s.length; i++ ) {
			if( s[i] &amp;&amp; s[i].isValid ) s[i].remove(true); //remove other parts of salon
		}
		delete e.$ExhibitionsSalonShips;
		e.$ExhibitionsSalonShips = [];
		var sp = Math.floor( p.length / e.$ExhibitionsSalonPartMax ); ///ships in one part
		var imin = 0;
		if( e.$ExhibitionsSalonPart &gt; 1 )
			imin = Math.floor( ( e.$ExhibitionsSalonPart - 1 ) * sp );
		var imax = p.length; //last part show last ship also
		if( e.$ExhibitionsSalonPart &lt; e.$ExhibitionsSalonPartMax )
			imax = Math.floor( e.$ExhibitionsSalonPart * sp ) - 1;
		if( e.$ExhibitionsLog )
			log(&quot;Exhibitions&quot;, &quot;Private Exhibition ships:&quot;+p.length+&quot; part:&quot;+e.$ExhibitionsSalonPart
				+&quot;/&quot;+e.$ExhibitionsSalonPartMax+&quot; sp:&quot;+sp+&quot; imin:&quot;+imin+&quot; imax:&quot;+imax);
		for( var i = imin; i &lt;= imax &amp;&amp; i &lt; p.length; i++ ) {
			e.$Exhibitions_Salon2( i );  //create ships in actual part
		}

		player.consoleMessage(&quot;Private Exhibit &quot;+e.$ExhibitionsSalonPart //+&quot;/&quot;+e.$ExhibitionsSalonPartMax
			+&quot;: Showing &quot;+(i-imin)+&quot; of &quot;+p.length+&quot; ships&quot;);
	} else player.consoleMessage(&quot;Private Exhibition show &quot;+e.$ExhibitionsSalonShips.length+&quot; ships&quot;);
}

//world script events
this.startUp = function() {
	this.$ExhibitionsJ = 0; //index in player ships during exhibition creation
	this.$ExhibitionsLastMenu = 0; //set marker to the lastly used exhibition menu line
	if( player.ship &amp;&amp; player.ship.docked )
		this.$ExhibitionsLastStation = player.ship.dockedStation;
	this.$ExhibitionsPerm = false; //permission to rotate ships in current exhibition
	this.$ExhibitionsPermReqSent = false; //permission request sent
	this.$ExhibitionsSalon = missionVariables.$ExhibitionsSalon; //recreate ships after load game if ordered before
	this.$ExhibitionsSalonDelta = 0; //count delta to determine FPS in Salon
	this.$ExhibitionsSalonDeltaC = 0; //counter to determine FPS in Salon
	this.$ExhibitionsSalonJ = 0; //index in player ships during Salon creation
	this.$ExhibitionsSalonRot = false; //rotating Salon
	this.$ExhibitionsSalonShips = []; //store ships to fine if destroyed by player
	this.$ExhibitionsSalonPartMax = 1;
	this.$ExhibitionsShips = []; //store ships to fine if destroyed by player
	this.$ExhibitionsSystems = []; //store system IDs of exhibitions

	var mv = missionVariables.$ExhibitionsSystems;//load advertised exhibitions from savegame
	if( !mv ) this.$ExhibitionsSystems = []; else this.$ExhibitionsSystems = mv.split(&quot;,&quot;);
	mv = missionVariables.$ExhibitionsStartDate;
	if( !mv ) this.$ExhibitionsStartDate = []; else this.$ExhibitionsStartDate = mv.split(&quot;,&quot;);
	mv = missionVariables.$ExhibitionsEndDate;
	if( !mv ) this.$ExhibitionsEndDate = []; else this.$ExhibitionsEndDate = mv.split(&quot;,&quot;);
	mv = missionVariables.$ExhibitionsType;
	if( !mv ) this.$ExhibitionsType = []; else this.$ExhibitionsType = mv.split(&quot;,&quot;);

	if( !(this.$ExhibitionsSystems.length &gt; 0) ) //make new list if empty (first run)
		this.$Exhibitions_Create(clock.days);

	mv = missionVariables.$ExhibitionsVisited;
	if( !mv ) this.$ExhibitionsVisited = []; 
	else if( (mv+&quot;&quot;).indexOf(&quot;,&quot;) ) this.$ExhibitionsVisited = (mv+&quot;&quot;).split(&quot;,&quot;); //need +&quot;&quot; for bugfix
	else this.$ExhibitionsVisited = [mv];
	
	mv = missionVariables.$ExhibitionsVisKey;
	if( !mv ) this.$ExhibitionsVisKey = []; 
	else if( (mv+&quot;&quot;).indexOf(&quot;,&quot;) ) this.$ExhibitionsVisKey = (mv+&quot;&quot;).split(&quot;,&quot;); //need +&quot;&quot; for bugfix
	else this.$ExhibitionsVisKey = [mv];

	if( this.$ExhibitionsLog ) { //log first list also
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsSystems (&quot;+this.$ExhibitionsSystems.length+&quot;): &quot;+this.$ExhibitionsSystems);
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsStartDate (&quot;+this.$ExhibitionsStartDate.length+&quot;): &quot;+this.$ExhibitionsStartDate);
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsEndDate (&quot;+this.$ExhibitionsEndDate.length+&quot;): &quot;+this.$ExhibitionsEndDate);
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsType (&quot;+this.$ExhibitionsType.length+&quot;): &quot;+this.$ExhibitionsType);
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsVisited (&quot;+this.$ExhibitionsVisited.length+&quot;): &quot;+this.$ExhibitionsVisited);
		log(&quot;Exhibitions&quot;, &quot;ExhibitionsVisKey (&quot;+this.$ExhibitionsVisKey.length+&quot;): &quot;+this.$ExhibitionsVisKey);
	}
	this.$ExhibitionsTimer = new Timer(this, this.$Exhibitions_Timed, 1);//need wait for gallery startUp finished

	if( player.ship &amp;&amp; player.ship.docked ) this.shipDockedWithStation( player.ship.dockedStation ); //set interface
	else if( system ) this.shipDockedWithStation( system.mainStation );//fallback	
}

this.dayChanged = function(newday) {
	if(!system || system.isInterstellarSpace) return;
	this.$Exhibitions_Create(newday); //make new ones
	var openex = false;
	if( this.$ExhibitionsJ &gt; 0 ) openex = true;
	if( this.$Exhibitions_CheckSystem() ) //create ships if there are an exhibition in this system today
		if( !openex ) player.consoleMessage(&quot;Exhibition open at witchpoint!&quot;,5);
	
	for( var x = 0; x &lt; this.$ExhibitionsEndDate.length; x++) { //remove expired items from all array
		if( this.$ExhibitionsEndDate[ x ] &lt; newday ) {
			this.$ExhibitionsSystems.splice(x,1);
			this.$ExhibitionsStartDate.splice(x,1);
			this.$ExhibitionsEndDate.splice(x,1);
			this.$ExhibitionsType.splice(x,1);
			x--;
		}
	}
}

this.playerBoughtEquipment = function(equipmentKey) {
	if(equipmentKey === (&quot;EQ_SALON_CONTROL&quot;)) {
		this.$ExhibitionsSalon = 1; //recreate ships after load game
		clock.addSeconds(86400*(1+Math.random()));
		this.$Exhibitions_Salon();
	}
}

this.playerEnteredNewGalaxy = function(galaxyNumber) { //make new exhibitions
	this.$ExhibitionsEndDate = []; //store the last valid date of exhibitions
	this.$ExhibitionsSystems = []; //store system IDs of exhibitions
	this.$ExhibitionsStartDate = []; //store start date of exhibitions
	this.$ExhibitionsType = []; //store types of introduced exhibitions
	this.$Exhibitions_Create(clock.days); //recreate exhibitions
}

this.playerWillSaveGame = function(message) {
	missionVariables.$ExhibitionsVisited = this.$ExhibitionsVisited;
	missionVariables.$ExhibitionsVisKey = this.$ExhibitionsVisKey;
	missionVariables.$ExhibitionsSalon = this.$ExhibitionsSalon;
	missionVariables.$ExhibitionsSystems = this.$ExhibitionsSystems;
	missionVariables.$ExhibitionsStartDate = this.$ExhibitionsStartDate;
	missionVariables.$ExhibitionsEndDate = this.$ExhibitionsEndDate;
	missionVariables.$ExhibitionsType = this.$ExhibitionsType;
}

this.shipDockedWithStation = function(station)
{
	if( this.$ExhibitionsLastStation != station ) {
		this.$ExhibitionsLastStation = station; //save lastly docked station to check if changed
		this.$Exhibitions_SalonRemove();//to can buy new salon placed before this new station
	}
	if( isValidFrameCallback( this.$ExhibitionsFCB ) )
		removeFrameCallback( this.$ExhibitionsFCB );
		
	this.$ExhibitionsPerm = false; //permission to rotate ships in current exhibition
	this.$ExhibitionsPermReqSent = false; //permission request sent
	
	var len = 0;
	if( this.$ExhibitionsVisited ) len = this.$ExhibitionsVisited.length;
	var exs = len;
	var exv = &quot;&quot;;
	if( len &gt; 0 ) exv += &quot; - you are &quot;+(this.$ExhibitionsVisitor[ this.$Exhibitions_VisitorLevel() ]);
	
	station.setInterface(&quot;Exhibitions&quot;,{
		title: &quot;Exhibitions (&quot;+exs+&quot; visited)&quot;+exv,
		category: &quot;Ship Systems&quot;,
		summary: &quot;Check incoming ship meetings to extend your Gallery with new ships and increase your Visitor Level.&quot;,
		callback: this.$Exhibitions_Interface.bind(this)
		});
}

this.shipKilledOther = function(whom, damageType) {
	if( this.$ExhibitionsShips &amp;&amp; this.$ExhibitionsShips.indexOf(whom) &gt; -1 ) {
		player.consoleMessage(&quot;GalCop fined you &quot;+formatCredits(10000, false, true)
			+&quot; for destroyng an Exhibition ship&quot;, 10);
		player.credits -= 100000;
		player.score--;
	}
	if( this.$ExhibitionsSalonShips &amp;&amp; this.$ExhibitionsSalonShips.indexOf(whom) &gt; -1 ) {
		player.consoleMessage(&quot;GalCop fined you &quot;+formatCredits(10000, false, true)
			+&quot; for destroying a Private Exhibition ship&quot;, 10);
		player.credits -= 10000;
		player.score--;
	}
}

this.shipTargetAcquired = function(target) { //flag
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e.$ExhibitionsJ &gt; 0 &amp;&amp; e.$ExhibitionsShips &amp;&amp; e.$ExhibitionsShips.indexOf(target) &gt; -1 ) {
		var si = e.$ExhibitionsSystems.indexOf(system.ID+&quot;&quot;);//need +&quot;&quot; for bugfix
		if( si &gt; -1 ) {
		    var key = e.$ExhibitionsStartDate[si]+&quot;&quot;+galaxyNumber+&quot;&quot;+system.ID; //unique for each exhibitions
		    if( e.$ExhibitionsVisKey.indexOf(key) == -1 ) { //new visit
			var rep = e.$Exhibitions_VisitorLevel();
			if( !e.$ExhibitionsVisited ) this.$ExhibitionsVisited = []; //for sure
			if( !e.$ExhibitionsVisKey ) this.$ExhibitionsVisKey = []; //for sure
			var len = e.$ExhibitionsVisited.length;
			e.$ExhibitionsVisited.push(clock.days+&quot;: &quot;+system.name+&quot; in &quot;+(galaxyNumber+1)+&quot; galaxy&quot;);
			e.$ExhibitionsVisKey.push(key);
			var msg = &quot;You visited your &quot;+(len+1)+&quot; exhibition.&quot;;
			player.consoleMessage(msg, 10);
			if( e.$ExhibitionsLog ) log(&quot;Exhibitions&quot;, msg+&quot; &quot;+key);
			var rep2 = e.$Exhibitions_VisitorLevel();
			if( rep2 &gt; rep ) {
				msg = &quot;Congratulations. You are &quot;+e.$ExhibitionsVisitor[ rep2 ];
				player.commsMessage(msg, 10);
				if( e.$ExhibitionsLog ) log(&quot;Exhibitions&quot;, msg);
			}
		    }
		}
		//request permission for rotate ships
		if( !this.$ExhibitionsPerm ) {
			if( !this.$ExhibitionsTimerPerm &amp;&amp; !this.$ExhibitionsPermReqSent ) {
				this.$ExhibitionsPermReqSent = true;
				player.consoleMessage(&quot;Permission requested to rotate ships in this exhibition&quot;, 10);
				var t = Math.ceil(Math.random() * 30); //max. 30 seconds
				this.$ExhibitionsTimerPerm = new Timer(this, this.$Exhibitions_TimedPerm, t);
			} else {
				player.consoleMessage(&quot;Please wait. You will get permission soon.&quot;, 5);
			}
		}
	}
}

this.shipWillEnterWitchspace = function() {
	delete this.$ExhibitionsShips;
	this.$ExhibitionsShips = [];
	if( isValidFrameCallback( this.$ExhibitionsFCB ) )
		removeFrameCallback( this.$ExhibitionsFCB );//stop rotate
	
	this.$ExhibitionsLastStation = null; //clear last station
	this.$ExhibitionsSalon = false; //do not recreate ships in salon after hyperjump
	this.$ExhibitionsSalonDeltaC = 0; //count delta to determine FPS in Salon
	delete this.$ExhibitionsSalonShips;
	this.$ExhibitionsSalonShips = [];
	this.$ExhibitionsSalonPartMax = 1;
	if( isValidFrameCallback( this.$ExhibitionsSalonFCB ) )
		removeFrameCallback( this.$ExhibitionsSalonFCB );//stop rotate
	player.ship.removeEquipment(&quot;EQ_SALON_CONTROL&quot;);
}

this.shipWillExitWitchspace = function() { //use this event due to shipExitedWitchspace is not working in v1.77
	this.$ExhibitionsPerm = false; //permission to rotate ships in current exhibition
	this.$ExhibitionsPermReqSent = false;
	if(system &amp;&amp; !system.isInterstellarSpace) this.$Exhibitions_CheckSystem(); //create ships after hyperjump
}

this.shipWillLaunchFromStation = function() {
	player.ship.hudHidden = false;
	this.$ExhibitionsPerm = false; //permission to rotate ships in current exhibition
	this.$ExhibitionsPermReqSent = false; //permission request sent
	if( this.$ExhibitionsJ &gt; 0 ) {
		if( !isValidFrameCallback( this.$ExhibitionsFCB ) )
			this.$ExhibitionsFCB = addFrameCallback( this.$Exhibitions_FCB ); //add ships and rotate
	} else this.$Exhibitions_CheckSystem(); //recreate ships after load game
}


//Exhibitions methods
this.$Exhibitions_CheckSystem = function() {
	var e = worldScripts[&quot;exhibitions&quot;];
	var x = e.$ExhibitionsSystems.indexOf( system.ID+&quot;&quot; );//need +&quot;&quot; for bugfix
	if( e.$ExhibitionsLog ) log(&quot;Exhibitions&quot;, &quot; CheckSystem:&quot;+system.ID+&quot; &quot;+x+&quot; &quot;+e.$ExhibitionsJ+&quot; &quot;
		+clock.days+&quot; &quot;+e.$ExhibitionsStartDate[ x ]+&quot;-&quot;+e.$ExhibitionsEndDate[ x ]+&quot; s&quot;+e.$ExhibitionsSystems[x]);
	if( x != -1 &amp;&amp; clock.days &gt;= e.$ExhibitionsStartDate[ x ]
		&amp;&amp; clock.days &lt;= e.$ExhibitionsEndDate[ x ] ) {
		if( e.$ExhibitionsJ == 0 ) e.$Exhibitions_Show( x ); //only if not shown before
		return( true );
	} else e.$Exhibitions_Remove(); //remove if last day elapsed
	return( false ); //no exhibition
}

this.$Exhibitions_Create = function( days ) {
	if(!system || system.isInterstellarSpace) return;
	
	var tlen = this.$ExhibitionsTypes.length; 
	var dlen = this.$ExhibitionsStartDate.length; 
	var maxstartdate = 0;
	if( dlen &gt; 0 ) maxstartdate = this.$ExhibitionsStartDate.sort()[dlen-1];
	if( maxstartdate == 0 ) {
		maxstartdate = 2084002;
		if( galaxyNumber == 0 ) {
			this.$ExhibitionsSystems.push(&quot;55&quot;); //long exhibition in Leesti for demonstration, need in &quot;&quot; for bugfix
			this.$ExhibitionsStartDate.push( 2084001 );
			this.$ExhibitionsEndDate.push( 2084060 );
			this.$ExhibitionsType.push( 1 ); //large exhibition
		}
	}
	var maxdate = days + 100; //new exhibitions introduced 100 days before
	if( !( dlen &gt; 0 &amp;&amp; maxstartdate &gt; maxdate ) ) {
		for( var i = maxstartdate; i &lt; maxdate; i++ ) {
			var r = system.scrambledPseudoRandomNumber(i);
			var t = Math.floor(r * (tlen)); //one open in every day, equal odds for each type
			var sy = Math.floor(r * 256) + &quot;&quot;; //need +&quot;&quot; for bugfix, 1/tlen odds for no opening
			if( t &gt; 0 &amp;&amp; this.$ExhibitionsSystems.indexOf(sy) == -1 ) {
				this.$ExhibitionsSystems.push( sy );
				this.$ExhibitionsStartDate.push( i );
				this.$ExhibitionsEndDate.push( i + 1 + Math.floor(r * 60) );//open max. 2 months
				this.$ExhibitionsType.push( t );
			}
		}
	}
}

this.$Exhibitions_FCB = function( delta ) {
	var e = worldScripts[&quot;exhibitions&quot;];
	var p = e.$ExhibitionsShipKeys;
	if( e.$ExhibitionsJ &lt; p.length ) {
		e.$Exhibitions_Show2( e.$ExhibitionsJ++ ); //spawn Salon ships in cycle
		if( e.$ExhibitionsJ &gt;= p.length ) {
			var x = e.$ExhibitionsSystems.indexOf( system.ID+&quot;&quot; );//need +&quot;&quot; for bugfix
			var type = e.$ExhibitionsTypes[ e.$ExhibitionsType[ x ] ][1]; //escort, hunter, trader, pirate
			player.consoleMessage(&quot;Exhibition of &quot;+type+&quot; ships is open at witchpoint&quot;, 10);
		}
	} else {
		if( e.$ExhibitionsPerm ) {
			var enc = worldScripts[&quot;gallery&quot;].$GalleryEncounters;
			var s = e.$ExhibitionsShips;
			var m = null;
			for( var i = 0; i &lt; s.length; i++ ) {
				m = s[i];
				if( enc.indexOf(m.dataKey) == -1 &amp;&amp; m.orientation  //rotate new ship
					|| player.ship &amp;&amp; player.ship.target == s[i] ) {//or current target
					m.orientation = m.orientation.rotateY( delta ).rotateZ( delta );
				}	
			}
		}
	}
}

this.$Exhibitions_Interface = function() {
	player.ship.hudHidden = true;//to shift down the menu
	this.$ExhibitionsLastMenu = 0;
	var g = worldScripts[&quot;gallery&quot;];
	if( g &amp;&amp; isValidFrameCallback( g.$GalleryFCB ) ) removeFrameCallback( g.$GalleryFCB ); //need for bugfix
	if( !isValidFrameCallback( this.$ExhibitionsMenuFCB ) )
		this.$ExhibitionsMenuFCB = addFrameCallback( this.$Exhibitions_MenuFCB ); //will call ex.menu
}

this.$Exhibitions_Menu = function() { //exhibitions menu
	var e = worldScripts[&quot;exhibitions&quot;];
	var g = worldScripts[&quot;gallery&quot;];
	var c = [];
	if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;Visitor:&quot;+e.$Exhibitions_VisitorLevel()
		+&quot; &quot;+e.$ExhibitionsVisitor[e.$Exhibitions_VisitorLevel()]);

	var len = 0;
	if( e.$ExhibitionsVisited ) len = e.$ExhibitionsVisited.length;
	var exs = &quot;You have not visited any exhibitions yet.&quot;;
	if( len &gt; 0 ) {
		exs = &quot;You visited &quot;+len+&quot; exhibition&quot;;
		if( len &gt; 1 ) exs += &quot;s&quot;;
		exs += &quot;. You are &quot;+(e.$ExhibitionsVisitor[ e.$Exhibitions_VisitorLevel() ]);
	}
	
	var msg = [];

	for( var i = 0; i &lt; e.$ExhibitionsTypes.length; i++ ) { //make menu for each type, start from 1 (not from 0!)
		c.push(e.$ExhibitionsTypes[i][0]);
		var ex = &quot;&quot;;
		var k = 0;
		for( var j = 0; j &lt; e.$ExhibitionsType.length &amp;&amp; k &lt; 23 - e.$ExhibitionsTypes.length ; j++ ) {
			if( i == 0 || i == e.$ExhibitionsType[j] ) {//list one type into type specific menus
				k++;
				ex += e.$ExhibitionsStartDate[j] + &quot; - &quot; + e.$ExhibitionsEndDate[j] + &quot;  &quot;
					+ System.infoForSystem(galaxyNumber, e.$ExhibitionsSystems[j]).name;
				if( i == 0 ) ex += &quot; - &quot; + e.$ExhibitionsTypes[e.$ExhibitionsType[j]][1] + &quot; ships\n&quot;;
				else ex += &quot;\n&quot;;
					
			}
		}
		msg.push(ex);
	}
	var pur = &quot;purchasable ships&quot;;
	if( e.$ExhibitionsAllShipsInPrivateExhibition ) pur = &quot;all ships&quot;;
	c.push(&quot;Private Exhibition of &quot;+pur);
	msg.push(&quot;You need &quot;+formatCredits(e.$ExhibitionsSalonCost, false, true)+&quot; to order your private exhibition.&quot;);
	c.push(&quot;Gallery of encounters&quot;); 
	msg.push(&quot;Go to Gallery&quot;);
	c.push(&quot;Exit&quot;); 
	msg.push(&quot;Bye&quot;);

	var startori = 0;
	var ti = &quot;Exhibitions&quot;;
	if( e.$ExhibitionsLastMenu &gt; 0 ) ti = c[e.$ExhibitionsLastMenu-10]+&quot; &quot;+clock.days+&quot;-&quot;;
	else { e.$ExhibitionsMO = null; startori = 1; }
	msg[-10] = [ exs+&quot;\n\nYou can choose exhibitions below. You will find them near witchpoints.&quot;
			+&quot; Target at least one ship within to increase your Visitor Level.&quot;
			+&quot; If you are lucky, you will find new ship types. You can add these to your Gallery by targeting them.&quot;
			+&quot;\n\nIn the Private Exhibition menu, you can order an exhibition of &quot;+pur+&quot;.&quot;
			+&quot;\nYou can go to the Gallery or exit when finished.&quot;];
	var ms = msg[e.$ExhibitionsLastMenu-10];
	if( e.$ExhibitionsLastMenu == 0 ) e.$ExhibitionsLastMenu = 10;
	var ch = {	&quot;_10&quot; : c[0],
		    	&quot;_11&quot; : c[1],
		    	&quot;_12&quot; : c[2],
		    	&quot;_13&quot; : c[3],
		    	&quot;_14&quot; : c[4],
		    	&quot;_15&quot; : c[5],
		    	&quot;_16&quot; : c[6],
		    	&quot;_17&quot; : c[7],
		    	&quot;_18&quot; : c[8],
		    	&quot;_19&quot; : c[9],
		    	&quot;_20&quot; : c[10],
		    	&quot;_21&quot; : c[11],
		    	&quot;_22&quot; : c[12],
		    	&quot;_23&quot; : c[13],
		    	&quot;_24&quot; : c[14],
		    	&quot;_25&quot; : c[15],
		    	&quot;_26&quot; : c[16],
		    	&quot;_27&quot; : c[17],
		    	&quot;_28&quot; : c[18],
		    	&quot;_29&quot; : c[19],
		    	&quot;_30&quot; : c[20],
		    	&quot;_31&quot; : c[21],
		    	&quot;_32&quot; : c[22],
		    	&quot;_33&quot; : c[23],
		    	&quot;_34&quot; : c[24],
		    	&quot;_35&quot; : c[25]
		};
	if( isValidFrameCallback( e.$ExhibitionsMenuFCB ) ) removeFrameCallback( e.$ExhibitionsMenuFCB );
	mission.runScreen({
		title: ti,
		message: ms,
		model: &quot;[&quot;+player.ship.dataKey+&quot;]&quot;,
		modelPersonality: 0,
		spinModel:false,
		background: &quot;gallery_bg.png&quot;,
		initialChoicesKey: &quot;_&quot;+e.$ExhibitionsLastMenu,
		choices: ch
	},function(choice) {
		var ch = 10;
		if( choice ) ch = choice.substr(1); //cut starting &quot;_&quot;
		e.$ExhibitionsLastMenu = 1 * ch;
		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;LastMenu: &quot;+e.$ExhibitionsLastMenu);
		if( e.$ExhibitionsLastMenu - 10 &lt; c.length - 3 ) {  //exhibition types, draw menu again
			if( !isValidFrameCallback( e.$ExhibitionsMenuFCB ) )
				e.$ExhibitionsMenuFCB = addFrameCallback( e.$Exhibitions_MenuFCB );
		} else switch( e.$ExhibitionsLastMenu - 10 ) {
			case (c.length - 3) : //Salon
				e.$Exhibitions_SalonMenu();
				break;
			case (c.length - 2) : //Go to Gallery
				g.$Gallery_Interface2( g.$GalleryShowAll ); //show from the lastly viewed ship
				break;
			case (c.length - 1) : //Exit
				break;
		}
	});
	var m = mission.displayModel;
	if( m ) {
		if( !e.$ExhibitionsMO ) e.$ExhibitionsMO = m.orientation; //save orientation in opening screen
		var w = oolite.gameSettings.gameWindow; //correction if not in widescreen
		var wide = Math.max( 0.01, ( w.width / w.height ) / g.$GalleryDefaultZoom );
		m.position = Vector3D(m.position.x, m.position.y, m.position.z * wide * 0.9); //zoom more closer
		m.orientation = e.$ExhibitionsMO.rotateZ( -Math.PI/2 ).rotateX( -Math.PI/2 )
			.rotateY( - Math.PI/4 * ( e.$ExhibitionsLastMenu + 5 - startori ) );
	}
}

this.$Exhibitions_MenuFCB = function( delta ) { //FrameCallBack for exhibitions menu
	var e = worldScripts[&quot;exhibitions&quot;];
	if( isValidFrameCallback( e.$ExhibitionsMenuFCB ) ) removeFrameCallback( e.$ExhibitionsMenuFCB );
	e.$Exhibitions_Menu();
}


this.$Exhibitions_Remove = function() { //remove ships
	this.$ExhibitionsJ = 0; //index in ships during creation
	var s = this.$ExhibitionsShips;
	for( var i = 0; i &lt; s.length; i++ ) {
		if( s[i] &amp;&amp; s[i].isValid ) s[i].remove(true);
	}
	this.$ExhibitionsPosition = [null, null, null, null];
	if( isValidFrameCallback( this.$ExhibitionsFCB ) )
		removeFrameCallback( this.$ExhibitionsFCB );
}


this.$Exhibitions_Salon = function() {
	if(!system || system.isInterstellarSpace) return;

	this.$ExhibitionsSalonJ = 0; //index in player ships during Salon creation
	var st = player.ship; //at load game or in-fly debug
	if( player.ship.docked ) st = player.ship.dockedStation;
	this.$ExhibitionsSalonO = st.orientation;
	this.$ExhibitionsSalonP = st.position.add(st.vectorForward.multiply( 10300 )); //Salon central position
	this.$ExhibitionsSalonR = st.vectorRight; //store initial vectorRight
	this.$ExhibitionsSalonU = st.vectorUp; //store initial vectorUp
	player.ship.awardEquipment(&quot;EQ_SALON_CONTROL&quot;);//need after load game
	if( !isValidFrameCallback( this.$ExhibitionsSalonFCB ) )
		this.$ExhibitionsSalonFCB = addFrameCallback( this.$Exhibitions_SalonFCB );
}

this.$Exhibitions_Salon2 = function( j ) {
	if(!system || system.isInterstellarSpace) return;

	var e = worldScripts[&quot;exhibitions&quot;];
	var g = worldScripts[&quot;gallery&quot;];
	var p = e.$Exhibitions_SalonShips();
	var space = e.$ExhibitionsSpace;//between ships
	var st = player.ship; //at load game or in-fly debug
	if( player.ship.docked ) st = player.ship.dockedStation;
	var sq = Math.ceil(Math.sqrt(p.length));
//	for( var j = 0; j &lt; p.length; j++ ) { //SalonFCB make this cycle to allow fast forwarding game clock parallelly
		var key = p[j];
		var row = Math.floor(j/sq);
		var pos = e.$ExhibitionsSalonP.add( e.$ExhibitionsSalonR.multiply( space * ( j - sq * row - sq / 2 + 0.5 ) ) )
				.add( e.$ExhibitionsSalonU.multiply( space * ( row - sq / 2 + 0.5 ) ) );//square align
		var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, pos, 5);
		if( ( !ships || !ships[0] ) &amp;&amp; key.indexOf(&quot;-player&quot;) &gt; -1 ) { //handle unsuccesful ship creation
			key = key.slice(0, key.indexOf(&quot;-player&quot;)); //remove -player
			ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, pos, 5);
			if( ships ) e.$Exhibitions_SalonAdd( ships[0], key, st, e, space, j );
		} else if( ships &amp;&amp; ships[0] ) e.$Exhibitions_SalonAdd( ships[0], key, st, e, space, j );
//	}
}

this.$Exhibitions_SalonAdd = function( ship, key, st, e, space, j ) {
	if( !ship ) { //handle unsuccesful ship creation
		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;Failed addShips [&quot;+key+&quot;] to Private Exhibition.&quot;);
	} else {
		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;[&quot;+key+&quot;] added to Private Exhibition.&quot;);
		if( ship.escorts &amp;&amp; ship.escorts.length &gt; 0 ) 
			for( var i = 0; i &lt; ship.escorts.length; i++ ) ship.escorts[i].remove(true);
		ship.beaconCode = null; //fix for escorted mothership in escort contracts
		if(ship.beaconLabel) ship.beaconLabel = &quot;&quot;;
		ship.bounty = 0;
		ship.displayName = &quot;[Private Exhibition] &quot; + ship.displayName;
		ship.setAI(&quot;nullAI.plist&quot;);
		ship.setScript(&quot;exhibitions-ship-script.js&quot;); //must deactivate the original script
		ship.target = null;
		ship.clearDefenseTargets();
//		ship.scanClass = &quot;CLASS_CARGO&quot;;
		if( st ) ship.orientation = e.$ExhibitionsSalonO.rotateX(3*Math.PI/2);
		var cr = ship.collisionRadius; //shift out large ships from the square plane
		if( cr &gt; space ) {
			var c2 = 1; //prevent collision of two neighbour baseship
			if( Math.floor( j / 2 ) == j / 2 ) c2 = -1;
			var mul =  c2 * (cr + 4 * space);
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, ship.displayName+&quot; too large, shifted out &quot;+j+&quot; &quot;+c2+&quot; &quot;+mul);
			ship.position = ship.position.add( st.vectorForward.multiply( mul ) );
		}
		e.$ExhibitionsSalonShips.push(ship);
	}
}

this.$Exhibitions_SalonFCB = function( delta ) {
	var e = worldScripts[&quot;exhibitions&quot;];
	var p = e.$Exhibitions_SalonShips();
	if( e.$ExhibitionsSalonJ &lt; p.length ) {
		if( e.$ExhibitionsSalonJ == 0 ) { //add active police as defenders of salon
			var role = &quot;police&quot;;
			if( 6 &lt;=  system.techLevel ) role = &quot;interceptor&quot;;
			var eg = system.addShips(role, 1+Math.floor(system.government/2), e.$ExhibitionsSalonP, 2000);
			if( eg ) for( var i = 0; i &lt; eg.length; i++ ) {
				if( eg[i] &amp;&amp; eg[i].isValid ) eg[i].displayName = &quot;[Private Exhibition Guard] &quot;+eg[i].displayName;
			}
		}
		e.$Exhibitions_Salon2( e.$ExhibitionsSalonJ++ ); //spawn Salon ships in cycle
	} else {
		if( e.$ExhibitionsSalonDeltaC &gt; 0 ) {
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;C:&quot;+e.$ExhibitionsSalonDeltaC+&quot; delta:&quot;+delta
				+&quot; deltasum:&quot;+e.$ExhibitionsSalonDelta);
			e.$ExhibitionsSalonDeltaC++;
			e.$ExhibitionsSalonDelta += delta;
		}
		if( e.$ExhibitionsSalonJ == p.length ) {
			e.$ExhibitionsSalonJ++; //send message once only
			player.consoleMessage(p.length+&quot; ships arrived. Take off to view Private Exhibition.&quot;,10);
			e.$ExhibitionsSalonRot = false; //rotating Salon
		}
		if( e.$ExhibitionsSalonJ &gt; p.length &amp;&amp; e.$ExhibitionsSalonDeltaC == 0
			&amp;&amp; player.ship &amp;&amp; !player.ship.docked ) { //wait for undock
			e.$ExhibitionsSalonDelta = delta; //start count delta to determine FPS for Salon split
			e.$ExhibitionsSalonDeltaC = 1;
		}
		if( e.$ExhibitionsSalonPartMax == 1 &amp;&amp; e.$ExhibitionsSalonDelta &gt; 2 ) { //after 2 seconds of measurement
			var fps = e.$ExhibitionsSalonDeltaC / e.$ExhibitionsSalonDelta; ///frames per second
			e.$ExhibitionsSalonDelta = delta;
//			e.$ExhibitionsSalonDeltaC = 1;//restart measurement
			e.$ExhibitionsSalonDeltaC = 0;//stop measurement
			var split = &quot;&quot;;
			if( fps &lt; e.$ExhibitionsMinFPS //too few FPS
				&amp;&amp; player.ship &amp;&amp; player.ship.position &amp;&amp; e.$ExhibitionsSalonP
				&amp;&amp; player.ship.position.distanceTo(e.$ExhibitionsSalonP) &lt; 25000 ) { //not so far
				e.$ExhibitionsSalonPartMax = Math.ceil( e.$ExhibitionsMinFPS / fps ); ///round up
				var sp = Math.floor( p.length / e.$ExhibitionsSalonPartMax ); ///ships in one part
				var sq = Math.ceil(Math.sqrt(p.length));
				if( sp &lt; sq ) //at least one row of ships in one part
					e.$ExhibitionsSalonPartMax = Math.ceil( p.length / sq ); ///
				e.$ExhibitionsSalonPart = 0; //will show the first part
				split = &quot;, split into &quot;+e.$ExhibitionsSalonPartMax+&quot; parts&quot;;
				var button = &quot;b&quot;;
				if( oolite.gameSettings.keyConfig ) //from Oolite v.1.77.1
					button = String.fromCharCode( oolite.gameSettings.keyConfig.key_mode_equipment );
				player.consoleMessage(&quot;Private Exhibition split into &quot;+e.$ExhibitionsSalonPartMax
					+&quot; parts. Prime Private Exhibition Control and press &#39;&quot;+button+&quot;&#39; to show next part&quot;, 10);
				e.mode(); //hide parts of salon
			}
			if(e.$ExhibitionsLog)
				log(&quot;Exhibitions&quot;, &quot;Private Exhibition &quot;+p.length+&quot; ships, &quot;+fps+&quot; FPS&quot;+split);
		}

		var s = e.$ExhibitionsSalonShips;
		var m = null;
		for( var i = 0; i &lt; s.length; i++ ) {
			m = s[i];
			if( m &amp;&amp; m.isValid &amp;&amp; m.orientation &amp;&amp; player.ship &amp;&amp; //rotate all ships in salon
				( e.$ExhibitionsSalonRot &amp;&amp; player.ship.target != s[i] //or current target only
				|| !e.$ExhibitionsSalonRot &amp;&amp; player.ship.target == s[i] ) )
				m.orientation = m.orientation.rotateZ( delta/1.5 );
		}
	}
}

this.$Exhibitions_SalonMenu = function() {
	var e = worldScripts[&quot;exhibitions&quot;];
	var g = worldScripts[&quot;gallery&quot;];
	var pur = &quot;purchasable ships&quot;;
	if( e.$ExhibitionsAllShipsInPrivateExhibition ) pur = &quot;all ships&quot;;

	var msg = &quot;You can order a Private Exhibition of &quot;+pur
		+&quot; before this station for &quot;+formatCredits(e.$ExhibitionsSalonCost, false, true)
		+&quot;, but you need to allow 1-2 days for this to be set up. If you have an existing Private Exhibition,&quot;
		+&quot; it will be renewed with this purchase.&quot;
		+&quot;\n\nYou will get a Private Exhibition Control primable equipment to start and stop rotation of ships&quot;
		+&quot; in your Private Exhibition, or you can start and stop rotation of a single ship by targeting it.&quot;
		+&quot; Do not destroy ships in your Private Exhibition. If you do, you will be fined.&quot;
		+&quot; Private Exhibition will be closed if you dock with another station or jump into another system.&quot;;
	mission.runScreen({
		title: &quot;Order a Private Exhibition&quot;,
		message: msg,
		model: &quot;[&quot;+player.ship.dataKey+&quot;]&quot;,
		modelPersonality: 0,
		spinModel:false,
		background: &quot;gallery_bg.png&quot;,
		choices: {&quot;_0&quot;:&quot;No thanks&quot;,&quot;_1&quot;:&quot;OK. I will pay and wait for ships!&quot;}
	},function(choice) {
		e.$ExhibitionsLastMenu = 0; //will display initial message
		switch(choice) {
			case &quot;_0&quot;:
				if( !isValidFrameCallback( e.$ExhibitionsMenuFCB ) )
					e.$ExhibitionsMenuFCB = addFrameCallback( e.$Exhibitions_MenuFCB );
				break;
			case &quot;_1&quot;:
				var saloncost = e.$ExhibitionsSalonCost; //must match with the cost in equipment.plist
				if( player.ship.equipmentStatus(&quot;EQ_SALON_CONTROL&quot;) == &quot;EQUIPMENT_OK&quot; ) {
					player.consoleMessage(&quot;Old Private Exhibition closed.&quot;,3);
					e.$Exhibitions_SalonRemove();
				}
				if( player.credits &gt;= saloncost ) {
					player.credits -= saloncost;
					player.ship.awardEquipment(&quot;EQ_SALON_CONTROL&quot;);
					e.playerBoughtEquipment(&quot;EQ_SALON_CONTROL&quot;); //do as if just bought one
					//no FCBE setup so will exit from ex.menu
				} else {
					//display not enough money message
					mission.runScreen({
						title: &quot;Order a Private Exhibition&quot;,
						message: &quot;You need &quot;+formatCredits(e.$ExhibitionsSalonCost, false, true)
							+&quot; to order your Private Exhibition.&quot;,
						model: &quot;[&quot;+player.ship.dataKey+&quot;]&quot;,
						modelPersonality: 0,
						spinModel:false,
						background: &quot;gallery_bg.png&quot;,
						choices: {&quot;_0&quot;:&quot;Ok&quot;}
						},function(choice) {
							//back to the exhibitions menu
							if( !isValidFrameCallback( e.$ExhibitionsMenuFCB ) )
							    e.$ExhibitionsMenuFCB = addFrameCallback(e.$Exhibitions_MenuFCB);
						});
				}
				break;
		}
	});
	var w = oolite.gameSettings.gameWindow;
	var wide = Math.max( 0.01, ( w.width / w.height ) / g.$GalleryDefaultZoom ); //correction if not in widescreen
	var m = mission.displayModel;
	if( m ) {
		m.position = Vector3D(m.position.x, m.position.y, m.position.z * wide * 0.9); //zoom more closer
		m.orientation = m.orientation.rotateZ( Math.PI/2 );
	}
}

this.$Exhibitions_SalonShips = function() {
	var g = worldScripts[&quot;gallery&quot;];
	if( worldScripts[&quot;exhibitions&quot;].$ExhibitionsAllShipsInPrivateExhibition ) 
		return( g.$GalleryAllObjects ); //cheat: all existing ships
	else return( g.$GalleryKeysForRole[ 1 ] );  //player ships
}

this.$Exhibitions_SalonRemove = function() {
	this.$ExhibitionsSalon = 0; //do not recreate ships after docked into a new station
	this.$ExhibitionsSalonDeltaC = 0; //count delta to determine FPS in Salon
	this.$ExhibitionsSalonJ = 0; //index in player ships during Salon creation
	this.$ExhibitionsSalonO = null; //store Salon initial orientation
	this.$ExhibitionsSalonP = null; //store Salon central position
	this.$ExhibitionsSalonR = null; //store Salon initial vectorRight
	this.$ExhibitionsSalonRot = false; //rotating Salon
	this.$ExhibitionsSalonU = null; //store Salon initial vectorUp
	var s = this.$ExhibitionsSalonShips;
	for( var i = 0; i &lt; s.length; i++ ) {
		if( s[i] &amp;&amp; s[i].isValid ) s[i].remove(true); //remove previous salon
	}
	delete this.$ExhibitionsSalonShips;
	this.$ExhibitionsSalonShips = [];
	this.$ExhibitionsSalonPartMax = 1;
	if( isValidFrameCallback( this.$ExhibitionsSalonFCB ) )
		removeFrameCallback( this.$ExhibitionsSalonFCB );
	player.ship.removeEquipment(&quot;EQ_SALON_CONTROL&quot;); //to can buy again
}

this.$Exhibitions_Show = function( x ) { //create ships
	if(!system || system.isInterstellarSpace) return;

	var e = worldScripts[&quot;exhibitions&quot;];
	var type = e.$ExhibitionsTypes[ e.$ExhibitionsType[ x ] ][1]; //escort, hunter, trader, pirate
	var enc = worldScripts[&quot;gallery&quot;].$GalleryEncounters;
	e.$ExhibitionsShips = [];
	e.$ExhibitionsShipKeys = [];

	var sdk = [];
	if (0 &lt; oolite.compareVersion(&quot;1.79&quot;)) { //slow and limited method, use before Oolite v1.79
		if( type == &quot;many&quot; ) { //from $ExhibitionsRoles
			for( var i = 0; i &lt; e.$ExhibitionsRoles.length; i++ ) {
				var ships = system.addShips( e.$ExhibitionsRoles[i], //sum of 64 ship created
					Math.ceil( 64 / e.$ExhibitionsRoles.length ), [0,0,0], 1000000 );
				if( ships ) for( var i = 0; i &lt; ships.length; i++ )
					if( ships[i] &amp;&amp; ships[i].isValid &amp;&amp; sdk.indexOf(ships[i].dataKey) == -1 )
						sdk.push( ships[i].dataKey );
			}
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, type+&quot;: &quot;+sdk);
			sdk = sdk.concat(enc); //player and encountered ships at the end, show if anothers is not enough
		} else {
			var ships = system.addShips(type, 64, [0,0,0], 1000000);
			if( ships ) for( var i = 0; i &lt; ships.length; i++ )
				if( ships[i] &amp;&amp; ships[i].isValid &amp;&amp; sdk.indexOf(ships[i].dataKey) == -1 )
					sdk.push( ships[i].dataKey );
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, type+&quot;: &quot;+sdk);
		}
		if( !sdk || sdk.length &lt; 1 ) { //fallback to player ships
			var ships = system.addShips(&quot;player&quot;, 64, [0,0,0], 1000000);
			if( ships ) for( var i = 0; i &lt; ships.length; i++ )
				if( ships[i] &amp;&amp; ships[i].isValid &amp;&amp; sdk.indexOf(ships[i].dataKey) == -1 )
					sdk.push( ships[i].dataKey );
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;player: &quot;+sdk);
		}
	} else { // Oolite v1.79 or later
		if( type == &quot;many&quot; ) { //from $ExhibitionsRoles
			for( var i = 0; i &lt; e.$ExhibitionsRoles.length; i++ ) {
				sdk = sdk.concat(Ship.keysForRole( e.$ExhibitionsRoles[i] ));
			}
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, type+&quot;: &quot;+sdk);
			sdk = sdk.concat(enc); //player and encountered ships at the end, show if anothers is not enough
		} else {
			sdk = Ship.keysForRole( type );
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, type+&quot;: &quot;+sdk);
		}
		if( !sdk || sdk.length &lt; 1 ) {
			sdk = Ship.keysForRole( &quot;player&quot; );//fallback to player ships
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;player: &quot;+sdk);
		}
	}
	if( (!sdk || sdk.length &lt; 1 ) &amp;&amp; player.ship ) sdk = player.ship.dataKey;//last resort
	if( !sdk || sdk.length &lt; 1 ) { //should not happed
		log(&quot;Exhibitions&quot;, &quot;$Exhibitions_Show() failed. Can not find any dataKey to show&quot;);
		return; //give up and exit to prevent errors
	}

	var maxnewship = 2; //a few new ship added into every exhibition only else reserves run out too early
	var shipno = 12 + 52 * system.scrambledPseudoRandomNumber(e.$ExhibitionsType[ x ]); //max. 64 = 8*8
	if( type == &quot;many&quot; ) shipno = Math.max(64, system.pseudoRandomNumber * e.$ExhibitionsMaxShipsInLargeExhibitions);
	for( var i = 0; e.$ExhibitionsShipKeys.length &lt; shipno &amp;&amp; i &lt; sdk.length; i++ ) {
		var key = sdk[i];
		if( ( key &amp;&amp; enc.indexOf(key) != -1 || maxnewship-- &gt; 0 ) 
			&amp;&amp; key.indexOf(&quot;station&quot;) == -1 &amp;&amp; key.indexOf(&quot;rock-hermit&quot;) == -1 ) {
			//still not sure if this is a ship, further checking
			if( Ship.shipDataForKey ) { //new fast method in 1.79 since 2014.05.19
				var s = Ship.shipDataForKey(key);
				if(this.$ExhibitionsLog) log(&quot;Exhibitions&quot;, j+&quot;. &quot;+key+&quot; shipDataForKey &quot;+s);
				if( s &amp;&amp; s.max_flight_speed &amp;&amp; s.max_flight_speed &gt; 0 )
					e.$ExhibitionsShipKeys.push(key); //ok, add it
			} else { //old way for Oolite 1.77
				if( key.indexOf(&quot;spacebar&quot;) == -1 ) //must check every problematic key
					e.$ExhibitionsShipKeys.push(key); //maybe ok, add it
			}
		}
	}

	if( sdk &amp;&amp; sdk.length &lt; shipno ) //duplicate until contain enough ships
		while( e.$ExhibitionsShipKeys.length &lt; shipno &amp;&amp; e.$ExhibitionsShipKeys.length &lt; 1000 )
			e.$ExhibitionsShipKeys = e.$ExhibitionsShipKeys.concat(e.$ExhibitionsShipKeys);
	e.$ExhibitionsShipKeys.splice( shipno ); //shrink before short, can appear ships from the end of the alphabet also
	e.$ExhibitionsShipKeys.sort();
	if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;ExhibitionsShipKeys: &quot;+e.$ExhibitionsShipKeys);


	this.$ExhibitionsJ = 0; //index in player ships during exhibition creation
	if( !isValidFrameCallback( this.$ExhibitionsFCB ) )
		this.$ExhibitionsFCB = addFrameCallback( this.$Exhibitions_FCB ); //add ships and rotate

	//add active police/pirate as defenders of exhibition
	var role = &quot;police&quot;;
	if( 6 &lt;=  system.techLevel ) role = &quot;interceptor&quot;;
	if(type == &quot;pirate&quot;) role = &quot;pirate&quot;;
	var base = 1;
	if(type == &quot;many&quot;) base += 1;

	var pos = Vector3D(0,0,10000);
	var ori = Quaternion(0, 0, 0, 0);
	var vr = Vector3D(1, 0, 0);
	var vu = Vector3D(0, 1, 0);
	if( player.ship &amp;&amp; player.ship.position ) {
		if( player.ship.position.distanceTo([0,0,0]) &lt; 25600 ) 
			pos = player.ship.position.add(player.ship.vectorForward.multiply( 10000 ));
		ori = player.ship.orientation;
		vr = player.ship.vectorRight; //store initial vectorRight
		vu = player.ship.vectorUp; //store initial vectorUp
	}
	this.$ExhibitionsPosition = [pos, ori, vr, vu]; 
	
	var eg = system.addShips(role, base+Math.floor(system.government/4), pos, 2000);
	if( eg ) for( var i = 0; i &lt; eg.length; i++ ) {
		if( eg[i] &amp;&amp; eg[i].isValid ) eg[i].displayName = &quot;[Exhibition Guard] &quot;+eg[i].displayName;
	}
}

this.$Exhibitions_Show2 = function( j ) {
	if(!system || system.isInterstellarSpace) return;

	var e = worldScripts[&quot;exhibitions&quot;];
	var p = e.$ExhibitionsShipKeys;
	var space = e.$ExhibitionsSpace;//between ships
	var sq = Math.ceil(Math.sqrt(p.length));
//	for( var j = 0; j &lt; p.length; j++ ) { //FCB make this cycle
		var key = p[j];
		var row = Math.floor(j/sq);
		var pos = null;
		
		if( e.$ExhibitionsPosition &amp;&amp; e.$ExhibitionsPosition[0] ) pos = e.$ExhibitionsPosition[0]
			.add( e.$ExhibitionsPosition[2].multiply( space * ( j - sq * row - sq / 2 + 0.5 ) ) )
			.add( e.$ExhibitionsPosition[3].multiply( space * ( row - sq / 2 + 0.5 ) ) );//square align
		else pos = [ space * ( j - sq * row - sq / 2 + 0.5 ), space * ( row - sq / 2 + 0.5 ), 10000 ];//fallback
		
		var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, pos, 5);
		if( ( !ships || !ships[0] ) &amp;&amp; key.indexOf(&quot;-player&quot;) &gt; -1 ) { //handle unsuccesful ship creation
			key = key.slice(0, key.indexOf(&quot;-player&quot;)); //remove -player
			ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, pos, 5);
			if( ships ) e.$Exhibitions_ShowAdd( ships[0], key, e, space, j );
		} else if( ships &amp;&amp; ships[0] ) e.$Exhibitions_ShowAdd( ships[0], key, e, space, j );
//	}
}

this.$Exhibitions_ShowAdd = function( ship, key, e, space, j ) {
	if( !ship ) { //handle unsuccesful ship creation
		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;Failed addShips [&quot;+key+&quot;] to the Exhibition.&quot;);
	} else {
		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;[&quot;+key+&quot;] added to the Exhibition.&quot;);
		if( ship.escorts &amp;&amp; ship.escorts.length &gt; 0 ) 
			for( var i = 0; i &lt; ship.escorts.length; i++ ) ship.escorts[i].remove(true);
		ship.beaconCode = null; //fix for escorted mothership in escort contracts
		if(ship.beaconLabel) ship.beaconLabel = &quot;&quot;;
		ship.bounty = 0;
		ship.displayName = &quot;[Exhibition] &quot; + ship.displayName;
		ship.setAI(&quot;nullAI.plist&quot;);
		ship.setScript(&quot;exhibitions-ship-script.js&quot;); //must deactivate the original script
		ship.target = null;
		ship.clearDefenseTargets();
//		ship.scanClass = &quot;CLASS_CARGO&quot;;
		var cr = ship.collisionRadius; //shift out large ships from the square plane
		if( cr &gt; space ) {
			var c2 = 1; //prevent collision of two neighbour baseship
			if( Math.floor( j / 2 ) == j / 2 ) c2 = -1;
			var mul =  c2 * (cr + 4 * space);
			if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, ship.displayName+&quot; too large, shifted out &quot;+j+&quot; &quot;+c2+&quot; &quot;+mul);
			ship.position = ship.position.add( [0, 0, mul ] );
		}
//		if(e.$ExhibitionsLog) log(&quot;Exhibitions&quot;, &quot;playerori:&quot;+player.ship.orientation);
		if( e.$ExhibitionsPosition &amp;&amp; e.$ExhibitionsPosition[1] ) 
			ship.orientation = e.$ExhibitionsPosition[1].rotateX( Math.PI/2 );
		else if( player.ship &amp;&amp; player.ship.orientation ) //fallback
			ship.orientation = player.ship.orientation.rotate( Vector3D(1,0,0), Math.PI/2 );

		if( !e.$ExhibitionsShips ) e.$ExhibitionsShips = [ship];
		else e.$ExhibitionsShips.push(ship);
	}
}

this.$Exhibitions_Timed = function() { //need wait for Gallery startUp finished to get filled ship dataKey arrays
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e.$ExhibitionsTimer ) {
		e.$ExhibitionsTimer.stop();
		delete e.$ExhibitionsTimer;
	}
	if(e.$ExhibitionsSalon) e.$Exhibitions_Salon(); //recreate after load game if ordered before
	e.$Exhibitions_CheckSystem(); //recreate exhibition after load game if any
}

this.$Exhibitions_TimedPerm = function() { //
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e.$ExhibitionsTimerPerm ) {
		e.$ExhibitionsTimerPerm.stop();
		delete e.$ExhibitionsTimerPerm;
	}
	if( e.$ExhibitionsPerm ) { //end of permitted time for rotation
		e.$ExhibitionsPerm = false;
		e.$ExhibitionsPermReqSent = false;
		player.consoleMessage(&quot;Permission revoked. You can request again by targeting another ship in the exhibition&quot;, 10);
	} else if( e.$ExhibitionsPermReqSent ) { //end of wait for permission
		e.$ExhibitionsPerm = true;
		e.$ExhibitionsPermReqSent = false;
		player.consoleMessage(&quot;Permission granted. You can rotate ships in the exhibition for 5 minutes&quot;, 10);
		e.$ExhibitionsTimerPerm = new Timer(e, e.$Exhibitions_TimedPerm, 300);
	}
}

this.$Exhibitions_VisitorLevel = function() {
	var e = worldScripts[&quot;exhibitions&quot;];
	var len = 0;
	if( e.$ExhibitionsVisited ) len = e.$ExhibitionsVisited.length;
	var rep = 0;
	if( len &lt; 2 ) rep = 0;
	else if( len &lt; 4 ) rep = 1;
	else if( len &lt; 8 ) rep = 2;
	else if( len &lt; 16 ) rep = 3;
	else if( len &lt; 32 ) rep = 4;
	else if( len &lt; 64 ) rep = 5;
	else if( len &lt; 100 ) rep = 6;
	else if( len &lt; 300 ) rep = 7;
	else if( len &lt; 1000 ) rep = 8;
	else rep = 9; //Elite Visitor
	return( rep );
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/gallery.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;gallery&quot;;
this.author      = &quot;Norby&quot;;
this.copyright   = &quot;2013 Norbert Nagy&quot;;
this.licence     = &quot;CC BY-NC-SA 3.0&quot;;
this.description = &quot;Show installed ships and objects in an interface screen.&quot;;

//customizable properties
this.$GalleryAll = true; //Gallery of all objects (cheat)
this.$GalleryDefaultZoom = 1.5; //default size of ships
this.$GalleryMaxIt = 5; //max. iteration in Oolite v1.77, reduce if cause &quot;Universe is full&quot; or crash to desktop
this.$GalleryLog = false; //verbose log
this.$GalleryRoles = [&quot;all&quot;,&quot;player&quot;, //main roles, you can add more but must leave these first two untouched
	&quot;escort&quot;,&quot;hunter&quot;,&quot;interceptor&quot;,&quot;miner&quot;,&quot;pirate&quot;,&quot;police&quot;,&quot;trader&quot;,&quot;scavenger&quot;,&quot;shuttle&quot;,&quot;thargoid&quot;,
	&quot;asteroid&quot;,&quot;boulder&quot;,&quot;buoy&quot;,&quot;cargopod&quot;,&quot;missile&quot;,&quot;station&quot;];
this.$GallerySpeed = 2; //move and zoom speed

//internal properties, should not touch
this.$GalleryAllObjects = []; //store all ship and object keys
this.$GalleryAllNames = []; //all ship names for search
this.$GalleryEncounters = []; //store encountered ship keys for savegame also
this.$GalleryEncNames = []; //encountered ship names for search
this.$GalleryFCB = null; //FrameCallBack for rotating ship model
this.$GalleryFCB2 = null; //FrameCallBack for menu
this.$GalleryFCB3 = null; //FrameCallBack to fill up other role
this.$GalleryKey = null; //store last dataKey
this.$GalleryKeyi = []; //selected key indexes in the GalleryKeysForRole array
this.$GalleryKeysi = 0; //actual index in all Keys
this.$GalleryKeysForRole = []; //dataKeys for the selected role
this.$GalleryLastMenu = 0; //set marker to the lastly used menu line
this.$GalleryLastEnc = []; //lastly encountered dataKeys
this.$GalleryMore = true; //show more menu
this.$GalleryMove = 0; //move showed ship
this.$GalleryOri = null; //store last orientation
this.$GalleryOthers = [];
this.$GalleryPrevZ = 0; //store previous z position
this.$GalleryRole = 0; //selected role
this.$GalleryRotate = 0; //rotating showed ship around Y axis
this.$GalleryShift = 0; //store move multiplier calculated from ship size
this.$GalleryShiftX = 0; //store move position
this.$GalleryShiftY = 0; //store move position
this.$GalleryShiftZ = 0; //store move position
this.$GalleryShowAll = false; //show all ships and objects selected in search
this.$GalleryTimer = null; //help avoid timelimit
this.$GalleryTRole = 0; //actual role in timer
this.$GalleryTRI = 0; //Timer Role Iteration
this.$GalleryTrash = []; //store created ships to remove later
this.$GalleryZoom = 0; //zoom showed ship

//following arrays comes from Technical Reference Library OXP by spara
this.$GalleryClassifiedScanClasses = [&quot;CLASS_MILITARY&quot;, &quot;CLASS_POLICE&quot;, &quot;CLASS_THARGOID&quot;];
this.$GalleryClassifiedRoles = [&quot;constrictor&quot;, &quot;kephalan&quot;, &quot;odonatean&quot;, &quot;scorpax&quot;, &quot;bigTrader&quot;, &quot;monkpatrol&quot;, &quot;griff_blackmonk_defenceship&quot;, &quot;monkhit1&quot;, &quot;monkhit2&quot;, &quot;monkhold1&quot;, &quot;monkhold2&quot;, &quot;ev_green_gecko&quot;, &quot;sin-pirate&quot;];//classify constrictor, aliens oxp, bigTrader ships, black monks, green gecko oxp and capisastra oxp.


//world script events
this.startUp = function() {
	this.$GalleryAllObjects = []; //store all ship and object keys
	this.$GalleryAllNames = []; //all ship names for search
	var ge = missionVariables.$GalleryEncounters; //load encountered ships from savegame
	if( !ge ) this.$GalleryEncounters = []; else this.$GalleryEncounters = ge.split(&quot;,&quot;);//need at least 2 item exists
	if(this.$GalleryLog)
		log(&quot;Gallery&quot;, &quot;Loaded Encounters (&quot;+this.$GalleryEncounters.length+&quot;): &quot;+this.$GalleryEncounters);
	this.$GalleryEncNames = []; //encountered ship names for search
	this.$GalleryFCB = null; //FrameCallBack for rotating ship model
	this.$GalleryLastMenu = 0; //set marker to the lastly used menu line
	
	var ge = missionVariables.$GalleryLastEnc; //load order of encounters from savegame
	if( !ge ) this.$GalleryLastEnc = []; 
	else if( (ge+&quot;&quot;).indexOf(&quot;,&quot;) ) this.$GalleryLastEnc = (ge+&quot;&quot;).split(&quot;,&quot;); //need +&quot;&quot; for bugfix of a single item
	else this.$GalleryLastEnc = [ge];
	if(this.$GalleryLog)
		log(&quot;Gallery&quot;, &quot;Loaded LastEnc (&quot;+this.$GalleryLastEnc.length+&quot;): &quot;+this.$GalleryLastEnc);
		
	this.$GalleryMore = true; //show more menu
	this.$GalleryMove = 0; //move showed ship
	this.$GalleryRole = 0; //starting role in Roles array
	this.$GalleryRotate = 0; //rotating showed ship around Y axis
	this.$GallerySet = false; //settings menu
	this.$GalleryShiftX = 0; //store move position
	this.$GalleryShiftY = 0; //store move position
	this.$GalleryShiftZ = 0; //store move position
	this.$GalleryShowAll = false; //show all ships and objects selected in search
	this.$GalleryTrash = []; //store created ships to remove later
	this.$GalleryZoom = 0; //zoom showed ship
	
	if (0 &lt; oolite.compareVersion(&quot;1.79&quot;)) { //slow and limited method, use before Oolite v1.79
//can cause long wait in startUp, &quot;Universe is full&quot; or crash to desktop before the spinning cobra if not enough memory
		log(&quot;Gallery&quot;, &quot;Fallback to a slow and inaccurate method without Oolite v1.79&quot;);
		this.$GalleryKeysForRole[ 0 ] = [];
		this.$GalleryKeysForRole[ 0 ] = this.$GalleryKeysForRole[ 0 ].concat(this.$GalleryEncounters);
		var all = false;
		if( this.$GalleryAll || worldScripts[&quot;exhibitions&quot;] 
			&amp;&amp; worldScripts[&quot;exhibitions&quot;].$ExhibitionsAllShipsInPrivateExhibition ) all = true;
		for( var i = 1; i &lt; this.$GalleryRoles.length &amp;&amp; all || i == 1; i++ ) { //main roles
			var maxk = this.$GalleryMaxIt; //how many iteration max., reduce if cause &quot;Universe is full&quot; or crash to desktop
			var prevlen = 0;
			var num = 16; //how many ships created at one time
			if( i == 1 ) num = 64; //more if player role
			for( var k = 1; k &lt;= maxk; k++ ) {
				if( this.$GalleryKeysForRole[ i ] ) prevlen = this.$GalleryKeysForRole[ i ].length;
				var ships = system.addShips(this.$GalleryRoles[i], num, [0,0,0], 1000000);
//				this.$GalleryTrash = this.$GalleryTrash.concat(ships);
				if(ships) for( var j = 0; j &lt; ships.length; j++ ) { //created ships
					if( ships[j] ) {
						var key = ships[j].dataKey;
						if( !this.$GalleryKeysForRole[ i ] ) {
							this.$GalleryKeysForRole[ i ] = [key];
						} else if( this.$GalleryKeysForRole[ i ].indexOf(key) == -1 )
							this.$GalleryKeysForRole[ i ].push(key);//add new key
						ships[j].remove(true);//can not remove everything and reach Universe limit
						//all ship remove must be called with true parameter to avoid call shipDied
						//event which will drop the following error in the case of constrictor!
						//TypeError: killer is null in oolite-constrictor.js, line 72
//					if(this.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. main role: &quot; + this.$GalleryRoles[i]
//							+&quot; &quot;+k+&quot;. try, &quot;+(j+1)+&quot;. key: &quot;+key
//							+&quot; GalleryKeysForRole[&quot;+i+&quot;]:&quot;+this.$GalleryKeysForRole[ i ]);
					}
				}
				if(this.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. main role: &quot; + this.$GalleryRoles[i]
					+&quot; &quot;+k+&quot;. try: &quot;+this.$GalleryKeysForRole[ i ] );
				if( //k == 1 &amp;&amp; this.$GalleryKeysForRole[ i ].length &lt; num / 3 ||//too few object in this role
					prevlen == this.$GalleryKeysForRole[ i ].length) maxk = 0;//exit from cycle
			}
			if(this.$GalleryKeysForRole[ i ]) {
				this.$GalleryKeysForRole[ i ].sort();
				if(this.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. role after &quot;+(k-1)+&quot; try: &quot; + this.$GalleryRoles[i]
					+ &quot; (&quot;+this.$GalleryKeysForRole[ i ].length+&quot;): &quot; + this.$GalleryKeysForRole[ i ] );
				this.$GalleryKeysForRole[ 0 ] = this.$GalleryKeysForRole[ 0 ].concat(this.$GalleryKeysForRole[ i ]);
			}
		}
		this.$GalleryKeysForRole[ 0 ].sort();
		for( var i = 1; i &lt; this.$GalleryKeysForRole[ 0 ].length; i++ ) { //remove duplicated keys
			if(this.$GalleryKeysForRole[0][i] == this.$GalleryKeysForRole[0][i-1]) {
				this.$GalleryKeysForRole[0].splice(i,1); //remove this item
				i--;
			}
		}
		if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot;All dataKeys (&quot;+this.$GalleryKeysForRole[ 0 ].length
			+&quot;): &quot; + this.$GalleryKeysForRole[ 0 ] );

//		this.$GalleryTRole = 1;
//		this.$GalleryTRI = 1;
//		this.$GalleryTimer = new Timer(this, this.$Gallery_Timed, 1); //cycle in timer
		if( !this.$GalleryEncounters || this.$GalleryEncounters.length == 0 )
			this.$GalleryEncounters = this.$GalleryKeysForRole[ 1 ]; //store playable ships
		else {
			for( var i = 1; i &lt; this.$GalleryKeysForRole[ 1 ].length; i++ ) {
				var key = this.$GalleryKeysForRole[ 1 ][i];
				if( this.$GalleryEncounters.indexOf( key ) == -1 )
					this.$GalleryEncounters.push( key );
			}
		}
	
	} else { //Oolite v1.79 or later
		var sdk = Ship.keysForRole( &quot;player&quot; );  //playable and encountered ships only
		if(this.$GalleryEncounters &amp;&amp; this.$GalleryEncounters.length &gt; 0) {
			for( var i = 1; i &lt; this.$GalleryEncounters.length; i++ ) {
				var key = this.$GalleryEncounters[i];
				if( sdk.indexOf( key ) == -1 ) sdk.push( key );
			}
		}
		this.$GalleryEncounters = sdk;
		if( this.$GalleryAll ) var sdk = Ship.keys(); //all dataKeys

	    this.$GalleryKeysForRole[ 0 ] = sdk.sort(); //all or playable+encountered dataKeys
	    this.$GalleryKeyi[ 0 ] = 0;
	    if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot;All dataKeys (&quot;+this.$GalleryKeysForRole[ 0 ].length+&quot;): &quot;
		    + this.$GalleryKeysForRole[ 0 ] );
	
	    for( var i = 1; i &lt; this.$GalleryRoles.length; i++ ) { //main roles
		var roleKeys = Ship.keysForRole( this.$GalleryRoles[i] ).sort();
		
		if( !roleKeys || !roleKeys.length || roleKeys.length &lt; 1 )
			this.$GalleryRoles.splice(i,1); //remove empty role
		else {

/* - validate check removed (too slow), check when try to show the item only
		    for( var j = 0; j &lt; roleKeys.length; j++ ) {
			var key = roleKeys[j];
			var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
			if( ( !ships || !ships[0] ) &amp;&amp; key.indexOf(&quot;-player&quot;) &gt; -1 ) { //handle unsuccesful ship creation
				key = key.slice(0, key.indexOf(&quot;-player&quot;)); //remove -player
				ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
				if( !ships || !ships[0] ) { //handle unsuccesful ship creation
					roleKeys.splice(j,1); //remove item
					j--;
					if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], removed.&quot;);
				} else ships[0].remove(true); //ok without -player
			} else {
				if( ships &amp;&amp; ships[0] ) {
					var ship = ships[0];
					if( ship.roles ) for( var k = 0; k &lt; ship.roles.length; k++ ) {
						if( ship.roles[k] &amp;&amp; ship.roles[k].indexOf(&quot;subent&quot;) &gt; -1 ) {
							//skip subentities in Griff_Shipset_Replace_v1.34.oxp
							roleKeys.splice(j,1); //remove item
							j--;
							k = ship.roles.length;//exit from cycle
							var msg = &quot;Subentity [&quot;+key+&quot;] removed.&quot;;
							if(this.$GalleryLog) log(&quot;Gallery&quot;, msg);
							if(ship != player.ship) ship.remove(true);
						}
					}
					ship.remove(true); //ok
				} else if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], removed.&quot;);
			}
		    }
*/		
		    if( this.$GalleryAll ) this.$GalleryKeysForRole[ i ] = roleKeys;
		    else {
			this.$GalleryKeysForRole[ i ] = [];
			for( var k = 1; k &lt; roleKeys.length; k++ ) {
				var key = roleKeys[k];
				if( this.$GalleryKeysForRole[ 0 ].indexOf( key ) != -1 )
					this.$GalleryKeysForRole[ i ].push( key ); //get playable or encountered keys only
			}
		    }
		    this.$GalleryKeyi[ i ] = 0;
		    if(this.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. role: &quot; + this.$GalleryRoles[i] 
			    + &quot; (&quot;+this.$GalleryKeysForRole[ i ].length+&quot;): &quot; + this.$GalleryKeysForRole[ i ] );
		}
	    }
	
	    if(this.$GalleryLog) var roles = Ship.roles(); //all roles
	    if(this.$GalleryLog) for( var j = 0; j &lt; roles.length; j++ ) {
//		if( roles[j] &amp;&amp; roles[j][0] != &quot;[&quot; ) { //many roles start with &quot;[&quot;
			var roleKeys = Ship.keysForRole( roles[j] );
			if(this.$GalleryLog) log(&quot;Gallery&quot;, (j+1)+&quot;. &quot;+roles[j]+&quot; (&quot;+roleKeys.length+&quot;): &quot;+roleKeys);
//		}
	    }
//	    if( !isValidFrameCallback( this.$GalleryFCB3 ) )
//		this.$GalleryFCB3 = addFrameCallback( this.$Gallery_OtherRole );//bug: give all keys, not others only

	}
	
	this.$GalleryAllObjects = this.$GalleryKeysForRole[ 0 ].sort(); //store all ships
//	this.$GalleryEncounters.sort();//Gallery_EncSort() is better after GalleryEncNames is filled

		
	//get encountered ship names
	for( var j = 0; j &lt; this.$GalleryEncounters.length; j++ ) {
		var key = this.$GalleryEncounters[j];
		if( Ship.shipDataForKey ) { //new fast method in 1.79 since 2014.05.19
			var s = Ship.shipDataForKey(key);
			if(this.$GalleryLog) log(&quot;Gallery&quot;, j+&quot;. &quot;+key+&quot; shipDataForKey &quot;+s);//debug
			if( s &amp;&amp; s.name &amp;&amp; s.name.length &gt; 0 ) this.$Gallery_AddEncName(j, s.name); //check and store name
		} else { //old slower way to get ship names, need validate check also
			var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 1000000);
			if( ( !ships || !ships[0] ) &amp;&amp; key.indexOf(&quot;-player&quot;) &gt; -1 ) { //handle unsuccesful ship creation
				key = key.slice(0, key.indexOf(&quot;-player&quot;)); //remove -player
				ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 1000000);
				if( !ships || !ships[0] ) { //handle unsuccesful ship creation
					this.$GalleryEncounters.splice(j,1); //remove item
					j--;
//					if(this.$GalleryLog) 
						log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], removed.&quot;);
				} else {
					this.$Gallery_AddEncName(j, ships[0].name); //check and store name
					ships[0].remove(true); //ok without -player
				}
			} else {
				if( ships &amp;&amp; ships[0] ) {
					var ship = ships[0];
					if( ship.roles ) for( var k = 0; k &lt; ship.roles.length; k++ ) {
						if( ship.roles[k] &amp;&amp; ship.roles[k].indexOf(&quot;subent&quot;) &gt; -1 ) {
							//skip subentities in Griff_Shipset_Replace_v1.34.oxp
							this.$GalleryEncounters.splice(j,1); //remove item
							j--;
							k = ship.roles.length;//exit from cycle
							var msg = &quot;Subentity [&quot;+key+&quot;] removed.&quot;;
//							if(this.$GalleryLog) 
								log(&quot;Gallery&quot;, msg);
							if(ship != player.ship) ship.remove(true);
						}
					}
					this.$Gallery_AddEncName(j, ship.name); //check and store name
					ship.remove(true); //ok
				} else //if(this.$GalleryLog)
					log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], removed.&quot;);
			}
		}
	}

	if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot; Gallery (&quot;+this.$GalleryEncounters.length+&quot;): &quot;+this.$GalleryEncounters);//debug
	this.$Gallery_EncSort();
	this.$GalleryKeysForRole[ 0 ] = this.$GalleryEncounters;//always start in enc. array
	if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot; Gallery (&quot;+this.$GalleryEncounters.length+&quot;): &quot;+this.$GalleryEncounters);//debug

	if( player.ship &amp;&amp; player.ship.docked ) this.shipDockedWithStation( player.ship.dockedStation ); //set interface
	else if( system ) this.shipDockedWithStation( system.mainStation );//fallback
}

this.commsMessageReceived = function(message, sender) {
	this.$Gallery_Encounter( sender );
}

this.distressMessageReceived = function(aggressor, sender) {
	this.$Gallery_Encounter( aggressor );
	this.$Gallery_Encounter( sender );
}
	
this.playerTargetedMissile = function(missile) {
	this.$Gallery_Encounter( missile );
}

this.playerWillSaveGame = function(message) {
	missionVariables.$GalleryEncounters = this.$GalleryEncounters;  //store encountered ships into savegame
	missionVariables.$GalleryLastEnc = this.$GalleryLastEnc;  //store order of encounters into savegame
}

this.shipAttackedOther = function(other) {
	this.$Gallery_Encounter( other );
}

this.shipAttackedWithMissile = function(missile, whom) {
	this.$Gallery_Encounter( missile );
	this.$Gallery_Encounter( whom );
}

this.shipBeingAttacked = function(whom) {
	this.$Gallery_Encounter( whom );
}

this.shipBeingAttackedUnsuccessfully = function(whom) {
	this.$Gallery_Encounter( whom );
}

this.shipCloseContact = function(otherShip) {
	this.$Gallery_Encounter( otherShip );
}

this.shipCollided = function(otherShip)
{
	this.$Gallery_Encounter( otherShip );
}

this.shipDockedWithStation = function(station)
{
	if( isValidFrameCallback( this.$GalleryFCB ) )
		removeFrameCallback( this.$GalleryFCB );
	var len = this.$GalleryLastEnc.length;
	var s = &quot;&quot;;
	if( len &gt; 1 ) s = &quot;s&quot;;
	station.setInterface(&quot;Gallery&quot;,{
		title: &quot;Gallery of encounters (&quot;+this.$GalleryLastEnc.length+&quot; item&quot;+s+&quot; stored)&quot;,
		category: &quot;Ship Systems&quot;,
		summary: &quot;Shows a gallery of ships and other space objects that you have encountered, with public technical data where available.&quot;,
		callback: this.$Gallery_Interface.bind(this)
		});
	if( this.$GalleryAll ) {
	    station.setInterface(&quot;GalleryAll&quot;,{
		title: &quot;Gallery of all objects (&quot;+this.$GalleryAllObjects.length+&quot; objects)&quot;,
		category: &quot;Ship Systems&quot;,
		summary: &quot;Shows a gallery of all ships and other space objects, with public technical data where available.&quot;,
		callback: this.$Gallery_InterfaceAll.bind(this)
	    });
	}
}

this.shipEnteredStationAegis = function(station) {
	this.$Gallery_Encounter( station );
}

this.shipFiredMissile = function(missile, target) {
	this.$Gallery_Encounter( missile );
	this.$Gallery_Encounter( target );
}

this.shipKilledOther = function(whom, damageType) {
	this.$Gallery_Encounter( whom );
}

this.shipScoopedOther = function(whom) {
	this.$Gallery_Encounter( whom );
}

this.shipTakingDamage = function(amount, whom, type) {
	this.$Gallery_Encounter( whom );
}

this.shipTargetAcquired = function(target) {
	this.$Gallery_Encounter( target );
}

this.shipWillLaunchFromStation = function() {
	player.ship.hudHidden = false;
	if( isValidFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB ) )
		removeFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB );
}


//Gallery methods
this.$Gallery_AddEncName = function( j, n ) { //save name for search, check for empty and duplicated name
	if( n &amp;&amp; n.length &gt; 0 ) {
		var x = this.$GalleryEncNames.indexOf(n);
		if( x &gt; -1 ) { //duplicated name, add number in parenthesis to the name
			for( var i = 1; i &lt; 10000; i++ ) {
				var n2 = n + &quot; (&quot; + i + &quot;)&quot;;
				if( this.$GalleryEncNames.indexOf(n2) == -1 ) i = 10000;//exit
			}
			this.$GalleryEncNames[j] = n2;
		} else this.$GalleryEncNames[j] = n;//save name
	} else this.$GalleryEncNames[j] = this.$GalleryEncounters[j];//datakey if name is empty
	if(this.$GalleryLog) log(&quot;Gallery&quot;, j+&quot;. &quot;+this.$GalleryEncounters[j]+&quot;: &quot;+this.$GalleryEncNames[j]);
}

this.$Gallery_Encounter = function( ship ) { //save the keys of encountered ships
	if( !ship || !ship.isValid || !player.ship || !player.ship.isValid ) return;
	var key = ship.dataKey;
	if( key &amp;&amp; key != &quot;telescopemarker&quot; &amp;&amp; key.indexOf(&quot;customshields&quot;) == -1
		&amp;&amp; ( !this.$GalleryEncounters || this.$GalleryEncounters.indexOf( key ) == -1 ) ) {
		if(this.$GalleryLog) log(&quot;Gallery&quot;, key+&quot; encountered.&quot;);
		if( !this.$GalleryEncounters ) this.$GalleryEncounters = [ key ];
		else this.$GalleryEncounters.push( key ); //do not sort: EncNames array will be in wrong order!
		if( !this.$GalleryLastEnc ) this.$GalleryLastEnc = [ key ];
		else this.$GalleryLastEnc.push( key ); //do not sort at all: this array hold the order of encounters
		var j = this.$GalleryEncounters.length - 1; //last item
		this.$Gallery_AddEncName( j, ship.name ); //do not use displayName to avoid randomshipnames OXP
//		this.$GalleryEncNames.push( ship.name );
		player.consoleMessage(this.$GalleryEncNames[j]+&quot; is now added to your ship&#39;s Gallery.&quot;,10); //as the &quot;+(j+1)+&quot;. space object
		this.$Gallery_EncSort();//sort after consoleMessage only!
//		if( !this.$GalleryShowAll ) this.$GalleryKeysForRole[0] = this.$GalleryEncounters;//needed but EncSort do it


		if( this.$GalleryAll ) for( var i = 2; i &lt; this.$GalleryRoles.length; i++ ) { //main roles
			if( ship.roles &amp;&amp; ship.roles.indexOf( this.$GalleryRoles[i] ) != -1 ) {
				if( !this.$GalleryKeysForRole[ i ] ) this.$GalleryKeysForRole[ i ] = [key];
				else this.$GalleryKeysForRole[ i ].push( key );
				this.$GalleryKeysForRole[ i ].sort();
			}
		}
	}
}

this.$Gallery_EncSort = function() {
	var g = worldScripts[&quot;gallery&quot;];
	var e = g.$GalleryEncounters;
	var n = g.$GalleryEncNames;
	var k = []; //dataKeys for names
	for( var i = 0; i &lt; n.length; i++ ) {
		if( n[i] &amp;&amp; n[i].length &gt; 0 ) k[ n[i] ] = e[i];
		else {
			e[i] = null;
			n[i] = null;
		}
	}
	g.$GalleryEncNames.sort();
	n = g.$GalleryEncNames;
	var e2 = [];
	for( var i = 0; i &lt; n.length; i++ ) e2[i] = k[ n[i] ];
	g.$GalleryEncounters = e2;
	if( !g.$GalleryShowAll ) g.$GalleryKeysForRole[ 0 ] = g.$GalleryEncounters;
}

this.$Gallery_FCB = function( delta ) { //FrameCallBack updating ship in sell salvage screen
	var m = mission.displayModel;
	if( m &amp;&amp; m.isValid ) {
		var g = worldScripts[&quot;gallery&quot;];
		
		switch( g.$GalleryRotate ) {
			case 0:
				m.orientation = m.orientation.rotateY( delta/1.5 );
				break;
			case 2:
				m.orientation = m.orientation.rotateY( -delta/1.5 );
				break;
			case 4:
				m.orientation = m.orientation.rotateX( delta/1.5 );
				break;
			case 6:
				m.orientation = m.orientation.rotateX( -delta/1.5 );
				break;
		}
		g.$GalleryOri = mission.displayModel.orientation;
		
		//Move and zoom, camera is at [0,0,0] facing [1,0,0,0]
		switch( g.$GalleryMove ) {
			case 1:
				g.$GalleryShiftX += g.$GallerySpeed * g.$GalleryShift * delta;
				break;
			case 3:
				g.$GalleryShiftX -= g.$GallerySpeed * g.$GalleryShift * delta;
				break;
			case 5:
				g.$GalleryShiftY += g.$GallerySpeed * g.$GalleryShift * delta;
				break;
			case 7:
				g.$GalleryShiftY -= g.$GallerySpeed * g.$GalleryShift * delta;
				break;
		}
		if( g.$GalleryZoom == 1 ) g.$GalleryShiftZ -= 3 * g.$GallerySpeed * g.$GalleryShift * delta;
		else if( g.$GalleryZoom == 3 ) g.$GalleryShiftZ += 3 * g.$GallerySpeed * g.$GalleryShift * delta;
		
		var w = oolite.gameSettings.gameWindow;
		var wide = Math.max( 0.01, ( w.width / w.height ) / g.$GalleryDefaultZoom ); //correction if not in widescreen
		mission.displayModel.position = Vector3D(g.$GalleryShiftX, g.$GalleryShiftY, g.$GalleryShiftZ * wide);
	}
}

this.$Gallery_FCB2 = function( delta ) { //FrameCallBack for menu
	var g = worldScripts[&quot;gallery&quot;];
	if( isValidFrameCallback( g.$GalleryFCB2 ) ) removeFrameCallback( g.$GalleryFCB2 );
	g.$Gallery_Interface2( g.$GalleryShowAll );
}

this.Gallery_GetShipData = function(ship, all) {
	var equip=&quot;&quot;;
	var s=&quot;&quot;;
	s=ship.forwardWeapon;
	if( s!=null &amp;&amp; s.equipmentKey != &quot;EQ_WEAPON_NONE&quot; ) equip+=&quot;Forward &quot;+s.name;
	var shipno = 0;
	var r =  worldScripts[&quot;rocketmenu&quot;];
	if( r ) {
		shipno = r.$RocketMenu_Name.indexOf(ship.dataKey); //RocketShip with extra weapons
	}
	if( shipno &gt; 0 ) {
		var pul = r.$RocketMenu_Pulse[shipno];
		if( pul &gt; 0 ) {
			if( equip.length &gt; 0 ) equip+=&quot;\n&quot;;
			if( pul &gt; 1) equip+=pul+&quot; &quot;;
			equip+=&quot;Auto Pulse Laser&quot;;
			if( pul &gt; 1) equip+=&quot;s&quot;;
		}
		var ham = r.$RocketMenu_Hammer[shipno];
		if( ham &gt; 0 ) {
			if( equip.length &gt; 0 ) equip+=&quot;\n&quot;;
			if( ham &gt; 1) equip+=ham+&quot; &quot;;
			equip+=&quot;Hammer Laser&quot;;
			if( ham &gt; 1) equip+=&quot;s&quot;;
		}
		var Sniper = r.$RocketMenu_Sniper[shipno];
		if( Sniper &gt; 0 ) {
			if( equip.length &gt; 0 ) equip+=&quot;\n&quot;;
			if( Sniper &gt; 1) equip+=Sniper+&quot; &quot;;
			equip+=&quot;Sniper Laser&quot;;
			if( Sniper &gt; 1) equip+=&quot;s&quot;;
		}
		var pha = r.$RocketMenu_Sapper[shipno];
		if( pha &gt; 0 ) {
			if( equip.length &gt; 0 ) equip+=&quot;\n&quot;;
			if( pha &gt; 1) equip+=pha+&quot; &quot;;
			equip+=&quot;Sapper&quot;;
			if( pha &gt; 1) equip+=&quot;s&quot;;
		}
	}
	s=ship.aftWeapon;
	if( s!=null &amp;&amp; s.equipmentKey != &quot;EQ_WEAPON_NONE&quot; ) {
		if( equip.length &gt; 0 ) equip+=&quot;\n&quot;; //Anaconda has aft weapon only
		equip+=&quot;Aft &quot;+s.name;
	}
	s=ship.portWeapon;
	if( s!=null &amp;&amp; s.equipmentKey != &quot;EQ_WEAPON_NONE&quot; ) equip+=&quot;\nPort &quot;+s.name;
	s=ship.starboardWeapon;
	if( s!=null &amp;&amp; s.equipmentKey != &quot;EQ_WEAPON_NONE&quot; ) equip+=&quot;\nStarboard &quot;+s.name;
	if( shipno &gt; 0 ) {
		var bt = r.$RocketMenu_Turrets[shipno];
		if( bt &gt; 0) {  //RocketShip with turrets
			if( equip.length &gt; 0 &amp;&amp; !ship.portWeapon &amp;&amp; !ship.starboardWeapon) equip+=&quot;\n&quot;;
			else equip+=&quot;, &quot;;
			if(bt &lt; 1) equip += (bt*10)+&quot; Mini&quot;;
			else if(bt &gt; 99) equip += Math.floor(bt/100)+&quot; Strong&quot;;
			else equip += bt+&quot; Ball&quot;;
			equip += &quot; Turret&quot;;
			if( bt &gt; 1) equip+=&quot;s&quot;;
		}
		if(ship.dataKey.indexOf(&quot;rocketcruiser&quot;) &gt; -1) equip+=&quot;, 2 Main Turrets&quot;; //rocketcruiser-player
	}
	if(equip.length &gt; 0) equip+=&quot;\n&quot;;
	else if( ship.isPiloted || all ) equip+=&quot;No Laser\n&quot;;
	var eqs = &quot;&quot;;
/*	var n = &quot;&quot;; //equipment list removed to make space
	var eq = ship.equipment;
	var i=-1;
	while(eq[++i]) {
		n = eq[i].name;
		if( n.length &gt; 0 ) eqs += n + &quot;, &quot;;
		else {	//skip noname eqs awarded by NumericHUD to avoid timeLimit error
			for( var j = i + 10; j &lt; eq.length; j+=10 ) {
				if( eq[j].name.length != 0 ) {
					i = j - 10; //end of skip
					j = eq.length;
				}
			}
			while( i &lt; eq.length &amp;&amp; eq[i].name.length == 0 ) i++;
			i--;
		}
	}
	eqs = eqs.substr( 0, eqs.length - 2 ); //cut last comma
	if( eqs.length &gt; 0 ) equip+=eqs+&quot;\n\n&quot;;
	else equip+=&quot;\n&quot;;//empty line before desc if no eqs
*/	var desc = &quot;&quot;;
	if( ship.scriptInfo &amp;&amp; ship.scriptInfo.buydesc )//show ship description if any
		desc=&quot;\&quot;&quot;+ship.scriptInfo.buydesc+&quot;\&quot;\n&quot;;
	var sh = 0;
	if( ship == player.ship ) sh += ship.maxForwardShield;
	else {
		var w = worldScripts[&quot;NPC-shields&quot;];
		if( w &amp;&amp; ship.script ) {
			if( !ship.script.maxShieldStrength ) w.shipSpawned(ship); //add npc shield
			sh += ship.script.maxShieldStrength;
		}
		var w = worldScripts[&quot;customshields&quot;];
		if( w &amp;&amp; ship.script ) {
			if( !ship.script.customshieldsmaxforwardshieldlevel ) w.shipSpawned(ship); //add customshield
			sh += ship.script.customshieldsmaxforwardshieldlevel;
		}
	}
	if( ship.dataKey.indexOf(&quot;escape-capsule&quot;) &gt; -1 ) sh = 0; //no shield on escape pod
	else if( worldScripts[&quot;shieldequalizercapacitors&quot;] ) {
		if( ship.equipmentStatus(&quot;EQ_BIGSHCAP&quot;) == &quot;EQUIPMENT_OK&quot;
			&amp;&amp; ship.equipmentStatus(&quot;EQ_FORWARD_SHIELD_CAPACITOR&quot;) == &quot;EQUIPMENT_OK&quot; ) sh += 256;
		else if( ship.equipmentStatus(&quot;EQ_FORWARD_SHIELD_CAPACITOR&quot;) == &quot;EQUIPMENT_OK&quot; ) sh += 64;
	}
	var psd = &quot;&quot;;//ship.displayName+
	var hd = &quot;&quot;;
	if(!ship.hasHyperspaceMotor ) hd = &quot;  No Hyperdrive&quot;;
	var speed = ship.maxSpeed;
	if( ship.script &amp;&amp; ship.script.name === &quot;rocketships&quot; )
		speed = Math.round(ship.maxSpeed/3*2)+&quot;+&quot;+Math.round(ship.maxSpeed/3);
	if( speed &gt; 0 ) psd += &quot;Speed: &quot;+speed+&quot; mLS  Thrust: &quot;+ship.maxThrust+&quot;  &quot;;
	if( all || speed &gt; 0 &amp;&amp; ship.isPiloted ) {
		psd += &quot;\nPitch: &quot;+Math.round(ship.maxPitch*100)/100+
			&quot;  Roll: &quot;+Math.round(ship.maxRoll*100)/100+
			&quot;  Yaw: &quot;+Math.round(ship.maxYaw*100)/100+hd+
//			&quot;  Version: &quot;+this.$shipVersion(ship)+
//			&quot;  Service &quot;+ship.serviceLevel+
			&quot;\nCargo: &quot;+ship.cargoSpaceCapacity;
		if( ship.extraCargo &gt; 0 ) psd += &quot;+&quot;+parseInt(ship.extraCargo); //need Oolite v1.79
		else if( ship.scriptInfo &amp;&amp; ship.scriptInfo.cargoext &amp;&amp; parseInt(ship.scriptInfo.cargoext) &gt; 0 )
			psd += &quot;+&quot;+parseInt(ship.scriptInfo.cargoext);
		psd += &quot;t  &quot;;
	}
	var sp = &quot;&quot;;
	var sph = Math.round(ship.collisionRadius*ship.collisionRadius*Math.PI);
	if( sph &lt; 1000000 ) sp = sph;
	else sp = Math.round(sph/100000)/10+&quot;k&quot;;//base sphere too large to fit in the line so show in km^2

	var en = &quot;&quot;;
	var r = &quot;&quot;;
	if(all) en = &quot;Energy: &quot;+ship.maxEnergy;
	else {
		if( ship.isPiloted ) {
			var eb = Math.max(1, Math.floor(ship.maxEnergy/64));
			en = &quot;EBank&quot;;
			if( eb &gt; 1 ) en += &quot;s&quot;;
			en += &quot;: &quot;+eb;
		}
	}

	if( ship.isPiloted || all ) {
		var er = 0;
		if( ship.energyRechargeRate &gt; 0 ) er = parseInt(ship.energyRechargeRate); //need Oolite v1.79
		else if( ship.scriptInfo &amp;&amp; ship.scriptInfo.recharge &amp;&amp; parseInt(ship.scriptInfo.recharge) &gt; 0 )
			er = parseInt(ship.scriptInfo.recharge);
		if( er &gt; 0 ) {
			var ers = &quot;&quot;;
			if( er &lt; 2.5 ) ers = &quot;Poor&quot;;
			else if( er &lt; 3.5 ) ers = &quot;Medium&quot;;
			else if( er &lt; 4.5 ) ers = &quot;Good&quot;;
			else if( er &lt; 10 ) ers = &quot;Excellent&quot;;
			else ers = &quot;Extreme&quot;;
			if( all ) ers += &quot; (&quot;+er+&quot;)&quot;;
			r = &quot;  Recharge: &quot;+ers;
		}
		if( sh &gt; 0 ) r += &quot;\nShields: &quot;+Math.max(2, Math.floor(sh/64));
		if( ship.missileCapacity &gt; 0 ) {
			if( sh &gt; 0 ) r += &quot;  &quot;; else r += &quot;\n&quot;;
			r += &quot;Missile&quot;;
			if( ship.missileCapacity &gt; 1 ) r += &quot;s&quot;;
			r += &quot;: &quot;+ship.missileCapacity;
		}
	}

	psd += &quot;Mass: &quot;+Math.max(Math.round(ship.mass)/1000, 1)+ //min.1t
		&quot;t\nSize: &quot;+Math.round(ship.boundingBox.x)+&quot;*&quot;+
		Math.round(ship.boundingBox.y)+&quot;*&quot;+Math.round(ship.boundingBox.z)+
		&quot;m Radius: &quot;+Math.round(ship.collisionRadius)+&quot;m&quot;+//&quot; Sphere: &quot;+sp+&quot;m^2&quot;+
		&quot;\n&quot;+en+r;
//	if( ship.scriptInfo &amp;&amp; ship.scriptInfo.hardarmour &amp;&amp; parseInt(ship.scriptInfo.hardarmour) &gt; 0 )
//		psd += &quot;\nHard Armour deflect &quot;+parseInt(ship.scriptInfo.hardarmour)+&quot; points from any damage&quot;;
		//removed, redundant with Hard Armour Equipment and give more free space
	psd += &quot;\n&quot;+equip;
	if( worldScripts[&quot;gallery&quot;].$GalleryMore ) psd = desc + psd;
	if( ship.price &gt; 0 ) psd += &quot;\nPrice: &quot;+formatCredits(ship.price, false, true);
	return(psd);
}

this.$Gallery_Interface = function() { //encounters only
	player.ship.hudHidden = true;//to shift down the menu
	var g = worldScripts[&quot;gallery&quot;];
	g.$GalleryShowAll = false;
	g.$GalleryKeysForRole[ 0 ] = g.$GalleryEncounters; //fill up default key array
	
	var e = worldScripts[&quot;exhibitions&quot;];
	if( e &amp;&amp; isValidFrameCallback( e.$ExhibitionsMenuFCB ) )
		removeFrameCallback( e.$ExhibitionsMenuFCB );  //need for bugfix
	
	this.$Gallery_LastEncounters( false, true ); //not all, init
//	this.$Gallery_Search( false, true ); //not all, init
//	this.$Gallery_Interface2( false );
}

this.$Gallery_InterfaceAll = function() { //all ships
	player.ship.hudHidden = true;//to shift down the menu
	var g = worldScripts[&quot;gallery&quot;];
	g.$GalleryShowAll = true;
	g.$GalleryKeysForRole[ 0 ] = g.$GalleryAllObjects; //fill up default key array
	this.$Gallery_Search( true, true ); //all, init
//	this.$Gallery_Interface2( true );
}

this.$Gallery_Interface2 = function( all ) {
	if( player.ship &amp;&amp; player.ship.docked &amp;&amp; system ) {
		player.ship.hudHidden = true;//to shift down the menu
		var g = worldScripts[&quot;gallery&quot;];
		if( !g.$GalleryKeyi[g.$GalleryRole] ) g.$GalleryKeyi[g.$GalleryRole] = 0; //prevent a bug
		var key = g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]];
		if(!key) {
			g.$GalleryKeyi[g.$GalleryRole] = 0;
			key = g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]];
			if(!key) {
				g.$GalleryRole = 0;
				key = g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]];
				if(!key) {
					g.$GalleryKeyi[g.$GalleryRole] = 0;
					key = g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]];
					if(!key) return; //no key found
				}
			}
		}
		if( key == player.ship.dataKey ) var ship = player.ship;
		else {
			if( !all &amp;&amp; 
				( g.$GalleryPlayerShips &amp;&amp; g.$GalleryPlayerShips.indexOf(key) == -1 ) &amp;&amp;
				( g.$GalleryEncounters &amp;&amp; g.$GalleryEncounters.indexOf(key) == -1 ) ) {
				if(this.$GalleryLog) log(&quot;Gallery&quot;, key+&quot; not encountered so removed. &quot;);
				this.$Gallery_RemoveCurrentShip(g, all); //will retry also
				return;
			}
			var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
			if( !ships ) { //need to handle unsuccesful ship creation
				var p = key.indexOf(&quot;-player&quot;);
				if( p &gt; -1 ) var key = key.slice(0, p); //remove -player part
				ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
				if( !ships ) { //need to handle unsuccesful ship creation
					var msg = &quot;Failed addShips with role [&quot;+key+&quot;], removed.&quot;;
					if(this.$GalleryLog) log(&quot;Gallery&quot;, msg);
					this.$Gallery_RemoveCurrentShip(g, all); //will retry also
					return;
				}
			}
			var ship = ships[0];
			if( ship.roles ) for( var i = 0; i &lt; ship.roles.length; i++ ) {
				if( ship.roles[i] &amp;&amp; ship.roles[i].indexOf(&quot;subent&quot;) &gt; -1 ) {
					i = ship.roles.length; //found, will exit from cycle
					//skip subentities in Griff_Shipset_Replace_v1.34.oxp
					var msg = &quot;Subentity [&quot;+key+&quot;] removed.&quot;;
					if(this.$GalleryLog) log(&quot;Gallery&quot;, msg);
					if(ship != player.ship) ship.remove(true);
					this.$Gallery_RemoveCurrentShip(g, all); //will retry also
					return;
				}
			}
		}
		if(this.$GalleryLog) log(&quot;Gallery&quot;, &quot;dataKey: &quot;+key+ &quot; Keyi:&quot;+g.$GalleryKeyi[g.$GalleryRole]+
			&quot; Gallery (&quot;+g.$GalleryKeysForRole.length+&quot;): &quot;+g.$GalleryKeysForRole );

		var c = [key,
			&quot;Previous&quot;,
			&quot;Role: &quot;+g.$GalleryRoles[g.$GalleryRole]+
				&quot; (&quot;+g.$GalleryKeysForRole[g.$GalleryRole].length+&quot;)&quot;,
			&quot;Previous role&quot;,
			&quot;Search&quot;,
			[&quot;Rotate Y+&quot;,&quot;Rotate stop&quot;,&quot;Rotate Y-&quot;,&quot;Rotate stop&quot;,&quot;Rotate X+&quot;,&quot;Rotate stop&quot;,&quot;Rotate X-&quot;,&quot;Rotate stop&quot;],
			[&quot;Move stop&quot;,&quot;Move X+&quot;,&quot;Move stop&quot;,&quot;Move X-&quot;,&quot;Move stop&quot;,&quot;Move Y+&quot;,&quot;Move stop&quot;,&quot;Move Y-&quot;],
			[&quot;Zoom stop&quot;,&quot;Zoom +&quot;,&quot;Zoom stop&quot;,&quot;Zoom -&quot;],
			&quot;Exit&quot;,
			&quot;Hide Menu&quot;,
			&quot;Menu&quot;];
			
		if( !all &amp;&amp; !g.$GalleryValidateTarget(ship) ) {
			var msg = &quot;No public details.&quot;;
			if(this.$GalleryLog) log(&quot;Gallery&quot;, key+&quot; showed without data.&quot;);
		} else {
			var msg = g.Gallery_GetShipData(ship, all);
			if(this.$GalleryLog) log(&quot;Gallery&quot;, msg);
		}
		if(ship != player.ship) ship.remove(true); //will really disappear after the end of the function
		
		var title = ship.displayName;
		var x = g.$GalleryEncounters.indexOf(key);
		if( x &gt; -1 ) title = g.$GalleryEncNames[x]; //show (1), (2), etc. after duplicated names
		if( all ) name = key;
		else name = title;
		if( !name || name.length &lt; 1) name = &quot;...&quot;; //for sure
		
		var ch = {	&quot;_0&quot; : name,
				&quot;_10&quot; : c[10]
		};
		if( g.$GalleryMore ) {
			if( all ) ch = {	&quot;_0&quot; : name,
		    			&quot;_1&quot; : c[1],
		    			&quot;_2&quot; : c[2],
		    			&quot;_3&quot; : c[3],
		    			&quot;_4&quot; : c[4],
		    			&quot;_5&quot; : c[5][g.$GalleryRotate],
		    			&quot;_6&quot; : c[6][g.$GalleryMove],
		    			&quot;_7&quot; : c[7][g.$GalleryZoom],
		    			&quot;_8&quot; : c[8],
		    			&quot;_9&quot; : c[9]
				};
			else ch = {	&quot;_0&quot; : name,
		    			&quot;_1&quot; : c[1],
//		    			&quot;_2&quot; : c[2], //without role menus
//		    			&quot;_3&quot; : c[3],
		    			&quot;_4&quot; : c[4],
		    			&quot;_5&quot; : c[5][g.$GalleryRotate],
		    			&quot;_6&quot; : c[6][g.$GalleryMove],
		    			&quot;_7&quot; : c[7][g.$GalleryZoom],
		    			&quot;_8&quot; : c[8],
		    			&quot;_9&quot; : c[9]
				};
		} 
		mission.runScreen({
			title: title,
			message: msg,
			model: &quot;[&quot;+key+&quot;]&quot;,
			modelPersonality: 0,
			spinModel:false,
			background: &quot;gallery_bg.png&quot;,
			initialChoicesKey: &quot;_&quot;+g.$GalleryLastMenu,
			choices: ch
		},function(choice) {
			switch(choice) {
				case &quot;_0&quot;:
					if( ++g.$GalleryKeyi[g.$GalleryRole] &gt;= g.$GalleryKeysForRole[g.$GalleryRole].length
						|| !g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]] ) 
						g.$GalleryKeyi[g.$GalleryRole] = 0;
					g.$GalleryLastMenu = 0;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_1&quot;:
					if( --g.$GalleryKeyi[g.$GalleryRole] &lt; 0 )
						g.$GalleryKeyi[g.$GalleryRole] = 
							g.$GalleryKeysForRole[g.$GalleryRole].length - 1;
					g.$GalleryLastMenu = 1;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_2&quot;:
					if( ++g.$GalleryRole &gt;= g.$GalleryRoles.length )
//						|| !g.$GalleryKeysForRole[g.$GalleryRole][g.$GalleryKeyi[g.$GalleryRole]] )
						g.$GalleryRole = 0;
					while( g.$GalleryRole &gt; 0 &amp;&amp;
						!g.$GalleryKeysForRole[g.$GalleryRole]
						|| g.$GalleryKeysForRole[g.$GalleryRole].length &lt; 1 ) { //skip empty roles
						if( ++g.$GalleryRole &gt;= g.$GalleryRoles.length ) g.$GalleryRole = 0;
					}
					g.$GalleryLastMenu = 2;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_3&quot;:
					if( --g.$GalleryRole &lt; 0 ) g.$GalleryRole =  g.$GalleryRoles.length - 1;
					while( g.$GalleryRole &gt; 0 &amp;&amp;
						!g.$GalleryKeysForRole[g.$GalleryRole]
						|| g.$GalleryKeysForRole[g.$GalleryRole].length &lt; 1 ) { //skip empty roles
						g.$GalleryRole--;
					}
					g.$GalleryLastMenu = 3;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_4&quot;:
					g.$GalleryLastMenu = 0;
					g.$Gallery_Search( all, false ); //use textEntry from Oolite v1.79
				break;
				case &quot;_5&quot;:
					if( ++g.$GalleryRotate &gt;= c[5].length ) g.$GalleryRotate = 0;
					g.$GalleryLastMenu = 5;
					mission.displayModel.orientation = g.$GalleryOri;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_6&quot;:
					if( ++g.$GalleryMove &gt;= c[6].length ) g.$GalleryMove = 0;
					g.$GalleryLastMenu = 6;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_7&quot;:
					if( ++g.$GalleryZoom &gt;= c[7].length ) g.$GalleryZoom = 0;
					g.$GalleryLastMenu = 7;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_8&quot;: //exit
				break;
				case &quot;_9&quot;: //Hide Menu
					g.$GalleryMore = false;
					g.$GalleryLastMenu = 10;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
				case &quot;_10&quot;: //Menu
					g.$GalleryMore = true;
					g.$GalleryLastMenu = 9;
					if( !isValidFrameCallback( g.$GalleryFCB2 ) )
						g.$GalleryFCB2 = addFrameCallback( g.$Gallery_FCB2 );
				break;
			}
		});
		if( g.$GalleryLog ) log(&quot;Gallery&quot;, key +&quot; &quot;+ g.$GalleryKey);
		if( key != g.$GalleryKey ) { //save position if new model
			g.$GalleryKey = key;
			g.$GalleryShiftX = mission.displayModel.position.x;
			g.$GalleryShiftY = mission.displayModel.position.y;
			if( g.$GalleryPrevZ &lt; 1 || g.$GalleryShiftZ &lt; 1 )
				g.$GalleryShiftZ = mission.displayModel.position.z;
			else {
				g.$GalleryShiftZ = mission.displayModel.position.z * g.$GalleryShiftZ / g.$GalleryPrevZ; ///
				g.$GalleryPrevZ = mission.displayModel.position.z;
			}
//			g.$GalleryOri = mission.displayModel.orientation;
		} else mission.displayModel.orientation = g.$GalleryOri;
		
		g.$GalleryShift = Math.max( ship.collisionRadius * 0.7 ,  //fix for adder and moray
					0.5 * mission.displayModel.position.z
					- Math.max( ship.boundingBox.x, ship.boundingBox.y ) ) / 5;
		if( g.$GalleryLog ) log(&quot;Gallery&quot;, mission.displayModel.position+ &quot; shift:&quot;+ g.$GalleryShift);
		// camera is at [0,0,0] facing [1,0,0,0]
		mission.displayModel.orientation = //fix flashing shaders in 1.81
				mission.displayModel.orientation.rotateX( 0.001 );

		if( !isValidFrameCallback( g.$GalleryFCB ) )
			g.$GalleryFCB = addFrameCallback( g.$Gallery_FCB );
 		g.$Gallery_FCB(0);//needed to set position immediately
	}
}

this.$Gallery_LastEncounters = function( all, init ) {
	var g = worldScripts[&quot;gallery&quot;];
//	g.$GalleryLastEnc = g.$GalleryEncounters;//debug

	var bgkey = player.ship.dataKey;
	var c = [];
	var title = g.$Gallery_SearchHeadTitle( all );
	if( !g.$GalleryLastEnc || g.$GalleryLastEnc.length == 0 ) { //skip last encounters menu if none
		var msg = &quot;You have not found any object yet, but you can search in purchasable ships.&quot;;
//		g.$Gallery_Search( false, true ); //not all, init
	} else {
		var len = g.$GalleryLastEnc.length;
		var s = &quot;&quot;;
		if( len &gt; 1 ) s = &quot;s&quot;;
		var msg = &quot;You have so far encountered a total of &quot;+len+&quot; space object&quot;+s
			+&quot;. Below are the latest items added to your gallery. Select the gallery item that you wish to view.&quot;;
//		var msg = g.$Gallery_SearchHeadMsg( all )+&quot;   Last encounters:&quot;;
		var i = len - 1;
		bgkey = g.$GalleryLastEnc[ i ];
		for( var j = 0; i &gt;= 0 &amp;&amp; j &lt; 23; j++ ) { //in reverse order
			var ei = g.$GalleryEncounters.indexOf( g.$GalleryLastEnc[ i ] );
			if( ei &gt; -1 ) {
				c[ j ] = g.$GalleryEncNames[ ei ]; 
			} else j--;
			i--;
		}
	}
	
		var ch = {
			&quot;_10&quot; : c[0],
		    	&quot;_11&quot; : c[1],
		    	&quot;_12&quot; : c[2],
		    	&quot;_13&quot; : c[3],
		    	&quot;_14&quot; : c[4],
		    	&quot;_15&quot; : c[5],
		    	&quot;_16&quot; : c[6],
		    	&quot;_17&quot; : c[7],
		    	&quot;_18&quot; : c[8],
		    	&quot;_19&quot; : c[9],
		    	&quot;_20&quot; : c[10],
		    	&quot;_21&quot; : c[11],
		    	&quot;_22&quot; : c[12],
		    	&quot;_23&quot; : c[13],
		    	&quot;_24&quot; : c[14],
		    	&quot;_25&quot; : c[15],
		    	&quot;_26&quot; : c[16],
		    	&quot;_27&quot; : c[17],
		    	&quot;_28&quot; : c[18],
		    	&quot;_29&quot; : c[19],
		    	&quot;_30&quot; : c[20],
		    	&quot;_31&quot; : c[21],
		    	&quot;_32&quot; : c[22],
			&quot;_S&quot; : &quot;Search&quot; //max. 23 llines fit into the screen after two line msg and one empty line
		};
		
		if( isValidFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB ) )
			removeFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB );
		mission.runScreen({
			title: title,
			message: msg,
			background: &quot;gallery_bg.png&quot;,
			model: &quot;[&quot;+bgkey+&quot;]&quot;,
			modelPersonality: 0,
			spinModel:false,
//			initialChoicesKey: &quot;_&quot;+g.$GalleryLastMenu,
			choices: ch
		},function( choice ) {
			g.$GalleryRole = 0;
			if( choice == &quot;_S&quot; ) {
				g.$Gallery_Search( all, false ); //use textEntry from Oolite v1.79
				return;
			}
			var text = &quot;&quot;;
			if( choice ) text = c[ choice.substr(1) - 10 ]; //cut starting &quot;_&quot;
			g.$Gallery_SearchKey(text.toLowerCase(), all);
		});
		var m = mission.displayModel;
		if( m ) {
			var w = oolite.gameSettings.gameWindow; //correction if not in widescreen
			var wide = Math.max( 0.01, ( w.width / w.height ) / g.$GalleryDefaultZoom );
			m.position = Vector3D(m.position.x, m.position.y, m.position.z * wide );
		}
//	}
}

this.$Gallery_OtherRole = function() { //separated from startUp for faster boot
	var g = worldScripts[&quot;gallery&quot;];
	var k = g.$GalleryKeysForRole[ 0 ];  //do one check/frame = 60 check/sec, need about 10 sec to finish
	var i = g.$GalleryKeysi++;
	var o = g.$GalleryOthers;
	
//	var k = Ship.keys(); //all dataKeys
//	var o = [];
//	for( var i = 0; i &lt; k.length; i++ ) { //find keys not in main rules
		var ki = k[i];
		var ok = true;
		for( var j = 0; j &lt; g.$GalleryKeysForRole.length; j++ ) {
			if( g.$GalleryKeysForRole.indexOf( ki ) &gt; -1 ) { //bug: can not filter anything
				ok = false;
				j = g.$GalleryKeysForRole.length; //exit from cycle
			}
		}
		if( ok ) {//found new key
//			var key = ki;
//			var ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
//			if( ( !ships || !ships[0] ) &amp;&amp; key.indexOf(&quot;-player&quot;) &gt; -1 ) { //handle unsuccesful ship creation
//				key = key.slice(0, key.indexOf(&quot;-player&quot;)); //remove -player
//				ships = system.addShips(&quot;[&quot;+key+&quot;]&quot;, 1, [0,0,0], 25000);
//				if( !ships || !ships[0] ) { //handle unsuccesful ship creation
//					if(g.$GalleryLog) log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], skipped.&quot;);
//				} else {  //ok without -player
//					ships[0].remove(true);
//					o.push( ki );//add to others
//				}
//			} else {
//				if( ships &amp;&amp; ships[0] ) { //ok
//					ships[0].remove(true);
					o.push( ki );//add to others
//				} else if(g.$GalleryLog) log(&quot;Gallery&quot;, &quot;Failed addShips [&quot;+key+&quot;], skipped.&quot;);
//			}
		}
//	}
	i++;
	if( i &gt;=  k.length ) {
		o.sort();
		if( g.$GalleryLog) log(&quot;Gallery&quot;, &quot;All other dataKeys: &quot; + o );
		if( o.length &gt; 0 ) {
			g.$GalleryKeysForRole.push( o );
			g.$GalleryRoles.push(&quot;all others&quot;);
		}
		if( isValidFrameCallback( g.$GalleryFCB3 ) )
			removeFrameCallback( g.$GalleryFCB3 );
	}
	g.$GalleryOthers = o;
}

this.$Gallery_RemoveCurrentShip = function(g, all) {
	g.$GalleryKeysForRole[g.$GalleryRole].splice(g.$GalleryKeyi[g.$GalleryRole],1); //remove from the current list
	if(!g.$GalleryKeysForRole[g.$GalleryRole]
		|| g.$GalleryKeysForRole[g.$GalleryRole].length &lt; 1 ) //none left in this rule
		g.$GalleryRole = 0;
	else if(g.$GalleryKeyi[g.$GalleryRole] &gt; g.$GalleryKeysForRole[g.$GalleryRole].length)
		g.$GalleryKeyi[g.$GalleryRole] ==
			g.$GalleryKeysForRole[g.$GalleryRole].length - 1; //previous one
	g.$Gallery_Interface2( all ); //try again with another ship
}
	
this.$Gallery_Search = function( all, init ) {
	var g = worldScripts[&quot;gallery&quot;];
	var title = this.$Gallery_SearchHeadTitle( all );
	var msg = this.$Gallery_SearchHeadMsg( all );

	if (init || 0 &lt; oolite.compareVersion(&quot;1.79&quot;)) { //no textEntry before Oolite v1.79
		msg += &quot; Select the gallery item that you wish to view.&quot;;

		var k = [];
		if( g.$GalleryShowAll ) k = g.$GalleryKeysForRole[ 0 ];
		else k = g.$GalleryEncNames;
		var k1 = [];
		var l = [&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;,&quot;f&quot;,&quot;g&quot;,&quot;h&quot;,&quot;i&quot;,&quot;j&quot;,&quot;k&quot;,&quot;l&quot;,&quot;m&quot;,&quot;n&quot;,&quot;o&quot;,
			&quot;p&quot;,&quot;q&quot;,&quot;r&quot;,&quot;s&quot;,&quot;t&quot;,&quot;u&quot;,&quot;v&quot;,&quot;w&quot;,&quot;x&quot;,&quot;y&quot;,&quot;z&quot;];
		var z = [];
		for( var j = 0; j &lt; k.length; j++ ) 
			if(k[j]) k1[j] = k[j].charAt(0).toLowerCase(); 
			else if(g.$GalleryKeysForRole[ 0 ][j]) k1[j] = g.$GalleryKeysForRole[ 0 ][j].charAt(0).toLowerCase();
			else k1[j] = &quot;?&quot;;
		for( var i = 0; i &lt; l.length; i++ ) {
			var x = k1.indexOf( l[i] );
			if( x != -1 ) z[ l[i] ] = k[x];
		}
		var last = &quot;&quot;;
		if( g.$GalleryLastEnc &amp;&amp; g.$GalleryLastEnc.length &gt; 0 ) last = &quot;Last encounters&quot;;
		var ch = {	&quot;_&quot; : last,
				&quot;A&quot; : z.a,
				&quot;B&quot; : z.b,
				&quot;C&quot; : z.c,
				&quot;D&quot; : z.d,
				&quot;E&quot; : z.e,
				&quot;F&quot; : z.f,
				&quot;G&quot; : z.g,
				&quot;H&quot; : z.h,
				&quot;I&quot; : z.i,
				&quot;J&quot; : z.j,
				&quot;K&quot; : z.k,
				&quot;L&quot; : z.l,
				&quot;M&quot; : z.m,
				&quot;N&quot; : z.n,
				&quot;O&quot; : z.o,
				&quot;P&quot; : z.p,
//				&quot;Q&quot; : z.q,//removed to give a line to the exhibitions menu
				&quot;R&quot; : z.r,
				&quot;S&quot; : z.s,
				&quot;T&quot; : z.t,
				&quot;U&quot; : z.u,
				&quot;V&quot; : z.v,
				&quot;W&quot; : z.w,
				&quot;X&quot; : z.x,
				&quot;Y&quot; : z.y,
				&quot;Z&quot; : z.z
		};
//		if( g.$GalleryAll ) {
//			if( all ) {
//				ch += {&quot;ZZEnc&quot; : &quot;Encounters&quot;};
//				msg += &quot;\nSelect \&quot;Encounters\&quot; to see Gallery of encounters.&quot;;
//			} else {
//				ch += {&quot;ZZAll&quot; : &quot;All&quot;};
//				msg += &quot;\nSelect \&quot;All\&quot; to see Gallery of all objects.&quot;;
//			}
//		}
		if( isValidFrameCallback( g.$GalleryFCB ) ) removeFrameCallback( g.$GalleryFCB );
		mission.runScreen({
			title: title,
			message: msg,
			model: &quot;[&quot;+player.ship.dataKey+&quot;]&quot;,
			modelPersonality: 0,
			spinModel:false,
			background: &quot;gallery_bg.png&quot;,
//			initialChoicesKey: &quot;_&quot;+g.$GalleryLastMenu,
			choices: ch
		},function(text) {
			if( text == &quot;_&quot; ) { //Last encounters menu
				g.$Gallery_LastEncounters( all, init );
				return;
			}
//			if( text == &quot;__&quot; ) { //exhibitions menu
//				var e = worldScripts[&quot;exhibitions&quot;];
//				e.$ExhibitionsLastMenu = 0;
//				if( g.$GalleryLog) log(&quot;Gallery&quot;, &quot;exhibitions menu&quot;);
//				if( !isValidFrameCallback( e.$ExhibitionsMenuFCB ) )
//					e.$ExhibitionsMenuFCB = addFrameCallback( e.$Exhibitions_MenuFCB ); //will call ex.menu
//			} else { //selected a ship
				g.$GalleryRole = 0;
//			if( g.$GalleryAll &amp;&amp; !g.$GalleryShowAll &amp;&amp; text == &quot;ZZAll&quot;) {
//				g.$GalleryShowAll = true;
//				g.$GalleryKeysForRole[ 0 ] = g.$GalleryAllObjects; //fill up default key array
//			} else if( g.$GalleryAll &amp;&amp; g.$GalleryShowAll &amp;&amp; text == &quot;ZZEnc&quot;) {
//				g.$GalleryShowAll = false;
//				g.$GalleryKeysForRole[ 0 ] = g.$GalleryEncounters; //fill up default key array
//			} else 
				g.$Gallery_SearchKey(text.toLowerCase(), all);
//			}
		});
		var m = mission.displayModel;
		if( m ) {
			var w = oolite.gameSettings.gameWindow; //correction if not in widescreen
			var wide = Math.max( 0.01, ( w.width / w.height ) / g.$GalleryDefaultZoom );
			m.position = Vector3D(m.position.x, m.position.y, m.position.z * wide );
			m.orientation = m.orientation.rotateY( Math.PI );
		}
	} else { //textEntry need Oolite v1.79
		msg += &quot;\nType any part of a ship name or press enter for a list.\nDetails of your ship:\n\n&quot;;
//		if( g.$GalleryAll ) {
//			if( all ) msg += &quot;\nType \&quot;enc\&quot; to switch back to the Gallery of encounters.&quot;;
//			else msg += &quot;\nType \&quot;all\&quot; to switch to the Gallery of all objects.&quot;;
//		}
		msg += g.Gallery_GetShipData(player.ship, g.$GalleryShowAll);
		if( isValidFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB ) )
			removeFrameCallback( worldScripts[&quot;gallery&quot;].$GalleryFCB );
		mission.runScreen({
			title: title,
			message: msg,
			background: &quot;gallery_bg.png&quot;,
			model: &quot;[&quot;+player.ship.dataKey+&quot;]&quot;,
			modelPersonality: 0,
			spinModel:true,
			screenID: &quot;gallery-search&quot;,
			textEntry: true
		},function(text) {
			g.$GalleryRole = 0;
			if( !text || text.length == 0 ) {
				g.$Gallery_Search( all, true );
				return;
			}
			text = text.toLowerCase();
//			if( g.$GalleryAll &amp;&amp; !g.$GalleryShowAll &amp;&amp; text == &quot;all&quot;) {
//				g.$GalleryShowAll = true;
//				g.$GalleryKeysForRole[ 0 ] = g.$GalleryAllObjects; //fill up default key array
//			} else if( g.$GalleryAll &amp;&amp; g.$GalleryShowAll &amp;&amp; text == &quot;enc&quot;) {
//				g.$GalleryShowAll = false;
//				g.$GalleryKeysForRole[ 0 ] = g.$GalleryEncounters; //fill up default key array
//			} else 
				g.$Gallery_SearchKey(text, all);
		});
	}
}

this.$Gallery_SearchHeadMsg = function( all ) {
	var g = worldScripts[&quot;gallery&quot;];
	var len = g.$GalleryEncounters.length;
	if( all ) len = len + &quot; of &quot;+g.$GalleryAllObjects.length;
	return( &quot;Your &quot;+player.ship.displayName+&quot; has recorded &quot;+len+&quot; ship and space object types.&quot; );
}

this.$Gallery_SearchHeadTitle = function( all ) {
	var title = &quot;Gallery of &quot;;
	if( all ) title += &quot;all objects&quot;;
	else title += &quot;encounters&quot;;
	return( title );
}

this.$Gallery_SearchKey = function( text, all ) {
	var g = worldScripts[&quot;gallery&quot;];
	var k = g.$GalleryKeysForRole[ 0 ];
	var found = false;
	if( !text || text.length == 0 ) found = true; //no search, show the last item
	else if( k ) {
		if( !g.$GalleryShowAll ) { //search in name, not in dataKey
			var n = g.$GalleryEncNames; 
			if(g.$GalleryLog) log(&quot;Gallery&quot;,n);
			for( var i = 0; i &lt; n.length; i++ ) {
				if ( n[i] &amp;&amp; n[i].toLowerCase().indexOf(text) == 0 ) { //find text from begin
					found = true;
					g.$GalleryKeyi[ 0 ] = i;//set to the found item
					i = n.length; //exit
				}
			}
			if( !found ) {
				for( var i = 0; i &lt; n.length; i++ ) {
					if ( n[i] &amp;&amp; n[i].toLowerCase().indexOf(text) != -1 ) { //find text within
						found = true;
						g.$GalleryKeyi[ 0 ] = i;//set to the found item
						i = n.length; //exit
					}
				}
			}
		}
		if( !found ) for( var i = 0; i &lt; k.length; i++ ) { //search in dataKey
			if ( k[i] &amp;&amp; k[i].toLowerCase().indexOf(text) == 0 ) { //find text from begin
				found = true;
				g.$GalleryKeyi[ 0 ] = i;//set to the found item
				i = k.length; //exit
			}
		}
		if( !found ) {
			for( var i = 0; i &lt; k.length; i++ ) {
				if ( k[i] &amp;&amp; k[i].toLowerCase().indexOf(text) != -1 ) { //find text within
					found = true;
					g.$GalleryKeyi[ 0 ] = i;//set to the found item
					i = k.length; //exit
				}
			}
		}
		if( !found &amp;&amp; text.length &gt; 1 ) {
			var text1 = text.charAt(0); //find starting letter only
			for( var i = 0; i &lt; k.length; i++ ) {
				if ( k[i] &amp;&amp; k[i].charAt(0).toLowerCase() == text1 ) {
					found = true;
					g.$GalleryKeyi[ 0 ] = i;//set to the found item
					i = k.length; //exit
				}
			}
		}
	}
	if( found ) g.$Gallery_Interface2( all ); //show it
	else g.$Gallery_Search( all, false );//try again
}

/*
this.$Gallery_Timed = function() { //extra ship.remove can not help avoid &quot;Universe is full&quot; due to the remaining entities
	for( var i = 0; i &lt; g.$GalleryTrash.length; i++ ) {
		g.$GalleryTrash[i].remove(true);
	}
	if( g.$GalleryLog) log(&quot;Gallery&quot;, &quot;Removed &quot;+g.$GalleryTrash.length+&quot; tried ship.&quot;);
	delete g.$GalleryTrash;
}
*/	

this.$Gallery_Timed = function() { //cause extreme memory usage and crash when out of allocation space
	var g = worldScripts[&quot;gallery&quot;];
	var maxk = 10; //how many iteration max., very slow and cause &quot;Universe is full&quot; if many OXP ships
	var num = 64; //how many ships created at one time
	var i = g.$GalleryTRole;//actual role in this timed function
	var k = g.$GalleryTRI;//actual TRole Iteration
	var prevlen = 0;

	if( g.$GalleryTimer ) { //remove old timer
		g.$GalleryTimer.stop();
		delete g.$GalleryTimer;
	}

	if( g.$GalleryKeysForRole[ i ] ) prevlen = g.$GalleryKeysForRole[ i ].length;
	var ships = system.addShips(g.$GalleryRoles[i], num, [0,0,0], 1000000);
	if(ships) {
		for( var j = 0; j &lt; ships.length; j++ ) { //created ships
			if( ships[j] ) {
				var key = ships[j].dataKey;
				if( !g.$GalleryKeysForRole[ i ] )
					g.$GalleryKeysForRole[ i ] = [key];
				else if( g.$GalleryKeysForRole[ i ].indexOf(key) == -1 )
					g.$GalleryKeysForRole[ i ].push(key);//add new key
				ships[j].remove(true);//can not remove everything, can reach Universe limit
//				if(g.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. main role: &quot; + g.$GalleryRoles[i]
//					+&quot; &quot;+k+&quot;. try, &quot;+(j+1)+&quot;. key: &quot;+key
//					+&quot; GalleryKeysForRole[&quot;+i+&quot;]:&quot;+g.$GalleryKeysForRole[ i ]);
			}
		}
		if(g.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. main role: &quot; + g.$GalleryRoles[i]
			+&quot; &quot;+k+&quot;. try: &quot;+g.$GalleryKeysForRole[ i ].length+&quot; object.&quot; );
		if(prevlen == g.$GalleryKeysForRole[ i ].length) maxk = 0;//exit from iteration cycle
	}
	var end = false;
	g.$GalleryTRI++;
	if( g.$GalleryTRI &gt; maxk ) {
	
		if(g.$GalleryKeysForRole[ i ]) {
			g.$GalleryKeysForRole[ i ].sort();
			if(g.$GalleryLog) log(&quot;Gallery&quot;, i + &quot;. role after &quot;+k+&quot; try: &quot; + g.$GalleryRoles[i]
				+ &quot; (&quot;+g.$GalleryKeysForRole[ i ].length+&quot;): &quot; + g.$GalleryKeysForRole[ i ] );
			g.$GalleryKeysForRole[ 0 ] = g.$GalleryKeysForRole[ 0 ].concat(g.$GalleryKeysForRole[ i ]);
		}

		g.$GalleryTRI = 1;
		g.$GalleryTRole++;
		if( g.$GalleryTRole &gt;= g.$GalleryRoles.length ) {
			
			g.$GalleryKeysForRole[ 0 ].sort();
			for( var i = 1; i &lt; g.$GalleryKeysForRole[ 0 ].length; i++ ) { //remove duplicated keys
				if(g.$GalleryKeysForRole[0][i] == g.$GalleryKeysForRole[0][i-1]) {
					g.$GalleryKeysForRole[0].splice(i,1); //remove this item
					i--;
				}
			}
			if(g.$GalleryLog) log(&quot;Gallery&quot;, &quot;All dataKeys (&quot;+g.$GalleryKeysForRole[ 0 ].length
				+&quot;): &quot; + g.$GalleryKeysForRole[ 0 ] );
			end = true; //dataKey search finished, no more timer start
		}
	}

	if( !end ) g.$GalleryTimer = new Timer(g, g.$Gallery_Timed, 2.3); //will make the next step
}


this.$GalleryValidateTarget = function(target) {

	if( target.dataKey.indexOf(&quot;stealth&quot;) &gt; -1 || target.primaryRole.indexOf(&quot;stealth&quot;) &gt; -1
		|| target.scriptInfo &amp;&amp; target.scriptInfo.ccl_missionShip //skip mission ships
		|| target.name == &quot;Constrictor&quot;
		|| target.dataKey == &quot;vector_arn&quot; //mission ship in Vector OXP
		|| target.primaryRole.indexOf(&quot;rescue_blackbox&quot;) &gt; -1 ) //mission ships in Rescue Stations OXP
		return false;
	
	if( !target.roles ) return true; //bugfix for entities without any role
		
	var lib = worldScripts[&quot;tech_ref_lib&quot;];
	if( lib ) return( lib.$validateTarget(target) ); //call the original function if available
	
	//following lines comes from Technical Reference Library OXP by spara
	//check scanclasses
	if (this.$GalleryClassifiedScanClasses.indexOf(target.scanClass) != -1) return false;
	//check roles
	var targetRoles = target.roles;
	var i;
	for (i = 0; i &lt; targetRoles.length; i++) {
		if (this.$GalleryClassifiedRoles.indexOf(targetRoles[i]) != -1) {
			return false;
		}
	}
	//check for script_info key
	if (target.scriptInfo &amp;&amp; target.scriptInfo.classifiedShip) return false;
	return true;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
