<html>
    <head>
        <title>Expansion Curse of the Black Sunspot</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Curse of the Black Sunspot</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">1 Equipment</a></li>
          <li><a href="#ships">12 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">10 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>An informal mission for experienced players set in Chart 3</td>
                    <td>An informal mission for experienced players set in Chart 3</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.cim.cotbs</td>
                    <td>oolite.oxp.cim.cotbs</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Curse of the Black Sunspot</td>
                    <td>Curse of the Black Sunspot</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Missions</td>
                    <td>Missions</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>cim</td>
                    <td>cim</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.0.2</td>
                    <td>1.0.2</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Curse_of_the_Black_Sunspot">http://wiki.alioth.net/index.php/Curse_of_the_Black_Sunspot</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://cim.sotl.org.uk/games/files/oolite/Curse_of_the_Black_Sunspot_1.0.2.oxz">https://cim.sotl.org.uk/games/files/oolite/Curse_of_the_Black_Sunspot_1.0.2.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-SA 3.0</td>
                    <td>CC-BY-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1397678091</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Curse%20of%20the%20Black%20Sunspot'>http://wiki.alioth.net/index.php/Curse%20of%20the%20Black%20Sunspot</a></p>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_COTBS_RESTORE.html">Restore to factory settings</a></td>
                    <td>yes</td>
                    <td align="right">10000</td>
                    <td align="center">9+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            <table>
                <tr>
                    <th>Name</th>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-escort1.html">cotbs-escort1</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-escort2.html">cotbs-escort2</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-escort3.html">cotbs-escort3</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-escort4.html">cotbs-escort4</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-ghost-base.html">Vengeance</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-guard.html">cotbs-guard</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-leader.html">cotbs-leader</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-loot.html">cotbs-loot</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-misjumper.html">cotbs-misjumper</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-rock.html">Asteroid</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-transmitter.html">Transmitter</a></td>
                </tr>
                <tr>
                    <td><a href="../ships/cotbs-turret.html">cotbs-turret</a></td>
                </tr>
            </table>
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-conditions.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS condition script&quot;;

/** How this works...
 * What we want is for the pirate leader to have the four unique
 * escorts defined in shipdata - specifically, one of each.
 * So, each escort has a common escort role, which the leader uses
 * Then, we keep a counter in the worldscript.
 * This is used to ensure that only cotbs-escort1 can be spawned to start with
 * Once it is spawned, its ship script event (and we have to use
 * spawnedAsEscort, as shipSpawned occurs too late) increments the
 * counter, so the next escort spawned must be cotbs-escort2, and so
 * on.
 */

this.allowSpawnShip = function(shipkey) {
		var rv = false;
		var counter = 1 + worldScripts[&quot;COTBS&quot;]._escortSetupCounter;

		if (shipkey == &quot;cotbs-escort&quot;+counter) {
				rv = true;
		}
		return rv;
}

/* Cleaner than messing around with TL 99 */

this.allowAwardEquipment = function(eqkey) {
		// eqkey is always EQ_COTBS_RESTORE
		if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
				if (missionVariables.COTBS_substage != &quot;UNKNOWN&quot; &amp;&amp; missionVariables.COTBS_substage != &quot;THATSODD&quot; &amp;&amp; missionVariables.COTBS_substage != &quot;NEEDTL9&quot; &amp;&amp; missionVariables.COTBS_delay &lt; 3) {
						return true;
				}
		}
		return false;
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-error.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS: display error&quot;;

this.effectSpawned = function() {
		this.$fcb = addFrameCallback(this._update.bind(this));
		this.visualEffect.shaderFloat1 = Math.random();
		this.visualEffect.shaderFloat2 = -1;
		player.consoleMessage(&quot;Camera feed malfunction. Attempting recalibration&quot;,10);
		this.visualEffect.scale(1000);
}

this.effectRemoved = function() {
		removeFrameCallback(this.$fcb);
}

this._update = function(delta) {
		this.visualEffect.shaderFloat1 += delta;
		this.visualEffect.shaderFloat2 += delta/7;
		this.visualEffect.position = player.ship.position;
		if (this.visualEffect.shaderFloat2 &gt; 1) {
				this.visualEffect.remove();
		}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-escort.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS pirate escort script&quot;;

this.shipSpawned = function() {
		// only get a name if ships in general get names
		if (worldScripts[&quot;randomshipnames&quot;]) {
				this.ship.displayName += &quot;: &quot; + this.ship.scriptInfo.cotbsname;
		}
		// correct for ship models with weapon on subent
		for (var i=0; i&lt;this.ship.subEntities.length;i++) {
				if (this.ship.subEntities[i].forwardWeapon != EquipmentInfo.infoForKey(&quot;EQ_WEAPON_NONE&quot;)) {
						this.ship.subEntities[i].forwardWeapon = this.ship.forwardWeapon;
						this.ship.forwardWeapon = &quot;EQ_WEAPON_NONE&quot;;
				}
		}

		this.ship.bounty = 64+Math.floor(Math.random()*64);
}

this.spawnedAsEscort = function(ship) {
		worldScripts[&quot;COTBS&quot;]._escortSetupCounter++;
}

this.shipDied = function() {
		if (worldScripts[&quot;COTBS&quot;]._adversary) {
				worldScripts[&quot;COTBS&quot;]._adversary.script._reactToEscortLoss();
		}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-ghost.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS ghost ships&quot;;

this._fcb = null;
this._ve = null;

this.shipSpawned = function() {
		this._ve = system.addVisualEffect(&quot;cotbs-ghost-&quot;+(1+Math.floor(Math.random()*6)),this.ship.position);
		this._ve.orientation = this.ship.orientation;
		this._fcb = addFrameCallback(this._veTrack.bind(this));
}

this._veTrack = function(delta) {
		if (this.ship) {
				this._ve.position = this.ship.position; 
				this._ve.orientation = this.ship.orientation;
		} else {
				this._ve.remove();
		}
}

this.shipDied = function() {
		if (this._fcb) {
				removeFrameCallback(this._fcb);
		}
		if (this._ve) {
				this._ve.remove();
		}
		if (player.alertLevel == 3) { // red alert
				// replace it 
				system.addShips(&quot;cotbs-ghost&quot;,1,player.ship.position,10E3);
		}
}

this._setTarget = function() {
		this.ship.target = player.ship;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-guard.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS guard ships&quot;;

this.shipSpawned = function() {

		if (worldScripts[&quot;randomshipnames&quot;]) {
				ship.displayName += &quot;: &quot; + worldScripts[&quot;randomshipnames&quot;].$randomPirateName(ship);
		}

		for (var i=0; i&lt;this.ship.subEntities.length;i++) {
				if (this.ship.subEntities[i].forwardWeapon != EquipmentInfo.infoForKey(&quot;EQ_WEAPON_NONE&quot;)) {
						this.ship.subEntities[i].forwardWeapon = this.ship.forwardWeapon;
						this.ship.forwardWeapon = &quot;EQ_WEAPON_NONE&quot;;
				}
		}
		
		this.ship.bounty |= Math.floor(Math.random()*64);
		this.ship.primaryRole = &quot;pirate&quot;;
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-leader.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS pirate leader ship script&quot;;

this._lostEscorts = 0;

this.shipSpawned = function() {
		// only get a name if ships in general get names
		if (worldScripts[&quot;randomshipnames&quot;]) {
				this.ship.displayName += &quot;: &quot; + this.ship.scriptInfo.cotbsname;
		}
		// correct for ship models with weapon on subent
		for (var i=0; i&lt;this.ship.subEntities.length;i++) {
				if (this.ship.subEntities[i].forwardWeapon != EquipmentInfo.infoForKey(&quot;EQ_WEAPON_NONE&quot;)) {
						this.ship.subEntities[i].forwardWeapon = this.ship.forwardWeapon;
						this.ship.forwardWeapon = &quot;EQ_WEAPON_NONE&quot;;
				}
		}
		// set escort formation if supported
		if (worldScripts[&quot;Escort Formations Randomiser&quot;]) {
				worldScripts[&quot;Escort Formations Randomiser&quot;].$setupEscortFormation(this.ship,&quot;arrowhead&quot;);
		}

		this.ship.bounty = 255;

		worldScripts[&quot;COTBS&quot;]._adversary = this.ship;
}

this.shipDied = function(whom,why) {
		worldScripts[&quot;COTBS&quot;]._adversary = null;
		this.ship.commsMessage(&quot;The curse of the black sunspot be upon you!&quot;);
		if (whom == player.ship) {
				missionVariables.COTBS_stage = &quot;DESTROYED&quot;;
				missionVariables.COTBS_delay = 1;
				missionVariables.COTBS_substage = &quot;UNKNOWN&quot;;

		} else {
				// they should be tough enough to flatten any NPC hunters or
				// traders in seconds, but...
				missionVariables.COTBS_stage = &quot;COMPLETE&quot;; // someone else&#39;s problem
				worldScripts.COTBS._cleanup();
		}
		worldScripts.COTBS._snoop(&quot;cotbs-story-destroyed&quot;);
		this.ship.spawn(&quot;cotbs_loot&quot;,20+Math.floor(Math.random()*10));
}

this._reactToEscortLoss = function() {
		this._lostEscorts++;
		if (this._lostEscorts == 2) {
				this.ship.commsMessage(expandDescription(&quot;[cotbs-comm-alert2]&quot;));
		} else if (this._lostEscorts == 3) {
				this.ship.commsMessage(expandDescription(&quot;[cotbs-comm-alert3]&quot;));
		} else if (this._lostEscorts == 4) {
				this.ship.commsMessage(expandDescription(&quot;[cotbs-comm-alert4]&quot;));
		}
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-loot.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS loot ship script&quot;;

this.shipSpawned = function() {
		var amount = 20+Math.floor(Math.random()*40);
		var type = &quot;Gold&quot;;
		if (Math.random() &lt; 0.5) {
				type = &quot;Gem-stones&quot;;
		}
		if (Math.random() &lt; 0.25) {
				type = &quot;Platinum&quot;;
		}
		this.ship.setCargo(type,amount);
		this.ship.velocity = Vector3D.randomDirection().multiply(30);
}</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-main.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS&quot;;
this.description = &quot;Curse of the Black Sunspot&quot;;

this._escortSetupCounter = 0;

this.startUp = function() {
		if (!missionVariables.COTBS_stage) {
				missionVariables.COTBS_stage = &quot;FUTURE&quot;;
		}
		if (missionVariables.COTBS_stage == &quot;COMPLETE&quot;) {
				return;
		}
		this._init();
		this._systemPopulator();
}

// if the mission is complete, for efficiency this is never called
this._init = function() {

		this._soundSource = new SoundSource;
		this._soundSource.loop = false;

		this._curseTimer = null;
		this._curseSubTimer = null;
		this._curseWSTimer = null;
		this._curseFC = null;
		this._teususdiOutlands = [1,14,21,72,103,222];

		if (worldScripts[&quot;System Features: Sunspots&quot;]) {
				// no random sunspots in this system
				if (worldScripts[&quot;System Features: Sunspots&quot;].startUp) {
						worldScripts[&quot;System Features: Sunspots&quot;].startUp();
				}
				worldScripts[&quot;System Features: Sunspots&quot;].$overrides[2].push(72);
		}

		if (worldScripts.CargoTypeExtension) {
				worldScripts.CargoTypeExtension.registerPriceChange(this.name);

				this.priceChange = function(good, context) {
						if (missionVariables.COTBS_stage != &quot;PRESENT&quot;) { return 1; }
						if (this._teususdiOutlands.indexOf(system.ID) &lt; 0) { return 1; }
						var gtype = worldScripts.CargoTypeExtension.cargoDefinition(good,&quot;genericType&quot;);
						if (gtype == &quot;computers&quot; || gtype == &quot;machinery&quot; || gtype == &quot;firearms&quot; || gtype == &quot;luxuries&quot;) {
								return 1.2;
						}
						return 1;
				}

				this.priceGossip = function() {
						if (missionVariables.COTBS_stage != &quot;PRESENT&quot;) { return false; }
						if (system.ID % 3 != 0) { return false; }
						return &quot;* Piracy in the Teususdi Outland is increasing the price of industrial goods.&quot;;
				}
		}

		this.shipWillEnterWitchspace = function() {
				this._escortSetupCounter = 0;
				if (this._curseTimer) {
						this._curseTimer.stop();
						delete this._curseTimer;
				}
				if (this._curseWSTimer) {
						this._curseWSTimer.stop();
						delete this._curseWSTimer;
				}
		}

		this.shipWillExitWitchspace = function() {
				if (missionVariables.COTBS_stage == &quot;FUTURE&quot; &amp;&amp; galaxyNumber == 2 &amp;&amp; player.score &gt;= 512 &amp;&amp; Math.random() &lt; 0.2) {
						missionVariables.COTBS_stage = &quot;PRESENT&quot;;
						this._snoop(&quot;cotbs-story-begin&quot;);
				}	else if (missionVariables.COTBS_substage == &quot;PERSIST&quot;)	{
						missionVariables.COTBS_substage = &quot;SEARCHED&quot;;
				}

				this._systemPopulator();
		}

		this._systemPopulator = function() {
				if (galaxyNumber == 2 &amp;&amp; missionVariables.COTBS_stage == &quot;PRESENT&quot;) { 
						if (this._teususdiOutlands.indexOf(system.ID) &gt;= 0) { // outlands
								var pirates = Math.floor(system.countShipsWithPrimaryRole(&quot;pirate&quot;) * 0.25+(Math.random()*0.25));
//								log(&quot;cotbs.populator&quot;,&quot;Adding &quot;+pirates+&quot; extra pirates&quot;);
								while (pirates &gt; 0) {
										var gsize = 2+Math.floor(Math.random()*3);
										pirates -= gsize;
										system.addGroup(&quot;pirate&quot;,gsize,system.mainPlanet.position.multiply(0.1+(0.8*Math.random())));
//										log(&quot;cotbs.populator&quot;,&quot;Adding group of &quot;+gsize);
								}
								var pirateships = system.shipsWithPrimaryRole(&quot;pirate&quot;);
//								log(&quot;cotbs.populator&quot;,&quot;Now has &quot;+pirateships.length+&quot; pirates.&quot;);
								for (var i=0;i&lt;pirateships.length;i++) {
//										log(&quot;cotbs.populator&quot;,&quot;...upgrading &quot;+i);
										var pship = pirateships[i];
										pship.accuracy += Math.random()*7;
										pship.bounty |= Math.floor(Math.random()*64);
										if (Math.random() &lt; 0.8) {
												pship.aftWeapon = pship.forwardWeapon;
												if (Math.random() &lt; 0.5) {
														if (pship.forwardWeapon == EquipmentInfo.infoForKey(&quot;EQ_WEAPON_PULSE_LASER&quot;)) {
																pship.forwardWeapon = &quot;EQ_WEAPON_BEAM_LASER&quot;;
														}
												}
												for (var j=0; j&lt;pship.subEntities.length;j++) {
														if (pship.subEntities[j].forwardWeapon != EquipmentInfo.infoForKey(&quot;EQ_WEAPON_NONE&quot;)) {
																pship.aftWeapon = pship.subEntities[j].forwardWeapon;
														} 
														if (Math.random() &lt; 0.5) {
																if (pship.subEntities[j].forwardWeapon == EquipmentInfo.infoForKey(&quot;EQ_WEAPON_PULSE_LASER&quot;)) {
																		pship.subEntities[j].forwardWeapon = &quot;EQ_WEAPON_BEAM_LASER&quot;;
																}
														}
												}
										}
								}
						}
						if (system.ID == 72) { // Enanen
								system.addShips(&quot;cotbs_leader&quot;,1,system.mainPlanet.position.multiply(0.5),10E3); // half-way along spacelane
						}
				}
				if (galaxyNumber == 2 &amp;&amp; system.ID == 72 &amp;&amp; missionVariables.COTBS_stage != &quot;FUTURE&quot;) {
						var planar = system.sun.position.direction()
						var normal = planar.cross(system.mainPlanet.position.direction());
						var spotpos = system.sun.position.subtract(planar.multiply(0.5).add(normal.multiply(0.87)).direction().multiply(system.sun.radius*0.999));
						var sunspot = system.addVisualEffect(&quot;cotbs-sunspot&quot;,spotpos);

						var facing = sunspot.position.subtract(system.sun.position).direction().rotationTo(new Vector3D([0,0,1]));
						sunspot.orientation = facing;
						// add asteroid
						if (missionVariables.COTBS_stage == &quot;PRESENT&quot; || (missionVariables.COTBS_stage == &quot;DESTROYED&quot; &amp;&amp; missionVariables.COTBS_substage != &quot;SCOOPED&quot; &amp;&amp; missionVariables.COTBS_substage != &quot;SEARCHED&quot;)) {
								var apos = spotpos.subtract(system.sun.position).direction().multiply(system.sun.radius*10).add(system.sun.position);
								system.addShips(&quot;cotbs-rock&quot;,1,apos,1);
								var guards = system.addGroup(&quot;cotbs-guard&quot;,4,apos,10E3);
						}
				} else if (missionVariables.COTBS_stage == &quot;DESTROYED&quot; &amp;&amp; missionVariables.COTBS_delay == 0) {
						var spotpos = system.sun.position.add(Vector3D.randomDirection(system.sun.radius*0.999));
						var sunspot = system.addVisualEffect(&quot;cotbs-sunspot2&quot;,spotpos);

						var facing = sunspot.position.subtract(system.sun.position).direction().rotationTo(new Vector3D([0,0,1]));
						sunspot.orientation = facing;

				}
		}

		this.dayChanged = function(day) {
				if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
						if (missionVariables.COTBS_delay &amp;&amp; missionVariables.COTBS_delay &gt; 0) {
								missionVariables.COTBS_delay--;
						}
				}
		}

		this.shipLaunchedFromStation = this.shipExitedWitchspace = function() {
				if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
						if (this._curseTimer) {
								this._curseTimer.stop();
								delete this._curseTimer;
						}
						if (missionVariables.COTBS_delay &lt;= 0) {
								var delay = 80+(Math.random()*40);
								if (player.ship.equipmentStatus(&quot;EQ_DCN&quot;) == &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_REPAIRBOTS_CONTROLLER&quot;) == &quot;EQUIPMENT_OK&quot;) {
										delay /= 3;
								}
								this._curseTimer = new Timer(this,this._applyCurseDamage,30+(Math.random()*10),delay);
								if (missionVariables.COTBS_sneaky) {
										delete missionVariables.COTBS_sneaky;
										this._taunt(&quot;[cotbs-sneaky-taunt]&quot;);
								}
						} 
				}
		}

		this._knowCurse = function() {
				if (missionVariables.COTBS_substage == &quot;UNKNOWN&quot; &amp;&amp; Math.random() &lt; 0.25) {
						missionVariables.COTBS_substage = &quot;THATSODD&quot;;
				}
		}

		this._forceKnowCurse = function() {
				missionVariables.COTBS_substage = &quot;THATSODD&quot;;
		}


		this._applyCurseDamage = function() {
				if (player.ship.dockedStation || missionVariables.COTBS_delay &gt; 0) {
						return;
				}
				this._forceApplyCurseDamage();
		}

		this._forceApplyCurseDamage = function() {
				var choice = Math.random();
				if (choice &lt; 0.33) { // 1/3 system damage
						do {
								var damaged = player.ship.takeInternalDamage();
						} while (!damaged);
						this._soundSource.sound = &quot;[player-direct-hit]&quot;;
						this._soundSource.play();
						this._knowCurse();
				} else if (choice &lt; 0.5) { // 1/6 display trouble
						this._soundSource.sound = &quot;[@warning]&quot;;
						this._soundSource.play();
						system.addVisualEffect(&quot;cotbs-error&quot;,player.ship.position);
						this._knowCurse();
				} else if (choice &lt; 0.66) { // 1/6 HUD trouble
						this._soundSource.sound = &quot;[@warning]&quot;;
						this._soundSource.play();
						player.ship.hudHidden = true;
						this._curseSubTimer = new Timer(this,this._restoreHud,Math.random()*15);
						this._knowCurse();
				} else if (choice &lt; 0.70 &amp;&amp; player.ship.fireMissile()) { // ~1/20 missile fire, if locked on
						this._knowCurse();
				} else if (choice &lt; 0.75) { // 1/20 shield drain (~1/10 if no missile lock)
						this._soundSource.sound = &quot;[@warning]&quot;;
						this._soundSource.play();
						player.consoleMessage(&quot;Warning: shield charge imbalance! Emergency restart of shield system in progress.&quot;,5);
						if (this._curseFC) {
								removeFrameCallback(this._curseFC);
								delete this._curseFC;
						}
						this._curseFC = addFrameCallback(this._shieldImbalance);
						this._knowCurse();

				} else if (choice &lt; 0.9) { // 3/20 taunt
						this._soundSource.sound = &quot;[@beep]&quot;;
						this._soundSource.play();
						this._taunt(&quot;[cotbs-taunt]&quot;);
				} else if (player.ship.fuel &gt; 0) { // 1/10 fuel leak
						this._soundSource.sound = &quot;[fuel-leak]&quot;;
						this._soundSource.play();
						player.consoleMessage(&quot;Warning: fuel leak!&quot;);
						player.ship.fuelLeakRate = 1;
						this._knowCurse();

				}
		}

		this._taunt = function(msg) {
				if (worldScripts[&quot;randomshipnames&quot;]) {
						player.commsMessage(expandDescription(&quot;Python: Adversarial:\n  &quot;+msg));
				} else {
						player.commsMessage(expandDescription(&quot;Python:\n  &quot;+msg));
				}
		}

		this._restoreHud = function() {
				player.ship.hudHidden = false;
		}

		this._shieldImbalance = function(delta) {
				var rate = delta*32;
				player.ship.aftShield -= rate;
				player.ship.forwardShield -= rate;
				if ((player.ship.forwardShield &lt; 1 &amp;&amp; player.ship.aftShield &lt; 1) || player.ship.dockedStation) {
						// shields drained
						removeFrameCallback(worldScripts.COTBS._curseFC);
						delete worldScripts.COTBS._curseFC;
				}
		}

		this.playerStartedJumpCountdown = function(type, seconds)	{
				if (missionVariables.COTBS_stage != &quot;DESTROYED&quot;) { return; }
				if (type == &quot;galactic&quot;) {
						this._knowCurse();
						player.ship.setEquipmentStatus(&quot;EQ_GAL_DRIVE&quot;,&quot;EQUIPMENT_DAMAGED&quot;);
						this._soundSource.sound = &quot;[player-direct-hit]&quot;;
						this._soundSource.play();
						player.consoleMessage(&quot;Warning! Galactic hyperdrive miscalibration detected. Disabling device until it can be serviced.&quot;,8);
				} else if (system.ID != 72 &amp;&amp; missionVariables.COTBS_delay &lt;= 0) {
						if (this._curseWSTimer) {
								this._curseWSTimer.stop();
								delete this._curseWSTimer;
						}
						var curdist = System.infoForSystem(galaxyNumber,72).distanceToSystem(System.infoForSystem(galaxyNumber,system.ID));
						var newdist = System.infoForSystem(galaxyNumber,72).distanceToSystem(System.infoForSystem(galaxyNumber,player.ship.targetSystem));
						if (newdist &gt; curdist) {
								// trying to get away, are you?
								this._curseWSTimer = new Timer(this,this._interruptJump,seconds-0.1);
								player.consoleMessage(&quot;The power of the black sunspot compels you, Commander...&quot;);
						}
				}
		}

		this.playerCancelledJumpCountdown = this.playerJumpFailed = function() {
				if (this._curseWSTimer) {
						this._curseWSTimer.stop();
						delete this._curseWSTimer;
				}
		}

		this._interruptJump = function() {
				var route = System.infoForSystem(galaxyNumber,system.ID).routeToSystem(System.infoForSystem(galaxyNumber,72));
				if (route &amp;&amp; route.route) {
						var newdest = route.route[1];
						var cpf = player.ship.fuel;
						cpf -= System.infoForSystem(galaxyNumber,system.ID).distanceToSystem(System.infoForSystem(galaxyNumber,newdest));
						if (cpf &gt;= 0) {
								var jumper = system.addShips(&quot;cotbs_misjumper&quot;,1,player.ship.position.add(player.ship.vectorForward.multiply(player.ship.collisionRadius+100)),0)[0];
								if (jumper.exitSystem(newdest)) {
										this._soundSource.sound = &quot;[witchdrive-malfunction]&quot;;
										this._soundSource.play();
										this._forceKnowCurse();
										player.ship.fuel = cpf;
										player.ship.position = jumper.position;
										player.ship.velocity = [0,0,0];
								}
								jumper.remove(true);
						}
				}						

		}

		this.alertConditionChanged = function(newc,oldc) {
				if (missionVariables.COTBS_stage != &quot;DESTROYED&quot; || missionVariables.COTBS_delay &gt; 0) { return; }
				if (newc != 3) {
						var objs = system.shipsWithPrimaryRole(&quot;cotbs-ghost&quot;);
						for (var i=0; i&lt;objs.length; i++) {
								objs[i].remove();
						}
				} else {
						this._knowCurse();
						system.addShips(&quot;cotbs-ghost&quot;,2+Math.floor(Math.random()*3),player.ship.position,10E3);
				}
		}

		this._snoop = function(key) {
				if (!worldScripts.snoopers) {
						return;
				}
				var obj = {
						ID: this.name,
						Message: expandDescription(&quot;[&quot;+key+&quot;]&quot;),
						Agency: 1,
						Model: &quot;[python-blackdog]&quot;,
						Priority: 3
				};

				worldScripts.snoopers.insertNews(obj);
		}

		this.playerBoughtNewShip = this.shipLaunchedEscapePod = function() {
				if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
						missionVariables.COTBS_delay += 3;
						missionVariables.COTBS_sneaky = 1;
				}
		}

		this.missionScreenOpportunity = function() {
				if (missionVariables.COTBS_stage != &quot;DESTROYED&quot;) { return; }
				if (player.ship.dockedStation != system.mainStation) { return; }
				if (system.info.techlevel &lt; 8) { // region except Teususdi
						if (missionVariables.COTBS_substage == &quot;THATSODD&quot;) {
								missionVariables.COTBS_substage = &quot;NEEDTL9&quot;;
								this._shipyardAnnouncement1();
						}
				} else if (system.info.techlevel &lt; 12) { // not Cedile or Bixein
						if (missionVariables.COTBS_substage == &quot;THATSODD&quot; || missionVariables.COTBS_substage == &quot;NEEDTL9&quot;) {
								missionVariables.COTBS_substage = &quot;NEEDTL13&quot;;
								this._shipyardAnnouncement2();
						}
				} else { // Cedile or Bixein, probably
						if (missionVariables.COTBS_substage == &quot;THATSODD&quot; || missionVariables.COTBS_substage == &quot;NEEDTL9&quot; || missionVariables.COTBS_substage == &quot;NEEDTL13&quot; || missionVariables.COTBS_substage == &quot;SEARCHED&quot;) {
								missionVariables.COTBS_cost = Math.floor(player.ship.price / 5);
								this._shipyardAnnouncement3();
						} else if (missionVariables.COTBS_substage == &quot;SCOOPED&quot;) {
								this._shipyardAnnouncement4();
						}
				}
		}

		this._shipyardAnnouncementTemplate = function() {
				return {
						title: &quot;%H shipyard&quot;,
						model: &quot;[&quot;+player.ship.shipKey+&quot;]&quot;
				}
		}
		
		this._shipyardAnnouncement1 = function() {
				var param = this._shipyardAnnouncementTemplate;
				param.messageKey = &quot;cotbs-sya1&quot;;
				mission.runScreen(param);
		}

		this._shipyardAnnouncement2 = function() {
				var param = this._shipyardAnnouncementTemplate;
				param.messageKey = &quot;cotbs-sya2&quot;;
				mission.runScreen(param);
		}

		this._shipyardAnnouncement3 = function() {
				var param = this._shipyardAnnouncementTemplate;
				param.messageKey = &quot;cotbs-sya3&quot;;
				param.choicesKey = &quot;cotbs-sya3-choices&quot;;
				mission.runScreen(param, this._shipyardAnnouncement3a);
		}

		this._shipyardAnnouncement3a = function(choice) {
				if (choice == &quot;01_TRANS&quot;) {
						if (missionVariables.COTBS_substage == &quot;SEARCHED&quot;) {
								missionVariables.COTBS_substage = &quot;PERSIST&quot;;
						} else {
								missionVariables.COTBS_substage = &quot;SEARCHING&quot;;
								mission.setInstructionsKey(&quot;cotbs-sya3-mission&quot;);
								mission.markSystem({system:72,name:this.name,markerColor:&quot;cyanColor&quot;},
																	 {system:22,name:this.name,markerColor:&quot;cyanColor&quot;,markerShape:&quot;MARKER_DIAMOND&quot;},
																	 {system:79,name:this.name,markerColor:&quot;cyanColor&quot;,markerShape:&quot;MARKER_DIAMOND&quot;});
						}

				} else {
						missionVariables.COTBS_stage = &quot;COMPLETED&quot;;
						if (missionVariables.COTBS_cost &gt; player.credits)
						{
								missionVariables.COTBS_cost = player.credits;
								clock.addSeconds(86400*2);
								player.ship.removeEquipment(&quot;EQ_NAVAL_ENERGY_UNIT&quot;);
								player.ship.removeEquipment(&quot;EQ_NAVAL_SHIELD_BOOSTER&quot;);
								player.ship.removeEquipment(&quot;EQ_SHIELD_BOOSTER&quot;);
								var param = this._shipyardAnnouncementTemplate;
								param.message = &quot;\&quot;You didn&#39;t have enough money in your account to pay for all the new electronics, so we&#39;ve had to remove some of the more expensive kit entirely. We can put it back in when you&#39;ve got some cash again.\&quot;&quot;;
								mission.runScreen(param);
						}
						player.credits -= missionVariables.COTBS_cost;

						this._cleanup();
				}
		}

		this._shipyardAnnouncement4 = function() {
				var param = this._shipyardAnnouncementTemplate;
				param.messageKey = &quot;cotbs-sya4&quot;;
				mission.runScreen(param);
				player.credits += 2500;
				clock.addSeconds(3600*5);
				missionVariables.COTBS_stage = &quot;COMPLETED&quot;;
			
				this._cleanup();
		}


		this.playerBoughtEquipment = function(eq) {
				if (eq == &quot;EQ_COTBS_RESTORE&quot;) {
						missionVariables.COTBS_delay = 3;
						player.ship.removeEquipment(&quot;EQ_COTBS_RESTORE&quot;);
				}
		}

		this.guiScreenChanged = function(to,from) {
				if (missionVariables.COTBS_stage != &quot;DESTROYED&quot; || missionVariables.COTBS_delay &gt; 0 || !player.ship.dockedStation) {
						return;
				}
				var choice = Math.random();
				if (choice &lt; 0.03) {
						while (player.ship.cargoSpaceAvailable &gt; 0 &amp;&amp; player.ship.dockedStation.market.narcotics.quantity &gt; 0 &amp;&amp; player.credits &gt; player.ship.dockedStation.market.narcotics.price / 10) {
								player.credits -= player.ship.dockedStation.market.narcotics.price / 10;
								player.ship.manifest.narcotics++;
								player.ship.dockedStation.setMarketQuantity(&quot;narcotics&quot;,player.ship.dockedStation.market.narcotics.quantity-1);
						}
				} else if (choice &lt; 0.06) {
						player.ship.awardEquipment(&quot;EQ_MISSILE_REMOVAL&quot;);
						player.credits -= 20;
				}
		}

		this.shipWillDockWithStation = function(station) {
				if (station.isMainStation &amp;&amp; clock.days % 10 == system.ID % 10 &amp;&amp; galaxyNumber == 2)	{
//						log(this.name,&quot;Interface addition?&quot;);
						station.setInterface(this.name,{
								title: &quot;Piracy Warning&quot;,
								category: expandDescription(&quot;[interfaces-category-news]&quot;),
								summary: &quot;Galcop Level 3 Warning: A large and well-equipped pirate band is attacking shipping in the Teususdi Outland. Caution is advised. More details are available.&quot;,
								callback: function() {
										mission.runScreen({&quot;titleKey&quot;: &quot;cotbs-news1-title&quot;,
																			 &quot;messageKey&quot;: &quot;cotbs-news1-message&quot;,
																			 &quot;model&quot;: &quot;cotbs_leader&quot;,
																			 &quot;allowInterrupt&quot;: true,
																			 &quot;exitScreen&quot;: &quot;GUI_SCREEN_INTERFACES&quot;});
								}});
				}
				
		}


		this._cleanup = function() {
				mission.unmarkSystem({system:72,name:this.name},
														 {system:22,name:this.name},
														 {system:79,name:this.name});
				mission.setInstructions(null);

				delete missionVariables.COTBS_substage;
				delete missionVariables.COTBS_delay;
				delete missionVariables.COTBS_sneaky;
				delete missionVariables.COTBS_cost;
				if (this._curseTimer) {
						this._curseTimer.stop();
						delete this._curseTimer;
				}
		}


		// call this on startup to add the news, if needed
		this.shipWillDockWithStation(player.ship.dockedStation);
		

} // end this._init</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-rock.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS asteroid&quot;;

this._transmitter = true;
this._transmitterEntity = null;
this._selfDestruct = 0;

this._triangulation = 0;

this._doSelfDestruct = function() {
		// shutdown
		this._selfDestruct++;
		if (this._selfDestruct == 1) {
				player.consoleMessage(&quot;Warning! Energy surge detected!&quot;,10);
				this.ship.scannerDisplayColor1 = &quot;redColor&quot;;
				this.ship.scannerDisplayColor2 = &quot;yellowColor&quot;;
		}
		if (this._selfDestruct == 15) { // ~75 seconds
				this.ship.dealEnergyDamage(255,5000,0);
				this.ship.explode();
		}
}

this._transmitCurse = function() {
		if (!this._transmitter) {
				if (this.ship.subEntities.length == 0) {
						this._doSelfDestruct();
						this._doSelfDestruct();
						this._doSelfDestruct();
				}
				return;
		}
		if (!player.ship.position) {
				return;
		}
		var distance = this.ship.position.subtract(player.ship.position).magnitude();
		if (distance &lt; 51200 &amp;&amp; Math.random() &lt; 0.3 &amp;&amp; missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
				worldScripts[&quot;COTBS&quot;]._forceApplyCurseDamage();
		} else if (missionVariables.COTBS_delay == 0 &amp;&amp; missionVariables.COTBS_stage == &quot;DESTROYED&quot; &amp;&amp; Math.random() &lt; 0.02) {
				worldScripts[&quot;COTBS&quot;]._applyCurseDamage();
				this._triangulation++;
				if (this._triangulation &gt; 10) {
						this._transmitterEntity.beaconCode = &quot;Transmission Source&quot;;
				}
		}
		
		if (distance &gt; 30000) {
				this._transmitterEntity.position = this._transmitterPosition();
				this._transmitterEntity.orientation = this.ship.orientation;
		}

		if (this.ship.subEntities.length == 0) {
				this._doSelfDestruct();
		}

}

this._transmitterPosition = function() {
		return position = this.ship.position.add(
				this.ship.vectorForward.multiply(632)).add(
						this.ship.vectorUp.multiply(-240)).add(
								this.ship.vectorRight.multiply(240));
}

this.shipSpawned = function() {
		this._transmitterEntity = system.addShips(&quot;cotbs-transmitter&quot;,1,this._transmitterPosition(),0)[0];
		this._transmitterEntity.script._owner = this.ship;
		this._transmitterEntity.orientation = this.ship.orientation;
}

this.shipTakingDamage = function(amount,whom,type) {
		if (type == &quot;scrape damage&quot;) {
				this.ship.energy += amount;
				this.ship.velocity = new Vector3D([0,0,0]);
				if (this._transmitter) {
						this._transmitterEntity.position = this._transmitterPosition();
						this._transmitterEntity.orientation = this.ship.orientation;
				}
		}
}

this.shipDied = function() {
		if (this._transmitter) {
				this._transmitterEntity.explode();
		}
		var fragments = this.ship.spawn(&quot;asteroid&quot;,15);
		for (var i=0;i&lt;fragments.length;i++) {
				fragments[i].explode();
		}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/cotbs-transmitter.js</td>
                    <td><pre>this.author      = &quot;cim&quot;; 
this.copyright   = &quot;� 2011-2014 cim.&quot;; 
this.licence = &quot;CC-BY-SA 3.0&quot;;
this.version     = &quot;1.0.2&quot;; 
this.name = &quot;COTBS transmitter script&quot;;

this.shipTakingDamage = function(amount,whom,type) {
		if (type == &quot;scrape damage&quot;) {
				this.ship.energy += amount;
				this.ship.velocity = new Vector3D([0,0,0]);
		}
}

this.shipDied = function() {
		this._owner.script._transmitter = false;
		player.consoleMessage(&quot;Transmitter is no longer detectable&quot;,10);
		worldScripts.COTBS._taunt(&quot;[cotbs-oops-taunt]&quot;);
		if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
				missionVariables.COTBS_substage = &quot;SEARCHED&quot;;
		}
}

this.shipWasScooped = function(scooper) {
		this._owner.script._transmitter = false;
		if (missionVariables.COTBS_stage == &quot;DESTROYED&quot;) {
				if (scooper != player.ship) {
						missionVariables.COTBS_substage = &quot;SEARCHED&quot;;
				} else {
						missionVariables.COTBS_substage = &quot;SCOOPED&quot;;
				}
		}
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
