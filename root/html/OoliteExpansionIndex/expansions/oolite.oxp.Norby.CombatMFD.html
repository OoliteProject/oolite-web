<html>
    <head>
        <title>Expansion MFD - Combat MFD</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion MFD - Combat MFD</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">4 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Makes the Multi-Function Displays more useful by displaying some info from your ship and your target. Fill up 40 custom HUD dials with useful values for HUDs in HUDSelector.</td>
                    <td>Makes the Multi-Function Displays more useful by displaying some info from your ship and your target. Fill up 40 custom HUD dials with useful values for HUDs in HUDSelector.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Norby.CombatMFD</td>
                    <td>oolite.oxp.Norby.CombatMFD</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>MFD - Combat MFD</td>
                    <td>MFD - Combat MFD</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>HUDs</td>
                    <td>HUDs</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Norby, Zireael</td>
                    <td>Norby, Zireael</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.14</td>
                    <td>1.14</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Norby.HUDSelector:1.8</li>
                            <li>oolite.oxp.CommonSenseOTB.NumericHUD:3.26</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Norby.HUDSelector:1.8</li>
                            <li>oolite.oxp.CommonSenseOTB.NumericHUD:3.26</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/CombatMFD">http://wiki.alioth.net/index.php/CombatMFD</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/3/3c/CombatMFD-1.14.oxz">https://wiki.alioth.net/img_auth.php/3/3c/CombatMFD-1.14.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC BY-NC-SA 3</td>
                    <td>CC BY-NC-SA 3</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1610873279</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/MFD%20-%20Combat%20MFD'>http://wiki.alioth.net/index.php/MFD%20-%20Combat%20MFD</a></p>
        <h3>Readme.txt</h3>
        <pre>Combat MFD
----------
v1.14, by Norby

If you buy Combat MFD equipment then your Multi-Function Displays will display many info from your ship:
-energy and SEE indicator (see below) in the first line,
-forward and aft shields (including Shield Capacitors), Shield Cycler mode (Equal, Forward, Aft or Disabled),  then equipment and one-shot indicators (see below),
-legal status, fuel and speed (including Q-Charger, Torus To Sun multiplier and FTL speeds),
-the name of the lastly damaged equipment then the number of how many others are damaged,

then your target&#39;s:
-name,
-distance, mass and speed,
-shield radius, then Front/Aft orientation display and Damaged!/Weak!/Derelict flag.
-laser weapon type and range (after a shot),
-status: Clean/Offender/Fugitive, if derelict then Trap or Treasure/Empty/Mined/Usable (see Towbar OXP).
-fired missiles counter with &quot;Hard&quot; flag.

Telescope can display the newly detected target in the last line.

Use the &quot;;&quot; and &quot;:&quot; keys to select an MFD and enjoy the view. ;)

Compatible with Telescope OXP if lock far targets and ShieldEqualizer+Capacitors OXP: if shields are over 100% then either Shield Boosters are installed or shield capacitors are filled also.

The &quot;Damaged!&quot; flag shown when the target&#39;s exhaust plumes are blinking (below 40% energy) and &quot;Weak!&quot; when blinking strongly and drop sparks with CustomShields OXP (below 20%).
If your HUD has support for this (like NumericHUDv3.25) then you will see these words near your crosshairs also. The support mean the following lines in the legends section of your hud.plist:
 { equipment_required=&quot;EQ_DTADAM&quot;; x=30; y=40; y_origin=0; height=20; width=16; text=&quot;Damaged&quot;; alpha=0.5; },
 { equipment_required=&quot;EQ_DTAWEA&quot;; x=30; y=40; y_origin=0; height=20; width=16; text=&quot;Weak&quot;; alpha=0.5; },
 { equipment_required=&quot;EQ_DTADER&quot;; x=30; y=40; y_origin=0; height=20; width=16; text=&quot;Derelict&quot;; },


SEE indicator
-------------

The top right corner show letters about how many shields, armour and energy remaining.
Each letter represents 2 energy banks in strength and ordered by from outside to inside.
Small letters mean one side is up only.
-C: Shield Capacitors (+50%),
-M: Military shields (300%),
-B: Shield Boosters (200%),
-S: Shields (100%),
-A: Armours in HardShips OXP (front and aft only),
-H: IronHide Armour OXP.
-E: Energy (EE=4 banks).

&quot;SEE&quot; mean you have basic Shields (2 banks=128 points) and 2*2 Energy banks filled (4 banks=256 points), as a Cobra Mark III at start.

The total length is relative with your ship&#39;s defensive strength. The strongest Andromeda has CCCCCCCCMBSAAAAAAAAHHHEEEEEEEE. :)

A letter will be changed to &quot;-&quot; if drops below the half of the banks represented by this letter so &quot;-E&quot; mean less than 3 banks filled and more than one.

Underscore &quot;_&quot; mean equipment damage which prevent regeneration, you should fix it in a dock. Checked damages:
-Shield Capacitors (includung big ones in HardShips OXP),
-Military Shield Enhancement,
-Shield Boosters,
-Breakable Shield Generators,
-Breakable Energy Unit.

The number in the corner show the total value in banks (64 points).

If you see &quot;LAST BANK!&quot; here instead of letters then ... well, you know. (Flee! ;))


Equipment indicator
-------------------

Next to the shield values there are letters which show if the following equipments are installed and turned on:
-&quot;ECM&quot; mean Auto ECM is active,
-&quot;Turret&quot; mean Turret Toggler allow your turrets to fire.


One-shot indicator
------------------

The space rightwards from shield percentages show letters to indicate one-shot equipments, in order:
-B: Energy Bomb,
-C: Additional Core Hull (this and next from HardShips OXP),
-E: Emergency Energy Generator (will be damaged at the second usage if High-Tech Catalyst is installed also),
-G: Galactic Hyperdrive,
-H: High-Tech Catalyst (from HardShips OXP, will be damaged at the first usage of Emergency Energy Generator),
-P: Escape Pod,
-R: Renewable Energy Generator (from HardShips OXP),
-U: Emergency Energy Unit (from Energy Equipment OXP),



Custom HUD dials
----------------

Oolite v1.81 provide drawCustomText: HUD dial which can display informations without MFD.
You still must buy the CombatMFD equipment for the followings but you must not show up the MFD if your HUD has support for these (like the Original and Small HUDs in HUDSelector).

CombatMFD fill up the following dials with values, so HUD designers can use these:

 data_source   	description
 combatAftSh	aft shield numeric value, including capacitors
 combatAftShP	aft shield percent value, over 100% if upgraded
 combatAlt	altitude over the nearest planet, moon or sun in km
 combatAltR	altitude over a planet, moon or sun in radius
 combatCredits	credits of player
 combatCTemp	cabin temp
 combatDmgEq	name of the lastly damaged equipment
 combatDEqNum	number of the damaged equipments
 combatEnergy	energy of player ship in numeric form
 combatEnergyP	energy of player ship in percent
 combatFwSh	forward shield numeric value, including capacitors
 combatFwShP	forward shield percent value, over 100% if upgraded
 combatFuel	remaining fuel in the main tank in ly, min. 0.0, max. 7.0
 combatFuelReq	required fuel of a declared hyperjump
 combatFuelRes	reserve fuel in extra tanks (integer)
 combatLegal	legal status of player, Clean/Offender/Fugitive
 combatLegalNum	legal status of player, bounty
 combatNewTelT	name of the newest target detected by Telescope
 combatOneShot	letters of One-shot indicator (BCEGHPRU)
 combatSCTDist	distance of space compass target
 combatSEE	letters of SEE indicator about the player ship (CMBSAHE)
 combatSEEMax	maximum number of ship durability: max of shield+armour+energy
 combatSEENum	number of ship durability: shield+armour+energy
 combatSpeed	actual speed of player ship in m/s
 combatTDist	distance of the current target
 combatTDmg	damaged/weak/derelict status of the current target
 combatTEnergy	energy of the current target, use for debug only
 combatTLaser	laser weapon of the current target
 combatTLegal	legal status of the current target, if derelict then Towbar status
 combatTLRange	range of the target&#39;s laser weapon
 combatTMissile	missile type fired by the target, Normal/Hard/Unknown
 combatTMissNum	number of missiles fired by the target so far
 combatTName	full name of the current target
 combatTRadius	shield radius of the current target
 combatTSpeed	speed of the current target

Numeric values are centered in a 28 character wide field by default, texts are left aligned (you can align to right in hud plist with align=1).
The default width of centered fields is adjustable in the worldScripts.combat_MFD.$DW variable.
If $DW is 0 then all field will be left aligned.
If $DW negative then right aligned in the given width.

Using the drawCustomBar: selector HUDs can give graphical feedback about the following values:

 data_source   	description
 combatAftShBar	aft shield bar including capacitors
 combatCargoBar	how filled the cargo bay of player ship
 combatFwShBar	forward shield bar including capacitors
 combatSEEBar	total durability bar of player ship based on the SEE indicator
 combatSLBar	service level bar of player ship


Original HUD display numeric speed over the speed bar (available in HUDSelector).
This need the following code in the dials section:

 {
 	data_source = &quot;combatSpeed&quot;;
 	selector = &quot;drawCustomText:&quot;;
 //	alert_conditions = 2; //uncomment if you want to see in green alert only
 	alpha = 1.0;
 	height = 13;
 	width = 15;
 	x = 151;
 	y = 87;
 	y_origin = -1;
 },


OXP developers can reach all data in worldScripts.combat_MFD.$Data object using the same data_soucre key names, so for speed use $Data.combatSpeed .

The access of worldScript name is slow, so you should get a pointer once in startUp:

 this.startUp = function() {
 	this.$combatWS = worldScripts.combat_MFD; //slow access for the pointer, one time only
 }
 this.$displaySpeed = function() {
 	if( this.$combatWS ) //must check CombatMFD existence to prevent an error
 		player.consoleMessage( this.$combatWS.$Data.combatSpeed ); //fast access
 	else log(this.name, &quot;Can not display speed value, CombatMFD OXP is missing&quot;);
 }


The $DataArray contain all available data_source keys.

 this.$combatKeyIsExists = function( key ) {
 	if( this.$combatWS &amp;&amp; this.$combatWS.$DataArray.indexOf( key ) &gt; -1 )
 		return true;
 	else return false;
 }


The $DataShow can disable the display of any data in the HUD:

 this.$disableKey = function(combatKey) {
 	if( this.$combatWS ) this.$combatWS.$DataShow[combatKey] = false;
 }



Dependencies
------------

Oolite 1.79 or later.

Instructions:

Do not unzip the .oxz file, just move into the AddOns folder of your Oolite installation.

License
-------

This work is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike License version 4.0.
If you are re-using any piece of this OXP, please let me know by sending an e-mail to norbylite@gmail.com.


Changelog
---------

 2020.11.23. v1.14 Adds target&#39;s mass to MFD.

 2020.11.18. v1.13 Shows Shield Cycler mode (Equal, Forward, Aft or Disabled).

 2015.10.03. v1.12 Show Auto ECM and Turret Toggler active status if installed.
                   Do not display 0 as bounty and damaged equipments if none.
                   Fixed a bug if both HardShips and IronHide Armour is installed.

 2015.05.18. v1.11 Speed formula updated for time forwarding in TorusToSun v1.5.

 2015.01.08. v1.10 Small fix of a harmless message in Oolite 1.80, thanks to phkb.

 2014.10.20. v1.9  Custom dials of player always calculated, dials of target need the equipment.
                   Altitude custom dial in km added.

 2014.10.16. v1.8  HUD dials added, need Oolite 1.81 and support in HUD plist.

 2014.10.11. v1.7  Telescope display the newest detected target in the last line.
                   Fuel display counts additional FuelTank, DuplexFuelTank, ExtraFuelTanks and
                   the reserve fuel of Andromeda also.
                   Better energy feedback for ships with a single energy bank.

 2014.08.11. v1.6  Damaged, Weak and Derelict display on HUDs with support for this feature.
                   Show FW instead of 8x when TorusToSun use time forwarding at max. speed.

 2014.07.24. v1.5  Equipment cost raised to 1000cr due to the MFD pricing thread.
                   Show Torus multiplier before player speed if Torus To Sun is installed.
                   Line length fine tune with hair spaces, thanks to spara.

 2014.07.09. v1.4  SEE and One-shot indicators added.
                   Player legal status added.
                   Missile counter with &quot;Hard&quot; flag added.
                   Energy and Shields percents are rounded to 10 for better readability.
                   Target Front/Aft orientation display.
                   Speed display use velocity for Q-Charger.
                   A fix against garbage-collected timer in log.

 2014.07.07. v1.3  Informations added in top right and bottom right corners.
                   Speed labels removed to prevent twithcing.
                   A small fix about Telescope far targets.

 2014.07.06. v1.2  Show the name of the lastly damaged equipment.
                   Show the target&#39;s laser type and range after a shot.
                   Energy and Shields are displayed in percents only.

 2014.07.05. v1.1  Must buy Combat MFD as an equipment.
                   Legal status display need Scanner Targeting Enhancement.
                   Show Telescope far target names without km.
                   Can show Empty, Mined and Usable ship status with Towbar.
                   Wormhole target supported with Wormhole Scanner equipment.

 2014.07.02. v1.0  More info displayed by Norby.

 2014.06.30. v0.1  Some info displayed by Zireael.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Visible</th>
                    <th>Cost [deci-credits]</th>
                    <th>Tech-Level</th>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_COMBATMFD.html">Combat MFD</a></td>
                    <td>yes</td>
                    <td align="right">10000</td>
                    <td align="center">5+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DTADAM.html">HUD</a></td>
                    <td>no</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DTADER.html">HUD</a></td>
                    <td>no</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
                <tr>
                    <td><a href="../equipment/EQ_DTAWEA.html">HUD</a></td>
                    <td>no</td>
                    <td align="right">0</td>
                    <td align="center">100+</td>
                </tr>
            </table>
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Config/script.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;combat_MFD&quot;;
this.author      = &quot;Norby, Zireael&quot;;
this.copyright   = &quot;2014 Norby, Zireael&quot;;
this.description = &quot;Makes MFDs more useful by displaying some info&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;
this.version     = &quot;1.14&quot;;

this.$DW = 28; //default width of centered textfields in setCustomHUDDial
this.$ExactNumbers = false; //energy and shield values for debug

this.$combat_MFD = null; //store the final displayed string with player and target data
this.$Data = {}; //storage of calculated values for external usage
this.$DataArray = [ //data_source key names for drawCustomText and drawCustomBar HUD dials
 &quot;combatAftSh&quot;,    //aft shield numeric value (including capacitors)
 &quot;combatAftShBar&quot;,    //aft shield bar including capacitors
 &quot;combatAftShP&quot;,    //aft shield percent value (over 100% if upgraded)
 &quot;combatAlt&quot;,    //altitude over the nearest planet, moon or sun in km
 &quot;combatAltR&quot;,    //altitude over a planet, moon or sun in radius
 &quot;combatCargoBar&quot;,    //how filled the cargo bay of player ship
 &quot;combatCredits&quot;,    //credits of player
 &quot;combatCTemp&quot;,    //cabin temp
 &quot;combatDmgEq&quot;,    //name of the lastly damaged equipment
 &quot;combatDEqNum&quot;,    //number of the damaged equipments
 &quot;combatEnergy&quot;,    //energy of player ship in numeric form
 &quot;combatEnergyP&quot;,    //energy of player ship in percent
 &quot;combatFwSh&quot;,    //forward shield numeric value (including capacitors)
 &quot;combatFwShBar&quot;,    //forward shield bar including capacitors
 &quot;combatFwShP&quot;,    //forward shield percent value (over 100% if upgraded)
 &quot;combatFuel&quot;,    //remaining fuel in the main tank in ly (min. 0.0, max. 7.0)
 &quot;combatFuelReq&quot;,    //required fuel of a declared hyperjump
 &quot;combatFuelRes&quot;,    //reserve fuel in extra tanks (integer)
 &quot;combatLegal&quot;,    //legal status of player (word)
 &quot;combatLegalNum&quot;,    //legal status of player (number)
 &quot;combatNewTelT&quot;,    //name of the newest target detected by Telescope
 &quot;combatOneShot&quot;,    //letters of One-shot indicator (BCEGHPRU)
 &quot;combatSCTDist&quot;,    //distance of space compass target
 &quot;combatSEE&quot;,    //letters of SEE indicator about the player ship (CMBSAHE)
 &quot;combatSEEBar&quot;,    //total durability bar of player ship based on the SEE indicator
 &quot;combatSEEMax&quot;,    //maximum number of ship durability: max of shield+armour+energy
 &quot;combatSEENum&quot;,    //number of ship durability: shield+armour+energy
 &quot;combatSLBar&quot;,    //service level bar of player ship
 &quot;combatSpeed&quot;,    //actual speed of player ship in m/s
 &quot;combatTDist&quot;,    //distance of the current target
 &quot;combatTDmg&quot;,    //damaged/weak/derelict status of the current target
 &quot;combatTEnergy&quot;,    //energy of the current target, use for debug only
 &quot;combatTLaser&quot;,    //laser weapon of the current target
 &quot;combatTLegal&quot;,    //legal status of the current target, if derelict then Towbar status
 &quot;combatTLRange&quot;,    //range of the target&#39;s laser weapon
 &quot;combatTMissile&quot;,    //missile type fired by the target (Hard, etc.)
 &quot;combatTMissNum&quot;,    //number of missiles fired by the target so far
 &quot;combatTName&quot;,    //full name of the current target
 &quot;combatTRadius&quot;,    //shield radius of the current target
 &quot;combatTSpeed&quot;    //speed of the current target
];
this.$DataShow = {}; //allow or deny display of the mentioned values in CustomHUDDial
this.$DmgEqs = []; //store damaged eq keys
this.$InfoTimer = null; //store pointer to timer
this.$InfoTimer2 = null; //store pointer to timer2
this.$TelescopeLine = &quot;&quot;; //the 5. line in this MFD is filled by Telescope_1.9.oxz
this.$WasOk = false; //store the previous state of Equipment
this.$lastTarget = null;

this.startUp = function() {
    var h = worldScripts.hudselector;
    if( h &amp;&amp; h.$HUDSelectorAddMFD ) h.$HUDSelectorAddMFD(this.name);

    for( var i = 0; i &lt; this.$DataArray.length; i++ ) {
        this.$Data[this.$DataArray[i]] = 0; //fill up Data object with key names
        this.$DataShow[this.$DataArray[i]] = true; //allow display all data by default
    }
    
    if(player.ship &amp;&amp; player.ship.isValid)
        this.$PlayerPrevPos = player.ship.position;
    else this.$PlayerPrevPos = [0,0,0];
    this.$Target = null;
    this.$TargetPrevPos = [0,0,0];
    this.$Aws = worldScripts.andromeda;
    this.$Cws = worldScripts[&quot;Automatic ECM System&quot;];
    this.$Dws = worldScripts.duplex_fuel_tank;
    this.$Ews = worldScripts[&quot;extra_tanks_script.js&quot;];
    this.$Hws = worldScripts.hardships;
    this.$Iws = worldScripts[&quot;IronHide Armour Script&quot;];
    this.$Ows = worldScripts.towbar;
    this.$Rws = worldScripts.torustosun;
    this.$Sws = worldScripts.shieldequalizercapacitors;
    this.$Scs = worldScripts[&quot;Shield Cycler&quot;];
    this.$Tws = worldScripts.telescope;
    this.$Uws = worldScripts[&quot;Turret Toggler&quot;];
    this.$InfoTimer = null; //store pointer to timer
    this.$InfoTimer2 = null; //store pointer to timer2

    this.$DmgEqs = []; //store damaged eq keys
    var eq = player.ship.equipment;
    var i=-1;
    while(eq[++i]) { //skip noname eqs awarded by NumericHUD
        if( eq[i].name.length &gt; 0
            &amp;&amp; player.ship.equipmentStatus(eq[i].equipmentKey)==&quot;EQUIPMENT_DAMAGED&quot;)
            this.$DmgEqs.push(eq[i].equipmentKey);
    }
}
    
this.equipmentDamaged = function(equipment) {
    this.$DmgEqs.push(equipment);
//    log(&quot;combat_MFD&quot;, &quot;DmgEqs: &quot;+this.$DmgEqs); //debug
}

this.shipAttackedWithMissile = function(missile, whom) {
    if( whom &amp;&amp; whom.script ) {
        if( whom.script.$combat_MFD_missiles &gt; 0 )
            whom.script.$combat_MFD_missiles++;
        else whom.script.$combat_MFD_missiles = 1;
        if(missile.dataKey == &quot;missile&quot;)
             whom.script.$combat_MFD_normalmissile = true;
        else if(missile.dataKey == &quot;ecm-proof-missile&quot;)
             whom.script.$combat_MFD_hardmissile = true;
    }
}

this.shipBeingAttacked = this.shipBeingAttackedUnsuccessfully = function(whom) {
     if(whom &amp;&amp; whom.script) whom.script.$combat_MFD_attacked = true; //flag for display Laser type
}

this.shipTargetAcquired = function(target) {
    this.$showCombatInfo(); //update MFD
}

this.shipTargetLost = function(losttarget) {
    this.$showCombatInfo(); //update MFD
}

this.shipWillDockWithStation = function() {
    this.$TelescopeLine = &quot;&quot;;
    if(this.$InfoTimer) {
        this.$InfoTimer.stop();
        delete this.$InfoTimer;
    }
    var p = player.ship;
    if( p.setCustomHUDDial ) //need Oolite v1.81
        for( key in this.$Data ) p.setCustomHUDDial(key, &quot;&quot;); //clear custom dials
}

this.shipWillEnterWitchspace = function() {
    this.$TelescopeLine = &quot;&quot;;
}

this.shipWillLaunchFromStation = function() {
    //the timer interval is bound to the multipliers in speed calculations so must change together
    if( !this.$InfoTimer ) {
        this.$InfoTimer = new Timer(this, this.$showCombatInfo.bind(this), 0, 0.25);
        if(this.$Sws) { //turn of irritating messages and sounds which is unneccesary with this MFD
            this.$Sws.togglemessages = &quot;OFF&quot;;
            this.$Sws.togglesoundfx2 = &quot;OFF&quot;;
        }
    }
        //log(&quot;CombatMFD&quot;,player.ship.equipmentStatus(&quot;EQ_COMBATMFD&quot;)+&quot; &quot;+this.$InfoTimer);//debug
    this.$InfoTimer2Done = false;

    if( this.$ExactNumbers ) {//debug
        var s = system.addShips(&quot;pirate&quot;, 1,
            system.mainStation.position.add(player.ship.heading.multiply(3000)), 100);//debug target
        if( s &amp;&amp; s[0]) {
            //s[0].forwardWeapon = null;//setAI(&quot;nullAI.plist&quot;);
            s[0].bounty = 1;
            s[0].target = player.ship;
            //s[0].displayName = s[0].name + &quot; Target&quot;;
        }
    }
}

this.$showCombatInfo = function() {
    var p = player.ship;
//    log(&quot;combat_MFD&quot;, &quot;EQ_COMBATMFD: &quot;+p.equipmentStatus(&quot;EQ_COMBATMFD&quot;)); //debug
    if(!p || !p.isValid) return;
    if(this.$WasOk &amp;&amp; p.equipmentStatus(&quot;EQ_COMBATMFD&quot;) == &quot;EQUIPMENT_DAMAGED&quot;) {
        this.$WasOk = false;
        p.removeEquipment(&quot;EQ_DTADER&quot;); //remove text legends in NumericHUD
        p.removeEquipment(&quot;EQ_DTADAM&quot;);
        p.removeEquipment(&quot;EQ_DTAWEA&quot;);
        p.setMultiFunctionText(this.name, &quot;Combat MFD is damaged&quot;, false);
    }
    var pp = p.position;
    var target = &quot;\n\n\n\n&quot;; //gather data of player&#39;s current target, skip the lines if no target
    var ceq = false;
    //always clear combatT dials for sure (no eq, no target or not applicable due to other reason)
    this.$setData(&quot;combatTDist&quot;, &quot;&quot;);    //distance of the current target
    this.$setData(&quot;combatTDmg&quot;, &quot;&quot;);    //damaged/weak/derelict status of the current target
    this.$setData(&quot;combatTEnergy&quot;, &quot;&quot;);    //energy of the current target, use for debug only
    this.$setData(&quot;combatTLaser&quot;, &quot;&quot;);    //laser weapon of the current target
    this.$setData(&quot;combatTLegal&quot;, &quot;&quot;);    //legal status of the current target, if derelict then Towbar status
    this.$setData(&quot;combatTLRange&quot;, &quot;&quot;);    //range of the target&#39;s laser weapon
    this.$setData(&quot;combatTMissile&quot;, &quot;&quot;);    //missile type fired by the target (Hard, etc.)
    this.$setData(&quot;combatTMissNum&quot;, &quot;&quot;);    //number of missiles fired by the target so far
    this.$setData(&quot;combatTName&quot;, &quot;&quot;);    //full name of the current target
    this.$setData(&quot;combatTRadius&quot;, &quot;&quot;);    //shield radius of the current target
    this.$setData(&quot;combatTSpeed&quot;, &quot;&quot;);    //speed of the current target
    if(p.equipmentStatus(&quot;EQ_COMBATMFD&quot;) == &quot;EQUIPMENT_OK&quot;) {
        var ceq = true;
        this.$WasOk = true;
        var t = p.target;
        if (t != this.$lastTarget) {
            p.removeEquipment(&quot;EQ_DTADER&quot;); //remove text legends in NumericHUD
            p.removeEquipment(&quot;EQ_DTADAM&quot;);
            p.removeEquipment(&quot;EQ_DTAWEA&quot;);
            this.$lastTarget = t;
        }
        if(t &amp;&amp; t.isValid) {
            var tdn = t.displayName;//must read name before handle telescopemarker
            var st = &quot;&quot;;
            if(t.isWormhole) {
                tdn = &quot;Wormhole&quot;;
                if(p.equipmentStatus(&quot;EQ_WORMHOLE_SCANNER&quot;) == &quot;EQUIPMENT_OK&quot;) {
                    if( this.$InfoTimer2Done &amp;&amp; this.$LastWormhole == t ) {
                        //log(&quot;CombatMFD&quot;,t.expiryTime+&quot; &quot;+clock.seconds+&quot; &quot;+t.arrivalTime);//debug
                        if(t.destination) tdn += &quot; to &quot;+System.systemNameForID(t.destination);
                        if(t.expiryTime) tdn = this.$AlignedText(tdn, &quot;expire in &quot;+
                            Math.round( t.expiryTime - clock.seconds )+&quot; s&quot;);
                        if(t.arrivalTime) {
                            st = &quot;Travel Time: &quot;+(Math.round(
                            (t.arrivalTime - clock.seconds)/360)/10)+&quot; h&quot;;
                            this.$setData(&quot;combatTLegal&quot;, st);
                        }
                    } else { //5s delay before show Wormhole info
                        tdn += &quot; scanning...&quot;;
                        if(this.$LastWormhole != t) {
                            this.$LastWormhole = t;
                            this.$InfoTimer2Done = false;
                            if(this.$InfoTimer2) {
                                this.$InfoTimer2.stop();
                                delete this.$InfoTimer2;
                            }
                            this.$InfoTimer2 = new Timer(this, this.$showWormholeInfo.bind(this), 6);
                        }
                    }
                }
            }

            //telescope far target over scanner range
            var t2 = null;
            if(this.$Tws &amp;&amp; t.dataKey==&quot;telescopemarker&quot;) {//change the pointer to the real target
                t2 = this.$Tws.$TelescopeList[this.$Tws.$TelescopeListi-1];
                //this.$Tws.$TelescopeTarget is not good: not refreshed when
                //the target is changed automatically in weapons offline mode
                if(t2 &amp;&amp; t2.isValid) t = t2;
                var k = tdn.indexOf(&quot;km &quot;); //chop the x km from the begin of marker name
                if( k &gt; -1 &amp;&amp; k &lt; 10 ) tdn = tdn.substr( k+3 );
            }
            this.$setData(&quot;combatTName&quot;, tdn);

             //target speed
            var tsp = 0;
            var ts = &quot;&quot;;
            if(t.maxSpeed &gt; 0) {
                if(this.$Target == t) { //need 2 pos. for speed, use velocity for Q-Charger
                    tsp = Math.round(t.velocity.magnitude()/10)*10; //stable but can not show FTL drive
                    if(tsp &gt; 31 * t.maxSpeed ) { //support for FarPlanets
                        var psp = Math.round(0.1*t.position.distanceTo(this.$TargetPrevPos))*10;
                        if( psp &gt; 1.1* tsp ) tsp = psp;//instable but need to follow position changes
                    }
                } else {
                    this.$Target = t; //first time save position
                    tsp = Math.round(t.velocity.magnitude()/10)*10;
                }
                if( tsp &gt; 10000000 ) tsp = Math.round( tsp / 1000000 ) + &quot; M&quot;;
                else if( tsp &gt; 1000000 ) tsp = Math.round( tsp / 1000 ) + &quot; k&quot;;
                else tsp = Math.round( tsp ) + &quot; &quot;;
                ts = tsp;
                tsp += &quot;m/s&quot;;
                //tsp = &quot;Speed: &quot; + tsp;
            } else tsp = &quot;&quot;; //nothing for stationary objects, zero for others
            this.$setData(&quot;combatTSpeed&quot;, ts, this.$DW);
            this.$TargetPrevPos = t.position;
            
            //target distance
            var ra = Math.round(t.collisionRadius);
            var di = Math.max(0, Math.round(t.position.distanceTo(pp)-ra-p.collisionRadius));
            if(di &gt;= 1000000000) di = Math.floor(di/1000000000)+&quot;Mkm&quot;;
            else if(di &gt;= 1000) di = Math.floor(di/1000)+&quot;km&quot;;
            else di += &quot;m&quot;;
            this.$setData(&quot;combatTDist&quot;, di, this.$DW);
            if( ra &gt; 100000 ) ra = Math.round( ra / 1000 ) + &quot;km&quot;;
            else ra += &quot;m&quot;;
            
            //target radius
            var sr = &quot;&quot;;
            if( !t.isShip || t.isPlanet || t.isSun || t.isRock ) {
                sr = &quot;Radius: &quot;+ra;
                this.$setData(&quot;combatTRadius&quot;, sr);
//                this.$setData(&quot;combatTDmg&quot;, &quot;&quot;);
            } else {    //facing shield
                if(!t2) { //within scanner range only
                    sr = &quot;Shield Radius: &quot;;
                    if(this.$AftShieldFacing(t)) sr = sr + ra + &quot;    Aft&quot;;
                    else sr = sr + ra + &quot;   Front&quot;;
                    this.$setData(&quot;combatTRadius&quot;, sr);
                }
                
                var d = false;
                if(t.isDerelict) {
                    d = &quot;Derelict&quot;;
//                    log(this.name, &quot;Awarding DTADER, target is derelict&quot;);
                    p.awardEquipment(&quot;EQ_DTADER&quot;); //show text legend in NumericHUD
                } else {
                    if(!t2 &amp;&amp; t.energy &amp;&amp; t.maxEnergy ) {
                        if(t.energy &lt; 0.2*t.maxEnergy ) {
                            d = &quot;Weak!&quot;;
                            p.awardEquipment(&quot;EQ_DTAWEA&quot;);
                        } else if(t.energy &lt; 0.4*t.maxEnergy ) {
                            d = &quot;Damaged!&quot;;
                            p.awardEquipment(&quot;EQ_DTADAM&quot;);
                        }
                    }
                }
                if( d ) {
                    sr = this.$AlignedText(sr, d);
                    this.$setData(&quot;combatTDmg&quot;, d);
                } //else this.$setData(&quot;combatTDmg&quot;, &quot;&quot;);
            }
            
            //target laser
            var laser = &quot;&quot;;
            if( t.script &amp;&amp; t.script.$combat_MFD_attacked &amp;&amp; t.currentWeapon ) {
                laser = &quot;Laser: &quot;+t.currentWeapon.name;
                this.$setData(&quot;combatTLaser&quot;, laser);
                var rng = &quot;Range: &quot;+Math.round(t.weaponRange/100)/10+&quot;km&quot;;
                this.$setData(&quot;combatTLRange&quot;, rng);
                laser = this.$AlignedText( laser, rng );
            } else if( t.forwardWeapon ) {
                laser = &quot;Laser: Unknown&quot;;
                this.$setData(&quot;combatTLaser&quot;, laser);
//                this.$setData(&quot;combatTLRange&quot;, &quot;&quot;);
            }
            
             //target status
            if(!t2 &amp;&amp; p.equipmentStatus(&quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot;) == &quot;EQUIPMENT_OK&quot;
                &amp;&amp; (!t.isWormhole&amp;&amp;t.isShip&amp;&amp;t.isPiloted||t.isDerelict)) {
                st = &quot;Status:&quot;;
                if(t.isDerelict) {
                    if(this.$Ows &amp;&amp; t.script) { //Towbar status
                        if(t.script.$TowbarUsableShip) st += &quot; Usable!&quot;;
                        else if(t.script.$TowbarMinedShip) st += &quot; Mined&quot;;
                        if(t.script.$TowbarEmptyShip) st += &quot; Empty&quot;;
                        else st += &quot; Trap or Treasure&quot;;
                    }
                } else if(t.bounty&gt;50) st += &quot; Fugitive&quot;; //legal status
                else if(t.bounty&gt;0) st += &quot; Offender&quot;;
                else st += &quot; Clean&quot;;
                this.$setData(&quot;combatTLegal&quot;, st);
                
                if( this.$ExactNumbers ) st += &quot; &quot;+Math.round(t.energy);//for debug
                this.$setData(&quot;combatTEnergy&quot;, Math.round(t.energy), this.$DW);
                
//                this.$setData(&quot;combatTMissNum&quot;, 2); this.$setData(&quot;combatTMissile&quot;, &quot;Normal&quot;);//debug
                //Missiles fired
                if( t.script) {
                    var m = t.script.$combat_MFD_missiles;
                    if( m &gt; 0 ) {
                        this.$setData(&quot;combatTMissNum&quot;, m);
                        var s = &quot;&quot;;
                        if( m &gt; 1 ) s = &quot;s&quot;;
                        if(t.script.$combat_MFD_hardmissile) {
                            m+=&quot; Hard&quot;;
                            this.$setData(&quot;combatTMissile&quot;, &quot;Hard&quot;);
                        } else if(t.script.$combat_MFD_normalmissile) {
                            this.$setData(&quot;combatTMissile&quot;, &quot;Normal&quot;);
                        } else {
                            m+=&quot; Unknown type&quot;;
                            this.$setData(&quot;combatTMissile&quot;, &quot;Unknown&quot;);
                        }
                        st = this.$AlignedText(st, &quot; Missile&quot;+s+&quot; fired: &quot;+m);
                    }
                }
            }
            
            //concatenate target info
            target = tdn + &quot;\n&quot; + this.$AlignedText(&quot;Distance: &quot;+di+&quot;, Mass: &quot;+(t.mass/1000).toFixed(1)+&quot;t&quot;, tsp) +
                &quot;\n&quot; + sr + &quot;\n&quot; + laser + &quot;\n&quot; + st;
        } 
        else {
            p.removeEquipment(&quot;EQ_DTADER&quot;); //remove text legends in NumericHUD
            p.removeEquipment(&quot;EQ_DTADAM&quot;);
            p.removeEquipment(&quot;EQ_DTAWEA&quot;);
            this.$Target = null;
        }
    }

    //player energy
    this.$setData(&quot;combatEnergy&quot;, Math.round(p.energy), this.$DW);
    var ep = &quot;Energy: &quot;+10*Math.round(10*p.energy/p.maxEnergy)+&quot;%&quot;;
    this.$setData(&quot;combatEnergyP&quot;, ep, this.$DW);

    var eb = Math.floor(p.maxEnergy/64);//how many energy banks shown in hud
    var e = Math.ceil(p.energy/(p.maxEnergy/eb));
    var en = &quot;&quot;;
    var seemax = p.maxEnergy;

    var ihv = 0;
    if( this.$Iws ) { //IronHide armour
        var ihs = missionVariables.ironHide_strength;
        seemax += ihs;
        var ihp = missionVariables.ironHide_percentage;
        if(ihs &gt; 0 &amp;&amp; ihp &gt; 0) ihv = ihs * ( ihp / 100 );
//        log(&quot;combat_MFD&quot;, &quot;H: &quot;+ihs+&quot; &quot;+ihp+&quot; &quot;+ihv); //debug
    }
    var asmax = p.maxAftShield;
    var fsmax = p.maxForwardShield;
    seemax += Math.max(asmax, fsmax);
    if(this.$Sws &amp;&amp; //Shield capacitor
        (p.equipmentStatus(&quot;EQ_FORWARD_SHIELD_CAPACITOR&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;
        || p.equipmentStatus(&quot;EQ_AFT_SHIELD_CAPACITOR&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot;)) {
        var max = 64;
        if(this.$Sws.secforwardshieldcapacitormax) {
            max = Math.max(max, this.$Sws.secforwardshieldcapacitormax);
            fsmax += this.$Sws.secforwardshieldcapacitormax;
        } else if(p.equipmentStatus(&quot;EQ_FORWARD_SHIELD_CAPACITOR&quot;) == &quot;EQUIPMENT_OK&quot;)
            fsmax += 64;
        if(this.$Sws.secaftshieldcapacitormax) {
            max = Math.max(max, this.$Sws.secaftshieldcapacitormax);
            asmax += this.$Sws.secaftshieldcapacitormax;
        } else if(p.equipmentStatus(&quot;EQ_AFT_SHIELD_CAPACITOR&quot;) == &quot;EQUIPMENT_OK&quot;)
            asmax += 64;
        seemax += max;
        en += this.$SEELetters( &quot;C&quot;, max,
            this.$Sws.secforwardshieldcapacitor,
            this.$Sws.secaftshieldcapacitor,
            &quot;EQ_FORWARD_SHIELD_CAPACITOR&quot;,
            &quot;EQ_AFT_SHIELD_CAPACITOR&quot;,
            &quot;EQ_BIGSHCAP&quot;, &quot;EQ_BIGSHCAP2&quot;, &quot;EQ_BIGSHCAP3&quot;);
    }
    if(this.$Hws) { //armours in HardShips OXP
        var hmax = Math.max(this.$Hws.$HardShips_AMax[0][0], //fw
            this.$Hws.$HardShips_AMax[0][1]); //aft
        seemax += hmax;
    }
    
    if( e &lt; 2 &amp;&amp; p.maxEnergy &gt; 96) { //not exactly below 64, for example in Fer-De-Lance below 75
        en =&quot;LAST BANK!&quot;;
    } else { //&quot;SEE&quot; indicator: letters mean shields, armour and energy for each double banks
        if(p.equipmentStatus(&quot;EQ_NAVAL_SHIELD_BOOSTER&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot; )
            en += this.$SEELetters( &quot;M&quot;, 128,
                Math.max(0, p.forwardShield-256),
                Math.max(0, p.aftShield-256),
                &quot;EQ_NAVAL_SHIELD_BOOSTER&quot;);
        if(p.equipmentStatus(&quot;EQ_SHIELD_BOOSTER&quot;) != &quot;EQUIPMENT_UNAVAILABLE&quot; )
            en += this.$SEELetters( &quot;B&quot;, 128,
                Math.min(128, Math.max(0, p.forwardShield-128)),
                Math.min(128, Math.max(0, p.aftShield-128)),
                &quot;EQ_SHIELD_BOOSTER&quot;);
        en += this.$SEELetters( &quot;S&quot;, 128,
            Math.min(128, p.forwardShield),
            Math.min(128, p.aftShield),
            &quot;EQ_BREAKABLE_SHIELD_FORE_SMALL&quot;,
            &quot;EQ_BREAKABLE_SHIELD_AFT_SMALL&quot;,
            &quot;EQ_BREAKABLE_SHIELD_FORE_MEDIUM&quot;,
            &quot;EQ_BREAKABLE_SHIELD_AFT_MEDIUM&quot;,
            &quot;EQ_BREAKABLE_SHIELD_FORE_LARGE&quot;,
            &quot;EQ_BREAKABLE_SHIELD_AFT_LARGE&quot;);
        if(this.$Hws) { //armours in HardShip OXP
            en += this.$SEELetters( &quot;A&quot;, hmax,
            this.$Hws.$HardShips_Armour[0][0], //fw armour value
            this.$Hws.$HardShips_Armour[0][1]);//aft
            //IronHide handled by HardShips
            var ihs = this.$Hws.$HardShips_AMax[0][7];
            var ihv = this.$Hws.$HardShips_Armour[0][7];
        }
        if(ihv &gt; 0) en += this.$SEELetters( &quot;H&quot;, ihs, ihv, ihv);
        en += this.$SEELetters( &quot;E&quot;, p.maxEnergy, p.energy, p.energy,
            &quot;EQ_BREAKABLE_ENERGY_UNIT_SMALL&quot;,
            &quot;EQ_BREAKABLE_ENERGY_UNIT_MEDIUM&quot;,
            &quot;EQ_BREAKABLE_ENERGY_UNIT_LARGE&quot;);
    }
    //&quot;SEE&quot; indicator is done at this point in en variable
    this.$setData(&quot;combatSEE&quot;, en);
        
    //count enery+armour+shield banks
    e = p.energy + Math.min(p.forwardShield, p.aftShield);
    if(this.$Sws) e += Math.min(this.$Sws.secforwardshieldcapacitor,
        this.$Sws.secaftshieldcapacitor);
    if(this.$Hws) e += Math.min(this.$Hws.$HardShips_Armour[0][0], //fw
        Math.min(this.$Hws.$HardShips_Armour[0][1],//aft
        Math.min(this.$Hws.$HardShips_Armour[0][2],//port
        Math.min(this.$Hws.$HardShips_Armour[0][3],//sb
        Math.min(this.$Hws.$HardShips_Armour[0][4],//top
            this.$Hws.$HardShips_Armour[0][5])))));//bottom
    e += ihv; //ironhide value, calculated above
    en += &quot; (&quot; + Math.round( e / 64 ) + &quot;)&quot;; //in banks
    this.$setData(&quot;combatSEEMax&quot;, seemax, this.$DW);//maximum of exact SEE value
    this.$setData(&quot;combatSEENum&quot;, Math.round( e ), this.$DW);//exact value
    this.$setData(&quot;combatSEEBar&quot;, e/seemax);//0-1
    
    //player shields
    var fs = Math.round(p.forwardShield); 
    if(this.$Sws) fs += Math.round(this.$Sws.secforwardshieldcapacitor);
    this.$setData(&quot;combatFwSh&quot;, fs, this.$DW);
    this.$setData(&quot;combatFwShBar&quot;, fs/fsmax);
    var as = Math.round(p.aftShield);
    if(this.$Sws) as += Math.round(this.$Sws.secaftshieldcapacitor);
    this.$setData(&quot;combatAftSh&quot;, as, this.$DW);
    this.$setData(&quot;combatAftShBar&quot;, as/asmax);
    var fp = this.$ForwardPercent(fs);
    var ap = this.$AftPercent(as);
    var sh = &quot;Shields: &quot;+fp+&quot;%/&quot;+ap+&quot;%&quot;;
    var ws_sc = this.$Scs;
    if (ws_sc &amp;&amp; (ws_sc._sc_get_sc_versions(null)).version &gt; 0 &amp;&amp; !ws_sc.$sc_disabled &amp;&amp; ws_sc.$sc_settings.version &gt; 0) 
        sh += &quot; &quot;+ws_sc.$sc_const.mode_names[ws_sc.$sc_settings.current_configuration];
    this.$setData(&quot;combatFwShP&quot;, fp+&quot;%&quot;, this.$DW);
    this.$setData(&quot;combatAftShP&quot;, ap+&quot;%&quot;, this.$DW);
    
    if( this.$ExactNumbers ) { //for debug
        en += &quot;: &quot;+Math.round(p.energy);
        sh += &quot; (&quot;+fs+&quot;/&quot;+as+&quot;)&quot;;
    }

    //Auto ECM and Turret Toggler indicators
    var one = &quot;&quot;;
    if( this.$Cws &amp;&amp; missionVariables.autoECM == 1
        &amp;&amp; p.equipmentStatus(&quot;EQ_AUTOECM&quot;) == &quot;EQUIPMENT_OK&quot; ) one += &quot; ECM &quot;;
    if( this.$Uws &amp;&amp; this.$Uws._tt_turret_status == &quot;active&quot;
        &amp;&amp; p.equipmentStatus(&quot;EQ_UNI_TURRET&quot;) == &quot;EQUIPMENT_OK&quot; ) one += &quot; Turret &quot;;
    if( one.length &gt; 0 ) one = &quot; &quot;+one+&quot; &quot;;
    
    //&quot;One-shot&quot; indicator for Energy Bomb and one-shot equipments in HardShips OXP
    if( p.equipmentStatus(&quot;EQ_ENERGY_BOMB&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;B&quot;;
    if(this.$Hws) {
        if(p.equipmentStatus(&quot;EQ_ADDITIONAL_CORE_HULL&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;C&quot;;
        if( p.equipmentStatus(&quot;EQ_EEG&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;E&quot;;
    }
    if( p.equipmentStatus(&quot;EQ_GAL_DRIVE&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;G&quot;;
    if( this.$Hws &amp;&amp; p.equipmentStatus(&quot;EQ_HTCAT&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;H&quot;;
    if( p.equipmentStatus(&quot;EQ_ESCAPE_POD&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;P&quot;;
    if( this.$Hws &amp;&amp; p.equipmentStatus(&quot;EQ_REG&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;R&quot;;
    if( p.equipmentStatus(&quot;EQ_EEU&quot;) == &quot;EQUIPMENT_OK&quot;) one += &quot;U&quot;;
    sh = this.$AlignedText(sh, one);
    this.$setData(&quot;combatOneShot&quot;, one);

    //player legal status
    var ps = &quot;&quot;;
    var psw = &quot;Clean&quot;;
    if(p.bounty&gt;50) {
        psw = &quot;Fugitive&quot;;
        ps += psw+&quot; (&quot;+p.bounty+&quot;)&quot;;
        if(p.bounty&lt;100) ps += &quot;  &quot;;
    } else if(p.bounty&gt;0) {
        psw = &quot;Offender&quot;;
        ps += psw+&quot; (&quot;+p.bounty+&quot;) &quot;;
        if(p.bounty&lt;10) ps += &quot;  &quot;;
    } else ps += &quot;Status: &quot;+psw+&quot; &quot;;
    this.$setData(&quot;combatLegal&quot;, psw);
    var b = Math.round(p.bounty);
    if( b == 0 ) b = &quot;&quot;;
    this.$setData(&quot;combatLegalNum&quot;, b, this.$DW);

    //player fuel
    var extrafuel = &quot;&quot;;
    var ef = 0;
    if( this.$Aws &amp;&amp; player.ship.dataKey == &quot;andromeda-player&quot;
        &amp;&amp; this.$Aws.$AndromedaFuelReserve &gt; 0 )
        ef += this.$Aws.$AndromedaFuelReserve;
    if( this.$Dws ) { //DuplexFuelTank.oxz
        if( p.equipmentStatus(&quot;EQ_DUPLEX_FUEL_TANK_STATE_1&quot;) == &quot;EQUIPMENT_OK&quot; ) ef += 1;
        else if( p.equipmentStatus(&quot;EQ_DUPLEX_FUEL_TANK_STATE_2&quot;) == &quot;EQUIPMENT_OK&quot; ) ef += 2;
        else if( p.equipmentStatus(&quot;EQ_DUPLEX_FUEL_TANK_STATE_3&quot;) == &quot;EQUIPMENT_OK&quot; ) ef += 3;
    }
    if( this.$Ews ) { //ExtraFuelTanks-v1.4.1.oxz
        if( p.equipmentStatus(&quot;EQ_RESERVE_TANK&quot;) == &quot;EQUIPMENT_OK&quot; ) ef += 1;
        else if( p.equipmentStatus(&quot;EQ_AUX_TANK&quot;) == &quot;EQUIPMENT_OK&quot; ) ef += 3;
    }
    if( p.equipmentStatus(&quot;EQ_FUELTANK_MINE&quot;) == &quot;EQUIPMENT_OK&quot; ) { //Fuel_Tank_2.2.oxz
//        log(this.name, p.missiles); //debug
        for( var i = 0; i &lt; p.missiles.length; i++ ) {
            if( p.missiles[i].equipmentKey == &quot;EQ_FUELTANK_MINE&quot; )
                ef += 3;
        }
    }
    if( ef &gt; 0 ) extrafuel = &quot;+&quot;+Math.round(ef); //display total reserve fuel in addition
    var f = (p.fuel).toFixed(1);
    this.$setData(&quot;combatFuel&quot;, f);
    this.$setData(&quot;combatFuelRes&quot;, extrafuel);
    ps += &quot; Fuel: &quot;+f+extrafuel+&quot;ly&quot;;

    var fr = &quot;&quot;; //fuel required for hyperjump
    if(p.targetSystem)
        fr = ( System.infoForSystem(galaxyNumber, system.info.systemID)
            .distanceToSystem(System.infoForSystem(galaxyNumber,p.targetSystem))
            ).toFixed(1);
    this.$setData(&quot;combatFuelReq&quot;, fr);

    //torus multiplyer and player speed
    var tm = &quot;&quot;;
    var sp = Math.round(p.velocity.magnitude()/10)*10; //stable but can not show FTL drive nor Torus multiplier
    if( this.$Rws &amp;&amp; this.$Rws.$TorusToSunBonus &gt; 1 ) {
        tm = &quot; &quot;+Math.round(this.$Rws.$TorusToSunBonus)+&quot;x&quot;;
        sp = Math.round(this.$Rws.$TorusToSunBonus * 3.2 * p.maxSpeed)*10;
        if( this.$Rws.$TimeFw &gt; 1 ) { //time forwarding active
            tm += Math.round(this.$Rws.$TimeFw);
            sp *= this.$Rws.$TimeFw;
        }
    } else {
        if(sp &gt; 31 * p.maxSpeed ) { //support for FarPlanets and any other position changer drives
            var psp = Math.round(0.1*pp.distanceTo(this.$PlayerPrevPos))*10;
            if( psp &gt; 1.1*sp ) sp = psp;//instable but need to follow position changes
        }
    }
    if( sp &gt; 10000000 ) sp = Math.round( sp / 1000000 ) + &quot; M&quot;;
    else if( sp &gt; 1000000 ) sp = Math.round( sp / 1000 ) + &quot; k&quot;;
    this.$setData(&quot;combatSpeed&quot;, sp, this.$DW);
    if(tm.length &gt; 0) sp += &quot;m/s&quot;; else sp += &quot; m/s&quot;;
    this.$PlayerPrevPos = pp;

    //damaged equipment if any
    var dm = &quot;&quot;; 
    var dmg = &quot;&quot;;
    var dmgeqs = [];
//    log(&quot;combat_MFD&quot;, &quot;DmgEqs: &quot;+this.$DmgEqs); //debug
//    p.setEquipmentStatus(&quot;EQ_ECM&quot;,&quot;EQUIPMENT_DAMAGED&quot;);//debug
    for( var i=0; i&lt;this.$DmgEqs.length; i++ ) //remove fixed ones from the damaged list
        if(p.equipmentStatus(this.$DmgEqs[i])==&quot;EQUIPMENT_DAMAGED&quot;)
            dmgeqs.push(this.$DmgEqs[i]);
    this.$DmgEqs = dmgeqs;
//    log(&quot;combat_MFD&quot;, &quot;DmgEqs: &quot;+this.$DmgEqs); //debug
    var b = &quot;&quot;; //hide 0 length value when no damaged eq
    if( dmgeqs &amp;&amp; dmgeqs.length &gt; 0 ) {  //show the name of the lastly damaged equipment
        b = dmgeqs.length;
        dmg = EquipmentInfo.infoForKey(dmgeqs[dmgeqs.length-1]).name;
        if( dmgeqs.length &gt; 1 ) dm = &quot;(+&quot;+(dmgeqs.length-1)+&quot;)&quot;;//+how many other eq damaged
    }
    this.$setData(&quot;combatDmgEq&quot;, dmg);
    this.$setData(&quot;combatDEqNum&quot;, b, this.$DW);
    if(dmg.length &gt; 0) dmg = this.$AlignedText(&quot;Damaged: &quot;+dmg, dm);
    
    if( ceq ) { //if CombatMFD equipment is ok then show the result in MFD
        this.$combat_MFD = this.$AlignedText(ep, en)+&quot;\n&quot;+ //1.line
            sh+&quot;\n&quot;+ //2.line
            this.$AlignedText(ps, sp+tm)+&quot;\n&quot;+ //3.line
            dmg+&quot;\n&quot;+ //4.line
            target+&quot;\n&quot;+  //5.-9.lines
            this.$TelescopeLine; //10.line
        p.setMultiFunctionText(this.name, this.$combat_MFD, false);
    }

    
    //extra data sources (not in MFD)

    //altimeter
    var c = system.sun; //closest planetary object
           if( c ) var d = p.position.distanceTo( c.position );
    else var d = 100000000000000000000.0; //10^20m for sure
    var l = system.planets;
    var len = l.length;
    for( var i = 0; i &lt; len; i++ ) { //find the smallest distance
        var s = pp.distanceTo( l[i].position )-l[i].radius;
        if( d &gt; s ) {
            d = s;
            c = l[i];
        }
    }
    var alt = &quot;&quot;; //clear if no planetary object
    var altr = &quot;&quot;;
    if( c ) {
        alt = pp.distanceTo(c) - c.radius - p.collisionRadius;
        altr = Math.round(100*alt / c.radius)/100; //how many radius far
        if(alt &gt;= 1000000000) alt = Math.floor(alt/1000000000)+&quot;Mkm&quot;;
        else if(alt &gt;= 1000) alt = Math.floor(alt / 1000)+&quot;km&quot;;
        else alt += &quot;m&quot;;
    }
    this.$setData(&quot;combatAlt&quot;, alt, this.$DW);
    this.$setData(&quot;combatAltR&quot;, altr, this.$DW);

    //credits of player
    this.$setData(&quot;combatCredits&quot;, formatCredits(player.credits, true, true), this.$DW);
    
    //cabin temp
    var ct = Math.max(Math.round(100*player.ship.temperature), 23); //prevent flickering below 23
    this.$setData(&quot;combatCTemp&quot;, ct);

    //the newest target detected by Telescope
    this.$setData(&quot;combatNewTelT&quot;, this.$TelescopeLine);

    //distance of space compass target
    var di = &quot;&quot;;
    var c = p.compassTarget;
    if( c &amp;&amp; c.isValid ) di = Math.max(0, Math.round(pp.distanceTo(c)-c.collisionRadius-p.collisionRadius));
    if(di &gt;= 1000000000) di = Math.floor(di/1000000000)+&quot;Mkm&quot;;
    else if(di &gt;= 1000) di = Math.floor(di/1000)+&quot;km&quot;;
    else if(c &amp;&amp; c.isValid) di += &quot;m&quot;;
    this.$setData(&quot;combatSCTDist&quot;, di, this.$DW);

    //how filled the cargo bay of player ship
    this.$setData(&quot;combatCargoBar&quot;, p.cargoSpaceUsed/p.cargoSpaceCapacity);

    //service level bar of player ship
    this.$setData(&quot;combatSLBar&quot;, (p.serviceLevel-75)/25);
}

this.$ForwardPercent = function(current) {
  var max = 128;//player.ship.maxForwardShield;
  var result = 10*Math.round(10*current / max);
  return result;
}

this.$AftPercent = function(current) {
  var max = 128;//player.ship.maxAftShield;
  var result = 10*Math.round(10*current / max);
  return result;
}

this.$showWormholeInfo = function() { //6s delay before show Wormhole info
    this.$InfoTimer2Done = true;
    if(this.$InfoTimer2) {
        this.$InfoTimer2.stop();
        delete this.$InfoTimer2;
    }
}

this.$AlignedText = function(left, right) { //insert as many spaces between as fill the line
    var width = 14.2;
    var space = &quot; &quot;;
    left += space;
    var t = left + right;
    while( defaultFont.measureString(t) &lt; width ) {
        left += space;
        t = left + right;
    }
    //fine tune with hair spaces - from spara&#39;s marketObserver
    var hairSpace = String.fromCharCode(31);
    while ( defaultFont.measureString(t + hairSpace) &lt; width ) {
        left += hairSpace;
        t = left + right;
    }
    return(t);
}

this.$CenteredText = function(txt, width) { //insert spaces before text to align to center in width
    var t = &quot;&quot;+txt; //force to srting, else txt.length is undefined for numbers
    var w = width / 2;
//    log(&quot;combat_MFD&quot;, &quot;CT1 &quot;+txt+&quot; &quot;+t.length+&quot; &quot;+w); //debug
    while( t &amp;&amp; t.length &lt; w ) { //for fixed with font in setCustomHUDDial
        t = &quot; &quot; + t;
    }
    return(t);
}

this.$RightText = function(txt, width) { //insert spaces before text to align to right in width
    var t = &quot;&quot;+txt; //force to srting, else txt.length is undefined for numbers
    while( t &amp;&amp; t.length &lt; width ) { //for fixed with font in setCustomHUDDial
        t = &quot; &quot; + t;
    }
    return(t);
}

this.$SEELetters = function(letter, max, fw, aft, eq1, eq2, eq3, eq4, eq5, eq6) {
    var s = 0; //smaller shield side
    var l = 0; //larger shield side
    var p = player.ship;
    if(eq1 &amp;&amp; p.equipmentStatus(eq1)==&quot;EQUIPMENT_DAMAGED&quot; ||
        eq2 &amp;&amp; p.equipmentStatus(eq2)==&quot;EQUIPMENT_DAMAGED&quot; ||
        eq3 &amp;&amp; p.equipmentStatus(eq3)==&quot;EQUIPMENT_DAMAGED&quot; ||
        eq4 &amp;&amp; p.equipmentStatus(eq4)==&quot;EQUIPMENT_DAMAGED&quot; ||
        eq5 &amp;&amp; p.equipmentStatus(eq5)==&quot;EQUIPMENT_DAMAGED&quot; ||
        eq6 &amp;&amp; p.equipmentStatus(eq6)==&quot;EQUIPMENT_DAMAGED&quot;)
        letter = &quot;_&quot;; //damaged
    s = Math.round(Math.min(fw, aft)/128);
    l = Math.round(Math.max(fw, aft)/128);
    var r = &quot;&quot;;
    var t = Math.round(max/128); //total letters
    for(var i = 0; i &lt; t; i++ )
        if( letter == &quot;_&quot; ) r += letter; //damaged equipment
        else if( i &lt; t-l ) r += &quot;-&quot;; //empty bank
        else if( i &lt; t-s ) r += letter.toLowerCase(); //one side of shield is up only
        else r += letter; //both forward and aft shield is up
//    log(&quot;combat_MFD&quot;, letter+&quot;: &quot;+max+&quot; &quot;+fw+&quot; &quot;+aft+&quot; &quot;+i+&quot;. &quot;+(t-s)+&quot; &quot;+(t-l)+&quot; &quot;+t+&quot; &quot;+r); //debug
    return(r);
}

this.$AftShieldFacing = function(ship) { //determine which shield of the target facing to player ship
    if(ship.vectorForward.angleTo(ship.position.subtract(player.ship.position)) &lt;= Math.PI/2)
        return(true);
    return(false);
}

this.$combatKeyIsExists = function( key ) {
     if( this.$DataArray.indexOf( key ) &gt; -1 ) return true;
     else return false;
}

this.$disableKey = function(combatKey) {
    this.$DataShow[combatKey] = false;
}

this.$enableKey = function(combatKey) {
    this.$DataShow[combatKey] = true;
}

this.$setData = function( key, v, align ) { //align=0:left, &gt;0:center in this width, &lt;0:right
    this.$Data[key] = v; //save for external access
    var p = player.ship;
    if( p.setCustomHUDDial &amp;&amp; this.$DataShow[key] ) {
        if(align &gt; 0) v = this.$CenteredText( v, align ); //centered in an align wide box
        else if(align &lt; 0) v = this.$RightText( v, -align ); //right in a -align wide box
        p.setCustomHUDDial(key, v);
    }
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
