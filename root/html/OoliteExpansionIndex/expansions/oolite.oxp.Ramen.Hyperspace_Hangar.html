<html>
    <head>
        <title>Expansion Hyperspace Hangar</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Hyperspace Hangar</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">3 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Unknown key &#39;upload_date&#39; at https://wiki.alioth.net/img_auth.php/4/44/HyperspaceHangar-1.17.0.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Invented by a small time noodle shop owner, it allows storage of ships in the Hyperspace Hangar service. OXPConfig recommended.</td>
                    <td>Invented by a small time noodle shop owner, it allows storage of ships in the Hyperspace Hangar service. OXPConfig recommended.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Ramen.Hyperspace_Hangar</td>
                    <td>oolite.oxp.Ramen.Hyperspace_Hangar</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Hyperspace Hangar</td>
                    <td>Hyperspace Hangar</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Ramen</td>
                    <td>Ramen</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.17.0</td>
                    <td>1.17.0</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.35</li>
                    </td>
                    <td>
                            <li>oolite.oxp.CaptMurphy.ShipStorageHelper:0.35</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Svengali.Library:1.7.1</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Svengali.Library:1.7.1</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/Hyperspace_Hangar">http://wiki.alioth.net/index.php/Hyperspace_Hangar</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/4/44/HyperspaceHangar-1.17.0.oxz">https://wiki.alioth.net/img_auth.php/4/44/HyperspaceHangar-1.17.0.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/img_auth.php/6/61/Hyperspace_Hangar-1.14.9.oxz">http://wiki.alioth.net/img_auth.php/6/61/Hyperspace_Hangar-1.14.9.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1669214381</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Hyperspace%20Hangar'>http://wiki.alioth.net/index.php/Hyperspace%20Hangar</a></p>
        <h3>README.md</h3>
        <pre>#Oolite-Hyperspace-Hangar
Written by Ramen, with credit to Capt. Murphy and Norby, and Norby again, for
providing a fix for the one-ship-type-only bug, and lots more Norby.
Credit goes to Kheng for providing the hangar image.
(http://kheng.deviantart.com)

For installation instructions, see INSTALL.md

Development thread located at: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=17437

Git repository: https://github.com/rotaryphone111/Oolite-Hyperspace-Hangar

Maintainer contact information:
Name: Kenji Takashima. Email: knjtkshm@gmail.com
##Changelog:
--------------------------------------------------------------------------------
### Version 1.17.0
* Preserves libconfig option to savefile;
* Portable and pylon equipment is not passed on to bought ship if old ship was stored.
* Shows Station Interface even if no ship is stored in Hyperspace Hangar.
* Sell price when selling ships through HH is 15% of full price.
* Damage might occur when switching into ships in station of TL&lt;7.
* Nest try/catch in the sell stored ship option so if an error occur when replacing ship we can revert the operation.
* Check and reports insufficient funds for a ship transfer.
* Creates a in-transit state for stroed ships: ordering ships transfered to current system do not advance the game clock to the ship arrival moment anymore.
* Fixes sell option station interface screens flux.
* Selling a stores ship doesn&#39;t advance game clock.
* Expands &quot;ships in transit&quot; to all order or send orders.
* Shows ships in transit in the Hyperspace Hangar station interface.
* Transit time information in hours is displayed with single decimal digit

### Version 1.16.0 
* Fixed compatibility issue with Ship Version, as well as adding pagination for when more that 1 page of ships are stored (courtesy of dybal).

### Version 1.15.1
* Included Hypercargo bays (including Vortex and Maelstom ships) when removing 
cargo on ship before storage.

### Version 1.15.0 
* Fixed major bug with not taking away the correct number of credits when storing ships, meaning players could easily get massive numbers of credits by buying, storing and selling ships.
* Adjusted position of text on transfer ship map screens.
* Various tweaks to exit screens and menu flow.

### Version 1.14.12
* Bug fixes, spelling corrections. 
* Made default exit points for mission screens to be F4 interfaces page.

### Version 1.14.11
* Attempt to fix issue with New Lasers not being able to be reinstalled.

### Version 1.14.5
* Thu Aug 13 13:07:18 PDT 2015 - Added INSTALL.md, 
* Renamed LICENSE.txt and README.txt to .md files. Added git repo to github.

### Version 1.14.4
* Mon Aug 10 15:48:16 PDT 2015 - Removed test message that was left in by accident.

### Version 1.14.3
* Mon Aug 10 15:21:34 PDT 2015 - Fixed incorrect ship pricing, which was causing several bugs, including ships being sold, Ships Not Being Removed(tm), etc.
* Also fixed the hangar not being activated. Turned oxp into git repo. (Not on the internet yet.)

### Version 1.14.2
* Fri Jul  3 12:58:53 PDT 2015 - I moved to California, so dates will now be in PDT. 
* I am also updating the changelog format to include version numbers from this point forward.

Older Versions:
-------------------------------------------------------------------------------
- Tue Jun 16 23:28:02 EDT 2015 - Reinstated switch damage, due to annoying
implementation bugs. Added short range chart functionality if target world is
less than or equal to 7.0 LY away. Added intergalactic ordering.
- Mon Jun 15 17:34:06 EDT 2015 - Changed damage so that it happens when sending
and ordering, not switching.
- Sun Jun 14 20:28:05 EDT 2015 - Added galactic chart display to send function.
Added ability to use function keys to switch out of some hangar screens.
(not all)
- Sun Jun 14 12:49:25 EDT 2015 - Added a need to order ahead or wait for ships to
arrive if switching. Selling remains unchanged due to the galactic internet. (or
something) Added possibility of damage if the docked station&#39;s tech level is
below 6. 
- Fri Jun 12 11:54:43 EDT 2015 - Made it so that only stations with shipyards have
the hangar. Fixed changelog typo.
- Wed Jun 10 00:07:37 EDT 2015 - Added messages confirming actions, e.g. selling
a ship. Also fixed a bug with ships selling when they are not supposed to.
Also added spiffy lines to changelog.(Now to write a program MADE from spiffy
lines that adds MORE spiffy lines that do the same thing.)
- Tue Jun  9 22:44:15 EDT 2015 - fixed a ship-won&#39;t-sell bug and added Xenon UI
compatibility
- Tue Jun  9 15:00:36 EDT 2015 - added image of hangar with rotating model of ship
(thanks to Kheng: http://kheng.deviantart.com). Also fixed another storage bug.
- Mon Jun  8 14:56:22 EDT 2015 - added ship removal option and made OXPConfig
optional
- Sun Jun  7 18:49:06 EDT 2015 - fixed ship-non-deletion bug. (hopefully)
- Sun Jun  7 12:11:14 EDT 2015 - rediscovered ship-non-deletion bug. Fixed pricing
bug. (Thanks Day!)
- Fri Jun  5 14:08:11 EDT 2015 - fixed bug where ships would not delete themselves
after not buying anything and moving away from the shipyard interface.
- Wed May 27 16:16:01 EDT 2015 - Updated hangar so that options have to be
activated from OXPConfig. Added OXPConfig as a dependency. Removed accidentally
added .diff files from oxz.
- Fri May 15 14:09:05 EDT 2015 - implemented bug fix from Norby, added
instructions for activating hangar.
- Wed May 13 18:33:33 EDT 2015 - added selling of stored ships and warning
messages for selling ships. also improved code readability.
- Wed May 13 17:59:04 EDT 2015 - added many things, forgot to put them here.
Added a ship storage delay and fee, made those adjustable, and created options
menu. Also added defaults restore option and added displays of the current delay
and price. 
- Sat May  9 20:31:16 EDT 2015 - fixed one-ship-type-only bug, thanks Norby!
Also changed dating system.
- 5/9/15 - updated manifest.plist to include license.
- 5/9/15 - first version.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/hyperhangar.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name           = &quot;HyperspaceHangar&quot;;
this.author         = &quot;Kenji Takashima&quot;;
this.copyright      = &quot;(C) 2015 Kenji Takashima.&quot;;
this.licence        = &quot;CC-BY-NC-SA 3.0&quot;;
this.description    = &quot;Provides a hangar for your ships across the stars.&quot;;
this.version        = &quot;1.17.0&quot;;

this._currentNames = {};
this._shipsStored = {};
this._shipsInTransit = {};
this._currentShip = &quot;&quot;;
this._currentName = &quot;&quot;;
this._currentPortable = [];
this._currentPylonMounted = [];
//Defaults
this._defaultpriceOption = 250000;
this._defaulttimeOption = 1800;
//OXPConfig related options
this._showOptions = false; // show Options in HH mission screen at Station Interfaces?
this._percentPrice = false; // Storage fee is based on ship&#39;s price?
this._shipPercent = 10;
this._shipDepreciation = 0.15; // How much of the ship trade in value we pay
this._allowsCargo = true;
this._svEnabled = false;  // ShipVersion installed?
this._cost = 0;
this._tradeIn = 0;
this._hudHidden;
this._debug = false;

// settings for Library Config
this._hhSettings = {
    Name:   this.name,
    Display:&quot;Settings&quot;,
    Alias:  &quot;Hyperspace Hangar&quot;,
    Alive:  &quot;_hhSettings&quot;,
    Bool: {
        B0: {
            Name:   &quot;_showOptions&quot;,
            Desc:   &quot;Show Options&quot;,
            Def:    false,
        },
        B1: {
            Name:   &quot;_percentPrice&quot;,
            Desc:   &quot;Storage Fee&quot;,
            Def:    false,
            Notify: &quot;$storageFeeChanged&quot;
        },
        Info:   &quot;Show Options - Displays price and time options at HH menu\n&quot;+
                &quot;Storage Fee - true: based on ship &#39;s price, false: flat fee&quot;
    },
    SInt: {
        S0: {
            Name:   &quot;_shipPercent&quot;,
            Desc:   &quot;Storage Fee&quot;,
            Def:    10,
            Min:    1,
            Max:    50,
            Hide:   true
        },
        Info:   &quot;Storage Fee - percent of ship&#39;s price, values from 1 to 50&quot;
    }
};


//
// Event Handlers
//

//---------------------------------------------------------------------------------//
this.startUp = function _HH_startUp() {
    //first time setup
    if (!missionVariables.hyperSpace_namesStored) {
        missionVariables.hyperSpace_namesStored = JSON.stringify({&quot;0_EXIT&quot;: &quot;EMPTY&quot;});
        missionVariables.hyperSpace_shipsStored = JSON.stringify({});
        missionVariables.hyperSpace_shipsInTransit = JSON.stringify({});
        missionVariables.hyperSpace_priceOption = this._defaultpriceOption;
        missionVariables.hyperSpace_timeOption = this._defaulttimeOption;
        missionVariables.hyperSpace_showOptions = 0;
        missionVariables.hyperSpace_percentPrice = 0;
        missionVariables.hyperSpace_shipPercent = 10;
    }
    //mission setup
    if (!missionVariables.hyperSpace_mission) {
        missionVariables.hyperSpace_mission = &quot;NOT_ACTIVATED&quot;;
    }

    //check if ShipVersion is installed (it changes the ship buying screen sequence)
    if (worldScripts.shipversion) this._svEnabled = true;

    //names of ships stored. Used because $shipsStored would give JSON strings
    this._currentNames = JSON.parse(missionVariables.hyperSpace_namesStored);
    if (this._currentNames[&quot;1_EXIT&quot;]) delete this._currentNames[&quot;1_EXIT&quot;];

    //values of ships stored.
    this._shipsStored = JSON.parse(missionVariables.hyperSpace_shipsStored);
    //value sof ships in transit
    if (missionVariables.hyperSpace_shipsInTransit) this._shipsInTransit = JSON.parse(missionVariables.hyperSpace_shipsInTransit);
    this.$cleanUp();


    if (this._debug) {
        log(this.name, &quot;There are &quot;+Object.keys(this._shipsStored).length+&quot; ships stored&quot;);
        for (k in this._currentNames) {
            let name = this._currentNames[k];
            log(this.name, k+&quot;: &quot;+name+&quot;, &quot;+JSON.stringify(this._shipsStored[k]));
        }
    }
    //constants for tests
    this._shipPrice = 0;
    this._actuallyBought = 0;
    this._delay = false;

    //current stored ship value; very important
    this._shipTempKey = null;

    //self explanatory
    this._oldChoice = 0;

    //saved percentPrice option
    this._percentPrice = (missionVariables.hyperSpace_percentPrice == 1 ? true : false);
    this._showOptions = (missionVariables.hyperSpace_showOptions == 1 ? true : false);
    this._shipPercent = (missionVariables.hyperSpace_shipPercent ? missionVariables.hyperSpace_shipPercent : 10);
    this.$storageFeeChanged();

    //current prices and storage time
    this._priceOption = missionVariables.hyperSpace_priceOption;
    this._timeOption = missionVariables.hyperSpace_timeOption;

    //information for the transfer function
    this._oldShips = [];
    this._arrivalTime = {};

    //compatibility with Xenon UI
    var w = worldScripts.XenonUI;
    if (w) w.$addMissionScreenException(&quot;HyperspaceHangar-map&quot;);
    var wx = worldScripts.XenonReduxUI;
    if (wx) wx.$addMissionScreenException(&quot;HyperspaceHangar-map&quot;);
}

//---------------------------------------------------------------------------------//
this.startUpComplete = function _HH_startUpComplete() {
    if (worldScripts.Lib_Config) 
        worldScripts.Lib_Config._registerSet(this._hhSettings);
    this.$dockedCheck();
}

//---------------------------------------------------------------------------------//
this.shipDockedWithStation = function _HH_shipDockedWithStation() {
    this.$dockedCheck();
}

//---------------------------------------------------------------------------------//
this.playerEnteredNewGalaxy = function _HH_playerEnteredNewGalaxy() {
    //mark mission system if in G6 and mission has been given
    if (galaxyNumber === 5 &amp;&amp; missionVariables.hyperSpace_mission === &quot;DELIVER&quot;) {
        mission.markSystem({
            system: 149,
            name: &quot;hyperspaceMission&quot;,
            markerColor: &quot;greenColor&quot;,
            markerScale: 1.5,
            markerShape: &quot;MARKER_DIAMOND&quot;
        });
    }
}

//---------------------------------------------------------------------------------//
this.playerWillSaveGame = function _HH_playerWillSaveGame() {
    this.$cleanUp();
    missionVariables.hyperSpace_namesStored = JSON.stringify(this._currentNames);
    missionVariables.hyperSpace_shipsStored = JSON.stringify(this._shipsStored);
    missionVariables.hyperSpace_shipsInTransit = JSON.stringify(this._shipsInTransit);
    missionVariables.hyperSpace_priceOption = this._priceOption;
    missionVariables.hyperSpace_timeOption = this._timeOption;
    missionVariables.hyperSpace_percentPrice = (this._percentPrice ? 1 : 0);
    missionVariables.hyperSpace_showOptions = (this._showOptions ? 1 : 0);
    missionVariables.hyperSpace_shipPercent = this._shipPercent;
}

//---------------------------------------------------------------------------------//
this.guiScreenChanged = function _HH_guiScreenChanged(to, from) {
    var that = _HH_guiScreenChanged;
    var wsSSH = (that.wsSSH = that.wsSSH || worldScripts[&quot;Ship_Storage_Helper.js&quot;]);
    //store player&#39;s ship if replacement is a possibility.
    if (guiScreen === &quot;GUI_SCREEN_SHIPYARD&quot;) {
        var _ship = player.ship;
        this._shipTempKey = clock.absoluteSeconds;
        this._currentShip = wsSSH.storeCurrentShip(player.ship);
        this._currentName = _ship.displayName;
        this._currentPortable = this.$getPortableEquipment(_ship);
        this._currentPylonMounted = this.$clearPylons(_ship);
        this._shipPrice = _ship.price;
        this._tradeIn = this.$tradeInAmount();
        this._actuallyBought = 1;
    } else {
        //has a ship been bought?
        if (from == &quot;GUI_SCREEN_SHIPYARD&quot; &amp;&amp; clock.isAdjusting) {
            this._delay = true;
            return;
        } else if (this._delay == false &amp;&amp; this._actuallyBought == 1) {
            this.$reinstatePylons(player.ship, this._currentPylonMounted);
            this.$clearStoredShip();
        }
        this._actuallyBought = 0;
    }
}

//---------------------------------------------------------------------------------//
this.playerBoughtNewShip = function _HH_playerBoughtNewShip(ship, price) {
    // if ShipVersion is installed this event handler is ineffective: HyperspaceHangar mission screen 
    // will be interrupted by ShipVersion&#39;s
    if (this._svEnabled) return;
    // factored the ship storing offer into a separated function so ShipVersion can call it if the 
    // player confirms the acquisition of the new ship
    this.$offerOldShipStorage(ship, price);
}



//
// Internal Functions
//

//---------------------------------------------------------------------------------//
this.$printShipsInTransit = function _HH_printShipsInTransit(max_ships) {
    var currentNames = this._currentNames;
    var shipsStored = this._shipsStored;
    var shipsInTransit = this._shipsInTransit;
    var arrival_times = Object.getOwnPropertyNames(shipsInTransit).sort();
    var msg = &quot;&quot;;
    var k, s;
    var now = clock.seconds;
    if (arrival_times.length == 0) return &quot;&quot;;
    msg += &quot;Ships in Transit\n\n&quot;;
    for (var i=0; i&lt;max_ships &amp;&amp; i&lt;arrival_times.length; i++) {
        k = arrival_times[i];
        log(this.name, &quot;Ship in transit arriving at &quot;+k+&quot;: &quot;+shipsInTransit[k]);
        s = JSON.parse(shipsInTransit[k]);
        msg += currentNames[k]+&quot; in transit to &quot;+s[0][4]+&quot;/G&quot;+s[0][0]+1+&quot;, arriving in &quot;+((k-now)/3600).toFixed(2)+&quot; hours\n&quot;;
    }
    return msg
}

//---------------------------------------------------------------------------------//
this.$storageFeeChanged = function _HH_storageFeeChanged() {
    this._hhSettings.SInt.S0.Hide = !this._percentPrice;
}

//---------------------------------------------------------------------------------//
this.$getPortableEquipment = function _HH_getPortableEquipment(ship) {
    var portable_eqs = [];
    var eqList = ship.equipment;
    var i = eqList.length;
    var eqInfo, eqKey;
    while (i--) {
        eqInfo = eqList[i];
        if (eqInfo.isPortableBetweenShips)
            portable_eqs.push(eqInfo.equipmentKey);
    }
    return portable_eqs;
}

//---------------------------------------------------------------------------------//
this.$clearPylons = function _HH_clearPylons(ship) {
    var pylon_mounted = [];
    var missiles = ship.missiles;
    var i;

    if (ship.missileCapacity &gt; 0) {
        for (i = 0; i &lt; missiles.length; i++) 
            pylon_mounted.push(missiles[i].equipmentKey);
    }
    i = missiles.length;
    while (i--) ship.removeEquipment(missiles[i].equipmentKey);

    if (this._debug) log(this.name, &quot;Cleared ship&#39;s pylons of &quot;+pylon_mounted);
    return pylon_mounted;
}

//---------------------------------------------------------------------------------//
this.$reinstatePylons = function _HH_reinstatePylons(ship, missiles) {
    for (var i = 0; i &lt; missiles.length; i++)
        ship.awardEquipment(missiles[i]);
    if (this._debug &amp;&amp; missiles.length &gt; 0) log(this.name, &quot;Reinstated ship&#39;s pylons with &quot;+missiles);
}

//---------------------------------------------------------------------------------//
this.$clearStoredShip = function _HH_clearStoredShip() {
    this._delay = false;
    this._shipTempKey = null;
    this._currentShip = &quot;&quot;;
    this._currentName = &quot;&quot;;
    this._currentPortable.length = 0;
    this._currentPylonMounted.length = 0;
}

//---------------------------------------------------------------------------------//
this.$dockedCheck = function _HH_dockedCheck() {
    //create hangar interface if docked and available. remove it otherwise
    var _ship = player.ship;

    if (_ship.docked &amp;&amp; _ship.dockedStation.hasShipyard) {
        _ship.dockedStation.setInterface(this.name, {
            title: &quot;Hyperspace Hangar&quot;,
            category: &quot;Services&quot;,
            summary: &quot;Provides access to ship storage facilities.&quot;,
            callback: this.$storeShips.bind(this)
        });
    } else {
        _ship.dockedStation.setInterface(this.name, null);
    }
    this.$checkShipArrivals();
}

//---------------------------------------------------------------------------------//
this.$offerOldShipStorage = function _HH_offerOldShipStorage(ship, price) {
    // can&#39;t use stored player credit amount and price to set player credits,
    // because this doesn&#39;t take the trade-in value into account
    // the displayed trade in amount appears to be
    //            Math.round((player.ship.price * (player.ship.serviceLevel / 100) * 0.75) / 1000, 0) * 1000
    // however, (this._playerCredit + tradeInValue) - price still doesn&#39;t reflect actual calculated values
    // must also include sale price of any cargo, but only cargo that was able to be offloaded onto the station&#39;s market

    // that said, we do need to take away the trade in value from the player if they store the ship, otherwise it&#39;s free money
    this._cost = 0;
    if (this._percentPrice == true) {
        this._cost = (this._shipPrice * (this._shipPercent * 0.01)); //Credits
    } else if (missionVariables.hyperSpace_mission != &quot;COMPLETE&quot;) {
        this._cost = this._priceOption * 0.1; //Credits
    } else {
        this._cost = this._priceOption * 0.05; //Credits
    }
    // we can only offer to store if the player would have enough remaining cash after the trade in amount is removed
    if ((player.credits - this._tradeIn) &gt;= this._cost &amp;&amp; this._actuallyBought == 1) {
        if (this._debug) log(this.name, &quot;percent fee? &quot;+this._percentPrice+&quot;, ship full price: &quot;+formatCredits(this._shipPrice, true, true)+&quot;, percent fee: &quot;+this._shipPercent+&quot;%, flat fee: &quot;+formatCredits(this._priceOption/10, true, true)+&quot; actual fee: &quot;+formatCredits(this._cost, true, true));
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + JSON.parse(this._currentShip)[1] + &quot;]&quot;,
                modelPersonality: JSON.parse(this._currentShip)[13],
                spinModel: true,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Would you like to store your ship?&quot;,
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
                choicesKey: &quot;hyperSpace_askstore&quot;
            },
            this.$askStore, this);
            // the ship storing fee was calculated at the beginning of the function
            mission.addMessageText(&quot;Current price: &quot; + formatCredits(this._cost, true, true));
            mission.addMessageText(&quot;Current storage time: &quot; + (this._timeOption / 60).toFixed(1) + &quot; minutes&quot;);
    } else {
        // not enough credits
        this.$reinstatePylons(player.ship, this._currentPylonMounted);
        this.$clearStoredShip();
    }
    this._actuallyBought = 0;
}

//---------------------------------------------------------------------------------//
this.$askStore = function _HH_askStore(choice) { 
    if (choice == &quot;1_STORE&quot;) {
        var key = clock.absoluteSeconds;
        var shipinfo2 = JSON.stringify(data);
        // take away the trade-in amount if we&#39;re storing the ship
        // the storing fee (this._cost) was calculated before offering the storing option
        if (player.credits - this._tradeIn &gt;= this._cost) {
            player.credits -= this._tradeIn;
            if (!this._allowsCargo) {
                var wsSTH = worldScripts[&quot;Ship_Storage_Helper.js&quot;];
                var data;
                if (wsSTH.storeCurrentShipToArray)
                    data = wsSTH.storeCurrentShipToArray(player.ship);
                else {
                    let shipinfo = wsSTH.storeCurrentShip(player.ship);
                    data = JSON.parse(shipinfo);
                }
                this.$removeCargo(data);
                this._currentShip = JSON.stringify(data);
            }
            this._shipsStored[this._shipTempKey] = this._currentShip;
            this._currentNames[this._shipTempKey] = this._currentName;
            log(&quot;HyperspaceHangar&quot;, &quot;Stored ship &quot; + this._currentNames[this._shipTempKey]);
            player.consoleMessage(&quot;Stored &quot; + this._currentNames[this._shipTempKey] + &quot;.&quot;);
            // remove portable equipment from new ship 
            log(this.name, &quot;Removing portable equipment from new ship: &quot;+this._currentPortable);
            var _ship = player.ship;
            var i = this._currentPortable.length;
            while (i--) _ship.removeEquipment(this._currentPortable[i]);
            //activate hangar
            this._currentNames[&quot;0_EXIT&quot;] = &quot;Exit&quot;;
            player.credits -= this._cost;
            clock.addSeconds(this._timeOption);
            this.$dockedCheck();
        }
        else {
            log(&quot;HyperspaceHangar&quot;, &quot;Player doesn&#39;t have enough credits for the fee&quot;);
            this.$reinstatePylons(player.ship, this._currentPylonMounted) 
        }
    } else {
        this.$reinstatePylons(player.ship, this._currentPylonMounted) 
    }
    this.$clearStoredShip();
}

//---------------------------------------------------------------------------------//
this.$removeCargo = function _HH_removeCargo(shipDataArray) {
    log(this.name, &quot;Removing cargo and passageners from &quot;+shipDataArray[0][3]+&quot; before storing in Hyperspace Hangar&quot;);
    shipDataArray[8].length = 0; // cargo bay
    shipDataArray[10].length = 0; // passengers
    shipDataArray[15] = null; // new cargoes manifest
    shipDataArray[16] = null; // HyperCargo
    shipDataArray[17] = null; // Vortex
    shipDataArray[31] = shipDataArray[32] = &quot;&quot;; // smuggler compartment
}

//---------------------------------------------------------------------------------//
this.$storeShips = function _HH_storeShips() {
    log(this.name,&quot;_HH_storeShips&quot;);
    this.$checkShipArrivals();
    var msg = this.$printShipsInTransit(12);
    //are options available?
    if (this._showOptions == false) {
        if (this._oxpConf_check != false) {
            player.consoleMessage(&quot;Options are available through OXPConfig.&quot;);
        } else if (this._libConf_check != false) {
            player.consoleMessage(&quot;Options are available through Library Config.&quot;);
        } else {
            player.consoleMessage(&quot;OXPConfig and Library Config not enabled/installed. Cannot provide options.&quot;);
        }
    }
    //deactivate hangar if empty
    if (Object.keys(this._currentNames) == &quot;0_EXIT&quot;) {
        this._currentNames[&quot;0_EXIT&quot;] = &quot;EMPTY&quot;;
    }
    //offer mission
    if (galaxyNumber == 2 &amp;&amp; missionVariables.hyperSpace_mission == &quot;NOT_ACTIVATED&quot;) {
        missionVariables.hyperSpace_mission = &quot;ACTIVATED&quot;
    }
    //not activated unless another ship is bought
    if (this._currentNames[&quot;0_EXIT&quot;] == &quot;EMPTY&quot;) {
        if (this._showOptions == false) {
            player.consoleMessage(&quot;You must purchase an additional ship in order to use the hangar.&quot;);
        } else {
            mission.runScreen({
                    screenID: &quot;HyperspaceHangar&quot;,
                    background: {
                        name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                        height: 480
                    },
                    allowInterrupt: true,
                    title: &quot;Hyperspace Hangar&quot;,
                    message: &quot;No ships stored.&quot;,
                    exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                    choicesKey: &quot;hyperSpace_notstored&quot;
                },
                this.$noneStored, this);
            mission.addMessageText(&quot;You must purchase an additional ship in order to use the hangar.&quot;);
        }
    }
    //no options
    else if (this._showOptions == false) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: msg+&quot;\nChoose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_nooptions&quot;
            },
            this.$choice, this);
    }
    //options
    else {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: msg+&quot;\nChoose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_choices&quot;
            },
            this.$choice, this);
    }
}


//---------------------------------------------------------------------------------//
this.$localizeShips = function _HH_localizeShips() {
    var systemID = system.ID;
    var currentNames = this._currentNames;
    var shipsStored = this._shipsStored;
    var shipsInTransit = this._shipsInTransit;
    var k, ship;

    this._inStationNames = {};
    this._otherStationNames = {};
    this._inTransitNames = {};
    log(this.name, &quot;current system: &quot;+System.systemNameForID(systemID)+&quot;(G&quot;+(galaxyNumber+1)+&quot;/&quot;+systemID+&quot;)&quot;);
    for (k in currentNames) {
        if (k != &quot;0_EXIT&quot;) {
            if (k in shipsStored) {
                ship = JSON.parse(shipsStored[k]);
                if (systemID == ship[0][1]) {
                    this._inStationNames[k] = currentNames[k];
                    if (this._debug) log(this.name, k+&quot;: Ship &quot;+currentNames[k]+&quot; in current system (&quot;+ship[0][1]+&quot;)&quot;);
                } else {
                    this._otherStationNames[k] = &quot;(in &quot; +ship[0][4] + &quot;/G&quot;+formatInteger(ship[0][0]+1)+&quot;) &quot; + currentNames[k];
                    if (this._debug) log(this.name, k+&quot;: Ship &quot;+currentNames[k]+&quot; in &quot;+ship[0][4]+&quot; (&quot;+ship[0][1]+&quot;/G&quot;+ship[0][0]+1+&quot;)&quot;);
                }
            } else if (k in shipsInTransit) {
                this._inTransitNames[k] = currentNames[k];
                if (this._debug) log(this.name, k+&quot;: Ship &quot;+currentNames[k]+&quot; in transit&quot;);
            } else {
                log(this.name, currentNames[k]+&quot; not found in stored or in transit ships, removing&quot;);
                delete currentNames[k];
            }
        }
    }
    if (this._debug) {
        log(this.name, &quot;Ships in system: &quot;+JSON.stringify(this._inStationNames));
        log(this.name, &quot;Ships in other systems: &quot;+JSON.stringify(this._otherStationNames));
        log(this.name, &quot;Ships in transit: &quot;+JSON.stringify(this._inTransitNames));
    }
}

//---------------------------------------------------------------------------------//
//menu function, used for almost every main menu, exepting no ships
this.$choice = function _HH_choice(choice) {
    var parameters;

    log(this.name,&quot;_HH_choice: &quot;+choice);
    this.$localizeShips();
    if (choice == &quot;GARAGE_1_SWITCH&quot;) {
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false, 
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose a ship:&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: this._inStationNames
        };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$choice_switch, this, true);
        mission.addMessageText(&quot;Current storage time: &quot; + (this._timeOption / 60) + &quot; minutes&quot;);
    } else if (choice == &quot;GARAGE_2_SELL&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_sellChoices&quot;
            },
            this.$choice_sell, this);
        mission.addMessageText(&quot;WARNING: ALL SOLD SHIPS WILL BE PERMANENTLY LOST.&quot;);
    } else if (choice == &quot;GARAGE_3_TRANSFER&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_transferChoices&quot;
            },
            this.$choice_transfer, this);
    } else if (choice == &quot;GARAGE_4_OPTIONS&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_options&quot;
            },
            this.$choice_options, this);
        mission.addMessageText(&quot;Current selling time: &quot; + (this._timeOption / 60) + &quot; minutes&quot;);
        mission.addMessageText(&quot;Current value: &quot; + formatCredits(this._priceOption * 0.1, true, true));
    } else if (choice == &quot;GARAGE_5_INFO&quot;) {
        //&quot;normal&quot; info screen
        if (missionVariables.hyperSpace_mission != &quot;COMPLETED&quot;) {
            mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                title: &quot;Station Database: Norby-Ramen Quirium Accuracy Drive&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                messageKey: &quot;hyperSpace_QAD&quot;
            });
        }
        //complete info screen
        else if (missionVariables.hyperSpace_mission == &quot;COMPLETED&quot;) {
            mission.runScreen({
                    screenID: &quot;HyperspaceHangar&quot;,
                    title: &quot;Station Database: Norby-Ramen Quirium Accuracy Drive&quot;,
                    messageKey: &quot;hyperSpace_QAD_authorized&quot;,
                    exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                    choicesKey: &quot;hyperSpace_QAD_nextPage&quot;
                },
                this.$info_next_page, this);
        }
    }
}

//---------------------------------------------------------------------------------//
this.$choice_switch = function _HH_choice_switch(choice) {
    //give chance to exit. ditto for sell function.
    log(this.name,&quot;choice: &quot;+choice);
    if ([&quot;Z99_EXIT&quot;,&quot;0_EXIT&quot;,&quot;99_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    } else if (system.ID != JSON.parse(this._shipsStored[choice])[0][1]) {
        player.consoleMessage(&quot;Ship not in hangar. Transfer ship first to switch.&quot;);
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    //confirm choice with possible damage
    if (player.ship.dockedStation.equivalentTechLevel &lt; 6 &amp;&amp; missionVariables.hyperSpace_mission != &quot;COMPLETE&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + JSON.parse(this._shipsStored[choice])[1] + &quot;]&quot;,
                modelPersonality: JSON.parse(this._shipsStored[choice])[13],
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Transferring at the currently docked station may be damaging. Continue anyway?&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_damage, this);
    }
    //confirm choice
    else {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + JSON.parse(this._shipsStored[choice])[1] + &quot;]&quot;,
                modelPersonality: JSON.parse(this._shipsStored[choice])[13],
                spinModel: true,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Switch ship to &quot; + this._currentNames[choice] + &quot;?&quot;,
                exitScreen: &quot;GUI_SCREEN_STATUS&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_switch, this);
    }
}


//sell menus
//---------------------------------------------------------------------------------//
this.$choice_sell = function _HH_choice_sell(choice) {
    var parameters;
    log(this.name,&quot;_HH_choice_sell: &quot;+choice);
    if (choice == &quot;1_SELLCURRENT&quot;) {
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose a ship to switch into after the sale.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: this._inStationNames
            };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$choice_sell_sub1, this, true);
    } else if (choice == &quot;2_SELLSTORED&quot;) {
        var ships = {};
        var s;
        for (s in this._inStationNames) 
            ships[s] = &quot;(in current system) &quot;+this._inStationNames[s];
        for (s in this._otherStationNames)
            ships[s] = this._otherStationNames[s];
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose a ship to sell.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: ships
            };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$choice_sell_sub2, this, true);
    }
}

//---------------------------------------------------------------------------------//
this.$choice_sell_sub1 = function _HH_choice_sell_sub1(choice) {
    //don&#39;t sell your options!
    if ([&quot;Z99_EXIT&quot;,&quot;0_EXIT&quot;,&quot;99_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    mission.runScreen({
            screenID: &quot;HyperspaceHangar&quot;,
            model: &quot;[&quot; + player.ship.dataKey + &quot;]&quot;,
            modelPersonality: player.ship.entityPersonality,
            spinModel: true,
            background: {
                name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                height: 480
            },
            title: &quot;Hyperspace Hangar&quot;,
            message: &quot;Sell &quot; + player.ship.displayName + &quot;?&quot;,
            exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
            choicesKey: &quot;hyperSpace_confirm&quot;
        },
        this.$choice_confirm_sell1, this);
}

//---------------------------------------------------------------------------------//
this.$choice_sell_sub2 = function _HH_choice_sell_sub2(choice) {
    log(this.name,&quot;_HH_choice_sell_sub2: &quot;+choice);
    //don&#39;t sell your options!
    if ([&quot;Z99_EXIT&quot;,&quot;0_EXIT&quot;,&quot;99_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    mission.runScreen({
            screenID: &quot;HyperspaceHangar&quot;,
            model: &quot;[&quot; + JSON.parse(this._shipsStored[choice])[1] + &quot;]&quot;,
            modelPersonality: JSON.parse(this._shipsStored[choice])[13],
            spinModel: true,
            background: {
                name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                height: 480
            },
            allowInterrupt: true,
            title: &quot;Hyperspace Hangar&quot;,
            message: &quot;Sell &quot; + this._currentNames[choice] + &quot;?&quot;,
            exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
            choicesKey: &quot;hyperSpace_confirm&quot;
        },
        this.$choice_confirm_sell2, this);
}

//transfer menu
//---------------------------------------------------------------------------------//
this.$choice_transfer = function _HH_choice_transfer(choice) {
    var parameters;
    if (choice == &quot;1_SEND&quot;) {
        var ships = {};
        var s;
        for (s in this._inStationNames) 
            ships[s] = &quot;(in current system &quot;+this._inStationNames[s];
        for (s in this._otherStationNames) 
            ships[s] = this._otherStationNames[s];
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose a ship to send to the location currently marked on the map: &quot; + System.systemNameForID(player.ship.targetSystem) + &quot;.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: ships
            };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$choice_transfer_send, this, true);
    } else if (choice == &quot;2_ORDER&quot;) {
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Have a ship sent to the current docked station.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: this._otherStationNames
            };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$choice_transfer_order, this, true);
    }
}

//---------------------------------------------------------------------------------//
this.$choice_transfer_send = function _HH_choice_transfer_send(choice) {
    if ([&quot;Z99_EXIT&quot;,&quot;99_EXIT&quot;,&quot;0_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    this._oldShips = JSON.parse(this._shipsStored[choice]);
    //redundancy check
    if (player.ship.targetSystem == JSON.parse(this._shipsStored[choice])[0][1]) {
        player.consoleMessage(&quot;Your ship is already at the selected system.&quot;);
        this.$storeShips();
        return;
    }
    //galaxy consistency check
    else if (this._oldShips[0][0] != galaxyNumber) {
        player.consoleMessage(&quot;Your ship is in another galaxy. Please order instead.&quot;);
        this.$storeShips();
        return;
    }
    this.$hudHidden = player.ship.hudHidden;
    player.ship.hudHidden = true;
    //is the short range chart usable?
    if (System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).distanceToSystem(System.infoForSystem(galaxyNumber, player.ship.targetSystem)) &lt;= 7.0 &amp;&amp;
        this._oldShips[0][0] == galaxyNumber) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar-map&quot;,
                model: &quot;[&quot; + this._oldShips[1] + &quot;]&quot;,
                modelPersonality: this._oldShips[13],
                spinModel: true,
                backgroundSpecial: &quot;SHORT_RANGE_CHART&quot;,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTransfer &quot; + this._currentNames[choice] + &quot; from &quot; + JSON.parse(this._shipsStored[choice])[0][4] + &quot; to &quot; +
                    System.infoForSystem(galaxyNumber, player.ship.targetSystem).name + &quot;?&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_transfer_send, this);
    }
    //what mode is the map in?
    else {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar-map&quot;,
                model: &quot;[&quot; + this._oldShips[1] + &quot;]&quot;,
                modelPersonality: this._oldShips[13],
                spinModel: true,
                backgroundSpecial: (player.ship.routeMode != &quot;OPTIMIZED_BY_TIME&quot; ? &quot;LONG_RANGE_CHART_SHORTEST&quot; : &quot;LONG_RANGE_CHART_QUICKEST&quot;),
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTransfer &quot; + this._currentNames[choice] + &quot; from &quot; + JSON.parse(this._shipsStored[choice])[0][4] + &quot; to &quot; +
                    System.infoForSystem(galaxyNumber, player.ship.targetSystem).name + &quot;?&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_transfer_send, this);
    } 
    mission.addMessageText(&quot;Transfer price: &quot; +
        formatCredits(System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).routeToSystem(System.infoForSystem(galaxyNumber, player.ship.targetSystem)).distance * 90, true, true)+&quot;   Transfer time: &quot;+System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).routeToSystem(System.infoForSystem(galaxyNumber, player.ship.targetSystem, player.ship.routeMode)).time.toFixed(1)+&quot; hours&quot;);
}

//---------------------------------------------------------------------------------//
this.$choice_transfer_order = function _HH_choice_transfer_order(choice) {
    if ([&quot;Z99_EXIT&quot;,&quot;99_EXIT&quot;,&quot;0_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    this._oldShips = JSON.parse(this._shipsStored[choice]);
    //redundancy check
    if (this._oldShips[0][1] == system.ID) {
        player.consoleMessage(&quot;Ship already present.&quot;);
        this.$storeShips();
        return;
    }
    //intergalactic order 
    else if (this._oldShips[0][0] != galaxyNumber) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + this._oldShips[1] + &quot;]&quot;,
                modelPersonality: this._oldShips[13],
                spinModel: true,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Transfer &quot; + this._currentNames[choice] + &quot; to Galaxy &quot; + (galaxyNumber + 1) + &quot;?&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_transfer_order_interGalactic, this);
        mission.addMessageText(&quot;Current location: &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name);
        mission.addMessageText(&quot;Current order cost: &quot; + formatCredits(Math.abs(galaxyNumber - this._oldShips[0][0]) * 1000, true, true));
        mission.addMessageText(&quot;Current shipping time: &quot; + Math.abs(galaxyNumber - this._oldShips[0][0]) * 72 + &quot; hours&quot;);
    }
    //regular order
    else {
        var fee = system.info.routeToSystem(System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]), player.ship.routeMode).distance * 90;
        var message;
        if (fee &lt;= player.credits) {
            mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + this._oldShips[1] + &quot;]&quot;,
                modelPersonality: this._oldShips[13],
                spinModel: true,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_confirm&quot;
            },
            this.$choice_confirm_transfer_order, this);
            message = &quot;Transfer &quot; + this._currentNames[choice] + &quot; to &quot; + system.name + &quot;?&quot;;
        } else {
            mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                model: &quot;[&quot; + this._oldShips[1] + &quot;]&quot;,
                modelPersonality: this._oldShips[13],
                spinModel: true,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                title: &quot;Hyperspace Hangar&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_order&quot;
            },
            this.$choice_transfer, this);
            message = &quot;Insufficient funds for transfer!&quot;;
        }
        mission.addMessageText(&quot;Current location: &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name);
        mission.addMessageText(&quot;Current order cost: &quot; + formatCredits(fee, true, true));
        mission.addMessageText(&quot;Current shipping time: &quot; + system.info.routeToSystem(System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]), player.ship.routeMode).time.toFixed(0) + &quot; hours\n&quot;);
         mission.addMessageText(message); 
    }
}

//---------------------------------------------------------------------------------//
this.$choice_options = function _HH_choice_options(choice) {
    if (choice == &quot;1_PRICE&quot;) {
        if (this._percentPrice == true) {
            player.consoleMessage(&quot;Standard pricing disabled. Check &quot; + this._configType + &quot;. Current value: &quot; + this._shipPercent * 10 + &quot;%.&quot;);
        } else {
            mission.runScreen({
                    screenID: &quot;HyperspaceHangar&quot;,
                    background: {
                        name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                        height: 480
                    },
                    allowInterrupt: true,
                    title: &quot;Hyperspace Hangar&quot;,
                    message: &quot;Input price&quot;,
                    exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                    textEntry: &quot;TRUE&quot;
                },
                this.$choice_price, this);
            mission.addMessageText(&quot;Current value: &quot; + formatCredits(this._priceOption / 10, true, true));
        }
    } else if (choice == &quot;2_TIME&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Input time (in seconds)&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                textEntry: &quot;TRUE&quot;
            },
            this.$choice_time, this);
        mission.addMessageText(&quot;Current value: &quot; + (this._timeOption / 60) + &quot; minutes&quot;);
    } else if (choice == &quot;3_RESET&quot;) {
        this._priceOption = this._defaultpriceOption;
        this._timeOption = this._defaulttimeOption;
    }
    //removes ships entirely
    else if (choice == &quot;4_PURGE&quot;) {
        var _ships = {};
        var s;
        for (s in this._inStationNames)
            _ships[s] = &quot;(in current system) &quot;+this._inStationNames[s];
        for (s in this._otherStationNames)
            _ships[s] = this._otherStationNames[s];
        parameters = {
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: false,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose ship to remove. WARNING: REMOVAL IS PERMANENT!&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choices: _ships
            };
        worldScripts[&quot;Paginated Screen&quot;].$runScreen(parameters, this.$purge, this, true);
    }
}

//---------------------------------------------------------------------------------//
this.$choice_price = function _HH_choice_price(choice) {
    this._priceOption = choice * 10;
}

//---------------------------------------------------------------------------------//
this.$choice_time = function _HH_choice_time(choice) {
    this._timeOption = choice;
}

//---------------------------------------------------------------------------------//
this.$purge = function _HH_purge(choice) {
    if ([&quot;Z99_EXIT&quot;,&quot;99_EXIT&quot;,&quot;0_EXIT&quot;].indexOf(choice) &gt; -1) {
        this.$storeShips();
        return;
    }
    this._oldChoice = choice;
    mission.runScreen({
            screenID: &quot;HyperspaceHangar&quot;,
            model: &quot;[&quot; + JSON.parse(this._shipsStored[choice])[1] + &quot;]&quot;,
            modelPersonality: JSON.parse(this._shipsStored[choice])[13],
            spinModel: true,
            background: {
                name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                height: 480
            },
            title: &quot;Hyperspace Hangar&quot;,
            message: &quot;Remove &quot; + this._currentNames[choice] + &quot;?&quot;,
            choicesKey: &quot;hyperSpace_confirm&quot;
        },
        this.$choice_confirm_purge, this);
}

//menu for no ships
//---------------------------------------------------------------------------------//
this.$noneStored = function _HH_noneStored(choice) {
    if (choice == &quot;1_OPTIONS&quot;) {
        mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                background: {
                    name: &quot;launch_bay_wip5_by_kheng-d7fmvuj.png&quot;,
                    height: 480
                },
                allowInterrupt: true,
                title: &quot;Hyperspace Hangar&quot;,
                message: &quot;Choose an option.&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                choicesKey: &quot;hyperSpace_options&quot;
            },
            this.$choice_options, this);
    } else if (choice == &quot;2_INFO&quot;) {
        if (missionVariables.hyperSpace_mission != &quot;COMPLETED&quot;) {
            mission.runScreen({
                screenID: &quot;HyperspaceHangar&quot;,
                title: &quot;Station Database: Norby-Ramen Quirium Accuracy Drive&quot;,
                exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                messageKey: &quot;hyperSpace_QAD&quot;
            });
        } else if (missionVariables.hyperSpace_mission == &quot;COMPLETED&quot;) {
            mission.runScreen({
                    screenID: &quot;HyperspaceHangar&quot;,
                    title: &quot;Station Database: Norby-Ramen Quirium Accuracy Drive&quot;,
                    messageKey: &quot;hyperSpace_QAD_authorized&quot;,
                    exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
                    choices: ({
                        &quot;1_NEXT&quot;: &quot;Next page&quot;
                    })
                },
                this.$info_next_page, this);
        }
    }
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_switch = function _HH_choice_confirm_switch(choice) {
    if (choice == &quot;1_YES&quot;) {
        //switch ships
        var wsSTH = worldScripts[&quot;Ship_Storage_Helper.js&quot;];
        var hud = player.ship.hud;
        var credits = player.credits;
        var data;
        if (wsSTH.storeCurrentShipToArray)
            data = wsSTH.storeCurrentShipToArray(player.ship);
        else {
            let shipinfo = wsSTH.storeCurrentShip(player.ship);
            data = JSON.parse(shipinfo);
        }
        if (!this._allowsCargo) this.$removeCargo(data);
        var key = clock.absoluteSeconds;
        this._shipsStored[key] = JSON.stringify(data);
        this._currentNames[key] = player.ship.displayName;
        log(this.name, &quot;Saving player ship &quot;+this._currentNames[key]+&quot;: &quot;+this._shipsStored[key]);
        if (this._svEnabled) { worldScripts.shipversion.$hyperspaceHangarRestoredShip = true; }
        try {
            worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(this._shipsStored[this._oldChoice]);
        } catch (err) {
            log(this.name, &quot;!!ERROR: &quot; + err);
        }
        player.credits = credits;
        player.ship.hud = hud;

        //don&#39;t keep switched ship stored!
        player.consoleMessage(&quot;Switched ship to &quot; + this._currentNames[this._oldChoice] + &quot;.&quot;);
        delete this._shipsStored[this._oldChoice];
        delete this._currentNames[this._oldChoice];
        this._oldChoice = &quot;&quot;;
        clock.addSeconds(this._timeOption);
    } else this.$storeShips();
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_damage = function _HH_choice_confirm_damage(choice) {
    if (choice == &quot;1_YES&quot;) {
        //switch ships
        var wsSTH = worldScripts[&quot;Ship_Storage_Helper.js&quot;];
        var hud = player.ship.hud;
        var credits = player.credits;
        var data;
        if (wsSTH.storeCurrentShipToArray)
            data = wsSTH.storeCurrentShipToArray(player.ship);
        else {
            let shipinfo = wsSTH.storeCurrentShip(player.ship);
            data = JSON.parse(shipinfo);
        }
        if (!this._allowsCargo) this.$removeCargo(data);
        var key = clock.absoluteSeconds;
        var shipinfo2 = JSON.stringify(data);
        this._shipsStored[key] = shipinfo2;
        this._currentNames[key] = player.ship.displayName;
        if (this._svEnabled) { worldScripts.shipversion.$hyperspaceHangarRestoredShip = true; }
        try {
            worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(this._shipsStored[this._oldChoice]);
        } catch (err) {
            log(this.name, &quot;!!ERROR: &quot; + err);
        }
        player.credits = credits;
        player.ship.hud = hud;

        //don&#39;t keep switched ship stored!
        player.consoleMessage(&quot;Switched ship to &quot; + this._currentNames[this._oldChoice] + &quot;.&quot;);
        delete this._shipsStored[this._oldChoice];
        delete this._currentNames[this._oldChoice];
        this._oldChoice = &quot;&quot;;
        clock.addSeconds(this._timeOption);

        //possibly damage ship
        if (player.ship.takeInternalDamage() === true) {
            player.consoleMessage(&quot;Ship damaged during switch.&quot;);
        }
    } else this.$storeShips();
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_sell1 = function _HH_choice_confirm_sell1(choice) {
    log(this.name, &quot;_HH_choice_confirm_sell1: &quot;+choice);
    if (choice == &quot;1_YES&quot;) {
        //&quot;sell&quot; ship
        var hud = player.ship.hud;
        var cost = this._shipDepreciation * this.$tradeInAmount();
        var old_name = player.ship.displayName;
        player.credits += cost;
        try {
            worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(this._shipsStored[this._oldChoice]);
        } catch (err) {
            log(this.name, &quot;!!ERROR: &quot; + err);
        }
        player.ship.hud = hud;
        player.consoleMessage(&quot;Sold &quot; + old_name + &quot; for &quot; + formatCredits(cost, false, true) + &quot;.&quot;);
        log(this.name, &quot;Sold  &quot; + old_name + &quot; for &quot; + formatCredits(cost, false, true) + &quot;.&quot;);
        delete this._shipsStored[this._oldChoice];
        delete this._currentNames[this._oldChoice];
        this._oldChoice = &quot;&quot;;
        this.$localizeShips();
        clock.addSeconds(this._timeOption);
    } else this.$storeShips();
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_sell2 = function _HH_choice_confirm_sell2(choice) {
    log(this.name, &quot;_HH_choice_confirm_sell2: &quot;+choice);
    if (choice == &quot;1_YES&quot;) {
        //store ship
        var hud = player.ship.hud;
        //this._shipTempKey = clock.absoluteSeconds;
        var holdShip = worldScripts[&quot;Ship_Storage_Helper.js&quot;].storeCurrentShip(player.ship);
        
        //reload ship for pricing
        if (worldScripts.ShipConfiguration_Core) {
            worldScripts.ShipConfiguration_Core._resprayActive = true;
            worldScripts.ShipConfiguration_Core._adding = true;
        }
        try {
            worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(this._shipsStored[this._oldChoice]);
            var cost = this._shipDepreciation * this.$tradeInAmount();
            player.credits += cost;
            player.consoleMessage(&quot;Sold &quot; + this._currentNames[this._oldChoice] + &quot; for &quot; + formatCredits(cost, false, true) + &quot;.&quot;);
            log(this.name, &quot;Sold  &quot; + this._currentNames[this._oldChoice] + &quot; for &quot; + formatCredits(cost, false, true) + &quot;.&quot;);
            delete this._shipsStored[this._oldChoice];
            delete this._currentNames[this._oldChoice];
            this._oldChoice = &quot;&quot;;
            this.$localizeShips();

            //reload original ship
            try {
                worldScripts[&quot;Ship_Storage_Helper.js&quot;].restoreStoredShip(holdShip);
                if (worldScripts.ShipConfiguration_Core) {
                    worldScripts.ShipConfiguration_Core._resprayActive = false;
                    worldScripts.ShipConfiguration_Core._adding = false;
                }
                player.ship.hud = hud;
                this._confirm = false;
            } catch (err) {
                log(this.name, &quot;!!ERROR reloading player ship: &quot; + err);
            }
        } catch (err) {
            log(this.name, &quot;!!ERROR loading ship to sell: &quot; + err);
        }
    } 
    this.$choice_sell(&quot;2_SELLSTORED&quot;);
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_transfer_send = function _HH_choice_confirm_transfer_send(choice) {
    if (choice == &quot;1_YES&quot;) {
        var fee = (System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).routeToSystem(System.infoForSystem(galaxyNumber, player.ship.targetSystem, player.ship.routeMode)).distance * 90);
        if (fee &lt;= player.credits) {
            var transit_time = System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).routeToSystem(System.infoForSystem(galaxyNumber, player.ship.targetSystem, player.ship.routeMode)).time
            var arrival_time = clock.seconds + transit_time * 3600;
            this._oldShips = JSON.parse(this._shipsStored[this._oldChoice]);
            //subtract money
            player.credits -= fee;
            //change values
            this._oldShips[0][0] = galaxyNumber;
            this._oldShips[0][1] = player.ship.targetSystem;
            this._oldShips[0][4] = System.infoForSystem(galaxyNumber, player.ship.targetSystem).name;
            this._shipsInTransit[arrival_time] = JSON.stringify(this._oldShips);
            this._currentNames[arrival_time] = this._currentNames[this._oldChoice];
            delete this._shipsStored[this._oldChoice];
            delete this._currentNames[this._oldChoice];
            this.$localizeShips();
            //give feedback
            log(this.name, &quot;Player confirmed transfer of ship &quot;+this._currentNames[this._oldChoice]+&quot; from &quot;+this._oldShips[0][4]+&quot; to &quot;+System.infoForSystem(galaxyNumber, player.ship.targetSystem).name+&quot; for &quot;+formatCredits(fee, true, true)+ &quot;, arrival in &quot;+transit_time+&quot; hours.&quot;);
            player.consoleMessage(this._oldShips[0][3] + &quot; sent to &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;, arrival in &quot;+transit_time+&quot; hours.&quot;);
        } else {
            log(this.name, &quot;Insuficient credits to transfer &quot;+this._oldShips[0][3] + &quot; to &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;.&quot;);
            player.consoleMessage(&quot;Insuficient credits to transfer &quot;+this._oldShips[0][3] + &quot; to &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;.&quot;);
        }
    }
    player.ship.hudHidden = this.$hudHidden;
    this.$choice_transfer(&quot;1_SEND&quot;);
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_transfer_order = function _HH_choice_confirm_transfer_order(choice) {
    if (choice == &quot;1_YES&quot;) {
        this._oldShips = JSON.parse(this._shipsStored[this._oldChoice]);
        var fee = system.info.routeToSystem(System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1], player.ship.routeMode)).distance * 90;
        if (fee &lt;= player.credits) {
            var transit_time = system.info.routeToSystem(System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]), player.ship.routeMode).time;
            var arrival_time = clock.seconds + transit_time * 3600;
            //subtract money
            player.credits -= fee;
            //give feedback
            log(this.name, &quot;Ordering &quot; + this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;, arrival in &quot;+transit_time+&quot; hours at &quot;+arrival_time);
            player.consoleMessage(&quot;Ordering &quot; + this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;, arrival in &quot;+transit_time+&quot; hours.&quot;);
            //change values
            this._oldShips[0][0] = galaxyNumber;
            this._oldShips[0][1] = system.ID;
            this._oldShips[0][4] = system.name;
            this._shipsInTransit[arrival_time] = JSON.stringify(this._oldShips);
            this._currentNames[arrival_time] = this._currentNames[this._oldChoice];
            delete this._shipsStored[this._oldChoice];
            delete this._currentNames[this._oldChoice];
            this.$localizeShips();
        } else {
            player.consoleMessage(&quot;Insuficient credits to transfer &quot;+this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;.&quot;)
            this.$choice_transfer(&quot;2_ORDER&quot;);
        }
        this.$choice_transfer(&quot;2_ORDER&quot;);
    }
}

//---------------------------------------------------------------------------------//
this.$choice_confirm_transfer_order_interGalactic = function _HH_choice_confirm_transfer_order_interGalactic(choice) {
    if (choice == &quot;1_YES&quot;) {
        var  fee = Math.abs(galaxyNumber - this._oldShips[0][0]) * 900;
        if (fee &lt;= player.credits) {
            var transit_time = Math.abs(galaxyNumber - this._oldShips[0][0]) * 72;
            var arrival_time = clock.seconds + transit_time * 3600;
            //subtract money
            player.credits -= fee;
            //give feedback
            log(this.name, &quot;Ordering &quot; + this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;, arrival in &quot;+transit_time+&quot; hours at &quot;+arrival_time);
            player.consoleMessage(&quot;Ordering &quot; + this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;, arrival in &quot;+transit_time+&quot; hours.&quot;);
            //change values
            this._oldShips[0][0] = galaxyNumber;
            this._oldShips[0][1] = system.ID;
            this._oldShips[0][4] = system.name;
            this._shipsInTransit[arrival_time] = JSON.stringify(this._oldShips);
            this._currentNames[arrival_time] = this._currentNames[this._oldChoice];
            delete this._shipsStored[this._oldChoice];
            delete this._currentNames[this._oldChoice];
            this.$localizeShips();
        } else {
            player.consoleMessage(&quot;Insuficient credits to transfer &quot;+this._oldShips[0][3] + &quot; from &quot; + System.infoForSystem(this._oldShips[0][0], this._oldShips[0][1]).name + &quot;.&quot;)
            this.$choice_transfer(&quot;2_ORDER&quot;);
        }
    } 
    player.ship.hudHidden = this.$hudHidden;
    this.$choice_transfer(&quot;1_SEND&quot;);
}


//---------------------------------------------------------------------------------//
this.$choice_confirm_purge = function _HH_choice_confirm_purge(choice) {
    if (choice == &quot;1_YES&quot;) {
        player.consoleMessage(&quot;Removed &quot; + this._currentNames[this._oldChoice] + &quot;.&quot;);
        delete this._currentNames[this._oldChoice];
        delete this._shipsStored[this._oldChoice];
        this._oldChoice = &quot;&quot;;
    } else this.$storeShips();
}

//---------------------------------------------------------------------------------//
//next page of info for mission completed info screen
this.$info_next_page = function _HH_info_next_page(choice) {
    mission.runScreen({
        screenID: &quot;HyperspaceHangar&quot;,
        title: &quot;Station Database: Norby-Ramen Quirium Accuracy Drive&quot;,
        exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
        messageKey: &quot;hyperSpace_QAD_authorized2&quot;
    });
}

//---------------------------------------------------------------------------------//
// clean out the stored ships dictionary, leaving only those ships which are actually stored
this.$cleanUp = function _HH_cleanUp() {
    var list = Object.keys(this._currentNames);
    var full = Object.keys(this._shipsStored);
    var transit = Object.keys(this._shipsInTransit);

    for (var i = 0; i &lt; full.length; i++) {
        if (list.indexOf(full[i]) === -1) {
            delete this._shipsStored[full[i]];
        }
    }
    for (var i = 0; i &lt; transit.length; i++) {
        if (list.indexOf(transit[i]) === -1) {
            delete this._shipsInTransit[transit[i]];
        }
    }
}

//---------------------------------------------------------------------------------//
this.$tradeInAmount = function _HH_tradeInAmount() {
    var p = player.ship;
    var amt = Math.round(p.price * (p.serviceLevel / 100) * (0.75) / 1000) * 1000;
    return amt;
}


//---------------------------------------------------------------------------------//
this.$checkShipArrivals = function _HH_checkShipArrivals() {
    var tempKey = clock.seconds;
    var transit = Object.keys(this._shipsInTransit);
    var newKey = clock.seconds;

    for (var i = 0; i &lt; transit.length; i++) {
        if (tempKey &gt; transit[i]) {
            // ship in transit arrived
            for (;this._currentNames[newKey];newKey++);
            log(this.name, this._currentNames[transit[i]]+&quot; arrived at Hyperspace Hangar, key:&quot;+newKey);
            player.consoleMessage(this._currentNames[transit[i]]+&quot; arrived at Hyperspace Hangar&quot;);
            this._shipsStored[newKey] = this._shipsInTransit[transit[i]];
            this._currentNames[newKey] = this._currentNames[transit[i]];
            delete this._shipsInTransit[transit[i]];
            delete this._currentNames[transit[i]];
        }
    } 
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/hypermission.js</td>
                    <td><pre>this.name           = &quot;HyperspaceHangar-Mission&quot;;
this.author         = &quot;Kenji Takashima&quot;;
this.copyright      = &quot;(C) 2015 Kenji Takashima.&quot;;
this.licence        = &quot;CC-BY-NC-SA 3.0&quot;;
this.description    = &quot;Mission for Hyperspace Hangar.&quot;;

&quot;use strict&quot;;

this.missionScreenOpportunity = function()
{
    //start mission
    if (missionVariables.hyperSpace_mission == &quot;ACTIVATED&quot;)
    {
        mission.runScreen({
            title: &quot;Message from Ramen Corporation&quot;,
            messageKey: &quot;hyperSpace_missionBegin&quot;});
        missionVariables.hyperSpace_mission = &quot;DELIVER&quot;;
        mission.setInstructions(&quot;Deliver the Ramen Corporation&#39;s documents to Diesanen in G6.&quot;);
    }
    //end mission
    else if (galaxyNumber == 5 &amp;&amp; system.ID == 149 &amp;&amp; missionVariables.hyperSpace_mission == &quot;DELIVER&quot;)
    {
        mission.runScreen({
            title: &quot;Message from Ramen Corporation&quot;,
            messageKey: &quot;hyperSpace_missionEnd&quot;});
        mission.unmarkSystem({
            system: 149,
            name: &quot;hyperspaceMission&quot;
        });
        missionVariables.hyperSpace_mission = &quot;DELIVERED&quot;;
    }
    //give reward screen
    else if (missionVariables.hyperSpace_mission == &quot;DELIVERED&quot;)
    {
        mission.runScreen({
            title: &quot;Message from Ramen Corporation&quot;,
            messageKey: &quot;hyperSpace_missionReward&quot;});
        missionVariables.hyperSpace_mission = &quot;COMPLETED&quot;;
        missionVariables.hyperSpaceTimeCompleted = clock.days;
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/paginated_screen.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;Paginated Screen&quot;;
this.author = &quot;Dybal&quot;;
this.licence = &quot;CC-BY-NC-SA 3.0&quot;;
this.description = &quot;Provides a paginated mission screen&quot; 

this._hudHidden;
this._maxContentRows = 21;
this._msRows = 23;
this._itemColor = &quot;greenColor&quot;;
this._menuColor = &quot;orangeColor&quot;;
this._maxPage;
this._curPage;
this._contentChoices = [];
this._contentCallback;
this._contentThisObj;
this._contentParameters;
this._contentExitChoice;

this.$runScreen = function _runPaginatedScreen(parameters, callback, this_obj, sort_entries) {
    this._contentCallback = callback;
    this._contentThisObj = this_obj;
    this._contentParameters = parameters;

    log(this.name, &quot;original choices: &quot;+JSON.stringify(parameters.choices));
    var _ship = player.ship;
    this.$hudHidden = player.ship.hudHidden;
    player.ship.hudHidden = true;

    if (!parameters.choices) return &quot;&#39;choices&#39; not found in &#39;parameters&#39;&quot;;
    var k;
    var original_choices = parameters.choices;
    this._contentChoices = [];
    for (k in original_choices) {
        if ((k.toUpperCase()).indexOf(&quot;EXIT&quot;) &gt; -1) {
            this._contentExitChoice = k;
            log(this.name, &quot;Original Exit choice: &quot;+this._contentExitChoice);
        } else {
            this._contentChoices.push({key:k, value:original_choices[k]});
        }
    }
    if (sort_entries) {
        log(this.name, &quot;sorting entries&quot;);
        this._contentChoices.sort(this._compareEntries);
    }

    if (!this._contentExitChoice) this._contentExitChoice = &quot;0_EXIT&quot;;
    log(this.name, &quot;Exit choice: &quot;+this._contentExitChoice);
    this._maxPage = Math.ceil(this._contentChoices.length / this._maxContentRows)-1;
    if (this._maxPage &lt; 0) this._maxPage = 0; // if original choices is empty...
    this._curPage = 0;
    log(this.name, this._contentChoices.length+&quot; entries, &quot;+this._maxPage+&quot; pages&quot;);
    this._showPage(0);
}

this._compareEntries = function(a,b) {
    var _a, _b;
    if (typeof a.value === &#39;object&#39; &amp;&amp; a.value.text) {
        _a = a.value.text;
    } else {
        _a = a.value;
    }
    if (typeof b.value === &#39;object&#39; &amp;&amp; b.value.text) {
        _b = b.value.text;
    } else {
        _b = b.value;
    }
    return (_a &gt; _b);    
}


this._showPage = function(page) {
    if (page &lt; 0) { this._curPage = 0; }
    else if (page &gt; this._maxPage) { this._curPage = this._maxPage }
    else { this._curPage = page; }
  
    var j;
    for (j=0; j &lt; this._contentChoices.length; j++) {
        log(this.name, j+&quot;: &quot;+this._contentChoices[j].key+&quot;: &quot;+this._contentChoices[j].value);
    }

    var _first_line = this._curPage * this._maxContentRows;
    var choices = {};
    var i = 0;
    var c, _key, _padding, j;
    var _zero = &quot;0&quot;;
 
    log(this.name, &quot;Showing page &quot;+page+&quot;, starts at &quot;+_first_line+&quot;, pages with &quot;+this._maxContentRows+&quot; lines&quot;);
    while (i &lt; this._maxContentRows &amp;&amp; _first_line + i &lt; this._contentChoices.length ) {
        c = this._contentChoices[_first_line+i];
        _key = (_first_line+i).toString();
        if (_key.length &lt; 4) {
            j = 4 - _key.length;
            while (j--) {
                _key = &quot;0&quot; + _key;
            }
            _key = &quot;C_&quot;+ _key;
        }
        choices[_key] = this._formatChoice(c.value);
        i++;
    }
    while (i &lt; this._msRows) {
        choices[&#39;Z96_SPACER_&#39;+i] = &quot;&quot;;
        i++;
    }
    if (this._curPage &gt; 0) { 
        choices[&#39;Z97_PREVIOUS_PAGE&#39;] = {text:&quot;Previous Page&quot;, color:this._menuColor, alignment:&quot;CENTER&quot;}; 
    }
    if (this._curPage &lt; this._maxPage ) { 
        choices[&#39;Z98_NEXT_PAGE&#39;] = {text:&quot;Next Page&quot;, color:this._menuColor, alignment:&quot;CENTER&quot;}; 
    }
    choices[&#39;Z99_EXIT&#39;] = {text:&quot;Exit&quot;, color:this._menuColor, alignment:&quot;CENTER&quot;};
    this._contentParameters.choices = choices;

    var k;
    var c;
    var i = 0;
    for (k in this._contentParameters.choices) {
        c = this._contentParameters.choices[k];
        log(this.name, &quot;linha &quot;+i+&quot;: &quot;+k+&quot;:{text:&quot;+c.text+&quot;}&quot;); 
        i++;
    }

    player.ship.hudHidden = true;
    mission.runScreen(this._contentParameters, this._pChoice, this);
}


this._formatChoice = function (choice) {
    if (typeof choice === &quot;object&quot;) {
        return { text: choice.text, color:(choice.color? choice.color : this._itemColor), alignment: (choice.algnment ? choice.alignment : &quot;LEFT&quot;)};
    } else {
        return { text: choice, color:this._itemColor, alignment:&quot;LEFT&quot;} ;
    }
}


this._pChoice = function (choice) {
    log(this.name, &quot;choice: &quot;+choice);
    if (choice === &#39;Z97_PREVIOUS_PAGE&#39;) {
        this._showPage(this._curPage - 1);
    }
    else if (choice === &#39;Z98_NEXT_PAGE&#39;) {
        this._showPage(this._curPage + 1);
    }
    else if (choice === &quot;Z99_EXIT&quot;) {
        player.ship.hudHidden = this._hudHidden;
        this._contentCallback.call(this._contentThisObj, this._contentExitChoice);
    }
    else {
        var c;
        c = choice.replace(&quot;C_&quot;, &quot;&quot;) * 1;
        log(this.name, choice+&quot;(&quot;+c +&quot;): &quot;+this._contentChoices[c].key+&quot; (&quot;+this._contentChoices[c].value+&quot;) chosen&quot;);
        player.ship.hudHidden = this._hudHidden;
        this._contentCallback.call(this._contentThisObj, this._contentChoices[c].key);
    }
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
