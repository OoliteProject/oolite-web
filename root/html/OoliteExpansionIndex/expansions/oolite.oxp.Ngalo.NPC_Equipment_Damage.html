<html>
    <head>
        <title>Expansion NPC Equipment Damage</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:48 PM</small></td>
            </tr>
        </table>

        <h1>Expansion NPC Equipment Damage</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN CAPITAL LETTER E)(&#39;[]&#39; vs &#39;[Equal Rights for NPCs, fairness, equipment, damage]&#39;)</li>
                <li>Unknown key &#39;upload_date&#39; at https://wiki.alioth.net/img_auth.php/2/21/Oolite.oxp.Ngalo.NPC_Equipment_Damage_0.3.0.oxz!manifest.plist</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Randomly damages NPC equipment, imitating what Oolite does for player-ship internal damage as far as possible.</td>
                    <td>Randomly damages NPC equipment, imitating what Oolite does for player-ship internal damage as far as possible.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.Ngalo.NPC_Equipment_Damage</td>
                    <td>oolite.oxp.Ngalo.NPC_Equipment_Damage</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>NPC Equipment Damage</td>
                    <td>NPC Equipment Damage</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>Ngalo, phkb, tsoj</td>
                    <td>Ngalo, phkb, tsoj</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>0.3.0</td>
                    <td>0.3.0</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>Equal Rights for NPCs, fairness, equipment, damage</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                            <li>oolite.oxp.Ngalo.N-Shields:0.6</li>
                            <li>oolite.oxp.phkb.ShipConfiguration:0.2.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.Ngalo.N-Shields:0.6</li>
                            <li>oolite.oxp.phkb.ShipConfiguration:0.2.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/NPC_equipment_damage_OXP">http://wiki.alioth.net/index.php/NPC_equipment_damage_OXP</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/2/21/Oolite.oxp.Ngalo.NPC_Equipment_Damage_0.3.0.oxz">https://wiki.alioth.net/img_auth.php/2/21/Oolite.oxp.Ngalo.NPC_Equipment_Damage_0.3.0.oxz</a></td>
                    <td><a target="_blank" href="TODO">TODO</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA</td>
                    <td>CC-BY-NC-SA</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1639155117</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/NPC%20Equipment%20Damage'>http://wiki.alioth.net/index.php/NPC%20Equipment%20Damage</a></p>
        <h3>readme.txt</h3>
        <pre>NPC Equipment Damage 0.3.0
by Ngalo

Does what it says on the tin: allows NPC equipment to get damaged in combat, as much like the core player damage handling as I can manage.
Also damages NPC cargo, because Oolite does both with the same code for the player.

OXP equipment which needs to be disabled by script when damaged can push a handler onto the worldScripts.NPC_Equipment_Damage.NPC_equipmentDamagedHandlers array.
Note that such handlers will be called as if they were in the damaged ship&#39;s script, not your worldScript.
A simple example handler from my NPC Energy Units OXP:

this.NPC_energy_equipmentDamaged = function(equipment)
{
	if (equipment == &quot;EQ_NPC_NAVAL_ENERGY_UNIT&quot;) this.ship.energyRechargeRate /= worldScripts.NPC_Energy_Units.NEU_multiplier;
	if (equipment == &quot;EQ_NPC_ENERGY_UNIT&quot;) this.ship.energyRechargeRate /= worldScripts.NPC_Energy_Units.EEU_multiplier;
}

Contributors
- Ngalo: author
- phkb: fixed manifest, fixed bugs
- tsoj: fixed bugs

License:
You may use, adapt, distribute etc. this Oolite Expansion Pack as permitted by the Creative Commons Attribution-NonCommercial-ShareAlike License (CC-BY-NC-SA).

Version history:
0.3.0	fixed manifest, fixed wrong probability of damage, fixed issue with N-Shields
0.2.1	Added a small fix which prevents time-wasting if the damaged ship is about to die anyway.
0.2		Made use of compatibility improvements in Ship Configuration OXP.
		Prevented the script from trying to damage equipment which is already damaged, or which can&#39;t be damaged at all.

0.1.1	Fixed &#39;quantity is not defined&#39; bug in cargo damage code
0.1		Initial WIP release</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/NPC_Equipment_Damage.js</td>
                    <td><pre>this.name = &quot;NPC_Equipment_Damage&quot;;
this.author = &quot;Ngalo&quot;;
this.copyright = &quot;CC-BY-NC-SA&quot;;
this.description = &quot;Randomly damages NPC equipment, imitating what Oolite does for player-ship internal damage as far as possible.&quot;;
this.version = &quot;0.3.0&quot;;

&quot;use strict&quot;;

this.NPC_equipmentDamagedHandlers = [];


this.startUp = function()
{
	if (worldScripts.ShipConfiguration_NPCShips)
	{
		this.NPC_equipmentDamagedHandlers.push(this._shipconf_equipmentDamaged);
	}
}


this.shipSpawned = function(ship)
{
	// Check whether ship should have eq dmg?
	if (worldScripts.NShields &amp;&amp; worldScripts.NShields.$shipHasShields(ship))
	{
		if (!ship.script._NShields_damageHandlers) ship.script._NShields_damageHandlers = [];
		ship.script._NShields_damageHandlers.push(this._NPC_internalDamageWrapper);
	}
	else
	{
		if (ship.isPiloted)
		{
			ship.script.EqDmg_hold_shipTakingDamage = ship.script.shipTakingDamage;
			ship.script.shipTakingDamage = this._NPC_internalDamageWrapper;
		}
	}
	ship.script.EqDmg_serviceLevel = Math.random()*25 + 75; // service level between 75 and 100
}

this._NPC_internalDamageWrapper = function (amount, whom, type)
{
	if (type == &quot;cascade weapon&quot;) return;

	if(amount &gt; 0 &amp;&amp; this.EqDmg_hold_shipTakingDamage) this.EqDmg_hold_shipTakingDamage(amount, whom, type);

	if (amount &gt; this.ship.energy) return; // Ship is good as dead, don&#39;t waste time (especially if it collided with a station or got Q-bombed!)
	
	while (amount &gt; 0.0)
	{
		var internal_damage = (Math.random() &amp; 31) &lt; amount; // not really sure what this does but...
		
		if (internal_damage)
		{
			worldScripts.NPC_Equipment_Damage._NPC_takeInternalDamage(this.ship)
		}
		amount -= 32;
	}
}

this._NPC_takeInternalDamage = function(ship)
{
	// should all types do this?
	
	var n_cargo = ship.cargoSpaceCapacity;
	var n_mass = ship.mass / 10000;
	var n_considered = Math.floor((n_cargo + n_mass) * ship.script.EqDmg_serviceLevel / 100); // real thing uses ship trade-in factor but NPCs don&#39;t have this
	var damage_to = n_considered == 0 ? 0 : Math.floor(Math.random() * n_considered);
	
	var cargopods = [];
	for (item in  ship.cargoList) // need to construct list of individual pods
	{
		for (var i=0; i &lt; ship.cargoList[item].quantity; i++)
		{
			cargopods.push(ship.cargoList[item].commodity)
		} 
	}
	if (damage_to &lt; cargopods)
	{
		ship.adjustCargo(cargopods[damage_to], -1);
		log(&quot;NPC_Equipment_Damage&quot;, &quot;Destroyed 1 unit of&quot;+cargopods[damage_to]+&quot; on &quot;+ship.displayName)
	}
	else
	{
		damage_to = n_considered - (damage_to + 1); // reverse the die roll
		var damageableCounter = 0;
		var damageableOdds = 0.0;
		var damageableEquip = [];
		for (i in ship.equipment)
		{
			var eq = ship.equipment[i]
			if (eq.canBeDamaged &amp;&amp; ship.equipmentStatus(eq.equipmentKey) == &quot;EQUIPMENT_OK&quot;)
			{
				damageableCounter++;
				damageableOdds += eq.damageProbability;
				damageableEquip.push(eq); // list only equipment which can be damaged &amp; isn&#39;t already
			}
		}
		
		if (damage_to &lt; damageableCounter)
		{
			var target = Math.random() * damageableOdds;
			var accumulator = 0.0;
			for (i in ship.equipment)
			{
				// var eq = ship.equipment[i] // no need to call infoForKey, the info object is what&#39;s listed?
				var eq = damageableEquip[i];
				
				accumulator += eq.damageProbability;
				if (accumulator &gt; target)
				{
					// check damageable, damage, apply handlers, return
					if (!eq.canBeDamaged) return;
					
					ship.setEquipmentStatus(eq.equipmentKey, &quot;EQUIPMENT_DAMAGED&quot;);
					
					log(&quot;NPC_Equipment_Damage&quot;, &quot;damaging &quot;+eq.equipmentKey+&quot; on &quot;+ship.displayName)
					
					var handlers = worldScripts.NPC_Equipment_Damage.NPC_equipmentDamagedHandlers
					for (h in handlers)
					{
						handlers[h].apply(ship.script, [eq.equipmentKey]);
					}
					return;
				}
			}
		}
	}
}

this._shipconf_equipmentDamaged = function(equipmentKey)
{
	if (this.$equipmentDamaged_Event)
	{
		this.$equipmentDamaged_Event(equipmentKey)
		return;
	}

	log (&quot;NPC Equipment Damage&quot;, &quot;Using old Ship Configuration equip dmg code for equipment &quot;+equipmentKey)
	var conf = worldScripts.ShipConfiguration_Core;
	if (conf._engines.indexOf(equipmentKey) &gt;= 0)
	{
		// damage the injectors before the engine
		if (this.ship.equipmentStatus(conf.$equipmentItemInUse(&quot;fuelinjectors&quot;, this.ship)) == &quot;EQUIPMENT_OK&quot;)
		{
			this.ship.setEquipmentStatus(equipmentKey, &quot;EQUIPMENT_OK&quot;);
			this.ship.setEquipmentStatus(conf.$equipmentItemInUse(&quot;fuelinjectors&quot;, this.ship), &quot;EQUIPMENT_DAMAGED&quot;);
			this.ship.setEquipmentStatus(&quot;EQ_FUEL_INJECTION&quot;, &quot;EQUIPMENT_DAMAGED&quot;)
			return;
		}
	}
	if (conf._energy.indexOf(equipmentKey) &gt;= 0)
	{
		if (this.ship.equipmentStatus(&quot;EQ_NPC_NAVAL_ENERGY_UNIT&quot;) == &quot;EQUIPMENT_OK&quot;)
		{
			this.ship.setEquipmentStatus(equipmentKey, &quot;EQUIPMENT_OK&quot;)
			this.ship.setEquipmentStatus(&quot;EQ_NPC_NAVAL_ENERGY_UNIT&quot;, &quot;EQUIPMENT_DAMAGED&quot;)
			worldScripts.NPC_Energy_Units.NPC_energy_equipmentDamaged(&quot;EQ_NPC_NAVAL_ENERGY_UNIT&quot;)
			return;
		}
		if (this.ship.equipmentStatus(&quot;EQ_NPC_ENERGY_UNIT&quot;) == &quot;EQUIPMENT_OK&quot;)
		{
			this.ship.setEquipmentStatus(equipmentKey, &quot;EQUIPMENT_OK&quot;)
			this.ship.setEquipmentStatus(&quot;EQ_NPC_ENERGY_UNIT&quot;, &quot;EQUIPMENT_DAMAGED&quot;)
			worldScripts.NPC_Energy_Units.NPC_energy_equipmentDamaged(&quot;EQ_NPC_ENERGY_UNIT&quot;)
			return;
		}
		this.ship.energyRechargeRate = 0;
		if (!this._energyTimer) this._energyTimer = new Timer(this, worldScripts.NPC_Equipment_Damage._drainEnergy.bind(this), 1, 1);
	}
	if (conf._fuelinjectors.indexOf(equipmentKey) &gt;= 0)
	{
		this.ship.setEquipmentStatus(&quot;EQ_FUEL_INJECTION&quot;, &quot;EQUIPMENT_DAMAGED&quot;)
	}
}

this._drainEnergy = function()
{
	this.ship.energy -= 1;
	if (this.ship.energy &lt; 30)
	{
		this._energyTimer.stop()
		delete this._energyTimer;
		this.ship.energyRechargeRate = 0;
	}
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
