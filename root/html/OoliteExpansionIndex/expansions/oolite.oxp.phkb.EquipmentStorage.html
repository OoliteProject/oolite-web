<html>
    <head>
        <title>Expansion Equipment Storage</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Equipment Storage</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">1 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Allows ship equipment to be stored at main stations.</td>
                    <td>Allows ship equipment to be stored at main stations.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.EquipmentStorage</td>
                    <td>oolite.oxp.phkb.EquipmentStorage</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Equipment Storage</td>
                    <td>Equipment Storage</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Mechanics</td>
                    <td>Mechanics</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.7</td>
                    <td>1.7</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/4/41/EquipmentStorage.oxz">https://wiki.alioth.net/img_auth.php/4/41/EquipmentStorage.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1625102155</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Equipment%20Storage'>http://wiki.alioth.net/index.php/Equipment%20Storage</a></p>
        <h3>readme.txt</h3>
        <pre>Equipment Storage
By Nick Rogers

Overview
========
Sometimes, when you purchase a new ship, you want to include equipment you have already purchased. In the core game there is no way around this. If you sell your ship, you have to repurchase everything. 

The Equipment Storage OXP provides an alternative. Every main station now has a self-storage facility into which your excess equipment can be transferred. An F4 interface screen, &quot;Storage facility management&quot;, will be available that will show you all the equipment you have stored at this station or any other station, and allow you to transfer most installed equipment items into storage. Equipment stored in the current station can be either sold or reinstalled. Equipment stored in other stations can be sold or transferred to the current station, after paying a transfer fee, but depending on the length of the trip and the number of dangerous systems the transfer ship must take to reach the current system, you may end up losing the equipment.

Most cargo can also be stored in the facilities, and transferred between them. After selecting &quot;Storage facility management&quot;, you will have an option to move cargo from your hold into the facility.

The cost of storage for most equipment items 1cr per equipment item per day. Some equipment items are categorised as software or having a negligible space or weight, and the cost for these items is 0.1cr per item per day.

Cargo storage costs are calculated at 1cr per ton per day.

Note: Storage facilities are only available at the main station in each system. If you dock at any other station the F4 interface screen will instead read &quot;Storage facility information&quot; and will provide details of what equipment and cargo you have in storage at the main station.

Note: Slaves, firearms and narcotics cannot be stored in any facility, by GalCop law. 

Ship Configuration Integration
==============================
When the Ship Configuration OXP is installed, the interface through which equipment items are transferred to storage is moved into the Ship Configuration equipment item on the F3 Equip Ship screen. The F4 interface screen will still be available for viewing stored equipment, and for reinstallation and transfer.

Note: Because Ship Configuration implements an equipment space/weight factor, the costs of storage could increase for some equipment items. The rate is 1cr per ton per day. See the Ship Configuration documentation for more information on the space/weight factor of individual items.

Licence
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Storage icon made by Freepik (http://www.freepik.com) from http://www.flaticon.com is licensed by Creative Commons BY 3.0 (http://creativecommons.org/licenses/by/3.0/)

Version History
===============
1.7
- Added extra parameter in call to Hermitage OXP.
- Fixed some potential referencing errors on mission screens.

1.6
- Added missing entry in descriptions.plist.

1.5
- Added Trail Detector item to override list, allowing it to be stored.
- Added Mining IFF Scanner Upgrade item to override list, allowing it to be stored.
- Added Rescue Stations equipment items to override list, allowing them to be stored.
- Fixed issue with Ship Configuration items (Fuel Scoops, Heat Shields and Fuel Injectors) that were not being assessed correctly in determining when an item was in use.
- Bug fixes.

1.4
- Added IronHide armour to the exclusion list.

1.3
- Added ShipVersion&#39;s placeholder equipment items to the list of items that can&#39;t be stored.
- Code refactoring.
- Bug fixes.

1.2
- Added overlay to transfer cargo screen.
- Cleaned up some instances where the core commodity name (eg &quot;gem_stones&quot;) was being displayed, instead of the display name (eg &quot;gem-stones&quot;).
- Added interfaces to another OXP in development.

1.1
- Corrected OXP name in manifest file.

1.0 
- Initial release.</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/equipstorage.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;EquipmentStorage&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2019 phkb&quot;;
this.description = &quot;Handles the process of storing equipment items for reuse later&quot;;
this.licence = &quot;CC BY-NC-SA 4.0&quot;;

// TODO:	Allow storage of missiles

this._noStore = [&quot;EQ_BREAKABLE_TORUSDRIVE&quot;, &quot;EQ_BREAKABLE_HUD_IFF_SCANNER&quot;, &quot;EQ_IRONHIDE&quot;];
this._allowedIgnored = [&quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot;, &quot;EQ_MULTI_TARGET&quot;, &quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;, &quot;EQ_INTEGRATED_TARGETING_SYSTEM&quot;,
	&quot;EQ_TARGET_MEMORY&quot;, &quot;EQ_SMUGGLING_PHASE_ADJUSTMENT&quot;, &quot;EQ_SDC_HACK_CHIP&quot;, &quot;EQ_IG_INSURANCE&quot;, &quot;EQ_IG_LEGAL_HACK&quot;, &quot;EQ_LMSS_ACTUATOR&quot;,
	&quot;EQ_ESCORTCONTRACTS&quot;, &quot;EQ_TEA_MAKER&quot;, &quot;EQ_TEAPOT&quot;, &quot;EQ_COMMSLOGMFD&quot;, &quot;EQ_COMMSLOGMFD_PASSIVE&quot;, &quot;EQ_BROADCASTCOMMSMFD&quot;, &quot;EQ_DAMAGE_REPORT_MFD&quot;,
	&quot;EQ_DAMAGE_REPORT_MFD_PASSIVE&quot;, &quot;EQ_COMBATMFD&quot;, &quot;EQ_NAVIGATION_MFD&quot;, &quot;EQ_APRIL_INVENTORY&quot;, &quot;EQ_APRIL_TRANSFER&quot;, &quot;EQ_APRIL_UNLOAD&quot;,
	&quot;EQ_AMS_1&quot;, &quot;EQ_AMS_2&quot;, &quot;EQ_AMS_3&quot;, &quot;EQ_AMS_4&quot;, &quot;EQ_GLARE_FILTER&quot;, &quot;EQ_AMS_5&quot;, &quot;EQ_AMS_6&quot;, &quot;EQ_AUTO_EJECT&quot;, &quot;EQ_BOUNTY_INFORMER&quot;, &quot;EQ_CARGOSPOTTER&quot;,
	&quot;EQ_ELITE_RANK&quot;, &quot;EQ_RESERVE_TANK_EMPTY&quot;, &quot;EQ_AUX_TANK_EMPTY&quot;, &quot;EQ_WEAPON_GATLING_LASER_COOLER&quot;, &quot;EQ_HUDSELECTOR&quot;, &quot;EQ_MARKET_INQUIRER_MFD&quot;,
	&quot;EQ_TROPHY_MFD&quot;, &quot;EQ_UPS_IDCLEANER&quot;, &quot;EQ_MULTIPASS&quot;, &quot;EQ_MULTIPASSED_ID&quot;, &quot;EQ_HARDWIRE_ORE_PROCESSOR&quot;, &quot;EQ_TARGETSELECTOR&quot;,
	&quot;EQ_TARGETSELECTOR_MODECHANGER&quot;, &quot;EQ_SHIPS_CAT_1&quot;, &quot;EQ_SHIPS_CAT_2&quot;, &quot;EQ_SHIPS_CAT_3&quot;, &quot;EQ_SHIPS_CAT_4&quot;, &quot;EQ_SHIPS_CAT_5&quot;, &quot;EQ_SHIPS_CAT_6&quot;,
	&quot;EQ_SHIPS_CAT_7&quot;, &quot;EQ_SHIPS_CAT_8&quot;, &quot;EQ_SHIPS_CAT_9&quot;, &quot;EQ_CTE_TRADERNET&quot;, &quot;EQ_CAMERA_DRONES&quot;, &quot;EQ_WPH_ASC_UPGRADE&quot;, &quot;EQ_POLICE_SCANNER_UPGRADE&quot;,
	&quot;EQ_Q-CHARGER_MESS&quot;, &quot;EQ_REPAIRBOTS_RECHARGE&quot;, &quot;EQ_SAFETYCATCH&quot;, &quot;EQ_SAFETY_MINE&quot;, &quot;EQ_SCANNER_ALERTING_ENHANCEMENT&quot;, &quot;EQ_HYPER_RADIO&quot;,
	&quot;EQ_HYPER_RADIO_ADD&quot;, &quot;EQ_HYPER_RADIO_PIRATE&quot;, &quot;EQ_ILS&quot;, &quot;EQ_WEAPON_LASER_COOLER&quot;, &quot;EQ_MANIFEST_MFD&quot;, &quot;EQ_SC_MANUAL_CONFIGURATOR_BASIC&quot;,
	&quot;EQ_SC_MANUAL_CONFIGURATOR_STANDARD&quot;, &quot;EQ_SC_MANUAL_CONFIGURATOR_ADVANCED&quot;, &quot;EQ_TARGET_AUTOLOCK&quot;, &quot;EQ_ENEMY_TARGETER_UPGRADE&quot;,
	&quot;EQ_TELESCOPEEXT&quot;, &quot;EQ_TORUSTOSUN&quot;, &quot;EQ_TRACKER&quot;, &quot;EQ_TRACKERCAM_LINK&quot;, &quot;EQ_TWS_GALACTICSATNAV&quot;, &quot;EQ_WELCOME_MAT&quot;, &quot;EQ_GAL_DRIVE_MOD&quot;,
	&quot;EQ_SALON_CONTROL&quot;, &quot;EQ_SNIPER_SCOPE&quot;, &quot;EQ_SYSTEM_MARKET_WATCH&quot;, &quot;EQ_AUTOECM&quot;, &quot;EQ_GALAXY_INFO&quot;, &quot;EQ_LONG_RANGE_SCANNER_JUMP&quot;,
	&quot;EQ_RETICLE_TARGET_SENSITIVE&quot;, &quot;EQ_MANIF_SCANNERX&quot;, &quot;EQ_MC_DESCRAMBLER&quot;, &quot;EQ_MURPH_THARGOID_DRIVE_TOFIT&quot;, &quot;EQ_ENEMY_TARGETER_UPGRADE&quot;,
	&quot;EQ_SNIPERLOCK&quot;, &quot;EQ_MFD_FAST_CONFIG&quot;, &quot;EQ_GCM_COMMS_RELAY_SWITCH&quot;, &quot;EQ_GCM_CARGO_STOPPER&quot;, &quot;EQ_GCM_EJECTION_DAMPER&quot;, &quot;EQ_GCM_UNPROCESSED_SCAN_DATA&quot;,
	&quot;EQ_GCM_SOFTWARE&quot;, &quot;EQ_GCM_STOLEN_SCHEMATICS&quot;, &quot;EQ_GCM_STOLEN_CODES&quot;, &quot;EQ_GCM_STOLEN_DOCUMENTS&quot;, &quot;EQ_GCM_STOLEN_WEAPONDESIGNS&quot;,
	&quot;EQ_RRS_FLIGHTFORM&quot;, &quot;EQ_RRS_ESCORT_TARGETING_SYSTEM&quot;, &quot;EQ_RRS_ESCORT_TARGETING_SYSTEM_WAYSTATION&quot;, 
	&quot;EQ_NS_MINING_SCANNER_UPGRADE&quot;, &quot;EQ_NS_SCANNER_SCAVENGER_HACK&quot;, &quot;EQ_TRAIL_DETECTOR&quot;
];

this._storage = []; // main array holding storage information
this._sc_core = null; // link to shipconfig core functions
this._compNames = [&quot;KennOords Storage&quot;, &quot;BulkStor&quot;, &quot;RentaSpace&quot;, &quot;Storage King&quot;, &quot;HOowards Storage World&quot;,
	&quot;%H Self Storage&quot;, &quot;Galactic Storage&quot;, &quot;StoreIt Self Storage&quot;, &quot;Systemwide Storage&quot;, &quot;Safe-n-Sound&quot;,
	&quot;Premier Storage Solutions&quot;, &quot;TopShelf Storage&quot;, &quot;HandiStor&quot;, &quot;SpaceWays Self Storage&quot;, &quot;B&amp;B Stor-More&quot;, &quot;OO-Haul Storage&quot;
];
this._salesRep = &quot;&quot;; // holds a string containing the name of the local sales rep
this._page = 0; // controls which page of information will be displayed
this._lastChargeDate = 0; // date player was last charged for storage
this._display = 0; // controls which display will be shown on the interface screen
this._displayType = 0; // 0 = current location only, 1 = all locations
this._selectedItem = &quot;&quot;; // currently selected item
this._lastChoice = [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;]; // players last choice on each of the displays
this._lastChoiceStore = &quot;&quot;;
this._lastSource = -1; // used to establish the start point for destination system calculations
this._commodities = []; // stores a list of installed commodity keys
this._storedPrices = []; // stores a copy of any sample prices so the player always gets the same answer
this._establishmentFee = 100;
this._disabled = false;
this._menuColor = &quot;orangeColor&quot;; // color of general menu items
this._itemColor = &quot;yellowColor&quot;; // color of special menu items (eg exit menu items)
this._damagedColor = &quot;redColor&quot;; // color of damaged equipment items
this._installedColor = &quot;greenColor&quot;; // color of installed equipment items
this._riskColor = &quot;0.8 0.8 0.8 1&quot;; // color of risky transit items
this._refundPct = 0.85; // value between 0 and 1 that indicates how much refund you get on equipment sold. 0 = no refund, 1 = refund full original price

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	if (worldScripts.ShipConfiguration_Core) this._sc_core = worldScripts.ShipConfiguration_Core;

	if (this._disabled) {
		delete this.playerWillSaveGame;
		delete this.shipWillDockWithStation;
		delete this.playerEnteredNewGalaxy;
		delete this.dayChanged;
		delete this.playerBoughtEquipment;
		delete this.playerBoughtNewShip;
		delete this.reportScreenEnded;
		delete this.missionScreenEnded;
		delete this.startUpComplete;
		return;
	}

	// add a mission screen exception to Xenon UI
	if (worldScripts.XenonUI) {
		var wx = worldScripts.XenonUI;
		wx.$addMissionScreenException(&quot;oolite-storage-shortrangechart-map&quot;);
		wx.$addMissionScreenException(&quot;oolite-storage-longrangechart-map&quot;);
	}
	// add a mission screen exception to Xenon Redux UI
	if (worldScripts.XenonReduxUI) {
		var wxr = worldScripts.XenonReduxUI;
		wxr.$addMissionScreenException(&quot;oolite-storage-shortrangechart-map&quot;);
		wxr.$addMissionScreenException(&quot;oolite-storage-longrangechart-map&quot;);
	}
	if (worldScripts.DisplayCurrentCourse) {
		var dcc = worldScripts.DisplayCurrentCourse;
		dcc._screenIDList.push(&quot;oolite-storage-shortrangechart-map&quot;);
		dcc._screenIDList.push(&quot;oolite-storage-longrangechart-map&quot;);
	}

	// pull in the values from ShipConfig vars, if loading for the first time after the split
	if (missionVariables.ShipConfig_EquipStorage) {
		this._storage = JSON.parse(missionVariables.ShipConfig_EquipStorage);
		delete missionVariables.ShipConfig_EquipStorage;
	}
	if (missionVariables.ShipConfig_LastChargeDate) {
		this._lastChargeDate = missionVariables.ShipConfig_LastChargeDate;
		delete missionVariables.ShipConfig_LastChargeDate;
	}
	// otherwise, we&#39;ll get our own versions
	if (missionVariables.EquipmentStorage_Data) {
		this._storage = JSON.parse(missionVariables.EquipmentStorage_Data);
		delete missionVariables.EquipmentStorage_Data;
	}
	if (missionVariables.EquipmentStorage_LastChargeDate) {
		this._lastChargeDate = missionVariables.EquipmentStorage_LastChargeDate;
	}
	this.$initInterface(player.ship.dockedStation);
	this._lastSource = system.ID;

	var keys = Object.keys(system.mainStation.market);
	for (var i = 0; i &lt; keys.length; i++) {
		this._commodities.push(keys[i]);
	}
	this.$compileSamplePrices();

	// if shipconfig is present, point our nostore list at shipconfig&#39;s nosell list
	if (this._sc_core) this._noStore = this._noStore.concat(this._sc_core._noSell);
	// include shipversions placeholder equipment items
	if (worldScripts.shipversion) {
		for (var i = 75; i &lt;= 100; i++) {
			this._noStore.push(&quot;EQ_SERVICE_LEVEL_&quot; + i.toString());
		}
		for (var i = 10; i &lt;= 100; i++) {
			this._noStore.push(&quot;EQ_SHIP_VERSION_&quot; + i.toString());
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function () {
	if (this._storage.length &gt; 0) {
		missionVariables.EquipmentStorage_Data = JSON.stringify(this._storage);
	} else {
		delete missionVariables.EquipmentStorage_Data;
	}
	missionVariables.EquipmentStorage_LastChargeDate = this._lastChargeDate;
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function (station) {
	this.$initInterface(station);
	this.$checkForArrivals();
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillLaunchFromStation = function (station) {
	this._lastSource = system.ID;
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function () {
	// update the lastSource ID
	if (system.ID != -1) this._lastSource = system.ID;
	this.$compileSamplePrices();
}

//-------------------------------------------------------------------------------------------------------------
this.playerEnteredNewGalaxy = function (galaxyNumber) {
	// any in transit items will be transported to their destinations - a galjump freebee
	for (var i = 0; i &lt; this._storage.length; i++) {
		if (this._storage[i].inTransit === true) {
			this._storage[i].system = this._storage[i].transitDestination;
			this._storage[i].systemName = this._storage[i].transitDestinationName;
			this._storage[i].inTransit = false;
			this._storage[i].transitSystem = -1;
			this._storage[i].transitDestination = -1;
			this._storage[i].transitETA = 0;
			this._storage[i].transitStart = 0;
		}
	}
	this._lastSource = system.ID;
}

//-------------------------------------------------------------------------------------------------------------
this.dayChanged = function () {
	// charge the player for storage
	if ((clock.seconds - this._lastChargeDate) &gt; 86400) {
		this._lastChargeDate = clock.seconds;
		var data = this.$storageSystemList();
		var abort = false;
		var compList = &quot;&quot;;
		var dropList = {};
		var totalRefund = 0;
		var totalCost = 0;

		var keys = Object.keys(data);
		for (var i = 0; i &lt; keys.length; i++) {
			var gal = parseInt(keys[i].split(&quot;_&quot;)[0]);
			var sys = parseInt(keys[i].split(&quot;_&quot;)[1]);
			var cost = this.$calculateSystemCost(gal, sys);
			var count = this.$storageSystemCount(gal, sys);
			if (player.credits &gt; cost) {
				player.credits -= cost;
				totalCost += cost;
				compList += (compList === &quot;&quot; ? &quot;&quot; : &quot;\n&quot;) + &quot;- &quot; + formatCredits(cost, false, true) + &quot; for storage of &quot; + count + (count === 1 ? &quot; item&quot; : &quot; items&quot;) + &quot; in the &quot; + data[keys[i]] + &quot; system&quot; +
					(galaxyNumber != gal ? &quot; (G&quot; + (gal + 1) + &quot;)&quot; : &quot;&quot;);

			} else {
				// refund half the cost of the items in storage, then remove them
				abort = true;
				var refund = 0;
				for (var j = this._storage.length - 1; j &gt;= 0; j--) {
					var item = this._storage[j];
					if (item.galaxy === gal &amp;&amp; item.system === sys) {
						if (item.equipmentKey != &quot;&quot;) {
							var info = EquipmentInfo.infoForKey(item.equipmentKey);
							if (info.effectiveTechLevel &gt; 14) {
								refund += 1000;
							} else {
								refund += (info.price / 10) * 0.5;
							}
						}
						if (item.commodity != &quot;&quot;) {
							refund += ((system.mainStation.market[item.commodity].price / 10) * item.weight) * 0.5;
						}
					}
					this._storage.splice(j, 1);
				}
				totalRefund += refund
				dropList[keys[i]] = {
					galaxy: gal,
					system: sys,
					systemName: data[keys[i]],
					refund: refund,
					count: count
				};
			}
		}
		// send a refund email, if required
		if (abort === true &amp;&amp; totalRefund &gt; 0) {
			player.credits += totalRefund;
			// give the player an email, if installed
			var ga = worldScripts.GalCopAdminServices;
			if (ga) {
				var email = worldScripts.EmailSystem;
				var keys = Object.keys(dropList);
				for (var i = 0; i &lt; keys.length; i++) {
					var item = dropList[keys[i]];

					var msg = expandDescription(&quot;[storeequip-cancelled]&quot;, {
						systemname: item.systemName,
						galaxy: (parseInt(item.galaxy) === galaxyNumber ? &quot;&quot; : &quot; (G&quot; + item.galaxy + &quot;)&quot;),
						count: item.count,
						refund: formatCredits(item.refund, true, true)
					});

					if (item.galaxy != galaxyNumber) {
						email.$createEmail({
							sender: expandDescription(this._compNames[item.system % 16]),
							subject: &quot;Storage Cancelled&quot;,
							date: global.clock.seconds,
							message: msg,
							expiryDays: ga._defaultExpiryDays
						});
					} else {
						email.$createEmail({
							sender: expandDescription(this._compNames[item.system % 16]),
							subject: &quot;Storage Cancelled&quot;,
							date: global.clock.seconds,
							sentFrom: item.system,
							message: msg,
							expiryDays: ga._defaultExpiryDays
						});
					}
				}
			}
		}
		// send a confirmation email, if required
		if (compList.length &gt; 0 &amp;&amp; totalCost &gt; 0) {
			// give the player an email, if installed
			var ga = worldScripts.GalCopAdminServices;
			if (ga) {
				var email = worldScripts.EmailSystem;

				var msg = expandDescription(&quot;[storeequip-dailycost]&quot;, {
					cost: formatCredits(totalCost, true, true),
					costdetails: compList
				});

				email.$createEmail({
					sender: &quot;Storage Facility&quot;,
					subject: &quot;Storage payment&quot;,
					date: global.clock.seconds,
					message: msg,
					expiryDays: ga._defaultExpiryDays
				});
			}
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function (equipment) {
	this.$checkForArrivals();
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtNewShip = function (ship) {
	this.$checkForArrivals();
}

//-------------------------------------------------------------------------------------------------------------
this.reportScreenEnded = this.missionScreenEnded = function () {
	this.$checkForArrivals();
}

//-------------------------------------------------------------------------------------------------------------
// mission screen for displaying list of equipment that can be stored
this.$storeEquipment = function $storeEquipment() {
	function compare(a, b) {
		return b.space - a.space;
	}

	var p = player.ship;
	var stn = p.dockedStation;
	var used = 0;
	var maxspace = 0;
	if (this._sc_core) {
		used = this._sc_core.$calcEquipmentSpace(p);
		maxspace = Math.ceil(this._sc_core.$equipmentSpaceTotal(p) + this._sc_core.$cargoSpaceAvailable(p));
	}
	var interrupt = true;
	var spc = String.fromCharCode(31) + String.fromCharCode(31) + String.fromCharCode(31);

	var text = &quot;&quot;;
	var curChoices = {};
	var itemcount = 0;

	var pagesize = 15;
	if (!this._sc_core) pagesize += 5;

	this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() === false) p.hudHidden = true;
	if (this._sc_core) this._sc_core._configScreen = true;
	var enabled = true;
	if (this.$storageSystemCount(galaxyNumber, system.ID) === 0 &amp;&amp; player.credits &lt; this._establishmentFee) enabled = false;

	// display the list of options
	if (used &gt; maxspace) {
		// make sure we don&#39;t lock the player in during flight
		if (p.alertCondition === 0) {
			interrupt = false; // set to false to force the player to sell equipment before continuing
		}
		if (this._sc_core) {
			curChoices[&quot;98_SWITCH&quot;] = {
				text: &quot;[sc-change-config]&quot;,
				color: this._itemColor
			};
			pagesize -= 1;
		}
		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._disabledColor,
			unselectable: true
		};
	} else {
		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};
		if (this._sc_core) this._sc_core._initialSetup = false;
	}

	text += this.$pageHeader();

	if (this._sc_core) {
		text += this.$padTextRight(expandDescription(&quot;[storage-equipment-title]&quot;), 16) +
			this.$padTextLeft((this._sc_core ? &quot;Equip&quot; : &quot; &quot;), 4) +
			this.$padTextLeft(&quot; &quot;, 4) +
			this.$padTextLeft(&quot;Storage&quot;, 8) + &quot;\n&quot;;
	} else {
		var addText = &quot; &quot;;
		if (stn.isMainStation === true &amp;&amp; this.$storageSystemCount(galaxyNumber, system.ID) === 0) {
			addText += expandDescription(&quot;[storage-deposit-required]&quot;, {
				fee: formatCredits(this._establishmentFee, false, true)
			});
		}
		text += this.$padTextRight(addText, 24) +
			this.$padTextLeft(&quot;Storage&quot;, 8) + &quot;\n&quot;;
	}

	text += this.$padTextRight(&quot;Equipment Item&quot;, 16) +
		this.$padTextLeft((this._sc_core ? &quot;space&quot; : &quot; &quot;), 4) +
		this.$padTextLeft((this._sc_core ? &quot;Weight&quot; : &quot; &quot;), 4) +
		this.$padTextLeft(&quot;Cost&quot;, 8) + &quot;\n\n&quot;;

	var eq = p.equipment;
	var list = [];

	for (var i = 0; i &lt; eq.length; i++) {
		var item = eq[i];
		// exclusions
		// don&#39;t include &quot;no store&quot; items
		if (this._noStore.indexOf(item.equipmentKey) &gt;= 0) continue;
		if (this._sc_core) {
			// boosters can&#39;t be included either
			if (this._sc_core._boosters.indexOf(item.equipmentKey) &gt;= 0) continue;
			// nor can armour
			if (this._sc_core._armour.indexOf(item.equipmentKey) &gt;= 0) continue;
			// nor can extensions
			if (this._sc_core._extensions.indexOf(item.equipmentKey) &gt;= 0) continue;
		}
		// we can&#39;t store smuggling compartments, because we can&#39;t reliably reinstall them later
		// storage facilities only exist at main stations, but smuggling compartments can only be installed at non-main stations
		if (item.equipmentKey.indexOf(&quot;EQ_SMUGGLING_COMPARTMENT&quot;) &gt;= 0) continue;
		// don&#39;t include any items in the ignore equipment list that aren&#39;t specially allowed
		if (this._sc_core &amp;&amp; this._sc_core._ignoreEquip.indexOf(item.equipmentKey) &gt;= 0 &amp;&amp; this._allowedIgnored.indexOf(item.equipmentKey) === -1) continue;

		var space = 0;
		var weight = 0;
		var zeroSpace = 0;

		var lookup = null;
		if (this._sc_core) lookup = this._sc_core._equipmentMatrix[item.equipmentKey];
		if (lookup) {
			space = parseFloat(lookup[0]);
			weight = parseFloat(lookup[1]);
			if (space === 0 &amp;&amp; weight === 0) zeroSpace = 1;
		} else {
			if (item.requiredCargoSpace === 0) {
				if (this._allowedIgnored.indexOf(item.equipmentKey) &gt;= 0) {
					zeroSpace = 1;
				} else {
					space = 1;
					weight = 1;
				}
			} else {
				weight = item.requiredCargoSpace;
				space = weight;
			}
		}

		var colr = this._menuColor;
		if (p.equipmentStatus(item.equipmentKey) === &quot;EQUIPMENT_DAMAGED&quot;) colr = this._damagedColor;
		// special case for armour
		if (this._sc_core &amp;&amp; this._sc_core._armour.indexOf(item.equipmentKey) &gt;= 0) {
			if (p.script._armourFront &lt; 100 || p.script._armourAft &lt; 100) colr = this._damagedColor;
		}
		if (enabled === false) colr = this._disabledColor;
		if (item.isVisible &amp;&amp; item.requiresEmptyPylon === false &amp;&amp; this.$equipmentIsRequired(item.equipmentKey) === false &amp;&amp; (!this._sc_core || (space &gt; 0 || weight &gt; 0 || zeroSpace === 1))) {
			// any items in the negotiate list will show as &quot;???&quot; in the cost column 
			// if the player chooses to sell this item he will have to negotiate a price
			var loop = 1;
			// special case for passenger berths - only 1 item is in the equipment list, but you could have multiple installed
			if (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot;) loop = p.passengerCapacity;
			for (var j = 1; j &lt;= loop; j++) {
				list.push({
					eq: item.equipmentKey,
					space: space,
					weight: weight,
					cost: this.$calculateStorageCost(space, weight),
					color: colr,
					name: (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : item.name),
					section: &quot;&quot;
				});
			}
		}
	}

	// laser weapons
	var lmss = worldScripts.LMSS_Core;
	var section = [&quot;Forward&quot;, &quot;Aft&quot;, &quot;Port&quot;, &quot;Starboard&quot;, &quot;Forward - Secondary&quot;, &quot;Aft - Secondary&quot;, &quot;Port - Secondary&quot;, &quot;Starboard - Secondary&quot;];
	for (var i = 0; i &lt; 7; i++) {
		var key = &quot;&quot;;
		var damage = false;
		switch (i) {
			case 0:
				key = p.forwardWeapon.equipmentKey;
				if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
					key = worldScripts.BreakableLasers_Main._holdDamage[&quot;FORWARD&quot;].primary;
					damage = true;
				}
				break;
			case 1:
				key = p.aftWeapon.equipmentKey;
				if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
					key = worldScripts.BreakableLasers_Main._holdDamage[&quot;AFT&quot;].primary;
					damage = true;
				}
				break;
			case 2:
				key = p.portWeapon.equipmentKey;
				if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
					key = worldScripts.BreakableLasers_Main._holdDamage[&quot;PORT&quot;].primary;
					damage = true;
				}
				break;
			case 3:
				key = p.starboardWeapon.equipmentKey;
				if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
					key = worldScripts.BreakableLasers_Main._holdDamage[&quot;STARBOARD&quot;].primary;
					damage = true;
				}
				break;
			case 4:
				if (lmss) {
					key = lmss._forwardAltKey;
					if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						key = worldScripts.BreakableLasers_Main._holdDamage[&quot;FORWARD&quot;].secondary;
						damage = true;
					}
				}
				break;
			case 5:
				if (lmss) {
					key = lmss._aftAltKey;
					if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						key = worldScripts.BreakableLasers_Main._holdDamage[&quot;AFT&quot;].secondary;
						damage = true;
					}
				}
				break;
			case 6:
				if (lmss) {
					key = lmss._portAltKey;
					if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						key = worldScripts.BreakableLasers_Main._holdDamage[&quot;PORT&quot;].secondary;
						damage = true;
					}
				}
				break;
			case 7:
				if (lmss) {
					key = lmss._starboardAltKey;
					if (key == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						key = worldScripts.BreakableLasers_Main._holdDamage[&quot;STARBOARD&quot;].secondary;
						damage = true;
					}
				}
				break;
		}
		if (key !== &quot;&quot; &amp;&amp; key !== &quot;EQ_WEAPON_NONE&quot;) {
			var item = EquipmentInfo.infoForKey(key);
			var space = 1; // for storage purposes, it&#39;s always 1t
			var weight = 0;
			var zeroSpace = 0;

			if (this._sc_core) {
				var lookup = this._sc_core._equipmentMatrix[item.equipmentKey];
				if (lookup) {
					space = parseFloat(lookup[0]);
					if (space === 0) space = 1;
					weight = parseFloat(lookup[1]);
				} else {
					weight = 1;
				}
			} else {
				weight = 1;
			}

			colr = this._menuColor;
			if (damage) colr = this._damagedColor;

			list.push({
				eq: item.equipmentKey,
				space: space,
				weight: weight,
				cost: this.$calculateStorageCost(space, weight),
				color: colr,
				name: item.name + &quot; (&quot; + section[i] + &quot;)&quot;,
				section: i
			});
		}
	}

	if (list.length &gt; 0) {
		list.sort(compare);

		var maxpage = Math.ceil(list.length / pagesize);
		if (maxpage &lt; (this._page + 1)) this._page -= 1;
		var end = ((this._page * pagesize) + pagesize);
		if (end &gt; list.length) end = list.length;
		// note: then station equipmentPriceFactor has been removed to prevent exploitation of equipment sales at different stations (galcop =&gt; rock hermit)
		for (var i = (this._page * pagesize); i &lt; end; i++) {
			curChoices[&quot;01_EQUIP-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i].eq + (list[i].section !== &quot;&quot; ? &quot;|&quot; + list[i].section : &quot;&quot;)] = {
				text: this.$padTextRight(list[i].name, 16) +
					this.$padTextLeft((this._sc_core ? list[i].space.toFixed(1) + spc + &quot;t&quot; : &quot; &quot;), 4) +
					this.$padTextLeft((this._sc_core ? list[i].weight.toFixed(1) + spc + &quot;t&quot; : &quot; &quot;), 4) +
					(list[i].cost === &quot;???&quot; ? this.$padTextLeft(&quot;???&quot;, 8) :
						this.$padTextLeft(formatCredits((list[i].cost), true, true) + &quot;/d&quot;, 8)), //* stn.equipmentPriceFactor
				alignment: &quot;LEFT&quot;,
				unselectable: !enabled,
				color: list[i].color
			};
			itemcount += 1;
		}
		for (var i = 0; i &lt; ((pagesize + 1) - itemcount); i++) {
			curChoices[&quot;90_SPACER_&quot; + i] = &quot;&quot;;
		}
	} else {
		text += expandDescription(&quot;[storage-none-to-store]&quot;);
	}

	if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
		curChoices[&quot;95_NEXT&quot;] = {
			text: &quot;[storage-nextpage]&quot;,
			color: this._itemColor
		};
	} else {
		curChoices[&quot;95_NEXT&quot;] = {
			text: &quot;[storage-nextpage]&quot;,
			color: this._disabledColor,
			unselectable: true
		};
	}
	if (this._page &gt; 0) {
		curChoices[&quot;96_PREV&quot;] = {
			text: &quot;[storage-prevpage]&quot;,
			color: this._itemColor
		};
	} else {
		curChoices[&quot;96_PREV&quot;] = {
			text: &quot;[storage-prevpage]&quot;,
			color: this._disabledColor,
			unselectable: true
		};
	}

	var def = &quot;99_EXIT&quot;;
	if (this._lastChoiceStore != &quot;&quot;) def = this._lastChoiceStore;

	var opts = {
		screenID: &quot;oolite-storage-equipment-map&quot;,
		title: &quot;Store Equipment&quot;,
		allowInterrupt: interrupt,
		exitScreen: (this._sc_core ? this._sc_core._sellEquipExitScreen : &quot;GUI_SCREEN_INTERFACES&quot;),
		choices: curChoices,
		initialChoicesKey: def,
		message: text
	};

	if (this._sc_core) this._sc_core.$addShipModelToScreen(opts);
	mission.runScreen(opts, this.$storeEquipmentScreenHandler, this);
	if (this._sc_core) this._sc_core.$finaliseShipModel();
}

//-------------------------------------------------------------------------------------------------------------
// handles menu selection on store equipment screen
this.$storeEquipmentScreenHandler = function $storeEquipmentScreenHandler(choice) {

	if (!choice) return;

	var p = player.ship;
	var stn = p.dockedStation;

	this._lastChoiceStore = choice;

	if (choice.indexOf(&quot;01_EQUIP&quot;) &gt;= 0) {
		var item = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var section = &quot;&quot;
		// check for a laser position
		if (item.indexOf(&quot;|&quot;) &gt;= 0) {
			section = item.split(&quot;|&quot;)[1];
			item = item.split(&quot;|&quot;)[0];
		}
		var info = EquipmentInfo.infoForKey(item);
		var space = 0;
		var weight = 0;
		if (section === &quot;&quot;) {
			var dam = p.equipmentStatus(item);

			var lookup = null;
			if (this._sc_core) lookup = this._sc_core._equipmentMatrix[info.equipmentKey];
			if (lookup) {
				space = parseFloat(lookup[0]);
				weight = parseFloat(lookup[1]);
				if (space === 0 &amp;&amp; info.requiredCargoSpace &gt; 0) space = info.requiredCargoSpace;
			} else {
				if (info.requiredCargoSpace === 0) {
					if (this._allowedIgnored.indexOf(info.equipmentKey) === -1) {
						space = 1;
						weight = 1;
					}
				} else {
					weight = info.requiredCargoSpace;
					space = weight;
				}
			}

			// special case for passenger berths
			if (item === &quot;EQ_PASSENGER_BERTH&quot;) {
				var creds = player.credits;
				p.awardEquipment(&quot;EQ_PASSENGER_BERTH_REMOVAL&quot;);
				p.credits = creds;
			} else {
				p.removeEquipment(item);
			}

			if (item.indexOf(&quot;EQ_LMSS&quot;) &gt;= 0) {
				// if we&#39;ve removed all the positions, then remove the activator as well
				if (p.equipmentStatus(&quot;EQ_LMSS_FRONT&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_AFT&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp;
					p.equipmentStatus(&quot;EQ_LMSS_PORT&quot;) != &quot;EQUIPMENT_OK&quot; &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_STARBOARD&quot;) != &quot;EQUIPMENT_OK&quot;) {
					p.removeEquipment(&quot;EQ_LMSS_ACTIVATOR&quot;);
				}
				worldScripts.LMSS_Core.$resetInterface();
			}

			if (this._sc_core) this._sc_core._current = {};
			var idx = this.$countItemAtStation(item);
			// for some reason passenger berths report as unavailable
			if (item === &quot;EQ_PASSENGER_BERTH&quot; &amp;&amp; dam === &quot;EQUIPMENT_UNAVAILABLE&quot;) dam = &quot;EQUIPMENT_OK&quot;;
		} else {
			// weapons are removed from specific locations
			var lookup = null;
			if (this._sc_core) lookup = this._sc_core._equipmentMatrix[item];
			if (lookup) {
				space = parseFloat(lookup[0]);
				if (space === 0) space = 1;
				weight = parseFloat(lookup[1]);
			} else {
				space = 1;
				weight = 1;
			}

			var dam = &quot;EQUIPMENT_OK&quot;; // lasers can&#39;t be damaged
			var lmss = worldScripts.LMSS_Core;
			var bl = worldScripts.BreakableLasers_Main;
			switch (section) {
				case &quot;0&quot;:
					if (p.forwardWeapon.equipmentKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;FORWARD&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					p.forwardWeapon = &quot;EQ_WEAPON_NONE&quot;;
					break;
				case &quot;1&quot;:
					if (p.aftWeapon.equipmentKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;AFT&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					p.aftWeapon = &quot;EQ_WEAPON_NONE&quot;;
					break;
				case &quot;2&quot;:
					if (p.portWeapon.equipmentKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;PORT&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					p.portWeapon = &quot;EQ_WEAPON_NONE&quot;;
					break;
				case &quot;3&quot;:
					if (p.starboardWeapon.equipmentKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;STARBOARD&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					p.starboardWeapon = &quot;EQ_WEAPON_NONE&quot;
					break;
				case &quot;4&quot;:
					if (lmss._forwardAltKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;FORWARD&quot;].secondary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					lmss._forwardAltKey = &quot;EQ_WEAPON_NONE&quot;;
					p.removeEquipment(&quot;EQ_LMSS_FRONT_WEAPON&quot;);
					break;
				case &quot;5&quot;:
					if (lmss._aftAltKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;AFT&quot;].secondary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					lmss._aftAltKey = &quot;EQ_WEAPON_NONE&quot;;
					p.removeEquipment(&quot;EQ_LMSS_AFT_WEAPON&quot;);
					break;
				case &quot;6&quot;:
					if (lmss._portAltKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;PORT&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					lmss._portAltKey = &quot;EQ_WEAPON_NONE&quot;;
					p.removeEquipment(&quot;EQ_LMSS_PORT_WEAPON&quot;);
					break;
				case &quot;7&quot;:
					if (lmss._starboardAltKey == &quot;EQ_WEAPON_DAMAGED_LASER&quot;) {
						bl._holdDamage[&quot;STARBOARD&quot;].primary = &quot;&quot;;
						dam = &quot;EQUIPMENT_DAMAGED&quot;;
					}
					lmss._starboardAltKey = &quot;EQ_WEAPON_NONE&quot;;
					p.removeEquipment(&quot;EQ_LMSS_STARBOARD_WEAPON&quot;);
					break;
			}
			if (lmss) lmss.$updateManifest();
			if (bl) bl.$updateManifest();

			var idx = this.$countItemAtStation(item);
			// once stored, they will become just standard lasers, not allocated to any specific position on the ship
			// positions will be confirmed when lasers are re-installed 
		}

		// charge player deposit
		if (this.$storageSystemCount(galaxyNumber, system.ID) === 0) {
			player.credits -= this._establishmentFee;
			player.consoleMessage(formatCredits(this._establishmentFee, false, true) + &quot; deducted to open storage facility account&quot;, 5);
		}

		this._storage.push({
			galaxy: galaxyNumber,
			system: system.ID,
			systemName: system.name,
			equipmentKey: item,
			commodity: &quot;&quot;,
			space: space,
			weight: weight,
			status: dam,
			index: idx,
			inTransit: false,
			transitETA: 0,
			transitDestination: -1,
			transitSystem: -1,
			transitStart: 0
		});

		// give the player an email, if installed
		var ga = worldScripts.GalCopAdminServices;
		if (ga) {
			var email = worldScripts.EmailSystem;
			var storeName = expandDescription(this._compNames[system.ID % 16]);

			if (this.$storageSystemCount(galaxyNumber, system.ID) === 0) {
				// email T&amp;C&#39;s
			}

			// were we charged something, or did we get a refund?
			var cost = &quot;This item will be stored here at a rate of &quot; + formatCredits(this.$calculateStorageCost(space, weight), true, true) + &quot; per day.&quot;;

			var msg = expandDescription(&quot;[storeequip-email]&quot;, {
				storagename: storeName,
				equipname: info.name,
				equipcost: cost,
				sender: this.$salesRep()
			});

			email.$createEmail({
				sender: storeName,
				subject: &quot;Storing equipment&quot;,
				date: global.clock.adjustedSeconds,
				message: msg,
				expiryDays: ga._defaultExpiryDays
			});
		}
		if (this._sc_core) this._sc_core.$addEquipmentSpaceItem(p);
	}

	if (choice === &quot;95_NEXT&quot;) this._page += 1;
	if (choice === &quot;96_PREV&quot;) this._page -= 1;
	if (choice === &quot;98_SWITCH&quot;) {
		this._sc_core._source = &quot;&quot;;
		this._sc_core.$shipConfig();
		return;
	}

	if (this._sc_core &amp;&amp; this._sc_core._source === &quot;REMOVEITEM&quot;) return;

	if (choice != &quot;99_EXIT&quot;) {
		this.$storeEquipment();
		return;
	}

	if (choice === &quot;99_EXIT&quot;) {
		if (this._sc_core) {
			if (this._sc_core._source === &quot;CONFIGSCREEN&quot;) {
				this._sc_core._source = &quot;&quot;;
				this._sc_core.$shipConfig();
			}
			return;
		}
		this.$viewStoredItems();
	}
}

//-------------------------------------------------------------------------------------------------------------
// initialise the equipment specification list
this.$initInterface = function $initInterface(station) {
	// no access in interstellar space
	if (system.ID === -1) {
		station.setInterface(this.name, null);
		return;
	}
	if (this.$stationHasStorageFacilities(station) === true) {
		station.setInterface(this.name, {
			title: &quot;Storage facility management&quot;,
			category: &quot;Station Interfaces&quot;,
			summary: &quot;Lists any equipment or cargo you have stored at this station or in other systems.&quot;,
			callback: this.$openStorageListing.bind(this)
		});
	} else {
		station.setInterface(this.name, {
			title: &quot;Storage facility information&quot;,
			category: &quot;Station Interfaces&quot;,
			summary: &quot;Lists any equipment or cargo you have stored at the main station or in other systems.&quot;,
			callback: this.$openStorageListing.bind(this)
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$openStorageListing = function $openStorageListing() {
	this._page = 0;
	this._display = 0;
	this._displayType = 0;
	this.$viewStoredItems();
}

//-------------------------------------------------------------------------------------------------------------
// views mission screen showing currently stored equipment
this.$viewStoredItems = function $viewStoredItems() {
	function compare(a, b) {
		return (b.sort &gt; a.sort ? -1 : 1);
	}

	var p = player.ship;
	var stn = p.dockedStation;

	var text = &quot;&quot;;
	var curChoices = {};
	var itemcount = 0;
	var list = [];

	var pagesize = 20;
	this._hudHidden = p.hudHidden;
	if (this.$isBigGuiActive() === false) p.hudHidden = true;
	if (this._sc_core) this._sc_core._configScreen = true;

	// main list
	if (this._display === 0) {
		pagesize = 19;
		text += expandDescription(this._compNames[system.ID % 16]) + &quot; Facility Management&quot; + (p.dockedStation.isMainStation === true ? &quot;&quot; : &quot; (at Main Station)&quot;) + &quot;\n\n&quot;;

		text += this.$padTextRight(expandDescription(&quot;Item&quot;), 16) +
			this.$padTextRight(&quot;Location&quot;, 10) +
			this.$padTextLeft(&quot;Cost&quot;, 6) + &quot;\n&quot;;

		for (var i = 0; i &lt; this._storage.length; i++) {
			if (this._displayType === 1 || (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system === system.ID) || this._storage[i].inTransit === true) {
				if (this._storage[i].equipmentKey != &quot;&quot;) {
					var equip = EquipmentInfo.infoForKey(this._storage[i].equipmentKey);
					if (equip) { // only display equipment items that are currently installed (in case an OXP is removed)
						var colr = this._menuColor;
						if (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system === system.ID) colr = this._installedColor;
						if (this._storage[i].status === &quot;EQUIPMENT_DAMAGED&quot;) colr = this._damagedColor;
						if (this._storage[i].galaxy != galaxyNumber) colr = &quot;blueColor&quot;;
						if (this._storage[i].inTransit === true) colr = this._riskColor;

						var info = null;
						var dist = 0;
						if (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system != system.ID &amp;&amp; this._storage[i].system &gt;= 0) {
							info = System.infoForSystem(galaxyNumber, this._storage[i].system);
							var route = system.info.routeToSystem(info);
							if (route &amp;&amp; route.route.length &gt; 0) dist = route.distance;
						}

						list.push({
							equipmentName: &quot;Equipment: &quot; + (equip.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : equip.name),
							location: (this._storage[i].inTransit === false ? this._storage[i].systemName + &quot; &quot; + (info != null ? &quot;(dist: &quot; + dist.toFixed(1) + &quot;ly)&quot; : (this._storage[i].galaxy != galaxyNumber ? &quot;(G&quot; + (this._storage[i].galaxy + 1) + &quot;)&quot; : &quot;&quot;)) : &quot;In transit&quot;),
							cost: formatCredits(this.$calculateStorageCost(this._storage[i].space, this._storage[i].weight), true, true) + &quot; / day&quot;,
							equipmentKey: this._storage[i].equipmentKey,
							commodity: &quot;&quot;,
							galaxy: this._storage[i].galaxy,
							system: this._storage[i].system,
							color: colr,
							sort: this._storage[i].galaxy + &quot;_&quot; + this._storage[i].systemName + &quot;_&quot; + equip.name,
							id: this._storage[i].galaxy + &quot;|&quot; + this._storage[i].system + &quot;|&quot; + this._storage[i].equipmentKey + &quot;|&quot; + this._storage[i].index
						});
					}
				}
				if (this._storage[i].commodity != &quot;&quot; &amp;&amp; this._commodities.indexOf(this._storage[i].commodity) &gt;= 0) {
					var colr = this._menuColor;
					if (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system === system.ID) colr = this._installedColor;
					if (this._storage[i].galaxy != galaxyNumber) colr = &quot;blueColor&quot;;
					if (this._storage[i].inTransit === true) colr = this._riskColor;

					var info = null;
					var dist = 0;
					if (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system != system.ID &amp;&amp; this._storage[i].system &gt;= 0) {
						info = System.infoForSystem(galaxyNumber, this._storage[i].system);
						var route = system.info.routeToSystem(info);
						if (route &amp;&amp; route.route.length &gt; 0) dist = route.distance;
					}

					list.push({
						equipmentName: &quot;Cargo: &quot; + this._storage[i].weight + this.$getCommodityType(this._storage[i].commodity) + &quot; × &quot; + displayNameForCommodity(this._storage[i].commodity),
						location: (this._storage[i].inTransit === false ? this._storage[i].systemName + &quot; &quot; + (info != null ? &quot;(dist: &quot; + dist.toFixed(1) + &quot;ly)&quot; : (this._storage[i].galaxy != galaxyNumber ? &quot;(G&quot; + (this._storage[i].galaxy + 1) + &quot;)&quot; : &quot;&quot;)) : &quot;In transit&quot;),
						cost: formatCredits(this.$calculateStorageCost(this._storage[i].space, this._storage[i].weight, this.$getCommodityType(this._storage[i].commodity)), true, true) + &quot; / day&quot;,
						equipmentKey: &quot;&quot;,
						commodity: this._storage[i].commodity,
						galaxy: this._storage[i].galaxy,
						system: this._storage[i].system,
						color: colr,
						sort: this._storage[i].galaxy + &quot;_&quot; + this._storage[i].systemName + &quot;_zz&quot; + displayNameForCommodity(this._storage[i].commodity), // ensure cargo items come after equipment
						id: this._storage[i].galaxy + &quot;|&quot; + this._storage[i].system + &quot;|&quot; + this._storage[i].commodity + &quot;|&quot; + this._storage[i].index
					});

				}
			}
		}

		if (list.length &gt; 0) {
			list.sort(compare);

			var maxpage = Math.ceil(list.length / pagesize);
			if (maxpage &lt; (this._page + 1)) this._page -= 1;
			var end = ((this._page * pagesize) + pagesize);
			if (end &gt; list.length) end = list.length;
			// note: the station equipmentPriceFactor has been removed to prevent exploitation of equipment sales at different stations (galcop =&gt; rock hermit)
			for (var i = (this._page * pagesize); i &lt; end; i++) {
				curChoices[&quot;01_EQUIP-&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;~&quot; + list[i].id] = {
					text: this.$padTextRight(list[i].equipmentName, 16) +
						this.$padTextRight(list[i].location, 10) +
						this.$padTextLeft(list[i].cost, 6),
					alignment: &quot;LEFT&quot;,
					color: list[i].color
				};
				itemcount += 1;
			}
			for (var i = 0; i &lt; (pagesize - itemcount) + (p.dockedStation.isMainStation === false ? 1 : 0); i++) {
				curChoices[&quot;90_SPACER_&quot; + i] = &quot;&quot;;
			}
		} else {
			text += expandDescription(&quot;[storage-equip-none]&quot;);
		}

		if (p.dockedStation.isMainStation === true) {
			if (this.$storageSystemCount(galaxyNumber, system.ID) === 0 &amp;&amp; player.credits &lt; this._establishmentFee) {
				if (!this._sc_core) {
					curChoices[&quot;96_Z_STOREEQUIP&quot;] = {
						text: expandDescription(&quot;[storage-store-equipment]&quot;) + &quot; (insufficient credits to open account)&quot;,
						color: this._disabledColor,
						unselectable: true
					};
				}
				curChoices[&quot;98_MOVECARGO&quot;] = {
					text: expandDescription(&quot;[storage-move-cargo]&quot;) + &quot; (insufficient credits to open account)&quot;,
					color: this._disabledColor,
					unselectable: true
				};
			} else {
				if (!this._sc_core) {
					curChoices[&quot;96_Z_STOREEQUIP&quot;] = {
						text: expandDescription(&quot;[storage-store-equipment]&quot;),
						color: this._itemColor,
					};
				}
				curChoices[&quot;98_MOVECARGO&quot;] = {
					text: &quot;[storage-move-cargo]&quot;,
					color: this._itemColor
				};
			}
		}

		if (maxpage &gt; 1 &amp;&amp; this._page &lt; (maxpage - 1)) {
			curChoices[&quot;95_NEXT&quot;] = {
				text: &quot;[storage-nextpage]&quot;,
				color: this._itemColor
			};
		} else {
			curChoices[&quot;95_NEXT&quot;] = {
				text: &quot;[storage-nextpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}
		if (this._page &gt; 0) {
			curChoices[&quot;96_PREV&quot;] = {
				text: &quot;[storage-prevpage]&quot;,
				color: this._itemColor
			};
		} else {
			curChoices[&quot;96_PREV&quot;] = {
				text: &quot;[storage-prevpage]&quot;,
				color: this._disabledColor,
				unselectable: true
			};
		}

		if (this._displayType === 1) {
			curChoices[&quot;97_SHOWLOCAL&quot;] = {
				text: &quot;[storage-showlocal]&quot;,
				color: this._itemColor
			};
		} else {
			curChoices[&quot;97_SHOWALL&quot;] = {
				text: &quot;[storage-showall]&quot;,
				color: this._itemColor
			};
		}

		curChoices[&quot;99_EXIT&quot;] = {
			text: &quot;Exit&quot;,
			color: this._itemColor
		};

		var def = &quot;99_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-main-map&quot;,
			title: &quot;Storage - &quot; + (this._displayType === 0 ? &quot;Local&quot; : &quot;All Systems&quot;),
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// equipment details
	if (this._display === 1) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
		}

		var info = null;
		var dist = 0;
		var jumps = 0;
		var danger = 0;
		var illegal = 0;
		var time = 0;
		if (item.galaxy === galaxyNumber &amp;&amp; item.system != system.ID &amp;&amp; item.system &gt;= 0) {
			this.$revealMap();
			info = System.infoForSystem(galaxyNumber, item.system);
			var route = system.info.routeToSystem(info);
			jumps = route.route.length;
			dist = route.distance;
			danger = this.$checkRouteDangerLevel(route);
			if (item.commodity != &quot;&quot;) illegal = this.$checkRouteIllegalLevel(route, item.commodity);
			time = route.time;
			this.$restoreMap();
		}

		if (item.equipmentKey != &quot;&quot;) {
			text = this.$padTextRight(&quot;Equipment item:&quot;, 10) + (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : equip.name) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Equipment status:&quot;, 10) + (item.status === &quot;EQUIPMENT_OK&quot; ? &quot;OK&quot; : &quot;Damaged&quot;) + &quot;\n&quot;;
			if (this._sc_core) {
				if (parseFloat(item.space) === 0 &amp;&amp; parseFloat(item.weight) === 0) {
					text += this.$padTextRight(&quot;Space/weight:&quot;, 10) + &quot;Negligible\n&quot;;
				} else {
					text += this.$padTextRight(&quot;Space/weight:&quot;, 10) + (parseFloat(item.space) === 0 ? item.weight : item.space) + &quot;t/&quot; + item.weight + &quot;t\n&quot;;
				}
			}
			text += this.$padTextRight(&quot;Storage cost:&quot;, 10) + formatCredits(this.$calculateStorageCost(item.space, item.weight), true, true) + &quot; per day\n&quot;;
		}
		if (item.commodity != &quot;&quot;) {
			text = this.$padTextRight(&quot;Cargo type:&quot;, 10) + displayNameForCommodity(item.commodity) + &quot;\n&quot;;
			if (this._sc_core) {
				var spcwt = this.$cargoSpaceRequired(this.$getCommodityType(item.commodity), item.weight);
				text += this.$padTextRight(&quot;Space/weight:&quot;, 10) + spcwt + &quot;t/&quot; + item.weight + this.$getCommodityType(item.commodity) + &quot;\n&quot;;
			}
			text += this.$padTextRight(&quot;Storage cost:&quot;, 10) + formatCredits(this.$calculateStorageCost(item.space, item.weight, this.$getCommodityType(item.commodity)), true, true) + &quot; per day\n&quot;;
		}
		if (item.system != -1) {
			text += this.$padTextRight(&quot;Location:&quot;, 10) +
				item.systemName + &quot; &quot; + (info != null ? &quot;(dist: &quot; + dist.toFixed(1) + &quot;ly)&quot; : (item.galaxy != galaxyNumber ? &quot;(G&quot; + (item.galaxy + 1) + &quot;)&quot; : &quot;&quot;)) + &quot;\n&quot;;
		} else {
			text += this.$padTextRight(&quot;Location:&quot;, 10) + &quot;In transit\n&quot;;
			var eta = this.$getTimeRemaining(item.transitETA);
			text += this.$padTextRight(&quot;ETA:&quot;, 10) + System.systemNameForID(item.transitDestination) + (eta === &quot;Overdue&quot; ? &quot; - delivery overdue&quot; : &quot; in &quot; + eta) + &quot;\n&quot;;
		}
		var tfrcost = 0;
		if (dist &gt; 0) {
			tfrcost = this.$calculateTransferCost(dist, jumps, danger, illegal);
			text += this.$padTextRight(&quot;Transfer cost:&quot;, 10) + formatCredits(tfrcost, true, true) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Transfer time:&quot;, 10) + time.toFixed(1) + &quot; hrs\n&quot;;
			text += this.$padTextRight(&quot;Transfer risk:&quot;, 10) + expandDescription(&quot;[transfer-danger-&quot; + danger + &quot;]&quot;) + &quot;\n&quot;;
		}

		if (dist &gt; 7.5) {
			curChoices[&quot;25_SHOWMAP_LONG&quot;] = {
				text: &quot;[storage-showmap]&quot;,
				color: this._itemColor
			};
		} else if (dist &gt; 0 &amp;&amp; dist &lt;= 7.5) {
			curChoices[&quot;25_SHOWMAP_SHORT&quot;] = {
				text: &quot;[storage-showmap]&quot;,
				color: this._itemColor
			};
		}
		if (dist &gt; 0 &amp;&amp; player.credits &gt;= tfrcost) {
			if (item.equipmentKey != &quot;&quot;) {
				curChoices[&quot;26_TRANSFER&quot;] = {
					text: &quot;[storage-transfer]&quot;,
					color: this._itemColor
				};
			} else if (item.commodity != &quot;&quot;) {
				curChoices[&quot;26_TRANSFER&quot;] = {
					text: &quot;[storage-transfer-cargo]&quot;,
					color: this._itemColor
				};
			}
		}
		if (item.inTransit === true) {
			curChoices[&quot;35_WAIT&quot;] = {
				text: &quot;[storage-wait]&quot;,
				color: this._itemColor
			};
		}
		// can only install items if we&#39;re in the same system and at the main station
		if (item.galaxy === galaxyNumber &amp;&amp; item.system === system.ID &amp;&amp; p.dockedStation.isMainStation === true) {
			if (item.equipmentKey != &quot;&quot;) {
				// can we install this item?
				var inst = true;
				var reason = &quot;&quot;;
				var curr = p.equipmentStatus(item.equipmentKey);

				if (p.canAwardEquipment(item.equipmentKey) === false) {
					inst = false;
					reason = &quot; (required equipment item not installed or item not permitted)&quot;;
				}
				// special case for shield boosters
				//if (item.equipmentKey === &quot;EQ_NAVAL_SHIELD_BOOSTER&quot; &amp;&amp; p.equipmentStatus(&quot;EQ_SHIELD_BOOSTER&quot;) != &quot;EQUIPMENT_OK&quot;) {inst = false; reason = &quot; (required equipment item not installed)&quot;;}

				// if we can&#39;t carry multiple versions of it, and we already have one, then no
				if (curr === &quot;EQUIPMENT_OK&quot; &amp;&amp; equip.canCarryMultiple === false) {
					inst = false;
					reason = &quot; (already installed)&quot;;
				}
				// reset for laser items
				if (item.equipmentKey.indexOf(&quot;EQ_WEAPON&quot;) &gt;= 0) {
					inst = true;
					reason = &quot;&quot;;
				}
				// if the current item of the same time is damaged, and so&#39;s the one in storage, then nodeName
				// (otherwise it can be used to fix the broken one)
				if (curr === &quot;EQUIPMENT_DAMAGED&quot; &amp;&amp; item.status === &quot;EQUIPMENT_DAMAGED&quot;) {
					inst = false;
					reason = &quot; (both items damaged)&quot;;
				}
				// do we have room for it, or will it put the ship into overload?
				var eq = EquipmentInfo.infoForKey(item.equipmentKey);
				if (eq.requiredCargoSpace &gt; 0 &amp;&amp; p.cargoSpaceAvailable &lt; eq.requiredCargoSpace) {
					inst = false;
					reason = &quot; (insufficient cargo space)&quot;;
				}
				var lookup = null;
				if (this._sc_core) lookup = this._sc_core._equipmentMatrix[item.equipmentKey];
				if (lookup) {
					var equipSpace = this._sc_core.$availableEquipmentSpace(p);
					// subtract the space the existing item is taking up
					if (curr === &quot;EQUIPMENT_OK&quot; || curr === &quot;EQUIPMENT_DAMAGED&quot;) equipSpace += lookup[0];
					if (lookup[0] &gt; equipSpace) {
						inst = false;
						reason = &quot; (insufficient equipment space)&quot;;
					}
				}

				if (inst === true) {
					curChoices[&quot;30_INSTALL&quot;] = {
						text: &quot;[storage-install]&quot;,
						color: this._itemColor
					};
				} else {
					curChoices[&quot;30_INSTALL&quot;] = {
						text: expandDescription(&quot;[storage-install]&quot; + reason),
						color: this._disabledColor,
						unselectable: true
					};
				}
			}
			if (item.commodity != &quot;&quot;) {
				// can we transfer any of this cargo into our hold
				var inst = true;
				var reason = &quot;&quot;;
				if (p.cargoSpaceAvailable === 0) {
					inst = false;
					reason = &quot; (insufficient cargo space)&quot;;
				}
				if (inst === true) {
					curChoices[&quot;31_LOAD&quot;] = {
						text: &quot;[storage-load-cargo]&quot;,
						color: this._itemColor
					};
				} else {
					curChoices[&quot;31_LOAD&quot;] = {
						text: expandDescription(&quot;[storage-load-cargo]&quot; + reason),
						color: this._disabledColor,
						unselectable: true
					};
				}
			}
		}

		// work out item cost
		if (item.equipmentKey != &quot;&quot;) {
			if (item.inTransit === false &amp;&amp; equip.techLevel &lt;= 14 &amp;&amp; item.galaxy === galaxyNumber) {
				var sellcost = equip.price / 10 * (item.status === &quot;EQUIPMENT_DAMAGED&quot; ? 0.5 : (item.equipmentKey.indexOf(&quot;EQ_WEAPON&quot;) &gt;= 0 ? 1 : this._refundPct)); // * factor;
				curChoices[&quot;70_SELL&quot;] = {
					text: expandDescription(&quot;[storage-sell]&quot;, {
						cost: formatCredits(sellcost, true, true)
					}),
					color: this._itemColor
				};
			}
		}
		if (item.commodity != &quot;&quot;) {
			// can only sell stored cargo when you&#39;re in the same system
			if (item.inTransit === false &amp;&amp; item.galaxy === galaxyNumber) {
				var pcsfee = 1;
				var maxqty = item.weight;
				var sellcost = 0;
				var price = 0;
				if (item.system === system.ID) {
					if ((item.weight + system.mainStation.market[item.commodity].quantity) &gt; 127) {
						maxqty = 127 - system.mainStation.market[item.commodity].quantity;
					}
					// 10% price penalty for selling remotely
					if (p.dockedStation.isMainStation === false) pcsfee = 0.9;
					price = (system.mainStation.market[item.commodity].price / 10) * pcsfee;

				} else {
					if (item.weight + Math.floor(system.scrambledPseudoRandomNumber(77) * 127) &gt; 127) {
						maxqty = 127 - Math.floor(system.scrambledPseudoRandomNumber(77) * 127);
					}
					// price will be 20% less than the sample price
					pcsfee = 0.8;
					price = this.$getSamplePrice(item.system, item.commodity) * pcsfee;
				}
				// only show the sell option if we can sell something
				if (maxqty &gt; 0) {
					sellcost = price * maxqty;
					curChoices[&quot;71_SELL&quot;] = {
						text: expandDescription(&quot;[storage-sell]&quot;, {
							cost: maxqty + this.$getCommodityType(item.commodity) + &quot; @ &quot; + price.toFixed(1) + &quot;, total &quot; + formatCredits(sellcost, true, true) + (pcsfee &lt; 1 ? &quot; incl &quot; + ((1 - pcsfee) * 100).toFixed(0) + &quot;% process fee&quot; : &quot;&quot;)
						}),
						color: this._itemColor
					};
				} else {
					curChoices[&quot;71_SELL&quot;] = {
						text: &quot;[storage-nosell]&quot;,
						color: this._disabledColor,
						unselectable: true
					};
				}
			}
		}
		// give player the option of dumping stuff in other galaxies (you&#39;re unable to do business transactions from different sectors)
		if (item.galaxy != galaxyNumber) {
			curChoices[&quot;80_DUMP&quot;] = {
				text: &quot;[storage-dump]&quot;,
				color: this._itemColor
			};
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};

		var def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-item-map&quot;,
			title: &quot;Storage - &quot; + (item.inTransit === true ? &quot;In Transit&quot; : item.systemName),
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// show short range map to location
	if (this._display === 2) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];

		// hold the player&#39;s destination
		this._suspendedDestination = p.targetSystem;
		// override it for the display
		p.targetSystem = item.system;

		var bg = &quot;SHORT_RANGE_CHART&quot;;
		curChoices[&quot;20_RETURN&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};
		if (item.system != system.ID &amp;&amp; item.system &gt;= 0 &amp;&amp; this.$playerTargetSystem() != item.system &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			curChoices[&quot;96_SETCOURSE~&quot; + item.system] = {
				text: &quot;Set course for &quot; + item.systemName,
				color: this._itemColor
			};
		}

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};

		def = &quot;20_RETURN&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-shortrangechart-map&quot;,
			title: &quot;Storage - Chart&quot;,
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// show long range map to location
	if (this._display === 3) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];

		// hold the player&#39;s destination
		this._suspendedDestination = p.targetSystem;
		// override it for the display
		p.targetSystem = item.system;

		var bg = &quot;LONG_RANGE_CHART&quot;;
		if (p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) bg = &quot;LONG_RANGE_CHART_SHORTEST&quot;;

		curChoices[&quot;20_RETURN&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};
		if (item.system != system.ID &amp;&amp; item.system &gt;= 0 &amp;&amp; this.$playerTargetSystem() != item.system &amp;&amp; p.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;)) {
			curChoices[&quot;96_SETCOURSE~&quot; + item.system] = {
				text: &quot;Set course for &quot; + item.systemName,
				color: this._itemColor
			};
		}

		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};

		def = &quot;20_RETURN&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-longrangechart-map&quot;,
			title: &quot;Storage - Chart&quot;,
			backgroundSpecial: bg,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// request transfer
	if (this._display === 4) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
		}

		var info = null;
		var dist = 0;
		var jumps = 0;
		var danger = 0;
		var illegal = 0;
		var time = 0;
		if (item.galaxy === galaxyNumber &amp;&amp; item.system != system.ID &amp;&amp; item.system &gt;= 0) {
			this.$revealMap();
			info = System.infoForSystem(galaxyNumber, item.system);
			var route = system.info.routeToSystem(info);
			jumps = route.route.length;
			dist = route.distance;
			danger = this.$checkRouteDangerLevel(route);
			if (item.commodity != &quot;&quot;) illegal = this.$checkRouteIllegalLevel(route, item.commodity);
			time = route.time;
			this.$restoreMap();
		}

		if (item.equipmentKey != &quot;&quot;) {
			text = this.$padTextRight(&quot;Equipment item:&quot;, 10) + (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : equip.name) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Equipment status:&quot;, 10) + (item.status === &quot;EQUIPMENT_OK&quot; ? &quot;OK&quot; : &quot;Damaged&quot;) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Space/weight:&quot;, 10) + (item.space === 0 ? item.weight : item.space) + &quot;t/&quot; + item.weight + &quot;t\n&quot;;
			text += this.$padTextRight(&quot;Storage cost:&quot;, 10) + formatCredits(this.$calculateStorageCost(item.space, item.weight), true, true) + &quot; per day\n&quot;;
		}
		if (item.commodity != &quot;&quot;) {
			text = this.$padTextRight(&quot;Cargo type:&quot;, 10) + displayNameForCommodity(item.commodity) + &quot;\n&quot;;
			var spcwt = this.$cargoSpaceRequired(this.$getCommodityType(item.commodity), item.weight);
			text += this.$padTextRight(&quot;Space/weight:&quot;, 10) + spcwt + &quot;t/&quot; + item.weight + this.$getCommodityType(item.commodity) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Storage cost:&quot;, 10) + formatCredits(this.$calculateStorageCost(item.space, item.weight, this.$getCommodityType(item.commodity)), true, true) + &quot; per day\n&quot;;
		}
		if (item.system != -1) {
			text += this.$padTextRight(&quot;Location:&quot;, 10) +
				item.systemName + &quot; &quot; + (info != null ? &quot;(dist: &quot; + dist.toFixed(1) + &quot;ly)&quot; : (item.galaxy != galaxyNumber ? &quot;(G&quot; + (item.galaxy + 1) + &quot;)&quot; : &quot;&quot;)) + &quot;\n&quot;;
		} else {
			text += this.$padTextRight(&quot;Location:&quot;, 10) + &quot;In transit\n&quot;;
			var eta = this.$getTimeRemaining(item.transitETA);
			text += this.$padTextRight(&quot;ETA:&quot;, 10) + System.systemNameForID(item.transitDestination) + (eta === &quot;Overdue&quot; ? &quot; - delivery overdue&quot; : &quot; in &quot; + eta) + &quot;\n&quot;;
		}
		if (dist &gt; 0) {
			var tfrcost = this.$calculateTransferCost(dist, jumps, danger, illegal);
			text += this.$padTextRight(&quot;Transfer cost:&quot;, 10) + formatCredits(tfrcost, true, true) + &quot;\n&quot;;
			text += this.$padTextRight(&quot;Transfer time:&quot;, 10) + time.toFixed(1) + &quot; hrs\n&quot;;
			text += this.$padTextRight(&quot;Transfer risk:&quot;, 10) + expandDescription(&quot;[transfer-danger-&quot; + danger + &quot;]&quot;) + &quot;\n&quot;;
		}

		if (item.commodity != &quot;&quot; &amp;&amp; illegal &gt; 0) {
			text += &quot;\n\nNote: The transfer cost includes premiums for bribing officials.&quot;;
		}
		text += &quot;\n\nDo you want to wait here for this item to arrive?&quot;;

		curChoices[&quot;40_YES&quot;] = {
			text: &quot;Yes&quot;,
			color: this._itemColor
		};
		curChoices[&quot;41_NO&quot;] = {
			text: &quot;No&quot;,
			color: this._itemColor
		};
		curChoices[&quot;42_CANCEL&quot;] = {
			text: &quot;Cancel transfer&quot;,
			color: this._itemColor
		};
		def = &quot;42_CANCEL&quot;;

		var opts = {
			screenID: &quot;oolite-storage-item-map&quot;,
			title: &quot;Storage - &quot; + item.systemName,
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// transfer cargo to storage - select commodity
	if (this._display === 5) {
		var cargo = p.manifest.list;
		var itemcount = 1;
		var sdm = worldScripts.Smugglers_DockMaster;
		var gcm = worldScripts.GalCopBB_Missions;

		var notAllowed = [&quot;slaves&quot;, &quot;firearms&quot;, &quot;narcotics&quot;];

		text = &quot;Select the cargo you want to transfer into storage:\n&quot;;
		if (this.$storageSystemCount(galaxyNumber, system.ID) === 0) {
			text += &quot;(Note: &quot; + formatCredits(this._establishmentFee, false, true) + &quot; will be charged to establish account)\n&quot;;
			itemcount += 1;
		}
		for (var i = 0; i &lt; cargo.length; i++) {
			// make sure we don&#39;t store relabelled cargo
			var q = cargo[i].quantity;
			if (sdm &amp;&amp; sdm._cargoLabelled.length &gt; 0) {
				for (var j = 0; j &lt; sdm._cargoLabelled.length; j++) {
					if (sdm._cargoLabelled[j].newCommodity === cargo[i].commodity) q -= sdm._cargoLabelled[j].quantity;
				}
			}
			// make sure we&#39;re not storing something required for a mission that would stop that mission from working.
			if (gcm) {
				var restr = gcm.$cargoRestricted(cargo[i].commodity);
				q -= restr;
			}
			if (q &gt; 0) {
				var unselect = false;
				if (notAllowed.indexOf(cargo[i].commodity) &gt;= 0) unselect = true
				curChoices[&quot;50_&quot; + (i &lt; 10 ? &quot;0&quot; : &quot;&quot;) + i + &quot;_CARGO~&quot; + cargo[i].commodity] = {
					text: cargo[i].displayName + &quot; (&quot; + q + cargo[i].unit + &quot;)&quot; + (unselect === true ? &quot; - Not permitted&quot; : &quot;&quot;),
					color: (unselect === false ? this._menuColor : this._disabledColor),
					unselectable: unselect
				};
				itemcount += 1;
			}
		}

		for (var i = 0; i &lt; (25 - itemcount); i++) {
			curChoices[&quot;97_SPACER_&quot; + i] = &quot;&quot;;
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};

		var def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-cargo-map&quot;,
			title: &quot;Storage - Cargo&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};

	}

	// how much of the cargo should be transferred
	if (this._display === 6) {
		// either from storage (tfrType = 1) or ships hold (tfrType = 0)
		this.$getTransferAmount();
		return;
	}

	// confirm dumping
	if (this._display === 7) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		var itmText = &quot;&quot;;
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
			itmText = &quot; - &quot; + (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : equip.name);
		}
		if (item.commodity != &quot;&quot;) {
			itmText = &quot; - &quot; + item.weight + this.$getCommodityType(item.commodity) + &quot; × &quot; + displayNameForCommodity(item.commodity);
		}

		text = expandDescription(&quot;[storage-dump-confirm]&quot;, {
			item: itmText
		});

		curChoices[&quot;81_YES&quot;] = {
			text: &quot;Yes&quot;,
			color: this._itemColor
		};
		curChoices[&quot;82_NO&quot;] = {
			text: &quot;No&quot;,
			color: this._itemColor
		};

		var def = &quot;82_NO&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-cargo-map&quot;,
			title: &quot;Storage - Dump Item&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	// install laser
	if (this._display === 8) {
		var itemcount = 3;
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
		}
		text = &quot;Install: &quot; + equip.name + &quot;\n\nSelect the position into which you want to install this weapon:\n&quot;;

		var lmss = worldScripts.LMSS_Core;
		var section = [&quot;Forward&quot;, &quot;Aft&quot;, &quot;Port&quot;, &quot;Starboard&quot;, &quot;Forward - Secondary&quot;, &quot;Aft - Secondary&quot;, &quot;Port - Secondary&quot;, &quot;Starboard - Secondary&quot;];

		for (var i = 0; i &lt; 7; i++) {
			var curr = &quot;X&quot;;
			switch (i) {
				case 0:
					if (&quot; 1 3 5 7 9 11 13 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						curr = p.forwardWeapon.equipmentKey;
					break;
				case 1:
					if (&quot; 2 3 6 7 10 11 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						curr = p.aftWeapon.equipmentKey;
					break;
				case 2:
					if (&quot; 4 5 6 7 12 13 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						curr = p.portWeapon.equipmentKey;
					break;
				case 3:
					if (&quot; 8 9 10 11 12 13 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						curr = p.starboardWeapon.equipmentKey;
					break;
				case 4:
					if (&quot; 1 3 5 7 9 11 13 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						if (lmss &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_FRONT&quot;) === &quot;EQUIPMENT_OK&quot;) curr = lmss._forwardAltKey;
					break;
				case 5:
					if (&quot; 2 3 6 7 10 11 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						if (lmss &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_AFT&quot;) === &quot;EQUIPMENT_OK&quot;) curr = lmss._aftAltKey;
					break;
				case 6:
					if (&quot; 4 5 6 7 12 13 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						if (lmss &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_PORT&quot;) === &quot;EQUIPMENT_OK&quot;) curr = lmss._portAltKey;
					break;
				case 7:
					if (&quot; 8 9 10 11 12 13 14 15 &quot;.indexOf(&quot; &quot; + p.weaponFacings.toString() + &quot; &quot;) &gt;= 0)
						if (lmss &amp;&amp; p.equipmentStatus(&quot;EQ_LMSS_STARBOARD&quot;) === &quot;EQUIPMENT_OK&quot;) curr = lmss._starboardAltKey;
					break;
			}
			if (curr !== &quot;X&quot;) {
				itemcount += 1;
				if (curr === &quot;&quot; || curr === &quot;EQ_WEAPON_NONE&quot;) {
					curChoices[(60 + i) + &quot;_WEAPON~&quot; + item.equipmentKey] = {
						text: this.$padTextRight(section[i], 31),
						color: this._menuColor,
						unselectable: false
					};
				} else {
					curChoices[(60 + i) + &quot;_WEAPON~&quot; + item.equipmentKey] = {
						text: this.$padTextRight(section[i], 10) + this.$padTextLeft(&quot;Current: &quot; + EquipmentInfo.infoForKey(curr).name, 21),
						color: this._disabledColor,
						unselectable: true
					};
				}
			}
		}
		for (var i = 0; i &lt; (25 - itemcount); i++) {
			curChoices[&quot;97_SPACER_&quot; + i] = &quot;&quot;;
		}
		curChoices[&quot;98_EXIT&quot;] = {
			text: &quot;[storage-return]&quot;,
			color: this._itemColor
		};

		var def = &quot;98_EXIT&quot;;
		if (this._lastChoice[this._display] != &quot;&quot;) def = this._lastChoice[this._display];

		var opts = {
			screenID: &quot;oolite-storage-item-map&quot;,
			title: &quot;Storage - Weapon Installation&quot;,
			allowInterrupt: true,
			overlay: {
				name: &quot;equipstorage.png&quot;,
				height: 546
			},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: def,
			message: text
		};
	}

	mission.runScreen(opts, this.$itemStorageScreenHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$itemStorageScreenHandler = function $itemStorageScreenHandler(choice) {

	if (this._suspendedDestination) player.ship.targetSystem = this._suspendedDestination;
	this._suspendedDestination = null;

	if (choice == null) return;

	var p = player.ship;
	var stn = p.dockedStation;
	this._lastChoice[this._display] = choice;

	if (choice.indexOf(&quot;01_EQUIP&quot;) &gt;= 0) {
		this._selectedItem = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._display = 1;
	}
	if (choice === &quot;20_RETURN&quot;) this._display = 1;
	if (choice === &quot;25_SHOWMAP_SHORT&quot;) this._display = 2;
	if (choice === &quot;25_SHOWMAP_LONG&quot;) this._display = 3;

	if (choice === &quot;26_TRANSFER&quot;) this._display = 4;
	if (choice === &quot;35_WAIT&quot;) {
		// switch over to the wait option
		choice = &quot;40_YES&quot;;
	}
	if (choice === &quot;30_INSTALL&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		// for laser weapons, we need to check what position it will be loaded into
		if (item.equipmentKey.indexOf(&quot;EQ_WEAPON&quot;) &gt;= 0) {
			this._display = 8;
		} else {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);

			this._display = 0;

			// we should only get here if it&#39;s possible to install the equipment, so we shouldn&#39;t need to do any extra checks
			if (p.equipmentStatus(item.equipmentKey) === &quot;EQUIPMENT_DAMAGED&quot;) {
				if (equip.techLevel &lt;= 14) {
					// ask the player if they want to keep the damaged item?
					var curChoices = {};
					var sellcost = equip.price / 10 * 0.5 * this._refundPct;
					curChoices[&quot;01_SELL&quot;] = &quot;Sell item (&quot; + formatCredits(sellcost, true, true) + &quot;)&quot;;
					curChoices[&quot;02_STORE&quot;] = &quot;Store item&quot;;
					var opts = {
						screenID: &quot;oolite-storage-swapout-map&quot;,
						title: &quot;Storage - &quot; + item.systemName,
						allowInterrupt: false,
						overlay: {
							name: &quot;equipstorage.png&quot;,
							height: 546
						},
						exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
						choices: curChoices,
						message: expandDescription(&quot;[storage-sellorstore]&quot;),
					};
					mission.runScreen(opts, this.$sellOrStoreDamaged, this);
					return;
				} else {
					// no choice but to store the item, so swap it out
					p.setEquipmentStatus(item.equipmentKey, &quot;EQUIPMENT_OK&quot;);
					item.status = &quot;EQUIPMENT_DAMAGED&quot;;
					player.consoleMessage(&quot;Damaged item replaced with working item, damaged item stored.&quot;);
				}
			} else {
				if (p.awardEquipment(item.equipmentKey) === true) {
					if (item.status === &quot;EQUIPMENT_DAMAGED&quot;) p.setEquipmentStatus(item.equipmentKey, &quot;EQUIPMENT_DAMAGED&quot;);
					player.consoleMessage(&quot;Item installed from storage.&quot;);
					if (item.equipmentKey.indexOf(&quot;EQ_LMSS&quot;) &gt;= 0) {
						worldScripts.LMSS_Core.playerBoughtEquipment(item.equipmentKey);
					}
					this._storage.splice(itemIndex, 1);
				} else {
					player.consoleMessage(&quot;!ALERT! Unable to install equipment.&quot;);
					this._display = 1;
				}
			}
		}
	}
	if (choice === &quot;31_LOAD&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		this._tfrCargo = item.commodity;
		this._maxCargo = item.weight;

		// how much of this can the player ship handle?
		var orig = p.manifest[this._tfrCargo];
		p.manifest[this._tfrCargo] += this._maxCargo;
		// check that the hold actually took all the amount
		if (p.manifest[this._tfrCargo] != (orig + this._maxCargo)) {
			// if not, adjust the amount of transfer
			this._maxCargo = p.manifest[this._tfrCargo] - orig;
		}
		p.manifest[this._tfrCargo] = orig;

		this._tfrType = 1; // transfer to cargo hold
		this._display = 6; // ask player how much cargo to transfer
	}
	if (choice === &quot;42_CANCEL&quot;) this._display = 1;
	if (choice === &quot;40_YES&quot;) {
		// we&#39;re waiting, so more the equipment directly into local storage and add the required time
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		var equip = EquipmentInfo.infoForKey(item.equipmentKey);

		this.$revealMap();
		var danger = 0;
		var time = 0;
		var info = System.infoForSystem(galaxyNumber, (item.inTransit === true ? item.transitSystem : item.system));
		var route = system.info.routeToSystem(info);
		var jumps = route.route.length;
		var dist = route.distance;
		var danger = this.$checkRouteDangerLevel(route);
		var illegal = (item.commodity != &quot;&quot; ? this.$checkRouteIllegalLevel(route, item.commodity) : 0);
		var time = route.time * 3600 + (Math.floor(Math.random() * 4) * 3600);

		var tfrcost = this.$calculateTransferCost(dist, jumps, danger, illegal);
		player.credits -= parseInt(tfrcost * 10) / 10;
		player.consoleMessage(&quot;Transfer request initiated. Your account has been debited &quot; + formatCredits(tfrcost, true, true));

		var destroyed = false;
		// work out if the item arrives safely
		for (var i = 0; i &lt; route.route.length; i++) {
			var sys = System.infoForSystem(galaxyNumber, route.route[i]);
			if (Math.random() &gt; ((sys.government + 1) / 9) &amp;&amp; Math.random() &gt; ((sys.government + 1) / 9) &amp;&amp; Math.random() &gt; ((sys.government + 1) / 9)) {
				destroyed = true;
				break;
			}
		}
		if (destroyed === false &amp;&amp; item.commodity != &quot;&quot;) {
			// chance of item being confiscated
			var chance = 0;
			for (var i = 0; i &lt; illegal; i++) {
				chance += Math.random();
			}
			var caught = (chance &lt; (illegal * 0.2) ? false : true);
		}
		this.$restoreMap();
		// add the transit time to the current time
		clock.addSeconds(time);
		this._display = 0;

		var info = null;
		var route = null;

		if (destroyed === true) {
			// bad luck, pal
			var sellcost = 0;
			var extra = &quot;&quot;;
			if (equip) {
				if (equip.techLevel &lt;= 14) {
					sellcost = (equip.price / 10 * (item.status === &quot;EQUIPMENT_DAMAGED&quot; ? 0.5 : 1) * 0.1);
					extra = &quot;, and we hope this insurance payment (of approximately 10% of the equipment value) will go some way towards alleviating the pain&quot;;
				}
			} else if (item.commodity != &quot;&quot;) {
				// 10% of cargo value
				sellcost = Math.floor(((system.mainStation.manifest[item.commodity].price / 10) * item.weight) * 0.1);
				extra = &quot;, and we hope this insurance payment (of approximately 10% of the cargo value) will go some towards alleviating the pain&quot;;
			}
			var storeName = expandDescription(this._compNames[item.system % 16]);
			mission.runScreen({
				screenID: &quot;oolite-storage-destroyed-map&quot;,
				title: &quot;Storage - Transfer&quot;,
				overlay: {
					name: &quot;equipstorage.png&quot;,
					height: 546
				},
				allowInterrupt: false,
				message: (equip ? expandDescription(&quot;[storage-transfer-destroyed]&quot;, {
					extra: extra,
					storagename: storeName
				}) : expandDescription(&quot;[storage-transfer-destroyed-cargo]&quot;, {
					extra: extra,
					storagename: storeName
				})),
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
			}, this.$transferFailed, this);

			// give player a consolation refund of 10% of item cost
			if (sellcost &gt; 0) {
				player.credits += sellcost;
				player.consoleMessage(&quot;You have been refunded &quot; + formatCredits(sellcost, true, true));
			}

			// remove the item from the storage array
			this._storage.splice(itemIndex, 1);
			return;

		} else if (caught === true) {
			var storeName = expandDescription(this._compNames[item.system % 16]);
			mission.runScreen({
				screenID: &quot;oolite-storage-caught-map&quot;,
				title: &quot;Storage - Transfer&quot;,
				overlay: {
					name: &quot;equipstorage.png&quot;,
					height: 546
				},
				allowInterrupt: false,
				message: expandDescription(&quot;[storage-transfer-caught]&quot;, {
					storagename: storeName
				}),
				exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;
			}, this.$transferFailed, this);

			this._storage.splice(itemIndex, 1);
			return;
		} else {
			// otherwise just move the item to be local
			item.system = system.ID;
			item.systemName = system.name;
		}
	}
	if (choice === &quot;41_NO&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];

		var info = System.infoForSystem(galaxyNumber, item.system);
		var route = system.info.routeToSystem(info);
		var jumps = route.route.length;
		var dist = route.distance;
		var danger = this.$checkRouteDangerLevel(route);
		var illegal = (item.commodity != &quot;&quot; ? this.$checkRouteIllegalLevel(route, item.commodity) : 0);

		var tfrcost = this.$calculateTransferCost(dist, jumps, danger, illegal);
		player.credits -= parseInt(tfrcost * 10) / 10;
		player.consoleMessage(&quot;Transfer request initiated. Your account has been debited &quot; + formatCredits(tfrcost, true, true) + &quot;.&quot;);

		item.inTransit = true;
		item.transitDestination = system.ID;
		item.transitDestinationName = system.name;
		item.transitSystem = item.system;
		item.transitStart = clock.adjustedSeconds;
		item.system = -1;
		item.transitETA = clock.adjustedSeconds + (route.time * 3600) + 7200;

		this._display = 0;
	}
	if (choice.indexOf(&quot;50_&quot;) &gt;= 0) {
		this._tfrCargo = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		this._maxCargo = p.manifest[this._tfrCargo];
		this._tfrType = 0; // transfer to storage
		this._display = 6;
	}
	if (choice.match(/6\d\_WEAPON/g)) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];
		var equip = choice.substring(choice.indexOf(&quot;~&quot;) + 1);
		var section = choice.substring(1, 2);
		// note: because of the way I interfaced LMSS with redspear&#39;s &quot;NewLasers&quot; OXP, you will need to have the LMSS OXP in order to install most New Lasers
		var lmss = worldScripts.LMSS_Core;
		if (lmss) lmss._switching = true;
		var bl = worldScripts.BrakableLasers_Main;
		// we will only allow installation into an empty position, so there is no need to do a remove/re-store
		switch (section) {
			case &quot;0&quot;:
				if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
					p.forwardWeapon = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
					bl._holdDamage[&quot;FORWARD&quot;].primary = equip;
					bl.$updateManifest();
				} else {
					p.forwardWeapon = equip;
				}
				break;
			case &quot;1&quot;:
				if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
					p.forwardWeapon = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
					bl._holdDamage[&quot;AFT&quot;].primary = equip;
					bl.$updateManifest();
				} else {
					p.aftWeapon = equip;
				}
				break;
			case &quot;2&quot;:
				if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
					p.forwardWeapon = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
					bl._holdDamage[&quot;PORT&quot;].primary = equip;
					bl.$updateManifest();
				} else {
					p.portWeapon = equip;
				}
				break;
			case &quot;3&quot;:
				if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
					p.forwardWeapon = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
					bl._holdDamage[&quot;STARBOARD&quot;].primary = equip;
					bl.$updateManifest();
				} else {
					p.starboardWeapon = equip;
				}
				break;
			case &quot;4&quot;:
				if (lmss) {
					if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
						lmss._forwardAltKey = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
						bl._holdDamage[&quot;FORWARD&quot;].secondary = equip;
						bl.$updateManifest();
					} else {
						lmss._forwardAltKey = equip;
					}
					p.awardEquipment(&quot;EQ_LMSS_FRONT_WEAPON&quot;);
				}
				break;
			case &quot;5&quot;:
				if (lmss) {
					if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
						lmss._aftAltKey = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
						bl._holdDamage[&quot;AFT&quot;].secondary = equip;
						bl.$updateManifest();
					} else {
						lmss._aftAltKey = equip;
					}
					p.awardEquipment(&quot;EQ_LMSS_AFT_WEAPON&quot;);
				}
				break;
			case &quot;6&quot;:
				if (lmss) {
					if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
						lmss._portAltKey = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
						bl._holdDamage[&quot;PORT&quot;].secondary = equip;
						bl.$updateManifest();
					} else {
						lmss._portAltKey = equip;
					}
					p.awardEquipment(&quot;EQ_LMSS_PORT_WEAPON&quot;);
				}
				break;
			case &quot;7&quot;:
				if (lmss) {
					if (item.status == &quot;EQUIPMENT_DAMAGED&quot;) {
						lmss._starboardAltKey = &quot;EQ_WEAPON_DAMAGED_LASER&quot;;
						bl._holdDamage[&quot;STARBOARD&quot;].secondary = equip;
						bl.$updateManifest();
					} else {
						lmss._starboardAltKey = equip;
					}
					p.awardEquipment(&quot;EQ_LMSS_STARBOARD_WEAPON&quot;);
				}
				break;
		}
		if (lmss) {
			lmss._switching = false;
			lmss.$updateManifest();
		}
		this._storage.splice(itemIndex, 1);
		this._display = 0;
	}
	if (choice === &quot;70_SELL&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		this.$sellEquipment(itemIndex);
		this._display = 0;
	}
	if (choice === &quot;71_SELL&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		// ask how much to sell
		this._tfrCargo = this._storage[itemIndex].commodity;
		this._maxCargo = this._storage[itemIndex].weight;
		if (this._storage[itemIndex].system != system.ID) {
			if (this._maxCargo + (system.scrambledPseudoRandomNumber(77) * 127) &gt; 127) {
				this._maxCargo = 127 - (system.scrambledPseudoRandomNumber(77) * 127);
			}
		} else {
			if ((this._maxCargo + system.mainStation.market[this._tfrCargo].quantity) &gt; 127) {
				this._maxCargo = 127 - system.mainStation.market[this._tfrCargo].quantity;
			}
		}
		this._tfrType = 2;
		this._display = 6;
	}
	if (choice === &quot;80_DUMP&quot;) this._display = 7;
	if (choice === &quot;81_YES&quot;) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		this._storage.splice(itemIndex, 1);
		player.consoleMessage(&quot;Item was successfully dumped.&quot;);
		this._display = 0;
	}
	if (choice === &quot;82_NO&quot;) this._display = 1;
	if (choice.indexOf(&quot;96_SETCOURSE&quot;) &gt;= 0) {
		var dest = parseInt(choice.substring(choice.indexOf(&quot;~&quot;) + 1));
		if (dest &gt;= 0 &amp;&amp; dest &lt;= 255) {
			player.ship.targetSystem = dest;
			player.ship.infoSystem = player.ship.targetSystem;
			player.consoleMessage(&quot;Course set for &quot; + System.systemNameForID(dest));
		}
	}
	if (choice === &quot;96_Z_STOREEQUIP&quot;) {
		this.$storeEquipment();
		return;
	}
	if (choice === &quot;95_NEXT&quot;) this._page += 1;
	if (choice === &quot;96_PREV&quot;) this._page -= 1;
	if (choice === &quot;97_SHOWLOCAL&quot;) {
		this._displayType = 0;
		this._lastChoice[this._display] = &quot;97_SHOWALL&quot;;
	}
	if (choice === &quot;97_SHOWALL&quot;) {
		this._displayType = 1;
		this._lastChoice[this._display] = &quot;97_SHOWLOCAL&quot;;
	}
	if (choice === &quot;98_MOVECARGO&quot;) this._display = 5;
	if (choice === &quot;98_EXIT&quot;) this._display = 0;

	if (choice != &quot;99_EXIT&quot;) {
		this.$viewStoredItems();
		return;
	}
}

//-------------------------------------------------------------------------------------------------------------
// prompts the user for the transfer amount
this.$getTransferAmount = function $getTransferAmount(type) {

	var text = &quot;&quot;;

	// don&#39;t show a screen when only 1 unit is possible
	if (this._maxCargo === 1) {
		switch (this._tfrType) {
			case 0:
				this.$getCargoTransferIn(1);
				return;
			case 1:
				this.$getCargoTransferOut(1);
				return;
			case 2:
				this.$getCargoToSell(1);
				return;
		}
	}

	switch (this._tfrType) {
		case 0:
			text = expandDescription(&quot;[enter-quantity-storage]&quot;, {
				commodity: displayNameForCommodity(this._tfrCargo),
				quantity: this._maxCargo
			});
			break;
		case 1:
			text = expandDescription(&quot;[enter-quantity-hold]&quot;, {
				commodity: displayNameForCommodity(this._tfrCargo),
				quantity: this._maxCargo
			});
			break;
		case 2:
			text = expandDescription(&quot;[enter-quantity-sell]&quot;, {
				commodity: displayNameForCommodity(this._tfrCargo),
				quantity: this._maxCargo
			});
			break;
	}

	var opts = {
		screenID: &quot;oolite-storage-transfer-map&quot;,
		title: &quot;Storage - &quot; + displayNameForCommodity(this._tfrCargo),
		allowInterrupt: false,
		overlay: {
			name: &quot;equipstorage.png&quot;,
			height: 546
		},
		exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
		message: text,
		textEntry: true
	};

	switch (this._tfrType) {
		case 0:
			mission.runScreen(opts, this.$getCargoTransferIn, true);
			break;
		case 1:
			mission.runScreen(opts, this.$getCargoTransferOut, true);
			break;
		case 2:
			mission.runScreen(opts, this.$getCargoToSell, true);
			break;
	}
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen - for transferring cargo to storage
this.$getCargoTransferIn = function $getCargoTransferIn(param) {
	if (!param) {
		this._display = 0;
		this.$viewStoredItems();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._maxCargo) {
		var amount = parseInt(param);
		var idx = this.$countItemAtStation(this._tfrCargo);
		if (idx === 0) {
			// charge establishment fee (if required)
			if (this.$storageSystemCount(galaxyNumber, system.ID) === 0) {
				player.credits -= this._establishmentFee;
				player.consoleMessage(formatCredits(this._establishmentFee, false, true) + &quot; deducted to open storage facility account&quot;, 5);
			}
			var spcwt = this.$cargoSpaceRequired(this.$getCommodityType(this._tfrCargo), amount);
			this._storage.push({
				galaxy: galaxyNumber,
				system: system.ID,
				systemName: system.name,
				equipmentKey: &quot;&quot;,
				commodity: this._tfrCargo,
				space: spcwt,
				weight: amount,
				status: &quot;&quot;,
				index: 0,
				inTransit: false,
				transitETA: 0,
				transitDestination: -1,
				transitSystem: -1,
				transitStart: 0
			});
		} else {
			idx = this.$getStorageIndex(galaxyNumber + &quot;|&quot; + system.ID + &quot;|&quot; + this._tfrCargo + &quot;|0&quot;);
			this._storage[idx].weight += amount;
			var spcwt = this.$cargoSpaceRequired(this.$getCommodityType(this._tfrCargo), this._storage[idx].weight);
			this._storage[idx].space = spcwt;
		}

		// take the cargo out of the hold
		var p = player.ship;
		p.manifest[this._tfrCargo] -= amount;
		// interface with hermitage cargo
		if (worldScripts.Hermitage_Cargo) {
			var hmc = worldScripts.Hermitage_Cargo;
			var tl = hmc.$minLevelForCargo(this._tfrCargo, amount);
			hmc.$removeCargoFromData(this._tfrCargo, amount, tl);
		}
	}
	this._display = 0;
	this.$viewStoredItems();
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen - for transferring cargo to hold
this.$getCargoTransferOut = function $getCargoTransferOut(param) {
	if (!param) {
		this._display = 1;
		this.$viewStoredItems();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._maxCargo) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);

		var p = player.ship;
		var amount = parseInt(param);
		var starting = p.manifest[this._tfrCargo];
		// put the cargo into the main hold
		p.manifest[this._tfrCargo] += amount;
		// check that the hold actually took all the amount
		if (p.manifest[this._tfrCargo] != (starting + amount)) {
			// if not, adjust the amount of transfer
			amount = p.manifest[this._tfrCargo] - starting;
		}
		// interface with hermitage cargo
		if (worldScripts.Hermitage_Cargo) {
			worldScripts.Hermitage_Cargo.$addCargoToData(this._tfrCargo, amount, p.dockedStation.equivalentTechLevel, system.info.economy);
		}

		var count = 0;
		this._storage[itemIndex].weight -= amount;
		if (this._storage[itemIndex].weight === 0) {
			this._storage.splice(itemIndex, 1);
			this._display = 0;
			this.$viewStoredItems();
			return;
		}
		this._storage[itemIndex].space = this.$cargoSpaceRequired(this.$getCommodityType(this._tfrCargo), this._storage[itemIndex].weight);
	}
	this._display = 1;
	this.$viewStoredItems();
}

//-------------------------------------------------------------------------------------------------------------
// parses the input from the getTransferAmount screen - for selling cargo 
this.$getCargoToSell = function $getCargoToSell(param) {
	if (!param) {
		this._display = 1;
		this.$viewStoredItems();
		return;
	}
	if (parseInt(param) &gt;= 1 &amp;&amp; parseInt(param) &lt;= this._maxCargo) {
		var itemIndex = this.$getStorageIndex(this._selectedItem);
		var item = this._storage[itemIndex];

		var amount = parseInt(param);
		var price = 0;
		// give player credits
		if (item.system === system.ID) {
			// 10% price penalty for selling remotely in the same system
			price = (system.mainStation.market[item.commodity].price / 10) * (player.ship.dockedStation.isMainStation ? 1 : 0.9);
			// add cargo to market
			var current = system.mainStation.market[item.commodity].quantity;
			// make sure we don&#39;t go over capacity
			var diff = 0;
			if (current + amount &gt; system.mainStation.market[item.commodity].capacity) {
				diff = (current + amount) - system.mainStation.market[item.commodity].capacity;
				amount -= diff;
			}
			system.mainStation.setMarketQuantity(item.commodity, current + amount);
		} else {
			// use the sample price as the means to calc the sale price at a distant system
			// includes a 20% price penalty for selling remotely
			price = this.$getSamplePrice(item.system, item.commodity) * 0.8;
		}

		player.credits += price * amount;
		player.consoleMessage(&quot;You have been credited &quot; + formatCredits(price * amount, true, true)) + &quot;.&quot;;
		this.$playSound(&quot;sell&quot;);
		// remove qty from storage
		this._storage[itemIndex].weight -= amount;
		// if we have nothing left, remove the item from the array
		if (this._storage[itemIndex].weight === 0) {
			this._storage.splice(itemIndex, 1);
			this._display = 0;
			this.$viewStoredItems();
			return;
		}
		this._storage[itemIndex].space = this.$cargoSpaceRequired(this.$getCommodityType(this._tfrCargo), this._storage[itemIndex].weight);
	}
	this._display = 1;
	this.$viewStoredItems();
}

//-------------------------------------------------------------------------------------------------------------
// used to sell a particular item out of the storage array
this.$sellEquipment = function $sellEquipment(itemIndex) {
	var item = this._storage[itemIndex];
	var info = EquipmentInfo.infoForKey(item.equipmentKey);
	var stn = player.ship.dockedStation;

	var sellcost = info.price / 10 * (item.status === &quot;EQUIPMENT_DAMAGED&quot; ? 0.5 : 1) * (item.equipmentKey.indexOf(&quot;EQ_WEAPON&quot;) &gt;= 0 ? 1 : this._refundPct);
	player.credits += sellcost;

	// give the player an email, if installed
	var ga = worldScripts.GalCopAdminServices;
	if (ga) {
		var email = worldScripts.EmailSystem;
		var cost = &quot;In total you were refunded &quot; + formatCredits(sellcost, true, true) + &quot;.&quot;;

		var msg = expandDescription(&quot;[storage-sell-email]&quot;, {
			storename: expandDescription(this._compNames[item.system % 16]),
			systemname: item.systemName,
			equipname: (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;Passenger Berth&quot; : info.name),
			equipcost: cost
		});

		email.$createEmail({
			sender: expandDescription(this._compNames[item.system % 16]),
			subject: &quot;Removing equipment&quot;,
			date: global.clock.adjustedSeconds,
			sentFrom: item.system,
			message: msg,
			expiryDays: ga._defaultExpiryDays
		});
	}

	player.consoleMessage(&quot;You have been refunded &quot; + formatCredits(sellcost, true, true));

	this._storage.splice(itemIndex, 1);
}

//-------------------------------------------------------------------------------------------------------------
this.$transferFailed = function $transferFailed(choice) {
	this.$viewStoredItems();
}

//-------------------------------------------------------------------------------------------------------------
this.$sellOrStoreDamaged = function $sellOrStoreDamaged(choice) {

	if (choice == null) return;

	var p = player.ship;
	var itemIndex = this.$getStorageIndex(this._selectedItem);
	var item = this._storage[itemIndex];

	if (choice === &quot;01_SELL&quot;) {
		// this is a swap out replacement to a damaged item, and sell the damaged one
		p.setEquipmentStatus(item.equipmentKey, &quot;EQUIPMENT_OK&quot;);
		item.status = &quot;EQUIPMENT_DAMAGED&quot;;
		player.consoleMessage(&quot;Damaged item replaced with working item, damaged item sold.&quot;);
		this.$sellEquipment(itemIndex);
	}
	if (choice === &quot;02_STORE&quot;) {
		// just change the status of each equipment item
		p.setEquipmentStatus(item.equipmentKey, &quot;EQUIPMENT_OK&quot;);
		item.status = &quot;EQUIPMENT_DAMAGED&quot;;
		player.consoleMessage(&quot;Damaged item replaced with working item, damaged item stored.&quot;);
	}

	this.$viewStoredItems();
	return;
}

//-------------------------------------------------------------------------------------------------------------
// calculates the storage cost for a single item of equipment, based on its size/weight profile
this.$calculateStorageCost = function $calculateStorageCost(space, weight, commodityType) {
	var calc = 0;
	if (commodityType != null) {
		space = this.$cargoSpaceRequired(commodityType, weight);
		switch (commodityType) {
			case &quot;kg&quot;:
				weight /= 1000;
				break;
			case &quot;g&quot;:
				weight /= 1000000;
				break;
		}
	}
	calc = space + (weight &gt; space ? weight - space : 0);
	if (calc &lt;= 0) calc = 0.1;
	return calc;
}

//-------------------------------------------------------------------------------------------------------------
this.$salesRep = function $salesRep() {
	if (this._salesRep === &quot;&quot;) {
		this._salesRep = randomName() + &quot; &quot; + randomName();
	}
	return this._salesRep;
}

//-------------------------------------------------------------------------------------------------------------
// calculates the total daily cost of all equipment currently stored throughout the galaxy
this.$calculateTotalDailyCost = function $calculateTotalDailyCost() {
	var cost = 0;
	for (var i = 0; i &lt; this._storage.length; i++) {
		var item = this._storage[i];
		var add = true;
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
			if (!equip) add = false;
		}
		if (add === true) cost += this.$calculateStorageCost(item.space, item.weight);
	}
	return cost;
}

//-------------------------------------------------------------------------------------------------------------
// returns the current daily cost for the gal/sys ID combination
this.$calculateSystemCost = function $calculateSystemCost(galaxyNum, systemID) {
	var cost = 0;
	for (var i = 0; i &lt; this._storage.length; i++) {
		var item = this._storage[i];
		if (item.system === systemID &amp;&amp; item.galaxy === galaxyNum) {
			var add = true;
			if (item.equipmentKey != &quot;&quot;) {
				var equip = EquipmentInfo.infoForKey(item.equipmentKey);
				if (!equip) add = false;
			}
			if (add === true) cost += this.$calculateStorageCost(item.space, item.weight);
		}
	}
	return cost;
}

//-------------------------------------------------------------------------------------------------------------
// returns a dictionary of gal/sys id&#39;s with the corresponding name of the system where the player currently has equipment stored
this.$storageSystemList = function $storageSystemList() {
	var data = {};
	for (var i = 0; i &lt; this._storage.length; i++) {
		var item = this._storage[i];
		var add = true;
		if (item.equipmentKey != &quot;&quot;) {
			var equip = EquipmentInfo.infoForKey(item.equipmentKey);
			if (!equip) add = false;
		}
		if (add === true) data[item.galaxy + &quot;_&quot; + item.system] = item.systemName;
	}
	return data;
}

//-------------------------------------------------------------------------------------------------------------
// counts the number of equipment items stored at the selected gal/sys 
this.$storageSystemCount = function $storageSystemCount(galaxyNum, systemID) {
	var count = 0;
	for (var i = 0; i &lt; this._storage.length; i++) {
		var item = this._storage[i];
		if (item.system === systemID &amp;&amp; item.galaxy === galaxyNum) {
			if (item.equipmentKey != &quot;&quot;) {
				var equip = EquipmentInfo.infoForKey(item.equipmentKey);
				if (equip) count += 1;
			}
			if (item.commodity != &quot;&quot;) {
				count += item.weight;
			}
		}
	}
	return count;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the station has equipment storage facilities, otherwise false
this.$stationHasStorageFacilities = function $stationHasStorageFacilities(station) {
	if (station.isMainStation) return true;
	return false;
}

//-------------------------------------------------------------------------------------------------------------
// returns the count of the specific equipment key stored at a station (in case the player decides to store multiples of the same item)
this.$countItemAtStation = function $countItemAtStation(itemKey) {
	var count = 0;
	for (var i = 0; i &lt; this._storage.length; i++) {
		if (this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system === system.ID) {
			if (this._storage[i].equipmentKey === itemKey) {
				var equip = EquipmentInfo.infoForKey(this._storage[i].equipmentKey);
				if (equip) count += 1;
			}
			if (this._storage[i].commodity === itemKey) {
				count += this._storage[i].weight;
			}
		}
	}
	return count;
}

//-------------------------------------------------------------------------------------------------------------
this.$getStorageIndex = function $getStorageIndex(datakey) {
	var data = datakey.split(&quot;|&quot;);
	var gal = parseInt(data[0]);
	var sys = parseInt(data[1]);
	var eq = data[2];
	var idx = parseInt(data[3]);

	for (var i = 0; i &lt; this._storage.length; i++) {
		if (this._storage[i].galaxy === gal &amp;&amp; this._storage[i].system === sys &amp;&amp; (this._storage[i].equipmentKey === eq || this._storage[i].commodity === eq) &amp;&amp; this._storage[i].index === idx) return i;
	}
	return -1;
}

//-------------------------------------------------------------------------------------------------------------
// returns a weighted average danger level for a particular route
this.$checkRouteDangerLevel = function $checkRouteDangerLevel(route) {
	var danger = 0;
	var count = 0;

	for (var i = 0; i &lt; route.route.length; i++) {
		var sys = System.infoForSystem(galaxyNumber, route.route[i]);
		danger += (7 - sys.government);
		count += 1;
		if (sys.government === 0) {
			danger += (7 - sys.government);
			count += 1;
		}
		if (sys.government &lt;= 1) {
			danger += (7 - sys.government);
			count += 1;
		}
		if (sys.government &lt;= 2) {
			danger += (7 - sys.government);
			count += 1;
		}
		if (sys.government &lt;= 3) {
			danger += (7 - sys.government);
			count += 1;
		}
		if (sys.government &lt;= 4) {
			danger += (7 - sys.government);
			count += 1;
		}
		if (sys.government &lt;= 5) {
			danger += (7 - sys.government);
			count += 1;
		}
	}
	danger = parseInt(danger / count);
	return danger;
}

//-------------------------------------------------------------------------------------------------------------
// returns a count of the number of systems where this good is illegal
this.$checkRouteIllegalLevel = function $checkRouteIllegalLevel(rt, commodity) {
	var si = worldScripts.Smugglers_Illegal;
	if (!si) return 0;
	var illegal = 0;
	for (var i = 0; i &lt; rt.route.length; i++) {
		if (si.$isGoodIllegal(rt.route[i], commodity) === true) illegal += 1;
	}
	return illegal;
}

//-------------------------------------------------------------------------------------------------------------
// returns the player&#39;s target system (1.80) or the next jump to their target system (1.82)
this.$playerTargetSystem = function $playerTargetSystem() {
	if (player.ship.hasOwnProperty(&quot;nextSystem&quot;)) return player.ship.nextSystem;

	var target = player.ship.targetSystem;

	if (oolite.compareVersion(&quot;1.81&quot;) &lt; 0 &amp;&amp; player.ship.hasEquipmentProviding(&quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;) === true) {
		// in 1.81 or greater, the target system could be more than 7 ly away. It becomes, essentially, the final destination.
		// there could be multiple interim stop points between the current system and the target system.
		// the only way to get this info is to recreate a route using the same logic as entered on the ANA, and pick item 1
		// from the list. That should be the next destination in the list.
		if (system.ID === -1) {
			var myRoute = System.infoForSystem(galaxyNumber, this._lastSource).routeToSystem(System.infoForSystem(galaxyNumber, target), player.ship.routeMode);
		} else {
			var myRoute = System.infoForSystem(galaxyNumber, global.system.ID).routeToSystem(System.infoForSystem(galaxyNumber, target), player.ship.routeMode);
		}
		if (myRoute &amp;&amp; myRoute.route.length &gt;= 1) {
			target = myRoute.route[1];
		}
	}

	return target;
}

//-------------------------------------------------------------------------------------------------------------
// returns a string containing the hours, minutes (and possibly seconds) remaining until the expiry time is reached
this.$getTimeRemaining = function $getTimeRemaining(expiry, hoursOnly) {
	var diff = expiry - clock.adjustedSeconds;
	var result = &quot;&quot;;
	if (diff &gt; 0) {
		var hours = Math.floor(diff / 3600);
		var mins = Math.floor((diff - (hours * 3600)) / 60);
		var secs = Math.floor(diff - (hours * 3600) - (mins * 60));
		// special case - reduce 1 hour down to mins
		if (hours === 1 &amp;&amp; mins &lt; 40) {
			hours = 0;
			mins += 60;
		}
		// special case - reduce 1 min down to secs
		if (hours === 0 &amp;&amp; mins === 1 &amp;&amp; secs &lt; 40) {
			mins = 0;
			secs += 60;
		}
		if (hoursOnly &amp;&amp; hoursOnly === true &amp;&amp; mins &gt; 30 &amp;&amp; hours &gt; 1) hours += 1;
		if (hours &gt; 0) result += hours + &quot; hours&quot;;
		if ((hoursOnly == null || hoursOnly === false) || (hours === 0 &amp;&amp; mins &gt; 0)) {
			if (mins &gt; 0) result += (result === &quot;&quot; ? &quot;&quot; : &quot; &quot;) + mins + &quot; mins&quot;;
		}
		if ((hoursOnly == null || hoursOnly === false) || (hours === 0 &amp;&amp; mins === 0 &amp;&amp; secs &gt; 0)) {
			if (hours === 0 &amp;&amp; secs &gt; 0) result += (result === &quot;&quot; ? &quot;&quot; : &quot; &quot;) + secs + &quot; secs&quot;;
		}
	} else {
		result = &quot;Overdue&quot;;
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
// check for any in transit arrivals
this.$checkForArrivals = function $checkForArrivals() {
	var si = worldScripts.Smugglers_Illegal;
	var mapOn = false;

	// any in transit arrivals?
	for (var i = this._storage.length - 1; i &gt;= 0; i--) {
		if (this._storage[i].inTransit === true) {
			var item = this._storage[i];
			var equip = null;
			var cargo = &quot;&quot;;

			if (item.equipmentKey != &quot;&quot;) equip = EquipmentInfo.infoForKey(item.equipmentKey);
			if (item.commodity != &quot;&quot; &amp;&amp; this._commodities.indexOf(item.commodity) &gt;= 0) cargo = item.commodity;

			// only move valid equipment items
			if (equip || cargo != &quot;&quot;) {
				if (mapOn === false) {
					this.$revealMap();
					mapOn = true;
				}
				// our starting system
				var info1 = System.infoForSystem(galaxyNumber, item.transitSystem);
				// our ultimate destination
				var info2 = System.infoForSystem(galaxyNumber, item.transitDestination);
				// route between the two
				var route1 = info1.routeToSystem(info2);

				// now work out the first step of this complete route
				var info3 = System.infoForSystem(galaxyNumber, route1.route[1]);
				// get the route between info1 (start) and this new point
				var route2 = info1.routeToSystem(info3);

				if (item.transitStart + (route2.time * 3600) &lt; clock.adjustedSeconds) {
					if (Math.random() &gt; ((info3.government + 1) / 9) &amp;&amp; Math.random() &gt; ((info3.government + 1) / 9) &amp;&amp; Math.random() &gt; ((info3.government + 1) / 9)) {
						var sellcost = 0;
						var extra = &quot;&quot;;
						var text = &quot;&quot;;
						extra = &quot; Insurance pays you &quot; + formatCredits(sellcost, true, true) + &quot;.&quot;;
						if (equip &amp;&amp; equip.techLevel &lt;= 14) {
							sellcost = (equip.price / 10 * (item.status === &quot;EQUIPMENT_DAMAGED&quot; ? 0.5 : 1) * 0.1);
							text = &quot;Storage Transfer Shipping reports that the ship carrying your &quot; + (item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot; ? &quot;passenger berth&quot; : equip.name.toLowerCase()) +
								&quot; has been destroyed by pirates while on route to &quot; + info2.name + &quot;.&quot; + extra;
						}
						if (cargo != &quot;&quot;) {
							sellcost = ((system.mainStation.market[cargo].price / 10) * 0.1) * item.weight;
							text = &quot;Storage Transfer Shipping reports that the ship carrying your cargo of &quot; + item.weight + this.$getCommodityType(item.commodity) + &quot; × &quot; + displayNameForCommodity(item.commodity) +
								&quot; has been destroyed by pirates while on route to &quot; + info2.name + &quot;.&quot; + extra;
						}
						// tell the player via an arrival report messages
						player.addMessageToArrivalReport(text);

						this._storage.splice(i, 1);
					} else {
						// move the ship along the plot
						item.transitSystem = info3.systemID;
						// add some time
						item.transitStart += (route2.time * 3600) + 3600;
						// check for illegal goods
						if (si &amp;&amp; cargo != &quot;&quot;) {
							// player may have paid a premium to allow for the shipping commander to bribe official&#39;s, but that doesn&#39;t mean it&#39;s going to work!
							if (si.$isGoodIllegal(item.transitSystem, item.commodity) === true) {
								// attempt a bribe on player&#39;s behalf - change player amount. if they can&#39;t afford it, remove cargo
								// 2 tries
								var chance = worldScripts.Smugglers_DockMaster._bribeChance[system.ID];
								var result = false;
								for (var tries = 1; tries &lt;= 2; tries++) {
									var bribe_attempt = Math.random();
									if (bribe_attempt &gt;= chance) {
										result = true;
										break;
									}
								}
								if (result === false) {
									// tell the player via an arrival report messages
									var text = &quot;Storage Transfer Shipping reports that your cargo of &quot; + item.weight + this.$getCommodityType(item.commodity) + &quot; × &quot; + displayNameForCommodity(item.commodity) +
										&quot; has been discovered and confiscated by GalCop Customs officials in &quot; + info3.name + &quot;.&quot; + extra;
									player.addMessageToArrivalReport(text);
									this._storage.splice(i, 1);
									continue;
								}
							}
						}

						if (item.transitSystem === item.transitDestination) {
							// arrived! reset transit data
							item.system = item.transitDestination;
							item.systemName = info2.name;
							item.inTransit = false;
							item.transitSystem = -1;
							item.transitDestination = -1;
							item.transitETA = 0;
							item.transitStart = 0;
						}
					}
				}
			}
		}
	}
	if (mapOn === true) {
		this.$restoreMap();
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the cost of transferring an item to local storage, based on the total distance, number of jumps, the danger level and the number of illegal systems
this.$calculateTransferCost = function $calculateTransferCost(dist, jumps, danger, illegal) {
	// cargo only: we add a premium for bribes if there are any systems that consider the cargo illegal
	// for equipment, illegal should always be zero
	return (((dist / jumps) * 3) * (danger + 1)) * 10 + (illegal * (system.scrambledPseudoRandomNumber(illegal) * 500 + 500));
}

//-------------------------------------------------------------------------------------------------------------
// gets the commodity type for a particular commodity (t, kg or g)
this.$getCommodityType = function $getCommodityType(good) {
	switch (good) {
		case &quot;gold&quot;:
		case &quot;platinum&quot;:
			return &quot;kg&quot;;
		case &quot;gem_stones&quot;:
			return &quot;g&quot;;
		default:
			return &quot;t&quot;;
	}
}

//-------------------------------------------------------------------------------------------------------------
// returns the minimum amount of space required for a particular cargo type (kg, g or t) and weight
this.$cargoSpaceRequired = function $cargoSpaceRequired(cargoType, weight) {
	var spcwt = 0;
	switch (cargoType) {
		case &quot;kg&quot;:
			spcwt = parseInt(weight / 1000);
			break;
		case &quot;g&quot;:
			spcwt = parseInt(weight / 1000000);
			break;
		default:
			spcwt = weight;
			break;
	}
	if (spcwt === 0) spcwt = 1;
	return spcwt;
}

//-------------------------------------------------------------------------------------------------------------
// compiles a list of sample prices for all the cargo/system combinations we have in storage
this.$compileSamplePrices = function $compileSamplePrices() {
	this._storedPrices.length = 0;
	var sc = worldScripts.Smugglers_Contracts;
	if (system.ID === -1) return;
	for (var i = 0; i &lt; this._storage.length; i++) {
		if (this._storage[i].commodity != &quot;&quot; &amp;&amp; this._storage[i].galaxy === galaxyNumber &amp;&amp; this._storage[i].system != system.ID) {
			var sys = System.infoForSystem(galaxyNumber, this._storage[i].system);
			var prc = 0;
			if (sc) {
				prc = sc.$priceForCommodity(this._storage[i].commodity, sys);
			} else {
				prc = (sys.samplePrice(this._storage[i].commodity) / 10);
			}
			this._storedPrices.push({
				system: this._storage[i].system,
				commodity: this._storage[i].commodity,
				price: prc
			});
		}
	}
	sc = null
}

//-------------------------------------------------------------------------------------------------------------
// returns the price for a particular system/commoodity combo
this.$getSamplePrice = function $getSamplePrice(sysID, commodity) {
	for (var i = 0; i &lt; this._storedPrices.length; i++) {
		if (this._storedPrices[i].system === sysID &amp;&amp; this._storedPrices[i].commodity === commodity) return this._storedPrices[i].price;
	}
	// if we get here, the specific system/commodity pair wan&#39;t matched, so add a new one to the array and return the new price
	var sc = worldScripts.Smugglers_Contracts;
	var sys = System.infoForSystem(galaxyNumber, sysID);
	var prc = 0;
	if (sc) {
		prc = sc.$priceForCommodity(commodity, sys);
	} else {
		prc = (sys.samplePrice(commodity) / 10);
	}
	// add it to the array so we don&#39;t have to keep looking it up
	this._storedPrices.push({
		system: sysID,
		commodity: commodity,
		price: prc
	});
	return prc;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function $isBigGuiActive() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; // until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function $padTextRight(currentText, desiredLength, leftSwitch) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var ellip = &quot;…&quot;;
	var currentLength = defaultFont.measureString(currentText.replace(/%%/g, &quot;%&quot;));
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1) {
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp === ellip) break;
		} while (defaultFont.measureString(tmp.replace(/%%/g, &quot;%&quot;)) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp.replace(/%%/g, &quot;%&quot;));
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	// quick way of generating a repeated string of that number
	if (!leftSwitch || leftSwitch === false) {
		return currentText + new Array(padsNeeded).join(hairSpace);
	} else {
		return new Array(padsNeeded).join(hairSpace) + currentText;
	}
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextLeft = function $padTextLeft(currentText, desiredLength) {
	return this.$padTextRight(currentText, desiredLength, true);
}

//-------------------------------------------------------------------------------------------------------------
this.$pageHeader = function $pageHeader() {
	if (this._sc_core) {
		return this._sc_core.$pageHeader(&quot;store&quot;);
	} else {
		return &quot;&quot;;
	}
}

//-------------------------------------------------------------------------------------------------------------
// player the buy/sell sound effects
this.$playSound = function $playSound(soundtype) {
	var mySound = new SoundSource;
	switch (soundtype) {
		case &quot;buy&quot;:
			mySound.sound = &quot;[buy-commodity]&quot;;
			break;
		case &quot;sell&quot;:
			mySound.sound = &quot;[sell-commodity]&quot;;
			break;
	}
	mySound.loop = false;
	mySound.play();
}

//-------------------------------------------------------------------------------------------------------------
// routine to completely reveal the system map (if parts have been concealed) to ensure route calculations work
this.$revealMap = function $revealMap() {
	this._holdConcealment = [];
	this._unconcealmentActive = true;
	//if (this._debug) log(this.name, &quot;system map uncovered&quot;);
	for (var i = 0; i &lt; 256; i++) {
		var sys = System.infoForSystem(galaxyNumber, i);
		var c = 0;
		if (sys.concealment) c = sys.concealment;
		this._holdConcealment.push(c);
		if (c != 0) sys.setProperty(2, &quot;concealment&quot;, 0);
	}
}

//-------------------------------------------------------------------------------------------------------------
// routine to restore system map (if parts had been concealed) after route calculations have completed
this.$restoreMap = function $restoreMap() {
	if (this._holdConcealment.length === 0) return;
	for (var i = 0; i &lt; this._holdConcealment.length; i++) {
		var sys = System.infoForSystem(galaxyNumber, i);
		if (this._holdConcealment[i] != 0) sys.setProperty(2, &quot;concealment&quot;, this._holdConcealment[i]);
	}
	//if (this._debug) log(this.name, &quot;system map restored&quot;);
	this._unconcealmentActive = false;
}

//-------------------------------------------------------------------------------------------------------------
// returns true if the passed equipment key is required by another piece of installed equipment, otherwise false
this.$equipmentIsRequired = function $equipmentIsRequired(equipmentKey) {

	// todo: look at requiresAnyEquipment as well
	var p = player.ship;
	var eq = p.equipment;
	var result = false;

	// special case for passengers: make sure we always have enough berths for the number of passengers currently on board.
	if (equipmentKey === &quot;EQ_PASSENGER_BERTH&quot;) {
		if (p.passengerCount &gt; 0 &amp;&amp; p.passengerCapacity &lt;= p.passengerCount) {
			result = true;
		}
	} else {
		for (var i = 0; i &lt; eq.length; i++) {
			// special case that isn&#39;t listed in equipment config
			//if (equipmentKey === &quot;EQ_SHIELD_BOOSTER&quot; &amp;&amp; eq[i].equipmentKey === &quot;EQ_NAVAL_SHIELD_BOOSTER&quot;) {
			//	result = true;
			//	break;
			// }
			var info = EquipmentInfo.infoForKey(eq[i].equipmentKey);
			if (info.requiresEquipment) {
				if (info.requiresEquipment.indexOf(equipmentKey) &gt;= 0 || 
					// some special cases for ShipConfig items
					(this._sc_core &amp;&amp; 
						((equipmentKey.indexOf(&quot;EQ_FUEL_SCOOPS&quot;) &gt;= 0 &amp;&amp; info.requiresEquipment.indexOf(&quot;EQ_FUEL_SCOOPS&quot;) &gt;= 0) ||
						(equipmentKey.indexOf(&quot;EQ_FUEL_INJECTION&quot;) &gt;= 0 &amp;&amp; info.requiresEquipment.indexOf(&quot;EQ_FUEL_INJECTION&quot;) &gt;= 0) || 
						(equipmentKey.indexOf(&quot;EQ_HEAT_SHIELD&quot;) &gt;= 0 &amp;&amp; info.requiresEquipment.indexOf(&quot;EQ_HEAT_SHIELD&quot;) &gt;= 0))
					)) {
					result = true;
					break;
				}
			}
		}
	}
	return result;
}</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
