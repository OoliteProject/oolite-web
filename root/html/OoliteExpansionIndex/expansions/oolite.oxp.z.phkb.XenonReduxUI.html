<html>
    <head>
        <title>Expansion Xenon Redux UI</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Xenon Redux UI</h1>

        <h2>Content</h2>
        <ul>
          
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">4 Scripts</a></li>
        </ul>


        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Adds backgrounds to all screens, allowing for a narrower screen ratio (eg 4:3). Also includes new title screen music. Also requires the XenonReduxUIResources.oxz. For 16:9 screens, see Xenon UI.

This OXP will override any backgrounds currently applied by other OXP&#39;s. This is by design, in order to maintain the illusion of looking at a computer display. If conflicts arise, where important information needs to be given to the player via a background screen, code can be applied to allow exceptions to take place. See the Wiki page for more information.</td>
                    <td>Adds backgrounds to all screens, allowing for a narrower screen ratio (eg 4:3). Also includes new title screen music. Also requires the XenonReduxUIResources.oxz. For 16:9 screens, see Xenon UI.

This OXP will override any backgrounds currently applied by other OXP&#39;s. This is by design, in order to maintain the illusion of looking at a computer display. If conflicts arise, where important information needs to be given to the player via a background screen, code can be applied to allow exceptions to take place. See the Wiki page for more information.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.z.phkb.XenonReduxUI</td>
                    <td>oolite.oxp.z.phkb.XenonReduxUI</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Xenon Redux UI</td>
                    <td>Xenon Redux UI</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Ambience</td>
                    <td>Ambience</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>3.5</td>
                    <td>3.5</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                            <li>oolite.oxp.z.phkb.XenonReduxUIResources:1.1.0</li>
                    </td>
                    <td>
                            <li>oolite.oxp.z.phkb.XenonReduxUIResources:1.1.0</li>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href="http://wiki.alioth.net/index.php/XenonUI">http://wiki.alioth.net/index.php/XenonUI</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/9/90/XenonReduxUI.oxz">https://wiki.alioth.net/img_auth.php/9/90/XenonReduxUI.oxz</a></td>
                    <td><a target="_blank" href="http://wiki.alioth.net/img_auth.php/9/90/XenonReduxUI.oxz">http://wiki.alioth.net/img_auth.php/9/90/XenonReduxUI.oxz</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 3.0</td>
                    <td>CC-BY-NC-SA 3.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1624987211</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Xenon%20Redux%20UI'>http://wiki.alioth.net/index.php/Xenon%20Redux%20UI</a></p>
        <h3>readme.txt</h3>
        <pre>Xenon Redux UI OXP
By Nick Rogers

About this OXP
==============
This OXP replaces all background UI screens with a new look and feel, based on the assumption that the Oolite UI screens are accessed through some form of computer terminal. 

The method used to add the backgrounds will mean that the background images of most other OXP&#39;s, if they set a background, will be overridden with the Xenon UI images. This is by design. 

If an OXP uses background images to convey important information to the player, and the &quot;mission.runScreen&quot; command in the OXP has a &quot;screenID&quot; parameter attached, it is possible to add exceptions to the override by adding the following code to a worldScript:

	var w = worldScripts.XenonReduxUI;
	if (w) w.$addMissionScreenException(&quot;mymissionscreenid&quot;);

The OXP is made up of two parts: the main XenonReduxUI.oxz, which holds all the config and code, and the XenonReduxUIResources.oxz, which holds all the images. This will allow fast updates to the code section, which is small, without having to download the large resources file regularly.

The images in this OXP are designed screens narrower than 16:10 (eg. 4:3). For a 16:9 and 16:10 screen version, see the XenonUI.oxz.

BGS 1.10 Compatibility
======================
Xenon Redux UI is compatible with BGS v1.10, but depending on where each one is installed, one OXP may end up taking priority over the other when backgrounds are selected and displayed. When BGS has priority, its images will be displayed ahead of the Xenon Reduc UI images. This will be particular apparent on screens like the title page or the load/save page.

If both OXP&#39;s (Xenon Redux UI and BGS) are installed in the Addons folder, Xenon Redux UI will normally take priority over BGS.

If both OXP&#39;s are installed via the download manager, again, Xenon Redux UI will normally take priority over BGS.

If BGS is installed via the download manager, and Xenon UI is installed in the AddOns folder, Xenon Redux UI will take priority over BGS.

If Xenon UI is installed via the download manager, and BGS is installed in the AddOns folder, BGS will take priority over Xenon Redux UI.

To ensure the Xenon Redux UI backgrounds appear, the best approach is to make sure they are both installed in the same location.

If you encounter issues where the BGS backgrounds are being displayed rather than the Xenon Redux UI ones, you will need to open the BGS OXP folder, then open the Config folder. Inside Config you will find a &#39;screenbackgrounds.plist&#39; file. Either remove this or re-name it - perhaps re-name it to &#39;screenbackgrounds.Xplist&#39; - and the Xenon Redux UI backgrounds will be used without affecting any other aspect of BGS. By re-naming &#39;screenbackgrounds.plist&#39; rather than removing it you have the option of switching back easily if required.

BGS 2.0 Compatibility
=====================
Xenon Redux UI will hook into Library GUI to register itself as a GUI set. Therefore, you can go to the Library GUI settings and change between BGS 2.0 and Xenon Redux UI anytime you like. 

Because of the way the images are created, Xenon Redux UI is still utilising settings in &quot;screenbackgrounds.plist&quot;, which may lead to some inconsistencies. For instance, if Xenon Redux UI and BGS 2.0 are installed, when you start Oolite and select the option to open a saved commander, the background will be Xenon Redux UI. Once you have loaded a game, if you then press F2 to load a new game, you will see the BGS background.

Licence
=======
This OXP is released under the Creative Commons Attribution - Non-Commercial - Share Alike 3.0 license. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/

Briefcase image form http://simpleicon.com/briefcase-3.html
Rocket image form http://simpleicon.com/rocket.html
ID Card from http://simpleicon.com/id_card-2.html
Power icon from http://simpleicon.com/switch_button_1.html
Report icon from http://simpleicon.com/note-11.html
Gears icon from http://simpleicon.com/gear-6.html
Load icon from http://simpleicon.com/upload_2.html
Save icon from http://simpleicon.com/download_2.html
Interface icon from http://simpleicon.com/retweet.html
Settings icon from http://simpleicon.com/setting.html
Keyboard icon from https://commons.wikimedia.org/wiki/File:High-contrast-input-keyboard.svg
Trolley icon from http://simpleicon.com/shopping_trolley_1.html
Clipboard icon from http://simpleicon.com/admite_form_1.html
Tag image from http://simpleicon.com/tag-2.html
Gamepad image from http://simpleicon.com/gaming_remote.html
Question mark image from http://simpleicon.com/question_mark_1.html
Warning image from http://simpleicon.com/warning.html

Version History
===============
3.5
- Bug fixes.

3.4
- Bug fixes.

3.3
- Fixes for Ships Library, Sothis TC, New Cargoes and Iron Raven to restore background images.

3.2
- Improvements in BGS compatibility.

3.1
- Updated compatibility with Library 1.7.

3.0
- Added &quot;Amber&quot; background option (selectable via Library Config).
- Code refactoring.

2.1.5
- Improvements in Library GUI integration.

2.1.4
- Improved coverage of different mission screen sequencing scenarios. (Oolite 1.85/86 required)
- Improved integration with XenonUI via Library GUI.
- Applied new screenbackgrounds added in v1.87 (&quot;custom_chart_mission&quot;).

2.1.3
- Fixed incorrect key lookup with mission screen overlays.
- Fixed issue with turning off overlay images with Library GUI.
- Disabling background images on a mission screen will now also disable any overlays as well.
- Bug fixes.

2.1.2
- Bug fixes.
- Included check for resources pack during startup.

2.1.1
- Rejigged connection to Library GUI for nicer handovers when GUI&#39;s change.

2.1.0
- Updated for simpler integration with Library GUI.
- Code refactoring.

2.0.4
- Adjusted the Random Hits screen ID exception.

2.0.3
- Hopefully fixed issues with mission screens losing the Xenon Redux UI theme.

2.0.2
- Updated title screen image.

2.0.1
- Fixed compatibility issue with HDBG when using Library GUI.

2.0.0
- Made compatible with Library GUI, and enabled it to be installed alongside Xenon UI, if required.
- Added some configuration settings to Library Config.
- Added additional overlays to various data screens.
- Fixed some image file naming errors.
- Code cleanup.

1.3.4
- Added &quot;oxz-manager&quot; to screenbackgrounds.plist.
- Changed &quot;==&quot; comparisons to &quot;===&quot; for performance improvements.

1.3.3
- Fixed &quot;p is null&quot; error.

1.3.2
- Update Nova Mission screen ID&#39;s to match core.

1.3.1
- Updated check for &quot;Allow Big GUI&quot;.

1.3.0
- Changed new game background to the &#39;no hud&#39; variant.
- New title screen image.
- Added mission screen overlays. Can be disabled by setting &quot;this._disableOverlays = true;&quot; in &quot;xenonreduxui.js&quot;.
- Fixed issue with BGS where the F6 overlay image was being removed.
- Fixed issue where exiting the Ship Library screen would sometimes show the wrong background.
- Added mission screen exception for Random Hits.

1.2.1
- Added screenID exceptions for UPS Courier.
- Added screedID exceptions for Escort Contracts (v1.6.3).
- Added routine to use 1.83/4 code to check for big GUI HUD&#39;s.

1.2.0
- Updated all images to be 2048x1024 to stop Oolite from rescaling them. Results in a much cleaner image
- Checks for the &quot;allow_big_gui&quot; option on HUD&#39;s. Uses the &quot;nohud&quot; background variations when found.
- Fixed issue where the wrong background was being selected going to or from the F8 Market screen if Market Observer is installed.
- Fixed issue with mission screens that exit to the short or long range chart, where the wrong background was being displayed.
- Added screenID&#39;s to nova mission screens.
- Added screenID exceptions for Rescue Stations.
- Added screenID exceptions for Blackmonks.

1.1.3
- Adjusted the main title colour to match with the background.
- Fixed issue with Trumbles and Nova missions not showing proper background image.
- Changed license of code section to CC-BY-NC-SA 3.0 due to inclusion of trumbles and nova mission code.

1.1.2
- Changed manifest identifier to try and position the OXP at the bottom of the install list

1.1.1
- Fixed bug where &quot;.&quot; is missing before &quot;indexOf&quot;.

1.1.0
- Split OXZ into two, one for resources (music and images), one for the code and config.
- Fixed file name issue for one of the files.
- Code improvements as suggested by Wildeblood.
- Added exception for Norby&#39;s forthcoming OXP (HDBG)
- Added some BGS override exceptions

1.0
- Initial release.
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. 
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. 
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. 
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/oolite-trumbles-mission.js</td>
                    <td><pre>/*

oolite-trumbles-mission.js

Script for random offers of trumbles.


Oolite
Copyright © 2004-2013 Giles C Williams and contributors

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
MA 02110-1301, USA.

Update by phkb to change mission background into overlay, for compatibility with XenonUI.

*/


/*jslint white: true, undef: true, eqeqeq: true, bitwise: true, regexp: true, newcap: true, immed: true */
/*global guiScreen, mission, missionVariables, player*/


&quot;use strict&quot;;


this.name			= &quot;oolite-trumbles&quot;;
this.author			= &quot;Jens Ayton&quot;;
this.copyright		= &quot;© 2008-2016 the Oolite team.&quot;;
this.description	= &quot;Random offers of trumbles.&quot;;


(function () {

var pendingOffer = false;


function cleanUp(script)
{
	delete script.shipDockedWithStation;
	delete script.missionScreenOpportunity;
	delete script.shipWillExitWitchspace;
}


this.startUp = function startUp()
{
	/*	In the pre-JavaScript implementation, the mission variable was set to
		OFFER_MADE while the mission screen was shown. If the player lanched
		in that state, the offer would never be made again -- unless some
		other script used the mission choice keys &quot;YES&quot; or &quot;NO&quot;. This
		implementation uses unique choice keys and doesn&#39;t change the mission
		variable, which should be more reliable in all cases.
	*/
	if (missionVariables.trumbles === &quot;OFFER_MADE&quot;)
	{
		missionVariables.trumbles = &quot;BUY_ME&quot;;
	}
	else if (missionVariables.trumbles === &quot;TRUMBLE_BOUGHT&quot;)
	{
		cleanUp(this);
	}
	delete this.startUp;
}


this.shipDockedWithStation = function shipDockedWithStation(station)
{
	pendingOffer = false;
	if (missionVariables.novacount || missionVariables.nova)
	{
		// So the offers eventually stop for long-time players who keep refusing.
		return;
	}

	if (station.isMainStation)
	{
		if (!missionVariables.trumbles)	
		{
			missionVariables.trumbles = &quot;BUY_ME&quot;;
		}

		if (missionVariables.trumbles === &quot;BUY_ME&quot; &amp;&amp;
			player.trumbleCount === 0 &amp;&amp;
			Math.random() &lt; 0.2) // 20% chance of trumble being offered.
		{
			pendingOffer = true;
		}
	}
}


this.missionScreenOpportunity = function missionScreenOpportunity()
{
	if (pendingOffer &amp;&amp; player.credits &gt; 6553.5)
	{
		pendingOffer = false;

		// Show the mission screen.
		mission.runScreen({
			titleKey: &quot;oolite_trumble_title&quot;,
			messageKey: &quot;oolite_trumble_offer&quot;,
			overlay: {name:&quot;trumblebox.png&quot;, height:512},
			choicesKey: &quot;oolite_trumble_offer_yesno&quot;,
			screenID: &quot;oolite-trumbles&quot;
		},
		function (choice)
		{
			if (choice === &quot;OOLITE_TRUMBLE_YES&quot;)
			{
				player.credits -= 30;
				player.ship.awardEquipment(&quot;EQ_TRUMBLE&quot;);

				missionVariables.trumbles = &quot;TRUMBLE_BOUGHT&quot;;
				cleanUp(this);
			}
			else
			{
				missionVariables.trumbles = &quot;NOT_NOW&quot;;
			}
		});
	}
};


this.shipWillExitWitchspace = function shipWillExitWitchspace()
{
	// If player has rejected a trumble offer, reset trumble mission with 2% probability per jump.
	if (missionVariables.trumbles === &quot;NOT_NOW&quot; &amp;&amp; Math.random() &lt; 0.02)
	{
		missionVariables.trumbles = &quot;BUY_ME&quot;;
	}
};

}).call(this);
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/xenonreduxui.js</td>
                    <td><pre>(function () {
	&quot;use strict&quot;;
	this.name = &quot;XenonReduxUI&quot;;
	this.author = &quot;phkb&quot;;
	this.copyright = &quot;2016 phkb&quot;;
	this.description = &quot;Simplified versions of the Xenon UI backgrounds (no side panels).&quot;;
	this.licence = &quot;CC BY-NC-SA 3.0&quot;;

	this._marketObserverInstalled = false; // flag to indicate when market observer is installed (for wide F8 display)
	this._disableMissionScreen = []; // array of mission &quot;screenID&#39;s&quot; that will have the background disabled
	this._chartExitScreenTimer = null;
	this._missionOverlay = {}; // array of mission screen ID&#39;s and image names for overlays
	this._backgroundOverride = []; // array of mission screen ID&#39;s we&#39;ve forcefully added a background to
	this._disableOverlays = false; // flag that indicates whether mission overlays will be applied to mission screens
	this._enableLibGUIInt = true; // flag to indicate whether integration with LibGUI is on or off. true means it is on.
	this._activeMode = true;
	this._guiActive = &quot;&quot;; // monitors changes in the currently selected GUI (when Library is installed)
	this._useBGS = &quot;&quot;;
	this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];
	this._hdbgActive = false; // indicates that the HG Backgrounds OXP is active
	this._addedID = {}; // keeps track of screen ID&#39;s we have added to Library GUI, so we can remove them if another GUI is selected
	this._xn = null; // link to Xenon UI (if installed)
	this._defaultBG = {};
	this._amber = false;  // indicates whether blue (false) or amber (true) backgrounds will be used

	// configuration settings for use in Lib_Config
	this._xenonReduxUIConfig = {
		Name: this.name,
		Alias: &quot;Xenon Redux UI&quot;,
		Display: &quot;Config&quot;,
		Alive: &quot;_xenonReduxUIConfig&quot;,
		Notify: &quot;$changeSettings&quot;,
		Bool: {
			B0: {
				Name: &quot;_disableOverlays&quot;,
				Def: false,
				Desc: &quot;Disable overlays&quot;
			},
			B1: {
				Name: &quot;_activeMode&quot;,
				Def: true,
				Desc: &quot;Active mode&quot;
			},
			B2: {
				Name: &quot;_amber&quot;,
				Def: false,
				Desc: &quot;Amber color&quot;
			},
			Info: &quot;0 - Disables the mission screen overlay images.\n1 - XenonReduxUI will actively attempt to apply backgrounds to all mission screens, except for those added as exceptions.\n2 - Switch amber color on.&quot;
		},
	};

	/*
		This OXP replaces all the backgrounds of all UI screens with new versions using a hi-tech-like design theme.
		In most cases any individual backgrounds supplied by individual OXP&#39;s on their mission &quot;runScreen&quot; will overridden by these ones (but see below).

		This OXP is designed to be compatible with the BackGroundSet (BGS). However, on some systems some BGS images may still be shown,
		depending on the load order of the OXP&#39;s. If this OXP loads after BGS, these images will be used. If BGS loads after this OXP, it&#39;s images may be used.

		If your OXP has backgrounds you want to keep, and you want to still use this OXP, use the &quot;$addMissionScreenException&quot; to your startUpComplete script:
		Example:
			var w = worldScripts.XenonReduxUI;
			if (w) w.$addMissionScreenException(&quot;mymissionscreenid&quot;);

	*/

	//-------------------------------------------------------------------------------------------------------------
	// adds a screen ID to the list of mission screen ID&#39;s for which this OXP will not override
	this.$addMissionScreenException = function $addMissionScreenException(missionScreenID) {
		var lib = worldScripts.Lib_GUI;
		if (this._disableMissionScreen.indexOf(missionScreenID) === -1) this._disableMissionScreen.push(missionScreenID);
		if (lib &amp;&amp; this._enableLibGUIInt &amp;&amp; (!this._addedID[missionScreenID] || this._addedID[missionScreenID] === 2) &amp;&amp; lib.$cur === &quot;XenonReduxUI&quot;) {
			if (!lib.$IDRules[missionScreenID]) {
				this._addedID[missionScreenID] = 2;
				this.$passConfig(missionScreenID);
				lib.$IDRules[missionScreenID] = {
					mpic: 0
				};
			}
			//lib.$IDRules[missionScreenID] = {
			//	mpic: 0
			//};
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// function to add an overlay image to a mission screen
	this.$addMissionOverlay = function $addMissionOverlay(missionScreenID, imagename) {
		if (!this._missionOverlay[missionScreenID] &amp;&amp; imagename == null) imagename = &quot;&quot;;
		if (imagename != null) this._missionOverlay[missionScreenID] = imagename;
		var lib = worldScripts.Lib_GUI;
		// lib_GUI stuff
		if (lib &amp;&amp; this._enableLibGUIInt) {
			if (imagename != null &amp;&amp; imagename != &quot;&quot;) {
				lib.$IDs.XenonReduxUI[missionScreenID] = {
					pic: {
						name: (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;) + &quot;_redux.png&quot;,
						height: 546
					},
					picBig: {
						name: (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;) + &quot;_redux_nohud.png&quot;,
						height: 546
					},
					ov: {
						name: imagename,
						height: 546
					},
					sndRef: this._useBGS
				};
				if (lib.$cur === &quot;XenonReduxUI&quot;) {
					if (!this._addedID[missionScreenID] || this._addedID[missionScreenID] === 2) {
						if (!lib.$IDRules[missionScreenID]) {
							this._addedID[missionScreenID] = 2;
							this.$passConfig(missionScreenID);
							if (this._disableOverlays === true) {
								lib.$IDRules[missionScreenID] = {
									pic: 1,
									ov: 0
								};
							} else {
								lib.$IDRules[missionScreenID] = {
									pic: 1,
									ov: 1
								};
							}
						}
						/*if (this._disableOverlays === true) {
							lib.$IDRules[missionScreenID] = {
								pic: 1,
								ov: 0
							};
						} else {
							lib.$IDRules[missionScreenID] = {
								pic: 1,
								ov: 1
							};
						}*/
					}
				}
			} else {
				if (imagename === &quot;&quot;) {
					lib.$IDs.XenonReduxUI[missionScreenID] = {
						pic: {
							name: (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;) + &quot;_redux.png&quot;,
							height: 546
						},
						picBig: {
							name: (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;) + &quot;_redux_nohud.png&quot;,
							height: 546
						},
						sndRef: this._useBGS
					};
					if (lib.$cur === &quot;XenonReduxUI&quot; &amp;&amp; (!this._addedID[missionScreenID] || this._addedID[missionScreenID] === 2)) {
						if (!lib.$IDRules[missionScreenID]) {
							this._addedID[missionScreenID] = 2;
							this.$passConfig(missionScreenID);
							lib.$IDRules[missionScreenID] = {
								pic: 1
							};
						}
						//lib.$IDRules[missionScreenID] = {
						//	pic: 1
						//};
					}
				}
			}
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.startUp = function () {
		this._xn = worldScripts.XenonUI;

		var disable = false;
		if (worldScriptNames.indexOf(&quot;Xenon Redux UI Resource Pack&quot;) === -1) {
			log(this.name, &quot;ERROR! The Xenon Redux UI Resource pack is not installed. Xenon Redux UI cannot function without it.&quot;);
			disable = true;
		}

		if (disable === true || (worldScripts.XenonUI &amp;&amp; (!worldScripts.Lib_GUI || this._enableLibGUIInt === false))) {
			// disable this OXP if XenonUI is installed along with it, but Library GUI isn&#39;t there to mediate.
			delete this.startUpComplete;
			delete this.guiScreenChanged;
			delete this.playerWillSaveGame;
			delete this.missionScreenEnded;
			delete this.gameResumed;
			delete this.startUp;
			return;
		}

		var lib = worldScripts.Lib_GUI;

		if (missionVariables.XenonReduxUI_ActiveMode) this._activeMode = (this._trueValues.indexOf(missionVariables.XenonReduxUI_ActiveMode) &gt;= 0 ? true : false);
		if (missionVariables.XenonReduxUI_DisableOverlays) this._disableOverlays = (this._trueValues.indexOf(missionVariables.XenonReduxUI_DisableOverlays) &gt;= 0 ? true : false);
		// only reload the amber setting if lib config is present - otherwise we&#39;ll just take the preset value
		if (lib) {
			if (missionVariables.XenonReduxUI_Amber) this._amber = (this._trueValues.indexOf(missionVariables.XenonReduxUI_Amber) &gt;= 0 ? true : false);
			this._lastAmber = this._amber;
		}
		if (!lib || lib.$cur === &quot;XenonReduxUI&quot;) this.$updateGuiColorSettings();

		if (worldScripts[&quot;BGS&quot;]) this._useBGS = &quot;BGS&quot;;
		if (worldScripts[&quot;market_observer3&quot;]) this._marketObserverInstalled = true;
		if (worldScripts[&quot;hdbg&quot;]) this._hdbgActive = true;

		if (lib &amp;&amp; this._enableLibGUIInt === true) {
			// flag some screens as readonly
			this._addedID[&quot;oolite-contracts-parcels-none&quot;] = 1;
			this._addedID[&quot;oolite-contracts-parcels-details&quot;] = 1;
			this._addedID[&quot;oolite-contracts-parcels-summary&quot;] = 1;
			this._addedID[&quot;oolite-contracts-passengers-none&quot;] = 1;
			this._addedID[&quot;oolite-contracts-passengers-details&quot;] = 1;
			this._addedID[&quot;oolite-contracts-passengers-summary&quot;] = 1;
			this._addedID[&quot;oolite-contracts-cargo-none&quot;] = 1;
			this._addedID[&quot;oolite-contracts-cargo-details&quot;] = 1;
			this._addedID[&quot;oolite-contracts-cargo-summary&quot;] = 1;
			this._addedID[&quot;oolite-primablemanager&quot;] = 1;
			this._addedID[&quot;oolite-register&quot;] = 1;
			this._addedID[&quot;Lib_Config&quot;] = 1;

			// disable our standard functions so LibGUI can take over
			this.$previous_guiScreenChanged = this.guiScreenChanged;
			delete this.guiScreenChanged;
			delete this.missionScreenEnded;
			delete this.gameResumed;
			delete this.startUp;
			this.$libGUISetup();
		}

		// if we don&#39;t have library to orchestrate backgrounds, disable &quot;better screens&quot; so xenon UI has priority
		// otherwise, we end up with a clash of different background sets
		if (!lib &amp;&amp; worldScripts[&quot;smivs_screen-backgrounds_worldscript&quot;]) {
			worldScripts[&quot;smivs_screen-backgrounds_worldscript&quot;].hide_guiScreenChanged = worldScripts[&quot;smivs_screen-backgrounds_worldscript&quot;].guiScreenChanged;
			delete worldScripts[&quot;smivs_screen-backgrounds_worldscript&quot;].guiScreenChanged;
		}

		this.$addStandardMissionScreenOverlays();
		this.$addStandardMissionScreenExceptions();

		// make Ship&#39;s library compatible with XenonUI
		if (worldScripts[&quot;Ships Library&quot;] &amp;&amp; !this._xn) {
			var sl = worldScripts[&quot;Ships Library&quot;];
			sl._showPage = this._showPage;
		}
		if (worldScripts.sothis_tc &amp;&amp; !this._xn) {
			var stc = worldScripts.sothis_tc;
			stc.missionScreenOpportunity = this._sothis_missionScreenOpportunity;
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.startUpComplete = function () {
		// register our settings, if Lib_Config is present
		if (worldScripts.Lib_Config) {
			worldScripts.Lib_Config._registerSet(this._xenonReduxUIConfig);
			if (!worldScripts.XenonUI) this.$setBGSDefaultBackgrounds();
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.guiScreenChanged = function (to, from) {

		var p = player.ship;

		var imagetype = &quot;redux&quot;;
		var redalert = &quot;&quot;;
		var nohud = &quot;&quot;;
		var imagename = &quot;&quot;;
		var startTimer = false;
		var overlay = &quot;&quot;;

		if (this._marketObserverInstalled) {
			if (from == &quot;GUI_SCREEN_MARKET&quot; || from == &quot;GUI_SCREEN_MARKETINFO&quot; || to == &quot;GUI_SCREEN_MARKET&quot; || to == &quot;GUI_SCREEN_MARKETINFO&quot;)
				// Because market observer uses a specialised HUD a slightly incorrect background image was being selected.
				// This was unnoticable if the &quot;allow_big_gui&quot; was not enabled on the default HUD, but quite noticeable on the Xenon HUD.
				// So we start a timer to force the correct background after Market Observer has set or reset the HUD.
				startTimer = true;
		}

		// fix for the issue where exiting the ship library screen could sometimes result in the wrong background being displayed
		// this would only be apparent with HUD&#39;s that don&#39;t implement the &quot;allow_big_gui&quot; setting.
		if (from == &quot;GUI_SCREEN_SHIPLIBRARY&quot; &amp;&amp; p &amp;&amp; p.docked) startTimer = true;

		if (p.alertCondition == 3) redalert = &quot;_redalert&quot;;
		if (p.hudHidden) nohud = &quot;_nohud&quot;;
		if (this.$isBigGuiActive() == true) nohud = &quot;_nohud&quot;;

		switch (guiScreen) {
			case &quot;GUI_SCREEN_MAIN&quot;:
				return;
			case &quot;GUI_SCREEN_KEYBOARD&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-keyboard.png&quot;;
				break;
			case &quot;GUI_SCREEN_STICKMAPPER&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-gamepad.png&quot;;
				break;
			case &quot;GUI_SCREEN_OPTIONS&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-settings.png&quot;;
				break;
			case &quot;GUI_SCREEN_LOAD&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-load.png&quot;;
				break;
			case &quot;GUI_SCREEN_SAVE&quot;:
			case &quot;GUI_SCREEN_SAVE_OVERWRITE&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-save.png&quot;;
				break;
			case &quot;GUI_SCREEN_EQUIP_SHIP&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-equipship.png&quot;;
				break;
			case &quot;GUI_SCREEN_INTERFACES&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-interfaces.png&quot;;
				break;
			case &quot;GUI_SCREEN_STATUS&quot;:
				// override BGS status and nocrowd image, if installed.
				if (worldScripts[&quot;BGS-M&quot;]) {
					worldScripts[&quot;BGS-M&quot;].bgsI.status = {
						name: &quot;xenon_&quot; + imagetype + &quot;_&quot; + nohud + redalert + &quot;.png&quot;,
						height: 546
					};
					worldScripts[&quot;BGS-M&quot;].bgsI.noCrowd = {
						name: &quot;xenon_&quot; + imagetype + &quot;_&quot; + nohud + redalert + &quot;.png&quot;,
						height: 546
					};
				}
				/*if (this._disableOverlays === false) {
					if (this.$playerHasDamagedEquipment() === true) {
						overlay = &quot;xrui-warning.png&quot;;
					} else {
						overlay = &quot;xrui-ok.png&quot;;
					}
				}*/
				break;
			case &quot;GUI_SCREEN_MANIFEST&quot;:
				if (this._disableOverlays === false) overlay = &quot;xrui-clipboard.png&quot;;
				break;
			case &quot;GUI_SCREEN_SHORT_RANGE_CHART&quot;:
				break;
			case &quot;GUI_SCREEN_LONG_RANGE_CHART&quot;:
				// override BGS lrc image, if installed.
				if (worldScripts[&quot;BGS-M&quot;]) {
					worldScripts[&quot;BGS-M&quot;].bgsI.lrc = {
						name: &quot;xenon_&quot; + imagetype + nohud + redalert + &quot;.png&quot;,
						height: 546
					};
				}
				break;
			case &quot;GUI_SCREEN_SYSTEM_DATA&quot;:
				var sysinf = System.infoForSystem(galaxyNumber, p.targetSystem);
				if (sysinf[&quot;sun_gone_nova&quot;] || sysinf[&quot;sun_going_nova&quot;]) imagename += &quot;_nova&quot;;
				break;
			case &quot;GUI_SCREEN_MARKET&quot;:
				if (this._marketObserverInstalled) imagename += &quot;_wide&quot;;
				if (this._disableOverlays === false) overlay = &quot;xrui-market.png&quot;;
				break;
			case &quot;GUI_SCREEN_MARKETINFO&quot;:
				if (this._marketObserverInstalled) imagename += &quot;_wide&quot;;
				if (this._disableOverlays === false) overlay = &quot;xrui-tag.png&quot;;
				break;
			case &quot;GUI_SCREEN_REPORT&quot;:
				if (worldScripts.hdbg) return;
				if (this._disableOverlays === false) overlay = &quot;xrui-report.png&quot;;
				if (this._hdbgActive === true) return;
				break;
			case &quot;GUI_SCREEN_MISSION&quot;:
				// look for any exceptions and jump out if found
				if (this._disableMissionScreen.indexOf(mission.screenID) != -1) imagename = &quot;disable&quot;;
				// check if we have an overlay to apply to this mission screen
				if (this._disableOverlays == false &amp;&amp; this._disableMissionScreen.indexOf(mission.screenID) === -1) {
					if (this._missionOverlay[mission.screenID]) overlay = this._missionOverlay[mission.screenID];
				}
				break;
		}

		// build the filename if it hasn&#39;t been disabled
		if (imagename != &quot;disable&quot;) {
			imagename = (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;) + &quot;_&quot; + imagetype + imagename + nohud + redalert + &quot;.png&quot;;
			// load the image to the background
			setScreenBackground({
				name: imagename,
				height: 546
			});
		}
		if (overlay != &quot;&quot;) setScreenOverlay({
			name: overlay,
			height: 546
		});

		// start a timer to force the background, if required
		if (startTimer) {
			if (this._chartExitScreenTimer &amp;&amp; this._chartExitScreenTimer.isRunning) this._chartExitScreenTimer.stop();
			this._chartExitScreenTimer = new Timer(this, this.$addBackground, 0.25, 0);
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.playerWillSaveGame = function () {
		missionVariables.XenonReduxUI_ActiveMode = this._activeMode;
		missionVariables.XenonReduxUI_DisableOverlays = this._disableOverlays;
		missionVariables.XenonReduxUI_Amber = this._amber;
	}

	//-------------------------------------------------------------------------------------------------------------
	this.missionScreenEnded = function () {
		this.guiScreenChanged(&quot;&quot;, &quot;&quot;);
	}

	//-------------------------------------------------------------------------------------------------------------
	this.gameResumed = function () {
		this.guiScreenChanged(&quot;&quot;, &quot;&quot;);
	}

	//-------------------------------------------------------------------------------------------------------------
	// adds overlays to the standard mission screens
	this.$addStandardMissionScreenOverlays = function $addStandardMissionScreenOverlays() {
		this.$addMissionOverlay(&quot;oolite-contracts-parcels-none&quot;, &quot;xrui-briefcase.png&quot;);
		this.$addMissionOverlay(&quot;oolite-contracts-parcels-summary&quot;, &quot;xrui-briefcase.png&quot;);
		this.$addMissionOverlay(&quot;oolite-contracts-passengers-none&quot;, &quot;xrui-boardingpass.png&quot;);
		this.$addMissionOverlay(&quot;oolite-contracts-passengers-summary&quot;, &quot;xrui-boardingpass.png&quot;);
		this.$addMissionOverlay(&quot;oolite-contracts-cargo-none&quot;, &quot;xrui-cargo.png&quot;);
		this.$addMissionOverlay(&quot;oolite-contracts-cargo-summary&quot;, &quot;xrui-cargo.png&quot;);
		this.$addMissionOverlay(&quot;oolite-primablemanager&quot;, &quot;xrui-switch.png&quot;);
		this.$addMissionOverlay(&quot;oolite-register&quot;, &quot;xrui-register.png&quot;);
	}

	//-------------------------------------------------------------------------------------------------------------
	// adds map screen exceptions for known screen ID&#39;s
	this.$addStandardMissionScreenExceptions = function $addStandardMissionScreenExceptions() {
		// each of these items can&#39;t be set using setScreenBackground - needs to be done via the plist file
		this.$addMissionScreenException(&quot;oolite-contracts-parcels-details&quot;);
		this.$addMissionScreenException(&quot;oolite-contracts-passengers-details&quot;);
		this.$addMissionScreenException(&quot;oolite-contracts-cargo-details&quot;);
		this.$addMissionScreenException(&quot;rrs_mission_map&quot;);
		this.$addMissionScreenException(&quot;blackmonks-map&quot;);
		this.$addMissionScreenException(&quot;ups-map&quot;);
		this.$addMissionScreenException(&quot;escort-contracts&quot;);
		if (worldScripts.Random_Hits) {
			var ver = worldScripts.Random_Hits.version.split(&quot;.&quot;);
			if (parseInt(ver[0]) &gt; 1 ||
				(parseInt(ver[0]) === 1 &amp;&amp; parseInt(ver[1])) &gt; 11 ||
				(parseInt(ver[0]) === 1 &amp;&amp; parseInt(ver[1]) === 11 &amp;&amp; parseInt(ver[2]) &gt; 2)) {
				this.$addMissionScreenException(&quot;random_hits_map&quot;);
			} else {
				this.$addMissionScreenException(&quot;random_hits&quot;);
			}
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// callback handler for when settings are changed
	this.$changeSettings = function $changeSettings() {
		var lib = worldScripts.Lib_GUI;
		if (this._amber != this._lastAmber) {
			this.$libGUISetup();
			this._lastAmber = this._amber;
		}
		if (lib.$cur === &quot;XenonReduxUI&quot;) {
			if (global.setScreenBackgroundForKey) this.$setBackgroundDefaults(true);
			this.$updateGuiColorSettings();
		}
		/*if (this._disableOverlays === true) {
			if (this._enableLibGUIInt === true &amp;&amp; lib &amp;&amp; lib.$cur === &quot;XenonReduxUI&quot;) {
				var keys = Object.keys(this._missionOverlay);
				for (var i = 0; i &lt; keys.length; i++) {
					if (!this._addedID[keys[i]] || this._addedID[keys[i]] === 2) {
						if (!lib.$IDRules[keys[i]]) {
							this._addedID[keys[i]] = 2;
							this.$passConfig(keys[i]);
						}
						lib.$IDRules[keys[i]] = {
							pic: 1,
							ov: 0
						};
					}
				}
			}
		} else {
			if (this._enableLibGUIInt === true &amp;&amp; lib &amp;&amp; lib.$cur === &quot;XenonReduxUI&quot;) {
				var keys = Object.keys(this._missionOverlay);
				for (var i = 0; i &lt; keys.length; i++) {
					if (!this._addedID[keys[i]] || this._addedID[keys[i]] === 2) {
						if (!lib.$IDRules[keys[i]]) {
							this._addedID[keys[i]] = 2;
							this.$passConfig(keys[i]);
						}
						lib.$IDRules[keys[i]] = {
							pic: 1,
							ov: 1
						};
					}
				}
			}
		}*/
		// remove any background that we added forcefully
		/*if (lib.$cur === &quot;XenonReduxUI&quot; &amp;&amp; this._activeMode === false) {
			for (var i = 0; i &lt; this._backgroundOverride.length; i++) {
				//delete lib.$IDs.XenonReduxUI[this._backgroundOverride[i]];
				if (!this._addedID[this._backgroundOverride[i]] || this._addedID[this._backgroundOverride[i]] === 2) {
					delete lib.$IDRules[this._backgroundOverride[i]];
				}
			}
		}*/
		// reset our monitoring array regardless of which gui is active
		if (this._activeMode === false) this._backgroundOverrride = [];

		this.$setupGeneralOverlays();
	}

	//-------------------------------------------------------------------------------------------------------------
	// sets up the LibGUI parameters
	this.$libGUISetup = function $libGUISetup() {

		var lib = worldScripts.Lib_GUI;
		// setup some event callbacks
		this.guiScreenChanged = this.$guiScreenChanged;
		//this.equipmentDamaged = this.$equipmentDamaged;
		//this.equipmentRepaired = this.$equipmentRepaired;
		//this.equipmentAdded = this.$equipmentAdded;
		//this.equipmentRemoved = this.$equipmentRemoved;
		this.missionScreenEnded = this.$missionScreenEnded;

		var style = (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;);

		lib.$guis.XenonReduxUI = {
			GUI_SCREEN_GAMEOPTIONS: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_LOAD: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				}
			},
			GUI_SCREEN_SAVE: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				}
			},
			GUI_SCREEN_SAVE_OVERWRITE: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				}
			},
			GUI_SCREEN_EQUIP_SHIP: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_INTERFACES: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_KEYBOARD: {
				pic: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				}
			},
			GUI_SCREEN_MANIFEST: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_MARKET: {
				pic: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_MARKETINFO: {
				pic: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux&quot; + (this._marketObserverInstalled === true ? &quot;_wide&quot; : &quot;&quot;) + &quot;_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_OPTIONS: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_SHIPLIBRARY: {
				pic: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				}
			},
			GUI_SCREEN_SHIPYARD: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_STATUS: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_STICKMAPPER: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_STICKPROFILE: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_SYSTEM_DATA: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picNova: {
					name: style + &quot;_redux_nova.png&quot;,
					height: 546
				},
				picNovaBig: {
					name: style + &quot;_redux_nova_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				picNovaRed: {
					name: style + &quot;_redux_nova_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_SHORT_RANGE_CHART: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
			GUI_SCREEN_LONG_RANGE_CHART: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			},
		};

		if (this._hdbgActive === false) {
			lib.$guis.XenonReduxUI.generic = {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			};
			lib.$guis.XenonReduxUI.GUI_SCREEN_REPORT = {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			};
		}

		this.$setupVariableScreens();
		this.$setupGeneralOverlays();

		// mission screen IDs
		lib.$IDs.XenonReduxUI = {
			generic: {
				pic: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picBig: {
					name: style + &quot;_redux_nohud.png&quot;,
					height: 546
				},
				picFlight: {
					name: style + &quot;_redux.png&quot;,
					height: 546
				},
				picRed: {
					name: style + &quot;_redux_redalert.png&quot;,
					height: 546
				},
				sndRef: this._useBGS
			}
		};

	}

	//-------------------------------------------------------------------------------------------------------------
	// adjust background images on F5 screen based on availability/status of equipment
	this.$setupVariableScreens = function $setupVariableScreens() {
		/*if (this._disableOverlays === false) {
			if (this.$playerHasDamagedEquipment() === true) {
				worldScripts.Lib_GUI.$guis.XenonReduxUI.GUI_SCREEN_STATUS[&quot;ov&quot;] = {name:&quot;xrui-warning.png&quot;, height:546};
			} else {
				worldScripts.Lib_GUI.$guis.XenonReduxUI.GUI_SCREEN_STATUS[&quot;ov&quot;] = {name:&quot;xrui-ok.png&quot;, height:546};
			}
		}*/
	}

	//-------------------------------------------------------------------------------------------------------------
	// adjust overlay images on general (non-mission) screens
	this.$setupGeneralOverlays = function $setupGeneralOverlays() {

		var lib = worldScripts.Lib_GUI.$guis.XenonReduxUI;

		if (this._disableOverlays) {
			delete lib.GUI_SCREEN_GAMEOPTIONS[&quot;ov&quot;];
			delete lib.GUI_SCREEN_LOAD[&quot;ov&quot;];
			delete lib.GUI_SCREEN_SAVE[&quot;ov&quot;];
			delete lib.GUI_SCREEN_SAVE_OVERWRITE[&quot;ov&quot;];
			delete lib.GUI_SCREEN_EQUIP_SHIP[&quot;ov&quot;];
			delete lib.GUI_SCREEN_INTERFACES[&quot;ov&quot;];
			delete lib.GUI_SCREEN_KEYBOARD[&quot;ov&quot;];
			delete lib.GUI_SCREEN_MANIFEST[&quot;ov&quot;];
			delete lib.GUI_SCREEN_MARKET[&quot;ov&quot;];
			delete lib.GUI_SCREEN_MARKETINFO[&quot;ov&quot;];
			delete lib.GUI_SCREEN_OPTIONS[&quot;ov&quot;];
			delete lib.GUI_SCREEN_REPORT[&quot;ov&quot;];
			//delete lib.GUI_SCREEN_STATUS[&quot;ov&quot;];
			delete lib.GUI_SCREEN_STICKMAPPER[&quot;ov&quot;];
		} else {
			lib.GUI_SCREEN_GAMEOPTIONS[&quot;ov&quot;] = {
				name: &quot;xrui-settings.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_LOAD[&quot;ov&quot;] = {
				name: &quot;xrui-load.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_SAVE[&quot;ov&quot;] = {
				name: &quot;xrui-save.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_SAVE_OVERWRITE[&quot;ov&quot;] = {
				name: &quot;xrui-question.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_EQUIP_SHIP[&quot;ov&quot;] = {
				name: &quot;xrui-equipship.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_INTERFACES[&quot;ov&quot;] = {
				name: &quot;xrui-interfaces.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_KEYBOARD[&quot;ov&quot;] = {
				name: &quot;xrui-keyboard.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_MANIFEST[&quot;ov&quot;] = {
				name: &quot;xrui-clipboard.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_MARKET[&quot;ov&quot;] = {
				name: &quot;xrui-market.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_MARKETINFO[&quot;ov&quot;] = {
				name: &quot;xrui-tag.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_OPTIONS[&quot;ov&quot;] = {
				name: &quot;xrui-settings.png&quot;,
				height: 546
			};
			if (this._hdbgActive === false) lib.GUI_SCREEN_REPORT[&quot;ov&quot;] = {
				name: &quot;xrui-report.png&quot;,
				height: 546
			};
			lib.GUI_SCREEN_STICKMAPPER[&quot;ov&quot;] = {
				name: &quot;xrui-gamepad.png&quot;,
				height: 546
			};
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// alternate version for use with Lib_GUI
	this.$missionScreenEnded = function $missionScreenEnded() {
		var lib = worldScripts.Lib_GUI;
		if (this._guiActive != lib.$cur &amp;&amp; (this._guiActive === &quot;XenonReduxUI&quot; || lib.$cur === &quot;XenonReduxUI&quot;)) {
			if (lib.$cur === &quot;XenonReduxUI&quot;) {
				// if we&#39;ve got it available (v1.85/86) then force the default screen background to be Xenon Redux
				if (global.setScreenBackgroundForKey) this.$setBackgroundDefaults(true);
				this.$updateGuiColorSettings();
				for (var i = 0; i &lt; this._disableMissionScreen.length; i++) {
					if (!this._addedID[this._disableMissionScreen[i]] || this._addedID[this._disableMissionScreen[i]] === 2) {
						if (!lib.$IDRules[this._disableMissionScreen[i]]) {
							this._addedID[this._disableMissionScreen[i]] = 2;
							this.$passConfig(this._disableMissionScreen[i]);
							lib.$IDRules[this._disableMissionScreen[i]] = {
								mpic: 0
							};
						}
						/*lib.$IDRules[this._disableMissionScreen[i]] = {
							mpic: 0
						};*/
					}
				}
				var keys = Object.keys(this._missionOverlay);
				for (var i = 0; i &lt; keys.length; i++) {
					// update Lib_GUI with our settings for mission screens
					if (!this._addedID[keys[i]] || this._addedID[keys[i]] === 2) {
						if (!lib.$IDRules[keys[i]]) {
							this._addedID[keys[i]] = 2;
							this.$passConfig(keys[i]);
							if (this._missionOverlay[keys[i]] != &quot;&quot;) {
								if (this._disableOverlays === true) {
									lib.$IDRules[keys[i]] = {
										pic: 1,
										ov: 0
									};
								} else {
									lib.$IDRules[keys[i]] = {
										pic: 1,
										ov: 1
									};
								}
							} else {
								lib.$IDRules[keys[i]] = {
									pic: 1
								};
							}
						}
						/*if (this._missionOverlay[keys[i]] != &quot;&quot;) {
							if (this._disableOverlays === true) {
								lib.$IDRules[keys[i]] = {
									pic: 1,
									ov: 0
								};
							} else {
								lib.$IDRules[keys[i]] = {
									pic: 1,
									ov: 1
								};
							}
						} else {
							lib.$IDRules[keys[i]] = {
								pic: 1
							};
						}*/
					}
				}
			} else {
				// if we&#39;ve got it available (v1.85/86) then reset the default screen backgrounds to be what it was previously
				if (global.setScreenBackgroundForKey) this.$setBackgroundDefaults(false);
				/*var items = Object.keys(this._addedID);
				for (var i = 0; i &lt; items.length; i++) {
					if (this._addedID[items[i]] === 2) {
						delete lib.$IDRules[items[i]];
					}
				}*/
			}
			this._guiActive = lib.$cur;
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// activated when Library GUI is in use
	// gets any unrecorded mission ScreenID&#39;s add add them to the list of rules to use Xenon
	this.$guiScreenChanged = function $guiScreenChanged(to, from) {
		if (guiScreen === &quot;GUI_SCREEN_STATUS&quot;) {
			// this bit should only be run once after load
			if (this._guiActive === &quot;&quot;) {
				// force all the screen rego stuff to happen if xenon was set after loading
				if (worldScripts.Lib_GUI.$cur === &quot;XenonReduxUI&quot;) this.missionScreenEnded();
				// make sure our local copy gets updated
				this._guiActive = worldScripts.Lib_GUI.$cur;
			}
		}

		if (guiScreen === &quot;GUI_SCREEN_MISSION&quot; &amp;&amp; this._guiActive === &quot;XenonReduxUI&quot; &amp;&amp; this._activeMode === true) {
			if (mission.screenID &amp;&amp; mission.screenID != &quot;&quot; &amp;&amp; this._disableMissionScreen.indexOf(mission.screenID) === -1) {
				this.$addMissionOverlay(mission.screenID, null);
				// make a note of any screen we add this way
				if (this._backgroundOverride.indexOf(mission.screenID) === -1) this._backgroundOverride.push(mission.screenID);
				// force an update
				worldScripts.Lib_GUI.guiScreenChanged();
			}
			// we&#39;ll try to override LibGUI if a mission screen is displayed without a screenID
			if (!mission.screenID) {
				this.$previous_guiScreenChanged(to, from);
			}
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// activated when Library GUI is in use
	this.$equipmentAdded = function $equipmentAdded(equipmentKey) {
		this.$setupVariableScreens();
	}

	//-------------------------------------------------------------------------------------------------------------
	// activated when Library GUI is in use
	this.$equipmentRemoved = function $equipmentRemoved(equipmentKey) {
		this.$setupVariableScreens();
	}

	//-------------------------------------------------------------------------------------------------------------
	// activated when Library GUI is in use
	this.$equipmentDamaged = function $equipmentDamaged(equipmentKey) {
		this.$setupVariableScreens();
	}

	//-------------------------------------------------------------------------------------------------------------
	// activated when Library GUI is in use
	this.$equipmentRepaired = function $equipmentRepaired(equipmentKey) {
		this.$setupVariableScreens();
	}

	//-------------------------------------------------------------------------------------------------------------
	// forces a background after the timer has expired
	// used when mission screens exit to the short or long range chart.
	this.$addBackground = function $addBackground() {
		this.guiScreenChanged(&quot;&quot;, &quot;&quot;);
	}

	//-------------------------------------------------------------------------------------------------------------
	// returns true if a HUD with allowBigGUI is enabled, otherwise false
	this.$isBigGuiActive = function $isBigGuiActive() {
		if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
			return player.ship.hudAllowsBigGui;
		} else {
			var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; // until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
			if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
				return true;
			} else {
				return false;
			}
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// returns true if any of the visible equipment items are damaged
	this.$playerHasDamagedEquipment = function $playerHasDamagedEquipment() {
		var p = player.ship;
		var eq = p.equipment;
		for (var i = 0; i &lt; eq.length; i++) {
			var itm = eq[i];
			if (itm.isVisible === true &amp;&amp; p.equipmentStatus(itm.equipmentKey) === &quot;EQUIPMENT_DAMAGED&quot;) return true;
		}
		return false;
	}

	//-------------------------------------------------------------------------------------------------------------
	this.$setBackgroundDefaults = function $setBackgroundDefaults(onOff) {
		if (onOff === true) {
			this._defaultBG[&quot;long_range_chart_mission&quot;] = getScreenBackgroundForKey(&quot;long_range_chart_mission&quot;);
			this._defaultBG[&quot;short_range_chart_mission&quot;] = getScreenBackgroundForKey(&quot;short_range_chart_mission&quot;);
			this._defaultBG[&quot;custom_chart_mission&quot;] = getScreenBackgroundForKey(&quot;custom_chart_mission&quot;);
			this._defaultBG[&quot;long_range_chart&quot;] = getScreenBackgroundForKey(&quot;long_range_chart&quot;);
			this._defaultBG[&quot;short_range_chart&quot;] = getScreenBackgroundForKey(&quot;short_range_chart&quot;);
			this._defaultBG[&quot;keyboardsettings&quot;] = getScreenBackgroundForKey(&quot;keyboardsettings&quot;);
			this._defaultBG[&quot;load_save&quot;] = getScreenBackgroundForKey(&quot;load_save&quot;);
			this._defaultBG[&quot;mount_weapon&quot;] = getScreenBackgroundForKey(&quot;mount_weapon&quot;);
			this._defaultBG[&quot;newgame&quot;] = getScreenBackgroundForKey(&quot;newgame&quot;);
			this._defaultBG[&quot;settings&quot;] = getScreenBackgroundForKey(&quot;settings&quot;);
			this._defaultBG[&quot;shiplibrary&quot;] = getScreenBackgroundForKey(&quot;shiplibrary&quot;);

			var nohud = &quot;&quot;;
			if (this.$isBigGuiActive() === true) nohud = &quot;_nohud&quot;;

			var style = (this._amber === true ? &quot;amber&quot; : &quot;xenon&quot;);

			var imagename = style + &quot;_redux&quot; + nohud + &quot;.png&quot;;
			setScreenBackgroundForKey(&quot;short_range_chart_mission&quot;, {
				name: imagename,
				height: 546
			});
			setScreenBackgroundForKey(&quot;long_range_chart_mission&quot;, {
				name: imagename,
				height: 546
			});
			setScreenBackgroundForKey(&quot;short_range_chart&quot;, {
				name: imagename,
				height: 546
			});
			setScreenBackgroundForKey(&quot;long_range_chart&quot;, {
				name: imagename,
				height: 546
			});

			setScreenBackgroundForKey(&quot;keyboardsettings&quot;, {
				name: style + &quot;_redux_nohud.png&quot;,
				height: 546
			});
			setScreenBackgroundForKey(&quot;load_save&quot;, {
				name: style + &quot;_redux.png&quot;,
				height: 546
			});
			setScreenBackgroundForKey(&quot;mount_weapon&quot;, {
				name: style + &quot;_redux.png&quot;,
				height: 546
			});
			setScreenBackgroundForKey(&quot;newgame&quot;, {
				name: style + &quot;_redux_nohud.png&quot;,
				height: 546
			});
			setScreenBackgroundForKey(&quot;settings&quot;, {
				name: style + &quot;_redux.png&quot;,
				height: 546
			});
			setScreenBackgroundForKey(&quot;shiplibrary&quot;, {
				name: style + &quot;_redux_nohud.png&quot;,
				height: 546
			});
		} else {
			var keys = Object.keys(this._defaultBG);
			for (var i = 0; i &lt; keys.length; i++) {
				var bg = getScreenBackgroundForKey(keys[i]);
				// are xenon&#39;s backgrounds still set?
				if (bg.hasOwnProperty(&quot;name&quot;) === true &amp;&amp; bg.name.indexOf(style + &quot;_redux&quot;) &gt;= 0) {
					// ok, we can reset things now
					setScreenBackgroundForKey(keys[i], this._defaultBG[keys[i]]);
				}
			}
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.$updateGuiColorSettings = function $updateGuiColorSettings() {
		if (global.setGuiColorSettingForKey) {
			global.setGuiColorSettingForKey(&quot;screen_divider_color&quot;, (this._amber === false ? &quot;0 74 127 200&quot; : &quot;127 74 0 200&quot;));
			global.setGuiColorSettingForKey(&quot;screen_title_color&quot;, (this._amber === false ? &quot;0 148 255 200&quot; : &quot;255 148 0 200&quot;));
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	this.$setBGSDefaultBackgrounds = function $setBGSDefaultBackgrounds() {
		// until BGS has something similar
		if (worldScripts.Lib_GUI.$cur == &quot;BGS&quot; &amp;&amp; global.setGuiColorSettingForKey) {
			setGuiColorSettingForKey(&quot;screen_title_color&quot;, &quot;0.9 0.9 0.8&quot;);
			setGuiColorSettingForKey(&quot;screen_divider_color&quot;, &quot;0.0 0.0 0.0 0.0&quot;);

			setScreenBackgroundForKey(&quot;paused_docked_overlay&quot;, &quot;bgs_ov_paused.png&quot;);
			setScreenBackgroundForKey(&quot;paused_overlay&quot;, &quot;bgs_ov_paused.png&quot;);
			setScreenBackgroundForKey(&quot;intro&quot;, &quot;bgs_intro.png&quot;);
			setScreenBackgroundForKey(&quot;keyboardsettings&quot;, &quot;bgs_fullscr.png&quot;);
			setScreenBackgroundForKey(&quot;load_save&quot;, &quot;bgs_options.png&quot;);
			setScreenBackgroundForKey(&quot;newgame&quot;, &quot;bgs_intro.png&quot;);
			setScreenBackgroundForKey(&quot;oxz-manager&quot;, &quot;bgs_fullscr.png&quot;);
			setScreenBackgroundForKey(&quot;settings&quot;, &quot;bgs_options.png&quot;);
			setScreenBackgroundForKey(&quot;shiplibrary&quot;, &quot;bgs_fullscr.png&quot;);
			setScreenBackgroundForKey(&quot;long_range_chart_mission&quot;, &quot;lib_black.png&quot;);
			setScreenBackgroundForKey(&quot;short_range_chart_mission&quot;, &quot;lib_black.png&quot;);
		}
	}

	//-------------------------------------------------------------------------------------------------------------
	// used to allow XenonUI and XenonReduxUI to co-exist
	this.$xenonCrossConfig = function $xenonCrossConfig(screenID) {
		this._addedID[screenID] = 2;
	}
	this.$passConfig = function $passConfig(screenID) {
		if (this._xn) this._xn.$xenonCrossConfig(screenID);
	}

	//-------------------------------------------------------------------------------------------------------------
	// to make Ships Library compatible with XenonUI
	this._showPage = function() {
		var chapter = this.$contents[this.$chapter];
	
		var text = this._textFromOffset(this.$chapter,this.$offset,this.$msStore,this.$msRows,this.$msCols);
		
		var opts = {
			screenID: &quot;ships-library&quot;,
			titleKey: chapter.key+&quot;-title&quot;,
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: {
				&quot;01_PREV&quot;:expandMissionText(&quot;ships-library-page-back&quot;),
				&quot;09_NEXT&quot;:expandMissionText(&quot;ships-library-page-next&quot;),
				&quot;10_CONTENTS&quot;:expandMissionText(&quot;ships-library-contents&quot;),
				&quot;99_EXIT&quot;:expandMissionText(&quot;ships-library-exit&quot;),
			},
			initialChoicesKey: this.$lastchoice?this.$lastchoice:&quot;09_NEXT&quot;,
			message: text
		};
		if (chapter.opts) {
			var extras = Object.keys(chapter.opts)
			for (var k=0;k&lt;extras.length;k++) {
				opts[extras[k]] = chapter.opts[extras[k]];
			}
		}
		if (chapter.backgrounds) {
			var page = this._pageOfOffset(chapter,this.$offset,this.$msStore);
			if (page &lt; chapter.backgrounds.length) {
				var backg = chapter.backgrounds[page];
			} else {
				var backg = chapter.backgrounds[chapter.backgrounds.length-1];
			}
			if (backg != &quot;&quot;) {
				opts.overlay = backg;
			}
		}
	
		mission.runScreen(opts,this._manualHandler,this);
		this.$fcbM = addFrameCallback(this._moveShip.bind(this));
	
	}

	//-------------------------------------------------------------------------------------------------------------
	// to make Sothis TC compatible with XenonUI
	this._sothis_missionScreenOpportunity = function() {
		if (!this.$showWelcome) return;
		var messText = expandDescription(&quot;[STC_welcome]&quot;);
		if (this.$new_cargoes)
			messText = messText + expandDescription(&quot;[STC_new_cargoes]&quot;);	
		var tcbgpic = &quot;OOmap_G&quot;+(galaxyNumber+1)+&quot;.png&quot;;
		mission.runScreen({
			title: &quot;Sothis Trade Center&quot;,
			message: messText,
			overlay: tcbgpic
		});
		this.$showWelcome = false;
	}

}).call(this);</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/xenonreduxui_compatibility.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;XenonReduxUI_Compatibility&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2021 phkb&quot;;
this.description = &quot;OXP Compatibility function overrides&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

this.startUp = function () {
    // if xenon UI is also installed, then let it do this work.
    if (worldScripts.XenonUI) return;

    // make Ship&#39;s library compatible
    if (worldScripts[&quot;Ships Library&quot;] &amp;&amp; worldScripts[&quot;Ships Library&quot;].version == &quot;0.8&quot;) {
        var sl = worldScripts[&quot;Ships Library&quot;];
        sl._showPage = this._showPage;
    }
    // make sothis tc compatible
    if (worldScripts.sothis_tc &amp;&amp; worldScripts.sothis_tc.version == &quot;1.0.3&quot;) {
        var stc = worldScripts.sothis_tc;
        stc.missionScreenOpportunity = this._sothis_missionScreenOpportunity;
    }
    // make New Cargoes compatible
    if (worldScripts[&quot;CargoTypeExtension-Auctions&quot;] &amp;&amp; worldScripts[&quot;CargoTypeExtension-Auctions&quot;].version == &quot;1.2.3&quot;) {
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].runOffer = this._auctions_runOffer;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].endAuction = this._auctions_endAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playSantaariAuction = this.playSantaariAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playAngianaAuction = this.playAngianaAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playColesqueAuction = this.playColesqueAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playJaftraAuction = this.playJaftraAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playLaratanAuction = this.playLaratanAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playProximusAuction = this.playProximusAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playSolansAuction = this.playSolansAuction;
        worldScripts[&quot;CargoTypeExtension-Auctions&quot;].playXrataAuction = this.playXrataAuction;
        worldScripts[&quot;CargoTypeExtension&quot;].startTrading = this.startTrading;
        worldScripts[&quot;CargoTypeExtension&quot;].showBuyScreen = this.showBuyScreen;
        worldScripts[&quot;CargoTypeExtension&quot;].showNoBuyScreen = this.showNoBuyScreen;
        worldScripts[&quot;CargoTypeExtension&quot;].showSellScreen = this.showSellScreen;
        worldScripts[&quot;CargoTypeExtension&quot;].showNoSellScreen = this.showNoSellScreen;
        worldScripts[&quot;CargoTypeExtension&quot;].gatherInformation = this.gatherInformation;
        worldScripts[&quot;CargoTypeExtension&quot;].gatherInformation2 = this.gatherInformation2;
        worldScripts[&quot;CargoTypeExtension&quot;].tradeFloor = this.tradeFloor;
        worldScripts[&quot;CargoTypeExtension&quot;].tradeFloorEncounter = this.tradeFloorEncounter;
        worldScripts[&quot;CargoTypeExtension&quot;].detailedManifest = this.detailedManifest;
        worldScripts[&quot;CargoTypeExtension&quot;].permitListing = this.permitListing;
        worldScripts[&quot;CargoTypeExtension&quot;].readTraderNet = this.readTraderNet;
        worldScripts[&quot;CargoTypeExtension-FetchContracts&quot;].runNewOffer = this.runNewOffer;
        worldScripts[&quot;CargoTypeExtension-FetchContracts&quot;].newOfferChoice = this.newOfferChoice;
        worldScripts[&quot;CargoTypeExtension-FetchContracts&quot;].runOldOffer = this.runOldOffer;
        worldScripts[&quot;CargoTypeExtension-FetchContracts&quot;].oldOfferChoice = this.oldOfferChoice;
        worldScripts[&quot;CargoTypeExtension-OpenContract&quot;].runOffer = this._contract_runOffer;
        worldScripts[&quot;CargoTypeExtension-OpenContract&quot;].dealOpenC = this.dealOpenC;
        worldScripts[&quot;CargoTypeExtension-OpenContract&quot;].openContractWin = this.openContractWin;
        worldScripts[&quot;CargoTypeExtension-OpenContract&quot;].openContractLose = this.openContractLose;
        worldScripts[&quot;CargoTypeExtension-Permits&quot;].runOffer = this._permits_runOffer;
        worldScripts[&quot;CargoTypeExtension-Permits&quot;].permitDealings = this.permitDealings;
        worldScripts[&quot;CargoTypeExtension-Scavenger&quot;].runOffer = this._scavenger_runOffer;
        worldScripts[&quot;CargoTypeExtension-Scavenger&quot;].dealScavenger = this.dealScavenger;
    }
    // make Iron Raven compatible
    if (worldScripts[&quot;IR-main-script.js&quot;] &amp;&amp; worldScripts[&quot;IR-main-script.js&quot;].version == &quot;1.4.2.1&quot;) {
        worldScripts[&quot;IR-main-script.js&quot;].questionScreens = this.questionScreens;
        worldScripts[&quot;IR-main-script.js&quot;].shipDockedWithStation = this._ir_shipDockedWithStation;
        worldScripts[&quot;IR-main-script.js&quot;].missionScreens = this.missionScreens;
        worldScripts[&quot;IR-main-script.js&quot;].choiceEvaluation = this.choiceEvaluation;
    }
}

//-------------------------------------------------------------------------------------------------------------
// to make Ships Library compatible
this._showPage = function () {
    var chapter = this.$contents[this.$chapter];

    var text = this._textFromOffset(this.$chapter, this.$offset, this.$msStore, this.$msRows, this.$msCols);

    var opts = {
        screenID: &quot;ships-library&quot;,
        titleKey: chapter.key + &quot;-title&quot;,
        allowInterrupt: true,
        exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
        choices: {
            &quot;01_PREV&quot;: expandMissionText(&quot;ships-library-page-back&quot;),
            &quot;09_NEXT&quot;: expandMissionText(&quot;ships-library-page-next&quot;),
            &quot;10_CONTENTS&quot;: expandMissionText(&quot;ships-library-contents&quot;),
            &quot;99_EXIT&quot;: expandMissionText(&quot;ships-library-exit&quot;),
        },
        initialChoicesKey: this.$lastchoice ? this.$lastchoice : &quot;09_NEXT&quot;,
        message: text
    };
    if (chapter.opts) {
        var extras = Object.keys(chapter.opts)
        for (var k = 0; k &lt; extras.length; k++) {
            opts[extras[k]] = chapter.opts[extras[k]];
        }
    }
    if (chapter.backgrounds) {
        var page = this._pageOfOffset(chapter, this.$offset, this.$msStore);
        if (page &lt; chapter.backgrounds.length) {
            var backg = chapter.backgrounds[page];
        } else {
            var backg = chapter.backgrounds[chapter.backgrounds.length - 1];
        }
        if (backg != &quot;&quot;) {
            opts.overlay = backg;
        }
    }

    mission.runScreen(opts, this._manualHandler, this);
    this.$fcbM = addFrameCallback(this._moveShip.bind(this));

}

//-------------------------------------------------------------------------------------------------------------
// to make Sothis TC compatible
this._sothis_missionScreenOpportunity = function () {
    if (!this.$showWelcome) return;
    var messText = expandDescription(&quot;[STC_welcome]&quot;);
    if (this.$new_cargoes)
        messText = messText + expandDescription(&quot;[STC_new_cargoes]&quot;);
    var tcbgpic = &quot;OOmap_G&quot; + (galaxyNumber + 1) + &quot;.png&quot;;
    mission.runScreen({
        title: &quot;Sothis Trade Center&quot;,
        message: messText,
        overlay: tcbgpic
    });
    this.$showWelcome = false;
}

//-------------------------------------------------------------------------------------------------------------
// to make New Cargoes compatible
this._auctions_runOffer = function () {
    var auc = this.activeAuction();
    var msg = &quot;Welcome, Trader. Bidding doesn&#39;t start until &quot; + clock.clockStringForTime(auc.time) + &quot;, so feel free to get your ship and credit ready before we start. We&#39;ve got &quot; + auc.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(auc.cargo, &quot;specificType&quot;) + &quot; to sell.\n\nRemember, you must have sufficient cargo space to take the goods, and cover all fees and bids from your current credits.\n\nWe&#39;ll be using &quot; + this.auctionTypeName(auc.atype) + &quot; bidding:\n&quot; + expandDescription(&quot;[cte_auc_rules&quot; + auc.atype + &quot;]&quot;);
    mission.runScreen({
        title: this.traderName(),
        message: msg,
        overlay: &quot;cte_auction.png&quot;,
        choicesKey: &quot;cte_auc_opening&quot;
    }, this.checkAuction, this);
}

this._auctions_endAuction = function () {
    mission.runScreen({
        title: &quot;Auction over&quot;,
        overlay: &quot;cte_auction.png&quot;,
        message: this.auctionmessage + &quot;\nThe auction is over.&quot;
    });
    this.localAuctioneer();
}

this.playSantaariAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Santaari (&quot; + this.blockSize(this.currentauction) + &quot; TC blocks)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_santaari_bid&quot;
        }, this.choiceSantaariAuction, this);
    }
}

this.playColesqueAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Colesque (minimum increment &quot; + this.colesqueIncrement(this.currentbid) + &quot;₢)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_colesque_bid&quot;
        }, this.choiceColesqueAuction, this);
    }
}

this.playLaratanAuction = function () {
    if (this.lastcall == 6) {
        this.endLaratanAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;You: &quot; + player.ship.cargoSpaceAvailable + &quot; TC free, &quot; + player.credits.toFixed(1) + &quot;₢ available\n&quot;;
        msg += &quot;Auction: Lara&#39;tan (ticket price &quot; + this.currentbid + &quot;₢)\n&quot;;
        msg += &quot;Round &quot; + this.lastcall + &quot;/5\n&quot;;

        msg += &quot;-----------------------------------\n&quot;;
        for (var i = 0; i &lt; this.currentbidders.length; i++) {
            var line = this.currentbidders[i].name + &quot;: &quot;;
            if (this.currentbidders[i].lastbid == 0) {
                line += &quot;no bid&quot;;
            } else {
                line += this.currentbidders[i].lastbid + &quot; ticket(s)&quot;;
            }
            line += &quot;\n&quot;;
            msg += line;
        }
        var line = &quot;Commander &quot; + player.name + &quot;: &quot;;
        if (this.playerbid == 0) {
            line += &quot;no bid&quot;;
        } else {
            line += this.playerbid + &quot; ticket(s)&quot;;
        }
        line += &quot;\n&quot;;
        msg += line;

        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_laratan_bid&quot;
        }, this.choiceLaratanAuction, this);
    }
}

this.playAngianaAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Angiana (minimum increment &quot; + this.colesqueIncrement(this.currentbid) + &quot;₢, buyout &quot; + this.angianaBuyout() + &quot;₢/TC)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_angiana_bid&quot;
        }, this.choiceAngianaAuction, this);
    }
}

this.playProximusAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Proximus (minimum increment &quot; + this.colesqueIncrement(this.currentbid) + &quot;₢)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_proximus_bid&quot;
        }, this.choiceProximusAuction, this);
    }
}

this.playSolansAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Solans (increment &quot; + this.colesqueIncrement(this.currentbid) + &quot;₢)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_solans_bid&quot;
        }, this.choiceSolansAuction, this);
    }
}

this.playJaftraAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Jaftra\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_jaftra_bid&quot;
        }, this.choiceJaftraAuction, this);
    }
}

this.playXrataAuction = function () {
    if (this.currentauction.quantity &lt; 1) {
        this.endAuction();
    } else {
        var title = this.currentauction.quantity + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.currentauction.cargo, &quot;specificType&quot;);
        var msg = &quot;Auction: Xrata (minimum increment &quot; + this.colesqueIncrement(this.currentbid) + &quot;₢)\n&quot;;
        if (this.auctionmessage != &quot;&quot;) {
            msg += &quot;* &quot; + this.auctionmessage + &quot;\n&quot;;
            this.auctionmessage = &quot;&quot;;
        }
        msg += this.auctionStatus();
        mission.runScreen({
            title: title,
            overlay: &quot;cte_auction.png&quot;,
            message: msg,
            choicesKey: &quot;cte_auc_xrata_bid&quot;
        }, this.choiceXrataAuction, this);
    }
}

this.startTrading = function () {
    var choices = &quot;cte_initscreenchoice&quot;;
    if (missionVariables.cargotypeextension_tradernet &amp;&amp; missionVariables.cargotypeextension_tradernet &gt;= clock.days) {
        choices = &quot;cte_initscreenchoice_wtn&quot;;
    }

    mission.runScreen({
            title: &quot;Specialist Trade Goods Market&quot;,
            message: this.showManifest(),
            overlay: &quot;cte_containers.png&quot;,
            choicesKey: choices
        },
        this.initScreenChoice, this);
}

this.showNoBuyScreen = function () {
    mission.runScreen({
            title: &quot;Buy Specialist Trade Goods&quot;,
            overlay: &quot;cte_containers.png&quot;,
            message: &quot;No specialist trade goods available for purchase&quot;
        },
        this.startTrading, this);
}

this.showBuyScreen = function () {
    var goods = this.stationMarket[this.pointer];

    mission.runScreen({
            title: &quot;Buy &quot; + this.specialCargoRegister[goods.type].specificType,
            overlay: &quot;cte_containers.png&quot;,
            message: this.buyMessage(goods),
            choicesKey: &quot;cte_buyscreenchoice&quot;,
            initialChoicesKey: this.lastscreenchoice
        },
        this.handleBuyDecision, this);
}

this.showNoSellScreen = function () {
    mission.runScreen({
            overlay: &quot;cte_containers.png&quot;,
            title: &quot;Sell Specialist Trade Goods&quot;,
            message: &quot;No specialist trade goods in hold&quot;
        },
        this.startTrading, this);
}

this.showSellScreen = function () {
    var goods = this.holdgoods[this.pointer];
    mission.runScreen({
            overlay: &quot;cte_containers.png&quot;,
            title: &quot;Sell &quot; + this.specialCargoRegister[goods].specificType,
            message: this.sellMessage(goods),
            choicesKey: &quot;cte_sellscreenchoice&quot;,
            initialChoicesKey: this.lastscreenchoice
        },
        this.handleSellDecision, this);
}

this.gatherInformation = function () {
    mission.runScreen({
            title: &quot;Local imports/exports&quot;,
            overlay: &quot;cte_tradefloor.png&quot;,
            message: this.localTradeGoods()
        },
        this.gatherInformation2, this);
}

this.gatherInformation2 = function () {
    mission.runScreen({
            title: &quot;Gossip in the trade district&quot;,
            overlay: &quot;cte_tradefloor.png&quot;,
            message: this.localGossip()
        },
        this.startTrading, this);
}

this.tradeFloor = function () {
    var choice = &quot;cte_tradefloorchoice&quot;;
    this.debug(&quot;Building trade floor&quot;);
    var traders = new Array;
    var srole = &quot;&quot;;
    if (player.ship.dockedStation != system.mainStation) {
        var srole = player.ship.dockedStation.primaryRole;
    }
    for (var i = 0; i &lt; this.personalities.length; i++) {
        if (worldScripts[this.personalities[i]].traderHere &amp;&amp; worldScripts[this.personalities[i]].traderHere(srole)) {
            traders.push(this.personalities[i]);
            this.debug(this.personalities[i] + &quot; is present&quot;);
        }
    }
    if (traders.length == 0) {
        this.tradeflooractive = 0;
        mission.runScreen({
                title: &quot;No-one about&quot;,
                overlay: &quot;cte_tradefloor.png&quot;,
                message: &quot;The trade floor is deserted.&quot;
            },
            this.startTrading, this
        );
    } else {
        if (traders.length == 1) {
            choice = &quot;cte_tradeflooronlychoice&quot;;
        }
        this.tradeFloorEncounter(traders[this.tradefloorpointer % traders.length], choice);
    }
}

this.tradeFloorEncounter = function (traderscript, choice) {
    var title = worldScripts[traderscript].traderName();
    var desc = worldScripts[traderscript].traderDesc();

    this.traderscript = traderscript;
    mission.runScreen({
        title: title,
        overlay: &quot;cte_tradefloor.png&quot;,
        message: desc,
        choicesKey: choice
    }, this.tradeFloorChoice, this);
}

this.detailedManifest = function () {
    var manlines = this.detailedManifestLines();
    var maxlines = 15;
    if (manlines.length &lt;= maxlines) {
        mission.runScreen({
                title: &quot;Detailed Manifest&quot;,
                overlay: &quot;cte_containers.png&quot;,
                message: this.viewDetailedManifest(manlines, 0, maxlines),
                choicesKey: &quot;cte_manifestlast&quot;
            },
            this.startTrading, this);
    } else {
        var pages = 1 + Math.floor((manlines.length - 1) / maxlines);
        var cpage = 1 + Math.floor((this.dmanoffset) / maxlines);
        var fn = this.startTrading;
        var choice = &quot;cte_manifestlast&quot;;
        if (this.dmanoffset + maxlines &lt; manlines.length) {
            fn = this.detailedManifest;
            var choice = &quot;cte_manifestnext&quot;;
        }
        mission.runScreen({
                title: &quot;Detailed Manifest (&quot; + cpage + &quot;/&quot; + pages + &quot;)&quot;,
                overlay: &quot;cte_containers.png&quot;,
                message: this.viewDetailedManifest(manlines, this.dmanoffset, maxlines),
                choicesKey: choice
            },
            fn, this);

        this.dmanoffset += maxlines;
    }
}

this.permitListing = function () {
    var msg = &quot;&quot;;
    for (var k = 0; k &lt; this.permits.length; k++) {
        this.debug(&quot;Trying &quot; + this.permits[k]);
        msg += worldScripts[this.permits[k]].describePermits();
    }
    for (var k = 0; k &lt; this.personalities.length; k++) {
        this.debug(&quot;Trying &quot; + this.personalities[k]);
        msg += worldScripts[this.personalities[k]].describeContracts();
    }

    if (msg == &quot;&quot;) {
        msg = &quot;You have no permits or active contracts, and no local regulations apply to trading.&quot;;
    }
    mission.runScreen({
            title: &quot;Permits, Contracts and Regulations&quot;,
            overlay: &quot;cte_permit.png&quot;,
            message: msg
        },
        this.startTrading, this);
}

this.readTraderNet = function () {
    var background = worldScripts[&quot;CargoTypeExtension-TraderNet&quot;].getPic();
    var messages = worldScripts[&quot;CargoTypeExtension-TraderNet&quot;].numMessages();
    if (messages == 0) {
        mission.runScreen({
                title: &quot;TraderNet News&quot;,
                overlay: background,
                message: &quot;\n\n\n\n\n\n\n\nNo news available.&quot;,
                choicesKey: &quot;cte_tradernet_last&quot;
            },
            this.startTrading, this);
    } else {
        if (this.tradernetpointer &gt;= messages) {
            var article = worldScripts[&quot;CargoTypeExtension-TraderNet&quot;].getMessage(messages);
            var ckey = &quot;cte_tradernet_last&quot;;
        } else {
            var ckey = &quot;cte_tradernet&quot;;
            var article = worldScripts[&quot;CargoTypeExtension-TraderNet&quot;].getMessage(this.tradernetpointer++);
        }
        mission.runScreen({
                title: &quot;TraderNet News&quot;,
                overlay: background,
                message: &quot;\n\n\n\n\n\n\n\n&quot; + article,
                choicesKey: ckey
            },
            function (choice) {
                if (choice == &quot;01_NEXT&quot;) {
                    this.readTraderNet();
                } else {
                    this.startTrading();
                }
            }, this);
    }
}

this.runNewOffer = function () {
    var offer = this.currentOffer();
    var msg = &quot;This is a standard procurement contract - you bring me &quot; + offer.amount + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(offer.good, &quot;specificType&quot;) + &quot; by &quot; + offer.deadline + &quot;, at a rate of &quot; + offer.price + &quot;₢/TC.\nYou can bring them in more than one load, if you want, and how you obtain the goods is up to you.\nIf you fail to fulfil the contract, there will be a penalty charge of &quot; + offer.price + &quot;₢ for every TC you are short, to cover my risk of being short on what I need, so it&#39;s in your interests to have a good idea of how you&#39;re going to deliver the goods.\n&quot;;

    mission.runScreen({
        title: this.traderName(),
        message: msg,
        overlay: &quot;cte_tradefloor.png&quot;,
        choicesKey: &quot;cte_fetch_deal&quot;
    }, this.newOfferChoice, this);
}

this.newOfferChoice = function (choice) {
    if (choice == &quot;01_ACCEPT&quot;) {
        this.fetchContracts.push(this.localOffer);
        this.localOffer = false;
        var msg = &quot;Thank you, Trader &quot; + player.name + &quot;. I look forward to you returning with the goods.&quot;;
    } else {
        var msg = &quot;If you change your mind after a look at your charts, then I&#39;ll be around here for a little bit longer.&quot;;
    }

    mission.runScreen({
        title: this.traderName(),
        message: msg,
        overlay: &quot;cte_tradefloor.png&quot;
    }, this.leaveFetch, this);
}

this.runOldOffer = function () {
    var offer = this.currentOffer();

    var carried = worldScripts[&quot;CargoTypeExtension&quot;].hasSpecialCargo(offer.good);
    if (carried == 0) {
        mission.runScreen({
            title: this.traderName(),
            message: &quot;You don&#39;t seem to have any &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(offer.good, &quot;specificType&quot;) + &quot; in your hold right now, Trader. Remember, I still need you to deliver &quot; + offer.amount + &quot; TC by &quot; + offer.deadline + &quot;.&quot;,
            overlay: &quot;cte_tradefloor.png&quot;
        }, this.leaveFetch, this);
    } else {
        var msg = &quot;Welcome back, Trader &quot; + player.name + &quot;. Your manifest indicates that you have &quot; + carried + &quot; TC of &quot; + worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(offer.good, &quot;specificType&quot;) + &quot; in your hold. Would you like to transfer them now, for the agreed price of &quot; + offer.price + &quot;₢ up to the &quot; + offer.amount + &quot; TC remaining on this contract?&quot;;
        mission.runScreen({
            title: this.traderName(),
            message: msg,
            overlay: &quot;cte_tradefloor.png&quot;,
            choicesKey: &quot;cte_fetch_transfer&quot;
        }, this.oldOfferChoice, this);
    }
}

this.oldOfferChoice = function (choice) {
    if (choice != &quot;01_ACCEPT&quot;) {
        mission.runScreen({
            title: this.traderName(),
            message: &quot;Don&#39;t forget to drop them off here before you leave, then!&quot;,
            overlay: &quot;cte_tradefloor.png&quot;
        }, this.leaveFetch, this);
        return;
    }

    var offer = this.currentOffer();
    var transferred = 0;
    while (offer.amount &gt; 0 &amp;&amp; worldScripts[&quot;CargoTypeExtension&quot;].hasSpecialCargo(offer.good) &gt; 0) {
        if (worldScripts[&quot;CargoTypeExtension&quot;].removeSpecialCargo(offer.good)) {
            transferred++;
            offer.amount--;
        } else {
            worldScripts[&quot;CargoTypeExtension&quot;].error(&quot;Unable to transfer expected good in fetch contract?!&quot;);
            player.consoleMessage(&quot;Warning: Unexpected error in NewCargoes OXP. Please see Latest.Log&quot;);
            return;
        }
    }

    var price = offer.price * transferred;
    var msg = &quot;Thank you. &quot; + transferred + &quot; TC has been transferred, and &quot; + price + &quot;₢ has been credited to your account.\n&quot;;
    player.credits += price;

    if (offer.amount &gt; 0) {
        msg += offer.amount + &quot; TC remain to be delivered by &quot; + offer.deadline + &quot;, Trader - I hope to see you back soon with more.&quot;;
    } else {
        msg += &quot;Thank you, Trader. This is all of the goods we agreed. I hope to see you again soon.&quot;;
    }
    mission.runScreen({
        title: this.traderName(),
        message: msg,
        overlay: &quot;cte_tradefloor.png&quot;
    }, this.leaveFetch, this);
}

this._contract_runOffer = function () {
    var price = worldScripts[&quot;CargoTypeExtension&quot;].cargoPriceExport(&quot;CTE_CTOC_1&quot;, 15, worldScripts[&quot;CargoTypeExtension&quot;].defaultMarketInfo()) / 10;
    var totalprice = price * this.contractdata.amount;

    if (player.ship.cargoSpaceCapacity &lt; this.contractdata.amount) {
        var msg = &quot;Trader, I appreciate your enthusiasm, but unfortunately my buyer isn&#39;t interested in partial deliveries. Come back and see me when you&#39;ve got a proper freighter.&quot;;

        if (player.ship.equipmentStatus(&quot;EQ_HYPERCARGO&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_MULTIBAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
            msg = &quot;Unfortunately, Trader, my buyer is somewhat old-fashioned, and doesn&#39;t approve of all these new hyperspatial storage arrangements. I&#39;m afraid I can only offer this contract to people with a sufficiently large primary cargo bay.&quot;;
        }
        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg
        }, this.leaveOpenC, this);

    } else if (player.ship.cargoSpaceAvailable &lt; this.contractdata.amount) {
        var msg = &quot;I&#39;m sorry, Trader. You&#39;ll need to free up some hold space before we can discuss this contract.&quot;;

        if (player.ship.equipmentStatus(&quot;EQ_HYPERCARGO&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_MULTIBAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
            msg = &quot;Unfortunately, Trader, my buyer is somewhat old-fashioned, and doesn&#39;t approve of all these new hyperspatial storage arrangements. You&#39;ll have to reorganise your cargo to get enough space in the main hold area for the goods before I can transfer them.&quot;;
        }

        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg
        }, this.leaveOpenC, this);
    } else if (totalprice &gt; player.credits) {
        var msg = &quot;I&#39;m sorry, Trader. You don&#39;t have enough credits to afford the security deposit. Come back some day when you&#39;re a little richer.&quot;;
        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg
        }, this.leaveOpenC, this);

    } else {

        var msg = &quot;Here&#39;s the deal, &quot; + player.name + &quot;. I&#39;ll sell you &quot; + this.contractdata.amount + &quot; of &quot; + this.contractdata.cargospecific + &quot; for &quot; + price.toFixed(1) + &quot;₢/TC (&quot; + totalprice + &quot;₢) security deposit. When you get to &quot; + System.infoForSystem(galaxyNumber, this.contractdata.dest).name + &quot; station, &quot; + this.contractdata.buyer + &quot; will pay you over ten times that for delivery. I can&#39;t tell you the exact price, unfortunately, because that obsolete Galcop regulation is still being enforced. They&#39;ll then pay me the rest of the goods cost minus your delivery fee and the security deposit. Everyone&#39;s a winner.\n\nWhat&#39;s that? What&#39;s the catch? Well, you&#39;re not the only one taking this contract. &quot; + this.contractdata.buyer + &quot; is only going to pay the first one there, so you&#39;ll need to be fast. You&#39;re one of the first to show up, so your odds are pretty good.&quot;;

        if (player.ship.equipmentStatus(&quot;EQ_HYPERCARGO&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_MULTIBAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
            msg = &quot;\n\nOh, by the way, Trader, my buyer is somewhat old-fashioned, and doesn&#39;t approve of all these new hyperspatial storage arrangements. For auditing purposes, you should keep the cargo in your main hold throughout the trip.&quot;;
        }

        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg,
            choicesKey: &quot;cte_oc_deal&quot;
        }, this.dealOpenC, this);
    }
}

this.dealOpenC = function (choice) {
    if (choice == &quot;01_DEAL&quot;) {
        var price = worldScripts[&quot;CargoTypeExtension&quot;].cargoPriceExport(&quot;CTE_CTOC_1&quot;, 15, worldScripts[&quot;CargoTypeExtension&quot;].defaultMarketInfo()) / 10;
        for (var i = 1; i &lt;= this.contractdata.amount; i++) {
            worldScripts[&quot;CargoTypeExtension&quot;].addSpecialCargo(&quot;CTE_CTOC_1&quot;, price.toFixed(1) + &quot;₢ for open contract in &quot; + system.info.name);
        }
        worldScripts[&quot;CargoTypeExtension&quot;].debug(price + &quot; &quot; + this.contractdata.amount);
        player.credits = player.credits - (price * this.contractdata.amount);
        this.contractdata.active = 1;

        var msg = &quot;Thank you, Trader. The cargo is being loaded on to your ship as we speak. I recommend you launch as soon as possible.&quot;;
        if (player.ship.equipmentStatus(&quot;EQ_HYPERCARGO&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_MULTIBAY&quot;) === &quot;EQUIPMENT_OK&quot;) {
            msg += &quot;\n\nRemember that the buyer doesn&#39;t approve of hyperspatial cargo storage. You can carry the cargo there in flight at your own risk if you must, but make sure that all the goods are in your primary cargo hold when you dock at the destination station, or they probably won&#39;t take them.&quot;;
        }

    } else {
        var msg = &quot;Understood, Trader. Now, if you&#39;ll excuse me, I have a few other potential couriers to talk to. I&#39;ll still be here for a little while if you change your mind.&quot;;
    }
    mission.runScreen({
        title: this.traderName(),
        overlay: &quot;cte_tradefloor.png&quot;,
        message: msg
    }, this.leaveOpenC, this);
}

this.openContractWin = function () {
    var price = worldScripts[&quot;CargoTypeExtension&quot;].cargoPriceImport(&quot;CTE_CTOC_1&quot;, 15, worldScripts[&quot;CargoTypeExtension&quot;].defaultMarketInfo()) / 10;
    var carried = worldScripts[&quot;CargoTypeExtension&quot;].hasSpecialCargo(&quot;CTE_CTOC_1&quot;);
    var msg = &quot;Welcome, Trader &quot; + player.name + &quot;. Let&#39;s see those &quot; + this.contractdata.cargospecific + &quot; then.\n\n&quot;;
    if (carried == this.contractdata.amount) {
        msg += &quot;Ah, excellent. All present and correct. If you&#39;ll just authorise the cargo transfer, the &quot; + price.toFixed(1) + &quot; ₢/TC will be yours.&quot;;

    } else if (carried &gt;= this.contractdata.amount) { // shouldn&#39;t be possible, in general. Well, they probably deserve a small bonus.
        msg += &quot;Ah, excellent. All present and correct. If you&#39;ll just authorise the cargo transfer, the &quot; + price.toFixed(1) + &quot; ₢/TC will be yours. I&#39;ll take the spares off your hands for the same price, I think. Don&#39;t tell &quot; + this.contractdata.seller + &quot;, though, or they&#39;ll be wanting their cut.&quot;;

    } else if (carried &gt; 0) {
        price = Math.floor(price * (carried / this.contractdata.amount));
        msg += &quot;You appear to be missing some of the cargo I need. I&#39;ll take what you have off your hands, now it&#39;s here, but your payment has been reduced to &quot; + price.toFixed(1) + &quot; ₢/TC to account for my costs in obtaining replacements.&quot;;
    } else if (carried == 0) {
        msg += &quot;Ah. Apologies. I seem to have been misinformed. I thought you were carrying some goods for me, but it must have been someone with a similar name.&quot;;
    }

    player.credits += price * carried;
    for (var i = 1; i &lt;= carried; i++) {
        worldScripts[&quot;CargoTypeExtension&quot;].removeSpecialCargo(&quot;CTE_CTOC_1&quot;);
    }

    this.contractdata.active = 0;
    mission.runScreen({
        title: this.contractdata.buyer,
        overlay: &quot;cte_tradefloor.png&quot;,
        message: msg
    }, function () {}, this);
}

this.openContractLose = function () {
    this.contractdata.active = 0;

    var missed = clock.adjustedSeconds - this.contractdata.deadline;
    var msg = &quot;You can&#39;t find &quot; + this.contractdata.buyer + &quot; when you dock. You ask the harbourmaster if they&#39;ve seen them.\n\n&quot;
    if (missed &lt; 60) {
        msg += &quot;You&#39;ve literally just missed them. Some trader in a Boa Clipper was unloading cargo with them over there.&quot;;
    } else if (missed &lt; 3600) {
        msg += &quot;They were here a moment ago. I think they left a few minutes ago with a Boa II pilot.&quot;;
    } else if (missed &lt; 86400) {
        msg += &quot;I saw them around earlier today. An L-Crate full of cargo came in for them, I think, so they were supervising the unloading.&quot;;
    } else if (missed &lt; (86400 * 7)) {
        msg += &quot;Not for a few days, no. They were taking some cargo from a Boa planetside.&quot;;
    } else {
        msg += &quot;No, they&#39;ve not been up here for a while, not since that Anaconda came in last week.&quot;;
    }

    mission.runScreen({
        title: &quot;Too late...&quot;,
        overlay: &quot;cte_tradefloor.png&quot;,
        message: msg
    }, function () {}, this);
}

this._permits_runOffer = function () {
    if (player.ship.targetSystem == system.ID) {
        this.permitDealings(&quot;Please set your navigation computer&#39;s destination system to your desired importer.&quot;);
        return;
    }
    this.currentpermit = this.decodePermit(this.permitSeller.permitcode);
    this.currentpermit.good = this.permitSeller.good;
    this.currentpermit.dest = player.ship.targetSystem;
    this.currentpermit.real = this.permitSeller.real;
    this.currentpermit.deadline = this.calculatePermitDeadline(this.currentpermit.dest, this.currentpermit.timenoise);
    if (this.currentpermit.deadline == 0) {
        this.permitDealings(&quot;I&#39;m afraid we don&#39;t have a trade agreement with &quot; + System.infoForSystem(galaxyNumber, player.ship.targetSystem).name + &quot;, Trader.&quot;);
        return;
    } else {
        var price = this.permitPrice(this.currentpermit);
        var desc = this.permitDescription(this.currentpermit);
        var msg = &quot;We can offer the following permit:\n&quot;;
        msg += &quot;-------------------------\n&quot;;
        msg += desc + &quot;\n&quot;;
        msg += &quot;-------------------------\n&quot;;
        msg += &quot;Inclusive of all fees and taxes, this will cost &quot; + price + &quot;₢&quot;;

        mission.runScreen({
            title: this.traderName(),
            message: msg,
            choicesKey: &quot;cte_permit_deal&quot;,
            overlay: &quot;cte_permit.png&quot;
        }, this.permitChoice, this);
    }
}

this.permitDealings = function (msg) {
    mission.runScreen({
        title: this.traderName(),
        message: msg,
        overlay: &quot;cte_permit.png&quot;
    }, this.permitExit, this);
}

this._scavenger_runOffer = function () {
    var scav = this.activeScavenger();

    var spec = worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.scavengerCargoes[scav], &quot;specificType&quot;);
    var gen = worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.scavengerCargoes[scav], &quot;genericType&quot;);

    var amount = worldScripts[&quot;CargoTypeExtension&quot;].hasSpecialCargo(this.scavengerCargoes[scav]);
    if (amount == 0) {
        var msg = &quot;I&#39;m sorry, Trader. I&#39;m sure the contents of your hold are fascinating to the right buyer, but I&#39;m only looking for &quot; + spec + &quot;. I won&#39;t take up your time any further.&quot;;
        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg
        }, this.leaveScavenger, this);

    } else {
        var price = Math.floor(1000 * amount * (Math.pow(amount, 0.25)));
        if (gen == &quot;slaves&quot; || gen == &quot;narcotics&quot; || gen == &quot;firearms&quot;) {
            price *= 2; // illegal goods
        }

        var msg = &quot;Excellent work, Trader. In exchange for the &quot; + amount + &quot; TC of &quot; + spec + &quot; in your hold, I will pay &quot; + price + &quot;₢. Do we have a deal?&quot;;
        mission.runScreen({
            title: this.traderName(),
            overlay: &quot;cte_tradefloor.png&quot;,
            message: msg,
            choicesKey: &quot;cte_scav_deal&quot;
        }, this.dealScavenger, this);
    }
}

this.dealScavenger = function (choice) {
    if (choice == &quot;01_DEAL&quot;) {
        var scav = this.activeScavenger();
        var gen = worldScripts[&quot;CargoTypeExtension&quot;].cargoDefinition(this.scavengerCargoes[scav], &quot;genericType&quot;);

        var amount = worldScripts[&quot;CargoTypeExtension&quot;].hasSpecialCargo(this.scavengerCargoes[scav]);
        for (var i = 0; i &lt; amount; i++) {
            worldScripts[&quot;CargoTypeExtension&quot;].removeSpecialCargo(this.scavengerCargoes[scav]);
        }
        var price = Math.floor(1000 * amount * (Math.pow(amount, 0.25)));
        if (gen == &quot;slaves&quot; || gen == &quot;narcotics&quot; || gen == &quot;firearms&quot;) {
            price *= 2; // illegal goods
        }

        player.credits += price;

        var msg = &quot;A pleasure dealing with you, Trader. &quot; + price + &quot;₢ has been credited to your account. Contact me again if you find any more.&quot;;

    } else {
        var msg = &quot;Your choice, but you won&#39;t find anyone else willing to pay this much. Come back when you&#39;ve figured that out for yourself.&quot;;
    }
    mission.runScreen({
        title: this.traderName(),
        overlay: &quot;cte_tradefloor.png&quot;,
        message: msg
    }, this.leaveScavenger, this);
}

//-------------------------------------------------------------------------------------------------------------
// to make Iron Raven compatible
this.questionScreens = function () {
    if (system.ID == 23) // Maenes
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;QuiCo Pharmaceuticals&quot;,
                overlay: &quot;IR_quico_logo.png&quot;,
                messageKey: &quot;IR_MAENES_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_MAENES_QUESTIONS&quot;
        }
    }

    if (system.ID == 171) // Yokohama
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;Yokohama Exports&quot;,
                overlay: &quot;IR_yk_logo.png&quot;,
                messageKey: &quot;IR_YOKOHAMA_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_YOKOHAMA_QUESTIONS&quot;
        }
    }

    if (system.ID == 232) //Janes
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;Janes&#39;s Shipyard Intelligence&quot;,
                overlay: &quot;IR_janes_logo.png&quot;,
                messageKey: &quot;IR_JANES_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_JANES_QUESTIONS&quot;
        }
    }

    if (system.ID == 240) // Pirate Cove
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            if (!missionVariables.IR_alsto) {
                this._runScreen({
                    title: &quot; &quot;,
                    messageKey: &quot;IR_PIRATE_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
                missionVariables.IR_alsto = &quot;MET&quot;
            } else {
                this._runScreen({
                    title: &quot; &quot;,
                    messageKey: &quot;IR_PIRATE_intro_alt&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
            }
        }
    }

    if (system.ID == 119) // PleasureWorld
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;PleasureWorld&quot;,
                overlay: &quot;IR_pw_logo.png&quot;,
                messageKey: &quot;IR_PW_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_PW_QUESTIONS&quot;
        }
    }

    if (system.ID == 180) // NWE
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;Naval Weapons Establishment&quot;,
                overlay: &quot;IR_NWE_logo.png&quot;,
                messageKey: &quot;IR_NWE_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_NWE_QUESTIONS&quot;
        }
    }

    if (system.ID == 219) // GSE
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;Galactic Stock Exchange&quot;,
                overlay: &quot;IR_GSE_logo.png&quot;,
                messageKey: &quot;IR_GSE_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
        }
    }

    if (system.ID == 31) // KORSHKOV
    {
        if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
            this._runScreen({
                title: &quot;OKB Korshkov&quot;,
                overlay: &quot;IR_korshlogo.png&quot;,
                messageKey: &quot;IR_KORSHKOV_intro&quot;,
                choicesKey: &quot;IR_questions&quot;
            }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_KORSHKOV_QUESTIONS&quot;
        }
    }
}

this._ir_shipDockedWithStation = function (station) {
    this.addIRinterface()

    if (missionVariables.IR_status == &quot;IR_epilogue&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
        this._runScreen({
            messageKey: &quot;IR_final&quot;,
            choicesKey: &quot;IR_continue&quot;
        }, function (choice) {
            if (choice == 1) {
                this._runScreen({
                    overlay: &quot;IR_title.png&quot;,
                    messageKey: &quot;IR_theend&quot;
                });
                missionVariables.IR_status = &quot;IR_completed&quot;
                mission.setInstructionsKey(null)
                missionVariables.IR_epilogue_deadline = null
                missionVariables.IR_shipment_quest = null
                missionVariables.IR_SDF_quest = null
                missionVariables.IR_SDF_question_no = null
                missionVariables.IR_SDF_question_key = null
                missionVariables.IR_SDF_question_string = null
                missionVariables.IR_defences_quest = null
                missionVariables.IR_defences_question_no = null
                missionVariables.IR_defences_question_key = null
                missionVariables.IR_defences_question_string = null
                missionVariables.IR_finance_quest = null
                missionVariables.IR_finance_question_no = null
                missionVariables.IR_finance_question_key = null
                missionVariables.IR_finance_question_string = null
                missionVariables.IR_shipment_quest_method = null
                missionVariables.IR_shipment_question_no = null
                missionVariables.IR_shipment_question_key = null
                missionVariables.IR_shipment_question_string = null
                missionVariables.IR_GSE_loan = null
                missionVariables.IR_wife_status = null
                missionVariables.IR_alsto = null
                missionVariables.IR_count = null
                missionVariables.IR_defences_kill_count = null
                missionVariables.IR_SDF_quest_location = null
                missionVariables.IR_SDF_quest_location_name = null
                missionVariables.IR_KORSHKOV_deadline = null
                missionVariables.IR_asked_question = null
                missionVariables.IR_question_settings = null
                missionVariables.IR_screen_log = null
                missionVariables.IR_screen_location = null
            }
        });
    }
    if (player.ship.docked &amp;&amp; galaxyNumber == 7) this.missionScreens();
}

this.missionScreens = function () {
    if (guiScreen == &quot;GUI_SCREEN_MISSION&quot; || !player.ship.docked)
        return;

    if (player.ship.dockedStation.hasRole(&quot;IR-luft-core&quot;)) {
        if (missionVariables.IR_SDF_quest == &quot;JACOB&quot; || missionVariables.IR_SDF_quest == &quot;LUFTSLOTTE&quot;) {
            this._runScreen({
                title: &quot;Luftslotte 6&quot;,
                messageKey: &quot;IR_SDF_quest_4&quot;
            })
            missionVariables.IR_SDF_quest = &quot;KRAIT&quot;
        }
    }

    if (player.ship.dockedStation.isMainStation &amp;&amp; missionVariables.IR_offer == null) {
        if (missionVariables.IR_status == null) {
            this._runScreen({
                overlay: &quot;IR_title.png&quot;,
                choicesKey: &quot;IR_continue&quot;
            }, function (choice) {
                if (choice == 1) {
                    this._runScreen({
                        messageKey: &quot;IR_IBANEZ_1&quot;
                    });
                    mission.setInstructionsKey(&quot;IR_IBANEZ_INFO&quot;)
                    missionVariables.IR_status = &quot;IR_IBANEZ_1&quot;
                }
            });
        }

        if (missionVariables.IR_finance_quest == &quot;REPROCESSED&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_KORSHKOV_deadline) //this is 20 days
        {
            this._runScreen({
                title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                messageKey: &quot;IR_finance_quest_4&quot;
            });
            missionVariables.IR_finance_quest = &quot;JANES_NEWS&quot;
            missionVariables.IR_KORSHKOV_deadline = null
            player.incrementFinanceStatus()
        }

        if (missionVariables.IR_SDF_quest == &quot;ADDRESS&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_SDF_deadline) {
            this._runScreen({
                messageKey: &quot;IR_SDF_quest_2&quot;
            });
            missionVariables.IR_SDF_quest = &quot;JACOB&quot;
            player.incrementSDFStatus()
        }

        if (missionVariables.IR_SDF_quest == &quot;POD_SCOOPED&quot;) {
            this._runScreen({
                messageKey: &quot;IR_SDF_quest_5&quot;
            });
            player.ship.useSpecialCargo(&quot;WARNING: Radiation detected in cargo hold&quot;)
            missionVariables.IR_SDF_quest = &quot;KORSHKOV&quot;
            player.incrementSDFStatus()
        }

        if (missionVariables.IR_SDF_quest == &quot;PHOTO&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_SDF_deadline) {
            this._runScreen({
                messageKey: &quot;IR_SDF_quest_8a&quot;,
                overlay: &quot;IR_kinnaird.png&quot;,
                choicesKey: &quot;IR_continue&quot;
            }, function (choice) {
                if (choice == 1)
                    this._runScreen({
                        messageKey: &quot;IR_SDF_quest_8b&quot;,
                        overlay: &quot;IR_match.png&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this._runScreen({
                                messageKey: &quot;IR_SDF_quest_8c&quot;
                            });
                            missionVariables.IR_SDF_quest = &quot;COMPLETED&quot;
                            player.clearSDFStatus()
                            missionVariables.IR_SDF_status_no = null
                            missionVariables.IR_SDF_deadline = null
                                ++missionVariables.IR_quest_count
                        }
                    });
            });
        }

        if (missionVariables.IR_finance_quest == &quot;WAIT3&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_KORSHKOV_deadline) {
            this._runScreen({
                title: &quot; &quot;,
                overlay: &quot;IR_bloomberg.png&quot;,
                messageKey: &quot;IR_finance_quest_10&quot;
            });
            missionVariables.IR_KORSHKOV_deadline = null
            player.clearFinanceStatus()
            missionVariables.IR_finance_status_no = null
            missionVariables.IR_finance_quest = &quot;COMPLETED&quot;
                ++missionVariables.IR_quest_count
        }

        if (missionVariables.IR_shipment_quest == &quot;SUCCESS&quot;) {
            this._runScreen({
                messageKey: &quot;IR_shipment_success&quot;
            });
            player.clearShipmentStatus()
            missionVariables.IR_shipment_status_no = null
            missionVariables.IR_shipment_quest = &quot;COMPLETED&quot;
            missionVariables.IR_YOKOHAMA_deadline = null
                ++missionVariables.IR_quest_count
            missionVariables.IR_tipoff_deadline = clock.days + 10
        }

        if (missionVariables.IR_shipment_quest == &quot;DISPATCHED&quot;) {
            this._runScreen({
                messageKey: &quot;IR_shipment_failure&quot;
            });
            player.clearShipmentStatus()
            missionVariables.IR_shipment_status_no = null
            missionVariables.IR_shipment_quest = &quot;FAILED&quot;
                ++missionVariables.IR_quest_count
            missionVariables.IR_YOKOHAMA_deadline = null
        }

        if (missionVariables.IR_shipment_quest == &quot;COMPLETED&quot;) {
            if (clock.days &gt;= missionVariables.IR_tipoff_deadline) {
                this._runScreen({
                    messageKey: &quot;IR_tipoff&quot;
                });
                missionVariables.IR_tipoff_deadline = null
                missionVariables.IR_shipment_quest = &quot;TIPPEDOFF&quot;
            }
        }

        if (missionVariables.IR_loan_deadline) {
            if (clock.days &gt;= missionVariables.IR_loan_deadline) {
                this._runScreen({
                    title: &quot;First Galactic Bank&quot;,
                    messageKey: &quot;IR_GSE_loan_warning&quot;
                });
                mission.setInstructionsKey(null)
                missionVariables.IR_loan_deadline = null
                missionVariables.IR_load_remaining = null
                player.credits -= 550000
                missionVariables.IR_GSE_loan = &quot;DEFAULTED&quot;
            }
        }

        if (missionVariables.IR_defences_quest == &quot;DEMO_6&quot; &amp;&amp; clock.days &gt; missionVariables.IR_defences_quest_deadline) {
            this._runScreen({
                messageKey: &quot;IR_defences_quest_6&quot;
            });
            ++missionVariables.IR_quest_count
            missionVariables.IR_defences_quest = &quot;COMPLETED&quot;
            missionVariables.IR_defences_quest_deadline = null
            missionVariables.IR_defences_status_no = null
            player.clearDefencesStatus()
        }

        if (missionVariables.IR_status == &quot;IR_KINNAIRD_2&quot;) {
            this._runScreen({
                messageKey: &quot;IR_kinnaird_3alt&quot;
            });
        }

        if (missionVariables.IR_status == &quot;IR_LEXICON_1&quot; &amp;&amp; clock.days &gt; missionVariables.IR_LEXICON_deadline) {
            this._runScreen({
                messageKey: &quot;IR_LEXICON_2&quot;
            });
            missionVariables.IR_status = &quot;IR_LEXICON_2&quot;
            mission.setInstructionsKey(&quot;IR_LEXICON_brief_2&quot;)
            missionVariables.IR_LEXICON_deadline = null
        }

        if (missionVariables.IR_status == &quot;IR_CHERKASOVA_1&quot;) // briefing with Cherkasova
        {
            this._runScreen({
                messageKey: &quot;IR_CHERKASOVA_1a&quot;,
                overlay: &quot;IR_KSR_logo.png&quot;,
                choicesKey: &quot;IR_continue&quot;
            }, function (choice) {
                if (choice == 1)
                    this._runScreen({
                        messageKey: &quot;IR_CHERKASOVA_1b&quot;,
                        overlay: &quot;IR_KSR_logo.png&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1)
                            this._runScreen({
                                messageKey: &quot;IR_CHERKASOVA_1c&quot;,
                                overlay: &quot;IR_KSR_logo.png&quot;,
                                choicesKey: &quot;IR_continue&quot;
                            }, function (choice) {
                                if (choice == 1)
                                    this._runScreen({
                                        messageKey: &quot;IR_CHERKASOVA_1d&quot;,
                                        overlay: &quot;IR_KSR_logo.png&quot;,
                                        choicesKey: &quot;IR_cherkasova_choices&quot;
                                    }, function (choice) {
                                        if (choice == 1) {
                                            this._runScreen({
                                                messageKey: &quot;IR_LOA_1&quot;,
                                                overlay: &quot;IR_KSR_logo.png&quot;
                                            })
                                            mission.setInstructionsKey(&quot;IR_LOA_brief_1&quot;)
                                            missionVariables.IR_status = &quot;IR_LOA_1&quot;
                                            mission.setInstructionsKey(&quot;IR_LOA_brief_1&quot;)
                                            missionVariables.IR_cherkasova_deadline = null
                                        }
                                        if (choice == 2) {
                                            this._runScreen({
                                                messageKey: &quot;IR_sources_1&quot;,
                                                overlay: &quot;IR_KSR_logo.png&quot;
                                            }) //screen fails to run
                                            mission.setInstructionsKey(&quot;IR_LEXICON_brief_1&quot;)
                                            missionVariables.IR_status = &quot;IR_sources_1&quot;
                                            missionVariables.IR_cherkasova_deadline = null
                                            mission.setInstructionsKey(&quot;IR_LEXICON_brief_1&quot;)
                                            missionVariables.IR_sources_deadline = clock.days + 15
                                        }
                                    });
                            });
                    });
            });
        }

        if (missionVariables.IR_status == &quot;IR_sources_1&quot; &amp;&amp; clock.days &gt; missionVariables.IR_sources_deadline) {
            this._runScreen({
                messageKey: &quot;IR_sources_2&quot;
            });
            missionVariables.IR_status = &quot;IR_sources_2&quot;
            mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
            missionVariables.IR_sources_deadline = clock.days + 7
        }

        if (missionVariables.IR_status == &quot;IR_sources_2&quot; &amp;&amp; clock.days &gt; missionVariables.IR_sources_deadline) {
            this._runScreen({
                messageKey: &quot;IR_sources_3&quot;
            });
            missionVariables.IR_status = &quot;IR_sources_3&quot;
            missionVariables.IR_sources_deadline = null
            mission.setInstructionsKey(&quot;IR_sources_brief_1&quot;)
        }

        if (missionVariables.IR_status == &quot;IR_LOA_4&quot; &amp;&amp; clock.days &gt; missionVariables.IR_attack_deadline) {
            this._runScreen({
                messageKey: &quot;IR_LOA_5&quot;
            });
            missionVariables.IR_status = &quot;IR_LOA_5&quot;
            missionVariables.IR_attack_deadline = null
            mission.setInstructionsKey(&quot;IR_LOA_brief_4&quot;)
        }

        if (missionVariables.IR_status == &quot;IR_LOA_7&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
            this._runScreen({
                messageKey: &quot;IR_LOA_7&quot;
            });
            missionVariables.IR_status = &quot;IR_LOA_8&quot;
            missionVariables.IR_epilogue_deadline = clock.days + 10
        }

        if (missionVariables.IR_status == &quot;IR_LOA_8&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
            this._runScreen({
                messageKey: &quot;IR_LOA_8&quot;
            });
            missionVariables.IR_status = &quot;IR_LOA_9&quot;
            missionVariables.IR_epilogue_deadline = clock.days + 7
        }

        if (missionVariables.IR_status == &quot;IR_LOA_9&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
            this._runScreen({
                messageKey: &quot;IR_invite&quot;
            });
            missionVariables.IR_status = &quot;IR_invite&quot;
            mission.setInstructionsKey(&quot;IR_invite_brief&quot;)
            missionVariables.IR_epilogue_deadline = null
        }

        if (missionVariables.IR_status == &quot;IR_sources_6&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
            this._runScreen({
                messageKey: &quot;IR_sources_6&quot;
            });
            missionVariables.IR_status = &quot;IR_sources_7&quot;
            missionVariables.IR_epilogue_deadline = clock.days + 15
        }

        if (missionVariables.IR_status == &quot;IR_sources_7&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
            this._runScreen({
                messageKey: &quot;IR_invite&quot;
            });
            missionVariables.IR_status = &quot;IR_invite&quot;
            mission.setInstructionsKey(&quot;IR_invite_brief&quot;)
            missionVariables.IR_epilogue_deadline = null
        }

        //Location Specific
        if (system.ID == 7) //Vegedius
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_1&quot;) {
                this._runScreen({
                    title: &quot;GalCop High Command&quot;,
                    messageKey: &quot;IR_IBANEZ_2a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            title: &quot;GalCop High Command&quot;,
                            messageKey: &quot;IR_IBANEZ_2b&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1) {
                                this._runScreen({
                                    title: &quot;GalCop High Command&quot;,
                                    messageKey: &quot;IR_IBANEZ_2c&quot;
                                });
                                missionVariables.IR_status = &quot;IR_IBANEZ_2&quot;
                                mission.setInstructionsKey(&quot;IR_RAAED_INFO&quot;)
                            }
                        });
                });
            }

            if (missionVariables.IR_status == &quot;IR_RAAED_1&quot;) //return to Ibanez
            {
                this._runScreen({
                    title: &quot;Galcop High Command&quot;,
                    messageKey: &quot;IR_IBANEZ_3&quot;
                })
                missionVariables.IR_status = &quot;IR_IBANEZ_3&quot;
                mission.setInstructionsKey(&quot;IR_JANES_INFO&quot;)
            }


            if (missionVariables.IR_status == &quot;IR_JANES_1&quot;) // return to Ibanez for big briefing
            {
                this._runScreen({
                    title: &quot;GalCop High Command&quot;,
                    messageKey: &quot;IR_IBANEZ_4a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            title: &quot;GalCop High Command&quot;,
                            messageKey: &quot;IR_IBANEZ_4b&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1)
                                this._runScreen({
                                    title: &quot;GalCop High Command&quot;,
                                    messageKey: &quot;IR_IBANEZ_4c&quot;,
                                    choicesKey: &quot;IR_continue&quot;
                                }, function (choice) {
                                    if (choice == 1) {
                                        this._runScreen({
                                            title: &quot;GalCop High Command&quot;,
                                            messageKey: &quot;IR_IBANEZ_4d&quot;
                                        });
                                        missionVariables.IR_status = &quot;IR_IBANEZ_4&quot;
                                        mission.setInstructionsKey(null)
                                        this.setupQuestions()
                                        this.setupStatus()
                                        missionVariables.IR_quest_count = 0
                                        this.addIRinterface();
                                    }
                                });
                        });
                });
            }

            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot; &amp;&amp; missionVariables.IR_quest_count == 4) {
                missionVariables.IR_quest_count = null

                if (missionVariables.IR_shipment_quest_method == &quot;YOKOHAMA_AMBUSH&quot;) {
                    this._runScreen({
                        messageKey: &quot;IR_IBANEZ_5a&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this._runScreen({
                                overlay: &quot;IR_title.png&quot;,
                                messageKey: &quot;IR_theend&quot;
                            });
                            missionVariables.IR_status = &quot;IR_completed&quot;
                            mission.setInstructionsKey(null)
                            missionVariables.IR_epilogue_deadline = null
                            missionVariables.IR_shipment_quest = null
                            missionVariables.IR_SDF_quest = null
                            missionVariables.IR_defences_quest = null
                            missionVariables.IR_finance_quest = null
                            missionVariables.IR_shipment_quest_method = null
                        }
                    });
                }

                if (missionVariables.IR_shipment_quest == &quot;FAILED&quot;) {
                    this._runScreen({
                        messageKey: &quot;IR_IBANEZ_5b&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this._runScreen({
                                overlay: &quot;IR_title.png&quot;,
                                messageKey: &quot;IR_theend&quot;
                            });
                            missionVariables.IR_status = &quot;IR_completed&quot;
                            mission.setInstructionsKey(null)
                            missionVariables.IR_epilogue_deadline = null
                            missionVariables.IR_shipment_quest = null
                            missionVariables.IR_SDF_quest = null
                            missionVariables.IR_defences_quest = null
                            missionVariables.IR_finance_quest = null
                            missionVariables.IR_shipment_quest_method = null
                        }
                    });
                } else
                    this._runScreen({
                        title: &quot;GalCop High Command&quot;,
                        messageKey: &quot;IR_IBANEZ_5&quot;,
                        choicesKey: &quot;IR_IBANEZ_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_IBANEZ_A_weiss&quot;) {
                            this._runScreen({
                                title: &quot;GalCop High Command&quot;,
                                messageKey: &quot;IR_weiss_1&quot;
                            });
                            missionVariables.IR_status = &quot;IR_WEISS_1&quot;
                            mission.setInstructionsKey(&quot;IR_weiss_brief_1&quot;)
                        }
                        if (choice == &quot;IR_IBANEZ_B_kinnaird&quot;) {
                            this._runScreen({
                                title: &quot;GalCop High Command&quot;,
                                messageKey: &quot;IR_kinnaird_1&quot;
                            });
                            missionVariables.IR_status = &quot;IR_KINNAIRD_1&quot;
                            mission.setInstructionsKey(&quot;IR_kinnaird_brief_1&quot;)
                        }
                        if (choice == &quot;IR_IBANEZ_C_moreinfo&quot;) {
                            this._runScreen({
                                title: &quot;GalCop High Command&quot;,
                                messageKey: &quot;IR_LEXICON_1&quot;
                            });
                            missionVariables.IR_status = &quot;IR_LEXICON_1&quot;
                            mission.setInstructionsKey(&quot;IR_LEXICON_1&quot;)
                            missionVariables.IR_LEXICON_deadline = clock.days + 15
                        }
                    });
            }

            if (missionVariables.IR_status == &quot;IR_WEISS_4&quot; || missionVariables.IR_status == &quot;IR_KINNAIRD_4&quot;) {
                this._runScreen({
                    title: &quot;Galcop High Command&quot;,
                    messageKey: &quot;IR_IBANEZ_5_debrief&quot;
                })
                missionVariables.IR_status = &quot;IR_IBANEZ_5&quot;
                mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
                missionVariables.IR_cherkasova_deadline = clock.days + 20
            }

            if (missionVariables.IR_status == &quot;IR_invite&quot; &amp;&amp; clock.days &gt; missionVariables.IR_epilogue_deadline) {
                this._runScreen({
                    messageKey: &quot;IR_reward_a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_reward_b&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1)
                                this._runScreen({
                                    messageKey: &quot;IR_reward_c&quot;,
                                    choicesKey: &quot;IR_continue&quot;,
                                    overlay: &quot;IR_maenesmedal.png&quot;
                                }, function (choice) {
                                    if (choice == 1)
                                        this._runScreen({
                                            messageKey: &quot;IR_reward_d&quot;,
                                            choicesKey: &quot;IR_continue&quot;
                                        }, function (choice) {
                                            if (choice == 1) {
                                                this._runScreen({
                                                    messageKey: &quot;IR_reward_e&quot;
                                                });
                                                missionVariables.IR_status = &quot;IR_epilogue&quot;
                                                missionVariables.IR_epilogue_deadline = clock.days + 5
                                                player.credits += 50000
                                                mission.setInstructionsKey(null)
                                            }
                                        });
                                });
                        });
                });
            }
        }

        if (system.ID == 230) // RAAED
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_2&quot;) {
                this._runScreen({
                    messageKey: &quot;IR_RAAED_1a&quot;,
                    overlay: &quot;IR_forest.png&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            overlay: &quot;IR_invoice.png&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1)
                                this._runScreen({
                                    messageKey: &quot;IR_RAAED_1c&quot;,
                                    overlay: &quot;IR_forest.png&quot;,
                                    choicesKey: &quot;IR_continue&quot;
                                }, function (choice) {
                                    if (choice == 1)
                                        this._runScreen({
                                            messageKey: &quot;IR_RAAED_1d&quot;,
                                            choicesKey: &quot;IR_continue&quot;,
                                            overlay: &quot;IR_forest.png&quot;
                                        }, function (choice) {
                                            if (choice == 1) {
                                                this._runScreen({
                                                    messageKey: &quot;IR_RAAED_1e&quot;,
                                                    overlay: &quot;IR_forest.png&quot;
                                                });
                                                missionVariables.IR_status = &quot;IR_RAAED_1&quot;
                                                mission.setInstructionsKey(&quot;IR_IBANEZ_INFO&quot;)
                                            }
                                        });
                                });
                        });
                });
            }
        }

        if (system.ID == 232) // Janes
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_3&quot;) // quick visit to Janes
            {
                this._runScreen({
                    messageKey: &quot;IR_JANES_1a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_JANES_1b&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1) {
                                this._runScreen({
                                    messageKey: &quot;IR_JANES_1c&quot;
                                });
                                missionVariables.IR_status = &quot;IR_JANES_1&quot;
                                mission.setInstructionsKey(&quot;IR_IBANEZ_INFO&quot;)
                            }
                        });
                });
            }

            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;Janes&#39;s Shipyard Intelligence&quot;,
                    overlay: &quot;IR_janes_logo.png&quot;,
                    messageKey: &quot;IR_JANES_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_JANES_QUESTIONS&quot;
            }
        }

        if (system.ID == 171) // Yokohama
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;Yokohama Exports&quot;,
                    overlay: &quot;IR_yk_logo.png&quot;,
                    messageKey: &quot;IR_YOKOHAMA_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_YOKOHAMA_QUESTIONS&quot;
            }
        }

        if (missionVariables.IR_convoy_exited == &quot;TRUE&quot; &amp;&amp; missionVariables.IR_alsto == &quot;HELP_ACCEPTED&quot;) {
            this._runScreen({
                messageKey: &quot;IR_shipment_contact_report&quot;
            });
            player.incrementShipmentStatus()
            missionVariables.IR_alsto = &quot;INFORMED&quot;
            missionVariables.IR_convoy_exited = null
        }

        if (system.ID == 240) // Pirate Cove
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;)

            {
                if (!missionVariables.IR_alsto) {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_intro&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
                    missionVariables.IR_alsto = &quot;MET&quot;
                } else {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_intro_alt&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
                }
            }

            if (missionVariables.IR_status == &quot;IR_LOA_1&quot;) {
                if (missionVariables.IR_alsto)
                    missionVariables.IR_LOA_text = &quot;known&quot;
                if (missionVariables.IR_alsto == &quot;INFORMED&quot;)
                    missionVariables.IR_LOA_text = &quot;helped&quot;
                if (!missionVariables.IR_alsto)
                    missionVariables.IR_LOA_text = &quot;unknown&quot;

                this._runScreen({
                    messageKey: &quot;IR_LOA_&quot; + [missionVariables.IR_LOA_text] + &quot;_2a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_LOA_&quot; + [missionVariables.IR_LOA_text] + &quot;_2b&quot;,
                            choicesKey: &quot;IR_continue&quot;
                        }, function (choice) {
                            if (choice == 1)
                                this._runScreen({
                                    messageKey: &quot;IR_LOA_2c&quot;,
                                    choicesKey: &quot;IR_continue&quot;
                                }, function (choice) {
                                    if (choice == 1) {
                                        this._runScreen({
                                            messageKey: &quot;IR_LOA_2d&quot;
                                        })
                                        missionVariables.IR_status = &quot;IR_LOA_2&quot;
                                        mission.setInstructionsKey(&quot;IR_LOA_brief_2&quot;)
                                        missionVariables.IR_alsto = null
                                        missionVariables.IR_LOA_text = null
                                    }
                                });
                        });
                });
            }
        }

        if (system.ID == 119) // PleasureWorld
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;PleasureWorld&quot;,
                    overlay: &quot;IR_pw_logo.png&quot;,
                    messageKey: &quot;IR_PW_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_PW_QUESTIONS&quot;
            }

            if (missionVariables.IR_status == &quot;IR_WEISS_3&quot;) {
                this._runScreen({
                    title: &quot;PleasureWord&quot;,
                    overlay: &quot;IR_pw_logo.png&quot;,
                    messageKey: &quot;IR_weiss_3a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            overlay: &quot;IR_pw_logo.png&quot;,
                            messageKey: &quot;IR_weiss_3b&quot;
                        })
                    missionVariables.IR_status = &quot;IR_WEISS_4&quot;
                    mission.setInstructionsKey(&quot;IR_weiss_brief_3&quot;)
                });
            }

            if (missionVariables.IR_status == &quot;IR_KINNAIRD_3&quot;) {
                this._runScreen({
                    title: &quot;PleasureWord&quot;,
                    overlay: &quot;IR_pw_logo.png&quot;,
                    messageKey: &quot;IR_kinnaird_4a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_kinnaird_4b&quot;
                        })
                    missionVariables.IR_status = &quot;IR_KINNAIRD_4&quot;
                    mission.setInstructionsKey(&quot;IR_kinnaird_brief_4&quot;)
                });
            }

            if (missionVariables.IR_status == &quot;IR_LEXICON_2&quot;) {
                this._runScreen({
                    messageKey: &quot;IR_LEXICON_3a&quot;,
                    overlay: &quot;IR_nightclub.png&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_LEXICON_3b&quot;,
                            overlay: &quot;IR_nightclub.png&quot;,
                            choicesKey: &quot;IR_launch_choice&quot;
                        }, function (choice) {
                            if (choice == 1) {
                                missionVariables.IR_status = &quot;IR_LEXICON_4&quot;
                                player.ship.launch()
                            }
                        });
                });
            }

            if (missionVariables.IR_status == &quot;IR_weiss_scooped&quot;) {
                this._runScreen({
                    messageKey: &quot;IR_LEXICON_4a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1)
                        this._runScreen({
                            messageKey: &quot;IR_LEXICON_4b&quot;
                        })
                    missionVariables.IR_status = &quot;IR_IBANEZ_5&quot;
                    mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
                    missionVariables.IR_cherkasova_deadline = clock.days + 20
                });
            }
        }

        if (system.ID == 180) // NWE
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;Naval Weapons Establishment&quot;,
                    overlay: &quot;IR_NWE_logo.png&quot;,
                    messageKey: &quot;IR_NWE_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_NWE_QUESTIONS&quot;
            }

            if (missionVariables.IR_defences_quest == &quot;DEMO_2&quot;) {
                this._runScreen({
                    title: &quot;Naval Weapons Establishment&quot;,
                    overlay: &quot;IR_NWE_logo.png&quot;,
                    messageKey: &quot;IR_defences_quest_2a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            title: &quot;Naval Weapons Establishment&quot;,
                            overlay: &quot;IR_NWE_logo.png&quot;,
                            messageKey: &quot;IR_defences_quest_2b&quot;
                        });
                        missionVariables.IR_defences_quest_deadline = clock.days + 7
                        missionVariables.IR_defences_quest = &quot;DEMO_3&quot;
                        player.incrementDefencesStatus()
                    }
                });
            }

            if (missionVariables.IR_defences_quest == &quot;DEMO_3&quot; &amp;&amp; clock.days &gt; missionVariables.IR_defences_quest_deadline) {
                this._runScreen({
                    title: &quot;Naval Weapons Establishment&quot;,
                    overlay: &quot;IR_NWE_logo.png&quot;,
                    messageKey: &quot;IR_defences_quest_3&quot;
                });
                missionVariables.IR_defences_quest_deadline = null
                missionVariables.IR_defences_quest = &quot;DEMO_4&quot;
                player.incrementDefencesStatus()
            }
        }

        if (system.ID == 82) // Inorle
        {
            if (missionVariables.IR_SDF_quest == &quot;JACOB&quot;) {
                this._runScreen({
                    messageKey: &quot;IR_SDF_quest_3&quot;
                })
                missionVariables.IR_SDF_quest = &quot;LUFTSLOTTE&quot;
            }
        }

        if (system.ID == 219) // GSE
        {
            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;Galactic Stock Exchange&quot;,
                    overlay: &quot;IR_GSE_logo.png&quot;,
                    messageKey: &quot;IR_GSE_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
            }


            if (missionVariables.IR_finance_quest == &quot;JANES_NEWS&quot;) {
                this._runScreen({
                    title: &quot;Galactic Stock Exchange&quot;,
                    overlay: &quot;IR_GSE_logo.png&quot;,
                    messageKey: &quot;IR_finance_quest_6a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            title: &quot;Galactic Stock Exchange&quot;,
                            overlay: &quot;IR_GSE_logo.png&quot;,
                            messageKey: &quot;IR_finance_quest_6b&quot;
                        });
                        player.incrementFinanceStatus()
                        missionVariables.IR_offer = null
                        missionVariables.IR_finance_quest = &quot;WIFE&quot;
                    }
                });
            }

            if (missionVariables.IR_finance_quest == &quot;WIFE_MET&quot;) {
                this._runScreen({
                    title: &quot;Galactic Stock Exchange&quot;,
                    overlay: &quot;IR_GSE_logo.png&quot;,
                    messageKey: &quot;IR_finance_quest_8&quot;,
                    choicesKey: &quot;IR_wife_choices&quot;
                }, function (choice) {
                    if (choice == &quot;IR_wife_yes&quot;) {
                        this._runScreen({
                            title: &quot;Galactic Stock Exchange&quot;,
                            overlay: &quot;IR_GSE_logo.png&quot;,
                            messageKey: &quot;IR_finance_quest_9_confirm&quot;
                        });
                        missionVariables.IR_wife_status = &quot;AFFAIR_CONFIRMED&quot;
                    }

                    if (choice == &quot;IR_wife_no&quot;) {
                        this._runScreen({
                            title: &quot;Galactic Stock Exchange&quot;,
                            overlay: &quot;IR_GSE_logo.png&quot;,
                            messageKey: &quot;IR_finance_quest_9_deny&quot;
                        });
                        missionVariables.IR_wife_status = &quot;AFFAIR_DENIED&quot;
                    }

                    player.incrementFinanceStatus()
                    missionVariables.IR_finance_quest = &quot;WAIT3&quot;
                    missionVariables.IR_KORSHKOV_deadline = clock.days + 10
                    missionVariables.IR_offer = null
                });
            }
        }

        if (system.ID == 31) // KORSHKOV
        {
            if (missionVariables.IR_finance_quest == &quot;WAIT&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_KORSHKOV_deadline) {
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_finance_quest_1&quot;
                });
                player.incrementFinanceStatus()
                missionVariables.IR_finance_quest = &quot;COLLECTION&quot;
                missionVariables.IR_KORSHKOV_deadline = null
                return;
            }

            if (missionVariables.IR_finance_quest == &quot;COLLECTION&quot;) {
                this.checkManifest()

                if (missionVariables.IR_manifestOK == &quot;TRUE&quot;) {
                    this._runScreen({
                        title: &quot;OKB Korshkov&quot;,
                        overlay: &quot;IR_korshlogo.png&quot;,
                        messageKey: &quot;IR_finance_quest_2&quot;
                    });
                    player.incrementFinanceStatus()
                    missionVariables.IR_KORSHKOV_deadline = clock.days + 10
                    missionVariables.IR_finance_quest = &quot;WAIT2&quot;
                    player.ship.manifest.radioactives -= 10
                    player.ship.manifest.alloys = -5
                    player.ship.manifest.minerals -= 2
                    player.ship.manifest.alienItems -= 2
                    player.ship.manifest.platinum -= 1
                    missionVariables.IR_manifestOK = null
                    return;
                }

                if (missionVariables.IR_manifestOK != &quot;TRUE&quot;)
                    this._runScreen({
                        title: &quot;OKB Korshkov&quot;,
                        overlay: &quot;IR_korshlogo.png&quot;,
                        messageKey: &quot;IR_finance_quest_3alt&quot;
                    });
                else return;
            }

            if (missionVariables.IR_finance_quest == &quot;WAIT2&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_KORSHKOV_deadline) {
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_finance_quest_3&quot;
                });
                player.incrementFinanceStatus()
                missionVariables.IR_KORSHKOV_deadline = null
                missionVariables.IR_finance_quest = &quot;IRRADIATE&quot;
                return;
            }

            if (missionVariables.IR_SDF_quest == &quot;KORSHKOV&quot;) {
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_SDF_quest_6&quot;
                });
                player.incrementSDFStatus()
                missionVariables.IR_SDF_deadline = clock.days + 10
                missionVariables.IR_SDF_quest = &quot;ANALYSIS&quot;
                player.ship.removeAllCargo()
                missionVariables.IR_cargoCount = null
                return;
            }

            if (missionVariables.IR_SDF_quest == &quot;ANALYSIS&quot; &amp;&amp; clock.days &gt;= missionVariables.IR_SDF_deadline)

            {
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_SDF_quest_7a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            messageKey: &quot;IR_SDF_quest_7b&quot;
                        });
                        missionVariables.IR_SDF_quest = &quot;DATA&quot;
                        player.incrementSDFStatus()
                        this.incrementSDFQuestion()
                        missionVariables.IR_SDF_location = null
                        missionVariables.IR_SDF_location_name = null
                    }
                });
                return;
            }

            if (missionVariables.IR_status == &quot;IR_IBANEZ_4&quot;) {
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_KORSHKOV_intro&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                missionVariables.IR_offer = &quot;IR_KORSHKOV_QUESTIONS&quot;
                return;
            }
        }

        if (system.ID == 142) // Tibiri bar
        {
            if (missionVariables.IR_finance_quest == &quot;WIFE_DOCKED&quot;) {
                this._runScreen({
                    messageKey: &quot;IR_finance_quest_7a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            messageKey: &quot;IR_finance_quest_7b&quot;
                        });
                        player.incrementFinanceStatus()
                        player.credits += 1000
                        missionVariables.IR_offer = null
                        missionVariables.IR_finance_quest = &quot;WIFE_MET&quot;
                    }
                });
            }
            if (missionVariables.IR_finance_quest == &quot;WIFE&quot; || missionVariables.IR_finance_quest == &quot;WIFE_IDENTIFIED&quot;)
                this._runScreen({
                    messageKey: &quot;IR_finance_quest_7alt&quot;
                });
        }

        if (system.ID == 23) // Maenes
        {
            if (missionVariables.IR_defences_question_no == 3 &amp;&amp; !missionVariables.IR_defences_quest) {
                if (!missionVariables.IR_Maenes_visit) {
                    this._runScreen({
                        title: &quot;QuiCo Pharmaceuticals&quot;,
                        overlay: &quot;IR_quico_logo.png&quot;,
                        messageKey: &quot;IR_defences_quest_1_alt&quot;
                    });
                    missionVariables.IR_defences_quest = &quot;DEMO_1&quot;
                }
                if (missionVariables.IR_Maenes_visit == &quot;TRUE&quot;) {
                    this._runScreen({
                        title: &quot;QuiCo Pharmaceuticals&quot;,
                        overlay: &quot;IR_quico_logo.png&quot;,
                        messageKey: &quot;IR_defences_quest_1&quot;
                    });
                    missionVariables.IR_defences_quest = &quot;DEMO_1&quot;
                    missionVariables.IR_Maenes_visit = null
                }

            }
            if (missionVariables.IR_defences_quest == &quot;DEMO_4&quot;) {
                this._runScreen({
                    title: &quot;QuiCo Pharmaceuticals&quot;,
                    overlay: &quot;IR_quico_logo.png&quot;,
                    messageKey: &quot;IR_defences_quest_4&quot;
                });
                missionVariables.IR_defences_quest = &quot;DEMO_5&quot;
            }

            if (missionVariables.IR_defences_quest == &quot;SABOTAGED&quot;) {
                this._runScreen({
                    title: &quot;QuiCo Pharmaceuticals&quot;,
                    overlay: &quot;IR_quico_logo.png&quot;,
                    messageKey: &quot;IR_defences_quest_5a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            messageKey: &quot;IR_defences_quest_5b&quot;
                        });
                        player.incrementDefencesStatus()
                        missionVariables.IR_defences_quest = &quot;DEMO_6&quot;
                        missionVariables.IR_defences_quest_deadline = clock.days + 15
                    }
                });
            }

            if (missionVariables.IR_status == &quot;IR_sources_5&quot;) {
                this._runScreen({
                    title: &quot;QuiCo Pharmaceuticals&quot;,
                    overlay: &quot;IR_quico_logo.png&quot;,
                    messageKey: &quot;IR_sources_5a&quot;,
                    choicesKey: &quot;IR_continue&quot;
                }, function (choice) {
                    if (choice == 1) {
                        this._runScreen({
                            messageKey: &quot;IR_sources_5b&quot;
                        });
                        mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
                        missionVariables.IR_status = &quot;IR_sources_6&quot;
                        missionVariables.IR_epilogue_deadline = clock.days + 10
                    }
                });
            }

            if (missionVariables.IR_status == &quot;IR_LOA_6&quot;) {
                this._runScreen({
                    title: &quot;QuiCo Pharmaceuticals&quot;,
                    overlay: &quot;IR_quico_logo.png&quot;,
                    messageKey: &quot;IR_LOA_6&quot;
                });
                mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
                missionVariables.IR_status = &quot;IR_LOA_7&quot;
                missionVariables.IR_epilogue_deadline = clock.days + 10
            }
        }

        if (system.ID == 35 &amp;&amp; missionVariables.IR_status == &quot;IR_KINNAIRD_1&quot;) //Atanon
        {
            this._runScreen({
                messageKey: &quot;IR_kinnaird_2&quot;
            });
            missionVariables.IR_status = &quot;IR_KINNAIRD_2&quot;
        }

        if (system.ID == 41 &amp;&amp; missionVariables.IR_status == &quot;IR_KINNAIRD_2&quot;) //Orlaroor
        {
            this._runScreen({
                messageKey: &quot;IR_kinnaird_3&quot;
            });
            missionVariables.IR_status = &quot;IR_KINNAIRD_3&quot;
            mission.setInstructionsKey(&quot;IR_kinnaird_brief_3&quot;)
        }

        if (system.ID == 149 &amp;&amp; missionVariables.IR_status == &quot;IR_LOA_3&quot;) //Arenxeon
        {
            this._runScreen({
                messageKey: &quot;IR_LOA_4a&quot;,
                choicesKey: &quot;IR_continue&quot;
            }, function (choice) {
                if (choice == 1) {
                    this._runScreen({
                        messageKey: &quot;IR_LOA_4b&quot;
                    });
                    missionVariables.IR_status = &quot;IR_LOA_4&quot;
                    missionVariables.IR_attack_deadline = clock.days + 10
                    mission.setInstructionsKey(&quot;IR_waitforinfo_brief&quot;)
                }
            });
        }

        if (system.ID == 63 &amp;&amp; missionVariables.IR_status == &quot;IR_sources_3&quot;) //Edsoan
        {
            this._runScreen({
                messageKey: &quot;IR_sources_4a&quot;,
                choicesKey: &quot;IR_continue&quot;
            }, function (choice) {
                if (choice == 1) {
                    this._runScreen({
                        messageKey: &quot;IR_sources_4b&quot;
                    });
                    missionVariables.IR_status = &quot;IR_sources_4&quot;
                    mission.setInstructionsKey(&quot;IR_sources_brief_2&quot;)
                }
            });
        }
        //keep brackets	
    }
}

this.choiceEvaluation = function (choice) {
    switch (missionVariables.IR_offer) {
        case &quot;IR_GSE_QUESTIONS&quot;: {
            if (choice == &quot;IR_B_finance_question_key&quot;) {
                if (missionVariables.IR_finance_question_no == 1) {
                    this._runScreen({
                        title: &quot;Galactic Stock Exchange&quot;,
                        overlay: &quot;IR_GSE_logo.png&quot;,
                        messageKey: &quot;IR_GSE_finance_answer_1a&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this.incrementFinanceQuestion()
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_finance_answer_1b&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                        }
                    });
                    break;
                }

                if (missionVariables.IR_finance_question_no &gt; 1) {
                    missionVariables.IR_asked_question = missionVariables.IR_finance_question_string
                    this._runScreen({
                        title: &quot;Galactic Stock Exchange&quot;,
                        overlay: &quot;IR_GSE_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }

            if (choice == &quot;IR_A_shipment_question_key&quot;) {
                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; !missionVariables.IR_GSE_loan) {
                    this._runScreen({
                        title: &quot;Galactic Stock Exchange&quot;,
                        overlay: &quot;IR_GSE_logo.png&quot;,
                        messageKey: &quot;IR_GSE_loan_offer&quot;,
                        choicesKey: &quot;IR_loan_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_loan_yes&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_agreed&quot;
                            });
                            missionVariables.IR_GSE_loan = &quot;ACCEPTED&quot;
                            player.credits += 500000
                            missionVariables.IR_loan_deadline = clock.days + 60
                            missionVariables.IR_loan_remaining = missionVariables.IR_loan_deadline - clock.days
                            mission.setInstructionsKey(&quot;IR_loan_amount&quot;)
                            missionVariables.IR_offer = null
                        }
                        if (choice == &quot;IR_loan_no&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_rejected&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = null
                            missionVariables.IR_GSE_loan = &quot;REJECTED&quot;
                        }
                        if (choice == &quot;IR_loan_defer&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_deferred&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                            missionVariables.IR_GSE_loan = &quot;DEFERRED&quot;
                        }
                    });
                    break;
                }

                if (missionVariables.IR_GSE_loan == &quot;DEFERRED&quot;) {
                    this._runScreen({
                        title: &quot;Galactic Stock Exchange&quot;,
                        overlay: &quot;IR_GSE_logo.png&quot;,
                        messageKey: &quot;IR_GSE_loan_repeat_offer&quot;,
                        choicesKey: &quot;IR_loan_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_loan_yes&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_agreed&quot;
                            });
                            missionVariables.IR_GSE_loan = &quot;ACCEPTED&quot;
                            player.credits += 500000
                            missionVariables.IR_loan_deadline = clock.days + 60
                            missionVariables.IR_loan_remaining = missionVariables.IR_loan_deadline - clock.days
                            mission.setInstructionsKey(&quot;IR_loan_amount&quot;)
                            missionVariables.IR_offer = null
                        }
                        if (choice == &quot;IR_loan_no&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_rejected&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                            missionVariables.IR_GSE_loan = &quot;REJECTED&quot;
                        }
                        if (choice == &quot;IR_loan_defer&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_loan_deferred&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                            missionVariables.IR_GSE_loan = &quot;DEFERRED&quot;
                        }
                    });
                    break;
                }

                if (missionVariables.IR_GSE_loan == &quot;ACCEPTED&quot;) {
                    this._runScreen({
                        title: &quot;Galactic Stock Exchange&quot;,
                        overlay: &quot;IR_GSE_logo.png&quot;,
                        messageKey: &quot;IR_GSE_loan_demand&quot;,
                        choicesKey: &quot;IR_pay_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_pay_yes&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_pay_accepted&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_GSE_loan = &quot;PAID&quot;
                            player.credits -= 550000
                            missionVariables.IR_loan_deadline = null
                            missionVariables.IR_loan_remaining = null
                            mission.setInstructionsKey(null)
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                        }
                        if (choice == &quot;IR_pay_no&quot;) {
                            this._runScreen({
                                title: &quot;Galactic Stock Exchange&quot;,
                                overlay: &quot;IR_GSE_logo.png&quot;,
                                messageKey: &quot;IR_GSE_pay_deferred&quot;,
                                choicesKey: &quot;IR_questions&quot;
                            }, this.choiceEvaluation);
                            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
                        }
                    });
                    break;
                }
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot;Galactic Stock Exchange&quot;,
                    overlay: &quot;IR_GSE_logo.png&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_GSE_QUESTIONS&quot;
            break;
        }

        case &quot;IR_KORSHKOV_QUESTIONS&quot;: {
            if (choice == &quot;IR_B_finance_question_key&quot;) {
                if (missionVariables.IR_finance_question_no == 2) {
                    this._runScreen({
                        title: &quot;OKB Korshkov&quot;,
                        overlay: &quot;IR_korshlogo.png&quot;,
                        messageKey: &quot;IR_KORSHKOV_finance_answer_1a&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this.incrementFinanceQuestion()
                            this._runScreen({
                                title: &quot;OKB Korshkov&quot;,
                                overlay: &quot;IR_korshlogo.png&quot;,
                                messageKey: &quot;IR_KORSHKOV_finance_answer_1b&quot;
                            });
                            missionVariables.IR_offer = &quot;IR_KORSHKOV_QUESTIONS&quot;
                            missionVariables.IR_KORSHKOV_deadline = clock.days + 5
                            player.incrementFinanceStatus()
                            missionVariables.IR_offer = null
                            missionVariables.IR_finance_quest = &quot;WAIT&quot;
                        }
                    });
                    break;
                }

                if (missionVariables.IR_finance_question_no &gt; 2) {
                    missionVariables.IR_asked_question = missionVariables.IR_finance_question_string
                    this._runScreen({
                        title: &quot;OKB Korshkov&quot;,
                        overlay: &quot;IR_korshlogo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }


            if (choice == &quot;IR_E_exit_question_key&quot;) {
                return;
            } else
                this._runScreen({
                    title: &quot;OKB Korshkov&quot;,
                    overlay: &quot;IR_korshlogo.png&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_KORSHKOV_QUESTIONS&quot;
            break;
        }

        case &quot;IR_JANES_QUESTIONS&quot;: {
            if (choice == &quot;IR_A_shipment_question_key&quot;) {
                this._runScreen({
                    title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                    overlay: &quot;IR_janes_logo.png&quot;,
                    messageKey: &quot;IR_no_more_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                break;
            }

            if (choice == &quot;IR_C_SDF_question_key&quot;) {
                if (missionVariables.IR_SDF_question_no == 1) {
                    this.incrementSDFQuestion()
                    this._runScreen({
                        title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                        overlay: &quot;IR_janes_logo.png&quot;,
                        messageKey: &quot;IR_JANES_SDF_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }

                if (missionVariables.IR_SDF_question_no &gt; 1) {
                    this._runScreen({
                        title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                        overlay: &quot;IR_janes_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }

            if (choice == &quot;IR_D_defences_question_key&quot;) {
                this._runScreen({
                    title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                    overlay: &quot;IR_janes_logo.png&quot;,
                    messageKey: &quot;IR_JANES_defences_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
                break;
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot;Jane&#39;s Shipyard Intelligence&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_JANES_QUESTIONS&quot;
            break;
        }

        case &quot;IR_PIRATE_QUESTIONS&quot;: {
            if (choice == &quot;IR_A_shipment_question_key&quot;) {
                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; missionVariables.IR_shipment_quest == &quot;SET&quot;) {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_shipment_answer&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1)
                            this._runScreen({
                                title: &quot; &quot;,
                                messageKey: &quot;IR_PIRATE_shipment_offer&quot;,
                                choicesKey: &quot;IR_pirate_choices&quot;
                            }, function (choice) {
                                if (choice == &quot;IR_pirate_yes&quot;) {
                                    this._runScreen({
                                        title: &quot; &quot;,
                                        messageKey: &quot;IR_PIRATE_shipment_accepted&quot;
                                    });
                                    missionVariables.IR_alsto = &quot;HELP_ACCEPTED&quot;
                                    player.credits -= 250000
                                    player.incrementShipmentStatus()
                                    missionVariables.IR_offer = null
                                }
                                if (choice == &quot;IR_pirate_no&quot;) {
                                    this._runScreen({
                                        title: &quot; &quot;,
                                        messageKey: &quot;IR_PIRATE_shipment_declined&quot;
                                    });
                                    missionVariables.IR_offer = null
                                    missionVariables.IR_alsto = &quot;HELP_DECLINED&quot;
                                }
                            });
                    });
                    break;
                }

                if (missionVariables.IR_shipment_question_no == 1) {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_negative_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
                    break;
                }

                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; missionVariables.IR_alsto == &quot;HELP_ACCEPTED&quot;)
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_shipment_confirm_help&quot;
                    });


                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; missionVariables.IR_alsto == &quot;HELP_DECLINED&quot;) {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_shipment_deferred_help&quot;,
                        choicesKey: &quot;IR_pirate_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_pirate_yes&quot;) {
                            this._runScreen({
                                title: &quot; &quot;,
                                messageKey: &quot;IR_PIRATE_shipment_accepted&quot;
                            });
                            missionVariables.IR_alsto = &quot;HELP_ACCEPTED&quot;
                            player.credits -= 250000
                            player.incrementShipmentStatus()
                            missionVariables.IR_offer = null
                        }
                        if (choice == &quot;IR_pirate_no&quot;) {
                            this._runScreen({
                                title: &quot; &quot;,
                                messageKey: &quot;IR_PIRATE_shipment_declined&quot;
                            });
                            missionVariables.IR_offer = null
                            missionVariables.IR_alsto = &quot;HELP_DECLINED&quot;
                        }

                    });

                    if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; missionVariables.IR_shipment_quest != &quot;SET&quot;) {
                        missionVariables.IR_asked_question = missionVariables.IR_shipment_question_string
                        this._runScreen({
                            title: &quot; &quot;,
                            messageKey: &quot;IR_no_more_answer&quot;,
                            choicesKey: &quot;IR_questions&quot;
                        }, this.choiceEvaluation);
                        break;
                    }
                }
            }

            if (choice == &quot;IR_C_SDF_question_key&quot;) {
                if (missionVariables.IR_SDF_question_no &lt; 2)
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_SDF_answer_1&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);

                if (missionVariables.IR_SDF_question_no == 2)
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_PIRATE_SDF_answer_2&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);

                if (missionVariables.IR_SDF_question_no &gt; 2) {
                    this._runScreen({
                        title: &quot; &quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                }
                break;
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot; &quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_PIRATE_QUESTIONS&quot;
            break;
        }

        case &quot;IR_YOKOHAMA_QUESTIONS&quot;: {
            if (choice == &quot;IR_A_shipment_question_key&quot;) {
                if (missionVariables.IR_shipment_question_no == 1) {
                    this.incrementShipmentQuestion()
                    this._runScreen({
                        title: &quot;Yokohama Exports&quot;,
                        overlay: &quot;IR_yk_logo.png&quot;,
                        messageKey: &quot;IR_YOKOHAMA_shipment_answer_1&quot;
                    });
                    missionVariables.IR_YOKOHAMA_deadline = clock.days + 30
                    missionVariables.IR_shipment_quest = &quot;SET&quot;
                    missionVariables.IR_offer = null
                    player.incrementShipmentStatus()
                    break;
                }

                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; clock.days &lt; missionVariables.IR_YOKOHAMA_deadline) {
                    this._runScreen({
                        title: &quot;Yokohama Exports&quot;,
                        overlay: &quot;IR_yk_logo.png&quot;,
                        messageKey: &quot;IR_YOKOHAMA_shipment_answer_2&quot;,
                        choicesKey: &quot;IR_YOKOHAMA_choices&quot;
                    }, function (choice) {
                        if (choice == &quot;IR_YOKOHAMA_yes&quot;) {
                            if (player.credits &gt;= 1000000) {
                                this._runScreen({
                                    title: &quot;Yokohama Exports&quot;,
                                    overlay: &quot;IR_yk_logo.png&quot;,
                                    messageKey: &quot;IR_YOKOHAMA_shipment_agreed&quot;
                                });
                                missionVariables.IR_shipment_quest = &quot;SUCCESS&quot;
                                missionVariables.IR_shipment_quest_method = &quot;PURCHASED&quot;
                                missionVariables.IR_YOKOHAMA_deadline = null
                                    ++missionVariables.IR_quest_count
                                this.incrementShipmentQuestion()
                                player.clearShipmentStatus()
                                missionVariables.IR_offer = null
                                player.credits -= 1000000
                            } else {
                                this._runScreen({
                                    title: &quot;Yokohama Exports&quot;,
                                    overlay: &quot;IR_yk_logo.png&quot;,
                                    messageKey: &quot;IR_YOKOHAMA_shipment_nomoney&quot;
                                });
                                missionVariables.IR_offer = null
                            }
                        }

                        if (choice == &quot;IR_YOKOHAMA_no&quot;) {
                            this._runScreen({
                                title: &quot;Yokohama Exports&quot;,
                                overlay: &quot;IR_yk_logo.png&quot;,
                                messageKey: &quot;IR_YOKOHAMA_shipment_declined&quot;
                            });
                            missionVariables.IR_shipment_quest = &quot;ENROUTE&quot;
                            this.incrementShipmentQuestion()
                            missionVariables.IR_offer = null
                            if (missionVariables.IR_alsto) {
                                player.incrementShipmentStatus()
                            }
                        }

                        if (choice == &quot;IR_YOKOHAMA_defer&quot;) {
                            this._runScreen({
                                title: &quot;Yokohama Exports&quot;,
                                overlay: &quot;IR_yk_logo.png&quot;,
                                messageKey: &quot;IR_YOKOHAMA_shipment_defer&quot;
                            });
                            missionVariables.IR_offer = null
                        }
                    });
                    break;
                }

                if (missionVariables.IR_shipment_question_no == 2 &amp;&amp; clock.days &gt; missionVariables.IR_YOKOHAMA_deadline) {
                    this._runScreen({
                        title: &quot;Yokohama Exports&quot;,
                        overlay: &quot;IR_yk_logo.png&quot;,
                        messageKey: &quot;IR_YOKOHAMA_shipment_toolate&quot;
                    });
                    missionVariables.IR_shipment_quest = &quot;DISPATCHED&quot;
                    player.clearShipmentStatus()
                    missionVariables.IR_offer = null
                    break;
                }

                if (missionVariables.IR_shipment_question_no &gt; 2) {
                    missionVariables.IR_asked_question = missionVariables.IR_shipment_question_string
                    this._runScreen({
                        title: &quot;Yokohama Exports&quot;,
                        overlay: &quot;IR_yk_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot;Yokohama Exports&quot;,
                    overlay: &quot;IR_yk_logo.png&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_YOKOHAMA_QUESTIONS&quot;
            break;
        }

        case &quot;IR_PW_QUESTIONS&quot;: {
            if (choice == &quot;IR_C_SDF_question_key&quot;) {
                if (missionVariables.IR_SDF_question_no == 2) {
                    this._runScreen({
                        title: &quot;PleasureWorld&quot;,
                        overlay: &quot;IR_pw_logo.png&quot;,
                        messageKey: &quot;IR_PW_SDF_answer_1&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this.incrementSDFQuestion()
                            this._runScreen({
                                title: &quot; &quot;,
                                messageKey: &quot;IR_SDF_quest_1&quot;
                            });
                            missionVariables.IR_SDF_quest = &quot;ADDRESS&quot;
                            missionVariables.IR_SDF_deadline = clock.days + 10
                        }
                    });
                    break;
                }

                if (missionVariables.IR_SDF_question_no == 3) {
                    this._runScreen({
                        title: &quot;PleasureWorld&quot;,
                        overlay: &quot;IR_pw_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }

                if (missionVariables.IR_SDF_question_no == 5) {
                    this._runScreen({
                        title: &quot;PleasureWorld&quot;,
                        overlay: &quot;IR_devries.png&quot;,
                        messageKey: &quot;IR_PW_SDF_answer_2&quot;
                    });
                    this.incrementSDFQuestion()
                    missionVariables.IR_SDF_quest = &quot;PHOTO&quot;
                    missionVariables.IR_SDF_deadline = clock.days + 35
                } else {
                    this._runScreen({
                        title: &quot;PleasureWorld&quot;,
                        overlay: &quot;IR_pw_logo.png&quot;,
                        messageKey: &quot;IR_negative_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                }
                break;
            }

            if (choice == &quot;IR_E_exit_question_key&quot;) {
                missionVariables.IR_offer = &quot;IR_ASKED&quot;
                return;
            } else
                this._runScreen({
                    title: &quot;PleasureWorld&quot;,
                    overlay: &quot;IR_pw_logo.png&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_PW_QUESTIONS&quot;
            break;
        }

        case &quot;IR_NWE_QUESTIONS&quot;: {
            if (choice == &quot;IR_C_SDF_question_key&quot;) {
                if (missionVariables.IR_SDF_question_no == 4) {
                    this._runScreen({
                        title: &quot;Naval Weapons Establishment&quot;,
                        overlay: &quot;IR_NWE_logo.png&quot;,
                        messageKey: &quot;IR_NWE_SDF_answer_1a&quot;,
                        choicesKey: &quot;IR_continue&quot;
                    }, function (choice) {
                        if (choice == 1) {
                            this.incrementSDFQuestion()
                            this._runScreen({
                                title: &quot; &quot;,
                                overlay: &quot;IR_NWE_logo.png&quot;,
                                messageKey: &quot;IR_NWE_SDF_answer_1b&quot;
                            });
                        }
                        missionVariables.IR_offer = null
                    });
                }

                if (missionVariables.IR_SDF_question_no &lt; 4 || missionVariables.IR_SDF_question_no &gt; 4) {
                    this._runScreen({
                        title: &quot;Naval Weapons Establishment&quot;,
                        overlay: &quot;IR_NWE_logo.png&quot;,
                        messageKey: &quot;IR_negative_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                }
                break;
            }

            if (choice == &quot;IR_D_defences_question_key&quot;) {
                if (missionVariables.IR_defences_question_no &lt; 3) {
                    this._runScreen({
                        title: &quot;Naval Weapons Establishment&quot;,
                        overlay: &quot;IR_NWE_logo.png&quot;,
                        messageKey: &quot;IR_NWE_defences_answer_1&quot;
                    });
                    missionVariables.IR_defences_question_no = 3
                    missionVariables.IR_offer = null
                    player.incrementDefencesStatus()
                    break;
                }

                if (missionVariables.IR_defences_question_no == 3) {
                    this._runScreen({
                        title: &quot;Naval Weapons Establishment&quot;,
                        overlay: &quot;IR_NWE_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot;Naval Weapons Establishment&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_NWE_QUESTIONS&quot;
            break;
        }

        case &quot;IR_MAENES_QUESTIONS&quot;: {
            if (choice == &quot;IR_D_defences_question_key&quot;) {
                if (missionVariables.IR_defences_question_no == 1) {
                    this._runScreen({
                        title: &quot;QuiCo Pharmaceuticals&quot;,
                        overlay: &quot;IR_quico_logo.png&quot;,
                        messageKey: &quot;IR_MAENES_defences_answer_1&quot;
                    });
                    this.incrementDefencesQuestion()
                    missionVariables.IR_offer = null
                    missionVariables.IR_Maenes_visit = &quot;TRUE&quot;
                    break;
                }

                if (missionVariables.IR_defences_question_no &gt;= 2) {
                    this._runScreen({
                        title: &quot;QuiCo Pharmaceuticals&quot;,
                        overlay: &quot;IR_quico_logo.png&quot;,
                        messageKey: &quot;IR_no_more_answer&quot;,
                        choicesKey: &quot;IR_questions&quot;
                    }, this.choiceEvaluation);
                    break;
                }
            }

            if (choice == &quot;IR_E_exit_question_key&quot;)
                return;
            else
                this._runScreen({
                    title: &quot;QuiCo Pharmaceuticals&quot;,
                    overlay: &quot;IR_quico_logo.png&quot;,
                    messageKey: &quot;IR_negative_answer&quot;,
                    choicesKey: &quot;IR_questions&quot;
                }, this.choiceEvaluation);
            missionVariables.IR_offer = &quot;IR_MAENES_QUESTIONS&quot;
            break;
        }
    }
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/xenonreduxui_coremissionfixes.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name = &quot;XenonReduxUI_CoreMissionFixes&quot;;
this.author = &quot;phkb&quot;;
this.copyright = &quot;2016 phkb&quot;;
this.description = &quot;Updates routines in core missions for compatibility with XenonReduxUI&quot;;
this.licence = &quot;CC BY-NC-SA 3.0&quot;;

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function () {
	// if XenonUI is installed as well, let it do the monkey patching
	if (worldScripts.XenonUI) {
		delete this.startUpComplete;
		return;
	}

	// apply fixes for nova missions
	var wn = worldScripts[&quot;oolite-nova&quot;];
	if (wn) {
		wn.missionScreenOpportunity = this.$nova_missionScreenOpportunity;
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$nova_missionScreenOpportunity = function $nova_missionScreenOpportunity() {
	if (!player.ship.docked) {
		return;
	}

	function choiceEvaluation(choice) {
		if (choice === &quot;YES&quot;) {
			player.ship.useSpecialCargo(expandDescription(&quot;[oolite-nova-refugees]&quot;));
			mission.setInstructionsKey(&quot;oolite_nova_info&quot;);
			missionVariables.nova = &quot;NOVA_ESCAPE_HERO&quot;;
			player.ship.launch();
			this._blowUpAllStations();
			system.sun.goNova(30);
		} else {
			// choice == &quot;NO&quot;, or null when player launched without making a choice.
			missionVariables.nova = &quot;NOVA_ESCAPE_COWARD&quot;;
			player.commsMessage(expandDescription(&quot;[oolite-nova-coward]&quot;), 4.5);
			system.sun.goNova(9); // barely enough time to jump out of the system.
		}
		missionVariables.novacount = null;
	}

	if (player.ship.dockedStation.isMainStation) {
		if (galaxyNumber === 3) {
			if (!missionVariables.nova &amp;&amp; !missionVariables.novacount) {
				missionVariables.novacount = 0;
			}
			if (missionVariables.nova === &quot;TWO_HRS_TO_ZERO&quot;) {
				mission.runScreen({
						titleKey: &quot;oolite_nova_title&quot;,
						messageKey: &quot;oolite_nova_brief&quot;,
						overlay: {
							name: &quot;solar.png&quot;,
							height: 512
						},
						choicesKey: &quot;oolite_nova_yesno&quot;,
						screenID: &quot;oolite-nova-briefing&quot;
					},
					choiceEvaluation);

				this.novaMissionTimer.stop();
			}
		}
		if (galaxyNumber === 3 || galaxyNumber === 4) {
			if (missionVariables.nova === &quot;NOVA_ESCAPED_SYSTEM&quot;) {
				player.ship.removeAllCargo();
				mission.runScreen({
					titleKey: &quot;oolite_nova_title&quot;,
					messageKey: &quot;oolite_nova_hero&quot;,
					overlay: {
						name: &quot;solar.png&quot;,
						height: 512
					},
					screenID: &quot;oolite-nova-hero&quot;
				});
				player.ship.manifest[&quot;gem_stones&quot;] += 100;
				this._endTheMission();
			} else if (missionVariables.nova === &quot;NOVA_ESCAPE_POD&quot;) {
				player.ship.removeAllCargo(); // can only be done while docked.
				mission.runScreen({
					titleKey: &quot;oolite_nova_title&quot;,
					messageKey: &quot;oolite_nova_disappointed&quot;,
					overlay: {
						name: &quot;solar.png&quot;,
						height: 512
					},
					screenID: &quot;oolite-nova-disappointed&quot;
				});
				this._endTheMission();
			} else if (missionVariables.nova === &quot;NOVA_ESCAPE_OTHER&quot;) {
				mission.runScreen({
					titleKey: &quot;oolite_nova_title&quot;,
					messageKey: &quot;oolite_nova_ignored&quot;,
					overlay: {
						name: &quot;solar.png&quot;,
						height: 512
					},
					screenID: &quot;oolite-nova-ignored&quot;
				});
				this._endTheMission();
			} else if (missionVariables.nova === &quot;NOVA_ESCAPE_COWARD&quot; &amp;&amp; !system.sun.isGoingNova &amp;&amp; !system.sun.hasGoneNova) {
				player.decreaseContractReputation();
				player.decreasePassengerReputation();
				mission.runScreen({
					titleKey: &quot;oolite_nova_title&quot;,
					messageKey: &quot;oolite_nova_disappointed&quot;,
					overlay: {
						name: &quot;solar.png&quot;,
						height: 512
					},
					screenID: &quot;oolite-nova-coward&quot;
				});
				this._endTheMission();
			}
		}
	} else if (missionVariables.nova === &quot;TWO_HRS_TO_ZERO&quot;) {
		// this is the the nova system, but not the main station.
		player.ship.launch();
		player.commsMessage(expandDescription(&quot;[oolite-nova-visit-main]&quot;));
	}
};</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
