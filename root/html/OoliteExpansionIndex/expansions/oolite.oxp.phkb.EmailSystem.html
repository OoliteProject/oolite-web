<html>
    <head>
        <title>Expansion Email System</title>
        <link rel="stylesheet" href="../style.css">
    </head>
    <body>
        <table border="0" width="100%">
            <tr>
                <td>Back to <a href='../index.html'>Index</a></td>
                <td align="right"><small>Page generated: Oct 11, 2023, 3:16:49 PM</small></td>
            </tr>
        </table>

        <h1>Expansion Email System</h1>

        <h2>Content</h2>
        <ul>
          <li><a href="#warnings">Warnings</a></li>
          <li><a href="#manifest">Manifest</a></li>
          <li><a href="#documentation">Documentation</a></li>
          <li><a href="#equipment">0 Equipment</a></li>
          <li><a href="#ships">0 Ships</a></li>
          <li><a href="#models">0 Models</a></li>
          <li><a href="#scripts">2 Scripts</a></li>
        </ul>

          <a name="warnings">
            <h2>Warnings</h2>
            <ol>
                <li>Tags mismatch between OXP Manifest and Expansion Manager at character position 0002 (RIGHT SQUARE BRACKET vs LATIN SMALL LETTER E)(&#39;[]&#39; vs &#39;[email, comms]&#39;)</li>
                <li>Information URL mismatch between OXP Manifest and Expansion Manager string length at character position 0</li>
            </ol>
          </a>

        <a name="manifest">
        <h2>Manifest</h2>
            <table border="1">
                <tr>
                    <th></th>
                    <th>from Expansion Manager's OXP list</th>
                    <th>from Expansion Manifest</th>
                </tr>
                <tr>
                    <td>Description</td>
                    <td>Adds an email system to the system interfaces screen.</td>
                    <td>Adds an email system to the system interfaces screen.</td>
                </tr>
                <tr>
                    <td>Identifier</td>
                    <td>oolite.oxp.phkb.EmailSystem</td>
                    <td>oolite.oxp.phkb.EmailSystem</td>
                </tr>
                <tr>
                    <td>Title</td>
                    <td>Email System</td>
                    <td>Email System</td>
                </tr>
                <tr>
                    <td>Category</td>
                    <td>Equipment</td>
                    <td>Equipment</td>
                </tr>
                <tr>
                    <td>Author</td>
                    <td>phkb</td>
                    <td>phkb</td>
                </tr>
                <tr>
                    <td>Version</td>
                    <td>1.7.9</td>
                    <td>1.7.9</td>
                </tr>
                <tr>
                    <td>Tags</td>
                    <td></td>
                    <td>email, comms</td>
                </tr>
                <tr>
                    <td>Required Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Maximum Oolite Version</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td>Required Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Optional Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Conflict Expansions</td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
                <tr>
                    <td>Information URL</td>
                    <td><a target="_blank" href=""></a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>Download URL</td>
                    <td><a target="_blank" href="https://wiki.alioth.net/img_auth.php/f/f1/EmailSystem.oxz">https://wiki.alioth.net/img_auth.php/f/f1/EmailSystem.oxz</a></td>
                    <td><a target="_blank" href="">n/a</a></td>
                </tr>
                <tr>
                    <td>License</td>
                    <td>CC-BY-NC-SA 4.0</td>
                    <td>CC-BY-NC-SA 4.0</td>
                </tr>
                <tr>
                    <td>File Size</td>
                    <td>n/a</td>
                </tr>
                <tr>
                    <td>Upload date</td>
                    <td>1613077187</td>
                </tr>
            </table>
                </a>

        <a name="documentation">
        <h2>Documentation</h2>
        <p>Also read <a href='http://wiki.alioth.net/index.php/Email%20System'>http://wiki.alioth.net/index.php/Email%20System</a></p>
        <h3>readme.txt</h3>
        <pre>================================================================================
Introduction

For a long time Oolite players have been receiving mission screens that array themselves as an email message. This makes sense in-game, as you would imagine a lot of communication between the player and NPC&#39;s in the game world would take place inside the bounds of an email system. However, while the conceit of an email system has been present, many other aspects of a true email system are lacking. In particular:

1. The ability to re-read emails after you receive them
2. The ability to analyse the trace of an email (ie, the path the email took to reach the player).

The Email System OXP attempts to address these shortcomings and provide (as much as possible) a true, in-game email system.

Big thanks go to Wildeblood who pushed me not to compromise on functionality. Thanks to Norby who is always willing to contribute valuable ideas to any project. Thanks to Disembodied for some wonderful suggestions on new parts of the system. Thanks to Astrobe for his help with the escape pod emails. And huge thanks to cim, who is an amazing help with any and all technical questions relating to Oolite.

********************************************************************************
Standard Operations

The OXP adds a new option on the &quot;Interfaces&quot; (F4) screen called &quot;Email system&quot;. The number of unread emails will be displayed here.

After opening the email system, the player will see their inbox, sorted with the most recently received email at the top. The inbox view shows the senders name or email address, the date the email was sent, and the subject line of the email. A &quot;!&quot; symbol beside the email indicates it is unread.

At the bottom of the screen are the functions the player can select. They are:

	Go to next page: If the inbox flows to multiple pages, this option will go to the next page.
	Go to previous page: If the inbox flows to multiple pages, this option will go to the next page.
	Mark all items read: This option will remove the unread &quot;!&quot; flag from all emails in your inbox.
	Delete all read items: This option will delete all emails that have been read and are not waiting for a response from the player.
	Delete all items: This will delete all emails that are not waiting for a response from the player.
	Exit email system: This will exit the email system and return the player to the Interfaces F4 screen.

To open an email, use the up and down arrow keys to move the highlight bar to the desired email and press enter. Opening an email will automatically flag it as read.

When an email is opened, at the top of the screen will be the senders name or email address, the date the email was sent, and the subject line of the email.

Below this is the content of the email.

At the bottom of the screen are functions the player can perform on this email. They are:
	Close email: This will close the email and return the player to the inbox. The email will now be flagged as &quot;read&quot;.
	Close email and open next: This will close the current email and open the next email in the inbox.
	Close and delete email: This will close the email and delete it from the inbox if there are no response required by the player.
	Show trace: This will open the email trace, which will display the path the email took to reach the player.

Some emails can require the player to make a response. When an email requires a response, there will be additional options below the &quot;Show trace&quot; option. The format of these options will be &quot;Send &#39;option&#39; response.&quot; For instance, an email could ask the player &quot;Do you want to join our team?&quot;. In this case the options might be:

	Send &#39;Yes&#39; response
	Send &#39;No&#39; response

The player can select either of these options and press enter to send the response.

When an email has previously had a response sent, additional text will be added to the email body, similar to an email trail. Continuing the example above, if the player has response &quot;Yes&quot;, the email display might end up looking like this:

	From:	   Commander Curruthers
	Sent:	   2084504:05:16:02
	Subject:   Request for assistance
	-----------------------------------------------------------------------
	Commander Jameson,

	Her Majesty is in need of your assistance. Thargoid incursions are on
	the increase, and we need your help in the battle. Would you be willing
	to join us in the fight against this rising tide of evil?

	-----------------------------------------------------------------------
	Reply sent: 2084504:05:29:42
	Reply:

	Commander Curruthurs, it would be an honour.

********************************************************************************
External Interfaces

Other OXP&#39;s can make use of the email system by calling the $createEmail function.

================================================================================
** $createEmail**
The $createEmail function accepts a single object, that can have the following properties:
Required fields:
	sender				(text) Name of person sending email
	subject				(text) Subject line of email
	date				(time in seconds) the global.clock time the email was sent
Optional fields:
	message				(text) Body text of email
	sentFrom			(int) ID of Planet that is the source of the email. Defaults to the current planet.
						If the optional stopTrace flag is set, this ID will be the last planet in the trace.
	isRead				(boolean) Setting this to true will add the email to the inbox as if its been read by the player.
						This might be useful if you have displayed the message to the  player using &quot;addMessageToArrivalReport&quot; or a mission screen,
						and want to add  a corresponding email, which, because the player has seen it, should be flagged as read.
	expiryDate			(time in seconds) The time this email will expire and be deleted (if no expiryText is set). Alternatively, use the following params
	expiryDays			(int) number of days past the current date when the email will expire
	expiryHours			(int) number of hours past the current date when the email will expire
	expiryMinutes		(int) number of minutes past the current date when the email will expire
	expirySeconds		(int) number of seconds past the current date when the email will expire
						Note: the above expiry options can be combined: to expire an email 2 hours and 30 minutes in the future, use expiryHours:2, expiryMinutes:30
	expiryText			(text) Text to display in the header when the email expired. If this text is not supplied, the email will be deleted when it expires.
	expiryOptions		(csv text) The response option numbers to display when the email expires.  eg &quot;3,4&quot; would mean that option numbers 3 and 4 will be visible when the email expires.
	allowExpiryCancel	(boolean) Indicates whether the option to cancel the expiry notice will be avaiable to the player. Defaults to true if not supplied.
	stopTrace			(boolean) Indicates that the routing ticket is corrupt and a trace is only partial. The trace will terminate at the &quot;sentFrom&quot; planet. Defaults to false.
	traceRoute			(csv text) Allows the trace route information to be fully specified. If not specified, the route will be all planets between sentFrom and the current planet using the fastest route.
	forceResponse		(boolean) Indicates that the player must select a response before the email can be closed. Defaults to false.
	option1				(object) Response option 1
	option2				(object) Response option 2
	option3				(object) Response option 3
	option4				(object) Response option 4

The Response options have the following format:
Required fields:
	display				(text) Text to display to the user. Shown as &quot;Send &#39;displayText&#39; response&quot;.
	reply				(text) The text to be appended to the body of the email as the reply from the player.
	script				(text) The name of the worldScript where the callback function resides
	callback			(text) The name of the function to call
Optional fields:
	parameter			(object) The object to pass to the callback function.

********************************************************************************
Examples

In is most simplest form, sending an email is done as follows

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;Captain Solo&quot;,					// senders name or email address
		subject:&quot;I&#39;ve got a bad feeling about this&quot;,		// subject line
		date:global.clock.seconds,				// the time the email was sent
		message:&quot;I thought they smelled bad on the outside.&quot;	// body text of the email
		});

In this form, there is no response required by the player. Also, the email trace will show that the email was sent from the current planet. To expand this example, lets add a longer trace.

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;Captain Solo&quot;,					// senders name or email address
		subject:&quot;I&#39;ve got a bad feeling about this&quot;,		// subject line
		date:global.clock.seconds,				// the time the email was sent
		message:&quot;I thought they smelled bad on the outside.&quot;,	// body text of the email
		sentFrom:14						// id of planet from which the email was sent.
		});

Now, when the player opens the email trace, the system will show all the planets between planet ID 14 and the players current planet. We can force a particular trace on this email by adding in a comma-separated list of items into the traceRoute parameter.

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;Captain Solo&quot;,					// senders name or email address
		subject:&quot;I&#39;ve got a bad feeling about this&quot;,		// subject line
		date:global.clock.seconds,				// the time the email was sent
		message:&quot;I thought they smelled bad on the outside.&quot;,	// body text of the email
		traceRoute:&quot;Lave,Isinor,Endor,Tatooine,Hoth&quot;		// csv list of items to appear in the email trace.
		});

The trace is ordered from the last to the first. That is, the end point of the trace (where the player receives the message) is at the start of the list. Note that we don&#39;t have to include planets - we can include anything we like in the trace when entered like this.

We might want to make it appear as though the trace is corrupted, which might be useful in some circumstances. To do this, set the stopTrace flag.

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;Captain Solo&quot;,					// senders name or email address
		subject:&quot;I&#39;ve got a bad feeling about this&quot;,		// subject line
		date:global.clock.seconds,				// the time the email was sent
		message:&quot;I thought they smelled bad on the outside.&quot;,	// body text of the email
		sentFrom:14,						// id of planet from which the email was sent.
		stopTrace:true						// the trace is now corrupt
		});

What this will do is show the trace from the players current planet to planet ID 14, but the message &quot;Routing ticket corrupt&quot; will be displayed, which would indicate to the player that there was more to the trace but it&#39;s now hidden.

All of these examples will add an email to the inbox, but there are no options attached. They are simple emails the player can view and delete as required. An example of an email with some options is below:

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		});

In this example, the player is asked if they want to play a game in the body of the email. Then, two options are configured. The first option will be shown to the player as &quot;Yes&quot;, the second as &quot;No.&quot;

If the player selects the &quot;Yes&quot; option, the text &quot;Sure. Why not?&quot; will be appended to the body of the email as the reply, and the $AcceptChallenge function will be called in the EmailSystemDemo worldScript.

If the player selects the &quot;No&quot; option, the text &quot;Sorry. Too busy right now. And I don&#39;t play games.&quot; will be appended to the body of the email as the reply, and the $DeclineChallenge function will be called in the EmailSystemDemo worldScript.

A paramater can be passed to the callback function by using the &quot;param&quot; parameter:

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;, parameter:&quot;mydata&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		});

Emails can be set to expire by using expiryDate, expiryDays, expiryHours, expiryMinutes and expirySeconds. In this example, the email will expire in 2 minutes and 30 seconds. When the email expires it will simply be deleted from the users inbox.

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		expiryMinutes:2,
		expirySeconds:30,
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;, parameter:&quot;mydata&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		});

An email with an expiry date will present the user with an option to &quot;Cancel expiry&quot;. That will remove the expiry date from the email. If you want to remove that option from the player, use the allowExpiryCancel flag,

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		expiryMinutes:2,
		expirySeconds:30,
		allowExpiryCancel:false,
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;, parameter:&quot;mydata&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		});

You might not want the email to be deleted, but to remain in an expired state. To do this, set the expiryText option:

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		expiryMinutes:2,
		expirySeconds:30,
		allowExpiryCancel:false,
		expiryText:&quot;This email has expired&quot;,
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;, parameter:&quot;mydata&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		});

If you have options on the un-expired email, those options will be hidden once the email expires. However, you can add response options that are only available when the email expires using the &quot;expiryOptions&quot; parameter. In this expiry, option 3 has been defined as an expiry option, which will only be visible after the email expires:

	var w = worldScripts.EmailSystem;
	w.$createEmail(
		{sender:&quot;The Chaser&quot;,				// senders name or email address
		subject:&quot;Something for you do look at...&quot;,	// subject line
		date:global.clock.seconds,			// the time the email was sent
		message:&quot;Would you like to play a game?&quot;,	// body text of the email
		expiryMinutes:2,
		expirySeconds:30,
		allowExpiryCancel:false,
		expiryText:&quot;This email has expired&quot;,
		expiryOptions:&quot;3&quot;,
		option1:{display:&quot;Yes&quot;, reply:&quot;Sure. Why not?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$AcceptChallenge&quot;, parameter:&quot;mydata&quot;},
		option2:{display:&quot;No&quot;, reply:&quot;Sorry. Too busy right now.&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$DeclineChallenge&quot;}
		option3:{display:&quot;Too late&quot;, reply:&quot;Sorry I didn&#39;t respond to your email in time. Can I still join in?&quot;, script:&quot;EmailSystemDemo&quot;, callback:&quot;$TooLate&quot;}}
		});

================================================================================
Why should you use this system?

Oolite already has mission screens with selectable options and callbacks, so why use this system?

This OXP is *not* designed to replace mission screens and their associated methods, although it can certainly do many of the same things. Instead, the intention is to provide a way to add extra realism to the game. If your mission screen sends information to the user and formats it like an email, keep doing this. But consider adding a couple of lines of code to check for the email system and add a new email item so the player has a record of the emails they have received. They can view their historic emails for reminders of mission parameters, or to find hidden clues. They can view the email trace that could help track down a target.

The Email System can provide an additional option for OXP developers for enhancing the realism in their missions.

Third Party Equipment in Maintenance Overhaul Emails
====================================================
In general, any third party equipment items will have a &quot;Perform diagnostics&quot; item in the maintenance overhaul email. But it is possible to include special maintenance description items for third party equipment by following these steps.

1. Include an item in your descriptions.plist file similar to this:
	maint_EQ_YOUR_EQUIPMENT_ID = (&quot;One or more maintenance description items&quot;);

2. Include the following code in your startUp or startUpComplete scripts:
	var g = worldScripts.GalCopAdminServices;
	if (g) g._maint_known_equip.push(&quot;EQ_YOUR_EQUIPMENT_ID&quot;);

License
=======
This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 4.0 Unported License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/

Sound files from &quot;Robot Blip Sound&quot; WAV file, created by Marianne Gagnon and sourced from soundbible.com. Licenced under Creative Commons Attribution 3.0.
Images from http://simpleicon.com/message_8.html, http://simpleicon.com/message.html

Discussion
==========
This OXP is discussed at this forum link: http://aegidian.org/bb/viewtopic.php?f=4&amp;t=17216

Version History
===============
1.7.9
- Fixed issue with NaN showing in some purchase emails.
- Fixed issue with Repair Bots recharge items showing as removal emails.
- Fixed issue with IronHide Military upgrades showing as removal emails.
- Fixed issue with Passenger berth purchases showing as removal emails.

1.7.8
- Message ID now returned to caller from $createEmail function.
- Fines processing only occurs at main system station (not at secondary stations, even those with police and with allegiance of &quot;galcop&quot;). 
- Fix for Target Autolock Plus purchase email.

1.7.7
- Bug fixes.

1.7.6
- Better handling of purchasing equipment emails when equipment item is for the removal of something.
- Better handling of purchasing equipment emails when price is calculated via a condition script.

1.7.5
- Spelling corrections.
- New ship email had additional zero on cost of new ship.

1.7.4
- Cost of new ship in the new ship email now formatted to include cr symbol.
- Small change to format of all script and text files.
- Included check for a new Elite rank of &quot;Harmless&quot;.
- Code refactoring.

1.7.3
- When future dated emails arrive in player&#39;s inbox, the trace route will now reflect the system they receive the email in, not the system where the email was generated.
- A console message will appear when future dated emails arrive in the player&#39;s inbox.

1.7.2
- Fixed issue where missile kills were not being noted in bounty emails.

1.7.1
- Remove debug message in new ship email.
- Added missing Elite Federation email subject for Above Average.
- Fixed repair email, which was not being triggered under certain conditions.

1.7.0
- Fixed issue where docking fine email was being sent after using an escape pod.
- Added new email for when the player purchases, uses or sells an escape pod.
- Better handling of sale of items via Ship Configuration.

1.6.8
- Player will now be notified of unread emails that require a response whenever they dock at a station.
- If player has unread emails requiring a response, the interface screen entry will include a token in its text.
- Fixed issue where emails having expired responses could not be deleted.
- Fixed issue with new ship email, where &quot;Remove laser&quot; was appearing in laser mounts that didn&#39;t have anything (or really, had EQ_WEAPON_NONE installed).
- Fixed issue where the sales rep name was missing from new ship emails.
- Fixed issue where equipment repair emails had &quot;NaN.NaN&quot; for the repair cost.
- Fixed issue where bounty payments were being overstated for Pirate coves (or any piloted entity defined with scanClass &quot;CLASS_ROCK&quot;).
- Added some configuration items to Library Config to control what emails are sent.

1.6.7
- Updated check for &quot;Allow Big GUI&quot;.
- Fixed Javascript error when setting up rep names.
- Switched name generator to use &quot;randomName&quot;.
- Updated maintenance overhaul email so that it won&#39;t try to lookup equipment keys that aren&#39;t known to have a &quot;maint_&quot; item in descriptions. This should prevent a lot of unnecessary Javascript error messages about expansion keys not found.
- Updated output of all credit amounts to use the formatCredits function.
- Changed &quot;==&quot; comparisons to &quot;===&quot; for performance improvements.
- Better handling of interstellar space conditions.
- Better menu handling, where the current email will still be selected in the list when returning from viewing it.
- Fixed issue with HUD not becoming visible again when launching while viewing the Email list.
- Code cleanup.

1.6.6
- Updated screenID&#39;s to enable BGS background sounds.
- Renamed background overlay images to prevent possibility of future duplication.
- Toned down overlay images.
- Bug fixes.

1.6.5
- Further attempts to fix Javascript timeouts on Mac.
- Code refactoring.

1.6.4
- Really fixed the Javascript timeout issue.
- New ship email was including equipment items that weren&#39;t visible.

1.6.3
- Added check to fine email for a zero calculation.
- Added check to repair email for a zero payment.
- Fixed issue where launching within 1 second of purchasing a new item would generate a Javascript error.
- Fixed variable naming issue.
- Fixed Javascript timeout issue.
- Bug fixes and code cleanup.

1.6.2
- Improvements to the &quot;marked for fines&quot; email - added additional checks for bounty threshold, suppression of arrival reports and sun going nova.
- Improvements to the &quot;docking fine&quot; email - added additional check for sun going nova.
- Switched to use &quot;clock.adjustedSeconds&quot; as the date sent in most GalCop emails.

1.6.1
- Spelling corrections.
- Small tweaks to the IronHide repair email.
- Tweaks to the repair email, so items that have &quot;repair&quot; in the name don&#39;t get &quot;Repair of&quot; at the beginning of the item (eg &quot;Repair of Emergency Hull Repairs&quot;).

1.6.0
- Added overlay background image to interface screens.
- Changed color of menu items on interface screens, so it&#39;s less yellow.
- Really fixed issue with maintenance email and no weapon mounts.
- Other maintenance email bug fixes.

1.5.2
- Fixed issue with maintenance email, where maintenance was said to be performed on weapon mounts with no weapons installed.

1.5.1
- Added more equipment exclusions for the Smuggling OXP.
- Fixed a small bug in the inbox compilation routine that would only have reared it&#39;s head if your inbox was ever empty.
- Fixed issue where the routine to clear out old emails was removing the most recent first instead of the oldest.
- Added extra process to the routine to clear out old emails to remove expired items first.

1.5.0
- Added some equipment exclusions for the Smuggling OXP.
- Moved lists of equipment items from descriptions and into proper arrays.
- Added routine to use 1.83/4 code to check for big GUI HUD&#39;s.

1.4.20
- Fixed issue with new rank email referencing incorrect array variable.

1.4.19
- Added specific docking fine email for Black Monks monestary.
- Moved list of Federation HQ planet ID&#39;s to be accessible to external OXP&#39;s (via worldScripts.GalCopAdminServices._fedHQ array), in case it&#39;s ever needed.
- Switched back to &quot;shipKilledOther&quot; so untargeted ships destroyed by the player (eg via missile) are included in the kill count and email.

1.4.18
- Checks for the &quot;allow_big_gui&quot; HUD option.
- Escape pod recovery emails now turn up immediately.
- Added RRS refueling to list of equipment items excluded from purchase emails.
- Reworked the procedure for when the player buys equipment, to ensure the email process happens after any other OXP process.
- Added condition for when the purchase price of an item is 0 (zero) credits (eg removing lasers).

1.4.17
- Fixed the fine amount calculation on the fine email (really totally for sure this time).
- Put option text into descriptions.plist file.

1.4.16
- Added ellipsis to columns when text is truncated
- Slight adjustment to column widths to cater for wider fonts
- Removed seconds component from email items on the inbox display. The full sent date/time, including seconds is still visible when you open an email.

1.4.15
- Fixed an issue with the new parcel and passenger contracts, where the contract name wasn&#39;t being added to the email correctly.

1.4.14
- Fixed an issue with purchasing passenger berths, where an incorrect email was being sent.

1.4.13
- Fixed an issue with the rescued escape pod email, where a substitution was not entered correctly.
- Fixed issue with maintenance email. Report will now only list items that have &quot;isVisible = true&quot;.

1.4.12
- Code improvements as suggested by Wildeblood.

1.4.11
- Speed improvements as suggested by Norby.

1.4.10
- Small bug fix when checking Combat Simulator
- Added exclusion for extra ship respray equipment item

1.4.9
- Fixed bug where the new pilot registration email was not being sent for new pilots. Instead, the late notice email was being sent.

1.4.8
- Corrected a minor bug with calculating the route to another system. Had &quot;OPTIMISED_BY_TIME&quot; instead of &quot;OPTIMIZED_BY_TIME&quot;.
- Faster sorting algorithm
- Added exclusion for &quot;Ship Respray&quot; OXP.

1.4.7
- Fixed issue where using the Combat Simulator OXP would generate invalid emails

1.4.6
- Better error handling of maint_itemname code.
- Fixed manifest version number issue

1.4.5
- Added some more equipment key exclusions for the maintenance email (ShipVersion OXP items)
- Added some special cases for ShipVersion repair equipment items.
- Switched from shipKilledOther to shipTargetDestroyed to better monitor for ships destroyed by the player
- Small bug fixes and tweaks.

1.4.4
- Fixed grammar issue with bounty emails in Interstellar space.
- Added some more exams to the new pilot registration email
- Fixed decimal number issue with docking fines and other places.
- Fixed issue with docking fines at some stations, where the wrong name was showing in the duty officers email signature.

1.4.3
- You can now exit from the email system just by pressing another function key.

1.4.2
- Attempt to fix issue when the number of unread emails on the interfaces screen was not updating in some circumstances

1.4.1
- Made the licence number longer (it&#39;s a big galaxy after all)
- Moved the licence email out of the block that checks for a new ship. This is so users of the Hardships OXP will at least get a pilot&#39;s licence when they start.
- Fixed a bug with saving and loading to mission variables.

1.4.0
- Changed the inbox UI to be similar to contract interfaces, where you highlight the desired item and press enter to open the email.
- Added a couple of other GalCop admin-related emails, relating to transfer of ownership of ships, and pilot licensing.
- Layout tweaks to maintenance email, adding some headings
- Small tweaks to the text of bounty emails.
- Small grammar corrections.

1.3.0
- Improved the purchase equipment email to handle removal of equipment better.
- Added equipment description to the purchase equipment email.
- Made the random names a little less random. Now, multiple purchases of equipment will have the same sales rep name while you are docked at that station.
- Improved compatibility with Hardships. You won&#39;t get an initial &quot;Welcome to your new ship&quot; with Hardship&#39;s start choices, but you also won&#39;t get spammed either.
- Included no bounty kills in the bounty email, with appropriate notices
- Added the number of kills to the bounty email
- Future-dated emails are now hidden until their sent date is in the past. This means you can send emails at any time, but with a future date, and player won&#39;t see them until the right time.
- ExpiryDays, ExpiryHours, ExpiryMinutes and ExpirySeconds are now linked to the sent date, rather than to the current date. So if you future date an email and give it an expiry of 2 days, that will be 2 days after the future date, not the current date.
- Added a tone for when future dated emails become current. Will only play when docked.
- Code cleanup.

1.2.0
- Fixed bug with the equipment purchase email, when the wrong price was being shown when equipment was bought in any non-main station.
- Added emails from the Elite Federation for changes in player rank
- Improved the new ship email content, including the method of calculating the cost of the new ship.
- Improved default option selection on multi-page emails
- Improved the bounty email. If there are several systems between dockings, the email will include the system name the bounties were collected in.
- Added more maintenance items for overhaul email, including notation for damaged items
- New ship email will now be sent whenever a new game is started (hopefully this will catch most scenarios as well as the standard ones)
- Fixed the calculation of the fine amount
- Fixed bug with failed passenger contracts subject line
- Fixed issue with overhaul email and ships without hyperspace capability (email might have included witchdrive maintenance items)
- Removed expiry date from new contract emails
- Spelling corrections

1.1.5
- Fixed problem with recursive function on Macs. Removed recursion.

1.1.4
- Added GalCop emails for purchasing equipment, new ships, and maintenance overhauls.

1.1.3
- Remove the %R special expansion and replaced with [nom] for better random name generation.

1.1.2
- Removed arrival report message. If you really want it, you can turn it on with a setting.
- Fixed issue with the bounty report email if the player destroys a ship with no bounty. No entry will be made in this case now.
- Added an archive limit, so that emails will automatically be start to be deleted if they have 100 emails or more.
- Added an expiry date to all the standard galcop notices.
- Simplified $createEmail object parameters.
- added a zero check on expiry time
- fixed bug where number of pages wasn&#39;t updating when deleting emails.
- spelling corrections

1.1.1
- Removed unnecessary OXP folders, combines GALCOP Admin services into main OXP, ready for OXZ publication
- Fixed bug when calling $createEmail during flight (thanks to Wildeblood for the heads up)
- Removed unnecessary option on the $createMail function
- Added message to arrival report if the player has unread emails.

1.1.0
- Fixed bug with closing a long email on a page greater than 1 and opening the next email. Thanks to Wildeblood for the bug report.
- Added ExpiryDate option (thanks to Wildeblood for the suggestion)
- Reworked the response options so that there is no need for OXP&#39;s to reconnect callback functions.
- Changed the save format in mission variables to use a single value, rather than multiple values, for emails.
- Code cleanup (thanks to Wildeblood for the pointers)

1.0.1
- Changed createEmail function call to use an object, rather than parameters.
- Added galaxy number to stored emails, which will be displayed when the player is in a galaxy other than the one they received the email in.
- fixed bug that was preventing bounty email from being sent
- fixed bug that was sending a docking clearance penalty notice when docking clearance was about to expire
- Spelling fixes
- Code cleanup
</pre>
        </a>

        <a name="equipment">          
        <h2>Equipment</h2>
            This expansion declares no equipment. This may be related to warnings.
        </a>

        <a name="ships">    
        <h2>Ships</h2>
            This expansion declares no ships. This may be related to warnings.
        </a>

        <a name="models">    
        <h2>Models</h2>
            This expansion declares no models. This may be related to warnings.
        </a>

        <a name="scripts">    
        <h2>Scripts</h2>
            <table>
                <tr>
                    <th>Path</th>
                </tr>
                <tr>
                    <td valign="top">Scripts/emailsystem_base.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;EmailSystem&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2017 phkb&quot;;
this.description = &quot;Implements a simple email system via the interfaces screen.&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

// specific settings for this oxp
this._maxpage = 0;              		// total number of pages of inbox to display
this._curpage = 1;              		// the current page of the inbox being displayed
this._msRows = 18; //15					// rows to display on the mission screen
this._msCols = 32;						// columns to display on the mission screen
this._itemsOnPage = 0;					// number of emails being displayed on a page
this._displayType = 0;					// controls the view. 0 = inbox, 1 = email, 2 = trace
this._emailPage = 0;					// which page of the email are we viewing.
this._emailMaxPages = 0;				// total number of pages in the email we are viewing
this._emails = [];						// main array of emails
this._emailID = 0;						// id of the email we are viewing
this._disableEmailNotification = false;	// disables unread email notification when docking
this._notifyMainStationOnly = false; 	// unread email notification at main stations only
this._archiveLimit = 100;				// number of emails to keep before they start getting deleted automatically
this._updateRequired = true;			// flag to indicate the interface screen needs updating because a new email was added
this._newMailAlert = null				// timer for future dated new emails arriving
this._pageItems = [];
this._lastChoice = [&quot;&quot;, &quot;&quot;, &quot;&quot;];
this._emailOpen = false;
this._itemColor = &quot;yellowColor&quot;;
this._menuColor = &quot;orangeColor&quot;;
this._exitColor = &quot;yellowColor&quot;;
this._disabledColor = &quot;darkGrayColor&quot;;
this._readColumn = 0.4;

//=============================================================================================================
// set up initial variables
//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
	this._hudHidden = false;
	this._emailOpen = false;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	// add the welcome email here. If this is the first time we&#39;ve used the system, there won&#39;t be any data to load from mission variables
	// so it will not be overwritten by restoring saved values
	// once there are saved emails to restore, this email will disappear
	this.$createEmail({sender:&quot;Xenon Industries&quot;,
		subject:&quot;Welcome to your inbox!&quot;,
		date:clock.seconds - 100,
		message:&quot;Xenon Industries is proud to welcome you to your new inbox. We hope you enjoy the facilities this system provides.\n\n&quot;
			+ &quot;Xenon Industries have been working behind the scenes for many years providing message facilities to spacers from &quot;
			+ &quot;all walks of life. However, it was only after GalCop regulation 3827B (Sub-section A) was passed that we &quot;
			+ &quot;have been allowed to provide a fully functional email system to any space going vessel. Even with this &quot;
			+ &quot;regulation, email facilities are only operational while dockside, as GalCop regulations make it clear than &quot;
			+ &quot;emailing while flying is a serious offence.\n\nDespite this, we know you will love all the benefits a good email &quot;
			+ &quot;client can provide, and we believe we have all of this and more.\n\n&quot;
			+ &quot;Thank you for using Xenon Industries&#39;s email system, and we trust it will perform flawlessly for you for years to come.&quot;}, false);

	if (defaultFont.measureString(&quot;!&quot;) &gt; 0.4) this._readColumn = defaultFont.measureString(&quot;!&quot;) + 0.1;

	// restore saved data if any exists
	if (missionVariables.EmailSystem_Emails) {
        this._emails = JSON.parse(missionVariables.EmailSystem_Emails);
        delete missionVariables.EmailSystem_Emails;
    }

	this.$checkForFutureDatedEmails();

	var p = player.ship;
	if(p.docked) this.$initInterface(p.dockedStation);
}

//=============================================================================================================
//public interfaces
//-------------------------------------------------------------------------------------------------------------

//-------------------------------------------------------------------------------------------------------------
// Create a new email
// REQUIRED
// emailObj.sender					(text) Name of person sending email
// emailObj.subject					(text) Subject line of email
// emailObj.date					time in seconds
// OPTIONAL
// emailObj.message					(text) Body text of email
// emailObj.sentFrom				(int) ID of Planet that is the source of the email. Defaults to the current planet.
//										If the optional stopTrace flag is set, this ID will be the last planet in the trace.
// emailObj.isRead					(boolean) setting this to true will add the email to the inbox as if it&#39;s been read by the player.
//										this might be useful if you have displayed the message to the player using &quot;addMessageToArrivalReport&quot;,
//										and want to add a corresponding email, which, because the player has seen it, should be flagged as read. Default false
// emailObj.stopTrace				(boolean) Indicates that the routing ticket is corrupt and a trace is only partial. The trace will terminate at the &quot;sentFrom&quot; planet. Default false.
// emailObj.traceRoute				(csv text) Allows the trace route information to be fully specified. If not specified, the route will be all planets between sentFrom and the current planet
//										using the fastest route.
// emailObj.expiryDate		    	time in seconds when email will expire
// emailObj.expiryDays				Number of days added to current date
// emailObj.expiryHours				Number of hours added to current date
// emailObj.expiryMinutes			Number of minutes added to current date
// emailObj.expirySeconds			Number of seconds added to current date
// emailObj.expiryText				Text to display in header when email expires
// emailObj.allowExpiryCancel		(boolean) indicates whether the expiry date of the email can be cancelled. (default true)
// emailObj.expiryOptions			(csv text) csv list of which options to display after expiry (possible values in list are 1,2,3 or 4) eg &quot;3,4&quot;
// emailObj.forceResponse			(boolean) Indicates that the player must select a response before the email can be closed. Default false
// emailObj.option1					(ResponseOption) Response option 1
// emailObj.option2					(ResponseOption) Response option 2
// emailObj.option3					(ResponseOption) Response option 3
// emailObj.option4					(ResponseOption) Response option 4
//
// Response options are an object:
// response.display					(text) Text to display on email. Will be slotted into &quot;Send &#39;xxx&#39; response&quot;
// response.reply					(text) Text to be appended to the email as a reply.
// response.script					(text) the name of the worldScript where the callback function is located
// response.callback				(text) the name of the function to call when the reply is selected
// response.parameter				(object) object to pass to the function when it is called
this.$createEmail = function(emailObj) {
	// using parameters
	if (emailObj.hasOwnProperty(&quot;sender&quot;) === false || emailObj.sender === &quot;&quot;) {
		throw &quot;Invalid settings: sender must be supplied.&quot;;
	}
	if (emailObj.hasOwnProperty(&quot;subject&quot;) === false || emailObj.subject === &quot;&quot;) {
		throw &quot;Invalid settings: subject must be supplied.&quot;;
	}
	if (emailObj.hasOwnProperty(&quot;date&quot;) === false || emailObj.date === 0) {
		throw &quot;Invalid settings: date must be supplied.&quot;;
	}
	if (emailObj.hasOwnProperty(&quot;sentFrom&quot;) === true) {
		if (emailObj.sentFrom &lt; 0 || emailObj.sentFrom &gt; 255) {
			throw &quot;Invalid settings: sentFrom (planet ID) must be supplied and be in range 0-255.&quot;;
		}
	}

	var id = this.$nextID();

	var ebody = &quot;&quot;;
	if (emailObj.hasOwnProperty(&quot;message&quot;) === true) ebody = emailObj.message;

	var planet = system.ID;
	if (emailObj.hasOwnProperty(&quot;sentFrom&quot;) === true) planet = emailObj.sentFrom;

	var stoptr = false;
	if (emailObj.hasOwnProperty(&quot;stopTrace&quot;) === true) stoptr = emailObj.stopTrace;

	var read = false;
	if (emailObj.hasOwnProperty(&quot;isRead&quot;) === true) read = emailObj.isRead;

	var trc = &quot;&quot;;
	if (emailObj.hasOwnProperty(&quot;traceRoute&quot;) === true) {
		trc = emailObj.traceRoute;
	} else {
		trc = this.$populateTrace(planet);			// text: CSV list of planets in the trace
	}

	var forcersp = false;
	if (emailObj.hasOwnProperty(&quot;forceResponse&quot;) === true) forcersp = emailObj.forceResponse;

	var expDate = 0;
	if (emailObj.hasOwnProperty(&quot;expiryDate&quot;) === true) expDate = emailObj.expiryDate;
	if (emailObj.hasOwnProperty(&quot;expiryDays&quot;) === true || emailObj.hasOwnProperty(&quot;expiryHours&quot;) === true || emailObj.hasOwnProperty(&quot;expiryMinutes&quot;) === true || emailObj.hasOwnProperty(&quot;expirySeconds&quot;) === true) {
		var addsec = 0;
		// convert all values to seconds
		if (emailObj.hasOwnProperty(&quot;expiryDays&quot;) === true) addsec += emailObj.expiryDays * 24 * 60 * 60;
		if (emailObj.hasOwnProperty(&quot;expiryHours&quot;) === true) addsec += emailObj.expiryHours * 60 * 60;
		if (emailObj.hasOwnProperty(&quot;expiryMinutes&quot;) === true) addsec += emailObj.expiryMinutes * 60;
		if (emailObj.hasOwnProperty(&quot;expirySeconds&quot;) === true) addsec += emailObj.expirySeconds; // don&#39;t know why you&#39;d want to, but just in case
		// add the expiry amount to the transmit date, so a future dated email with expiry will not expire before it&#39;s visible
		if (addsec &gt; 0) expDate = emailObj.date + addsec;
	}

	var expText = &quot;&quot;;
	if (emailObj.hasOwnProperty(&quot;expiryText&quot;) === true) expText = emailObj.expiryText;

	var expOptions = &quot;&quot;;
	if (emailObj.hasOwnProperty(&quot;expiryOptions&quot;) === true) expOptions = emailObj.expiryOptions;
	if (expOptions != &quot;&quot; &amp;&amp; expText === &quot;&quot;) {
		throw &quot;Invalid settings: expiryOptions have been defined but no expiryText has been set. Options will never be available to player.&quot;;
	}

	var expCancel = true;
	if (emailObj.hasOwnProperty(&quot;allowExpiryCancel&quot;) === true) expCancel = emailObj.allowExpiryCancel;

	var opt1 = {DisplayText:&quot;&quot;, ReplyText:&quot;&quot;, WorldScriptsName:&quot;&quot;, CallbackFunction:&quot;&quot;, FunctionParam:{}};
	if (emailObj.hasOwnProperty(&quot;option1&quot;) === true) {
		opt1.DisplayText = emailObj.option1.display;
		opt1.ReplyText = emailObj.option1.reply;
		opt1.WorldScriptsName = emailObj.option1.script;
		opt1.CallbackFunction = emailObj.option1.callback;
		if (emailObj.option1.hasOwnProperty(&quot;parameter&quot;) === true) opt1.FunctionParam = emailObj.option1.parameter;
	}
	var opt2 = {DisplayText:&quot;&quot;, ReplyText:&quot;&quot;, WorldScriptsName:&quot;&quot;, CallbackFunction:&quot;&quot;, FunctionParam:{}};
	if (emailObj.hasOwnProperty(&quot;option2&quot;) === true) {
		opt2.DisplayText = emailObj.option2.display;
		opt2.ReplyText = emailObj.option2.reply;
		opt2.WorldScriptsName = emailObj.option2.script;
		opt2.CallbackFunction = emailObj.option2.callback;
		if (emailObj.option2.hasOwnProperty(&quot;parameter&quot;) === true) opt2.FunctionParam = emailObj.option2.parameter;
	}
	var opt3 = {DisplayText:&quot;&quot;, ReplyText:&quot;&quot;, WorldScriptsName:&quot;&quot;, CallbackFunction:&quot;&quot;, FunctionParam:{}};
	if (emailObj.hasOwnProperty(&quot;option3&quot;) === true) {
		opt3.DisplayText = emailObj.option3.display;
		opt3.ReplyText = emailObj.option3.reply;
		opt3.WorldScriptsName = emailObj.option3.script;
		opt3.CallbackFunction = emailObj.option3.callback;
		if (emailObj.option3.hasOwnProperty(&quot;parameter&quot;) === true) opt3.FunctionParam = emailObj.option3.parameter;
	}
	var opt4 = {DisplayText:&quot;&quot;, ReplyText:&quot;&quot;, WorldScriptsName:&quot;&quot;, CallbackFunction:&quot;&quot;, FunctionParam:{}};
	if (emailObj.hasOwnProperty(&quot;option4&quot;) === true) {
		opt4.DisplayText = emailObj.option4.display;
		opt4.ReplyText = emailObj.option4.reply;
		opt4.WorldScriptsName = emailObj.option4.script;
		opt4.CallbackFunction = emailObj.option4.callback;
		if (emailObj.option4.hasOwnProperty(&quot;parameter&quot;) === true) opt4.FunctionParam = emailObj.option4.parameter;
	}

	if (expOptions != &quot;&quot; &amp;&amp;
		((expOptions.indexOf(&quot;1&quot;) &gt;=0 &amp;&amp; opt1.DisplayText === &quot;&quot;) ||
		(expOptions.indexOf(&quot;2&quot;) &gt;=0 &amp;&amp; opt2.DisplayText === &quot;&quot;) ||
		(expOptions.indexOf(&quot;3&quot;) &gt;=0 &amp;&amp; opt3.DisplayText === &quot;&quot;) ||
		(expOptions.indexOf(&quot;4&quot;) &gt;=0 &amp;&amp; opt4.DisplayText === &quot;&quot;))) {
		throw &quot;Invalid settings: expiryOptions have been defined but the response option has not been set.&quot;;
	}

	var msg = {ID:id,
			Sender:emailObj.sender,
			Subject:emailObj.subject,
			TransmitDate:emailObj.date,
			EmailBody:ebody,
			OriginatingPlanet:System.systemNameForID(planet),
			ReceivedPlanet:System.systemNameForID(system.ID),
			Read:read,
			CorruptTrace:stoptr,
			Trace:trc,
			ExpiryDate:expDate,
			ExpiryText:expText,
			ExpiryOptions:expOptions,
			AllowExpiryCancel:expCancel,
			ChosenOption:0,
			Marked:false,
			GalaxyNum:galaxyNumber,
			ForceResponse:forcersp,
			ResponseOption1:opt1,
			ResponseOption2:opt2,
			ResponseOption3:opt3,
			ResponseOption4:opt4};

	this._emails.push(msg);

	if (emailObj.date &gt; clock.seconds &amp;&amp; player.ship.docked === true) {
		// set a timer to ding when the email &quot;appears&quot; in the inbox - only while docked
		if (!this._newMailAlert || this._newMailAlert.isRunning === false) {
			this._newMailAlert = new Timer(this, this.$newMailArrived, (emailObj.date - clock.seconds), 0);
		}
	}

	// make sure we keep our array inside the bounds of the archive limit
	this.$deleteOldest();
	this._updateRequired = true;

	// return the msg id back to the caller, just in case they need it.
	return id;
}

//=============================================================================================================
// ship interfaces

//-------------------------------------------------------------------------------------------------------------
this.shipDockedWithStation = function(station) {

	if (this._disableEmailNotification === false &amp;&amp; ((this._notifyMainStationOnly === true &amp;&amp; station.isMainStation) || this._notifyMainStationOnly === false)) {
		var unread = this.$totalUnreadItemsRequiringResponse();
		if(unread != 0) {
			var addText = &quot;emails&quot;;
			var respText = &quot;require&quot;;
			if (unread === 1) { addText = &quot;email&quot;; respText = &quot;requires&quot;; }
			player.addMessageToArrivalReport(&quot;You have &quot; + unread + &quot; unread &quot; + addText + &quot; that &quot; + respText + &quot; a response.&quot;);
		}
	}

	this.$checkForFutureDatedEmails();
	this.$initInterface(station);
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function(station) {
	delete missionVariables.EmailSystem_Emails;
	if (this._newMailAlert &amp;&amp; this._newMailAlert.isRunning) this._newMailAlert.stop();
}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
	// save email array
	missionVariables.EmailSystem_Emails = JSON.stringify(this._emails);
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function(to, from) {

	if (guiScreen === &quot;GUI_SCREEN_INTERFACES&quot; || this._updateRequired === true) {
		// update the interfaces screen
		this._updateRequired = false;
		var p = player.ship;
		if (p.dockedStation) this.$initInterface(p.dockedStation);
	}

	if (from === &quot;GUI_SCREEN_MISSION&quot; &amp;&amp; this._emailOpen) {
		this._emailOpen = false;
		if (this._hudHidden === false &amp;&amp; player.ship.hudHidden === true) player.ship.hudHidden = false;
	}
}

//=============================================================================================================
// general functions

//-------------------------------------------------------------------------------------------------------------
// check for any future dated emails, and start a timer to play a ding noise
this.$checkForFutureDatedEmails = function() {
	// when will the next ding happen?
	if (player.ship.docked) {
		var next = 0;
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].TransmitDate &gt; clock.seconds &amp;&amp; (this._emails[i].TransmitDate - clock.seconds) &gt; next) {
				next = (this._emails[i].TransmitDate - clock.seconds);
				// update the receipt planet and the trace of all future dated emails, so when they arrive
				// they have the correct values
				if (this._emails[i].GalaxyNum === galaxyNumber) {
					this._emails[i].ReceivedPlanet = System.systemNameForID(system.ID);
					this._emails[i].Trace = this.$populateTrace(System.systemIDForName(this._emails[i].OriginatingPlanet));
				}
			}
		}
		if (next &gt; 0) {
			if (!this._newMailAlert || this._newMailAlert.isRunning === false)
				this._newMailAlert = new Timer(this, this.$newMailArrived, next, 0);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// play the new mail message noise
this.$newMailArrived = function $newMailArrived() {
	this._updateRequired = true;
	var mySound = new SoundSource;
	mySound.sound = &quot;ding.ogg&quot;;
	mySound.loop = false;
	mySound.play();
	player.consoleMessage(expandDescription(&quot;[emailnewitem]&quot;));
	// check for any more emails
	this.$checkForFutureDatedEmails();
}

//-------------------------------------------------------------------------------------------------------------
// returns the next ID number for new emails
this.$nextID = function() {
	var iMax = 0;
	if (this._emails != null &amp;&amp; this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].ID &gt; iMax) iMax = this._emails[i].ID;
		}
	}
	return (iMax + 1);
}

//-------------------------------------------------------------------------------------------------------------
// this function should only be called when an email is created. Once created, it will be populated from the missionvariables store
this.$populateTrace = function(startPoint) {
	// get list of planets between start and end points
	var sysID = system.ID;
	if (system.ID === -1) sysID = player.ship.targetSystem;
	var myRoute = System.infoForSystem(galaxyNumber, sysID).routeToSystem(System.infoForSystem(galaxyNumber, startPoint), &quot;OPTIMIZED_BY_TIME&quot;);
	// expand and reverse list for storage
	var ret = &quot;&quot;;
	if (myRoute != null) {
		for (var i = 0; i &lt; myRoute.route.length; i++) {
			if (i &gt; 0) {
				ret += &quot;,&quot;;
			}
			ret = ret + System.systemNameForID(myRoute.route[i]);
		}
	} else {
		ret = &quot;&lt;&lt; Error: Trace unavailable &gt;&gt;&quot;;
	}
	return ret;
}

//-------------------------------------------------------------------------------------------------------------
// deletes oldest emails from array until the count is less than archive total
this.$deleteOldest = function() {
	function compare(a,b) {
		return a.TransmitDate - b.TransmitDate;
	}

	// look for and delete any expired emails first
	for (var i = this._emails.length - 1; i &gt;= 0; i--) {
		if (this._emails[i].ExpiryDate != 0 &amp;&amp; clock.seconds &gt; this._emails[i].ExpiryDate &amp;&amp; this._emails[i].ExpiryText === &quot;&quot;) {
			this._emails.splice(i, 1);
		}
	}

	if (this._emails.length &gt; this._archiveLimit) {
		// sort emails oldest to newest
		this._emails.sort(compare);
		var idx = 0;
		do {
			// only delete if there isn&#39;t a response required
			if (this.$requiresResponse(this._emails[idx]) === false) this._emails.splice(idx, 1);
			idx += 1;
			// if the player has 100 emails that require a response, we might still end up with an array greater than 100
			// so watch for that case here
			if (idx &gt;= this._emails.length) break;

		} while (this._emails.length &gt; this._archiveLimit);
	}

}

//-------------------------------------------------------------------------------------------------------------
// returns the email based on ID number
this.$getEmailByID = function(id) {
	for (var i = 0; i &lt; this._emails.length; i++) {
		if (this._emails[i].ID === id) return this._emails[i];
	}
	return null;
}

//-------------------------------------------------------------------------------------------------------------
// returns the email based on ID number
this.$getEmailIndexByID = function(id) {
	for (var i = 0; i &lt; this._emails.length; i++) {
		if (this._emails[i].ID === id) return i;
	}
	return -1;
}

//-------------------------------------------------------------------------------------------------------------
this.$findNextEmailID = function(id) {
	var ret = -1;
	for (var i = 0; i &lt; this._emails.length; i++) {
		if (this._emails[i].ID === id &amp;&amp; i &lt; (this._emails.length - 1)) ret = this._emails[i + 1].ID;
	}
	return ret;
}

//-------------------------------------------------------------------------------------------------------------
// executes the callback function of the selected response
this.$executeCallback = function(id, optionNumber) {
	var email = this.$getEmailByID(id);

	switch (optionNumber) {
		case 1:
			if (email.ResponseOption1.CallbackFunction != &quot;&quot;) {
				var w = worldScripts[email.ResponseOption1.WorldScriptsName];
				if (w) w[email.ResponseOption1.CallbackFunction](email.ResponseOption1.FunctionParam);

			}
			break;
		case 2:
			if (email.ResponseOption2.CallbackFunction != &quot;&quot;) {
				var w = worldScripts[email.ResponseOption2.WorldScriptsName];
				if (w) w[email.ResponseOption2.CallbackFunction](email.ResponseOption2.FunctionParam);
			}
			break;
		case 3:
			if (email.ResponseOption3.CallbackFunction != null) {
				var w = worldScripts[email.ResponseOption3.WorldScriptsName];
				if (w) w[email.ResponseOption3.CallbackFunction](email.ResponseOption3.FunctionParam);
			}
			break;
		case 4:
			if (email.ResponseOption4.CallbackFunction != null) {
				var w = worldScripts[email.ResponseOption4.WorldScriptsName];
				if (w) w[email.ResponseOption4.CallbackFunction](email.ResponseOption4.FunctionParam);
			}
			break;
	}
}

//-------------------------------------------------------------------------------------------------------------
// counts the total number of emails viewable in the inbox
this.$totalItems = function() {
	var itms = 0;
	if (this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].TransmitDate &lt;= clock.seconds) itms += 1;
		}
	}
	return itms;
}

//-------------------------------------------------------------------------------------------------------------
// counts the total number of marked emails
this.$totalItemsMarked = function() {
	var itms = 0;
	if (this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].Marked === true) itms += 1;
		}
	}
	return itms;
}

//-------------------------------------------------------------------------------------------------------------
// counts how many read items are in the inbox
this.$totalReadItems = function() {
	var itms = 0;
	if (this._emails != null &amp;&amp; this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].Read === true &amp;&amp; this._emails[i].TransmitDate &lt;= clock.seconds) itms += 1;
		}
	}
	return itms;
}

//-------------------------------------------------------------------------------------------------------------
// counts how many unread items are in the inbox
this.$totalUnreadItems = function() {
	var itms = 0;
	if (this._emails != null &amp;&amp; this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].Read === false &amp;&amp; this._emails[i].TransmitDate &lt;= clock.seconds) itms += 1;
		}
	}
	return itms;
}

//-------------------------------------------------------------------------------------------------------------
// counts how many unread items requiring a response are in the inbox
this.$totalUnreadItemsRequiringResponse = function() {
	var itms = 0;
	if (this._emails != null &amp;&amp; this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].Read === false &amp;&amp; this._emails[i].TransmitDate &lt;= clock.seconds &amp;&amp; this._emails[i].ExpiryDate &gt; clock.adjustedSeconds &amp;&amp; this.$requiresResponse(this._emails[i]) === true) itms += 1;
		}
	}
	return itms;
}

//-------------------------------------------------------------------------------------------------------------
// marks all items read
this.$markAllItemsRead = function() {
	if (this._emails != null &amp;&amp; this._emails.length &gt; 0) {
		for (var i = 0; i &lt; this._emails.length; i++) {
			if (this._emails[i].Read === false &amp;&amp; this._emails[i].TransmitDate &lt;= clock.seconds) this._emails[i].Read = true;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// checks whether the current item is marked
this.$isItemMarked = function(id) {
	var email = this.$getEmailByID(id);
	if (email.Marked === true) {
		return true;
	} else {
		return false;
	}
}

//-------------------------------------------------------------------------------------------------------------
// marks the currently selected item
this.$markItem = function(id) {
	var email = this.$getEmailByID(id);
	email.Marked = true;
}

//-------------------------------------------------------------------------------------------------------------
// unmarks the currently selected item
this.$unmarkItem = function(id) {
	var email = this.$getEmailByID(id);
	email.Marked = false;
}

//-------------------------------------------------------------------------------------------------------------
// deletes the currently selected item
this.$deleteSelectedItem = function(id) {
	if (this._emails.length &gt; 0 &amp;&amp; id &gt; 0) {
		var idx = this.$getEmailIndexByID(id);
		if (this.$requiresResponse(this._emails[idx]) === false || this._emails[idx].ExpiryDate &lt; clock.adjustedSeconds) {
			this._emails.splice(idx, 1);
			this._maxpage = Math.ceil(this.$totalItems() / this._msRows);
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// deletes all marked emails that don&#39;t have a pending response
this.$deleteMarkedItems = function() {
	if (this._emails.length &gt; 0 &amp;&amp; this.$totalItemsMarked() &gt; 0) {
		for (var i = this._emails.length - 1; i &gt;= 0; i--) {
			if (this._emails[i].Marked === true &amp;&amp; this.$requiresResponse(this._emails[i]) === false) {
				this._emails.splice(i, 1);
			}
		}
		this._curpage = 0;
		this._maxpage = Math.ceil(this.$totalItems() / this._msRows);
	}
}

//-------------------------------------------------------------------------------------------------------------
// deletes all marked emails that don&#39;t have a pending response
this.$deleteReadItems = function() {
	if (this._emails.length &gt; 0 &amp;&amp; this.$totalReadItems() &gt; 0) {
		for (var i = this._emails.length - 1; i &gt;= 0; i--) {
			if (this._emails[i].Read === true &amp;&amp; this.$requiresResponse(this._emails[i]) === false) {
				this._emails.splice(i, 1);
			}
		}
		this._curpage = 0;
		this._maxpage = Math.ceil(this.$totalItems() / this._msRows);
	}
}

//-------------------------------------------------------------------------------------------------------------
// deletes all emails that don&#39;t have a pending response.
this.$deleteAllItems = function() {
	for (var i = this._emails.length - 1; i &gt;= 0; i--) {
		// only delete emails that are in the past
		if (this.$requiresResponse(this._emails[i]) === false &amp;&amp; this._emails[i].TransmitDate &lt;= clock.seconds) {
			this._emails.splice(i, 1);
		}
	}
	this._curpage = 0;
	this._maxpage = 1;
}

//-------------------------------------------------------------------------------------------------------------
// records the index of the response against the selected email
this.$recordResponse = function(id, option) {
	var email = this.$getEmailByID(id);
	email.ChosenOption = option;
	email.ResponseDate = clock.seconds;
}

//-------------------------------------------------------------------------------------------------------------
// Returns the header details of the email formatted for display
this.$header = function(email) {

	var text = &quot;&quot;;

	text += this.$padTextRight(&quot;From:&quot;, 5) + email.Sender + &quot;\n&quot;;
	text += this.$padTextRight(&quot;Sent:&quot;, 5) + clock.clockStringForTime(email.TransmitDate)
	// add the galaxy number if the email was received in a different galaxy to the one the player is in now.
	if (galaxyNumber != email.GalaxyNum) text += &quot; (G&quot; + (email.GalaxyNum + 1) + &quot;)&quot;;
	text += &quot;\n&quot;;
	// expiry date
	if (email.ExpiryDate != 0) {
		text += this.$padTextRight(&quot;Expires:&quot;, 5);
		if (email.ExpiryDate &gt; clock.seconds) {
			text += clock.clockStringForTime(email.ExpiryDate) + &quot;\n&quot;;
		} else {
			text += email.ExpiryText + &quot;\n&quot;;
		}
	}

	text += this.$padTextRight(&quot;Subject:&quot;, 5) + email.Subject + &quot;\n&quot;;
	text += this.$duplicate(&quot;-&quot;, 32) + &quot;\n&quot;;

	return text;
}

//-------------------------------------------------------------------------------------------------------------
// checks whether a response is required for this email.
// Returns true if there is a response and none has been selected, otherwise false.
this.$requiresResponse = function(email) {
	var ret = false;
	if ((email.ResponseOption1.DisplayText != &quot;&quot; || email.ResponseOption2.DisplayText != &quot;&quot; || email.ResponseOption3.DisplayText != &quot;&quot; || email.ResponseOption4.DisplayText != &quot;&quot;) &amp;&amp; email.ChosenOption === 0) {
		ret = true;
	}
	return ret;
}

//-------------------------------------------------------------------------------------------------------------
// returns the inbox line for this email
this.$inboxDisplay = function(email) {

	var ret = &quot;&quot;;

	if (email.Read === false) {
		ret += this.$padTextRight(&quot;!&quot;, this._readColumn);
	} else {
		ret += this.$padTextRight(&quot;&quot;, this._readColumn);
	}

	ret += this.$padTextRight(email.Sender, 10);
	ret += this.$padTextRight(this.$inboxTime(clock.clockStringForTime(email.TransmitDate)), 7.6);
	ret += this.$padTextRight(email.Subject, 14);

	return ret;
}

//-------------------------------------------------------------------------------------------------------------
// appends space to currentText to the specified length in &#39;em&#39;
this.$padTextRight = function(currentText, desiredLength) {
	if (currentText == null) currentText = &quot;&quot;;
	var hairSpace = String.fromCharCode(31);
	var currentLength = defaultFont.measureString(currentText);
	var hairSpaceLength = defaultFont.measureString(hairSpace);
	var ellip = &quot;…&quot;;
	// calculate number needed to fill remaining length
	var padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
	if (padsNeeded &lt; 1)	{
		// text is too long for column, so start pulling characters off
		var tmp = currentText;
		do {
			tmp = tmp.substring(0, tmp.length - 2) + ellip;
			if (tmp === ellip) break;
		} while (defaultFont.measureString(tmp) &gt; desiredLength);
		currentLength = defaultFont.measureString(tmp);
		padsNeeded = Math.floor((desiredLength - currentLength) / hairSpaceLength);
		currentText = tmp;
	}
	if (padsNeeded &lt; 0) padsNeeded = 0;
	// quick way of generating a repeated string of that number
	return currentText + new Array(padsNeeded).join(hairSpace);
}

//-------------------------------------------------------------------------------------------------------------
// works out whether a particular option should be displayed or not
this.$displayResponseOption = function(email, itemNumber) {

	var bShow = false;

	switch (itemNumber) {
		case 1:
			if (email.ResponseOption1 != null &amp;&amp; email.ResponseOption1.DisplayText != &quot;&quot;) bShow = true;
			// if the expiry is turned off but this option was included as an expiry option, don&#39;t show it
			if (email.ExpiryDate === 0 &amp;&amp; email.ExpiryOptions.indexOf(&quot;1&quot;) &gt;= 0) bShow = false;
			if (email.ExpiryDate != 0) {
				// don&#39;t show this option if it&#39;s an expiry option
				if (email.ExpiryDate &gt; clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;1&quot;) &gt;= 0) bShow = false;
				// don&#39;t show this option if the email has expired and it&#39;s not included in the expiry options
				if (email.ExpiryDate &lt;= clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;1&quot;) &lt; 0) bShow = false;
			}
			break;
		case 2:
			if (email.ResponseOption2 != null &amp;&amp; email.ResponseOption2.DisplayText != &quot;&quot;) bShow = true;
			// if the expiry is turned off but this option was included as an expiry option, don&#39;t show it
			if (email.ExpiryDate === 0 &amp;&amp; email.ExpiryOptions.indexOf(&quot;2&quot;) &gt;= 0) bShow = false;
			if (email.ExpiryDate != 0) {
				// don&#39;t show this option if it&#39;s an expiry option
				if (email.ExpiryDate &gt; clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;2&quot;) &gt;= 0) bShow = false;
				// don&#39;t show this option if the email has expired and it&#39;s not included in the expiry options
				if (email.ExpiryDate &lt;= clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;2&quot;) &lt; 0) bShow = false;
			}
			break;
		case 3:
			if (email.ResponseOption3 != null &amp;&amp; email.ResponseOption3.DisplayText != &quot;&quot;) bShow = true;
			// if the expiry is turned off but this option was included as an expiry option, don&#39;t show it
			if (email.ExpiryDate === 0 &amp;&amp; email.ExpiryOptions.indexOf(&quot;3&quot;) &gt;= 0) bShow = false;
			if (email.ExpiryDate != 0) {
				// don&#39;t show this option if it&#39;s an expiry option
				if (email.ExpiryDate &gt; clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;3&quot;) &gt;= 0) bShow = false;
				// don&#39;t show this option if the email has expired and it&#39;s not included in the expiry options
				if (email.ExpiryDate &lt;= clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;3&quot;) &lt; 0) bShow = false;
			}
			break;
		case 4:
			if (email.ResponseOption4 != null &amp;&amp; email.ResponseOption4.DisplayText != &quot;&quot;) bShow = true;
			// if the expiry is turned off but this option was included as an expiry option, don&#39;t show it
			if (email.ExpiryDate === 0 &amp;&amp; email.ExpiryOptions.indexOf(&quot;4&quot;) &gt;= 0) bShow = false;
			if (email.ExpiryDate != 0) {
				// don&#39;t show this option if it&#39;s an expiry option
				if (email.ExpiryDate &gt; clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;4&quot;) &gt;= 0) bShow = false;
				// don&#39;t show this option if the email has expired and it&#39;s not included in the expiry options
				if (email.ExpiryDate &lt;= clock.seconds &amp;&amp; email.ExpiryOptions.indexOf(&quot;4&quot;) &lt; 0) bShow = false;
			}
			break;
	}

	return bShow;
}

//-------------------------------------------------------------------------------------------------------------
// duplicates text until it is just less than the desired length;
this.$duplicate = function(text, desiredLength) {
	var res = &quot;&quot;;

	do {
		res += text;
	} while (defaultFont.measureString(res) &lt; desiredLength);

	res = res.substring(1, res.length);
	return res;
}

//-------------------------------------------------------------------------------------------------------------
// adds a message to an array, splitting the lines based on a line width
this.$addMsgToArray = function(msg, ary, linewidth) {

	var prt = &quot; &quot;;
	if (msg.substring(0,1) === &quot;~&quot; || msg.substring(0,1) === &quot;-&quot;) {
		// don&#39;t indent this one
		prt = &quot;&quot;;
		// remove the &quot;~&quot; char
		if (msg.substring(0,1) === &quot;~&quot;) msg = msg.substring(1, msg.length);
	}

	if (defaultFont.measureString(msg) &gt; linewidth) {
		var words = msg.split(&quot; &quot;);
		var iPoint = 0
		var nextWord = &quot;&quot;;
		do {
			// add the space in (after the first word)
			if (prt != &quot;&quot;)  prt += &quot; &quot;;

			// add the word on
			prt = prt + words[iPoint];
			// get the next word in the array
			if (iPoint &lt; words.length - 1) {
				nextWord = &quot; &quot; + words[iPoint + 1];
			} else {
				nextWord = &quot;&quot;
			}
			// check the width of the next with the nextword added on
			if (defaultFont.measureString(prt + nextWord) &gt; linewidth) {
				// hit the max width - add the line and start again
				ary.push(prt);
				prt = &quot;&quot;;
			}
			iPoint += 1;
			// check for the end of the array, and output remaining text
			if ((iPoint &gt;= words.length) &amp;&amp; (prt.trim() != &quot;&quot;)) ary.push(prt);

		} while (iPoint &lt; words.length);
	} else {
		ary.push(prt + msg);
	}
}

//=============================================================================================================
// screen interfaces
this.$initInterface = function(station) {

	var unread = &quot;&quot;;
	var itms = this.$totalUnreadItems();
	if (itms &gt; 0) unread = &quot; (&quot; + itms.toString() + &quot; unread&quot; + (this.$totalUnreadItemsRequiringResponse() &gt; 0 ? &quot; •&quot; : &quot;&quot;) + &quot;)&quot;

	station.setInterface(this.name,{
		title:&quot;Email system&quot; + unread,
		category:expandDescription(&quot;[interfaces-category-logs]&quot;),
		summary:&quot;Opens your email inbox&quot;,
		callback:this.$showInbox.bind(this)
	});

}

//=============================================================================================================
// inbox
this.$showInbox = function() {
	this._emailID = 0;
	this._emailIndex = 0;
	this._maxpage = Math.ceil(this.$totalItems() / this._msRows);
	this._curpage = 0;
	this._displayType = 0;
	this.$showPage();
}

//-------------------------------------------------------------------------------------------------------------
this.$showPage = function() {
	function compare(a,b) {
		return b.TransmitDate - a.TransmitDate;
	}

	this._hudHidden = player.ship.hudHidden;
	if (this.$isBigGuiActive() === false) player.ship.hudHidden = true;
	this._emailOpen = true;

	var text = &quot;&quot;;
	var opts;
	var curChoices = {};
	var def = &quot;&quot;;

	//=============================================================================================================
	// inbox view
	if (this._displayType === 0) {
		// sort the inbox by date, newest to oldest
		this._emails.sort(compare);
		this._emailPage = 0;

		var expired = false;
		// look for and delete any expired emails
		for (var i = this._emails.length - 1; i &gt;= 0; i--) {
			if (this._emails[i].ExpiryDate != 0 &amp;&amp; clock.seconds &gt; this._emails[i].ExpiryDate &amp;&amp; this._emails[i].ExpiryText === &quot;&quot;) {
				this._emails.splice(i, 1);
				expired = true;
			}
		}

		// adjust the max page if we remove any expired emails
		if (expired) this._maxpage = Math.ceil(this.$totalItems() / this._msRows);

		curChoices = this.$inboxPageChoices(this._curpage, this._msRows);

		// make sure the selected email stays selected, in case new emails arrived while we were viewing another email
		if (this._emailID != 0 &amp;&amp; this._emailIndex != this.$getChoiceItemIndex(this._emailID)) {
			var old = this._emailIndex;
			this._emailIndex = this.$getChoiceItemIndex(this._emailID);
			if (this._emailIndex === 0 &amp;&amp; old === this._msRows) {
				// we&#39;ve been bumped to a new page, so switch to it
				this._curpage += 1;
				curChoices = this.$inboxPageChoices(this._curpage, this._msRows);
				this._emailIndex = this.$getChoiceItemIndex(this._emailID);
			}
			this._lastChoice[this._displayType] = &quot;01_email-&quot; + (this._emailIndex &lt; 10 ? &quot;0&quot; : &quot;&quot;) + this._emailIndex + &quot;+&quot; + this._emailID;
		}

		this._emailID = 0;

		text = this.$padTextRight(&quot;&quot;, this._readColumn + 0.15);
		text += this.$padTextRight(&quot;From&quot;, 10);
		text += this.$padTextRight(&quot;Date&quot;, 7.6);
		text += &quot;Subject&quot;;
		if (this._itemsOnPage === 0) text += &quot;\n\n(no items to display)&quot;;

		for (var i = 0; i &lt; (this._msRows + 1) - this._itemsOnPage; i++) {
			curChoices[&quot;02_SPACER_&quot; + i] = &quot;&quot;;
		}

		var def = &quot;99_EXIT&quot;;

		if (this._emails != null &amp;&amp; this._emails.length != 0) {
			if (this._curpage &lt; this._maxpage - 1) {
				curChoices[&quot;10_GOTONEXT&quot;] = {text:&quot;[emailopt_nextpage]&quot;, color:this._menuColor};
			} else {
				curChoices[&quot;10_GOTONEXT&quot;] = {text:&quot;[emailopt_nextpage]&quot;, color:this._disabledColor, unselectable:true};
			}
			if (this._curpage &gt; 0) {
				curChoices[&quot;11_GOTOPREV&quot;] = {text:&quot;[emailopt_prevpage]&quot;, color:this._menuColor};
			} else {
				curChoices[&quot;11_GOTOPREV&quot;] = {text:&quot;[emailopt_prevpage]&quot;, color:this._disabledColor, unselectable:true};
			}
			if (this.$totalReadItems() &gt; 0) {
				curChoices[&quot;42_MARKALLREAD&quot;] = {text:&quot;[emailopt_markallread]&quot;, color:this._menuColor};
				curChoices[&quot;45_DELREAD&quot;] = {text:&quot;[emailopt_deleteread]&quot;, color:this._menuColor};
			} else {
				curChoices[&quot;42_MARKALLREAD&quot;] = {text:&quot;[emailopt_markallread]&quot;, color:this._disabledColor, unselectable:true};
				curChoices[&quot;45_DELREAD&quot;] = {text:&quot;[emailopt_deleteread]&quot;, color:this._disabledColor, unselectable:true};
			}
			curChoices[&quot;50_DELALL&quot;] = {text:&quot;[emailopt_deleteall]&quot;, color:this._menuColor};
		} else {
			curChoices[&quot;10_GOTONEXT&quot;] = {text:&quot;[emailopt_nextpage]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;11_GOTOPREV&quot;] = {text:&quot;[emailopt_prevpage]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;42_MARKALLREAD&quot;] = {text:&quot;[emailopt_markallread]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;45_DELREAD&quot;] = {text:&quot;[emailopt_deleteread]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;50_DELALL&quot;] = {text:&quot;[emailopt_deleteall]&quot;, color:this._disabledColor, unselectable:true};
		}

		curChoices[&quot;99_EXIT&quot;] = {text:&quot;[emailopt_exit]&quot;, color:this._exitColor};

		var opts = {
			screenID: &quot;oolite-emailsystem-main-map&quot;,
			title: &quot;Inbox - page &quot; + (this._curpage + 1).toString() + &quot; of &quot; + this._maxpage.toString(),
			allowInterrupt: true,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			overlay: {name:&quot;email-message.png&quot;, height:546},
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	//=============================================================================================================
	// email item
	if (this._displayType === 1) {
		var email = this.$getEmailByID(this._emailID);

		var headerlen = 4;
		if (email.ExpiryDate !=0 &amp;&amp; email.ExpiryDate &gt; clock.seconds) {
			headerlen += 1; // extra line if expiry date is still current
			if (email.allowExpiryCancel) headerlen +=1; // another line for the &quot;Cancel expiry&quot; option
		}

		email.Read = true;

		text += this.$header(email);

		var lines = email.EmailBody.split(&quot;\n&quot;);
		var dest = [];

		for (var i = 0; i &lt; lines.length; i++) {
			this.$addMsgToArray(lines[i], dest, this._msCols);
		}

		// append any response to the body of the email
		if (email.ChosenOption &gt; 0) {
			var resp = &quot;&quot;;
			resp += &quot;\n&quot;;
			resp += &quot;~&quot; + this.$duplicate(&quot;-&quot;, 32) + &quot;\n&quot;;
			resp += &quot;~&quot; + this.$padTextRight(&quot;Reply sent:&quot;, 5) + clock.clockStringForTime(email.ResponseDate) + &quot;\n&quot;;
			resp += &quot;~Reply:\n\n&quot;;

			switch (email.ChosenOption) {
				case 1:
					resp += email.ResponseOption1.ReplyText;
					break;
				case 2:
					resp += email.ResponseOption2.ReplyText;
					break;
				case 3:
					resp += email.ResponseOption3.ReplyText;
					break;
				case 4:
					resp += email.ResponseOption4.ReplyText;
					break;
			}
			var respLines = resp.split(&quot;\n&quot;);
			for (var i = 0; i &lt; respLines.length; i++) {
				this.$addMsgToArray(respLines[i], dest, this._msCols);
			}
		}

		var addText = &quot;&quot;;
		var iPageHeight = 16 + (4 - headerlen);
		this._emailMaxPages = 0;

		// check if
		if (dest.length &gt; iPageHeight &amp;&amp; this.$requiresResponse(email) === true) {
			// how many options are there?
			var iRespCount = 0;
			if ($displayResponseOption(email, 1)) iRespCount += 1;
			if ($displayResponseOption(email, 2)) iRespCount += 1;
			if ($displayResponseOption(email, 3)) iRespCount += 1;
			if ($displayResponseOption(email, 4)) iRespCount += 1;

			// reduce the page height by the number of responses
			iPageHeight -= iRespCount;
		}

		if (dest.length &gt; iPageHeight) {
			this._emailMaxPages = Math.ceil(dest.length / iPageHeight);
			addText = &quot; (Page &quot; + (this._emailPage + 1).toString() + &quot; of &quot; + this._emailMaxPages.toString() + &quot;)&quot;;
		}
		var iStart = this._emailPage * iPageHeight; // when 0 then 0, when 1 then 16
		var iEnd = this._emailPage * iPageHeight + iPageHeight; // when 0 then 16, when 1 then 32 etc
		if (iEnd &gt; dest.length) {
			iEnd = dest.length;
		}
		for (var i = iStart; i &lt;= iEnd - 1; i++) {
			text += dest[i] + &quot;\n&quot;;
		}

		def = &quot;23_CLOSE&quot;;

		if (this._emailMaxPages != 0) {
			if (this._emailPage + 1 &lt; this._emailMaxPages) {
				curChoices[&quot;21_NEXTPAGE&quot;] = {text:&quot;[emailitem_nextpage]&quot;, color:this._menuColor};
				def = &quot;21_NEXTPAGE&quot;;
			} else {
				curChoices[&quot;21_NEXTPAGE&quot;] = {text:&quot;[emailitem_nextpage]&quot;, color:this._disabledColor, unselectable:true};
			}
			if (this._emailPage &gt; 0) {
				curChoices[&quot;22_PREVPAGE&quot;] = {text:&quot;[emailitem_prevpage]&quot;, color:this._menuColor};
			} else {
				curChoices[&quot;22_PREVPAGE&quot;] = {text:&quot;[emailitem_prevpage]&quot;, color:this._disabledColor, unselectable:true};
			}
		}
		// if the force response option is turned on, disable all the close email options, so the player has to make a choice
		if (email.ForceResponse === true &amp;&amp; email.ChosenOption === 0) {
			curChoices[&quot;23_CLOSE&quot;] = {text:&quot;[emailitem_close]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;23A_CLOSEOPEN&quot;] = {text:&quot;[emailitem_closeopen]&quot;, color:this._disabledColor, unselectable:true};
			curChoices[&quot;24_CLOSEDEL&quot;] = {text:&quot;[emailitem_closedelete]&quot;, color:this._disabledColor, unselectable:true};
		} else {
			curChoices[&quot;23_CLOSE&quot;] = {text:&quot;[emailitem_close]&quot;, color:this._menuColor};
			if (this.$findNextEmailID(this._emailID) &gt;= 0) {
				curChoices[&quot;23A_CLOSEOPEN&quot;] = {text:&quot;[emailitem_closeopen]&quot;, color:this._menuColor};
			} else {
				curChoices[&quot;23A_CLOSEOPEN&quot;] = {text:&quot;[emailitem_closeopen]&quot;, color:this._disabledColor, unselectable:true};
			}
			if (this.$requiresResponse(email) === true &amp;&amp; email.ExpiryDate &gt; clock.seconds &amp;&amp; email.ChosenOption === 0) {
				curChoices[&quot;24_CLOSEDEL&quot;] = {text:&quot;[emailitem_closedelete]&quot;, color:this._disabledColor, unselectable:true};
			} else {
				curChoices[&quot;24_CLOSEDEL&quot;] = {text:&quot;[emailitem_closedelete]&quot;, color:this._menuColor};
			}
		}
		curChoices[&quot;25_TRACE&quot;] = {text:&quot;[emailitem_trace]&quot;, color:this._menuColor};
		if (email.ExpiryDate != 0 &amp;&amp; email.ExpiryDate &gt; clock.seconds &amp;&amp; email.AllowExpiryCancel === true) {
			curChoices[&quot;25A_CANCELEXPIRY&quot;] = {text:&quot;[emailitem_cancelexpiry]&quot;, color:this._menuColor};
		}

		if (email.ChosenOption === 0) {
			if (this.$displayResponseOption(email, 1)) curChoices[&quot;26_OPT1&quot;] = {text:&quot;Send &#39;&quot; + email.ResponseOption1.DisplayText + &quot;&#39; response&quot;, color:this._menuColor};
			if (this.$displayResponseOption(email, 2)) curChoices[&quot;26_OPT2&quot;] = {text:&quot;Send &#39;&quot; + email.ResponseOption2.DisplayText + &quot;&#39; response&quot;, color:this._menuColor};
			if (this.$displayResponseOption(email, 3)) curChoices[&quot;26_OPT3&quot;] = {text:&quot;Send &#39;&quot; + email.ResponseOption3.DisplayText + &quot;&#39; response&quot;, color:this._menuColor};
			if (this.$displayResponseOption(email, 4)) curChoices[&quot;26_OPT4&quot;] = {text:&quot;Send &#39;&quot; + email.ResponseOption4.DisplayText + &quot;&#39; response&quot;, color:this._menuColor};
		}

		var opts = {
			screenID: &quot;oolite-emailsystem-item-map&quot;,
			title: &quot;Message&quot; + addText,
			allowInterrupt: false,
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			overlay: {name:&quot;email-message_open.png&quot;, height:546},
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
	}

	//=============================================================================================================
	// trace
	if (this._displayType === 2) {
		var email = this.$getEmailByID(this._emailID);

		var initText = &quot;- Received: &quot;;

		text += this.$header(email);

		text += &quot;Trace:\n\n&quot;;
		var planets = email.Trace.split(&quot;,&quot;);
		var bEnd = false;
		var bCrpt = false;
		var colHeight = 16;
		if (planets.length &lt; colHeight) {
			for (var i = 0; i &lt; planets.length; i++) {
				if (planets[i] != &quot;&quot;) {
					text += initText + planets[i] + &quot;\n&quot;;
					initText = &quot;- Sent from: &quot;;
				}
			}
		} else {
			for (var i = 0; i &lt; colHeight; i++) {
				if (planets[i] != &quot;&quot;) {
					text += this.$padTextRight(initText + planets[i], 10);
					initText = &quot;- Sent from: &quot;;
					if (i + colHeight &lt; planets.length) {
						if (planets[i + colHeight] != &quot;&quot;) {
							text += this.$padTextRight(&quot;- Sent from: &quot; + planets[i + colHeight], 10);
						}
					}
					if (i + colHeight === planets.length) {
						if (email.CorruptTrace === true) {
							text += &quot;- Routing ticket corrupt&quot;;
							bCrpt = true;
						}
					}
					if (i + (colHeight * 2) &lt; planets.length) {
						if (planets[i + (colHeight * 2)] != &quot;&quot;) {
							text += this.$padTextRight(&quot;- Sent from: &quot; + planets[i + (colHeight * 2)], 10);
						}
					}
					if (i + (colHeight * 2) === planets.length) {
						if (email.CorruptTrace === true) {
							text += &quot;- Routing ticket corrupt&quot;;
							bCrpt = true;
						}
					}
					text += &quot;\n&quot;;
				}
			}
		}
		if (email.CorruptTrace === true) {
			if (bCrpt === false) {
				text += &quot;- Routing ticket corrupt\n&quot;;
			}
			text += &quot;\nTrace incomplete.&quot;;
		} else if (bEnd === false){
			text += &quot;\nTrace complete.&quot;;
		}
		def = &quot;27_CLOSE&quot;;

		curChoices[&quot;27_CLOSE&quot;] = {text:&quot;[emailtrace_close]&quot;, color:this._exitColor};

		var opts = {
			screenID: &quot;oolite-emailsystem-trace-summary&quot;,
			title: expandDescription(&quot;[emailtrace_title]&quot;),
			allowInterrupt: false,
			overlay: {name:&quot;email-message_open.png&quot;, height:546},
			exitScreen: &quot;GUI_SCREEN_INTERFACES&quot;,
			choices: curChoices,
			initialChoicesKey: (this._lastChoice[this._displayType] != &quot;&quot; ? this._lastChoice[this._displayType] : def),
			message: text
		};
		planets = [];
	}

	mission.runScreen(opts, this.$inboxHandler, this);
}

//-------------------------------------------------------------------------------------------------------------
this.$inboxHandler = function(choice) {

	var curdisplay = this._displayType;
	var newChoice = &quot;&quot;;
	var newChoicePage = 0;
	
	this._lastChoice[this._displayType] = choice;

	if (!choice) {
		return; // launched while reading?
	} else if (choice.indexOf(&quot;01_email&quot;) &gt;= 0) {
		this._emailID = parseInt(choice.substring(choice.indexOf(&quot;+&quot;) + 1));
		this._emailIndex = parseInt(choice.substring(choice.indexOf(&quot;-&quot;) + 1, choice.indexOf(&quot;+&quot;)));
		this._emailPage = 0;
		this._displayType = 1;
	} else if (choice === &quot;11_GOTOPREV&quot;) {
		this._curpage -= 1;
		if (this._curpage === 0) {
			newChoice = &quot;10_GOTONEXT&quot;;
			newChoicePage = this._displayType;
		}
	} else if (choice === &quot;10_GOTONEXT&quot;) {
		this._curpage += 1;
		if (this._curpage === this._maxpage - 1) {
			newChoice = &quot;11_GOTOPREV&quot;;
			newChoicePage = this._displayType;
		}
	} else if (choice === &quot;42_MARKALLREAD&quot;) {
		this.$markAllItemsRead();
	} else if (choice === &quot;45_DELREAD&quot;) {
		this.$deleteReadItems();
	} else if (choice === &quot;50_DELALL&quot;) {
		this.$deleteAllItems();
	} else if (choice === &quot;21_NEXTPAGE&quot;) {
		this._emailPage += 1;
		if ((this._emailPage - 1) === this._emailMaxPages) {
			newChoice = &quot;22_PREVPAGE&quot;;
			newChoicePage = this._displayType;
		}
	} else if (choice === &quot;22_PREVPAGE&quot;) {
		this._emailPage -= 1;
		if (this._emailPage === 0) {
			newChoice = &quot;21_NEXTPAGE&quot;;
			newChoicePage = this._displayType;
		}
	} else if (choice === &quot;23_CLOSE&quot;) {
		this._displayType = 0;
	} else if (choice === &quot;23A_CLOSEOPEN&quot;) {
		this._emailPage = 0;
		// get next email id
		this._emailID = this.$findNextEmailID(this._emailID);
		// if this the last item on the page?
		if (this._emailIndex === this._msRows &amp;&amp; (this._curpage + 1) &lt; this._maxpage) {
			// we&#39;ve flipped over to the next page
			this._curpage += 1;
			this.$inboxPageChoices(this._curpage, this._msRows);
		}
		this._emailIndex = this.$getChoiceItemIndex(this._emailID)
		newChoice = &quot;01_email-&quot; + (this._emailIndex &lt; 10 ? &quot;0&quot; : &quot;&quot;) + this._emailIndex + &quot;+&quot; + this._emailID;
		newChoicePage = 0;
	} else if (choice === &quot;24_CLOSEDEL&quot;) {
		this._displayType = 0;
		this.$deleteSelectedItem(this._emailID);
	} else if (choice === &quot;25_TRACE&quot;) {
		this._displayType = 2;
	} else if (choice === &quot;25A_CANCELEXPIRY&quot;) {
		this._emails[this.$getEmailIndexByID(this._emailID)].ExpiryDate = 0;
	} else if (choice === &quot;26_OPT1&quot;) {
		// make sure the email hasn&#39;t expired while being viewed
		if (this.$displayResponseOption(this.$getEmailByID(this._emailID), 1)) {
			this.$recordResponse(this._emailID, 1);
			this.$executeCallback(this._emailID, 1);
		}
	} else if (choice === &quot;26_OPT2&quot;) {
		// make sure the email hasn&#39;t expired while being viewed
		if (this.$displayResponseOption(this.$getEmailByID(this._emailID), 2)) {
			this.$recordResponse(this._emailID, 2);
			this.$executeCallback(this._emailID, 2);
		}
	} else if (choice === &quot;26_OPT3&quot;) {
		// make sure the email hasn&#39;t expired while being viewed
		if (this.$displayResponseOption(this.$getEmailByID(this._emailID), 3)) {
			this.$recordResponse(this._emailID, 3);
			this.$executeCallback(this._emailID, 3);
		}
	} else if (choice === &quot;26_OPT4&quot;) {
		// make sure the email hasn&#39;t expired while being viewed
		if (this.$displayResponseOption(this.$getEmailByID(this._emailID), 4)) {
			this.$recordResponse(this._emailID, 4);
			this.$executeCallback(this._emailID, 4);
		}
	} else if (choice === &quot;27_CLOSE&quot;) {
		this._displayType = 1;
	}
	
	if (newChoice != &quot;&quot;) this._lastChoice[newChoicePage] = newChoice;
	
	if (choice != &quot;99_EXIT&quot;) {
		this.$showPage();
	}
}

//-------------------------------------------------------------------------------------------------------------
this.$inboxPageChoices = function(cpage, lines) {
	//var output = &quot;&quot;;

	var iStart = 0;
	var iEnd = 0;
	var offset = 0;
	var choices = {};

	// work out start point - start after any future dated emails
	for (var i = 0; i &lt; this._emails.length; i++) {
		if (this._emails[i].TransmitDate &lt;= clock.seconds) {
			offset = i;
			break;
		}
	}

	// set out initial end point
	iStart = offset;
	iEnd = iStart + lines;
	if (cpage != 0) {
		iStart = (cpage * lines) + offset;
		iEnd = iStart + lines;
	}
	if (iEnd &gt; this._emails.length) {
		iEnd = this._emails.length;
	}

	this._itemsOnPage = 0;

	this._pageItems.length = 0;

	if (this.$totalItems() != 0) {
		for (var i = iStart; i &lt; iEnd; i++) {
			// put an index in the key for sorting, and add the id for selecting
			this._itemsOnPage += 1;
			choices[&quot;01_email-&quot; + (this._itemsOnPage &lt; 10 ? &quot;0&quot; : &quot;&quot;) + this._itemsOnPage + &quot;+&quot; + this._emails[i].ID] = {text:this.$inboxDisplay(this._emails[i]), alignment:&quot;LEFT&quot;, color:this._itemColor};
			this._pageItems.push({ID:this._emails[i].ID, index:this._itemsOnPage});
		}
	}
	return choices;
}

//-------------------------------------------------------------------------------------------------------------
this.$getChoiceItemIndex = function(id) {
	var result = 0;
	if (this._pageItems &amp;&amp; this._pageItems.length &gt; 0) {
		for (var i = 0; i &lt; this._pageItems.length; i++) {
			if (this._pageItems[i].ID === id) result = this._pageItems[i].index;
		}
	}
	return result;
}

//-------------------------------------------------------------------------------------------------------------
this.$inboxTime = function(emailTime) {
	return emailTime.substring(0, emailTime.length - 3);
}

//-------------------------------------------------------------------------------------------------------------
// returns true if a HUD with allowBigGUI is enabled, otherwise false
this.$isBigGuiActive = function() {
	if (oolite.compareVersion(&quot;1.83&quot;) &lt;= 0) {
		return player.ship.hudAllowsBigGui;
	} else {
		var bigGuiHUD = [&quot;XenonHUD.plist&quot;, &quot;coluber_hud_ch01-dock.plist&quot;]; 	// until there is a property we can check, I&#39;ll be listing HUD&#39;s that have the allow_big_gui property set here
		if (bigGuiHUD.indexOf(player.ship.hud) &gt;= 0) {
			return true;
		} else {
			return false;
		}
	}
}
</pre></td>
                </tr>
                <tr>
                    <td valign="top">Scripts/galcopadmin.js</td>
                    <td><pre>&quot;use strict&quot;;
this.name        = &quot;GalCopAdminServices&quot;;
this.author      = &quot;phkb&quot;;
this.copyright   = &quot;2017 phkb&quot;;
this.description = &quot;Transmits emails to player from GalCop admin relating to bounty notifications and other admin processes.&quot;;
this.licence     = &quot;CC BY-NC-SA 4.0&quot;;

/*
	Todo:
	Check for docking fines on other station types (UPS Courier, Jaguar company, The collector, Aquatics, Resistance Commander, Lave Acedemy, FTZ, Planetfall);
	Check for purchase equip on Black Monks Monestary (need different voice for email).

	Ideas:
	Welcome to new galaxy emails
		- Tech Level 15 planets -- G1 Ceesxe, G2 Tezaeded, G3 none (14: LEZAER,BIRERA,LEORENDI,ORZAEDVE,TEEDUS,TIERA,CEDILE), G4 none (14: GEBIISSO,DICEBE),
			G5 Xevera, G6 Diesanen, G7 Quandixe and Maraus, G8 none (14: ESUSALE).
		- List of galactic regions
		- List of galactic routes
		- GalCop HQ&#39;s
		- RRS station HQ locations
		- Superhub locations
		- Gal Navy sector commands

	Constore emails about special deals
	Space bar emails
	Emails from revolutionists, saying &quot;Here&#39;s the details of the conspiracy&quot;
	Emails from Hognose Evangelists telling player about their religion
	Emails containing bargains for trade (ie &quot;trade in Furs between X and Y for a super bargain. Offer won&#39;t last!&quot; X will be system within 7 LY of player, Y will be within 10 LY of X.)
		maybe two different emails: 1 saying nnn commodity is really cheap at X, 1 saying demand for nnn commodity is high at Y
		have an opt in/opt out functionality
		-- seems to be similar to function in NewCargoes OXP, but might be useful as an alternative (ie. if you don&#39;t want NewCargos, you can still get market bargins)
		-- also similar to functionality in BlOomberg markets
*/

this._debug = true;
this._bountyEmailBody = &quot;&quot;;										// holds details of next bounty email
this._bountyEmailTime = 0;										// the time of the last kill
this._bountyEmailTotalCR = 0;									// total amount of bounty
this._boughtEquipTimer = null;
this._killCount = 0;											// total number of kills
this._killAssortedCount = 0;									// total number of non-ship kills (eg missiles)
this._holdBountyEmail = [];										// holds bounty emails across hyperspace jumps
this._disableBounty = false;									// controls whether bounty emails are sent
this._disableDocking = false;									// controls whether docking violation emails are sent
this._disableEscapePods = false;								// controls whether escape pod rescue emails are sent
this._disableContracts = false;									// controls whether contract emails are sent
this._disableFines = false;										// controls whether fine processing emails are sent
this._disableEquipPurchase = false;								// controls whether equipment purchase emails are sent
this._disableMaintenance = false;								// controls whether repair and overhaul emails are sent
this._disableNewShip = false;									// controls whether new ship emails are sent
this._disableEliteFederation = false;							// controls whether changes to player rank are sent
this._defaultExpiryDays = 5;									// default expiry period for emails that expire
this._repairHullDamage = false;									// keeps track of hull damage email (Battle Damage OXP)
this._repairIronHide = false;									// keeps track of iron hide repair emails (IronHide OXP)
this._sendMaintEmail = false;									// keeps track of when we are sending maintenance emails (relates to IronHide OXP)
this._sendRepairEmail = false;									// keeps track of when we are sending repair emails (relates to IronHide OXP)
this._maintCost = 0;
this._maintCostInit = 0;
this._equipItems = [];											// list of equipment items, held in order to determine diff between purchase and repair
this._equipSalesRep = &quot;&quot;;										// name of sales assistant for equipment
this._shipSalesRep = &quot;&quot;;										// name of sales assistant for ships
this._maintRep = &quot;&quot;;											// name of maintenance rep for repair or overhaul emails
this._dutyOfficer = &quot;&quot;;											// station duty officer/flight controller (for docking fines)
this._galCopBountyOfficer = &quot;&quot;;									// name of galcop bounty processor
this._insuranceOfficer = &quot;&quot;;									// name of claims administrator (for escape pod insurance claims)
this._namesLocation = &quot;&quot;;										// keeps track of the system/dock the names are associated with
this._galCopHQ = [7, 33, 26, 49, 102, 85, 202, 184];			// galcop hq locations in each sector
this._fedHQ = [131, 167, 58, 65, 230, 35, 181, 130];			// location of elite federation hq in each sector
this._playerEnteringShipyard = false;							// keeps track of when the player enters the shipyard at a station, so we can check for buying a new ship
this._licenceNumber = &quot;&quot;;										// holds the pilot licence number, in case it&#39;s ever needed
this._maintItemNameReplacements = &quot;&quot;;							// holds list of maint item replacement name keys
this._trueValues = [&quot;yes&quot;, &quot;1&quot;, 1, &quot;true&quot;, true];
this._playerEjected = false;
this._maint_ignore_equip = []; // no longer used, but kept for backwards compatibility.
this._oldPassengerCount = 0;

/* equipment known to have description items for an overhaul email */
this._maint_known_equip = [&quot;EQ_CARGO_BAY&quot;, &quot;EQ_ECM&quot;, &quot;EQ_FUEL_SCOOPS&quot;, &quot;EQ_ESCAPE_POD&quot;, &quot;EQ_ENERGY_UNIT&quot;, &quot;EQ_NAVAL_ENERGY_UNIT&quot;, &quot;EQ_DOCK_COMP&quot;, &quot;EQ_GAL_DRIVE&quot;,
	&quot;EQ_WEAPON_PULSE_LASER&quot;, &quot;EQ_WEAPON_BEAM_LASER&quot;, &quot;EQ_WEAPON_MINING_LASER&quot;, &quot;EQ_WEAPON_MILITARY_LASER&quot;, &quot;EQ_CLOAKING_DEVICE&quot;, &quot;EQ_PASSENGER_BERTH&quot;, &quot;EQ_FUEL_INJECTION&quot;,
	&quot;EQ_SCANNER_SHOW_MISSILE_TARGET&quot;, &quot;EQ_MULTI_TARGET&quot;, &quot;EQ_ADVANCED_COMPASS&quot;, &quot;EQ_ADVANCED_NAVIGATIONAL_ARRAY&quot;, &quot;EQ_TARGET_MEMORY&quot;, &quot;EQ_INTEGRATED_TARGETING_SYSTEM&quot;,
	&quot;EQ_SHIELD_BOOSTER&quot;, &quot;EQ_NAVAL_SHIELD_BOOSTER&quot;, &quot;EQ_HEAT_SHIELD&quot;, &quot;EQ_WORMHOLE_SCANNER&quot;, &quot;EQ_WEAPON_TWIN_PLASMA_CANNON&quot;,
	&quot;EQ_LMSS_FRONT&quot;, &quot;EQ_LMSS_AFT&quot;, &quot;EQ_LMSS_PORT&quot;, &quot;EQ_LMSS_STARBOARD&quot;, &quot;EQ_LMSS_ACTUATOR&quot;];

/* equipment items devoted to repair (not equipment in themselves) */
this._maint_repair_equip = [&quot;EQ_HULL_REPAIR&quot;, &quot;EQ_IRONHIDE_REPAIR&quot;, &quot;EQ_TURRET_RECOVER&quot;, &quot;EQ_SHIP_VERSION_REPAIR&quot;, &quot;EQ_SERVICE_LEVEL_SMALL_FIX_1&quot;,
	&quot;EQ_SERVICE_LEVEL_SMALL_FIX_2&quot;, &quot;EQ_SERVICE_LEVEL_SMALL_FIX_3&quot;, &quot;EQ_SERVICE_LEVEL_SMALL_FIX_4&quot;];

/* equipment items devoted to removal of equipment */
this._maint_remove_equip = [&quot;EQ_PASSENGER_BERTH_REMOVAL&quot;, &quot;EQ_MISSILE_REMOVAL&quot;, &quot;EQ_WEAPON_NONE&quot;];

/* equipment items to be ignored by the email system */
this._purchase_ignore_equip = [&quot;EQ_FUEL&quot;, &quot;EQ_MISSILE&quot;, &quot;EQ_TRUMBLE&quot;, &quot;EQ_RRS_FUEL&quot;, &quot;EQ_SHIP_RESPRAY&quot;, &quot;EQ_SHIP_RESPRAY_180&quot;, &quot;EQ_SMUGGLING_COMPARTMENT&quot;, &quot;EQ_IMPORT_PERMIT&quot;];

// equipment items that will be immediately removed after purchase
this._purchase_removed = [&quot;EQ_IRONHIDE_MIL&quot;, &quot;EQ_REPAIRBOTS_RECHARGE_10&quot;, &quot;EQ_REPAIRBOTS_RECHARGE_5&quot;];

//======================================================================================================================
// Library config
this._galCopAdminConfig = {Name:this.name, Alias:&quot;GalCop Admin Services&quot;, Display:&quot;Config&quot;, Alive:&quot;_galCopAdminConfig&quot;,
	Bool:{
		B0:{Name:&quot;_disableBounty&quot;, Def:false, Desc:&quot;Bounty emails&quot;},
		B1:{Name:&quot;_disableDocking&quot;, Def:false, Desc:&quot;Docking fine emails&quot;},
		B2:{Name:&quot;_disableEscapePods&quot;, Def:false, Desc:&quot;Escape pod emails&quot;},
		B3:{Name:&quot;_disableContracts&quot;, Def:false, Desc:&quot;Contract emails&quot;},
		B4:{Name:&quot;_disableFines&quot;, Def:false, Desc:&quot;Fine penalty emails&quot;},
		B5:{Name:&quot;_disableEquipPurchase&quot;, Def:false, Desc:&quot;Equip purchase emails&quot;},
		B6:{Name:&quot;_disableNewShip&quot;, Def:false, Desc:&quot;New ship emails&quot;},
		B7:{Name:&quot;_disableMaintenance&quot;, Def:false, Desc:&quot;Maintenance emails&quot;},
		B8:{Name:&quot;_disableEliteFederation&quot;, Def:false, Desc:&quot;Elite Fed emails&quot;},
		Info:&quot;Set item to true to disable those emails from being transmitted.&quot;},
};

//=============================================================================================================
// ship interfaces
//-------------------------------------------------------------------------------------------------------------
this.startUp = function() {
	// delete the missionScreenEnded routine if IronHide OXP is not installed
	if (!worldScripts[&quot;IronHide Armour Script&quot;]) delete this.missionScreenEnded;
}

//-------------------------------------------------------------------------------------------------------------
this.startUpComplete = function() {
	// register our settings, if Lib_Config is present
	if (worldScripts.Lib_Config) worldScripts.Lib_Config._registerSet(this._galCopAdminConfig);

	// load in the licence number if it&#39;s been saved
	if (missionVariables.GalCopAdmin_licenceNumber) this._licenceNumber = missionVariables.GalCopAdmin_licenceNumber;
	if (missionVariables.GalCopAdmin_DisableBounty) this._disableBounty = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableBounty) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableEscapePods) this._disableEscapePods = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableEscapePods) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableContracts) this._disableContracts = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableContracts) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableFines) this._disableFines = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableFines) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableEquipPurchase) this._disableEquipPurchase = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableEquipPurchase) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableNewShip) this._disableNewShip = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableNewShip) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableMaintenance) this._disableMaintenance = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableMaintenance) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableEliteFed) this._disableEliteFederation = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableEliteFed) &gt;= 0 ? true : false);
	if (missionVariables.GalCopAdmin_DisableDocking) this._disableDocking = (this._trueValues.indexOf(missionVariables.GalCopAdmin_DisableDocking) &gt;= 0 ? true : false);

	this._maintItemNameReplacements = expandDescription(&quot;[maint_itemname_list]&quot;);

	// send a late notice pilot licence email
	if (global.clock.clockStringForTime(global.clock.seconds).indexOf(&quot;2084004:20&quot;) === -1 &amp;&amp; this._licenceNumber === &quot;&quot;) {
		this._licenceNumber = this.$generateLicenceNumber();
		// pilot licence notification arrives shortly after the start
		var lgl = expandDescription(&quot;[legalstatuswarnings_&quot; + expandDescription(&quot;[commander_legal_status]&quot;) + &quot;]&quot;);
		var w = worldScripts.EmailSystem;
		w.$createEmail({sender:expandDescription(&quot;[new-licence-sender]&quot;),
			subject:expandDescription(&quot;Re: New Pilot Registration&quot;),
			date:global.clock.adjustedSeconds,
			message:expandDescription(&quot;[latenotice-licence]&quot;, {licenceno:this._licenceNumber, insertlegalstatus:lgl}),
			sentFrom:this._galCopHQ[galaxyNumber]
		});
	}

}

//-------------------------------------------------------------------------------------------------------------
this.playerWillSaveGame = function() {
	// save the licence number in worldscripts
	//if (this._licenceNumber === &quot;&quot;) this._licenceNumber = this.$generateLicenceNumber();
	missionVariables.GalCopAdmin_licenceNumber = this._licenceNumber;
	missionVariables.GalCopAdmin_DisableBounty = this._disableBounty;
	missionVariables.GalCopAdmin_DisableEscapePods = this._disableEscapePods;
	missionVariables.GalCopAdmin_DisableContracts = this._disableContracts;
	missionVariables.GalCopAdmin_DisableFines = this._disableFines;
	missionVariables.GalCopAdmin_DisableEquipPurchase = this._disableEquipPurchase;
	missionVariables.GalCopAdmin_DisableNewShip = this._disableNewShip;
	missionVariables.GalCopAdmin_DisableMaintenance = this._disableMaintenance;
	missionVariables.GalCopAdmin_DisableEliteFed = this._disableEliteFederation;
	missionVariables.GalCopAdmin_DisableDocking = this._disableDocking;
}

//-------------------------------------------------------------------------------------------------------------
this.shipWillDockWithStation = function(station) {

	var w = worldScripts.EmailSystem;
	this.$setupRepNames(station);

	// have we changed ranking?
	var newrank = expandDescription(&quot;[commander_rank]&quot;);
	if (this._oldrank != newrank &amp;&amp; newrank != &quot;Harmless&quot; &amp;&amp; this._disableEliteFederation === false) {
		// send an email from the Elite Federation
		// get clean version of rank
		if (newrank.indexOf(&quot;Deadly&quot;) &gt;=0) newrank = &quot;Deadly&quot;;
		if (newrank.indexOf(&quot;E L I T E&quot;) &gt;=0 || newrank.indexOf(&quot;ELITE&quot;) &gt;= 0) newrank = &quot;Elite&quot;;

		var pre = &quot;a&quot;;
		if (&quot;AEIOU&quot;.indexOf(player.ship.shipClassName.substring(0,1)) &gt;= 0) {
			pre = &quot;an&quot;;
		}
		w.$createEmail({sender:expandDescription(&quot;[elite-fed-sender]&quot;),
			subject:expandDescription(&quot;[elite-fed-subject-&quot; + newrank + &quot;]&quot;),
			date:global.clock.adjustedSeconds,
			message:expandDescription(&quot;[elite-fed-body-&quot; + newrank + &quot;]&quot;, {shipnamepre:pre, realshipname:player.ship.shipUniqueName, galnum:(galaxyNumber + 1)}),
			sentFrom:this._fedHQ[galaxyNumber]
		});
	}

	// do we have any pending bounty notifications?
	if (this._disableBounty === false &amp;&amp; (this._bountyEmailBody != &quot;&quot; || (this._holdBountyEmail &amp;&amp; this._holdBountyEmail.length &gt; 0))) {
		var include = &quot;&quot;;
		// have we got any bounty reports in the hold queue
		if (this._holdBountyEmail &amp;&amp; this._holdBountyEmail.length &gt; 0) {
			for (var i = 0; i &lt; this._holdBountyEmail.length; i++) {
				if (this._holdBountyEmail[i].bountySystem === &quot;Interstellar space&quot;) {
					include += &quot;~In &quot; + this._holdBountyEmail[i].bountySystem + &quot;:\n&quot; + this._holdBountyEmail[i].bountyEmail + &quot;\n&quot;;
				} else {
					include += &quot;~In the &quot; + this._holdBountyEmail[i].bountySystem + &quot; system:\n&quot; + this._holdBountyEmail[i].bountyEmail + &quot;\n&quot;;
				}
			}
			// any stuff left to add? add another system marker
			if (this._bountyEmailBody != &quot;&quot;) {
				if (this._bountySystem === &quot;Interstellar space&quot;) {
					include += &quot;~In &quot; + this._bountySystem + &quot;:\n&quot;;
				} else {
					include += &quot;~In the &quot; + this._bountySystem + &quot; system:\n&quot;;
				}
			}
			// clean up
			while(this._holdBountyEmail.length &gt; 0) {
				this._holdBountyEmail.pop();
			}
		}
		// any emailbody holding info? add it to the include var
		if (this._bountyEmailBody != &quot;&quot;) include += this._bountyEmailBody;

		// add warning for no-bounty kills
		if (this._bountyEmailTotalCR &gt; 0 &amp;&amp; this._bountyEmailBody.indexOf(&quot;(no bounty)&quot;) &gt;= 0) include += &quot;\nPlease note that GalCop does not condone the killing of innocent pilots.\n&quot;;

		// number of kills
		var kills = &quot;A total of &quot; + this._killCount + &quot; ships were destroyed&quot;;
		if (this._killCount === 1) kills = &quot;A single ship was destroyed&quot;;
		var killasrt = &quot;&quot;;
		if (this._killAssortedCount &gt; 0) {
			killasrt = &quot; (plus &quot; + this._killAssortedCount + &quot; other items)&quot;;
			if (this._killAssortedCount === 1) killasrt = &quot; (plus 1 other item)&quot;;
		}
		kills += killasrt;

		var emailType = &quot;[galcop-bounty-admin-body]&quot;;
		// if we didn&#39;t have any bounty, switch to the no-bounty email type
		if (this._bountyEmailTotalCR === 0) emailType = &quot;[galcop-nobounty-admin-body]&quot;;

		w.$createEmail({sender:expandDescription(&quot;[galcop-bounty-sender]&quot;),
			subject:&quot;Bounty confirmation&quot;,
			date:this._bountyEmailTime,
			message:expandDescription(emailType, {bounty:formatCredits(this._bountyEmailTotalCR, false, true), bountybody:include, totalkills:kills, sender:this._galCopBountyOfficer}),
			sentFrom:this._galCopHQ[galaxyNumber],
			expiryDays:this._defaultExpiryDays}
		);
		this._bountyEmailBody = &quot;&quot;;
		this._bountyEmailTotalCR = 0;
		this._bountyEmailTime = 0;
		this._killCount = 0;
		this._killAssortedCount = 0;
	}

	// player ejected
	if (this._disableEscapePods === false &amp;&amp; this._playerEjected === true) {
		var msg = expandDescription(&quot;[escapepod-rescue-body]&quot;, {sender:randomName() + &quot; &quot; + randomName()});
		w.$createEmail({sender:expandDescription(&quot;[escapepod-insurance-sender]&quot;),
			subject:&quot;Rescue&quot;,
			date:global.clock.adjustedSeconds,
			message:msg,
			expiryDays:this._defaultExpiryDays
		});
	}

	// docking fine
	if (this._disableDocking === false &amp;&amp; station.requiresDockingClearance === true &amp;&amp;
		player.dockingClearanceStatus != &quot;DOCKING_CLEARANCE_STATUS_GRANTED&quot; &amp;&amp; player.dockingClearanceStatus != &quot;DOCKING_CLEARANCE_STATUS_TIMING_OUT&quot; &amp;&amp;
		this._playerEjected === false &amp;&amp; system.sun.isGoingNova === false) {

		// what type of station is this?
		var bSent = false;
		// calculate fine
		var fine = player.credits * 0.05;
		if (fine &gt; 5000) fine = 5000;

		// main station
		if (station.isMainStation === true) {
			var msg = expandDescription(&quot;[galcop-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.displayName, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[galcop-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
			bSent = true;
		}
		// seedy space bar
		if (bSent === false &amp;&amp; station.hasRole(&quot;random_hits_any_spacebar&quot;)) {
			var msg = expandDescription(&quot;[ssb-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.displayName, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[ssb-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
			bSent = true;
		}
		// blackmonk monestary
		if (bSent === false &amp;&amp; station.hasRole(&quot;blackmonk_monastery&quot;)) {
			var msg = expandDescription(&quot;[bmm-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.displayName, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[bmm-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
			bSent = true;
		}
		// constore
		if (bSent === false &amp;&amp; station.hasRole(&quot;constore&quot;)) {
			var msg = expandDescription(&quot;[constore-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.displayName, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[constore-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
			bSent = true;
		}
		// rescue station
		if (bSent === false &amp;&amp; station.hasRole(&quot;rescue_station&quot;)) {
			var msg = expandDescription(&quot;[rs-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.displayName, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[rs-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
			bSent = true;
		}
		// other?
		if (bSent === false) {
			var msg = expandDescription(&quot;[generic-docking-fine-body]&quot;, {fine:formatCredits(fine, true, true), stationname:station.name, sender:this._dutyOfficer});

			w.$createEmail({sender:expandDescription(&quot;[generic-docking-fine-sender]&quot;),
				subject:&quot;Docking Penalty&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
		}
	}

	// general fine notification/payment
	if (this._disableFines === false &amp;&amp; player.ship.markedForFines === true &amp;&amp; station.isMainStation &amp;&amp; station.suppressArrivalReports === false &amp;&amp; system.sun.isGoingNova === false &amp;&amp; player.bounty &lt; (50 - (system.info.government * 6))) {
		// calculate what the fine is
		var gov = 0;
		var calc_fine = 0;
		if (global.system.ID === -1) {
			gov = 1;
		} else {
			gov = system.government;
		}
		calc_fine = 50 + ((gov &lt; 2 || gov &gt; 5) ? 50 : 0);
		calc_fine *= player.bounty;
		if (calc_fine &gt; player.credits) {
			calc_fine = player.credits;
		}

		if (calc_fine &gt; 0) {
			var msg = expandDescription(&quot;[marked-for-fines-intro]&quot;, {fine:formatCredits(calc_fine, true, true)});
			if (player.bounty &gt;= 50) {
				msg += expandDescription(&quot;[marked-for-fines-fugitive]&quot;);
			}
			msg += expandDescription(&quot;[marked-for-fines-end]&quot;);
			w.$createEmail({sender:expandDescription(&quot;[marked-for-fines-sender]&quot;),
				subject:&quot;Fine payment&quot;,
				date:global.clock.adjustedSeconds,
				message:msg,
				expiryDays:this._defaultExpiryDays
			});
		}
	}

	this._playerEjected = false;
}

//-------------------------------------------------------------------------------------------------------------
this.guiScreenChanged = function(to, from) {

	// make a note of when we reach the shipyafrds screen
	if (guiScreen === &quot;GUI_SCREEN_SHIPYARD&quot; &amp;&amp; this._disableNewShip === false) {
		var p = player.ship;
		this._playerEnteringShipyard = true;
		this._oldcredits = player.credits;

		// calculate price of current ship
		// reproduction of core code
		this._storedShipCost = this.$cunningFee((((p.price - (p.price * 0.006 * this.$missingSubEntitiesAdjustment())) * 75 * p.serviceLevel) + 5000) / 10000 , 0.005);

		// calculate price of stock in hold
		this._storedManifestCost = 0;
		for (var i = 0; i &lt; manifest.list.length; i++) {
			this._storedManifestCost += Math.round(manifest.list[i].quantity * (p.dockedStation.market[manifest.list[i].commodity].price / 10) * 100) / 100;
		}
	}
	if (guiScreen != &quot;GUI_SCREEN_SHIPYARD&quot; &amp;&amp; guiScreen != &quot;GUI_SCREEN_STATUS&quot; &amp;&amp; this._playerEnteringShipyard === true) {
		this._playerEnteringShipyard = false;
	}

	// sending an email at the start of a new game, welcome player to their just-purchased ship
	// note, because of the way Hardships works, it&#39;s hard to know when the player has finished looking at ships and testing them
	// so, if you have hardships installed, you won&#39;t get a welcome to your new ship email. Standard purchasing will still give an email
	if (guiScreen === &quot;GUI_SCREEN_STATUS&quot; &amp;&amp; player.name === &quot;Jameson&quot; &amp;&amp; !worldScripts.hardships) {
		if (global.clock.clockStringForTime(global.clock.seconds).indexOf(&quot;2084004:20&quot;) === 0 &amp;&amp; !missionVariables.EmailSystem_newGame) {
			// this is a new game, send new ship email
			missionVariables.EmailSystem_newGame = 1;
			this.$sendNewShipEmail(player.ship);
		}
		if (global.clock.clockStringForTime(global.clock.seconds).indexOf(&quot;2084004:20&quot;) === -1) {
			// clean up
			delete missionVariables.EmailSystem_newGame;
		}
	}

	// send a pilot licence email
	if (guiScreen === &quot;GUI_SCREEN_STATUS&quot; &amp;&amp; player.name === &quot;Jameson&quot;) {
		if (global.clock.clockStringForTime(global.clock.seconds).indexOf(&quot;2084004:20&quot;) === 0 &amp;&amp; this._licenceNumber === &quot;&quot;) {
			this._licenceNumber = this.$generateLicenceNumber();
			// pilot licence notification arrives shortly after the start
			var w = worldScripts.EmailSystem;
			w.$createEmail({sender:expandDescription(&quot;[new-licence-sender]&quot;),
				subject:expandDescription(&quot;New Pilot Registration&quot;),
				date:global.clock.seconds + 40,
				message:expandDescription(&quot;[new-licence]&quot;, {licenceno:this._licenceNumber}),
				sentFrom:this._galCopHQ[galaxyNumber]
			});
		}
	}

	// make a note of the credit balance
	if(to &amp;&amp; to === &quot;GUI_SCREEN_EQUIP_SHIP&quot;) {
		this._oldcredits = player.credits;
		this._oldPassengerCount = player.ship.passengerCapacity;
		// if the Battle damage OXP is present, check for the HULL REPAIR item. If it&#39;s not on the player ship, there is hull damage to repair
		var w = worldScripts[&quot;Battle Damage&quot;];
		if (w &amp;&amp; missionVariables.BattleDamage_status === &quot;DAMAGED&quot;) {
			// there is hull damage to repair
			this._repairHullDamage = true;
		}
		// if the Iron Hide OXP is present, check for damage so we can include an item in the email
		w = worldScripts[&quot;IronHide Armour Script&quot;];
		if(w) {
			if ((player.ship.equipmentStatus(&quot;EQ_IRONHIDE&quot;) === &quot;EQUIPMENT_OK&quot; || player.ship.equipmentStatus(&quot;EQ_IRONHIDE_MIL&quot;) === &quot;EQUIPMENT_OK&quot;) &amp;&amp; missionVariables.ironHide_percentage &lt; 100) {
				this._repairIronHide = true;
			}
		}

		// store equipment status of all items so we can tell when it&#39;s a repair job
		var p = player.ship;
		var eq = p.equipment;
		for (var i = 0; i &lt; eq.length; i++) {
			var q = eq[i];
			this._equipItems.push({key:q.equipmentKey, status:p.equipmentStatus(q.equipmentKey)});
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
// special case for IronHide
this.missionScreenEnded = function() {
	// if the ironhide armour gets repairs during the maintenance overhaul, it calls a mission screen
	// this will run when the mission screen ends
	if (this._sendMaintEmail === true) {
		this._sendMaintEmail = false;
		this._maintCost = this._maintCostInit - player.credits;
		this.$sendMaintenanceEmail()
	}
	// if the ironhide armour is repaired on its own, it still calls a mission screen
	// this will run when that screen ends
	if (this._sendRepairEmail === true) {
		this._sendRepairEmail = false;
		var msg = expandDescription(&quot;[purchase-maintenance]&quot;,
			{shipname:player.ship.shipClassName,
			maintenanceitems:&quot;\n\n- Repair of IronHide armour&quot;,
			servicecost:formatCredits(this._maintCostInit - player.credits, true, true),
			costnote:&quot;&quot;,
			sender:this._maintRep
		});

		var w = worldScripts.EmailSystem;
		w.$createEmail({sender:expandDescription(&quot;[purchase-maintenance-sender]&quot;),
			subject:&quot;Repair (Invoice #&quot; + (this.$rand(500000) + 100000).toString() + &quot;)&quot;,
			date:global.clock.adjustedSeconds,
			message:msg,
			expiryDays:this._defaultExpiryDays
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedEscapePod = function(pod, pass) {
	this._playerEjected = true;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtEquipment = function(equipment) {
	if (this._debug) log(this.name, &quot;equipment &quot; + equipment);
	// start a timer to do all the bought equipment work
	// this is to ensure any OXP processes have completed (like refunding) before we do out calculations
	this._boughtKey = equipment
	this._boughtStn = player.ship.dockedStation;
	// make sure the timer isn&#39;t already running
	if (this._boughtEquipTimer &amp;&amp; this._boughtEquipTimer.isRunning) this._boughtEquipTimer.stop();
	this._boughtEquipTimer = new Timer(this, this.$playerBoughtEquip, 1, 0);
}

//-------------------------------------------------------------------------------------------------------------
this.$playerBoughtEquip = function $playerBoughtEquip() {

	var equipment = this._boughtKey;
	if (this._debug) log(this.name, &quot;bought key = &quot; + equipment);
	// work out where the purchase occurred
	var stn = null;
	if (this._boughtStn) {
		stn = this._boughtStn;
	} else {
		if (player.ship.dockedStation) {
			stn = player.ship.dockedStation;
		} else {
			stn = system.mainStation;
		}
	}
	this._boughtStn = null;

	// don&#39;t do anything for these items
	if (this._purchase_ignore_equip.indexOf(equipment) &gt;= 0) return;

	var w = worldScripts.EmailSystem;

	if (this._shipSalesRep === &quot;&quot;) {
		this.$setupRepNames(stn);
	}

	if (equipment !== &quot;EQ_RENOVATION&quot;) {
		// purchasing items
		var etype = &quot;purchase&quot;;
		var subtype = 0;
		var eq = EquipmentInfo.infoForKey(equipment);

		// work out what sort of purchase this was: standard purchase, repair or removal

		// we could be repairing something so check the statuses we saved when we switched to the equip ship screen
		if (this._equipItems &amp;&amp; this._equipItems.length &gt; 0) {
			for (var i = 0; i &lt; this._equipItems.length; i++) {
				if (this._equipItems[i].key === equipment &amp;&amp; this._equipItems[i].status === &quot;EQUIPMENT_DAMAGED&quot;) etype = &quot;repair&quot;;
			}
		}
		// if the equipment key itself has &quot;REPAIR&quot; in it, switch to repair mode
		if (this._maint_repair_equip.indexOf(equipment) &gt;= 0 || (equipment.indexOf(&quot;REPAIR&quot;) &gt;= 0 &amp;&amp; equipment.indexOf(&quot;REPAIRBOTS&quot;) === 0)) etype = &quot;repair&quot;;
		// if the equipment key itself has &quot;REMOVAL&quot; in it, switch to removal mode
		var desc = eq.description.toLowerCase();
		if (this._maint_remove_equip.indexOf(equipment) &gt;= 0 || 
			(desc.indexOf(&quot;remove&quot;) &gt;= 0 || 
				(desc.indexOf(&quot;sell &quot;) &gt;= 0 &amp;&amp; desc.indexOf(&quot;buy &quot;) === -1) || 
				desc.indexOf(&quot;unmount&quot;) &gt;= 0 || 
				desc.indexOf(&quot;undo &quot;) &gt;= 0 || 
				equipment.indexOf(&quot;REFUND&quot;) &gt;= 0))
			{etype = &quot;remove&quot;; subtype = 1;}
		// if the player doesn&#39;t have the equipment anymore, it must be a removal
		// this should really only be triggered by an external pack calling the playerBoughtEquipment routine manually (see Ship Configuration for an example)
		if (etype === &quot;purchase&quot;) {
			if (equipment != &quot;EQ_PASSENGER_BERTH&quot; &amp;&amp; player.ship.equipmentStatus(equipment) !== &quot;EQUIPMENT_OK&quot; &amp;&amp; this._purchase_removed.indexOf(equipment) === -1) etype = &quot;remove&quot;;
		}

		var extra = &quot;&quot;;
		var msg = &quot;&quot;;
		var itemname = &quot;&quot;;

		// see if there is a replacement description for this piece of equipment
		if (this._maintItemNameReplacements.indexOf(equipment) &gt;= 0) {
			itemname = expandDescription(&quot;[maint_itemname_&quot; + equipment + &quot;]&quot;);
			if (!itemname || itemname === &quot;&quot; || itemname.indexOf(&quot;[maint_&quot;) &gt;= 0) {
				itemname = eq.name;
			}
		} else {
			itemname = eq.name;
		}

		if (this._debug) {
			log(this.name, &quot;etype = &quot; + etype);
			log(this.name, &quot;subtype = &quot; + subtype);
			log(this.name, &quot;old creds = &quot; + this._oldcredits);
			log(this.name, &quot;curr creds = &quot; + player.credits);
		}

		switch (etype) {
			case &quot;remove&quot;:
				if (this._disableEquipPurchase === false) {
					var cost = &quot;&quot;;
					// were we charged something, or did we get a refund?
					if (eq.price != 0) {
						if ((this._oldcredits - player.credits) &lt; 0) {
							if (subtype === 1) {
								cost = &quot;The cost of this service was &quot; + formatCredits(eq.price / 10, true, true) + &quot;, but all together you were refunded &quot; + formatCredits(player.credits - this._oldcredits, true, true) + &quot;.&quot;;
							} else {
								cost = &quot;In total you were refunded &quot; + formatCredits(player.credits - this._oldcredits, true, true) + &quot;.&quot;;
							}
						} else {
							cost = &quot;You were charged &quot; + formatCredits(this._oldcredits - player.credits, true, true) + &quot;.&quot;;
						}
					} else {
						if ((this._oldcredits - player.credits) &lt; 0) {
							cost = &quot;In total you were refunded &quot; + formatCredits(player.credits - this._oldcredits, true, true) + &quot;.&quot;;
						} else {
							cost = &quot;There was no charge for this service.&quot;;
						}
					}

					msg = expandDescription(&quot;[remove-equip]&quot;,
						{stationname:stn.displayName,
						equipname:itemname,
						equipcost:cost,
						sender:this._equipSalesRep
					});

					w.$createEmail({sender:expandDescription(&quot;[purchase-equip-sender]&quot;),
						subject:&quot;Removing equipment&quot;,
						date:global.clock.adjustedSeconds,
						message:msg,
						expiryDays:this._defaultExpiryDays
					});

					// special case for escape pod
					if (equipment === &quot;EQ_ESCAPE_POD&quot;) {
						msg = expandDescription(&quot;[escapepod-sold-body]&quot;,
							{sender:randomName() + &quot; &quot; + randomName()
						});

						w.$createEmail({sender:expandDescription(&quot;[escapepod-insurance-sender]&quot;),
							subject:&quot;Contract termination&quot;,
							date:global.clock.adjustedSeconds + 150,
							message:msg,
							expiryDays:this._defaultExpiryDays
						});
					}
				}
				break;
			case &quot;purchase&quot;:
				if (this._disableEquipPurchase === false) {
					var paid = ((eq.price / 10) * stn.equipmentPriceFactor);
					if (this._oldcredits != player.credits + ((eq.price / 10) * stn.equipmentPriceFactor)) {
						paid = (this._oldcredits - player.credits);
						// did we get a refund for an existing weapon?
						if (equipment.indexOf(&quot;EQ_WEAPON&quot;) &gt;= 0) {
							extra = &quot;(Note: You were refunded the cost of any laser that was removed in order to install your new one.)&quot;;
							// switch back to the direct equipment price, otherwise the email text gets confusing
							paid = ((eq.price / 10) * stn.equipmentPriceFactor);
						}
					}

					if (this._debug) log(this.name, &quot;paid = &quot; + paid);

					msg = expandDescription(&quot;[purchase-equip]&quot;,
						{stationname:stn.displayName,
						extranote:extra,
						equipname:itemname + &quot;: &quot; + eq.description,
						equipcost:&quot;The cost of this item was &quot; + formatCredits(paid, true, true),
						sender:this._equipSalesRep
					});

					// make the missle purchase email more reasonable.
					if (equipment.indexOf(&quot;MISSILE&quot;) &gt;= 0) {
						msg = msg.replace(&quot;We hope you will enjoy many years of trouble-free use of this item.&quot;, &quot;We hope this item performs flawlessly for you when you need it.&quot;);
					}

					w.$createEmail({sender:expandDescription(&quot;[purchase-equip-sender]&quot;),
						subject:&quot;Purchasing equipment&quot;,
						date:global.clock.adjustedSeconds,
						message:msg,
						expiryDays:this._defaultExpiryDays
					});

					// special case for escapepods - send insurance application notification
					if (equipment === &quot;EQ_ESCAPE_POD&quot;) {
						msg = expandDescription(&quot;[escapepod-purchase-body]&quot;,
							{sender:randomName() + &quot; &quot; + randomName()
						});

						w.$createEmail({sender:expandDescription(&quot;[escapepod-insurance-sender]&quot;),
							subject:&quot;Insurance Application&quot;,
							date:global.clock.adjustedSeconds + 300,
							message:msg,
							expiryDays:this._defaultExpiryDays
						});
					}
				}
				break;

			case &quot;repair&quot;:
				if (this._disableMaintenance === false) {
					if (equipment === &quot;EQ_IRONHIDE_REPAIR&quot;) {
						this._sendRepairEmail = true;
						this._maintCostInit = this._oldcredits;
					} else {
						if ((this._oldcredits - player.credits) &gt; 0) {
							var maint = &quot;&quot;;
							if (eq.name.toLowerCase().indexOf(&quot;repair&quot;) &gt;= 0) {
								maint = &quot;\n\n- &quot; + eq.name;
							} else {
								maint = &quot;\n\n- Repair of &quot; + eq.name;
							}

							// special cases - ShipVersion OXP
							if (equipment === &quot;EQ_TURRET_RECOVER&quot;) maint = &quot;\n\n- Recovery of destroyed turrets&quot;;
							if (equipment === &quot;EQ_SHIP_VERSION_REPAIR&quot;) maint = &quot;\n\n- Restoring the recharge bonuses provided by Ship Version equipment.&quot;;

							msg = expandDescription(&quot;[purchase-maintenance]&quot;,
								{shipname:player.ship.shipClassName,
								maintenanceitems:maint,
								servicecost:formatCredits(this._oldcredits - player.credits, true, true),
								costnote:&quot;&quot;,
								sender:this._maintRep
							});

							var w = worldScripts.EmailSystem;
							w.$createEmail({sender:expandDescription(&quot;[purchase-maintenance-sender]&quot;),
								subject:&quot;Repair (Invoice #&quot; + (this.$rand(500000) + 100000).toString() + &quot;)&quot;,
								date:global.clock.adjustedSeconds,
								message:msg,
								expiryDays:this._defaultExpiryDays
							});
						}
					}
				}
				break;
		}

		if (equipment === &quot;EQ_IRONHIDE_REPAIR&quot;) this._repairIronHide = false;
		if (equipment === &quot;EQ_HULL_REPAIR&quot;) this._repairHullDamage = false;

	} else {
		if (this._disableMaintenance === false) {
			if (this._repairIronHide === false) {
				// if there&#39;s no ironhide armour repair, send the email immediately
				this._maintCost = this._oldcredits - player.credits;
				this.$sendMaintenanceEmail();
			} else {
				// otherwise set up params for sending email later
				this._sendMaintEmail = true;
				this._maintCostInit = this._oldcredits;
			}
		}
	}

	this._oldcredits = player.credits;
}

//-------------------------------------------------------------------------------------------------------------
this.playerBoughtNewShip = function(ship, price) {
	if (this._playerEnteringShipyard === true &amp;&amp; this._disableNewShip === false) {
		this._newShipCost = (this._oldcredits + this._storedShipCost + this._storedManifestCost) - player.credits;
		this._playerEnteringShipyard = false;
		this.$sendNewShipEmail(ship);
	}
	this._oldcredits = player.credits;
}

//-------------------------------------------------------------------------------------------------------------
this.shipLaunchedFromStation = function(station) {
	// make a note of the rank we have on launch
	this._oldrank = expandDescription(&quot;[commander_rank]&quot;);
	// make a note of the system we launch in
	this._bountySystem = system.name;
}

//-------------------------------------------------------------------------------------------------------------
this.shipKilledOther = function(whom, damageType) {
	// don&#39;t record anything if this is a siumulator run
	if (this.$simulatorRunning()) return;
	if (whom.isMissile) {
		this._killAssortedCount += 1;
		this._bountyEmailTime = global.clock.seconds;
	}
	if (!whom.hasRole(&quot;escape-capsule&quot;) &amp;&amp; (whom.isPiloted || whom.isDerelict || whom.hasRole(&quot;tharglet&quot;) || whom.hasRole(&quot;thargon&quot;))) {
		// increment the kill counter
		this._killCount += 1;
		this._bountyEmailTime = global.clock.seconds;
		// but was their a bounty?
		if (whom.bounty &gt; 0) {
			// add a new item to the bounty email body
			var true_bounty = whom.bounty;
			if (whom.isCargo || whom.scanClass == &quot;CLASS_BUOY&quot; || whom.scanClass == &quot;CLASS_ROCK&quot;) true_bounty = whom.bounty / 10;
			this._bountyEmailBody += &quot;~- Destruction of &quot; + whom.displayName + &quot; for &quot; + formatCredits(true_bounty, false, true) + &quot;.\n&quot;;
			this._bountyEmailTotalCR += true_bounty;
		} else {
			// add a no bounty item to the email body
			this._bountyEmailBody += &quot;~- Destruction of &quot; + whom.displayName + &quot; (no bounty).\n&quot;;
		}
	}
}

//-------------------------------------------------------------------------------------------------------------
this.shipExitedWitchspace = function() {
	// if we enter a system while there is some bounty email body hanging around, put it into an array so we can itemise it later
	if (this._bountyEmailBody != &quot;&quot;) {
		if (!this._holdBountyEmail) {
			this._holdBountyEmail = [];
		}
		this._holdBountyEmail.push({bountyEmail:this._bountyEmailBody, bountySystem:this._bountySystem});
		this._bountyEmailBody = &quot;&quot;;
	}
	this._bountySystem = system.name;
}

//-------------------------------------------------------------------------------------------------------------
// bounty on scooped escape capsule (1.81 only)
this.playerRescuedEscapePod = function(fee, reason, occupant) {

	var w = worldScripts.EmailSystem;

	var msg = &quot;&quot;;
	var subj = &quot;&quot;;
	var sndr = &quot;&quot;;
	switch (reason) {
		case &quot;insurance&quot;:
			sndr = expandDescription(&quot;[escapepod-insurance-sender]&quot;);
			subj = &quot;Salvage fee for escape pod recovery&quot;;
			msg = expandDescription(&quot;[escapepod-insurance-body]&quot;,
				{occupant:occupant.name,
				description:occupant.description,
				fee:formatCredits(fee / 10, true, true),
				sender:this._insuranceOfficer
			});
			break;
		case &quot;bounty&quot;:
			sndr = expandDescription(&quot;[galcop-bounty-sender]&quot;);
			subj = &quot;Bounty for escape pod recovery&quot;;
			msg = expandDescription(&quot;[escapepod-bounty-body]&quot;,
				{occupant:occupant.name,
				description:occupant.description,
				fee:formatCredits(fee / 10, true, true),
				sentFrom:this._galCopHQ[galaxyNumber],
				sender:this._galCopBountyOfficer
			});
			break;
		//case &quot;slave&quot;:
	}
	if (sndr != &quot;&quot; &amp;&amp; this._disableEscapePods === false) {
		w.$createEmail({sender:sndr,
			subject:subj,
			date:global.clock.seconds,
			message:msg,
			expiryDays:this._defaultExpiryDays
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// send email to player when a contract is started. (1.81 only)
this.playerEnteredContract = function(type, contract) {

	var w = worldScripts.EmailSystem;

	var msg = &quot;&quot;;
	var subj = &quot;&quot;;
	var sndr = &quot;&quot;;

	switch (type) {
		case &quot;cargo&quot;:
			sndr = expandDescription(&quot;[cargo-contract-sender]&quot;);
			subj = &quot;Accepted contract: &quot; + contract.cargo_description;
			msg = expandDescription(&quot;[cargo-contract-start]&quot;,
				{description:contract.cargo_description,
				systemname:System.systemNameForID(contract.destination),
				time:global.clock.clockStringForTime(contract.arrival_time),
				fee:formatCredits(contract.fee, true, true)
			});
			break;
		case &quot;passenger&quot;:
			sndr = expandDescription(&quot;[passenger-contract-sender]&quot;);
			subj = &quot;Accepted contract: &quot; + contract.name;
			msg = expandDescription(&quot;[passenger-contract-start]&quot;,
				{contractname:contract.name,
				systemname:System.systemNameForID(contract.destination),
				time:global.clock.clockStringForTime(contract.arrival_time),
				fee:formatCredits(contract.fee, true, true)
			});
			break;
		case &quot;parcel&quot;:
			sndr = expandDescription(&quot;[parcel-contract-sender]&quot;);
			subj = &quot;Accepted contract: &quot; + contract.name;
			msg = expandDescription(&quot;[parcel-contract-start]&quot;,
				{contractname:contract.name,
				systemname:System.systemNameForID(contract.destination),
				time:global.clock.clockStringForTime(contract.arrival_time),
				fee:formatCredits(contract.fee, true, true)
			});
			break;
	}

	if (sndr != &quot;&quot; &amp;&amp; this._disableContracts === false) {
		w.$createEmail({sender:sndr,
			subject:subj,
			date:global.clock.adjustedSeconds,
			message:msg
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// result of parcel/passenger/cargo contract (1.81 only)
this.playerCompletedContract = function(type, result, fee, contract) {

	var w = worldScripts.EmailSystem;

	if (this._disableContracts === false) {
		var msg = &quot;&quot;;
		var subj = &quot;&quot;;
		var sndr = &quot;&quot;;

		sndr = expandDescription(&quot;[&quot; + type + &quot;-contract-sender]&quot;);
		msg = expandDescription(&quot;[&quot; + type + &quot;-contract-&quot; + result + &quot;]&quot;,
			{description:contract.cargo_description,
			contractname:contract.name,
			systemname:System.systemNameForID(contract.destination),
			time:global.clock.clockStringForTime(contract.arrival_time),
			fee:formatCredits(fee / 10, true, true)
		});
		subj = expandDescription(&quot;[&quot; + type + &quot;-contract-&quot; + result + &quot;-subject]&quot;);

		w.$createEmail({sender:sndr,
			subject:subj,
			date:global.clock.adjustedSeconds,
			message:msg,
			expiryDays:this._defaultExpiryDays
		});
	}
}

//-------------------------------------------------------------------------------------------------------------
// sends the maintenance email
this.$sendMaintenanceEmail = function() {

	var maint = &quot;&quot;;
	var item = &quot;&quot;;
	var count = 0;
	var hasLCB = false;

	var extra = &quot;&quot;;
	if (this._repairIronHide === true) extra = &quot; (includes cost of IronHide armour repair)&quot;;

	// add common items
	maint += &quot;\n\n~General ship maintenance tasks\n&quot;;
	maint += expandDescription(&quot;[maintitem_all]&quot;);

	// add general items
	do {
		item = expandDescription(&quot;[maintitem_general]&quot;);
		if (item.trim() != &quot;&quot;) {
			// because the first word of the item can be random, check if everything after the first word exists in our maintenance list yet
			// only add it if it doesn&#39;t exist
			if (maint.indexOf(item.substring(item.indexOf(&quot; &quot;)).trim()) === -1) {
				maint += &quot;\n- &quot; + item;
				count += 1;
			}
		}
	} while (count &lt; system.info.techlevel);

	var p = player.ship;
	var itemname = &quot;&quot;;
	var diagtype = expandDescription(&quot;[maintperform]&quot;);

	maint += &quot;\n\n~Equipment specific maintenance tasks&quot;
	// if the player ship hyperspace capable?
	if (p.hasHyperspaceMotor) {
		maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on Witchspace Drive&quot;;
		maint += &quot;\n- &quot; + expandDescription(&quot;[maint_Hyperspace]&quot;);
	}

	// get list of equipment keys to ignore (hull damage equipment item from the Battle Damage OXP, IronHide item, and any cats/dogs from Ships Cat OXP)
	// add equipment specific items;
	for (var i = 0; i &lt; p.equipment.length; i++) {
		var e_item = p.equipment[i];
		if (this._maint_known_equip.indexOf(e_item.equipmentKey) &gt;= 0) {
			// can this item be repaired in this system?
			if ((e_item.techLevel - 1) &lt;= system.info.techlevel &amp;&amp; e_item.isVisible) {
				// is this piece of equipment OK (don&#39;t do maintenance on damaged equipment)
				if (p.equipmentStatus(e_item.equipmentKey) === &quot;EQUIPMENT_OK&quot;) {
					// add a diagnostic entry for all items
					itemname = e_item.name;

					// check if we have a large cargo bay - we&#39;ll use this later on
					if (e_item.equipmentKey === &quot;EQ_CARGO_BAY&quot;) hasLCB = true;

					// special case for passenger berth, as its name has extraneous text in it
					if (e_item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot;) itemname = &quot;Passenger Berth&quot;;

					maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on &quot; + itemname;

					// get a maintenance item for this equipment
					item = expandDescription(&quot;[maint_&quot; + e_item.equipmentKey + &quot;]&quot;);
					// do we have a real value? if so, add it to the list
					if (item.indexOf(&quot;[&quot;) === -1 &amp;&amp; item.trim() != &quot;&quot;) maint += &quot;\n- &quot; + item;
				} else if (p.equipmentStatus(e_item.equipmentKey) === &quot;EQUIPMENT_DAMAGED&quot;) {
					// this item is damaged - just note it in the message
					// add a diagnostic entry for all items
					itemname = e_item.name;

					// special case for passenger berth, as its name has extraneous text in it
					if (e_item.equipmentKey === &quot;EQ_PASSENGER_BERTH&quot;) itemname = &quot;Passenger Berth&quot;;

					item = &quot;Identified repairs required for &quot; + itemname;
					maint += &quot;\n- &quot; + item;
				}
			}
		}
	}

	// did the player repair the ironhide armour?
	if ((p.equipmentStatus(&quot;EQ_IRONHIDE&quot;) === &quot;EQUIPMENT_OK&quot; || p.equipmentStatus(&quot;EQ_IRONHIDE_MIL&quot;) === &quot;EQUIPMENT_OK&quot;) &amp;&amp; missionVariables.ironHide_percentage === 100 &amp;&amp; this._repairIronHide === true) {
		// player repaired ironhide armour
		maint += &quot;\n- Repair IronHide armour&quot;;
		this._repairIronHide = false;
	}

	// for battle damage OXP, add an item to show that the damage has been repaired
	if (this._repairHullDamage === true) {
		maint += &quot;\n- Repair hull damage&quot;;
		this._repairHullDamage = false;
	}

	// do we have any cargo space but no LCB?
	if (p.cargoSpaceCapacity &gt; 0 &amp;&amp; hasLCB === false) {
		maint += &quot;\n- &quot; + expandDescription(&quot;[maint_CargoBay]&quot;);
	}

	// do we have any missiles?
	if (p.missileCapacity &gt; 0) {
		maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on missile system&quot;;
		maint += &quot;\n- &quot; + expandDescription(&quot;[maint_MissileSystem]&quot;);
	}

	// weapon equipment items don&#39;t appear in the ship.equipment array, so we need to do an individual check for each one
	if (p.forwardWeapon &amp;&amp; p.forwardWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot; &amp;&amp; this._maint_known_equip.indexOf(p.forwardWeapon.equipmentKey) &gt;= 0) {
		if (p.forwardWeapon.techLevel &lt;= (system.info.techlevel - 1)) {
			maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on front &quot; + p.forwardWeapon.name;
			item = expandDescription(&quot;[maint_&quot; + p.forwardWeapon.equipmentKey + &quot;]&quot;, {pos:&quot;front&quot;});
			maint += &quot;\n- &quot; + item;
		}
	}
	if (p.aftWeapon &amp;&amp; p.aftWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot; &amp;&amp; this._maint_known_equip.indexOf(p.aftWeapon.equipmentKey) &gt;= 0) {
		if (p.aftWeapon.techLevel &lt;= (system.info.techlevel - 1)) {
			maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on aft &quot; + p.aftWeapon.name;
			item = expandDescription(&quot;[maint_&quot; + p.aftWeapon.equipmentKey + &quot;]&quot;, {pos:&quot;aft&quot;});
			maint += &quot;\n- &quot; + item;
		}
	}
	if (p.portWeapon &amp;&amp; p.portWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot; &amp;&amp; this._maint_known_equip.indexOf(p.portWeapon.equipmentKey) &gt;= 0) {
		if (p.portWeapon.techLevel &lt;= (system.info.techlevel - 1)) {
			maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on port &quot; + p.portWeapon.name;
			item = expandDescription(&quot;[maint_&quot; + p.portWeapon.equipmentKey + &quot;]&quot;, {pos:&quot;port&quot;});
			maint += &quot;\n- &quot; + item;
		}
	}
	if (p.starboardWeapon &amp;&amp; p.starboardWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot; &amp;&amp; this._maint_known_equip.indexOf(p.starboardWeapon.equipmentKey) &gt;= 0) {
		if (p.starboardWeapon.techLevel &lt;= (system.info.techlevel - 1)) {
			maint += &quot;\n- &quot; + diagtype + &quot; diagnostics on starboard &quot; + p.starboardWeapon.name;
			item = expandDescription(&quot;[maint_&quot; + p.starboardWeapon.equipmentKey + &quot;]&quot;, {pos:&quot;starboard&quot;});
			maint += &quot;\n- &quot; + item;
		}
	}

	maint += &quot;\n- Ship detailing and valet service\n- Parts and labour&quot;;

	var msg = expandDescription(&quot;[purchase-maintenance]&quot;,
		{shipname:p.shipClassName,
		maintenanceitems:maint,
		servicecost:formatCredits(this._maintCost, true, true),
		costnote:extra,
		sender:this._maintRep
	});

	var w = worldScripts.EmailSystem;
	w.$createEmail({sender:expandDescription(&quot;[purchase-maintenance-sender]&quot;),
		subject:&quot;Overhaul (Invoice #&quot; + (this.$rand(500000) + 100000).toString() + &quot;)&quot;,
		date:global.clock.adjustedSeconds,
		message:msg,
		expiryDays:this._defaultExpiryDays
	});
}

//-------------------------------------------------------------------------------------------------------------
// sends new ship email
this.$sendNewShipEmail = function(ship) {

	// make sure we have created the rep names
	if (this._shipSalesRep === &quot;&quot;) this.$setupRepNames();

	var equip = &quot;&quot;;
	var specs = &quot;&quot;;
	var inj = 7;
	if (0 &gt;= oolite.compareVersion(&quot;1.81&quot;)) inj = ship.injectorSpeedFactor;

	var wpn = &quot;\n     Front - &quot;;
	if (ship.forwardWeapon &amp;&amp; ship.forwardWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot;) {
		wpn += ship.forwardWeapon.name;
	} else {
		wpn += &quot;None&quot;;
	}

	if (&quot; 3 7 11 15 &quot;.indexOf(&quot; &quot; + ship.weaponFacings.toString() + &quot; &quot;) &gt;= 0) {
		wpn += &quot;\n     Aft - &quot;;
		if (ship.aftWeapon &amp;&amp; ship.aftWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot;) {
			wpn += ship.aftWeapon.name;
		} else {
			wpn += &quot;None&quot;;
		}
	}
	if (&quot; 5 7 13 15 &quot;.indexOf(&quot; &quot; + ship.weaponFacings.toString() + &quot; &quot;) &gt;= 0) {
		wpn += &quot;\n     Port - &quot;;
		if (ship.portWeapon &amp;&amp; ship.portWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot;) {
			wpn += ship.portWeapon.name;
		} else {
			wpn += &quot;None&quot;;
		}
	}
	if (&quot; 9 11 13 15 &quot;.indexOf(&quot; &quot; + ship.weaponFacings.toString() + &quot; &quot;) &gt;= 0) {
		wpn += &quot;\n     Starboard - &quot;;
		if (ship.starboardWeapon &amp;&amp; ship.starboardWeapon.equipmentKey != &quot;EQ_WEAPON_NONE&quot;) {
			wpn += ship.starboardWeapon.name;
		} else {
			wpn += &quot;None&quot;;
		}
	}

	specs = &quot;- Max speed/thrust: &quot; + (ship.maxSpeed / 1000).toFixed(3) + &quot;/&quot; + (ship.maxThrust / 1000).toFixed(3) + &quot; LS\n&quot; +
		&quot;- Injector speed: &quot; + ((ship.maxSpeed * inj) / 1000).toFixed(3) + &quot; LS\n&quot; +
		&quot;- Max pitch/roll/yaw: &quot; + ship.maxPitch.toFixed(2) + &quot;/&quot; + ship.maxRoll.toFixed(2) + &quot;/&quot; + ship.maxYaw.toFixed(2) + &quot;\n&quot; +
		&quot;- Laser mounts: &quot; + wpn + &quot;\n&quot; +
		&quot;- Missile pylons: &quot; + ship.missileCapacity + &quot;\n&quot; +
		&quot;- Cargo capacity: &quot; + ship.cargoSpaceCapacity + &quot; tons\n&quot; +
		&quot;- Max energy: &quot; + (ship.maxEnergy) + &quot; units\n&quot; +
		&quot;- Energy recharge rate: &quot; + ship.energyRechargeRate.toFixed(2) + &quot; units/sec\n&quot; +
		&quot;- Hyperspace capable: &quot; + ship.hasHyperspaceMotor + &quot;\n&quot;;

	if (ship.equipment.length &gt; 0) {
		equip = &quot;Your ship also came equipped with the following items:\n&quot;;
		var added = false;
		var e = ship.equipment;
		for (var i = 0; i &lt; e.length; i++) {
			var q = e[i];
			if (&quot;EQ_HULL_REPAIR&quot;.indexOf(q.equipmentKey) === -1) {
				if (q.isPortableBetweenShips === false &amp;&amp; q.isVisible === true) {
					equip += &quot;- &quot; + q.name + &quot;\n&quot;;
					added = true
				}
			}
		}
		if (added === false) {
			equip = &quot;&quot;;
		} else {
			equip += &quot;\n&quot;;
		}
	}

	var cost = ship.price;
	var extra = &quot;&quot;;

	if (this._newShipCost) {
		cost = this._newShipCost;
		extra = &quot; As part of this transaction your old ship was traded for &quot; + formatCredits(this._storedShipCost, false, true);
		if (this._storedManifestCost &gt; 0) extra += &quot;, and the content of your hold was traded for &quot; + formatCredits(this._storedManifestCost, true, true);
		extra += &quot;.&quot;;
	}

	var msg = expandDescription(&quot;[purchase-ship]&quot;,
		{stationname:player.ship.dockedStation.displayName,
		shipclass:ship.shipClassName,
		shipspecs:specs,
		shipequip:equip,
		shipcost:formatCredits(cost, false, true),
		extracost:extra,
		rndsystem:System.systemNameForID(this.$rand(256)-1),
		sender:this._shipSalesRep
	});

	var w = worldScripts.EmailSystem;
	w.$createEmail({sender:expandDescription(&quot;[purchase-ship-sender]&quot;),
		subject:&quot;Purchase of new ship&quot;,
		date:global.clock.adjustedSeconds,
		message:msg
	});

	// transfer of ownership email arrives shortly after the first one.
	w.$createEmail({sender:&quot;GalCop Ship Registry&quot;,
		subject:&quot;Transfer of ownership&quot;,
		date:global.clock.adjustedSeconds + 25,
		message:expandDescription(&quot;[new-ship-transfer]&quot;)
	});
}

//-------------------------------------------------------------------------------------------------------------
// return a random number between 1 and max
this.$rand = function(max) {
	return Math.floor((Math.random() * max) + 1)
}

//-------------------------------------------------------------------------------------------------------------
// generates a random licence number in the format &quot;GPL000000-XX000-XX0000&quot;
this.$generateLicenceNumber = function() {

	var ln = &quot;GPL&quot;;

	ln += (this.$rand(800000) + 100000);
	ln += &quot;-&quot; + expandDescription(&quot;[licencecodes]&quot;);
	ln += (this.$rand(500) + 200);
	ln += &quot;-&quot; + expandDescription(&quot;[licencecodes]&quot;);
	ln += (this.$rand(8000) + 1000);

	return ln;
}

//-------------------------------------------------------------------------------------------------------------
// set up and store various names for inclusion in emails
this.$setupRepNames = function(station) {
	if (!station &amp;&amp; !player.ship.dockedStation) station = system.mainStation;
	if (!station &amp;&amp; player.ship.dockedStation) station = player.ship.dockedStation;

	// if we just redocked at the same station, don&#39;t change anything
	if (this._namesLocation === system.name + &quot;-&quot; + station.displayName) return;

	this._namesLocation = system.name + &quot;-&quot; + station.displayName;

	this._shipSalesRep = randomName() + &quot; &quot; + randomName();
	this._equipSalesRep = randomName() + &quot; &quot; + randomName();
	this._maintRep = randomName() + &quot; &quot; + randomName();
	this._dutyOfficer = randomName() + &quot; &quot; + randomName();
	this._insuranceOfficer = randomName() + &quot; &quot; + randomName();
	// bounty processing occurs in a central location, so only update the officer occasionally
	if (this._galCopBountyOfficer === &quot;&quot;) {
		this._galCopBountyOfficer = randomName() + &quot; &quot; + randomName();
	} else {
		if (this.$rand(20) &gt; 15) this._galCopBountyOfficer = randomName() + &quot; &quot; + randomName();
	}
}

//-------------------------------------------------------------------------------------------------------------
// reproductions of core code to try and work out an accurate trade in value for the player&#39;s ship
this.$cunningFee = function(value, precision) {
	var fee = value;
	var superfee = 100000.0;
	var max = 1 + precision;
	var min = 1 - precision;
	var rounded_fee = superfee * Math.floor(0.5 + fee / superfee);
	if (rounded_fee === 0) rounded_fee = 1;
	var ratio = fee / parseFloat(rounded_fee);
	while ((ratio &lt; min || ratio &gt; max) &amp;&amp; superfee &gt; 1)
	{
		rounded_fee = superfee * Math.floor(0.5 + fee / superfee);
		if (rounded_fee === 0) rounded_fee = 1;
		ratio = fee / parseFloat(rounded_fee);
		superfee /= 10.0;
	}
	if (ratio &gt; min &amp;&amp; ratio &lt; max) fee = rounded_fee;
	return fee;
}

//-------------------------------------------------------------------------------------------------------------
this.$missingSubEntitiesAdjustment = function() {
	// each missing subentity depreciates the ship by 5%, up to a maximum of 35% depreciation.
	var percent = 5 * (player.ship.subEntityCapacity - player.ship.subEntities.length);
	return (percent &gt; 35 ? 35 : percent);
}

//-------------------------------------------------------------------------------------------------------------
this.$simulatorRunning = function() {
	var w = worldScripts[&quot;Combat Simulator&quot;];
	if (w &amp;&amp; w.$checkFight &amp;&amp; w.$checkFight.isRunning) return true;
	return false;
}
</pre></td>
                </tr>
            </table>
        </a>
    </body>
</html>
